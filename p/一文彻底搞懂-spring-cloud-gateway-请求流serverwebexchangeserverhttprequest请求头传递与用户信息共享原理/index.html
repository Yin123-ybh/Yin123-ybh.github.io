<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="æ·±å…¥è§£æ Spring Cloud Gateway çš„åº•å±‚å“åº”å¼æ¶æ„ï¼ŒåŒ…æ‹¬ ServerWebExchangeã€ServerHttpRequest ä¸å¯å˜å¯¹è±¡æ¨¡å‹ã€mutate() æœºåˆ¶åŸç†ï¼Œä»¥åŠå¦‚ä½•å®‰å…¨é«˜æ•ˆåœ°ä¼ é€’ç”¨æˆ·ä¿¡æ¯ã€‚"><meta name=keywords content="Spring Cloud Gateway,ServerWebExchange,WebFlux,å“åº”å¼ç¼–ç¨‹,ä¸å¯å˜å¯¹è±¡,JWTä¼ é€’"><title>ä¸€æ–‡å½»åº•ææ‡‚ Spring Cloud Gateway è¯·æ±‚æµï¼šServerWebExchangeã€ServerHttpRequestã€è¯·æ±‚å¤´ä¼ é€’ä¸ç”¨æˆ·ä¿¡æ¯å…±äº«åŸç†</title><link rel=canonical href=https://Yin123-ybh.github.io/p/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82-spring-cloud-gateway-%E8%AF%B7%E6%B1%82%E6%B5%81serverwebexchangeserverhttprequest%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BC%A0%E9%80%92%E4%B8%8E%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B1%E4%BA%AB%E5%8E%9F%E7%90%86/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="ä¸€æ–‡å½»åº•ææ‡‚ Spring Cloud Gateway è¯·æ±‚æµï¼šServerWebExchangeã€ServerHttpRequestã€è¯·æ±‚å¤´ä¼ é€’ä¸ç”¨æˆ·ä¿¡æ¯å…±äº«åŸç†"><meta property='og:description' content="æ·±å…¥è§£æ Spring Cloud Gateway çš„åº•å±‚å“åº”å¼æ¶æ„ï¼ŒåŒ…æ‹¬ ServerWebExchangeã€ServerHttpRequest ä¸å¯å˜å¯¹è±¡æ¨¡å‹ã€mutate() æœºåˆ¶åŸç†ï¼Œä»¥åŠå¦‚ä½•å®‰å…¨é«˜æ•ˆåœ°ä¼ é€’ç”¨æˆ·ä¿¡æ¯ã€‚"><meta property='og:url' content='https://Yin123-ybh.github.io/p/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82-spring-cloud-gateway-%E8%AF%B7%E6%B1%82%E6%B5%81serverwebexchangeserverhttprequest%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BC%A0%E9%80%92%E4%B8%8E%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B1%E4%BA%AB%E5%8E%9F%E7%90%86/'><meta property='og:site_name' content='Cecilia-å¡è¥¿è‰å¨…'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring Cloud Gateway'><meta property='article:tag' content='WebFlux'><meta property='article:tag' content='JWT'><meta property='article:tag' content='Filter'><meta property='article:tag' content='Reactive Programming'><meta property='article:tag' content='å¾®æœåŠ¡ç½‘å…³'><meta property='article:published_time' content='2025-01-20T10:00:00+08:00'><meta property='article:modified_time' content='2025-01-20T10:00:00+08:00'><meta name=twitter:title content="ä¸€æ–‡å½»åº•ææ‡‚ Spring Cloud Gateway è¯·æ±‚æµï¼šServerWebExchangeã€ServerHttpRequestã€è¯·æ±‚å¤´ä¼ é€’ä¸ç”¨æˆ·ä¿¡æ¯å…±äº«åŸç†"><meta name=twitter:description content="æ·±å…¥è§£æ Spring Cloud Gateway çš„åº•å±‚å“åº”å¼æ¶æ„ï¼ŒåŒ…æ‹¬ ServerWebExchangeã€ServerHttpRequest ä¸å¯å˜å¯¹è±¡æ¨¡å‹ã€mutate() æœºåˆ¶åŸç†ï¼Œä»¥åŠå¦‚ä½•å®‰å…¨é«˜æ•ˆåœ°ä¼ é€’ç”¨æˆ·ä¿¡æ¯ã€‚"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_8636e4c1b17bd1a4.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ§‘â€ğŸ’»</span></figure><div class=site-meta><h1 class=site-name><a href=/>Cecilia-å¡è¥¿è‰å¨…</a></h1><h2 class=site-description>Welcome to my website</h2></div></header><ol class=menu-social><li><a href=https://github.com/Yin123-ybh target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://Yin123-ybh.github.io/ selected>English</option><option value=https://Yin123-ybh.github.io/zh-cn/>ç®€ä½“ä¸­æ–‡</option><option value=https://Yin123-ybh.github.io/ar/>Ø¹Ø±Ø¨ÙŠ</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#-å‰è¨€>ğŸš€ å‰è¨€</a></li><li><a href=#-ä¸€spring-cloud-gateway-çš„å®šä½ä¸åŸç†>ğŸ§­ ä¸€ã€Spring Cloud Gateway çš„å®šä½ä¸åŸç†</a><ol><li><a href=#1-ä»€ä¹ˆæ˜¯ç½‘å…³>1. ä»€ä¹ˆæ˜¯ç½‘å…³</a></li><li><a href=#2-spring-cloud-gateway-çš„åº•å±‚å¼•æ“>2. Spring Cloud Gateway çš„åº•å±‚å¼•æ“</a><ol><li><a href=#å“åº”å¼ç¼–ç¨‹çš„ä¸‰é©¾é©¬è½¦>å“åº”å¼ç¼–ç¨‹çš„ä¸‰é©¾é©¬è½¦</a></li><li><a href=#æ€§èƒ½å¯¹æ¯”>æ€§èƒ½å¯¹æ¯”</a></li></ol></li></ol></li><li><a href=#-äºŒserverwebexchangeè¯·æ±‚çš„ä¸Šä¸‹æ–‡å®¹å™¨>ğŸ§© äºŒã€ServerWebExchangeï¼šè¯·æ±‚çš„"ä¸Šä¸‹æ–‡å®¹å™¨"</a><ol><li><a href=#å®ƒåŒ…å«ä»€ä¹ˆ>å®ƒåŒ…å«ä»€ä¹ˆï¼Ÿ</a></li><li><a href=#attributes-çš„å¦™ç”¨>attributes çš„å¦™ç”¨</a></li><li><a href=#ä¸¾ä¾‹è¯´æ˜>ä¸¾ä¾‹è¯´æ˜</a></li></ol></li><li><a href=#-ä¸‰serverhttprequest-ä¸-serverhttpresponse-è¯¦è§£>ğŸ§  ä¸‰ã€ServerHttpRequest ä¸ ServerHttpResponse è¯¦è§£</a><ol><li><a href=#1-serverhttprequest-çš„æ ¸å¿ƒèŒè´£>1. ServerHttpRequest çš„æ ¸å¿ƒèŒè´£</a></li><li><a href=#2-serverhttpresponse-çš„æ ¸å¿ƒèŒè´£>2. ServerHttpResponse çš„æ ¸å¿ƒèŒè´£</a></li></ol></li><li><a href=#-å››ä¸å¯å˜å¯¹è±¡immutable-objectæ¨¡å‹>âš™ï¸ å››ã€ä¸å¯å˜å¯¹è±¡ï¼ˆImmutable Objectï¼‰æ¨¡å‹</a><ol><li><a href=#1-ä¸ºä»€ä¹ˆè¦ä¸å¯å˜>1. ä¸ºä»€ä¹ˆè¦ä¸å¯å˜ï¼Ÿ</a><ol><li><a href=#ä¼ ç»Ÿå¯å˜å¯¹è±¡çš„é£é™©>ä¼ ç»Ÿå¯å˜å¯¹è±¡çš„é£é™©</a></li><li><a href=#å“åº”å¼ç¯å¢ƒä¸‹çš„è€ƒè™‘>å“åº”å¼ç¯å¢ƒä¸‹çš„è€ƒè™‘</a></li></ol></li><li><a href=#2-ä¸å¯å˜å¸¦æ¥çš„å¥½å¤„>2. ä¸å¯å˜å¸¦æ¥çš„å¥½å¤„</a></li><li><a href=#3-ä¸å¯å˜å¸¦æ¥çš„é™åˆ¶>3. ä¸å¯å˜å¸¦æ¥çš„"é™åˆ¶"</a></li></ol></li><li><a href=#-äº”mutate-çš„åº•å±‚åŸç†ä¸å®ç°ç»†èŠ‚>ğŸ§© äº”ã€mutate() çš„åº•å±‚åŸç†ä¸å®ç°ç»†èŠ‚</a><ol><li><a href=#1-mutate-æ˜¯ä»€ä¹ˆ>1. mutate() æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href=#2-å·¥ä½œåŸç†ç¤ºæ„>2. å·¥ä½œåŸç†ç¤ºæ„</a></li><li><a href=#3-mutate-çš„å†…éƒ¨å®ç°ç®€åŒ–ç‰ˆ>3. mutate() çš„å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</a></li><li><a href=#4-æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚>4. æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚</a></li></ol></li><li><a href=#-å…­é‡æ–°æ”¾å…¥-serverwebexchange>ğŸ”„ å…­ã€é‡æ–°æ”¾å…¥ ServerWebExchange</a><ol><li><a href=#1-åˆ›å»ºæ–°-exchange>1. åˆ›å»ºæ–° Exchange</a></li><li><a href=#2-å®Œæ•´æµç¨‹ç¤ºæ„>2. å®Œæ•´æµç¨‹ç¤ºæ„</a></li><li><a href=#3-ä¸ºä»€ä¹ˆ-response-å’Œ-attributes-ä¸å˜>3. ä¸ºä»€ä¹ˆ response å’Œ attributes ä¸å˜ï¼Ÿ</a></li></ol></li><li><a href=#-ä¸ƒä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä¼ é€’ç”¨æˆ·ä¿¡æ¯>ğŸ” ä¸ƒã€ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ</a><ol><li><a href=#1-æ€§èƒ½è€ƒè™‘>1. æ€§èƒ½è€ƒè™‘</a><ol><li><a href=#æ–¹æ¡ˆaæ¯ä¸ªæœåŠ¡éƒ½è§£æ-tokené‡å¤å·¥ä½œ>æ–¹æ¡ˆAï¼šæ¯ä¸ªæœåŠ¡éƒ½è§£æ Tokenï¼ˆé‡å¤å·¥ä½œï¼‰</a></li><li><a href=#æ–¹æ¡ˆbç½‘å…³è§£æé€šè¿‡-header-ä¼ é€’æ¨è>æ–¹æ¡ˆBï¼šç½‘å…³è§£æï¼Œé€šè¿‡ Header ä¼ é€’ï¼ˆæ¨èï¼‰</a></li></ol></li><li><a href=#2-æœ€ç®€å•çš„åŠæ³•åœ¨è¯·æ±‚å¤´ä¸­é™„åŠ ç”¨æˆ·ä¿¡æ¯>2. æœ€ç®€å•çš„åŠæ³•ï¼šåœ¨è¯·æ±‚å¤´ä¸­é™„åŠ ç”¨æˆ·ä¿¡æ¯</a></li><li><a href=#3-æ•°æ®ä¼ é€’ç¤ºä¾‹>3. æ•°æ®ä¼ é€’ç¤ºä¾‹</a></li></ol></li><li><a href=#-å…«æ›¿ä»£æ–¹æ¡ˆä¸å®‰å…¨è€ƒè™‘>ğŸ§° å…«ã€æ›¿ä»£æ–¹æ¡ˆä¸å®‰å…¨è€ƒè™‘</a><ol><li><a href=#1-attributes-æ–¹å¼ä»…å†…éƒ¨ä½¿ç”¨>1. attributes æ–¹å¼ï¼ˆä»…å†…éƒ¨ä½¿ç”¨ï¼‰</a><ol><li><a href=#attributes-vs-header-å¯¹æ¯”>attributes vs Header å¯¹æ¯”</a></li></ol></li><li><a href=#2-è¯·æ±‚å¤´æ–¹å¼è·¨æœåŠ¡ä¼ é€’>2. è¯·æ±‚å¤´æ–¹å¼ï¼ˆè·¨æœåŠ¡ä¼ é€’ï¼‰</a><ol><li><a href=#å®‰å…¨é£é™©>å®‰å…¨é£é™©</a></li><li><a href=#å®‰å…¨å»ºè®®>å®‰å…¨å»ºè®®</a></li></ol></li><li><a href=#3-ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡ç†é«˜çº§æ–¹æ¡ˆ>3. ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰</a></li></ol></li><li><a href=#-ä¹è¯·æ±‚æµå®Œæ•´æ‰§è¡Œè¿‡ç¨‹>âš¡ ä¹ã€è¯·æ±‚æµå®Œæ•´æ‰§è¡Œè¿‡ç¨‹</a><ol><li><a href=#é˜¶æ®µ1è¯·æ±‚åˆ°è¾¾-gateway>é˜¶æ®µ1ï¼šè¯·æ±‚åˆ°è¾¾ Gateway</a></li><li><a href=#é˜¶æ®µ2è¿›å…¥-globalfilter>é˜¶æ®µ2ï¼šè¿›å…¥ GlobalFilter</a></li><li><a href=#é˜¶æ®µ3è·¯ç”±è½¬å‘>é˜¶æ®µ3ï¼šè·¯ç”±è½¬å‘</a></li><li><a href=#é˜¶æ®µ4ä¸‹æ¸¸æœåŠ¡å¤„ç†>é˜¶æ®µ4ï¼šä¸‹æ¸¸æœåŠ¡å¤„ç†</a></li><li><a href=#é˜¶æ®µ5å“åº”è¿”å›>é˜¶æ®µ5ï¼šå“åº”è¿”å›</a></li></ol></li><li><a href=#-åç”Ÿäº§å®è·µç»éªŒæ€»ç»“>ğŸ’¡ åã€ç”Ÿäº§å®è·µç»éªŒæ€»ç»“</a><ol><li><a href=#1-ä¸è¦ä¿®æ”¹åŸå§‹å¯¹è±¡>1. ä¸è¦ä¿®æ”¹åŸå§‹å¯¹è±¡</a></li><li><a href=#2-ä½¿ç”¨-header-ä¼ é€’è½»é‡çº§ä¿¡æ¯>2. ä½¿ç”¨ Header ä¼ é€’è½»é‡çº§ä¿¡æ¯</a></li><li><a href=#3-ç½‘å…³æ˜¯è¯·æ±‚å…¥å£--å®‰å…¨è¾¹ç•Œ>3. ç½‘å…³æ˜¯"è¯·æ±‚å…¥å£ + å®‰å…¨è¾¹ç•Œ"</a></li><li><a href=#4-å“åº”å¼é“¾ä¸­çš„å¯¹è±¡å‡ä¸ºä¸€æ¬¡æ€§ä½¿ç”¨>4. å“åº”å¼é“¾ä¸­çš„å¯¹è±¡å‡ä¸ºä¸€æ¬¡æ€§ä½¿ç”¨</a></li><li><a href=#5-æ¨èæ­é…-mdc-æˆ–-threadlocal-ä¸Šä¸‹æ–‡è·Ÿè¸ª>5. æ¨èæ­é… MDC æˆ– ThreadLocal ä¸Šä¸‹æ–‡è·Ÿè¸ª</a></li><li><a href=#6-æ€§èƒ½ä¼˜åŒ–æŠ€å·§>6. æ€§èƒ½ä¼˜åŒ–æŠ€å·§</a></li></ol></li><li><a href=#-åä¸€ç¤ºæ„å›¾è¯·æ±‚æµè½¬å…¨è¿‡ç¨‹>ğŸ§± åä¸€ã€ç¤ºæ„å›¾ï¼šè¯·æ±‚æµè½¬å…¨è¿‡ç¨‹</a></li><li><a href=#-åäºŒå¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ>ğŸ¯ åäºŒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a><ol><li><a href=#q1å¦‚ä½•åœ¨-filter-ä¸­è·å–æˆ–ä¿®æ”¹è¯·æ±‚ä½“>Q1ï¼šå¦‚ä½•åœ¨ Filter ä¸­è·å–æˆ–ä¿®æ”¹è¯·æ±‚ä½“ï¼Ÿ</a></li><li><a href=#q2å¦‚ä½•åœ¨-filter-ä¸­è·å–å“åº”ä½“>Q2ï¼šå¦‚ä½•åœ¨ Filter ä¸­è·å–å“åº”ä½“ï¼Ÿ</a></li><li><a href=#q3filter-çš„æ‰§è¡Œé¡ºåºå¦‚ä½•æ§åˆ¶>Q3ï¼šFilter çš„æ‰§è¡Œé¡ºåºå¦‚ä½•æ§åˆ¶ï¼Ÿ</a></li><li><a href=#q4å¦‚ä½•å®ç°ç†”æ–­é™çº§>Q4ï¼šå¦‚ä½•å®ç°ç†”æ–­é™çº§ï¼Ÿ</a></li></ol></li><li><a href=#-åä¸‰ç»“è¯­>ğŸ åä¸‰ã€ç»“è¯­</a><ol><li><a href=#æ ¸å¿ƒè¦ç‚¹å›é¡¾>æ ¸å¿ƒè¦ç‚¹å›é¡¾</a></li><li><a href=#ä¸‹ä¸€æ­¥å­¦ä¹ >ä¸‹ä¸€æ­¥å­¦ä¹ </a></li></ol></li><li><a href=#-å»¶ä¼¸é˜…è¯»>ğŸ“š å»¶ä¼¸é˜…è¯»</a><ol><li><a href=#å®˜æ–¹æ–‡æ¡£>å®˜æ–¹æ–‡æ¡£</a></li><li><a href=#æŠ€æœ¯è§„èŒƒ>æŠ€æœ¯è§„èŒƒ</a></li><li><a href=#æ¨èä¹¦ç±>æ¨èä¹¦ç±</a></li><li><a href=#ç›¸å…³æ–‡ç« >ç›¸å…³æ–‡ç« </a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%8A%80%E6%9C%AF%E5%8D%9A%E5%AE%A2/>æŠ€æœ¯åšå®¢
</a><a href=/categories/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/>åç«¯æ¶æ„</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82-spring-cloud-gateway-%E8%AF%B7%E6%B1%82%E6%B5%81serverwebexchangeserverhttprequest%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BC%A0%E9%80%92%E4%B8%8E%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B1%E4%BA%AB%E5%8E%9F%E7%90%86/>ä¸€æ–‡å½»åº•ææ‡‚ Spring Cloud Gateway è¯·æ±‚æµï¼šServerWebExchangeã€ServerHttpRequestã€è¯·æ±‚å¤´ä¼ é€’ä¸ç”¨æˆ·ä¿¡æ¯å…±äº«åŸç†</a></h2><h3 class=article-subtitle>æ·±å…¥è§£æ Spring Cloud Gateway çš„åº•å±‚å“åº”å¼æ¶æ„ï¼ŒåŒ…æ‹¬ ServerWebExchangeã€ServerHttpRequest ä¸å¯å˜å¯¹è±¡æ¨¡å‹ã€mutate() æœºåˆ¶åŸç†ï¼Œä»¥åŠå¦‚ä½•å®‰å…¨é«˜æ•ˆåœ°ä¼ é€’ç”¨æˆ·ä¿¡æ¯ã€‚</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-01-20</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><h2 id=-å‰è¨€>ğŸš€ å‰è¨€</h2><p>åœ¨ä½¿ç”¨ <strong>Spring Cloud Gateway</strong> å¼€å‘å¾®æœåŠ¡ç½‘å…³æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šçœ‹åˆ°è¿™æ ·ä¸€æ®µç»å…¸ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>GatewayFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isExclude</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getPath</span><span class=p>().</span><span class=na>toString</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;authorization&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtTool</span><span class=p>.</span><span class=na>parseToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>UnauthorizedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>().</span><span class=na>setStatusCode</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>().</span><span class=na>setComplete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userId</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>newExchange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>newRequest</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>newExchange</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>çœ‹ä¼¼ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå®é™…ä¸Šè•´å«äº† Spring Cloud Gateway çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š
<strong>å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰</strong>ã€<strong>ä¸å¯å˜æ•°æ®æ¨¡å‹ï¼ˆImmutable Modelï¼‰</strong> ä¸ <strong>å£°æ˜å¼æ•°æ®æµï¼ˆDeclarative Data Flowï¼‰</strong>ã€‚</p><p>æœ¬æ–‡å°†å¸¦ä½ ä»åº•å±‚åŸç†å‡ºå‘ï¼Œæ·±å…¥ç†è§£è¿™ä¸€åˆ‡çš„èƒŒåé€»è¾‘ã€‚</p><hr><h2 id=-ä¸€spring-cloud-gateway-çš„å®šä½ä¸åŸç†>ğŸ§­ ä¸€ã€Spring Cloud Gateway çš„å®šä½ä¸åŸç†</h2><h3 id=1-ä»€ä¹ˆæ˜¯ç½‘å…³>1. ä»€ä¹ˆæ˜¯ç½‘å…³</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç½‘å…³ï¼ˆGatewayï¼‰æ˜¯<strong>æ‰€æœ‰å¤–éƒ¨è¯·æ±‚çš„å”¯ä¸€å…¥å£</strong>ã€‚
å®ƒè´Ÿè´£ï¼š</p><ul><li><strong>ç»Ÿä¸€è®¤è¯ä¸é‰´æƒ</strong>ï¼šæ‰€æœ‰è¯·æ±‚åœ¨è¿›å…¥å¾®æœåŠ¡ä¹‹å‰ï¼Œå…ˆç»è¿‡ç½‘å…³çš„èº«ä»½éªŒè¯</li><li><strong>æµé‡æ§åˆ¶ä¸é™æµ</strong>ï¼šé˜²æ­¢å•ä¸ªæœåŠ¡è¢«å‹å®</li><li><strong>è·¯ç”±åˆ†å‘</strong>ï¼šæ ¹æ®è§„åˆ™å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡</li><li><strong>æ—¥å¿—è¿½è¸ªä¸ç›‘æ§</strong>ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜</li><li><strong>å‚æ•°è¿‡æ»¤ä¸å®‰å…¨æ ¡éªŒ</strong>ï¼šSQLæ³¨å…¥ã€XSSæ”»å‡»ç­‰å®‰å…¨é˜²æŠ¤</li><li><strong>è·¨åŸŸå¤„ç†</strong>ï¼šç»Ÿä¸€å¤„ç†CORSé—®é¢˜</li></ul><p>å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š</p><blockquote><p><strong>&ldquo;æ‰€æœ‰å¾®æœåŠ¡çš„é—¨å« + å®‰ä¿ + æ¥å¾…å‘˜&rdquo;</strong></p></blockquote><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚   Client    â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>       â”‚
</span></span><span class=line><span class=cl>       â†“
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚     Spring Cloud Gateway            â”‚
</span></span><span class=line><span class=cl>â”‚                                     â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  GlobalFilter                â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  - è®¤è¯é‰´æƒ                   â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  - é™æµç†”æ–­                   â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  - æ—¥å¿—è¿½è¸ª                   â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â”‚              â†“                      â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  RouteLocator                â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  - è·¯ç”±åŒ¹é…                   â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  - è½¬å‘è§„åˆ™                   â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>               â”‚
</span></span><span class=line><span class=cl>               â†“
</span></span><span class=line><span class=cl>    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>    â”‚                     â”‚
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚ Order  â”‚          â”‚ Product  â”‚
</span></span><span class=line><span class=cl>â”‚Service â”‚          â”‚ Service  â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=2-spring-cloud-gateway-çš„åº•å±‚å¼•æ“>2. Spring Cloud Gateway çš„åº•å±‚å¼•æ“</h3><p>Spring Cloud Gateway æ„å»ºåœ¨ <strong>Spring WebFlux</strong> ä¹‹ä¸Šï¼Œ
è€Œ WebFlux åˆæ˜¯åŸºäº <strong>Reactor å“åº”å¼æµï¼ˆReactive Streamsï¼‰</strong> æ ‡å‡†ã€‚</p><h4 id=å“åº”å¼ç¼–ç¨‹çš„ä¸‰é©¾é©¬è½¦>å“åº”å¼ç¼–ç¨‹çš„ä¸‰é©¾é©¬è½¦</h4><p><strong>Reactor</strong> æ˜¯ Spring å›¢é˜Ÿå¼€å‘çš„å“åº”å¼æµåº“ï¼Œæä¾›ä¸¤ä¸ªæ ¸å¿ƒç±»å‹ï¼š</p><ul><li><strong>Mono</strong>ï¼šè¡¨ç¤ºå¼‚æ­¥çš„0-1ä¸ªå€¼ï¼ˆç±»ä¼¼ Optionalï¼‰</li><li><strong>Flux</strong>ï¼šè¡¨ç¤ºå¼‚æ­¥çš„0-Nä¸ªå€¼çš„åºåˆ—</li></ul><p>WebFlux çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š</p><blockquote><p><strong>éé˜»å¡ + å¼‚æ­¥ + é«˜å¹¶å‘ + å‡½æ•°å¼ç¼–ç¨‹é£æ ¼</strong></p></blockquote><p>è¿™æ„å‘³ç€ï¼š</p><ul><li>âœ… <strong>æ¯ä¸ªè¯·æ±‚ä¸ä¼šç‹¬å çº¿ç¨‹</strong>ï¼šä¼ ç»Ÿ Servlet æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹èµ„æºæœ‰é™ï¼ˆé€šå¸¸å‡ ç™¾ä¸ªï¼‰ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å¾ˆå®¹æ˜“è€—å°½</li><li>âœ… <strong>æ•°æ®åœ¨ Filter é“¾ä¸­ä»¥ã€Œæµã€çš„å½¢å¼ä¼ é€’</strong>ï¼šæ•°æ®æ˜¯æµåŠ¨çš„ï¼Œä¸æ˜¯é™æ­¢çš„</li><li>âœ… <strong>æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸å¯å˜çš„ï¼ˆImmutableï¼‰</strong>ï¼šåœ¨å¼‚æ­¥ç¯å¢ƒä¸‹ä¿è¯çº¿ç¨‹å®‰å…¨</li><li>âœ… <strong>è¿‡æ»¤å™¨ä¹‹é—´é€šè¿‡ Mono / Flux ç»„åˆå½¢æˆå¼‚æ­¥ç®¡é“</strong>ï¼šä»£ç æ˜¯å£°æ˜å¼çš„ï¼Œæè¿°"åšä»€ä¹ˆ"è€Œé"æ€ä¹ˆåš"</li></ul><h4 id=æ€§èƒ½å¯¹æ¯”>æ€§èƒ½å¯¹æ¯”</h4><div class=table-wrapper><table><thead><tr><th>ç‰¹æ€§</th><th>ä¼ ç»Ÿ Servlet</th><th>Spring WebFlux</th></tr></thead><tbody><tr><td>I/Oæ¨¡å‹</td><td>é˜»å¡IO</td><td>éé˜»å¡IO</td></tr><tr><td>çº¿ç¨‹æ¨¡å‹</td><td>æ¯ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼ˆæµªè´¹ï¼‰</td><td>äº‹ä»¶å¾ªç¯ï¼ˆé«˜æ•ˆï¼‰</td></tr><tr><td>å¹¶å‘èƒ½åŠ›</td><td>~200 req/s per thread</td><td>~10,000 req/s</td></tr><tr><td>ç¼–ç¨‹é£æ ¼</td><td>å‘½ä»¤å¼</td><td>å£°æ˜å¼ï¼ˆå‡½æ•°å¼ï¼‰</td></tr></tbody></table></div><hr><h2 id=-äºŒserverwebexchangeè¯·æ±‚çš„ä¸Šä¸‹æ–‡å®¹å™¨>ğŸ§© äºŒã€ServerWebExchangeï¼šè¯·æ±‚çš„"ä¸Šä¸‹æ–‡å®¹å™¨"</h2><p>åœ¨ WebFlux ä¸­ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚ä¼šè¢«å°è£…ä¸ºä¸€ä¸ª <code>ServerWebExchange</code> å¯¹è±¡ã€‚</p><h3 id=å®ƒåŒ…å«ä»€ä¹ˆ>å®ƒåŒ…å«ä»€ä¹ˆï¼Ÿ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ServerWebExchange
</span></span><span class=line><span class=cl>â”œâ”€â”€ ServerHttpRequest   â†’ è¯·æ±‚éƒ¨åˆ†ï¼ˆURLã€Headerã€Bodyç­‰ï¼‰
</span></span><span class=line><span class=cl>â”œâ”€â”€ ServerHttpResponse  â†’ å“åº”éƒ¨åˆ†ï¼ˆHeaderã€Bodyç­‰ï¼‰
</span></span><span class=line><span class=cl>â””â”€â”€ attributes           â†’ Mapç»“æ„çš„å…±äº«ä¸Šä¸‹æ–‡ï¼ˆFilteré—´ä¼ é€’æ•°æ®ï¼‰
</span></span></code></pre></td></tr></table></div></div><p>ç†è§£æ–¹å¼ï¼š</p><blockquote><p><strong>&ldquo;ServerWebExchange å°±åƒä¸€ä¸ªä¿¡å°ï¼Œé‡Œé¢è£…ç€è¯·æ±‚(request)å’Œå“åº”(response)ï¼Œå¹¶é™„å¸¦ä¸€å¼ å°çº¸æ¡ï¼ˆattributesï¼‰æ¥è®°å½•é¢å¤–ä¿¡æ¯ã€‚&rdquo;</strong></p></blockquote><h3 id=attributes-çš„å¦™ç”¨>attributes çš„å¦™ç”¨</h3><p><code>attributes</code> æ˜¯ä¸€ä¸ª <code>Map&lt;String, Object></code>ï¼Œç”¨äºåœ¨åŒä¸€è¯·æ±‚çš„å¤„ç†é“¾ä¸­ä¼ é€’è‡ªå®šä¹‰æ•°æ®ã€‚</p><p>å¸¸è§çš„ç”¨é€”ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨ç¬¬ä¸€ä¸ª Filter ä¸­è®¾ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;startTime&#34;</span><span class=p>,</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;requestId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åœ¨åç»­ Filter ä¸­è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Long</span><span class=p>)</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;startTime&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;requestId&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ä¸¾ä¾‹è¯´æ˜>ä¸¾ä¾‹è¯´æ˜</h3><p>å½“ç”¨æˆ·è¯·æ±‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /api/order?id=1
</span></span><span class=line><span class=cl>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ Gateway å±‚å°±ä¼šè¢«è§£ææˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>URI</span><span class=w> </span><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getURI</span><span class=p>();</span><span class=w>                    </span><span class=c1>// /api/order?id=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpMethod</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>        </span><span class=c1>// GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpHeaders</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>();</span><span class=w>     </span><span class=c1>// Authorization, Content-Type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getBody</span><span class=p>();</span><span class=w>     </span><span class=c1>// è¯·æ±‚ä½“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å“åº”å¯¹è±¡ï¼ˆç”¨äºå‘å®¢æˆ·ç«¯è¿”å›ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>response</span><span class=p>.</span><span class=na>setStatusCode</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>OK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>response</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å…±äº«å±æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>attrs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>attrs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>10086L</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=-ä¸‰serverhttprequest-ä¸-serverhttpresponse-è¯¦è§£>ğŸ§  ä¸‰ã€ServerHttpRequest ä¸ ServerHttpResponse è¯¦è§£</h2><p>è¿™ä¸¤ä¸ªç±»åˆ†åˆ«å°è£…äº† HTTP åè®®ä¸­çš„è¯·æ±‚ä¸å“åº”éƒ¨åˆ†ã€‚</p><h3 id=1-serverhttprequest-çš„æ ¸å¿ƒèŒè´£>1. ServerHttpRequest çš„æ ¸å¿ƒèŒè´£</h3><p>è´Ÿè´£ä¿å­˜ï¼š</p><ul><li><strong>è¯·æ±‚æ–¹æ³•ï¼ˆMethodï¼‰</strong>ï¼šGETã€POSTã€PUTã€DELETE ç­‰</li><li><strong>URL ä¿¡æ¯</strong>ï¼šå®Œæ•´è·¯å¾„ã€æŸ¥è¯¢å‚æ•°ã€è·¯å¾„å˜é‡</li><li><strong>è¯·æ±‚å¤´ï¼ˆHeadersï¼‰</strong>ï¼šAuthorizationã€Content-Type ç­‰</li><li><strong>è¯·æ±‚ä½“ï¼ˆBodyï¼‰</strong>ï¼šä»¥ Flux<databuffer> å½¢å¼æä¾›ï¼Œæ”¯æŒæµå¼è¯»å–</li></ul><p>å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚è·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getURI</span><span class=p>().</span><span class=na>getPath</span><span class=p>();</span><span class=w>        </span><span class=c1>// /api/orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getURI</span><span class=p>().</span><span class=na>getQuery</span><span class=p>();</span><span class=w>      </span><span class=c1>// id=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚å¤´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>auth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>contentType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpMethod</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>          </span><span class=c1>// GET, POST, etc.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚ä½“ï¼ˆéœ€è¦è®¢é˜… Fluxï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getBody</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>collectList</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>dataBuffers</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¤„ç†è¯·æ±‚ä½“æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-serverhttpresponse-çš„æ ¸å¿ƒèŒè´£>2. ServerHttpResponse çš„æ ¸å¿ƒèŒè´£</h3><p>è´Ÿè´£ï¼š</p><ul><li><strong>å“åº”çŠ¶æ€ç </strong>ï¼š200ã€401ã€404ã€500 ç­‰</li><li><strong>å“åº”å¤´</strong>ï¼šContent-Typeã€Set-Cookie ç­‰</li><li><strong>å“åº”ä½“è¾“å‡ºæµ</strong>ï¼šä»¥ Reactive æ–¹å¼å†™å…¥</li></ul><p>ç¤ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerHttpResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¾ç½®çŠ¶æ€ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>response</span><span class=p>.</span><span class=na>setStatusCode</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¾ç½®å“åº”å¤´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>response</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å†™å…¥å“åº”ä½“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>response</span><span class=p>.</span><span class=na>writeWith</span><span class=p>(</span><span class=n>Flux</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>bufferFactory</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=s>&#34;{\&#34;error\&#34;:\&#34;Unauthorized\&#34;}&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>())));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æˆ–è€…ç›´æ¥è®¾ç½®ä¸ºå®Œæˆï¼ˆç©ºå“åº”ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>setComplete</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=-å››ä¸å¯å˜å¯¹è±¡immutable-objectæ¨¡å‹>âš™ï¸ å››ã€ä¸å¯å˜å¯¹è±¡ï¼ˆImmutable Objectï¼‰æ¨¡å‹</h2><p>è¿™ä¸€ç‚¹æ˜¯å¾ˆå¤šäººç¬¬ä¸€æ¬¡ä½¿ç”¨ WebFlux/Gateway æ—¶æœ€éš¾ç†è§£çš„åœ°æ–¹ã€‚</p><h3 id=1-ä¸ºä»€ä¹ˆè¦ä¸å¯å˜>1. ä¸ºä»€ä¹ˆè¦ä¸å¯å˜ï¼Ÿ</h3><p>åœ¨å“åº”å¼æ¶æ„ä¸­ï¼Œç³»ç»Ÿè¦åŒæ—¶å¤„ç†æˆåƒä¸Šä¸‡ä¸ªå¼‚æ­¥è¯·æ±‚ã€‚
å¦‚æœå¯¹è±¡æ˜¯å¯å˜çš„ï¼ˆMutableï¼‰ï¼Œé‚£ä¹ˆä¸åŒçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªè¯·æ±‚å¯¹è±¡æ—¶ï¼Œå°±ä¼šå¯¼è‡´<strong>æ•°æ®ç«äº‰å’Œä¸å¯é¢„æµ‹çš„é”™è¯¯</strong>ã€‚</p><h4 id=ä¼ ç»Ÿå¯å˜å¯¹è±¡çš„é£é™©>ä¼ ç»Ÿå¯å˜å¯¹è±¡çš„é£é™©</h4><p>å‡è®¾æœ‰è¿™æ ·çš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é”™è¯¯ç¤ºä¾‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Request</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setUserId</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=o>-</span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=s>&#34;10086&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=o>-</span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=s>&#34;10087&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æœ€ç»ˆ userId çš„å€¼ä¸ç¡®å®šï¼</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯å˜å¯¹è±¡ä¼šé€ æˆï¼š</p><ul><li>æ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰</li><li>çº¿ç¨‹ä¸å®‰å…¨</li><li>éš¾ä»¥è°ƒè¯•å’Œè¿½è¸ª</li></ul><h4 id=å“åº”å¼ç¯å¢ƒä¸‹çš„è€ƒè™‘>å“åº”å¼ç¯å¢ƒä¸‹çš„è€ƒè™‘</h4><p>åœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢æ‰§è¡Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>è¯·æ±‚1 â†’ Thread-A â†’ åˆ‡æ¢åˆ° Thread-B â†’ ç»§ç»­æ‰§è¡Œ
</span></span><span class=line><span class=cl>è¯·æ±‚2 â†’ Thread-C â†’ ç»§ç»­æ‰§è¡Œ
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœå¯¹è±¡å¯å˜ï¼Œä¸åŒçº¿ç¨‹ä¿®æ”¹åŒä¸€å¯¹è±¡ä¼šå¯¼è‡´ï¼š</p><ul><li>æ•°æ®ä¸ä¸€è‡´</li><li>ä¸å¯é¢„æµ‹çš„è¡Œä¸º</li><li>éœ€è¦å¤§é‡é”æœºåˆ¶ï¼Œé™ä½æ€§èƒ½</li></ul><p>å› æ­¤ï¼š</p><blockquote><p><strong>WebFlux ä¸­æ‰€æœ‰å…³é”®å¯¹è±¡ï¼ˆ<code>ServerWebExchange</code>ã€<code>ServerHttpRequest</code>ã€<code>ServerHttpResponse</code>ï¼‰éƒ½æ˜¯ä¸å¯å˜çš„ã€‚</strong></p></blockquote><h3 id=2-ä¸å¯å˜å¸¦æ¥çš„å¥½å¤„>2. ä¸å¯å˜å¸¦æ¥çš„å¥½å¤„</h3><ul><li>âœ… <strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šä¸éœ€è¦é¢å¤–çš„é”æœºåˆ¶</li><li>âœ… <strong>å¯é¢„æµ‹æ€§</strong>ï¼šæ•°æ®ä¸ä¼šè¢«æ„å¤–ä¿®æ”¹</li><li>âœ… <strong>æ˜“äºå¹¶å‘</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨åœ°åŒæ—¶è¯»å–</li><li>âœ… <strong>å‡½æ•°å¼é£æ ¼</strong>ï¼šç¬¦åˆ"æ— å‰¯ä½œç”¨"åŸåˆ™</li></ul><h3 id=3-ä¸å¯å˜å¸¦æ¥çš„é™åˆ¶>3. ä¸å¯å˜å¸¦æ¥çš„"é™åˆ¶"</h3><p>ä½ <strong>ä¸èƒ½ç›´æ¥ä¿®æ”¹è¯·æ±‚å¤´</strong>ã€<strong>ä¸èƒ½ç›´æ¥æ”¹URL</strong>ã€‚</p><p>ä¾‹å¦‚ï¼Œè¿™æ ·çš„ä»£ç æ˜¯ä¸å¯è¡Œçš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// âŒ é”™è¯¯ï¼šå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ²¡æœ‰ setter æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;10086&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>setPath</span><span class=p>(</span><span class=s>&#34;/new/path&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¿…é¡»é€šè¿‡ä¸€ä¸ªç‰¹æ®Šæœºåˆ¶ï¼š<strong><code>mutate()</code></strong>ã€‚</p><hr><h2 id=-äº”mutate-çš„åº•å±‚åŸç†ä¸å®ç°ç»†èŠ‚>ğŸ§© äº”ã€mutate() çš„åº•å±‚åŸç†ä¸å®ç°ç»†èŠ‚</h2><h3 id=1-mutate-æ˜¯ä»€ä¹ˆ>1. mutate() æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><code>mutate()</code> æ˜¯ä¸€ä¸ª<strong>æ„å»ºå™¨ï¼ˆBuilderï¼‰æ¨¡å¼</strong>çš„å®ç°ã€‚
å®ƒçš„å·¥ä½œæœºåˆ¶å¦‚ä¸‹ï¼š</p><ol><li><strong>æ‹·è´åŸå¯¹è±¡çš„æ‰€æœ‰å­—æ®µ</strong></li><li><strong>åº”ç”¨ä½ æƒ³è¦çš„ä¿®æ”¹</strong></li><li><strong>è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡å®ä¾‹</strong></li></ol><h3 id=2-å·¥ä½œåŸç†ç¤ºæ„>2. å·¥ä½œåŸç†ç¤ºæ„</h3><p>ä»¥è¯·æ±‚ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åŸå§‹çš„è¯·æ±‚å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>oldRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä½¿ç”¨ mutate() åˆ›å»ºæ–°è¯·æ±‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldRequest</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;10086&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userRole&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ADMIN&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>path</span><span class=p>(</span><span class=s>&#34;/new/path&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œåï¼š</p><ul><li>âœ… åŸæ¥çš„ <code>oldRequest</code> ä¾æ—§ä¿ç•™ï¼Œå†…å®¹ä¸å˜</li><li>âœ… æ–°çš„ <code>newRequest</code> æ˜¯"å…‹éš†ä½“"ï¼ŒåŒ…å«ç›¸åŒçš„æ•°æ® + æ–°çš„ header</li></ul><h3 id=3-mutate-çš„å†…éƒ¨å®ç°ç®€åŒ–ç‰ˆ>3. mutate() çš„å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ServerHttpRequest æ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>ServerHttpRequest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// mutate() æ–¹æ³•è¿”å›æ„å»ºå™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=w> </span><span class=n>Builder</span><span class=w> </span><span class=nf>mutate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultBuilder</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ„å»ºå™¨æ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>interface</span> <span class=nc>Builder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Builder</span><span class=w> </span><span class=nf>header</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Builder</span><span class=w> </span><span class=nf>path</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>path</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=nf>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å…·ä½“å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>DefaultBuilder</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ServerHttpRequest</span><span class=p>.</span><span class=na>Builder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>delegate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DefaultBuilder</span><span class=p>(</span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>delegate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>delegate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>delegate</span><span class=p>;</span><span class=w>  </span><span class=c1>// ä¿å­˜åŸå§‹å¯¹è±¡å¼•ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Builder</span><span class=w> </span><span class=nf>header</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®°å½•ä¿®æ”¹æ“ä½œï¼Œä½†ä¸ç«‹å³æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>headersToAdd</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=nf>build</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åœ¨è¿™é‡Œåˆ›å»ºæ–°å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DelegatingServerHttpRequest</span><span class=p>(</span><span class=n>delegate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>HttpHeaders</span><span class=w> </span><span class=nf>getHeaders</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HttpHeaders</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpHeaders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>headers</span><span class=p>.</span><span class=na>putAll</span><span class=p>(</span><span class=n>delegate</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>headers</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>headersToAdd</span><span class=p>);</span><span class=w>  </span><span class=c1>// åº”ç”¨ä¿®æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>headers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™å°±æ˜¯ <strong>å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ä¸­çš„æ— å‰¯ä½œç”¨ï¼ˆNo Side Effectï¼‰</strong>ã€‚</p><h3 id=4-æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚>4. æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚</h3><p>WebFlux çš„å®ç°éå¸¸é«˜æ•ˆï¼š</p><ul><li><strong>å»¶è¿Ÿæ‹·è´ï¼ˆLazy Copy-on-Writeï¼‰</strong>ï¼šåªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»ºå‰¯æœ¬</li><li><strong>å¯¹è±¡æ± åŒ–</strong>ï¼šå¤ç”¨åº•å±‚æ•°æ®ç»“æ„</li><li><strong>é›¶æ‹·è´</strong>ï¼šå°½å¯èƒ½é¿å…ä¸å¿…è¦çš„æ•°æ®ç§»åŠ¨</li></ul><hr><h2 id=-å…­é‡æ–°æ”¾å…¥-serverwebexchange>ğŸ”„ å…­ã€é‡æ–°æ”¾å…¥ ServerWebExchange</h2><p>ä¿®æ”¹å®Œè¯·æ±‚åï¼Œå¦‚æœæƒ³ç»§ç»­å¾€ä¸‹ä¼ é€’ï¼Œå°±è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ServerWebExchange</code>ã€‚</p><h3 id=1-åˆ›å»ºæ–°-exchange>1. åˆ›å»ºæ–° Exchange</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>newExchange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>newRequest</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å®ƒä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ exchange å®ä¾‹ï¼ŒåŒ…å«ï¼š</p><ul><li><strong>æ–°çš„ request</strong>ï¼ˆåŠ äº† headerï¼‰</li><li><strong>åŸæ¥çš„ response</strong>ï¼ˆæ²¡å˜ï¼‰</li><li><strong>åŸæ¥çš„ attributes</strong>ï¼ˆæ²¡å˜ï¼Œä½†å†…å®¹ç›¸åŒï¼‰</li></ul><h3 id=2-å®Œæ•´æµç¨‹ç¤ºæ„>2. å®Œæ•´æµç¨‹ç¤ºæ„</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>æ—§ exchange
</span></span><span class=line><span class=cl>â”‚
</span></span><span class=line><span class=cl>â”œâ”€â”€ request: 
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ path: /api/order
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ method: GET
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ headers: {Authorization: Bearer xxx}
</span></span><span class=line><span class=cl>â”‚
</span></span><span class=line><span class=cl>â”œâ”€â”€ response: 
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ statusCode: null
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ headers: {}
</span></span><span class=line><span class=cl>â”‚
</span></span><span class=line><span class=cl>â””â”€â”€ attributes: {}
</span></span><span class=line><span class=cl>   â†“ mutate() ä¿®æ”¹
</span></span><span class=line><span class=cl>   â†“
</span></span><span class=line><span class=cl>æ–° exchange
</span></span><span class=line><span class=cl>â”‚
</span></span><span class=line><span class=cl>â”œâ”€â”€ request: 
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ path: /api/order
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ method: GET
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ headers: {
</span></span><span class=line><span class=cl>â”‚       Authorization: Bearer xxx,
</span></span><span class=line><span class=cl>â”‚       userId: 10086        â† æ–°å¢
</span></span><span class=line><span class=cl>â”‚   }
</span></span><span class=line><span class=cl>â”‚
</span></span><span class=line><span class=cl>â”œâ”€â”€ response: (æœªå˜)
</span></span><span class=line><span class=cl>â””â”€â”€ attributes: (æœªå˜)
</span></span></code></pre></td></tr></table></div></div><h3 id=3-ä¸ºä»€ä¹ˆ-response-å’Œ-attributes-ä¸å˜>3. ä¸ºä»€ä¹ˆ response å’Œ attributes ä¸å˜ï¼Ÿ</h3><ul><li><strong>response</strong>ï¼šå¦‚æœæ²¡ä¿®æ”¹ï¼Œå¤ç”¨åŸæ¥çš„å°±å¥½ï¼Œé¿å…ä¸å¿…è¦çš„æ‹·è´</li><li><strong>attributes</strong>ï¼šå…±äº«ä¸Šä¸‹æ–‡ï¼Œæ‰€æœ‰å¼•ç”¨éƒ½æŒ‡å‘åŒä¸€ä¸ª Mapï¼Œä¿®æ”¹æ˜¯å®‰å…¨çš„</li></ul><hr><h2 id=-ä¸ƒä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä¼ é€’ç”¨æˆ·ä¿¡æ¯>ğŸ” ä¸ƒã€ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ</h2><p>åœ¨ç½‘å…³å±‚éªŒè¯å®Œ JWT Token åï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠç”¨æˆ·èº«ä»½ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ã€‚
å¦åˆ™æ¯ä¸ªå¾®æœåŠ¡éƒ½è¦é‡å¤è§£æ Tokenï¼Œæµªè´¹æ€§èƒ½ã€‚</p><h3 id=1-æ€§èƒ½è€ƒè™‘>1. æ€§èƒ½è€ƒè™‘</h3><h4 id=æ–¹æ¡ˆaæ¯ä¸ªæœåŠ¡éƒ½è§£æ-tokené‡å¤å·¥ä½œ>æ–¹æ¡ˆAï¼šæ¯ä¸ªæœåŠ¡éƒ½è§£æ Tokenï¼ˆé‡å¤å·¥ä½œï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Client 
</span></span><span class=line><span class=cl>  â†’ Gateway (è§£æ Tokenï¼Œå¾—åˆ° userId)
</span></span><span class=line><span class=cl>    â†’ Order Service (åˆè§£æä¸€æ¬¡ Token)
</span></span><span class=line><span class=cl>      â†’ Inventory Service (åˆè§£æä¸€æ¬¡ Token)
</span></span><span class=line><span class=cl>        â†’ Payment Service (åˆè§£æä¸€æ¬¡ Token)
</span></span></code></pre></td></tr></table></div></div><p>é—®é¢˜ï¼š</p><ul><li>æµªè´¹ CPU èµ„æºï¼ˆé‡å¤è§£æï¼‰</li><li>å¢åŠ å»¶è¿Ÿï¼ˆæ¯ä¸ªæœåŠ¡éƒ½è¦éªŒè¯ï¼‰</li><li>ç»´æŠ¤æˆæœ¬é«˜ï¼ˆæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å¼•å…¥ JWT åº“ï¼‰</li></ul><h4 id=æ–¹æ¡ˆbç½‘å…³è§£æé€šè¿‡-header-ä¼ é€’æ¨è>æ–¹æ¡ˆBï¼šç½‘å…³è§£æï¼Œé€šè¿‡ Header ä¼ é€’ï¼ˆæ¨èï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Client 
</span></span><span class=line><span class=cl>  â†’ Gateway (è§£æ Tokenï¼Œå¾—åˆ° userIdï¼Œæ·»åŠ åˆ° Header)
</span></span><span class=line><span class=cl>    â†’ Order Service (ä» Header è¯»å– userId)
</span></span><span class=line><span class=cl>      â†’ Inventory Service (ä» Header è¯»å– userId)
</span></span><span class=line><span class=cl>        â†’ Payment Service (ä» Header è¯»å– userId)
</span></span></code></pre></td></tr></table></div></div><p>ä¼˜åŠ¿ï¼š</p><ul><li>âœ… åªè§£æä¸€æ¬¡ Token</li><li>âœ… ä¸‹æ¸¸æœåŠ¡æ— æ„ŸçŸ¥</li><li>âœ… æ€§èƒ½æ›´å¥½</li><li>âœ… æ¶æ„æ›´æ¸…æ™°</li></ul><h3 id=2-æœ€ç®€å•çš„åŠæ³•åœ¨è¯·æ±‚å¤´ä¸­é™„åŠ ç”¨æˆ·ä¿¡æ¯>2. æœ€ç®€å•çš„åŠæ³•ï¼šåœ¨è¯·æ±‚å¤´ä¸­é™„åŠ ç”¨æˆ·ä¿¡æ¯</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userId</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userName&#34;</span><span class=p>,</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getName</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userRole&#34;</span><span class=p>,</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getRole</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸‹æ¸¸æœåŠ¡å³å¯ç›´æ¥è¯»å–ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getOrders</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;userName&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>userRole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;userRole&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯å¤„ç†ä¸šåŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>orderService</span><span class=p>.</span><span class=na>getOrdersByUserId</span><span class=p>(</span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userId</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-æ•°æ®ä¼ é€’ç¤ºä¾‹>3. æ•°æ®ä¼ é€’ç¤ºä¾‹</h3><p>å‡è®¾å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /api/orders
</span></span><span class=line><span class=cl>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ Gateway çš„å¤„ç†æµç¨‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 1. æ¥æ”¶è¯·æ±‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>originalRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Headers: { Authorization: Bearer xxx }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 2. è§£æ Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtService</span><span class=p>.</span><span class=na>parseToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;å¼ ä¸‰&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>userRole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;USER&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 3. åˆ›å»ºæ–°è¯·æ±‚ï¼ˆæ·»åŠ ç”¨æˆ·ä¿¡æ¯ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>enhancedRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>originalRequest</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userId</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userName&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userName</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userRole&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userRole</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Headers: { Authorization: Bearer xxx, userId: 10086, userName: å¼ ä¸‰, userRole: USER }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 4. ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>newExchange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>enhancedRequest</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸‹æ¸¸æœåŠ¡æ”¶åˆ°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /api/orders
</span></span><span class=line><span class=cl>Authorization: Bearer xxx
</span></span><span class=line><span class=cl>userId: 10086
</span></span><span class=line><span class=cl>userName: å¼ ä¸‰
</span></span><span class=line><span class=cl>userRole: USER
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=-å…«æ›¿ä»£æ–¹æ¡ˆä¸å®‰å…¨è€ƒè™‘>ğŸ§° å…«ã€æ›¿ä»£æ–¹æ¡ˆä¸å®‰å…¨è€ƒè™‘</h2><h3 id=1-attributes-æ–¹å¼ä»…å†…éƒ¨ä½¿ç”¨>1. attributes æ–¹å¼ï¼ˆä»…å†…éƒ¨ä½¿ç”¨ï¼‰</h3><p>åœ¨è¿‡æ»¤å™¨é“¾ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨ <code>exchange.getAttributes().put("userId", userId)</code>ï¼Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨ GlobalFilter ä¸­è®¾ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åœ¨å…¶ä»– Filter ä¸­è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Long</span><span class=p>)</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä½†è¿™åªåœ¨å½“å‰ç½‘å…³çš„å¤„ç†é“¾æœ‰æ•ˆï¼Œ<strong>æ— æ³•ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡</strong>ã€‚</p><h4 id=attributes-vs-header-å¯¹æ¯”>attributes vs Header å¯¹æ¯”</h4><div class=table-wrapper><table><thead><tr><th>ç‰¹æ€§</th><th>attributes</th><th>Header</th></tr></thead><tbody><tr><td>ä½œç”¨åŸŸ</td><td>ä»…åœ¨ Gateway å†…éƒ¨</td><td>è·¨æœåŠ¡ä¼ é€’</td></tr><tr><td>å¯è§æ€§</td><td>ä¸å¯è§ï¼ˆè¯·æ±‚å¤´ä¸­çœ‹ä¸åˆ°ï¼‰</td><td>å¯è§ï¼ˆè¯·æ±‚å¤´ä¸­èƒ½çœ‹åˆ°ï¼‰</td></tr><tr><td>ç”¨é€”</td><td>å†…éƒ¨æ•°æ®ä¼ é€’</td><td>è·¨æœåŠ¡æ•°æ®ä¼ é€’</td></tr><tr><td>å®‰å…¨æ€§</td><td>é«˜ï¼ˆä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼‰</td><td>éœ€è¦è€ƒè™‘å®‰å…¨æ€§</td></tr></tbody></table></div><h3 id=2-è¯·æ±‚å¤´æ–¹å¼è·¨æœåŠ¡ä¼ é€’>2. è¯·æ±‚å¤´æ–¹å¼ï¼ˆè·¨æœåŠ¡ä¼ é€’ï¼‰</h3><p>è¿™ç§æ–¹å¼æœ€å¸¸ç”¨ï¼Œå› ä¸ºè¯·æ±‚å¤´ä¼šè¢«è‡ªåŠ¨è½¬å‘ç»™åç«¯ã€‚</p><p>ä¸è¿‡è¦æ³¨æ„å®‰å…¨é—®é¢˜ï¼š</p><h4 id=å®‰å…¨é£é™©>å®‰å…¨é£é™©</h4><ul><li>âŒ <strong>ä¸è¦ç›´æ¥ä¼ é€’æ•æ„Ÿæ•°æ®</strong>ï¼šå¦‚å®Œæ•´ JWTã€å¯†ç ã€èº«ä»½è¯å·</li><li>âŒ <strong>ä¸è¦ä¼ é€’ä¸šåŠ¡ç§˜å¯†</strong>ï¼šå¦‚è´¦æˆ·ä½™é¢ã€ç§æœ‰ä»¤ç‰Œ</li><li>âš ï¸ <strong>å°å¿ƒä¿¡æ¯æ³„éœ²</strong>ï¼šè¯·æ±‚å¤´å¯èƒ½è¢«è®°å½•åˆ°æ—¥å¿—ä¸­</li></ul><h4 id=å®‰å…¨å»ºè®®>å®‰å…¨å»ºè®®</h4><ul><li>âœ… <strong>åªä¼ é€’å¿…è¦å­—æ®µ</strong>ï¼šå¦‚ <code>userId</code>ã€<code>role</code>ã€<code>tenantId</code></li><li>âœ… <strong>æ•°æ®è„±æ•</strong>ï¼šå¦‚æœå¿…é¡»ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼Œå…ˆåŠ å¯†æˆ–è„±æ•</li><li>âœ… <strong>ç­¾åéªŒè¯</strong>ï¼šåœ¨å…³é”®Headerä¸Šæ·»åŠ ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹</li><li>âœ… <strong>HTTPSä¼ è¾“</strong>ï¼šç¡®ä¿ä¼ è¾“è¿‡ç¨‹åŠ å¯†</li></ul><p>ç¤ºä¾‹ï¼šå¸¦ç­¾åçš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Gateway ç«¯æ·»åŠ ç­¾å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;10086&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generateSignature</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>timestamp</span><span class=p>,</span><span class=w> </span><span class=n>secretKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;timestamp&#34;</span><span class=p>,</span><span class=w> </span><span class=n>timestamp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;signature&#34;</span><span class=p>,</span><span class=w> </span><span class=n>signature</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸‹æ¸¸æœåŠ¡éªŒè¯ç­¾å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>receivedSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;signature&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>expectedSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generateSignature</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>timestamp</span><span class=p>,</span><span class=w> </span><span class=n>secretKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>receivedSignature</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>expectedSignature</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SecurityException</span><span class=p>(</span><span class=s>&#34;Invalid signature&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡ç†é«˜çº§æ–¹æ¡ˆ>3. ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰</h3><p>å¯¹äºå¤§å‹ç³»ç»Ÿï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªç»Ÿä¸€çš„ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>customAttrs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¯ä»¥åºåˆ—åŒ–ä¸ºJSONä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toJson</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åœ¨ Gateway ä¸­å°è£…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;X-User-Context&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userContext</span><span class=p>.</span><span class=na>toJson</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸‹æ¸¸æœåŠ¡è§£æ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>contextJson</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;X-User-Context&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UserContext</span><span class=w> </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UserContext</span><span class=p>.</span><span class=na>fromJson</span><span class=p>(</span><span class=n>contextJson</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=-ä¹è¯·æ±‚æµå®Œæ•´æ‰§è¡Œè¿‡ç¨‹>âš¡ ä¹ã€è¯·æ±‚æµå®Œæ•´æ‰§è¡Œè¿‡ç¨‹</h2><p>å‡è®¾å®¢æˆ·ç«¯è¯·æ±‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /api/orders?page=1&amp;size=10
</span></span><span class=line><span class=cl>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><h3 id=é˜¶æ®µ1è¯·æ±‚åˆ°è¾¾-gateway>é˜¶æ®µ1ï¼šè¯·æ±‚åˆ°è¾¾ Gateway</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. ç½‘å…³æ¥æ”¶è¯·æ±‚
</span></span><span class=line><span class=cl>   â†“
</span></span><span class=line><span class=cl>2. åˆ›å»º ServerWebExchange å¯¹è±¡
</span></span><span class=line><span class=cl>   ServerWebExchange {
</span></span><span class=line><span class=cl>       request: ServerHttpRequest {
</span></span><span class=line><span class=cl>           path: /api/orders
</span></span><span class=line><span class=cl>           method: GET
</span></span><span class=line><span class=cl>           headers: {Authorization: Bearer ..., Content-Type: ...}
</span></span><span class=line><span class=cl>           body: ...
</span></span><span class=line><span class=cl>       },
</span></span><span class=line><span class=cl>       response: ServerHttpResponse {...},
</span></span><span class=line><span class=cl>       attributes: {}
</span></span><span class=line><span class=cl>   }
</span></span></code></pre></td></tr></table></div></div><h3 id=é˜¶æ®µ2è¿›å…¥-globalfilter>é˜¶æ®µ2ï¼šè¿›å…¥ GlobalFilter</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>3</span><span class=p>.</span><span class=w> </span><span class=n>è¿›å…¥è‡ªå®šä¹‰</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AuthGlobalFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=p>...)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>// è¯»å–è¯·æ±‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>// è·å–Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>().</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>// è§£æTokenï¼ˆè¿™é‡Œç®€åŒ–ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtTool</span><span class=p>.</span><span class=na>parseToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>  </span><span class=c1>// å‡è®¾è¿”å› 10086</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>// è®°å½•å¼€å§‹æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;startTime&#34;</span><span class=p>,</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>// åˆ›å»ºæ–°è¯·æ±‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userId</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=c1>// åˆ›å»ºæ–°Exchange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>newExchange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>newRequest</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>newExchange</span><span class=p>);</span><span class=w>  </span><span class=c1>// ç»§ç»­ä¼ é€’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=é˜¶æ®µ3è·¯ç”±è½¬å‘>é˜¶æ®µ3ï¼šè·¯ç”±è½¬å‘</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>4. è·¯ç”±åŒ¹é…
</span></span><span class=line><span class=cl>   Router æ ¹æ® path /api/orders åŒ¹é…åˆ° Order Service
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>5. LoadBalancer é€‰æ‹©å®ä¾‹
</span></span><span class=line><span class=cl>   ä»å¤šä¸ª Order Service å®ä¾‹ä¸­é€‰æ‹©ä¸€ä¸ªï¼ˆå¦‚ï¼š192.168.1.10:8080ï¼‰
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>6. è½¬å‘è¯·æ±‚
</span></span><span class=line><span class=cl>   HTTP Forward: GET http://192.168.1.10:8080/api/orders
</span></span><span class=line><span class=cl>   Headers: {
</span></span><span class=line><span class=cl>       Authorization: Bearer ...
</span></span><span class=line><span class=cl>       Content-Type: application/json
</span></span><span class=line><span class=cl>       userId: 10086          â† æ–°æ·»åŠ çš„
</span></span><span class=line><span class=cl>   }
</span></span></code></pre></td></tr></table></div></div><h3 id=é˜¶æ®µ4ä¸‹æ¸¸æœåŠ¡å¤„ç†>é˜¶æ®µ4ï¼šä¸‹æ¸¸æœåŠ¡å¤„ç†</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/api&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getOrders</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w>  </span><span class=c1>// ä¼ ç»Ÿæ–¹å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@RequestHeader</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=c1>// ä»Headerè·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¯ä»¥ç›´æ¥ä½¿ç”¨ userIdï¼Œæ— éœ€å†æ¬¡è§£æToken</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>getOrdersByUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=é˜¶æ®µ5å“åº”è¿”å›>é˜¶æ®µ5ï¼šå“åº”è¿”å›</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>7. Order Service è¿”å›å“åº”
</span></span><span class=line><span class=cl>   200 OK
</span></span><span class=line><span class=cl>   Content-Type: application/json
</span></span><span class=line><span class=cl>   Body: [{&#34;id&#34;: 1, &#34;total&#34;: 99.9}, ...]
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>8. Gateway æ¥æ”¶å“åº”
</span></span><span class=line><span class=cl>   è®¡ç®—è€—æ—¶ï¼šendTime - startTime
</span></span><span class=line><span class=cl>   è®°å½•æ—¥å¿—
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>9. è¿”å›ç»™å®¢æˆ·ç«¯
</span></span><span class=line><span class=cl>   æœ€ç»ˆå“åº”åˆ°è¾¾å®¢æˆ·ç«¯
</span></span></code></pre></td></tr></table></div></div><p>æ•´ä¸ªé“¾æ¡<strong>å®Œå…¨éé˜»å¡ã€çº¿ç¨‹å®‰å…¨</strong>ã€‚</p><hr><h2 id=-åç”Ÿäº§å®è·µç»éªŒæ€»ç»“>ğŸ’¡ åã€ç”Ÿäº§å®è·µç»éªŒæ€»ç»“</h2><h3 id=1-ä¸è¦ä¿®æ”¹åŸå§‹å¯¹è±¡>1. ä¸è¦ä¿®æ”¹åŸå§‹å¯¹è±¡</h3><p><strong>âŒ é”™è¯¯åšæ³•</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å°è¯•é€šè¿‡åå°„ä¿®æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;headers&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpHeaders</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpHeaders</span><span class=p>)</span><span class=w> </span><span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>headers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;10086&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>âœ… æ­£ç¡®åšæ³•</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å§‹ç»ˆä½¿ç”¨ mutate()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;10086&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-ä½¿ç”¨-header-ä¼ é€’è½»é‡çº§ä¿¡æ¯>2. ä½¿ç”¨ Header ä¼ é€’è½»é‡çº§ä¿¡æ¯</h3><p><strong>ä¼ é€’çš„åŸåˆ™</strong>ï¼š</p><ul><li>âœ… åªä¼ å¿…è¦èº«ä»½å­—æ®µï¼ˆuserId, role, tenantï¼‰</li><li>âœ… é¿å…ä¼ é€’å¤§å¯¹è±¡ï¼ˆæ€§èƒ½è€ƒè™‘ï¼‰</li><li>âœ… é¿å…ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰</li></ul><p><strong>ç¤ºä¾‹</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ¨èï¼šè½»é‡çº§å­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;userRole&#34;</span><span class=p>,</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;tenantId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>tenantId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸æ¨èï¼šå¤§æ•°æ®æˆ–æ•æ„Ÿä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// .header(&#34;userInfo&#34;, largeJsonString)  â† å½±å“æ€§èƒ½</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// .header(&#34;privateKey&#34;, secretKey)      â† å®‰å…¨é£é™©</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-ç½‘å…³æ˜¯è¯·æ±‚å…¥å£--å®‰å…¨è¾¹ç•Œ>3. ç½‘å…³æ˜¯"è¯·æ±‚å…¥å£ + å®‰å…¨è¾¹ç•Œ"</h3><p><strong>èŒè´£åˆ†å·¥</strong>ï¼š</p><ul><li><strong>Gateway</strong>ï¼šè®¤è¯ã€é‰´æƒã€é™æµã€å®¡è®¡ã€å®‰å…¨é˜²æŠ¤</li><li><strong>Service</strong>ï¼šä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†</li></ul><p><strong>ä¸è¦åœ¨ä¸šåŠ¡æœåŠ¡ä¸­é‡å¤åšè®¤è¯</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Order Service - ä¸éœ€è¦å†æ¬¡éªŒè¯Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getOrders</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@RequestHeader</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=c1>// ç›´æ¥ä½¿ç”¨ï¼Œç½‘å…³å·²éªŒè¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>orderService</span><span class=p>.</span><span class=na>getOrders</span><span class=p>(</span><span class=n>userId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=4-å“åº”å¼é“¾ä¸­çš„å¯¹è±¡å‡ä¸ºä¸€æ¬¡æ€§ä½¿ç”¨>4. å“åº”å¼é“¾ä¸­çš„å¯¹è±¡å‡ä¸ºä¸€æ¬¡æ€§ä½¿ç”¨</h3><p><strong>ä¸è¦ç¼“å­˜æˆ–å…±äº«å¯¹è±¡</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// âŒ é”™è¯¯ï¼šç¼“å­˜ request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>cachedRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(...)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cachedRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>  </span><span class=c1>// å±é™©ï¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// âœ… æ­£ç¡®ï¼šæ¯æ¬¡è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=p>...)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>  </span><span class=c1>// æ¯æ¬¡éƒ½è·å–æ–°å¼•ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=5-æ¨èæ­é…-mdc-æˆ–-threadlocal-ä¸Šä¸‹æ–‡è·Ÿè¸ª>5. æ¨èæ­é… MDC æˆ– ThreadLocal ä¸Šä¸‹æ–‡è·Ÿè¸ª</h3><p><strong>MDCï¼ˆMapped Diagnostic Contextï¼‰ç”¨äºæ—¥å¿—è¿½è¸ª</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TracingGlobalFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>GatewayFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>exchange</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;requestId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>doFinally</span><span class=p>(</span><span class=n>signalType</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// æ—¥å¿—è®°å½•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>MDC</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;requestId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Request completed: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>MDC</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=6-æ€§èƒ½ä¼˜åŒ–æŠ€å·§>6. æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3><p><strong>é¿å…é¢‘ç¹çš„ mutate() è°ƒç”¨</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// âŒ ä¸å¥½ï¼šå¤šæ¬¡ mutate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>().</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;h1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;v1&#34;</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>mutate</span><span class=p>().</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;h2&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;v2&#34;</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>r3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>mutate</span><span class=p>().</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;h3&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;v3&#34;</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// âœ… æ›´å¥½ï¼šä¸€æ¬¡ mutate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>newRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;h1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;v1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;h2&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;v2&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;h3&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;v3&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=-åä¸€ç¤ºæ„å›¾è¯·æ±‚æµè½¬å…¨è¿‡ç¨‹>ğŸ§± åä¸€ã€ç¤ºæ„å›¾ï¼šè¯·æ±‚æµè½¬å…¨è¿‡ç¨‹</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚                    Client Application                        â”‚
</span></span><span class=line><span class=cl>â”‚                                                             â”‚
</span></span><span class=line><span class=cl>â”‚  GET /api/orders?page=1&amp;size=10                             â”‚
</span></span><span class=line><span class=cl>â”‚  Authorization: Bearer eyJ...                               â”‚
</span></span><span class=line><span class=cl>â”‚  Content-Type: application/json                             â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>                       â”‚
</span></span><span class=line><span class=cl>                       â”‚ HTTP Request
</span></span><span class=line><span class=cl>                       â†“
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚              Spring Cloud Gateway                            â”‚
</span></span><span class=line><span class=cl>â”‚                                                             â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ 1. Receive Request                                    â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    ServerWebExchange created                          â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    {request, response, attributes}                    â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â”‚                      â†“                                       â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ 2. GlobalFilter: AuthGlobalFilter                    â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Read Authorization header                        â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Parse JWT token â†’ userId: 10086                  â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Add userId to request header                     â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    request.mutate().header(&#34;userId&#34;, &#34;10086&#34;).build()â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â”‚                      â†“                                       â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ 3. RouteLocator                                       â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Match path: /api/orders                         â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Route to: Order Service                         â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - LoadBalance: 192.168.1.10:8080                  â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>                        â”‚
</span></span><span class=line><span class=cl>                        â”‚ Forward Request
</span></span><span class=line><span class=cl>                        â”‚ GET http://192.168.1.10:8080/api/orders
</span></span><span class=line><span class=cl>                        â”‚ Headers: {
</span></span><span class=line><span class=cl>                        â”‚     Authorization: Bearer eyJ...
</span></span><span class=line><span class=cl>                        â”‚     userId: 10086
</span></span><span class=line><span class=cl>                        â”‚ }
</span></span><span class=line><span class=cl>                        â†“
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚                   Order Service                             â”‚
</span></span><span class=line><span class=cl>â”‚                                                             â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ OrderController                                       â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚                                                       â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  @GetMapping(&#34;/orders&#34;)                              â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  public List&lt;Order&gt; getOrders(                        â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚      @RequestHeader(&#34;userId&#34;) Long userId) {          â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚      // ç›´æ¥ä½¿ç”¨ userIdï¼Œæ— éœ€è§£æToken               â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚      return orderService.getOrders(userId);           â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚  }                                                    â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â”‚                      â”‚                                       â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ OrderService                                          â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Query database                                   â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Return orders                                    â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>                        â”‚
</span></span><span class=line><span class=cl>                        â”‚ HTTP Response
</span></span><span class=line><span class=cl>                        â”‚ 200 OK
</span></span><span class=line><span class=cl>                        â”‚ [{&#34;id&#34;: 1, &#34;total&#34;: 99.9}, ...]
</span></span><span class=line><span class=cl>                        â†“
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚              Spring Cloud Gateway (Continue)                â”‚
</span></span><span class=line><span class=cl>â”‚                                                             â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ 4. Calculate Duration                                 â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    startTime - endTime                                â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â”‚                      â†“                                       â”‚
</span></span><span class=line><span class=cl>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚ 5. Log Request                                        â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Method, Path                                     â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Duration                                         â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â”‚    - Response status                                  â”‚  â”‚
</span></span><span class=line><span class=cl>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>                        â”‚
</span></span><span class=line><span class=cl>                        â”‚ Response
</span></span><span class=line><span class=cl>                        â†“
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚                    Client Application                        â”‚
</span></span><span class=line><span class=cl>â”‚                                                             â”‚
</span></span><span class=line><span class=cl>â”‚  200 OK                                                     â”‚
</span></span><span class=line><span class=cl>â”‚  [{&#34;id&#34;: 1, &#34;total&#34;: 99.9}, {&#34;id&#34;: 2, &#34;total&#34;: 150.5}]    â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=-åäºŒå¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ>ğŸ¯ åäºŒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id=q1å¦‚ä½•åœ¨-filter-ä¸­è·å–æˆ–ä¿®æ”¹è¯·æ±‚ä½“>Q1ï¼šå¦‚ä½•åœ¨ Filter ä¸­è·å–æˆ–ä¿®æ”¹è¯·æ±‚ä½“ï¼Ÿ</h3><p><strong>Aï¼š</strong> éœ€è¦åŒ…è£…è¯·æ±‚ä½“ï¼Œä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ModifyRequestBodyFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>GatewayFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerHttpRequestDecorator</span><span class=w> </span><span class=n>decoratedRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerHttpRequestDecorator</span><span class=p>(</span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getBody</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>getBody</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>dataBuffer</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// ä¿®æ”¹ body å†…å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>String</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decode</span><span class=p>(</span><span class=n>dataBuffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>String</span><span class=w> </span><span class=n>modified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modify</span><span class=p>(</span><span class=n>content</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>encode</span><span class=p>(</span><span class=n>modified</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>decoratedRequest</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=q2å¦‚ä½•åœ¨-filter-ä¸­è·å–å“åº”ä½“>Q2ï¼šå¦‚ä½•åœ¨ Filter ä¸­è·å–å“åº”ä½“ï¼Ÿ</h3><p><strong>Aï¼š</strong> ç±»ä¼¼åœ°ï¼Œéœ€è¦åŒ…è£…å“åº”ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LogResponseFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>GatewayFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerHttpResponseDecorator</span><span class=w> </span><span class=n>decoratedResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerHttpResponseDecorator</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>writeWith</span><span class=p>(</span><span class=n>Publisher</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>DataBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>body</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>writeWith</span><span class=p>(</span><span class=n>body</span><span class=p>.</span><span class=na>doOnNext</span><span class=p>(</span><span class=n>dataBuffer</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è®°å½•å“åº”å†…å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Response: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>decode</span><span class=p>(</span><span class=n>dataBuffer</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>response</span><span class=p>(</span><span class=n>decoratedResponse</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=q3filter-çš„æ‰§è¡Œé¡ºåºå¦‚ä½•æ§åˆ¶>Q3ï¼šFilter çš„æ‰§è¡Œé¡ºåºå¦‚ä½•æ§åˆ¶ï¼Ÿ</h3><p><strong>Aï¼š</strong> ä½¿ç”¨ <code>@Order</code> æ³¨è§£æˆ–å®ç° <code>Ordered</code> æ¥å£ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Order</span><span class=p>(</span><span class=n>Ordered</span><span class=p>.</span><span class=na>HIGHEST_PRECEDENCE</span><span class=p>)</span><span class=w>  </span><span class=c1>// æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AuthGlobalFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æˆ–è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AuthGlobalFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=p>,</span><span class=w> </span><span class=n>Ordered</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getOrder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>100</span><span class=p>;</span><span class=w>  </span><span class=c1>// ä¼˜å…ˆçº§æœ€é«˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=q4å¦‚ä½•å®ç°ç†”æ–­é™çº§>Q4ï¼šå¦‚ä½•å®ç°ç†”æ–­é™çº§ï¼Ÿ</h3><p><strong>Aï¼š</strong> ä½¿ç”¨ Resilience4j æˆ–è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FallbackGlobalFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>GatewayFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>onErrorResume</span><span class=p>(</span><span class=n>ex</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ç†”æ–­é™çº§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ServerHttpResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>response</span><span class=p>.</span><span class=na>setStatusCode</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>SERVICE_UNAVAILABLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>errorMsg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Service temporarily unavailable, please try again later&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>DataBuffer</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>bufferFactory</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>errorMsg</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>writeWith</span><span class=p>(</span><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=-åä¸‰ç»“è¯­>ğŸ åä¸‰ã€ç»“è¯­</h2><p>Spring Cloud Gateway çš„è®¾è®¡éå¸¸"ä¼˜é›…"â€”â€”
å®ƒä»¥ <strong>å“åº”å¼æµå¼æ¨¡å‹</strong> ä¸ºæ ¸å¿ƒï¼Œå½»åº•æ‘’å¼ƒä¼ ç»Ÿ Servlet æ¨¡å¼ä¸‹çš„å¯å˜å¯¹è±¡ï¼Œ
è®©æ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹æ›´åŠ å®‰å…¨ã€é«˜æ•ˆã€å¯é¢„æµ‹ã€‚</p><p>ç†è§£ <code>ServerWebExchange</code>ã€<code>ServerHttpRequest</code>ã€<code>mutate()</code> çš„å·¥ä½œåŸç†ï¼Œ
æ­£æ˜¯æŒæ¡è¿™ä¸€å¥—æœºåˆ¶çš„å…³é”®ã€‚</p><blockquote><p><strong>&ldquo;Immutable å¯¹è±¡ + Reactive æ•°æ®æµ = é«˜å¹¶å‘å¾®æœåŠ¡çš„åŸºç¡€&rdquo;</strong></p></blockquote><h3 id=æ ¸å¿ƒè¦ç‚¹å›é¡¾>æ ¸å¿ƒè¦ç‚¹å›é¡¾</h3><ol><li>âœ… <code>ServerWebExchange</code> æ˜¯è¯·æ±‚çš„ä¸Šä¸‹æ–‡å®¹å™¨</li><li>âœ… <code>ServerHttpRequest</code> å’Œ <code>ServerHttpResponse</code> éƒ½æ˜¯ä¸å¯å˜çš„</li><li>âœ… ä½¿ç”¨ <code>mutate()</code> åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œéä¿®æ”¹åŸå¯¹è±¡</li><li>âœ… é€šè¿‡ Header ä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™ä¸‹æ¸¸æœåŠ¡</li><li>âœ… å“åº”å¼ç¼–ç¨‹è®©ç³»ç»Ÿæ›´åŠ é«˜å¹¶å‘ã€å¯æ‰©å±•</li></ol><h3 id=ä¸‹ä¸€æ­¥å­¦ä¹ >ä¸‹ä¸€æ­¥å­¦ä¹ </h3><p>æŒæ¡äº†åŸºç¡€åŸç†åï¼Œå¯ä»¥è¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ ï¼š</p><ul><li><strong>Reactor å“åº”å¼ç¼–ç¨‹</strong>ï¼šMonoã€Flux çš„é«˜çº§æ“ä½œ</li><li><strong>WebFlux çš„å¼‚æ­¥å¤„ç†</strong>ï¼šå¦‚ä½•é¿å…é˜»å¡æ“ä½œ</li><li><strong>ç½‘å…³æ€§èƒ½ä¼˜åŒ–</strong>ï¼šé™æµã€ç†”æ–­ã€ç¼“å­˜ç­–ç•¥</li><li><strong>åˆ†å¸ƒå¼è¿½è¸ª</strong>ï¼šSleuthã€Zipkin é›†æˆ</li></ul><hr><h2 id=-å»¶ä¼¸é˜…è¯»>ğŸ“š å»¶ä¼¸é˜…è¯»</h2><h3 id=å®˜æ–¹æ–‡æ¡£>å®˜æ–¹æ–‡æ¡£</h3><ul><li><a class=link href=https://spring.io/projects/spring-cloud-gateway target=_blank rel=noopener>Spring Cloud Gateway å®˜æ–¹æ–‡æ¡£</a></li><li><a class=link href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html target=_blank rel=noopener>Spring WebFlux å®˜æ–¹æ–‡æ¡£</a></li></ul><h3 id=æŠ€æœ¯è§„èŒƒ>æŠ€æœ¯è§„èŒƒ</h3><ul><li><a class=link href=https://www.reactive-streams.org/ target=_blank rel=noopener>Reactive Streams è§„èŒƒ</a></li><li><a class=link href=https://datatracker.ietf.org/doc/html/rfc7519 target=_blank rel=noopener>JWT è§„èŒƒ (RFC 7519)</a></li></ul><h3 id=æ¨èä¹¦ç±>æ¨èä¹¦ç±</h3><ul><li>ã€ŠSpring WebFlux In Depthã€‹</li><li>ã€Šå“åº”å¼æ¶æ„è®¾è®¡æ€æƒ³ä¸å®æˆ˜ã€‹</li><li>ã€ŠSpring Cloud å¾®æœåŠ¡å®æˆ˜ã€‹</li></ul><h3 id=ç›¸å…³æ–‡ç« >ç›¸å…³æ–‡ç« </h3><ul><li>ã€ŠReactor å“åº”å¼ç¼–ç¨‹å®Œå…¨æŒ‡å—ã€‹</li><li>ã€ŠJWT Token åœ¨å¾®æœåŠ¡ä¸­çš„æœ€ä½³å®è·µã€‹</li><li>ã€Šç½‘å…³é™æµç†”æ–­å®æˆ˜æ€»ç»“ã€‹</li></ul><hr><p><em>æœ€åæ›´æ–°ï¼š2025-01-20</em>
<em>ä½œè€…ï¼šCecilia</em>
<em>è®¸å¯ï¼šæœ¬æ–‡é‡‡ç”¨ <a class=link href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel=noopener>CC BY-SA 4.0</a> è®¸å¯åè®®</em></p></section><footer class=article-footer><section class=article-tags><a href=/tags/spring-cloud-gateway/>Spring Cloud Gateway</a>
<a href=/tags/webflux/>WebFlux</a>
<a href=/tags/jwt/>JWT</a>
<a href=/tags/filter/>Filter</a>
<a href=/tags/reactive-programming/>Reactive Programming</a>
<a href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/>å¾®æœåŠ¡ç½‘å…³</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 Cecilia-å¡è¥¿è‰å¨…</section><section class=powerby>Never give up<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>