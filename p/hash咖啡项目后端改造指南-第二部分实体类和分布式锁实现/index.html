<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="åŸºäºLuaè„šæœ¬ä¸Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ä¼˜æƒ åˆ¸è¶…å–ä¸é‡å¤è·å–ï¼Œé€šè¿‡MySQLæ•°æ®åº“çš„åŸå­æ€§æ“ä½œä¿è¯åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨"><title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°</title><link rel=canonical href=https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°"><meta property='og:description' content="åŸºäºLuaè„šæœ¬ä¸Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ä¼˜æƒ åˆ¸è¶…å–ä¸é‡å¤è·å–ï¼Œé€šè¿‡MySQLæ•°æ®åº“çš„åŸå­æ€§æ“ä½œä¿è¯åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨"><meta property='og:url' content='https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/'><meta property='og:site_name' content='Cecilia-å¡è¥¿è‰å¨…'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Java'><meta property='article:tag' content='Spring Boot'><meta property='article:tag' content='Redis'><meta property='article:tag' content='åˆ†å¸ƒå¼é”'><meta property='article:tag' content='Luaè„šæœ¬'><meta property='article:tag' content='ç§’æ€ç³»ç»Ÿ'><meta property='article:tag' content='é˜²è¶…å–'><meta property='article:published_time' content='2025-01-14T00:00:00+00:00'><meta property='article:modified_time' content='2025-01-14T00:00:00+00:00'><meta name=twitter:title content="Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°"><meta name=twitter:description content="åŸºäºLuaè„šæœ¬ä¸Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ä¼˜æƒ åˆ¸è¶…å–ä¸é‡å¤è·å–ï¼Œé€šè¿‡MySQLæ•°æ®åº“çš„åŸå­æ€§æ“ä½œä¿è¯åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_8636e4c1b17bd1a4.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ§‘â€ğŸ’»</span></figure><div class=site-meta><h1 class=site-name><a href=/>Cecilia-å¡è¥¿è‰å¨…</a></h1><h2 class=site-description>Welcome to my website</h2></div></header><ol class=menu-social><li><a href=https://github.com/Yin123-ybh target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://Yin123-ybh.github.io/ selected>English</option><option value=https://Yin123-ybh.github.io/zh-cn/>ç®€ä½“ä¸­æ–‡</option><option value=https://Yin123-ybh.github.io/ar/>Ø¹Ø±Ø¨ÙŠ</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ç›®å½•>ç›®å½•</a></li><li><a href=#æ¦‚è¿°>æ¦‚è¿°</a></li><li><a href=#1-å®ä½“ç±»æ‰©å±•>1. å®ä½“ç±»æ‰©å±•</a><ol><li><a href=#11-ç”¨æˆ·å®ä½“ç±»æ‰©å±•>1.1 ç”¨æˆ·å®ä½“ç±»æ‰©å±•</a></li><li><a href=#12-æ¶ˆæ¯å®ä½“ç±»è®¾è®¡>1.2 æ¶ˆæ¯å®ä½“ç±»è®¾è®¡</a><ol><li><a href=#121-è®¢å•æ”¯ä»˜æ¶ˆæ¯>1.2.1 è®¢å•æ”¯ä»˜æ¶ˆæ¯</a></li><li><a href=#122-ç§¯åˆ†è·å¾—æ¶ˆæ¯>1.2.2 ç§¯åˆ†è·å¾—æ¶ˆæ¯</a></li><li><a href=#123-è®¢å•è¶…æ—¶æ¶ˆæ¯>1.2.3 è®¢å•è¶…æ—¶æ¶ˆæ¯</a></li></ol></li></ol></li><li><a href=#2-åˆ†å¸ƒå¼é”æœåŠ¡å®ç°>2. åˆ†å¸ƒå¼é”æœåŠ¡å®ç°</a><ol><li><a href=#21-åˆ†å¸ƒå¼é”æœåŠ¡ç±»>2.1 åˆ†å¸ƒå¼é”æœåŠ¡ç±»</a></li><li><a href=#22-redisé”®å¸¸é‡ç±»>2.2 Redisé”®å¸¸é‡ç±»</a></li></ol></li><li><a href=#3-serviceå±‚æ‰©å±•>3. Serviceå±‚æ‰©å±•</a><ol><li><a href=#31-userserviceæ‰©å±•>3.1 UserServiceæ‰©å±•</a></li><li><a href=#32-orderserviceæ‰©å±•>3.2 OrderServiceæ‰©å±•</a></li><li><a href=#33-couponserviceæ‰©å±•>3.3 CouponServiceæ‰©å±•</a></li></ol></li><li><a href=#4-mapperå±‚æ‰©å±•>4. Mapperå±‚æ‰©å±•</a><ol><li><a href=#41-usermapperæ‰©å±•>4.1 UserMapperæ‰©å±•</a></li><li><a href=#42-couponmapperæ‰©å±•>4.2 CouponMapperæ‰©å±•</a></li><li><a href=#43-coupontemplatemapperæ‰©å±•>4.3 CouponTemplateMapperæ‰©å±•</a></li></ol></li><li><a href=#5-é…ç½®ç±»>5. é…ç½®ç±»</a><ol><li><a href=#51-redissoné…ç½®>5.1 Redissoné…ç½®</a></li></ol></li><li><a href=#6-å…³é”®ç‰¹æ€§>6. å…³é”®ç‰¹æ€§</a><ol><li><a href=#61-åˆ†å¸ƒå¼é”é˜²è¶…å–>6.1 åˆ†å¸ƒå¼é”é˜²è¶…å–</a></li><li><a href=#62-çº¿ç¨‹å®‰å…¨>6.2 çº¿ç¨‹å®‰å…¨</a></li><li><a href=#63-æ€§èƒ½ä¼˜åŒ–>6.3 æ€§èƒ½ä¼˜åŒ–</a></li></ol></li><li><a href=#7-æ³¨æ„äº‹é¡¹>7. æ³¨æ„äº‹é¡¹</a></li><li><a href=#8-æµ‹è¯•å»ºè®®>8. æµ‹è¯•å»ºè®®</a></li><li><a href=#9-ä¸šåŠ¡æµç¨‹è¯¦è§£>9. ä¸šåŠ¡æµç¨‹è¯¦è§£</a><ol><li><a href=#91-ç§’æ€ä¸šåŠ¡æµç¨‹>9.1 ç§’æ€ä¸šåŠ¡æµç¨‹</a><ol><li><a href=#911-ç”¨æˆ·å‚ä¸ç§’æ€æµç¨‹>9.1.1 ç”¨æˆ·å‚ä¸ç§’æ€æµç¨‹</a></li><li><a href=#912-é˜²è¶…å–æœºåˆ¶>9.1.2 é˜²è¶…å–æœºåˆ¶</a></li></ol></li><li><a href=#92-ä¼˜æƒ åˆ¸ä¸šåŠ¡æµç¨‹>9.2 ä¼˜æƒ åˆ¸ä¸šåŠ¡æµç¨‹</a><ol><li><a href=#921-ä¼˜æƒ åˆ¸é¢†å–æµç¨‹>9.2.1 ä¼˜æƒ åˆ¸é¢†å–æµç¨‹</a></li><li><a href=#922-ä¼˜æƒ åˆ¸ä½¿ç”¨æµç¨‹>9.2.2 ä¼˜æƒ åˆ¸ä½¿ç”¨æµç¨‹</a></li></ol></li><li><a href=#93-ç§¯åˆ†ä¸šåŠ¡æµç¨‹>9.3 ç§¯åˆ†ä¸šåŠ¡æµç¨‹</a><ol><li><a href=#931-ç§¯åˆ†è·å¾—æµç¨‹>9.3.1 ç§¯åˆ†è·å¾—æµç¨‹</a></li><li><a href=#932-ç§¯åˆ†ä½¿ç”¨æµç¨‹>9.3.2 ç§¯åˆ†ä½¿ç”¨æµç¨‹</a></li></ol></li></ol></li><li><a href=#10-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥>10. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</a><ol><li><a href=#101-ç¼“å­˜ç­–ç•¥>10.1 ç¼“å­˜ç­–ç•¥</a><ol><li><a href=#1011-redisç¼“å­˜è®¾è®¡>10.1.1 Redisç¼“å­˜è®¾è®¡</a></li><li><a href=#1012-ç¼“å­˜ä¸€è‡´æ€§>10.1.2 ç¼“å­˜ä¸€è‡´æ€§</a></li></ol></li><li><a href=#102-æ•°æ®åº“ä¼˜åŒ–>10.2 æ•°æ®åº“ä¼˜åŒ–</a><ol><li><a href=#1021-ç´¢å¼•ä¼˜åŒ–>10.2.1 ç´¢å¼•ä¼˜åŒ–</a></li><li><a href=#1022-åˆ†åº“åˆ†è¡¨ç­–ç•¥>10.2.2 åˆ†åº“åˆ†è¡¨ç­–ç•¥</a></li></ol></li><li><a href=#103-å¹¶å‘æ§åˆ¶>10.3 å¹¶å‘æ§åˆ¶</a><ol><li><a href=#1031-åˆ†å¸ƒå¼é”ä¼˜åŒ–>10.3.1 åˆ†å¸ƒå¼é”ä¼˜åŒ–</a></li><li><a href=#1032-é™æµç­–ç•¥>10.3.2 é™æµç­–ç•¥</a></li></ol></li></ol></li><li><a href=#11-ç›‘æ§å’Œå‘Šè­¦>11. ç›‘æ§å’Œå‘Šè­¦</a><ol><li><a href=#111-ç³»ç»Ÿç›‘æ§>11.1 ç³»ç»Ÿç›‘æ§</a><ol><li><a href=#1111-æ€§èƒ½ç›‘æ§>11.1.1 æ€§èƒ½ç›‘æ§</a></li><li><a href=#1112-ä¸šåŠ¡ç›‘æ§>11.1.2 ä¸šåŠ¡ç›‘æ§</a></li></ol></li><li><a href=#112-å‘Šè­¦æœºåˆ¶>11.2 å‘Šè­¦æœºåˆ¶</a><ol><li><a href=#1121-å‘Šè­¦è§„åˆ™>11.2.1 å‘Šè­¦è§„åˆ™</a></li><li><a href=#1122-å‘Šè­¦å¤„ç†>11.2.2 å‘Šè­¦å¤„ç†</a></li></ol></li></ol></li><li><a href=#12-æµ‹è¯•ç­–ç•¥>12. æµ‹è¯•ç­–ç•¥</a><ol><li><a href=#121-å•å…ƒæµ‹è¯•>12.1 å•å…ƒæµ‹è¯•</a><ol><li><a href=#1211-æœåŠ¡å±‚æµ‹è¯•>12.1.1 æœåŠ¡å±‚æµ‹è¯•</a></li><li><a href=#1212-é›†æˆæµ‹è¯•>12.1.2 é›†æˆæµ‹è¯•</a></li></ol></li><li><a href=#122-æ€§èƒ½æµ‹è¯•>12.2 æ€§èƒ½æµ‹è¯•</a><ol><li><a href=#1221-å‹åŠ›æµ‹è¯•>12.2.1 å‹åŠ›æµ‹è¯•</a></li><li><a href=#1222-ç¨³å®šæ€§æµ‹è¯•>12.2.2 ç¨³å®šæ€§æµ‹è¯•</a></li></ol></li></ol></li><li><a href=#13-éƒ¨ç½²å’Œè¿ç»´>13. éƒ¨ç½²å’Œè¿ç»´</a><ol><li><a href=#131-éƒ¨ç½²ç­–ç•¥>13.1 éƒ¨ç½²ç­–ç•¥</a><ol><li><a href=#1311-å®¹å™¨åŒ–éƒ¨ç½²>13.1.1 å®¹å™¨åŒ–éƒ¨ç½²</a></li><li><a href=#1312-å¾®æœåŠ¡éƒ¨ç½²>13.1.2 å¾®æœåŠ¡éƒ¨ç½²</a></li></ol></li><li><a href=#132-è¿ç»´ç›‘æ§>13.2 è¿ç»´ç›‘æ§</a><ol><li><a href=#1321-æ—¥å¿—ç®¡ç†>13.2.1 æ—¥å¿—ç®¡ç†</a></li><li><a href=#1322-ç›‘æ§å‘Šè­¦>13.2.2 ç›‘æ§å‘Šè­¦</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/>åç«¯å¼€å‘</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°</a></h2><h3 class=article-subtitle>åŸºäºLuaè„šæœ¬ä¸Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ä¼˜æƒ åˆ¸è¶…å–ä¸é‡å¤è·å–ï¼Œé€šè¿‡MySQLæ•°æ®åº“çš„åŸå­æ€§æ“ä½œä¿è¯åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-01-14</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><h1 id=hashå’–å•¡åç«¯æ”¹é€ æŒ‡å—-ç¬¬äºŒéƒ¨åˆ†-å®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°>Hashå’–å•¡åç«¯æ”¹é€ æŒ‡å—-ç¬¬äºŒéƒ¨åˆ†-å®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°</h1><h2 id=ç›®å½•>ç›®å½•</h2><ol><li><a class=link href=#1-%e9%a1%b9%e7%9b%ae%e6%a6%82%e8%bf%b0>é¡¹ç›®æ¦‚è¿°</a></li><li><a class=link href=#2-%e5%ae%9e%e4%bd%93%e7%b1%bb%e8%ae%be%e8%ae%a1>å®ä½“ç±»è®¾è®¡</a></li><li><a class=link href=#3-%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81%e5%ae%9e%e7%8e%b0>åˆ†å¸ƒå¼é”å®ç°</a></li><li><a class=link href=#4-lua%e8%84%9a%e6%9c%ac%e4%bc%98%e5%8c%96>Luaè„šæœ¬ä¼˜åŒ–</a></li><li><a class=link href=#5-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%93%8d%e4%bd%9c%e4%bc%98%e5%8c%96>æ•°æ®åº“æ“ä½œä¼˜åŒ–</a></li><li><a class=link href=#6-%e7%bc%93%e5%ad%98%e7%ad%96%e7%95%a5>ç¼“å­˜ç­–ç•¥</a></li><li><a class=link href=#7-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86>å¼‚å¸¸å¤„ç†</a></li><li><a class=link href=#8-%e6%80%a7%e8%83%bd%e7%9b%91%e6%8e%a7>æ€§èƒ½ç›‘æ§</a></li><li><a class=link href=#9-%e4%b8%9a%e5%8a%a1%e6%b5%81%e7%a8%8b%e8%af%a6%e8%a7%a3>ä¸šåŠ¡æµç¨‹è¯¦è§£</a></li><li><a class=link href=#10-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a5>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</a></li><li><a class=link href=#11-%e7%9b%91%e6%8e%a7%e5%92%8c%e5%91%8a%e8%ad%a6>ç›‘æ§å’Œå‘Šè­¦</a></li><li><a class=link href=#12-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5>æµ‹è¯•ç­–ç•¥</a></li><li><a class=link href=#13-%e9%83%a8%e7%bd%b2%e5%92%8c%e8%bf%90%e7%bb%b4>éƒ¨ç½²å’Œè¿ç»´</a></li></ol><h2 id=æ¦‚è¿°>æ¦‚è¿°</h2><p>æœ¬éƒ¨åˆ†ä¸»è¦ä»‹ç»Hashå’–å•¡é¡¹ç›®ä¸­ç§’æ€å’Œä¼˜æƒ åˆ¸åŠŸèƒ½çš„å®ä½“ç±»è®¾è®¡ã€åˆ†å¸ƒå¼é”å®ç°ï¼Œä»¥åŠç›¸å…³çš„Serviceå±‚æ‰©å±•ã€‚é€šè¿‡Luaè„šæœ¬ä¸Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ä¼˜æƒ åˆ¸è¶…å–ä¸é‡å¤è·å–ï¼ŒåŒæ—¶é€šè¿‡MySQLæ•°æ®åº“çš„åŸå­æ€§æ“ä½œä¿è¯åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨ã€‚</p><h2 id=1-å®ä½“ç±»æ‰©å±•>1. å®ä½“ç±»æ‰©å±•</h2><h3 id=11-ç”¨æˆ·å®ä½“ç±»æ‰©å±•>1.1 ç”¨æˆ·å®ä½“ç±»æ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-pojo/src/main/java/com/sky/entity/User.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AllArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Builder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>openid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å§“å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ‰‹æœºå·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>phone</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ€§åˆ« 0 å¥³ 1 ç”·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//èº«ä»½è¯å·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>idNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å¤´åƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>avatar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//ç§¯åˆ†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>points</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ³¨å†Œæ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>createTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¸»è¦å˜æ›´è¯´æ˜</strong>:</p><ul><li>æ·»åŠ äº† <code>points</code> å­—æ®µç”¨äºå­˜å‚¨ç”¨æˆ·ç§¯åˆ†</li><li>ç§¯åˆ†ç³»ç»Ÿæ˜¯ç”¨æˆ·å¿ è¯šåº¦ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†</li><li>ç§¯åˆ†å¯ä»¥ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸ã€æŠµæ‰£ç°é‡‘ç­‰</li></ul><p><strong>ä¸šåŠ¡ä»·å€¼</strong>:</p><ol><li><strong>ç”¨æˆ·ç•™å­˜</strong>: é€šè¿‡ç§¯åˆ†ç³»ç»Ÿæé«˜ç”¨æˆ·ç²˜æ€§</li><li><strong>æ¶ˆè´¹æ¿€åŠ±</strong>: ç§¯åˆ†å¥–åŠ±æœºåˆ¶ä¿ƒè¿›ç”¨æˆ·æ¶ˆè´¹</li><li><strong>æ•°æ®åˆ†æ</strong>: ç§¯åˆ†æ•°æ®å¯ç”¨äºç”¨æˆ·è¡Œä¸ºåˆ†æ</li></ol><h3 id=12-æ¶ˆæ¯å®ä½“ç±»è®¾è®¡>1.2 æ¶ˆæ¯å®ä½“ç±»è®¾è®¡</h3><h4 id=121-è®¢å•æ”¯ä»˜æ¶ˆæ¯>1.2.1 è®¢å•æ”¯ä»˜æ¶ˆæ¯</h4><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-pojo/src/main/java/com/sky/entity/message/OrderPayMessage.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.entity.message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AllArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Builder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.math.BigDecimal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è®¢å•æ”¯ä»˜æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm> * ç”¨äºå¼‚æ­¥å¤„ç†è®¢å•æ”¯ä»˜åçš„ä¸šåŠ¡é€»è¾‘
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderPayMessage</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ”¯ä»˜é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ”¯ä»˜æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>payTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ”¯ä»˜æ–¹å¼
</span></span></span><span class=line><span class=cl><span class=cm>     * 1-å¾®ä¿¡æ”¯ä»˜ 2-æ”¯ä»˜å® 3-é“¶è¡Œå¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>payMethod</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>è®¾è®¡ç†å¿µ</strong>:</p><ul><li>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡</li><li>æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦å’Œç¨³å®šæ€§</li><li>æ”¯æŒå¼‚æ­¥å¤„ç†ï¼Œé¿å…åŒæ­¥é˜»å¡</li></ul><h4 id=122-ç§¯åˆ†è·å¾—æ¶ˆæ¯>1.2.2 ç§¯åˆ†è·å¾—æ¶ˆæ¯</h4><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-pojo/src/main/java/com/sky/entity/message/PointsEarnMessage.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.entity.message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AllArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Builder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ç§¯åˆ†è·å¾—æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm> * ç”¨äºå¤„ç†ç”¨æˆ·ç§¯åˆ†å¢åŠ çš„ä¸šåŠ¡é€»è¾‘
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PointsEarnMessage</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å¾—ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>points</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å¾—æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>earnTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¸šåŠ¡è§„åˆ™</strong>:</p><ul><li>æ¯æ¶ˆè´¹1å…ƒè·å¾—1ç§¯åˆ†</li><li>ç§¯åˆ†æœ‰æ•ˆæœŸä¸º1å¹´</li><li>ç§¯åˆ†å¯ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸</li></ul><h4 id=123-è®¢å•è¶…æ—¶æ¶ˆæ¯>1.2.3 è®¢å•è¶…æ—¶æ¶ˆæ¯</h4><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-pojo/src/main/java/com/sky/entity/message/OrderTimeoutMessage.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.entity.message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AllArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Builder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è®¢å•è¶…æ—¶æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm> * ç”¨äºå¤„ç†è®¢å•è¶…æ—¶æœªæ”¯ä»˜çš„ä¸šåŠ¡é€»è¾‘
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderTimeoutMessage</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¶…æ—¶æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>timeoutTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>è¶…æ—¶å¤„ç†æœºåˆ¶</strong>:</p><ul><li>è®¢å•åˆ›å»ºå15åˆ†é’Ÿå†…æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ</li><li>é‡Šæ”¾åº“å­˜ï¼Œæ¢å¤å•†å“å¯å”®çŠ¶æ€</li><li>å‘é€è¶…æ—¶é€šçŸ¥ç»™ç”¨æˆ·</li></ul><h2 id=2-åˆ†å¸ƒå¼é”æœåŠ¡å®ç°>2. åˆ†å¸ƒå¼é”æœåŠ¡å®ç°</h2><h3 id=21-åˆ†å¸ƒå¼é”æœåŠ¡ç±»>2.1 åˆ†å¸ƒå¼é”æœåŠ¡ç±»</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/lock/DistributedLockService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.lock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.constant.RedisKeyConstants</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.redisson.api.RLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.redisson.api.RedissonClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.core.io.ClassPathResource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.data.redis.core.RedisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.data.redis.core.script.DefaultRedisScript</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.scripting.support.ResourceScriptSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Service</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Arrays</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ConcurrentHashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.function.Supplier</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * åˆ†å¸ƒå¼é”æœåŠ¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
</span></span></span><span class=line><span class=cl><span class=cm> * åŸºäºRedissonå®ç°åˆ†å¸ƒå¼é”ï¼Œæ”¯æŒç§’æ€åœºæ™¯ä¸‹çš„é«˜å¹¶å‘æ§åˆ¶
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DistributedLockService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedissonClient</span><span class=w> </span><span class=n>redissonClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${sky.redis.seckill.prefix}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>seckillPrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é”ç¼“å­˜ï¼Œé¿å…é‡å¤è·å–é”å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>RLock</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç§’æ€å‚ä¸è„šæœ¬</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&gt;</span><span class=w> </span><span class=n>seckillParticipateScript</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DistributedLockService</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åˆå§‹åŒ–ç§’æ€å‚ä¸è„šæœ¬</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>seckillParticipateScript</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>seckillParticipateScript</span><span class=p>.</span><span class=na>setScriptSource</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>ResourceScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ClassPathResource</span><span class=p>(</span><span class=s>&#34;scripts/seckill_participate.lua&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>seckillParticipateScript</span><span class=p>.</span><span class=na>setResultType</span><span class=p>(</span><span class=n>List</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–é”å¯¹è±¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     * ä½¿ç”¨ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åˆ›å»ºé”å¯¹è±¡ï¼Œæé«˜æ€§èƒ½
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RLock</span><span class=w> </span><span class=nf>getLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>lockCache</span><span class=p>.</span><span class=na>computeIfAbsent</span><span class=p>(</span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>redissonClient</span><span class=p>.</span><span class=na>getLock</span><span class=p>(</span><span class=n>key</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç§’æ€å‚ä¸
</span></span></span><span class=line><span class=cl><span class=cm>     * ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œï¼Œé˜²æ­¢è¶…å–
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>seckillParticipate</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>perUserLimit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä½¿ç”¨å·¥å…·æ–¹æ³•ç”Ÿæˆé”®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>stockKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillPrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>RedisKeyConstants</span><span class=p>.</span><span class=na>getStockKey</span><span class=p>(</span><span class=n>activityId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>participantsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillPrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>RedisKeyConstants</span><span class=p>.</span><span class=na>getParticipantsKey</span><span class=p>(</span><span class=n>activityId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>stockKey</span><span class=p>,</span><span class=w> </span><span class=n>participantsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>userId</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>quantity</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>perUserLimit</span><span class=p>.</span><span class=na>toString</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>seckillParticipateScript</span><span class=p>,</span><span class=w> </span><span class=n>keys</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å°è¯•è·å–é”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     * æ”¯æŒè¶…æ—¶æœºåˆ¶ï¼Œé¿å…æ­»é”
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>leaseTime</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>(</span><span class=n>waitTime</span><span class=p>,</span><span class=w> </span><span class=n>leaseTime</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;è·å–é”è¢«ä¸­æ–­&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é‡Šæ”¾é”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     * ç¡®ä¿é”çš„æ­£ç¡®é‡Šæ”¾ï¼Œé¿å…èµ„æºæ³„éœ²
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>isHeldByCurrentThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;é‡Šæ”¾é”å¤±è´¥: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ‰§è¡Œå¸¦é”çš„æ“ä½œï¼ˆæ¨èä½¿ç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     * è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„åŸå­æ€§
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>executeWithLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>leaseTime</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                 </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w> </span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>supplier</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>(</span><span class=n>waitTime</span><span class=p>,</span><span class=w> </span><span class=n>leaseTime</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>supplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;è·å–é”å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;è·å–é”è¢«ä¸­æ–­: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>isHeldByCurrentThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ£€æŸ¥é”çŠ¶æ€
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨äºç›‘æ§å’Œè°ƒè¯•
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isLocked</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>isLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–é”å‰©ä½™æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨äºç›‘æ§é”çš„ä½¿ç”¨æƒ…å†µ
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>getLockRemainingTime</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>remainTimeToLive</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>è®¾è®¡ç‰¹ç‚¹</strong>:</p><ol><li><strong>é”ç¼“å­˜æœºåˆ¶</strong>: é¿å…é‡å¤åˆ›å»ºé”å¯¹è±¡ï¼Œæé«˜æ€§èƒ½</li><li><strong>Luaè„šæœ¬</strong>: ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œé˜²æ­¢è¶…å–</li><li><strong>è¶…æ—¶æœºåˆ¶</strong>: é¿å…æ­»é”ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§</li><li><strong>å¼‚å¸¸å¤„ç†</strong>: ç¡®ä¿é”çš„æ­£ç¡®é‡Šæ”¾</li></ol><h3 id=22-redisé”®å¸¸é‡ç±»>2.2 Redisé”®å¸¸é‡ç±»</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-common/src/main/java/com/sky/constant/RedisKeyConstants.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.constant</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Redisé”®å¸¸é‡ç±»
</span></span></span><span class=line><span class=cl><span class=cm> * ç»Ÿä¸€ç®¡ç†Redisé”®çš„å‘½åè§„èŒƒï¼Œé¿å…é”®å†²çª
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisKeyConstants</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç§’æ€ç›¸å…³å‰ç¼€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>SECKILL_PREFIX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;seckill:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç§’æ€å­é”®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>STOCK_KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;stock:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>PARTICIPANTS_KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;participants:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>LOCK_KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;lock:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>ORDER_KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;order:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”Ÿæˆåº“å­˜é”®
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¼å¼: seckill:stock:æ´»åŠ¨ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getStockKey</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>SECKILL_PREFIX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>STOCK_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”Ÿæˆå‚ä¸è€…é”®
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¼å¼: seckill:participants:æ´»åŠ¨ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getParticipantsKey</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>SECKILL_PREFIX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>PARTICIPANTS_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”Ÿæˆé”é”®
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¼å¼: seckill:lock:ä¸šåŠ¡é”®
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getLockKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>businessKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>SECKILL_PREFIX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LOCK_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>businessKey</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”Ÿæˆè®¢å•é”®
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¼å¼: seckill:order:è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getOrderKey</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>SECKILL_PREFIX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ORDER_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å‘½åè§„èŒƒ</strong>:</p><ul><li>ä½¿ç”¨å†’å·åˆ†éš”å±‚çº§ç»“æ„</li><li>å‰ç¼€ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…é”®å†²çª</li><li>æ”¯æŒæŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç±»ç®¡ç†</li></ul><h2 id=3-serviceå±‚æ‰©å±•>3. Serviceå±‚æ‰©å±•</h2><h3 id=31-userserviceæ‰©å±•>3.1 UserServiceæ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/service/UserService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.service</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.UserLoginDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.entity.User</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å¾®ä¿¡ç™»å½•
</span></span></span><span class=line><span class=cl><span class=cm>     * @param userLoginDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=nf>wxLogin</span><span class=p>(</span><span class=n>UserLoginDTO</span><span class=w> </span><span class=n>userLoginDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ·»åŠ ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm>     * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     * @param points ç§¯åˆ†æ•°é‡
</span></span></span><span class=line><span class=cl><span class=cm>     * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>addUserPoints</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>points</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm>     * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     * @return ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=nf>getUserPoints</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/service/impl/UserServiceImpl.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨UserServiceImplä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ·»åŠ ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param points ç§¯åˆ†æ•°é‡
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addUserPoints</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>points</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æŸ¥è¯¢ç”¨æˆ·å½“å‰ç§¯åˆ†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>user</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ›´æ–°ç”¨æˆ·ç§¯åˆ†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userMapper</span><span class=p>.</span><span class=na>updateUserPoints</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getPoints</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>points</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ç”¨æˆ·ç§¯åˆ†å¢åŠ æˆåŠŸï¼šuserId={}, points={}, orderId={}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>points</span><span class=p>,</span><span class=w> </span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è·å–ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @return ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getUserPoints</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getPoints</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¸šåŠ¡é€»è¾‘</strong>:</p><ol><li><strong>ç§¯åˆ†å¢åŠ </strong>: ç”¨æˆ·æ¶ˆè´¹åè‡ªåŠ¨å¢åŠ ç§¯åˆ†</li><li><strong>ç§¯åˆ†æŸ¥è¯¢</strong>: æ”¯æŒç”¨æˆ·æŸ¥çœ‹å½“å‰ç§¯åˆ†</li><li><strong>ç§¯åˆ†ä½¿ç”¨</strong>: ç§¯åˆ†å¯ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸</li></ol><h3 id=32-orderserviceæ‰©å±•>3.2 OrderServiceæ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/service/OrderService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨OrderServiceæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¤„ç†è®¢å•æ”¯ä»˜
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param amount æ”¯ä»˜é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>processOrderPayment</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å–æ¶ˆè¶…æ—¶è®¢å•
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>cancelTimeoutOrder</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param amount æ”¯ä»˜é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>sendOrderPayMessage</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/service/impl/OrderServiceImpl.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨OrderServiceImplä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¤„ç†è®¢å•æ”¯ä»˜
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param amount æ”¯ä»˜é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processOrderPayment</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Orders</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>id</span><span class=p>(</span><span class=n>orderId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>payStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PAID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>checkoutTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è®¢å•æ”¯ä»˜å¤„ç†æˆåŠŸï¼šorderId={}, amount={}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å–æ¶ˆè¶…æ—¶è®¢å•
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancelTimeoutOrder</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æŸ¥è¯¢è®¢å•çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Orders</span><span class=w> </span><span class=n>ordersDB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ordersDB</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>ordersDB</span><span class=p>.</span><span class=na>getStatus</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PENDING_PAYMENT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Orders</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>id</span><span class=p>(</span><span class=n>orderId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>cancelReason</span><span class=p>(</span><span class=s>&#34;è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>cancelTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è®¢å•è¶…æ—¶å–æ¶ˆæˆåŠŸï¼šorderId={}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderId è®¢å•ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param amount æ”¯ä»˜é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendOrderPayMessage</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€æ¶ˆæ¯çš„é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ï¼šorderId={}, userId={}, amount={}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¸šåŠ¡æµç¨‹</strong>:</p><ol><li><strong>æ”¯ä»˜å¤„ç†</strong>: æ›´æ–°è®¢å•çŠ¶æ€ï¼Œè®°å½•æ”¯ä»˜ä¿¡æ¯</li><li><strong>è¶…æ—¶å–æ¶ˆ</strong>: è‡ªåŠ¨å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜è®¢å•</li><li><strong>æ¶ˆæ¯å‘é€</strong>: å¼‚æ­¥å‘é€æ”¯ä»˜æ¶ˆæ¯</li></ol><h3 id=33-couponserviceæ‰©å±•>3.3 CouponServiceæ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/service/CouponService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨CouponServiceæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * é¢†å–ä¼˜æƒ åˆ¸
</span></span></span><span class=line><span class=cl><span class=cm> * @param templateId ä¼˜æƒ åˆ¸æ¨¡æ¿ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @return é¢†å–ç»“æœ
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=nf>claimCoupon</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>templateId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è·å–ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @return ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸åˆ—è¡¨
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Coupon</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUserAvailableCoupons</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨
</span></span></span><span class=line><span class=cl><span class=cm> * @param couponId ä¼˜æƒ åˆ¸ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderAmount è®¢å•é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm> * @return æ£€æŸ¥ç»“æœ
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=nf>checkCouponAvailable</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>couponId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>orderAmount</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/service/impl/CouponServiceImpl.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨CouponServiceImplä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * é¢†å–ä¼˜æƒ åˆ¸
</span></span></span><span class=line><span class=cl><span class=cm> * @param templateId ä¼˜æƒ åˆ¸æ¨¡æ¿ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @return é¢†å–ç»“æœ
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>claimCoupon</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>templateId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é¢†å–è¯¥æ¨¡æ¿çš„ä¼˜æƒ åˆ¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasReceived</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>templateId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;æ‚¨å·²ç»é¢†å–è¿‡è¯¥ä¼˜æƒ åˆ¸äº†&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CouponTemplate</span><span class=w> </span><span class=n>template</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>couponTemplateMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>templateId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>template</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>template</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ä¼˜æƒ åˆ¸æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>template</span><span class=p>.</span><span class=na>getEndTime</span><span class=p>().</span><span class=na>isBefore</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ä¼˜æƒ åˆ¸å·²è¿‡æœŸ&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»ºä¼˜æƒ åˆ¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Coupon</span><span class=w> </span><span class=n>coupon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Coupon</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>templateId</span><span class=p>(</span><span class=n>templateId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=c1>// 0-æœªä½¿ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>createTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>updateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>couponMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>coupon</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ä¼˜æƒ åˆ¸é¢†å–æˆåŠŸ&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è·å–ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @return ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸åˆ—è¡¨
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Coupon</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUserAvailableCoupons</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>couponMapper</span><span class=p>.</span><span class=na>getByUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w> </span><span class=c1>// 0-æœªä½¿ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨
</span></span></span><span class=line><span class=cl><span class=cm> * @param couponId ä¼˜æƒ åˆ¸ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param orderAmount è®¢å•é‡‘é¢
</span></span></span><span class=line><span class=cl><span class=cm> * @return æ£€æŸ¥ç»“æœ
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>checkCouponAvailable</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>couponId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>orderAmount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿™é‡Œå¯ä»¥æ·»åŠ ä¼˜æƒ åˆ¸å¯ç”¨æ€§æ£€æŸ¥é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ä¼˜æƒ åˆ¸å¯ç”¨&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¸šåŠ¡è§„åˆ™</strong>:</p><ol><li><strong>é¢†å–é™åˆ¶</strong>: æ¯ä¸ªç”¨æˆ·æ¯ç§ä¼˜æƒ åˆ¸åªèƒ½é¢†å–ä¸€æ¬¡</li><li><strong>æœ‰æ•ˆæœŸæ£€æŸ¥</strong>: ç¡®ä¿ä¼˜æƒ åˆ¸åœ¨æœ‰æ•ˆæœŸå†…</li><li><strong>ä½¿ç”¨æ¡ä»¶</strong>: æ£€æŸ¥ä¼˜æƒ åˆ¸çš„ä½¿ç”¨æ¡ä»¶</li></ol><h2 id=4-mapperå±‚æ‰©å±•>4. Mapperå±‚æ‰©å±•</h2><h3 id=41-usermapperæ‰©å±•>4.1 UserMapperæ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/mapper/UserMapper.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨UserMapperæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ›´æ–°ç”¨æˆ·ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm> * @param userId ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> * @param points æ–°ç§¯åˆ†
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>updateUserPoints</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>points</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/resources/mapper/UserMapper.xml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- åœ¨UserMapper.xmlä¸­æ·»åŠ ä»¥ä¸‹SQL --&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;update</span> <span class=na>id=</span><span class=s>&#34;updateUserPoints&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    UPDATE user 
</span></span><span class=line><span class=cl>    SET points = #{points}, 
</span></span><span class=line><span class=cl>        update_time = NOW()
</span></span><span class=line><span class=cl>    WHERE id = #{userId}
</span></span><span class=line><span class=cl><span class=nt>&lt;/update&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=42-couponmapperæ‰©å±•>4.2 CouponMapperæ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/mapper/CouponMapper.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨CouponMapperæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ’å…¥ä¼˜æƒ åˆ¸
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>insert</span><span class=p>(</span><span class=n>Coupon</span><span class=w> </span><span class=n>coupon</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/resources/mapper/CouponMapper.xml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- åœ¨CouponMapper.xmlä¸­æ·»åŠ ä»¥ä¸‹SQL --&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;insert</span> <span class=na>id=</span><span class=s>&#34;insert&#34;</span> <span class=na>parameterType=</span><span class=s>&#34;com.sky.entity.Coupon&#34;</span> <span class=na>useGeneratedKeys=</span><span class=s>&#34;true&#34;</span> <span class=na>keyProperty=</span><span class=s>&#34;id&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    INSERT INTO coupon (
</span></span><span class=line><span class=cl>        template_id,
</span></span><span class=line><span class=cl>        user_id,
</span></span><span class=line><span class=cl>        status,
</span></span><span class=line><span class=cl>        create_time,
</span></span><span class=line><span class=cl>        update_time
</span></span><span class=line><span class=cl>    ) VALUES (
</span></span><span class=line><span class=cl>        #{templateId},
</span></span><span class=line><span class=cl>        #{userId},
</span></span><span class=line><span class=cl>        #{status},
</span></span><span class=line><span class=cl>        #{createTime},
</span></span><span class=line><span class=cl>        #{updateTime}
</span></span><span class=line><span class=cl>    )
</span></span><span class=line><span class=cl><span class=nt>&lt;/insert&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=43-coupontemplatemapperæ‰©å±•>4.3 CouponTemplateMapperæ‰©å±•</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/mapper/CouponTemplateMapper.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœ¨CouponTemplateMapperæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿
</span></span></span><span class=line><span class=cl><span class=cm> * @return å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿åˆ—è¡¨
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>CouponTemplate</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getAvailableTemplates</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/resources/mapper/CouponTemplateMapper.xml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- åœ¨CouponTemplateMapper.xmlä¸­æ·»åŠ ä»¥ä¸‹SQL --&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;select</span> <span class=na>id=</span><span class=s>&#34;getAvailableTemplates&#34;</span> <span class=na>resultType=</span><span class=s>&#34;com.sky.entity.CouponTemplate&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    SELECT * FROM coupon_template 
</span></span><span class=line><span class=cl>    WHERE status = 1 
</span></span><span class=line><span class=cl>    AND start_time <span class=ni>&amp;lt;</span>= NOW() 
</span></span><span class=line><span class=cl>    AND end_time <span class=ni>&amp;gt;</span>= NOW()
</span></span><span class=line><span class=cl>    ORDER BY create_time DESC
</span></span><span class=line><span class=cl><span class=nt>&lt;/select&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=5-é…ç½®ç±»>5. é…ç½®ç±»</h2><h3 id=51-redissoné…ç½®>5.1 Redissoné…ç½®</h3><p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>sky-server/src/main/java/com/sky/config/RedissonConfig.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.redisson.Redisson</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.redisson.api.RedissonClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.redisson.config.Config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Redissoné…ç½®
</span></span></span><span class=line><span class=cl><span class=cm> * é…ç½®åˆ†å¸ƒå¼é”å®¢æˆ·ç«¯ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedissonConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${spring.redis.host}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${spring.redis.port}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${spring.redis.password:}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${spring.redis.database:0}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>database</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedissonClient</span><span class=w> </span><span class=nf>redissonClient</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Config</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Config</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;redis://&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>config</span><span class=p>.</span><span class=na>useSingleServer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setAddress</span><span class=p>(</span><span class=n>address</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=n>password</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setDatabase</span><span class=p>(</span><span class=n>database</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setConnectionPoolSize</span><span class=p>(</span><span class=n>10</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setConnectionMinimumIdleSize</span><span class=p>(</span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setIdleConnectionTimeout</span><span class=p>(</span><span class=n>10000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setConnectTimeout</span><span class=p>(</span><span class=n>10000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setRetryAttempts</span><span class=p>(</span><span class=n>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setRetryInterval</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Redisson</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>é…ç½®è¯´æ˜</strong>:</p><ul><li><strong>è¿æ¥æ± å¤§å°</strong>: 10ä¸ªè¿æ¥ï¼Œæ”¯æŒé«˜å¹¶å‘</li><li><strong>æœ€å°ç©ºé—²è¿æ¥</strong>: 5ä¸ªï¼Œä¿è¯è¿æ¥å¯ç”¨æ€§</li><li><strong>è¶…æ—¶è®¾ç½®</strong>: 10ç§’è¿æ¥è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…</li><li><strong>é‡è¯•æœºåˆ¶</strong>: 3æ¬¡é‡è¯•ï¼Œæé«˜è¿æ¥æˆåŠŸç‡</li></ul><h2 id=6-å…³é”®ç‰¹æ€§>6. å…³é”®ç‰¹æ€§</h2><h3 id=61-åˆ†å¸ƒå¼é”é˜²è¶…å–>6.1 åˆ†å¸ƒå¼é”é˜²è¶…å–</h3><ul><li>åŸºäºRedissonå®ç°åˆ†å¸ƒå¼é”</li><li>ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ</li><li>é”ç¼“å­˜æœºåˆ¶æé«˜æ€§èƒ½</li></ul><h3 id=62-çº¿ç¨‹å®‰å…¨>6.2 çº¿ç¨‹å®‰å…¨</h3><ul><li>MySQLæ•°æ®åº“åŸå­æ€§æ“ä½œ</li><li>Redis Luaè„šæœ¬ä¿è¯ä¸€è‡´æ€§</li><li>åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é—®é¢˜</li></ul><h3 id=63-æ€§èƒ½ä¼˜åŒ–>6.3 æ€§èƒ½ä¼˜åŒ–</h3><ul><li>é”å¯¹è±¡ç¼“å­˜</li><li>è¿æ¥æ± é…ç½®</li><li>å¼‚æ­¥å¤„ç†æœºåˆ¶</li></ul><h2 id=7-æ³¨æ„äº‹é¡¹>7. æ³¨æ„äº‹é¡¹</h2><ol><li><strong>é”è¶…æ—¶è®¾ç½®</strong>: åˆç†è®¾ç½®é”çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ­»é”</li><li><strong>å¼‚å¸¸å¤„ç†</strong>: ç¡®ä¿é”çš„é‡Šæ”¾ï¼Œé¿å…èµ„æºæ³„éœ²</li><li><strong>æ€§èƒ½ç›‘æ§</strong>: ç›‘æ§é”çš„è·å–å’Œé‡Šæ”¾æ€§èƒ½</li><li><strong>æ•°æ®ä¸€è‡´æ€§</strong>: ç¡®ä¿Rediså’ŒMySQLæ•°æ®çš„ä¸€è‡´æ€§</li></ol><h2 id=8-æµ‹è¯•å»ºè®®>8. æµ‹è¯•å»ºè®®</h2><ol><li><strong>å¹¶å‘æµ‹è¯•</strong>: ä½¿ç”¨JMeterç­‰å·¥å…·æµ‹è¯•é«˜å¹¶å‘åœºæ™¯</li><li><strong>é”æµ‹è¯•</strong>: éªŒè¯åˆ†å¸ƒå¼é”çš„æ­£ç¡®æ€§</li><li><strong>æ€§èƒ½æµ‹è¯•</strong>: æµ‹è¯•ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹çš„è¡¨ç°</li><li><strong>å¼‚å¸¸æµ‹è¯•</strong>: æµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µä¸‹çš„ç³»ç»Ÿè¡Œä¸º</li></ol><h2 id=9-ä¸šåŠ¡æµç¨‹è¯¦è§£>9. ä¸šåŠ¡æµç¨‹è¯¦è§£</h2><h3 id=91-ç§’æ€ä¸šåŠ¡æµç¨‹>9.1 ç§’æ€ä¸šåŠ¡æµç¨‹</h3><h4 id=911-ç”¨æˆ·å‚ä¸ç§’æ€æµç¨‹>9.1.1 ç”¨æˆ·å‚ä¸ç§’æ€æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>    participant U as ç”¨æˆ·
</span></span><span class=line><span class=cl>    participant C as æ§åˆ¶å™¨
</span></span><span class=line><span class=cl>    participant S as æœåŠ¡å±‚
</span></span><span class=line><span class=cl>    participant R as Redis
</span></span><span class=line><span class=cl>    participant D as æ•°æ®åº“
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    U-&gt;&gt;C: å‚ä¸ç§’æ€è¯·æ±‚
</span></span><span class=line><span class=cl>    C-&gt;&gt;S: è°ƒç”¨ç§’æ€æœåŠ¡
</span></span><span class=line><span class=cl>    S-&gt;&gt;R: è·å–åˆ†å¸ƒå¼é”
</span></span><span class=line><span class=cl>    R--&gt;&gt;S: é”è·å–æˆåŠŸ
</span></span><span class=line><span class=cl>    S-&gt;&gt;R: æ‰§è¡ŒLuaè„šæœ¬
</span></span><span class=line><span class=cl>    R--&gt;&gt;S: è¿”å›æ‰§è¡Œç»“æœ
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ›´æ–°æ•°æ®åº“
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: æ›´æ–°æˆåŠŸ
</span></span><span class=line><span class=cl>    S-&gt;&gt;R: é‡Šæ”¾é”
</span></span><span class=line><span class=cl>    R--&gt;&gt;S: é”é‡Šæ”¾æˆåŠŸ
</span></span><span class=line><span class=cl>    S--&gt;&gt;C: è¿”å›ç»“æœ
</span></span><span class=line><span class=cl>    C--&gt;&gt;U: è¿”å›å“åº”
</span></span></code></pre></td></tr></table></div></div><p><strong>æµç¨‹è¯´æ˜</strong>:</p><ol><li><strong>ç”¨æˆ·è¯·æ±‚</strong>: ç”¨æˆ·å‘èµ·ç§’æ€å‚ä¸è¯·æ±‚</li><li><strong>è·å–é”</strong>: ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é—®é¢˜</li><li><strong>æ‰§è¡Œè„šæœ¬</strong>: ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§</li><li><strong>æ›´æ–°æ•°æ®åº“</strong>: æ›´æ–°åº“å­˜å’Œè®¢å•ä¿¡æ¯</li><li><strong>é‡Šæ”¾é”</strong>: é‡Šæ”¾åˆ†å¸ƒå¼é”</li><li><strong>è¿”å›ç»“æœ</strong>: è¿”å›å¤„ç†ç»“æœç»™ç”¨æˆ·</li></ol><h4 id=912-é˜²è¶…å–æœºåˆ¶>9.1.2 é˜²è¶…å–æœºåˆ¶</h4><p><strong>Luaè„šæœ¬å®ç°</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- ç§’æ€å‚ä¸è„šæœ¬</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>stockKey</span> <span class=o>=</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>participantsKey</span> <span class=o>=</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>userId</span> <span class=o>=</span> <span class=n>ARGV</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>quantity</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>perUserLimit</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- æ£€æŸ¥åº“å­˜</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>currentStock</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=n>stockKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=ow>not</span> <span class=n>currentStock</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;æ´»åŠ¨ä¸å­˜åœ¨&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>currentStock</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>currentStock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>currentStock</span> <span class=o>&lt;</span> <span class=n>quantity</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;åº“å­˜ä¸è¶³&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- æ£€æŸ¥ç”¨æˆ·è´­ä¹°é™åˆ¶</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>userPurchased</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;hget&#39;</span><span class=p>,</span> <span class=n>participantsKey</span><span class=p>,</span> <span class=n>userId</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>userPurchased</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>userPurchased</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>userPurchased</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>if</span> <span class=n>userPurchased</span> <span class=o>+</span> <span class=n>quantity</span> <span class=o>&gt;</span> <span class=n>perUserLimit</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>        <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;è¶…å‡ºè´­ä¹°é™åˆ¶&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- æ‰£å‡åº“å­˜</span>
</span></span><span class=line><span class=cl><span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;decrby&#39;</span><span class=p>,</span> <span class=n>stockKey</span><span class=p>,</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>-- è®°å½•ç”¨æˆ·è´­ä¹°</span>
</span></span><span class=line><span class=cl><span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;hincrby&#39;</span><span class=p>,</span> <span class=n>participantsKey</span><span class=p>,</span> <span class=n>userId</span><span class=p>,</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;å‚ä¸æˆåŠŸ&#39;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>é˜²è¶…å–åŸç†</strong>:</p><ol><li><strong>åŸå­æ€§æ“ä½œ</strong>: Luaè„šæœ¬ä¿è¯æ“ä½œçš„åŸå­æ€§</li><li><strong>åº“å­˜æ£€æŸ¥</strong>: å…ˆæ£€æŸ¥åº“å­˜å†æ‰£å‡</li><li><strong>ç”¨æˆ·é™åˆ¶</strong>: æ£€æŸ¥ç”¨æˆ·è´­ä¹°é™åˆ¶</li><li><strong>çŠ¶æ€æ›´æ–°</strong>: åŒæ—¶æ›´æ–°åº“å­˜å’Œç”¨æˆ·è®°å½•</li></ol><h3 id=92-ä¼˜æƒ åˆ¸ä¸šåŠ¡æµç¨‹>9.2 ä¼˜æƒ åˆ¸ä¸šåŠ¡æµç¨‹</h3><h4 id=921-ä¼˜æƒ åˆ¸é¢†å–æµç¨‹>9.2.1 ä¼˜æƒ åˆ¸é¢†å–æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>    participant U as ç”¨æˆ·
</span></span><span class=line><span class=cl>    participant C as æ§åˆ¶å™¨
</span></span><span class=line><span class=cl>    participant S as æœåŠ¡å±‚
</span></span><span class=line><span class=cl>    participant D as æ•°æ®åº“
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    U-&gt;&gt;C: é¢†å–ä¼˜æƒ åˆ¸è¯·æ±‚
</span></span><span class=line><span class=cl>    C-&gt;&gt;S: è°ƒç”¨ä¼˜æƒ åˆ¸æœåŠ¡
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é¢†å–
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: è¿”å›æ£€æŸ¥ç»“æœ
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: è¿”å›æ¨¡æ¿ä¿¡æ¯
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: åˆ›å»ºä¼˜æƒ åˆ¸è®°å½•
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: åˆ›å»ºæˆåŠŸ
</span></span><span class=line><span class=cl>    S--&gt;&gt;C: è¿”å›ç»“æœ
</span></span><span class=line><span class=cl>    C--&gt;&gt;U: è¿”å›å“åº”
</span></span></code></pre></td></tr></table></div></div><p><strong>ä¸šåŠ¡è§„åˆ™</strong>:</p><ol><li><strong>é¢†å–é™åˆ¶</strong>: æ¯ä¸ªç”¨æˆ·æ¯ç§ä¼˜æƒ åˆ¸åªèƒ½é¢†å–ä¸€æ¬¡</li><li><strong>æœ‰æ•ˆæœŸæ£€æŸ¥</strong>: ç¡®ä¿ä¼˜æƒ åˆ¸åœ¨æœ‰æ•ˆæœŸå†…</li><li><strong>çŠ¶æ€æ£€æŸ¥</strong>: æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿æ˜¯å¦å¯ç”¨</li><li><strong>è®°å½•åˆ›å»º</strong>: åˆ›å»ºç”¨æˆ·ä¼˜æƒ åˆ¸è®°å½•</li></ol><h4 id=922-ä¼˜æƒ åˆ¸ä½¿ç”¨æµç¨‹>9.2.2 ä¼˜æƒ åˆ¸ä½¿ç”¨æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>    participant U as ç”¨æˆ·
</span></span><span class=line><span class=cl>    participant C as æ§åˆ¶å™¨
</span></span><span class=line><span class=cl>    participant S as æœåŠ¡å±‚
</span></span><span class=line><span class=cl>    participant D as æ•°æ®åº“
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    U-&gt;&gt;C: ä½¿ç”¨ä¼˜æƒ åˆ¸è¯·æ±‚
</span></span><span class=line><span class=cl>    C-&gt;&gt;S: è°ƒç”¨ä¼˜æƒ åˆ¸æœåŠ¡
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ£€æŸ¥ä¼˜æƒ åˆ¸çŠ¶æ€
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: è¿”å›ä¼˜æƒ åˆ¸ä¿¡æ¯
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ£€æŸ¥ä½¿ç”¨æ¡ä»¶
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: è¿”å›æ£€æŸ¥ç»“æœ
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: æ›´æ–°æˆåŠŸ
</span></span><span class=line><span class=cl>    S--&gt;&gt;C: è¿”å›ç»“æœ
</span></span><span class=line><span class=cl>    C--&gt;&gt;U: è¿”å›å“åº”
</span></span></code></pre></td></tr></table></div></div><p><strong>ä½¿ç”¨æ¡ä»¶</strong>:</p><ol><li><strong>çŠ¶æ€æ£€æŸ¥</strong>: ä¼˜æƒ åˆ¸å¿…é¡»ä¸ºæœªä½¿ç”¨çŠ¶æ€</li><li><strong>æœ‰æ•ˆæœŸæ£€æŸ¥</strong>: ä¼˜æƒ åˆ¸å¿…é¡»åœ¨æœ‰æ•ˆæœŸå†…</li><li><strong>ä½¿ç”¨æ¡ä»¶</strong>: æ£€æŸ¥è®¢å•é‡‘é¢æ˜¯å¦æ»¡è¶³ä½¿ç”¨æ¡ä»¶</li><li><strong>çŠ¶æ€æ›´æ–°</strong>: æ›´æ–°ä¼˜æƒ åˆ¸ä¸ºå·²ä½¿ç”¨çŠ¶æ€</li></ol><h3 id=93-ç§¯åˆ†ä¸šåŠ¡æµç¨‹>9.3 ç§¯åˆ†ä¸šåŠ¡æµç¨‹</h3><h4 id=931-ç§¯åˆ†è·å¾—æµç¨‹>9.3.1 ç§¯åˆ†è·å¾—æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>    participant O as è®¢å•æœåŠ¡
</span></span><span class=line><span class=cl>    participant M as æ¶ˆæ¯é˜Ÿåˆ—
</span></span><span class=line><span class=cl>    participant I as ç§¯åˆ†æœåŠ¡
</span></span><span class=line><span class=cl>    participant D as æ•°æ®åº“
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    O-&gt;&gt;M: å‘é€ç§¯åˆ†æ¶ˆæ¯
</span></span><span class=line><span class=cl>    M-&gt;&gt;I: æ¶ˆè´¹ç§¯åˆ†æ¶ˆæ¯
</span></span><span class=line><span class=cl>    I-&gt;&gt;D: æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†
</span></span><span class=line><span class=cl>    D--&gt;&gt;I: è¿”å›å½“å‰ç§¯åˆ†
</span></span><span class=line><span class=cl>    I-&gt;&gt;D: æ›´æ–°ç”¨æˆ·ç§¯åˆ†
</span></span><span class=line><span class=cl>    D--&gt;&gt;I: æ›´æ–°æˆåŠŸ
</span></span><span class=line><span class=cl>    I-&gt;&gt;M: ç¡®è®¤æ¶ˆæ¯
</span></span></code></pre></td></tr></table></div></div><p><strong>ç§¯åˆ†è§„åˆ™</strong>:</p><ol><li><strong>è·å¾—è§„åˆ™</strong>: æ¯æ¶ˆè´¹1å…ƒè·å¾—1ç§¯åˆ†</li><li><strong>æœ‰æ•ˆæœŸ</strong>: ç§¯åˆ†æœ‰æ•ˆæœŸä¸º1å¹´</li><li><strong>ä½¿ç”¨è§„åˆ™</strong>: ç§¯åˆ†å¯ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸</li><li><strong>è®°å½•ç®¡ç†</strong>: è®°å½•ç§¯åˆ†å˜åŠ¨å†å²</li></ol><h4 id=932-ç§¯åˆ†ä½¿ç”¨æµç¨‹>9.3.2 ç§¯åˆ†ä½¿ç”¨æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>    participant U as ç”¨æˆ·
</span></span><span class=line><span class=cl>    participant C as æ§åˆ¶å™¨
</span></span><span class=line><span class=cl>    participant S as æœåŠ¡å±‚
</span></span><span class=line><span class=cl>    participant D as æ•°æ®åº“
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    U-&gt;&gt;C: ä½¿ç”¨ç§¯åˆ†è¯·æ±‚
</span></span><span class=line><span class=cl>    C-&gt;&gt;S: è°ƒç”¨ç§¯åˆ†æœåŠ¡
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: è¿”å›ç§¯åˆ†ä¿¡æ¯
</span></span><span class=line><span class=cl>    S-&gt;&gt;D: æ‰£å‡ç”¨æˆ·ç§¯åˆ†
</span></span><span class=line><span class=cl>    D--&gt;&gt;S: æ‰£å‡æˆåŠŸ
</span></span><span class=line><span class=cl>    S--&gt;&gt;C: è¿”å›ç»“æœ
</span></span><span class=line><span class=cl>    C--&gt;&gt;U: è¿”å›å“åº”
</span></span></code></pre></td></tr></table></div></div><p><strong>ä½¿ç”¨é™åˆ¶</strong>:</p><ol><li><strong>ç§¯åˆ†æ£€æŸ¥</strong>: ç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿç§¯åˆ†</li><li><strong>æœ‰æ•ˆæœŸæ£€æŸ¥</strong>: ç¡®ä¿ç§¯åˆ†åœ¨æœ‰æ•ˆæœŸå†…</li><li><strong>ä½¿ç”¨è®°å½•</strong>: è®°å½•ç§¯åˆ†ä½¿ç”¨å†å²</li><li><strong>çŠ¶æ€æ›´æ–°</strong>: æ›´æ–°ç”¨æˆ·ç§¯åˆ†ä½™é¢</li></ol><h2 id=10-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥>10. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h2><h3 id=101-ç¼“å­˜ç­–ç•¥>10.1 ç¼“å­˜ç­–ç•¥</h3><h4 id=1011-redisç¼“å­˜è®¾è®¡>10.1.1 Redisç¼“å­˜è®¾è®¡</h4><p><strong>ç¼“å­˜é”®è®¾è®¡</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>seckill:stock:æ´»åŠ¨ID          # åº“å­˜ç¼“å­˜
</span></span><span class=line><span class=cl>seckill:participants:æ´»åŠ¨ID   # å‚ä¸è€…ç¼“å­˜
</span></span><span class=line><span class=cl>seckill:lock:ä¸šåŠ¡é”®          # é”ç¼“å­˜
</span></span><span class=line><span class=cl>seckill:order:è®¢å•ID         # è®¢å•ç¼“å­˜
</span></span></code></pre></td></tr></table></div></div><p><strong>ç¼“å­˜æ›´æ–°ç­–ç•¥</strong>:</p><ol><li><strong>å†™ç©¿é€</strong>: å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜</li><li><strong>ç¼“å­˜é¢„çƒ­</strong>: ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®</li><li><strong>ç¼“å­˜æ›´æ–°</strong>: æ•°æ®å˜æ›´æ—¶åŠæ—¶æ›´æ–°ç¼“å­˜</li><li><strong>ç¼“å­˜è¿‡æœŸ</strong>: è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´</li></ol><h4 id=1012-ç¼“å­˜ä¸€è‡´æ€§>10.1.2 ç¼“å­˜ä¸€è‡´æ€§</h4><p><strong>ä¸€è‡´æ€§ä¿è¯</strong>:</p><ol><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>: å…è®¸çŸ­æš‚çš„ä¸ä¸€è‡´</li><li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>: ä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶ç¼“å­˜æ›´æ–°</li><li><strong>äº‹ä»¶é©±åŠ¨</strong>: é€šè¿‡äº‹ä»¶æœºåˆ¶æ›´æ–°ç¼“å­˜</li><li><strong>ç›‘æ§å‘Šè­¦</strong>: ç›‘æ§ç¼“å­˜ä¸€è‡´æ€§çŠ¶æ€</li></ol><h3 id=102-æ•°æ®åº“ä¼˜åŒ–>10.2 æ•°æ®åº“ä¼˜åŒ–</h3><h4 id=1021-ç´¢å¼•ä¼˜åŒ–>10.2.1 ç´¢å¼•ä¼˜åŒ–</h4><p><strong>ç§’æ€æ´»åŠ¨è¡¨ç´¢å¼•</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- æ´»åŠ¨çŠ¶æ€ç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_seckill_activity_status</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>seckill_activity</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- æ—¶é—´èŒƒå›´ç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_seckill_activity_time</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>seckill_activity</span><span class=p>(</span><span class=n>start_time</span><span class=p>,</span><span class=w> </span><span class=n>end_time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- å•†å“IDç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_seckill_activity_dish_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>seckill_activity</span><span class=p>(</span><span class=n>dish_id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¼˜æƒ åˆ¸è¡¨ç´¢å¼•</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- ç”¨æˆ·IDç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_coupon_user_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>coupon</span><span class=p>(</span><span class=n>user_id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- çŠ¶æ€ç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_coupon_status</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>coupon</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- æ¨¡æ¿IDç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_coupon_template_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>coupon</span><span class=p>(</span><span class=n>template_id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1022-åˆ†åº“åˆ†è¡¨ç­–ç•¥>10.2.2 åˆ†åº“åˆ†è¡¨ç­–ç•¥</h4><p><strong>åˆ†è¡¨ç­–ç•¥</strong>:</p><ol><li><strong>æŒ‰æ—¶é—´åˆ†è¡¨</strong>: æŒ‰æœˆæˆ–æŒ‰å¹´åˆ†è¡¨</li><li><strong>æŒ‰ç”¨æˆ·IDåˆ†è¡¨</strong>: æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†è¡¨</li><li><strong>æŒ‰æ´»åŠ¨IDåˆ†è¡¨</strong>: æŒ‰æ´»åŠ¨IDåˆ†è¡¨</li><li><strong>æŒ‰çŠ¶æ€åˆ†è¡¨</strong>: æŒ‰æ•°æ®çŠ¶æ€åˆ†è¡¨</li></ol><h3 id=103-å¹¶å‘æ§åˆ¶>10.3 å¹¶å‘æ§åˆ¶</h3><h4 id=1031-åˆ†å¸ƒå¼é”ä¼˜åŒ–>10.3.1 åˆ†å¸ƒå¼é”ä¼˜åŒ–</h4><p><strong>é”ç²’åº¦æ§åˆ¶</strong>:</p><ol><li><strong>ç»†ç²’åº¦é”</strong>: æŒ‰å•†å“IDåŠ é”</li><li><strong>é”è¶…æ—¶è®¾ç½®</strong>: è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´</li><li><strong>é”é‡å…¥</strong>: æ”¯æŒé”é‡å…¥æœºåˆ¶</li><li><strong>é”ç›‘æ§</strong>: ç›‘æ§é”çš„ä½¿ç”¨æƒ…å†µ</li></ol><p><strong>é”æ€§èƒ½ä¼˜åŒ–</strong>:</p><ol><li><strong>é”ç¼“å­˜</strong>: ç¼“å­˜é”å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»º</li><li><strong>é”å‡çº§</strong>: æ”¯æŒé”å‡çº§æœºåˆ¶</li><li><strong>é”é™çº§</strong>: æ”¯æŒé”é™çº§æœºåˆ¶</li><li><strong>é”é‡Šæ”¾</strong>: ç¡®ä¿é”çš„æ­£ç¡®é‡Šæ”¾</li></ol><h4 id=1032-é™æµç­–ç•¥>10.3.2 é™æµç­–ç•¥</h4><p><strong>æ¥å£é™æµ</strong>:</p><ol><li><strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>: ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•é™æµ</li><li><strong>æ»‘åŠ¨çª—å£</strong>: ä½¿ç”¨æ»‘åŠ¨çª—å£é™æµ</li><li><strong>æ¼æ¡¶ç®—æ³•</strong>: ä½¿ç”¨æ¼æ¡¶ç®—æ³•é™æµ</li><li><strong>è‡ªé€‚åº”é™æµ</strong>: æ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªé€‚åº”é™æµ</li></ol><p><strong>ç”¨æˆ·é™æµ</strong>:</p><ol><li><strong>IPé™æµ</strong>: æŒ‰IPåœ°å€é™æµ</li><li><strong>ç”¨æˆ·é™æµ</strong>: æŒ‰ç”¨æˆ·IDé™æµ</li><li><strong>è®¾å¤‡é™æµ</strong>: æŒ‰è®¾å¤‡IDé™æµ</li><li><strong>è¡Œä¸ºé™æµ</strong>: æŒ‰ç”¨æˆ·è¡Œä¸ºé™æµ</li></ol><h2 id=11-ç›‘æ§å’Œå‘Šè­¦>11. ç›‘æ§å’Œå‘Šè­¦</h2><h3 id=111-ç³»ç»Ÿç›‘æ§>11.1 ç³»ç»Ÿç›‘æ§</h3><h4 id=1111-æ€§èƒ½ç›‘æ§>11.1.1 æ€§èƒ½ç›‘æ§</h4><p><strong>å…³é”®æŒ‡æ ‡</strong>:</p><ol><li><strong>å“åº”æ—¶é—´</strong>: æ¥å£å“åº”æ—¶é—´ç›‘æ§</li><li><strong>ååé‡</strong>: ç³»ç»Ÿååé‡ç›‘æ§</li><li><strong>é”™è¯¯ç‡</strong>: ç³»ç»Ÿé”™è¯¯ç‡ç›‘æ§</li><li><strong>èµ„æºä½¿ç”¨</strong>: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡</li></ol><p><strong>ç›‘æ§å·¥å…·</strong>:</p><ol><li><strong>Prometheus</strong>: æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨</li><li><strong>Grafana</strong>: æŒ‡æ ‡å¯è§†åŒ–</li><li><strong>AlertManager</strong>: å‘Šè­¦ç®¡ç†</li><li><strong>Jaeger</strong>: åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</li></ol><h4 id=1112-ä¸šåŠ¡ç›‘æ§>11.1.2 ä¸šåŠ¡ç›‘æ§</h4><p><strong>ä¸šåŠ¡æŒ‡æ ‡</strong>:</p><ol><li><strong>ç§’æ€æˆåŠŸç‡</strong>: ç§’æ€æ´»åŠ¨æˆåŠŸç‡</li><li><strong>ä¼˜æƒ åˆ¸ä½¿ç”¨ç‡</strong>: ä¼˜æƒ åˆ¸ä½¿ç”¨ç‡</li><li><strong>ç§¯åˆ†ä½¿ç”¨ç‡</strong>: ç§¯åˆ†ä½¿ç”¨ç‡</li><li><strong>ç”¨æˆ·æ´»è·ƒåº¦</strong>: ç”¨æˆ·æ´»è·ƒåº¦æŒ‡æ ‡</li></ol><h3 id=112-å‘Šè­¦æœºåˆ¶>11.2 å‘Šè­¦æœºåˆ¶</h3><h4 id=1121-å‘Šè­¦è§„åˆ™>11.2.1 å‘Šè­¦è§„åˆ™</h4><p><strong>ç³»ç»Ÿå‘Šè­¦</strong>:</p><ol><li><strong>å“åº”æ—¶é—´å‘Šè­¦</strong>: å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼</li><li><strong>é”™è¯¯ç‡å‘Šè­¦</strong>: é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼</li><li><strong>èµ„æºä½¿ç”¨å‘Šè­¦</strong>: èµ„æºä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼</li><li><strong>æœåŠ¡å¯ç”¨æ€§å‘Šè­¦</strong>: æœåŠ¡ä¸å¯ç”¨å‘Šè­¦</li></ol><p><strong>ä¸šåŠ¡å‘Šè­¦</strong>:</p><ol><li><strong>åº“å­˜å‘Šè­¦</strong>: åº“å­˜ä¸è¶³å‘Šè­¦</li><li><strong>æ´»åŠ¨å¼‚å¸¸å‘Šè­¦</strong>: æ´»åŠ¨å¼‚å¸¸å‘Šè­¦</li><li><strong>æ•°æ®å¼‚å¸¸å‘Šè­¦</strong>: æ•°æ®å¼‚å¸¸å‘Šè­¦</li><li><strong>ç”¨æˆ·å¼‚å¸¸å‘Šè­¦</strong>: ç”¨æˆ·è¡Œä¸ºå¼‚å¸¸å‘Šè­¦</li></ol><h4 id=1122-å‘Šè­¦å¤„ç†>11.2.2 å‘Šè­¦å¤„ç†</h4><p><strong>å‘Šè­¦æµç¨‹</strong>:</p><ol><li><strong>å‘Šè­¦è§¦å‘</strong>: ç›‘æ§æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼</li><li><strong>å‘Šè­¦å‘é€</strong>: å‘é€å‘Šè­¦é€šçŸ¥</li><li><strong>å‘Šè­¦å¤„ç†</strong>: å¤„ç†å‘Šè­¦é—®é¢˜</li><li><strong>å‘Šè­¦æ¢å¤</strong>: å‘Šè­¦æ¢å¤é€šçŸ¥</li></ol><h2 id=12-æµ‹è¯•ç­–ç•¥>12. æµ‹è¯•ç­–ç•¥</h2><h3 id=121-å•å…ƒæµ‹è¯•>12.1 å•å…ƒæµ‹è¯•</h3><h4 id=1211-æœåŠ¡å±‚æµ‹è¯•>12.1.1 æœåŠ¡å±‚æµ‹è¯•</h4><p><strong>æµ‹è¯•è¦†ç›–</strong>:</p><ol><li><strong>æ­£å¸¸æµç¨‹æµ‹è¯•</strong>: æµ‹è¯•æ­£å¸¸ä¸šåŠ¡æµç¨‹</li><li><strong>å¼‚å¸¸æµç¨‹æµ‹è¯•</strong>: æµ‹è¯•å¼‚å¸¸æƒ…å†µå¤„ç†</li><li><strong>è¾¹ç•Œæ¡ä»¶æµ‹è¯•</strong>: æµ‹è¯•è¾¹ç•Œæ¡ä»¶</li><li><strong>å¹¶å‘æµ‹è¯•</strong>: æµ‹è¯•å¹¶å‘åœºæ™¯</li></ol><p><strong>æµ‹è¯•å·¥å…·</strong>:</p><ol><li><strong>JUnit</strong>: å•å…ƒæµ‹è¯•æ¡†æ¶</li><li><strong>Mockito</strong>: Mockæµ‹è¯•æ¡†æ¶</li><li><strong>TestContainers</strong>: å®¹å™¨åŒ–æµ‹è¯•</li><li><strong>WireMock</strong>: HTTPæœåŠ¡Mock</li></ol><h4 id=1212-é›†æˆæµ‹è¯•>12.1.2 é›†æˆæµ‹è¯•</h4><p><strong>æµ‹è¯•åœºæ™¯</strong>:</p><ol><li><strong>æ•°æ®åº“é›†æˆæµ‹è¯•</strong>: æµ‹è¯•æ•°æ®åº“æ“ä½œ</li><li><strong>Redisé›†æˆæµ‹è¯•</strong>: æµ‹è¯•Redisæ“ä½œ</li><li><strong>æ¶ˆæ¯é˜Ÿåˆ—é›†æˆæµ‹è¯•</strong>: æµ‹è¯•æ¶ˆæ¯é˜Ÿåˆ—æ“ä½œ</li><li><strong>å¤–éƒ¨æœåŠ¡é›†æˆæµ‹è¯•</strong>: æµ‹è¯•å¤–éƒ¨æœåŠ¡è°ƒç”¨</li></ol><h3 id=122-æ€§èƒ½æµ‹è¯•>12.2 æ€§èƒ½æµ‹è¯•</h3><h4 id=1221-å‹åŠ›æµ‹è¯•>12.2.1 å‹åŠ›æµ‹è¯•</h4><p><strong>æµ‹è¯•å·¥å…·</strong>:</p><ol><li><strong>JMeter</strong>: æ€§èƒ½æµ‹è¯•å·¥å…·</li><li><strong>Gatling</strong>: é«˜æ€§èƒ½æµ‹è¯•å·¥å…·</li><li><strong>Artillery</strong>: è½»é‡çº§æµ‹è¯•å·¥å…·</li><li><strong>K6</strong>: ç°ä»£åŒ–æµ‹è¯•å·¥å…·</li></ol><p><strong>æµ‹è¯•åœºæ™¯</strong>:</p><ol><li><strong>ç§’æ€å‹åŠ›æµ‹è¯•</strong>: æµ‹è¯•ç§’æ€åœºæ™¯æ€§èƒ½</li><li><strong>ä¼˜æƒ åˆ¸å‹åŠ›æµ‹è¯•</strong>: æµ‹è¯•ä¼˜æƒ åˆ¸åœºæ™¯æ€§èƒ½</li><li><strong>ç§¯åˆ†å‹åŠ›æµ‹è¯•</strong>: æµ‹è¯•ç§¯åˆ†åœºæ™¯æ€§èƒ½</li><li><strong>æ··åˆåœºæ™¯æµ‹è¯•</strong>: æµ‹è¯•æ··åˆåœºæ™¯æ€§èƒ½</li></ol><h4 id=1222-ç¨³å®šæ€§æµ‹è¯•>12.2.2 ç¨³å®šæ€§æµ‹è¯•</h4><p><strong>æµ‹è¯•ç›®æ ‡</strong>:</p><ol><li><strong>é•¿æ—¶é—´è¿è¡Œ</strong>: æµ‹è¯•ç³»ç»Ÿé•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§</li><li><strong>å†…å­˜æ³„æ¼</strong>: æµ‹è¯•å†…å­˜æ³„æ¼é—®é¢˜</li><li><strong>èµ„æºä½¿ç”¨</strong>: æµ‹è¯•èµ„æºä½¿ç”¨æƒ…å†µ</li><li><strong>æ€§èƒ½è¡°å‡</strong>: æµ‹è¯•æ€§èƒ½è¡°å‡æƒ…å†µ</li></ol><h2 id=13-éƒ¨ç½²å’Œè¿ç»´>13. éƒ¨ç½²å’Œè¿ç»´</h2><h3 id=131-éƒ¨ç½²ç­–ç•¥>13.1 éƒ¨ç½²ç­–ç•¥</h3><h4 id=1311-å®¹å™¨åŒ–éƒ¨ç½²>13.1.1 å®¹å™¨åŒ–éƒ¨ç½²</h4><p><strong>Dockeré…ç½®</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> openjdk:17-jre-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> target/sky-server.jar app.jar<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8084</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;java&#34;</span><span class=p>,</span> <span class=s2>&#34;-jar&#34;</span><span class=p>,</span> <span class=s2>&#34;/app.jar&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Docker Composeé…ç½®</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sky-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8084:8084&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SPRING_PROFILES_ACTIVE=prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>rabbitmq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:7-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;6379:6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>rabbitmq:3-management</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;5672:5672&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;15672:15672&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mysql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mysql:8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3306:3306&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_ROOT_PASSWORD=root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_DATABASE=sky</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1312-å¾®æœåŠ¡éƒ¨ç½²>13.1.2 å¾®æœåŠ¡éƒ¨ç½²</h4><p><strong>æœåŠ¡æ‹†åˆ†</strong>:</p><ol><li><strong>ç”¨æˆ·æœåŠ¡</strong>: ç”¨æˆ·ç›¸å…³åŠŸèƒ½</li><li><strong>è®¢å•æœåŠ¡</strong>: è®¢å•ç›¸å…³åŠŸèƒ½</li><li><strong>å•†å“æœåŠ¡</strong>: å•†å“ç›¸å…³åŠŸèƒ½</li><li><strong>ä¼˜æƒ åˆ¸æœåŠ¡</strong>: ä¼˜æƒ åˆ¸ç›¸å…³åŠŸèƒ½</li><li><strong>ç§¯åˆ†æœåŠ¡</strong>: ç§¯åˆ†ç›¸å…³åŠŸèƒ½</li></ol><p><strong>æœåŠ¡æ²»ç†</strong>:</p><ol><li><strong>æœåŠ¡æ³¨å†Œ</strong>: ä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡æ³¨å†Œ</li><li><strong>æœåŠ¡å‘ç°</strong>: ä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡å‘ç°</li><li><strong>è´Ÿè½½å‡è¡¡</strong>: ä½¿ç”¨Ribbonè¿›è¡Œè´Ÿè½½å‡è¡¡</li><li><strong>ç†”æ–­é™çº§</strong>: ä½¿ç”¨Sentinelè¿›è¡Œç†”æ–­é™çº§</li></ol><h3 id=132-è¿ç»´ç›‘æ§>13.2 è¿ç»´ç›‘æ§</h3><h4 id=1321-æ—¥å¿—ç®¡ç†>13.2.1 æ—¥å¿—ç®¡ç†</h4><p><strong>æ—¥å¿—é…ç½®</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>com.sky</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pattern</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>console</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logs/sky-server.log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max-size</span><span class=p>:</span><span class=w> </span><span class=l>100MB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max-history</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æ—¥å¿—æ”¶é›†</strong>:</p><ol><li><strong>ELK Stack</strong>: ä½¿ç”¨Elasticsearchã€Logstashã€Kibana</li><li><strong>Fluentd</strong>: ä½¿ç”¨Fluentdæ”¶é›†æ—¥å¿—</li><li><strong>Filebeat</strong>: ä½¿ç”¨Filebeatæ”¶é›†æ—¥å¿—</li><li><strong>Logback</strong>: ä½¿ç”¨Logbackè®°å½•æ—¥å¿—</li></ol><h4 id=1322-ç›‘æ§å‘Šè­¦>13.2.2 ç›‘æ§å‘Šè­¦</h4><p><strong>ç›‘æ§æŒ‡æ ‡</strong>:</p><ol><li><strong>ç³»ç»ŸæŒ‡æ ‡</strong>: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ</li><li><strong>åº”ç”¨æŒ‡æ ‡</strong>: å“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡</li><li><strong>ä¸šåŠ¡æŒ‡æ ‡</strong>: è®¢å•é‡ã€ç”¨æˆ·é‡ã€æ”¶å…¥</li><li><strong>åŸºç¡€è®¾æ–½æŒ‡æ ‡</strong>: æ•°æ®åº“ã€Redisã€æ¶ˆæ¯é˜Ÿåˆ—</li></ol><p><strong>å‘Šè­¦é…ç½®</strong>:</p><ol><li><strong>é˜ˆå€¼å‘Šè­¦</strong>: è®¾ç½®æŒ‡æ ‡é˜ˆå€¼å‘Šè­¦</li><li><strong>è¶‹åŠ¿å‘Šè­¦</strong>: è®¾ç½®è¶‹åŠ¿å˜åŒ–å‘Šè­¦</li><li><strong>å¼‚å¸¸å‘Šè­¦</strong>: è®¾ç½®å¼‚å¸¸æƒ…å†µå‘Šè­¦</li><li><strong>æ¢å¤å‘Šè­¦</strong>: è®¾ç½®æ¢å¤æƒ…å†µå‘Šè­¦</li></ol><p>é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼é”é˜²è¶…å–ç³»ç»Ÿï¼Œç¡®ä¿äº†ç§’æ€å’Œä¼˜æƒ åˆ¸åŠŸèƒ½çš„çº¿ç¨‹å®‰å…¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/spring-boot/>Spring Boot</a>
<a href=/tags/redis/>Redis</a>
<a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/>åˆ†å¸ƒå¼é”</a>
<a href=/tags/lua%E8%84%9A%E6%9C%AC/>Luaè„šæœ¬</a>
<a href=/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/>ç§’æ€ç³»ç»Ÿ</a>
<a href=/tags/%E9%98%B2%E8%B6%85%E5%8D%96/>é˜²è¶…å–</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/><div class=article-details><h2 class=article-title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡</h2></div></a></article><article><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8Capi%E6%8E%A5%E5%8F%A3/><div class=article-details><h2 class=article-title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£</h2></div></a></article><article><a href=/p/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-redis--lua-%E5%9C%A8%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/><div class=article-details><h2 class=article-title>æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨</h2></div></a></article><article><a href=/p/%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%90%ABredis%E9%A2%84%E6%89%A3%E5%BA%93%E5%AD%98%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0/><div class=article-details><h2 class=article-title>å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰</h2></div></a></article><article><a href=/p/redisson-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/><div class=article-details><h2 class=article-title>Redisson å¯é‡å…¥é”åŸç†è¯¦è§£</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 Cecilia-å¡è¥¿è‰å¨…</section><section class=powerby>Never give up<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>