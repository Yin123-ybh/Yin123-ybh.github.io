<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='秒杀活动功能完善指南 - 第一部分 目录 项目概述 数据库设计 后端核心功能实现 项目概述 功能目标 实现高并发的秒杀活动系统 防止超卖和重复参与 支持分布式部署 提供用户友好的界面 技术栈 后端: Spring Boot + MyBatis + Redis + Redisson 前端: Vue.js + Element UI 数据库: MySQL 缓存: Redis 分布式锁: Redisson 数据库设计 1. 秒杀参与记录表 1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE seckill_participant ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, quantity INT NOT NULL COMMENT &#39;参与数量&#39;, status TINYINT(1) DEFAULT 0 COMMENT &#39;状态：0-待处理，1-成功，2-失败&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;, PRIMARY KEY (id), UNIQUE KEY uk_user_activity (user_id, activity_id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;秒杀参与记录表&#39;; 2. 秒杀订单表 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 CREATE TABLE seckill_order ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, dish_id BIGINT NOT NULL COMMENT &#39;商品ID&#39;, quantity INT NOT NULL COMMENT &#39;购买数量&#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT &#39;秒杀价格&#39;, total_amount DECIMAL(10,2) NOT NULL COMMENT &#39;总金额&#39;, status TINYINT(1) DEFAULT 0 COMMENT &#39;订单状态：0-待支付，1-已支付，2-已取消&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;, PRIMARY KEY (id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;秒杀订单表&#39;; 3. 库存扣减记录表 1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE seckill_stock_log ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, quantity INT NOT NULL COMMENT &#39;扣减数量&#39;, before_stock INT NOT NULL COMMENT &#39;扣减前库存&#39;, after_stock INT NOT NULL COMMENT &#39;扣减后库存&#39;, status TINYINT(1) DEFAULT 1 COMMENT &#39;状态：1-成功，0-失败&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, PRIMARY KEY (id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;库存扣减记录表&#39;; 后端核心功能实现 1. 创建实体类 1.1 秒杀参与记录实体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillParticipant.java package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillParticipant implements Serializable { private static final long serialVersionUID = 1L; private Long id; private Long activityId; private Long userId; private Integer quantity; private Integer status; private LocalDateTime createTime; private LocalDateTime updateTime; } 1.2 秒杀订单实体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillOrder.java package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.math.BigDecimal; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillOrder implements Serializable { private static final long serialVersionUID = 1L; private Long id; private Long activityId; private Long userId; private Long dishId; private Integer quantity; private BigDecimal seckillPrice; private BigDecimal totalAmount; private Integer status; private LocalDateTime createTime; private LocalDateTime updateTime; } 2. 创建DTO类 2.1 秒杀参与DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // 文件路径: sky-pojo/src/main/java/com/sky/dto/SeckillParticipateDTO.java package com.sky.dto; import lombok.Data; import java.io.Serializable; @Data public class SeckillParticipateDTO implements Serializable { private static final long serialVersionUID = 1L; private Long activityId; private Long userId; private Integer quantity; } 3. 创建Mapper接口 3.1 秒杀参与记录Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillParticipantMapper.java package com.sky.mapper; import com.sky.entity.SeckillParticipant; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillParticipantMapper { void insert(SeckillParticipant participant); SeckillParticipant getByUserAndActivity(@Param("userId") Long userId, @Param("activityId") Long activityId); void updateStatus(@Param("id") Long id, @Param("status") Integer status); } 3.2 秒杀订单Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillOrderMapper.java package com.sky.mapper; import com.sky.entity.SeckillOrder; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillOrderMapper { void insert(SeckillOrder order); SeckillOrder getById(@Param("id") Long id); void updateStatus(@Param("id") Long id, @Param("status") Integer status); } 4. 创建Mapper XML文件 4.1 秒杀参与记录Mapper XML 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 <!-- 文件路径: sky-server/src/main/resources/mapper/SeckillParticipantMapper.xml --> <?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > <mapper namespace="com.sky.mapper.SeckillParticipantMapper"> <insert id="insert" useGeneratedKeys="true" keyProperty="id"> INSERT INTO seckill_participant (activity_id, user_id, quantity, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{quantity}, #{status}, #{createTime}, #{updateTime}) </insert> <select id="getByUserAndActivity" resultType="com.sky.entity.SeckillParticipant"> SELECT * FROM seckill_participant WHERE user_id = #{userId} AND activity_id = #{activityId} </select> <update id="updateStatus"> UPDATE seckill_participant SET status = #{status}, update_time = NOW() WHERE id = #{id} </update> </mapper> 4.2 秒杀订单Mapper XML 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 <!-- 文件路径: sky-server/src/main/resources/mapper/SeckillOrderMapper.xml --> <?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > <mapper namespace="com.sky.mapper.SeckillOrderMapper"> <insert id="insert" useGeneratedKeys="true" keyProperty="id"> INSERT INTO seckill_order (activity_id, user_id, dish_id, quantity, seckill_price, total_amount, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{dishId}, #{quantity}, #{seckillPrice}, #{totalAmount}, #{status}, #{createTime}, #{updateTime}) </insert> <select id="getById" resultType="com.sky.entity.SeckillOrder"> SELECT * FROM seckill_order WHERE id = #{id} </select> <update id="updateStatus"> UPDATE seckill_order SET status = #{status}, update_time = NOW() WHERE id = #{id} </update> </mapper> 5. 创建Lua脚本 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 -- 文件路径: sky-server/src/main/resources/seckill_participate.lua -- 秒杀参与Lua脚本 -- KEYS[1] = seckill:stock:{activityId} -- KEYS[2] = seckill:participants:{activityId} -- ARGV[1] = userId -- ARGV[2] = quantity -- ARGV[3] = perUserLimit -- 检查用户是否已参与 local isParticipated = redis.call(&#39;SISMEMBER&#39;, KEYS[2], ARGV[1]) if isParticipated == 1 then return {0, &#39;用户已参与该活动&#39;} end -- 检查库存是否充足 local stock = redis.call(&#39;GET&#39;, KEYS[1]) if not stock then return {0, &#39;活动不存在&#39;} end stock = tonumber(stock) local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) if stock < quantity then return {0, &#39;库存不足&#39;} end if quantity > perUserLimit then return {0, &#39;超过限购数量&#39;} end -- 扣减库存 local newStock = redis.call(&#39;DECRBY&#39;, KEYS[1], quantity) if newStock < 0 then -- 回滚库存 redis.call(&#39;INCRBY&#39;, KEYS[1], quantity) return {0, &#39;库存不足&#39;} end -- 记录用户参与 redis.call(&#39;SADD&#39;, KEYS[2], ARGV[1]) -- 设置过期时间（活动结束后清理） redis.call(&#39;EXPIRE&#39;, KEYS[2], 86400) return {1, &#39;参与成功&#39;, newStock} 6. 增强SeckillActivityService 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 // 在 SeckillActivityServiceImpl.java 中添加以下方法 @Autowired private RedisTemplate redisTemplate; @Autowired private RedissonClient redissonClient; @Autowired private SeckillParticipantMapper seckillParticipantMapper; @Autowired private SeckillOrderMapper seckillOrderMapper; @Value("${sky.redis.seckill.prefix:seckill:}") private String seckillPrefix; /** * 参与秒杀活动 */ @Override public String participateSeckill(Long activityId, Long userId, Integer quantity) { // 1. 获取活动信息 SeckillActivity activity = getById(activityId); if (activity == null) { return "活动不存在"; } // 2. 检查活动状态 if (activity.getStatus() != 1) { return "活动已禁用"; } LocalDateTime now = LocalDateTime.now(); if (now.isBefore(activity.getStartTime())) { return "活动未开始"; } if (now.isAfter(activity.getEndTime())) { return "活动已结束"; } // 3. 使用分布式锁防止重复参与 String lockKey = seckillPrefix + "lock:" + activityId; RLock lock = redissonClient.getLock(lockKey); try { if (lock.tryLock(10, 30, TimeUnit.SECONDS)) { // 4. 执行Lua脚本 String stockKey = seckillPrefix + "stock:" + activityId; String participantsKey = seckillPrefix + "participants:" + activityId; DefaultRedisScript<List> script = new DefaultRedisScript<>(); script.setScriptSource(new ResourceScriptSource(new ClassPathResource("seckill_participate.lua"))); script.setResultType(List.class); List<String> keys = Arrays.asList(stockKey, participantsKey); List<Object> args = Arrays.asList(userId.toString(), quantity.toString(), activity.getPerUserLimit().toString()); List result = redisTemplate.execute(script, keys, args.toArray()); if (result != null && result.size() > 0) { Integer success = (Integer) result.get(0); if (success == 1) { // 5. 记录参与记录 SeckillParticipant participant = SeckillParticipant.builder() .activityId(activityId) .userId(userId) .quantity(quantity) .status(1) .createTime(now) .updateTime(now) .build(); seckillParticipantMapper.insert(participant); // 6. 异步处理订单 processSeckillOrderAsync(activity, userId, quantity); return "参与成功"; } else { return (String) result.get(1); } } return "参与失败"; } else { return "系统繁忙，请稍后重试"; } } catch (Exception e) { log.error("参与秒杀活动异常", e); return "参与失败，请重试"; } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } /** * 异步处理秒杀订单 */ @Async public void processSeckillOrderAsync(SeckillActivity activity, Long userId, Integer quantity) { try { // 创建秒杀订单 SeckillOrder order = SeckillOrder.builder() .activityId(activity.getId()) .userId(userId) .dishId(activity.getDishId()) .quantity(quantity) .seckillPrice(activity.getSeckillPrice()) .totalAmount(activity.getSeckillPrice().multiply(new BigDecimal(quantity))) .status(0) .createTime(LocalDateTime.now()) .updateTime(LocalDateTime.now()) .build(); seckillOrderMapper.insert(order); // 更新数据库库存 updateDatabaseStock(activity.getId(), quantity); log.info("秒杀订单创建成功：orderId={}, userId={}, activityId={}", order.getId(), userId, activity.getId()); } catch (Exception e) { log.error("处理秒杀订单异常", e); } } /** * 更新数据库库存 */ @Async public void updateDatabaseStock(Long activityId, Integer quantity) { try { seckillActivityMapper.reduceStock(activityId, quantity); seckillActivityMapper.increaseSoldCount(activityId, quantity); } catch (Exception e) { log.error("更新数据库库存异常", e); } } 7. 创建用户端控制器 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // 文件路径: sky-server/src/main/java/com/sky/controller/user/SeckillActivityController.java package com.sky.controller.user; import com.sky.entity.SeckillActivity; import com.sky.result.Result; import com.sky.service.SeckillActivityService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.util.List; @RestController @RequestMapping("/user/seckill/activity") @Api(tags = "用户端秒杀活动") @Slf4j public class SeckillActivityController { @Autowired private SeckillActivityService seckillActivityService; @GetMapping("/current") @ApiOperation("获取当前进行中的秒杀活动") public Result<List<SeckillActivity>> getCurrentActivities() { log.info("获取当前进行中的秒杀活动"); List<SeckillActivity> activities = seckillActivityService.getCurrentActivities(); return Result.success(activities); } @GetMapping("/{id}") @ApiOperation("根据id查询秒杀活动详情") public Result<SeckillActivity> getById(@PathVariable Long id) { log.info("根据id查询秒杀活动详情：{}", id); SeckillActivity seckillActivity = seckillActivityService.getById(id); return Result.success(seckillActivity); } @PostMapping("/participate/{id}") @ApiOperation("参与秒杀活动") public Result<String> participateSeckill(@PathVariable Long id, @RequestParam Integer quantity) { log.info("用户参与秒杀活动：id={}, quantity={}", id, quantity); // 这里需要从JWT中获取用户ID，暂时使用固定值 Long userId = 1L; // 实际项目中从JWT中获取 String result = seckillActivityService.participateSeckill(id, userId, quantity); return Result.success(result); } } 总结 第一部分涵盖了秒杀活动功能的核心后端实现，包括：\n'><title></title><link rel=canonical href=https://Yin123-ybh.github.io/p/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content><meta property='og:description' content='秒杀活动功能完善指南 - 第一部分 目录 项目概述 数据库设计 后端核心功能实现 项目概述 功能目标 实现高并发的秒杀活动系统 防止超卖和重复参与 支持分布式部署 提供用户友好的界面 技术栈 后端: Spring Boot + MyBatis + Redis + Redisson 前端: Vue.js + Element UI 数据库: MySQL 缓存: Redis 分布式锁: Redisson 数据库设计 1. 秒杀参与记录表 1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE seckill_participant ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, quantity INT NOT NULL COMMENT &#39;参与数量&#39;, status TINYINT(1) DEFAULT 0 COMMENT &#39;状态：0-待处理，1-成功，2-失败&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;, PRIMARY KEY (id), UNIQUE KEY uk_user_activity (user_id, activity_id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;秒杀参与记录表&#39;; 2. 秒杀订单表 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 CREATE TABLE seckill_order ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, dish_id BIGINT NOT NULL COMMENT &#39;商品ID&#39;, quantity INT NOT NULL COMMENT &#39;购买数量&#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT &#39;秒杀价格&#39;, total_amount DECIMAL(10,2) NOT NULL COMMENT &#39;总金额&#39;, status TINYINT(1) DEFAULT 0 COMMENT &#39;订单状态：0-待支付，1-已支付，2-已取消&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;, PRIMARY KEY (id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;秒杀订单表&#39;; 3. 库存扣减记录表 1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE seckill_stock_log ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, quantity INT NOT NULL COMMENT &#39;扣减数量&#39;, before_stock INT NOT NULL COMMENT &#39;扣减前库存&#39;, after_stock INT NOT NULL COMMENT &#39;扣减后库存&#39;, status TINYINT(1) DEFAULT 1 COMMENT &#39;状态：1-成功，0-失败&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, PRIMARY KEY (id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;库存扣减记录表&#39;; 后端核心功能实现 1. 创建实体类 1.1 秒杀参与记录实体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillParticipant.java package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillParticipant implements Serializable { private static final long serialVersionUID = 1L; private Long id; private Long activityId; private Long userId; private Integer quantity; private Integer status; private LocalDateTime createTime; private LocalDateTime updateTime; } 1.2 秒杀订单实体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillOrder.java package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.math.BigDecimal; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillOrder implements Serializable { private static final long serialVersionUID = 1L; private Long id; private Long activityId; private Long userId; private Long dishId; private Integer quantity; private BigDecimal seckillPrice; private BigDecimal totalAmount; private Integer status; private LocalDateTime createTime; private LocalDateTime updateTime; } 2. 创建DTO类 2.1 秒杀参与DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // 文件路径: sky-pojo/src/main/java/com/sky/dto/SeckillParticipateDTO.java package com.sky.dto; import lombok.Data; import java.io.Serializable; @Data public class SeckillParticipateDTO implements Serializable { private static final long serialVersionUID = 1L; private Long activityId; private Long userId; private Integer quantity; } 3. 创建Mapper接口 3.1 秒杀参与记录Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillParticipantMapper.java package com.sky.mapper; import com.sky.entity.SeckillParticipant; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillParticipantMapper { void insert(SeckillParticipant participant); SeckillParticipant getByUserAndActivity(@Param("userId") Long userId, @Param("activityId") Long activityId); void updateStatus(@Param("id") Long id, @Param("status") Integer status); } 3.2 秒杀订单Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillOrderMapper.java package com.sky.mapper; import com.sky.entity.SeckillOrder; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillOrderMapper { void insert(SeckillOrder order); SeckillOrder getById(@Param("id") Long id); void updateStatus(@Param("id") Long id, @Param("status") Integer status); } 4. 创建Mapper XML文件 4.1 秒杀参与记录Mapper XML 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 <!-- 文件路径: sky-server/src/main/resources/mapper/SeckillParticipantMapper.xml --> <?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > <mapper namespace="com.sky.mapper.SeckillParticipantMapper"> <insert id="insert" useGeneratedKeys="true" keyProperty="id"> INSERT INTO seckill_participant (activity_id, user_id, quantity, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{quantity}, #{status}, #{createTime}, #{updateTime}) </insert> <select id="getByUserAndActivity" resultType="com.sky.entity.SeckillParticipant"> SELECT * FROM seckill_participant WHERE user_id = #{userId} AND activity_id = #{activityId} </select> <update id="updateStatus"> UPDATE seckill_participant SET status = #{status}, update_time = NOW() WHERE id = #{id} </update> </mapper> 4.2 秒杀订单Mapper XML 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 <!-- 文件路径: sky-server/src/main/resources/mapper/SeckillOrderMapper.xml --> <?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > <mapper namespace="com.sky.mapper.SeckillOrderMapper"> <insert id="insert" useGeneratedKeys="true" keyProperty="id"> INSERT INTO seckill_order (activity_id, user_id, dish_id, quantity, seckill_price, total_amount, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{dishId}, #{quantity}, #{seckillPrice}, #{totalAmount}, #{status}, #{createTime}, #{updateTime}) </insert> <select id="getById" resultType="com.sky.entity.SeckillOrder"> SELECT * FROM seckill_order WHERE id = #{id} </select> <update id="updateStatus"> UPDATE seckill_order SET status = #{status}, update_time = NOW() WHERE id = #{id} </update> </mapper> 5. 创建Lua脚本 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 -- 文件路径: sky-server/src/main/resources/seckill_participate.lua -- 秒杀参与Lua脚本 -- KEYS[1] = seckill:stock:{activityId} -- KEYS[2] = seckill:participants:{activityId} -- ARGV[1] = userId -- ARGV[2] = quantity -- ARGV[3] = perUserLimit -- 检查用户是否已参与 local isParticipated = redis.call(&#39;SISMEMBER&#39;, KEYS[2], ARGV[1]) if isParticipated == 1 then return {0, &#39;用户已参与该活动&#39;} end -- 检查库存是否充足 local stock = redis.call(&#39;GET&#39;, KEYS[1]) if not stock then return {0, &#39;活动不存在&#39;} end stock = tonumber(stock) local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) if stock < quantity then return {0, &#39;库存不足&#39;} end if quantity > perUserLimit then return {0, &#39;超过限购数量&#39;} end -- 扣减库存 local newStock = redis.call(&#39;DECRBY&#39;, KEYS[1], quantity) if newStock < 0 then -- 回滚库存 redis.call(&#39;INCRBY&#39;, KEYS[1], quantity) return {0, &#39;库存不足&#39;} end -- 记录用户参与 redis.call(&#39;SADD&#39;, KEYS[2], ARGV[1]) -- 设置过期时间（活动结束后清理） redis.call(&#39;EXPIRE&#39;, KEYS[2], 86400) return {1, &#39;参与成功&#39;, newStock} 6. 增强SeckillActivityService 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 // 在 SeckillActivityServiceImpl.java 中添加以下方法 @Autowired private RedisTemplate redisTemplate; @Autowired private RedissonClient redissonClient; @Autowired private SeckillParticipantMapper seckillParticipantMapper; @Autowired private SeckillOrderMapper seckillOrderMapper; @Value("${sky.redis.seckill.prefix:seckill:}") private String seckillPrefix; /** * 参与秒杀活动 */ @Override public String participateSeckill(Long activityId, Long userId, Integer quantity) { // 1. 获取活动信息 SeckillActivity activity = getById(activityId); if (activity == null) { return "活动不存在"; } // 2. 检查活动状态 if (activity.getStatus() != 1) { return "活动已禁用"; } LocalDateTime now = LocalDateTime.now(); if (now.isBefore(activity.getStartTime())) { return "活动未开始"; } if (now.isAfter(activity.getEndTime())) { return "活动已结束"; } // 3. 使用分布式锁防止重复参与 String lockKey = seckillPrefix + "lock:" + activityId; RLock lock = redissonClient.getLock(lockKey); try { if (lock.tryLock(10, 30, TimeUnit.SECONDS)) { // 4. 执行Lua脚本 String stockKey = seckillPrefix + "stock:" + activityId; String participantsKey = seckillPrefix + "participants:" + activityId; DefaultRedisScript<List> script = new DefaultRedisScript<>(); script.setScriptSource(new ResourceScriptSource(new ClassPathResource("seckill_participate.lua"))); script.setResultType(List.class); List<String> keys = Arrays.asList(stockKey, participantsKey); List<Object> args = Arrays.asList(userId.toString(), quantity.toString(), activity.getPerUserLimit().toString()); List result = redisTemplate.execute(script, keys, args.toArray()); if (result != null && result.size() > 0) { Integer success = (Integer) result.get(0); if (success == 1) { // 5. 记录参与记录 SeckillParticipant participant = SeckillParticipant.builder() .activityId(activityId) .userId(userId) .quantity(quantity) .status(1) .createTime(now) .updateTime(now) .build(); seckillParticipantMapper.insert(participant); // 6. 异步处理订单 processSeckillOrderAsync(activity, userId, quantity); return "参与成功"; } else { return (String) result.get(1); } } return "参与失败"; } else { return "系统繁忙，请稍后重试"; } } catch (Exception e) { log.error("参与秒杀活动异常", e); return "参与失败，请重试"; } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } /** * 异步处理秒杀订单 */ @Async public void processSeckillOrderAsync(SeckillActivity activity, Long userId, Integer quantity) { try { // 创建秒杀订单 SeckillOrder order = SeckillOrder.builder() .activityId(activity.getId()) .userId(userId) .dishId(activity.getDishId()) .quantity(quantity) .seckillPrice(activity.getSeckillPrice()) .totalAmount(activity.getSeckillPrice().multiply(new BigDecimal(quantity))) .status(0) .createTime(LocalDateTime.now()) .updateTime(LocalDateTime.now()) .build(); seckillOrderMapper.insert(order); // 更新数据库库存 updateDatabaseStock(activity.getId(), quantity); log.info("秒杀订单创建成功：orderId={}, userId={}, activityId={}", order.getId(), userId, activity.getId()); } catch (Exception e) { log.error("处理秒杀订单异常", e); } } /** * 更新数据库库存 */ @Async public void updateDatabaseStock(Long activityId, Integer quantity) { try { seckillActivityMapper.reduceStock(activityId, quantity); seckillActivityMapper.increaseSoldCount(activityId, quantity); } catch (Exception e) { log.error("更新数据库库存异常", e); } } 7. 创建用户端控制器 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // 文件路径: sky-server/src/main/java/com/sky/controller/user/SeckillActivityController.java package com.sky.controller.user; import com.sky.entity.SeckillActivity; import com.sky.result.Result; import com.sky.service.SeckillActivityService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.util.List; @RestController @RequestMapping("/user/seckill/activity") @Api(tags = "用户端秒杀活动") @Slf4j public class SeckillActivityController { @Autowired private SeckillActivityService seckillActivityService; @GetMapping("/current") @ApiOperation("获取当前进行中的秒杀活动") public Result<List<SeckillActivity>> getCurrentActivities() { log.info("获取当前进行中的秒杀活动"); List<SeckillActivity> activities = seckillActivityService.getCurrentActivities(); return Result.success(activities); } @GetMapping("/{id}") @ApiOperation("根据id查询秒杀活动详情") public Result<SeckillActivity> getById(@PathVariable Long id) { log.info("根据id查询秒杀活动详情：{}", id); SeckillActivity seckillActivity = seckillActivityService.getById(id); return Result.success(seckillActivity); } @PostMapping("/participate/{id}") @ApiOperation("参与秒杀活动") public Result<String> participateSeckill(@PathVariable Long id, @RequestParam Integer quantity) { log.info("用户参与秒杀活动：id={}, quantity={}", id, quantity); // 这里需要从JWT中获取用户ID，暂时使用固定值 Long userId = 1L; // 实际项目中从JWT中获取 String result = seckillActivityService.participateSeckill(id, userId, quantity); return Result.success(result); } } 总结 第一部分涵盖了秒杀活动功能的核心后端实现，包括：\n'><meta property='og:url' content='https://Yin123-ybh.github.io/p/'><meta property='og:site_name' content='Cecilia-塞西莉娅'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta name=twitter:title content><meta name=twitter:description content='秒杀活动功能完善指南 - 第一部分 目录 项目概述 数据库设计 后端核心功能实现 项目概述 功能目标 实现高并发的秒杀活动系统 防止超卖和重复参与 支持分布式部署 提供用户友好的界面 技术栈 后端: Spring Boot + MyBatis + Redis + Redisson 前端: Vue.js + Element UI 数据库: MySQL 缓存: Redis 分布式锁: Redisson 数据库设计 1. 秒杀参与记录表 1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE seckill_participant ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, quantity INT NOT NULL COMMENT &#39;参与数量&#39;, status TINYINT(1) DEFAULT 0 COMMENT &#39;状态：0-待处理，1-成功，2-失败&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;, PRIMARY KEY (id), UNIQUE KEY uk_user_activity (user_id, activity_id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;秒杀参与记录表&#39;; 2. 秒杀订单表 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 CREATE TABLE seckill_order ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, dish_id BIGINT NOT NULL COMMENT &#39;商品ID&#39;, quantity INT NOT NULL COMMENT &#39;购买数量&#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT &#39;秒杀价格&#39;, total_amount DECIMAL(10,2) NOT NULL COMMENT &#39;总金额&#39;, status TINYINT(1) DEFAULT 0 COMMENT &#39;订单状态：0-待支付，1-已支付，2-已取消&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;, PRIMARY KEY (id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;秒杀订单表&#39;; 3. 库存扣减记录表 1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE seckill_stock_log ( id BIGINT AUTO_INCREMENT COMMENT &#39;主键ID&#39;, activity_id BIGINT NOT NULL COMMENT &#39;秒杀活动ID&#39;, user_id BIGINT NOT NULL COMMENT &#39;用户ID&#39;, quantity INT NOT NULL COMMENT &#39;扣减数量&#39;, before_stock INT NOT NULL COMMENT &#39;扣减前库存&#39;, after_stock INT NOT NULL COMMENT &#39;扣减后库存&#39;, status TINYINT(1) DEFAULT 1 COMMENT &#39;状态：1-成功，0-失败&#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, PRIMARY KEY (id), KEY idx_activity_id (activity_id), KEY idx_user_id (user_id) ) COMMENT=&#39;库存扣减记录表&#39;; 后端核心功能实现 1. 创建实体类 1.1 秒杀参与记录实体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillParticipant.java package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillParticipant implements Serializable { private static final long serialVersionUID = 1L; private Long id; private Long activityId; private Long userId; private Integer quantity; private Integer status; private LocalDateTime createTime; private LocalDateTime updateTime; } 1.2 秒杀订单实体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillOrder.java package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.math.BigDecimal; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillOrder implements Serializable { private static final long serialVersionUID = 1L; private Long id; private Long activityId; private Long userId; private Long dishId; private Integer quantity; private BigDecimal seckillPrice; private BigDecimal totalAmount; private Integer status; private LocalDateTime createTime; private LocalDateTime updateTime; } 2. 创建DTO类 2.1 秒杀参与DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // 文件路径: sky-pojo/src/main/java/com/sky/dto/SeckillParticipateDTO.java package com.sky.dto; import lombok.Data; import java.io.Serializable; @Data public class SeckillParticipateDTO implements Serializable { private static final long serialVersionUID = 1L; private Long activityId; private Long userId; private Integer quantity; } 3. 创建Mapper接口 3.1 秒杀参与记录Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillParticipantMapper.java package com.sky.mapper; import com.sky.entity.SeckillParticipant; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillParticipantMapper { void insert(SeckillParticipant participant); SeckillParticipant getByUserAndActivity(@Param("userId") Long userId, @Param("activityId") Long activityId); void updateStatus(@Param("id") Long id, @Param("status") Integer status); } 3.2 秒杀订单Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillOrderMapper.java package com.sky.mapper; import com.sky.entity.SeckillOrder; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillOrderMapper { void insert(SeckillOrder order); SeckillOrder getById(@Param("id") Long id); void updateStatus(@Param("id") Long id, @Param("status") Integer status); } 4. 创建Mapper XML文件 4.1 秒杀参与记录Mapper XML 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 <!-- 文件路径: sky-server/src/main/resources/mapper/SeckillParticipantMapper.xml --> <?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > <mapper namespace="com.sky.mapper.SeckillParticipantMapper"> <insert id="insert" useGeneratedKeys="true" keyProperty="id"> INSERT INTO seckill_participant (activity_id, user_id, quantity, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{quantity}, #{status}, #{createTime}, #{updateTime}) </insert> <select id="getByUserAndActivity" resultType="com.sky.entity.SeckillParticipant"> SELECT * FROM seckill_participant WHERE user_id = #{userId} AND activity_id = #{activityId} </select> <update id="updateStatus"> UPDATE seckill_participant SET status = #{status}, update_time = NOW() WHERE id = #{id} </update> </mapper> 4.2 秒杀订单Mapper XML 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 <!-- 文件路径: sky-server/src/main/resources/mapper/SeckillOrderMapper.xml --> <?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > <mapper namespace="com.sky.mapper.SeckillOrderMapper"> <insert id="insert" useGeneratedKeys="true" keyProperty="id"> INSERT INTO seckill_order (activity_id, user_id, dish_id, quantity, seckill_price, total_amount, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{dishId}, #{quantity}, #{seckillPrice}, #{totalAmount}, #{status}, #{createTime}, #{updateTime}) </insert> <select id="getById" resultType="com.sky.entity.SeckillOrder"> SELECT * FROM seckill_order WHERE id = #{id} </select> <update id="updateStatus"> UPDATE seckill_order SET status = #{status}, update_time = NOW() WHERE id = #{id} </update> </mapper> 5. 创建Lua脚本 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 -- 文件路径: sky-server/src/main/resources/seckill_participate.lua -- 秒杀参与Lua脚本 -- KEYS[1] = seckill:stock:{activityId} -- KEYS[2] = seckill:participants:{activityId} -- ARGV[1] = userId -- ARGV[2] = quantity -- ARGV[3] = perUserLimit -- 检查用户是否已参与 local isParticipated = redis.call(&#39;SISMEMBER&#39;, KEYS[2], ARGV[1]) if isParticipated == 1 then return {0, &#39;用户已参与该活动&#39;} end -- 检查库存是否充足 local stock = redis.call(&#39;GET&#39;, KEYS[1]) if not stock then return {0, &#39;活动不存在&#39;} end stock = tonumber(stock) local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) if stock < quantity then return {0, &#39;库存不足&#39;} end if quantity > perUserLimit then return {0, &#39;超过限购数量&#39;} end -- 扣减库存 local newStock = redis.call(&#39;DECRBY&#39;, KEYS[1], quantity) if newStock < 0 then -- 回滚库存 redis.call(&#39;INCRBY&#39;, KEYS[1], quantity) return {0, &#39;库存不足&#39;} end -- 记录用户参与 redis.call(&#39;SADD&#39;, KEYS[2], ARGV[1]) -- 设置过期时间（活动结束后清理） redis.call(&#39;EXPIRE&#39;, KEYS[2], 86400) return {1, &#39;参与成功&#39;, newStock} 6. 增强SeckillActivityService 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 // 在 SeckillActivityServiceImpl.java 中添加以下方法 @Autowired private RedisTemplate redisTemplate; @Autowired private RedissonClient redissonClient; @Autowired private SeckillParticipantMapper seckillParticipantMapper; @Autowired private SeckillOrderMapper seckillOrderMapper; @Value("${sky.redis.seckill.prefix:seckill:}") private String seckillPrefix; /** * 参与秒杀活动 */ @Override public String participateSeckill(Long activityId, Long userId, Integer quantity) { // 1. 获取活动信息 SeckillActivity activity = getById(activityId); if (activity == null) { return "活动不存在"; } // 2. 检查活动状态 if (activity.getStatus() != 1) { return "活动已禁用"; } LocalDateTime now = LocalDateTime.now(); if (now.isBefore(activity.getStartTime())) { return "活动未开始"; } if (now.isAfter(activity.getEndTime())) { return "活动已结束"; } // 3. 使用分布式锁防止重复参与 String lockKey = seckillPrefix + "lock:" + activityId; RLock lock = redissonClient.getLock(lockKey); try { if (lock.tryLock(10, 30, TimeUnit.SECONDS)) { // 4. 执行Lua脚本 String stockKey = seckillPrefix + "stock:" + activityId; String participantsKey = seckillPrefix + "participants:" + activityId; DefaultRedisScript<List> script = new DefaultRedisScript<>(); script.setScriptSource(new ResourceScriptSource(new ClassPathResource("seckill_participate.lua"))); script.setResultType(List.class); List<String> keys = Arrays.asList(stockKey, participantsKey); List<Object> args = Arrays.asList(userId.toString(), quantity.toString(), activity.getPerUserLimit().toString()); List result = redisTemplate.execute(script, keys, args.toArray()); if (result != null && result.size() > 0) { Integer success = (Integer) result.get(0); if (success == 1) { // 5. 记录参与记录 SeckillParticipant participant = SeckillParticipant.builder() .activityId(activityId) .userId(userId) .quantity(quantity) .status(1) .createTime(now) .updateTime(now) .build(); seckillParticipantMapper.insert(participant); // 6. 异步处理订单 processSeckillOrderAsync(activity, userId, quantity); return "参与成功"; } else { return (String) result.get(1); } } return "参与失败"; } else { return "系统繁忙，请稍后重试"; } } catch (Exception e) { log.error("参与秒杀活动异常", e); return "参与失败，请重试"; } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } /** * 异步处理秒杀订单 */ @Async public void processSeckillOrderAsync(SeckillActivity activity, Long userId, Integer quantity) { try { // 创建秒杀订单 SeckillOrder order = SeckillOrder.builder() .activityId(activity.getId()) .userId(userId) .dishId(activity.getDishId()) .quantity(quantity) .seckillPrice(activity.getSeckillPrice()) .totalAmount(activity.getSeckillPrice().multiply(new BigDecimal(quantity))) .status(0) .createTime(LocalDateTime.now()) .updateTime(LocalDateTime.now()) .build(); seckillOrderMapper.insert(order); // 更新数据库库存 updateDatabaseStock(activity.getId(), quantity); log.info("秒杀订单创建成功：orderId={}, userId={}, activityId={}", order.getId(), userId, activity.getId()); } catch (Exception e) { log.error("处理秒杀订单异常", e); } } /** * 更新数据库库存 */ @Async public void updateDatabaseStock(Long activityId, Integer quantity) { try { seckillActivityMapper.reduceStock(activityId, quantity); seckillActivityMapper.increaseSoldCount(activityId, quantity); } catch (Exception e) { log.error("更新数据库库存异常", e); } } 7. 创建用户端控制器 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // 文件路径: sky-server/src/main/java/com/sky/controller/user/SeckillActivityController.java package com.sky.controller.user; import com.sky.entity.SeckillActivity; import com.sky.result.Result; import com.sky.service.SeckillActivityService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.util.List; @RestController @RequestMapping("/user/seckill/activity") @Api(tags = "用户端秒杀活动") @Slf4j public class SeckillActivityController { @Autowired private SeckillActivityService seckillActivityService; @GetMapping("/current") @ApiOperation("获取当前进行中的秒杀活动") public Result<List<SeckillActivity>> getCurrentActivities() { log.info("获取当前进行中的秒杀活动"); List<SeckillActivity> activities = seckillActivityService.getCurrentActivities(); return Result.success(activities); } @GetMapping("/{id}") @ApiOperation("根据id查询秒杀活动详情") public Result<SeckillActivity> getById(@PathVariable Long id) { log.info("根据id查询秒杀活动详情：{}", id); SeckillActivity seckillActivity = seckillActivityService.getById(id); return Result.success(seckillActivity); } @PostMapping("/participate/{id}") @ApiOperation("参与秒杀活动") public Result<String> participateSeckill(@PathVariable Long id, @RequestParam Integer quantity) { log.info("用户参与秒杀活动：id={}, quantity={}", id, quantity); // 这里需要从JWT中获取用户ID，暂时使用固定值 Long userId = 1L; // 实际项目中从JWT中获取 String result = seckillActivityService.participateSeckill(id, userId, quantity); return Result.success(result); } } 总结 第一部分涵盖了秒杀活动功能的核心后端实现，包括：\n'><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_8636e4c1b17bd1a4.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🧑‍💻</span></figure><div class=site-meta><h1 class=site-name><a href=/>Cecilia-塞西莉娅</a></h1><h2 class=site-description>Welcome to my website</h2></div></header><ol class=menu-social><li><a href=https://github.com/Yin123-ybh target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://Yin123-ybh.github.io/ selected>English</option><option value=https://Yin123-ybh.github.io/zh-cn/>简体中文</option><option value=https://Yin123-ybh.github.io/ar/>عربي</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#目录>目录</a></li><li><a href=#项目概述>项目概述</a><ol><li><a href=#功能目标>功能目标</a></li><li><a href=#技术栈>技术栈</a></li></ol></li><li><a href=#数据库设计>数据库设计</a><ol><li><a href=#1-秒杀参与记录表>1. 秒杀参与记录表</a></li><li><a href=#2-秒杀订单表>2. 秒杀订单表</a></li><li><a href=#3-库存扣减记录表>3. 库存扣减记录表</a></li></ol></li><li><a href=#后端核心功能实现>后端核心功能实现</a><ol><li><a href=#1-创建实体类>1. 创建实体类</a><ol><li><a href=#11-秒杀参与记录实体>1.1 秒杀参与记录实体</a></li><li><a href=#12-秒杀订单实体>1.2 秒杀订单实体</a></li></ol></li><li><a href=#2-创建dto类>2. 创建DTO类</a><ol><li><a href=#21-秒杀参与dto>2.1 秒杀参与DTO</a></li></ol></li><li><a href=#3-创建mapper接口>3. 创建Mapper接口</a><ol><li><a href=#31-秒杀参与记录mapper>3.1 秒杀参与记录Mapper</a></li><li><a href=#32-秒杀订单mapper>3.2 秒杀订单Mapper</a></li></ol></li><li><a href=#4-创建mapper-xml文件>4. 创建Mapper XML文件</a><ol><li><a href=#41-秒杀参与记录mapper-xml>4.1 秒杀参与记录Mapper XML</a></li><li><a href=#42-秒杀订单mapper-xml>4.2 秒杀订单Mapper XML</a></li></ol></li><li><a href=#5-创建lua脚本>5. 创建Lua脚本</a></li><li><a href=#6-增强seckillactivityservice>6. 增强SeckillActivityService</a></li><li><a href=#7-创建用户端控制器>7. 创建用户端控制器</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/></a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><h1 id=秒杀活动功能完善指南---第一部分>秒杀活动功能完善指南 - 第一部分</h1><h2 id=目录>目录</h2><ol><li><a class=link href=#%e9%a1%b9%e7%9b%ae%e6%a6%82%e8%bf%b0>项目概述</a></li><li><a class=link href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e8%ae%be%e8%ae%a1>数据库设计</a></li><li><a class=link href=#%e5%90%8e%e7%ab%af%e6%a0%b8%e5%bf%83%e5%8a%9f%e8%83%bd%e5%ae%9e%e7%8e%b0>后端核心功能实现</a></li></ol><hr><h2 id=项目概述>项目概述</h2><h3 id=功能目标>功能目标</h3><ul><li>实现高并发的秒杀活动系统</li><li>防止超卖和重复参与</li><li>支持分布式部署</li><li>提供用户友好的界面</li></ul><h3 id=技术栈>技术栈</h3><ul><li><strong>后端</strong>: Spring Boot + MyBatis + Redis + Redisson</li><li><strong>前端</strong>: Vue.js + Element UI</li><li><strong>数据库</strong>: MySQL</li><li><strong>缓存</strong>: Redis</li><li><strong>分布式锁</strong>: Redisson</li></ul><hr><h2 id=数据库设计>数据库设计</h2><h3 id=1-秒杀参与记录表>1. 秒杀参与记录表</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>seckill_participant</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=n>AUTO_INCREMENT</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;主键ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>activity_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;秒杀活动ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>user_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;用户ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>quantity</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;参与数量&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>status</span><span class=w> </span><span class=n>TINYINT</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;状态：0-待处理，1-成功，2-失败&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>create_time</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;创建时间&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>update_time</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;更新时间&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>uk_user_activity</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>activity_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>KEY</span><span class=w> </span><span class=n>idx_activity_id</span><span class=w> </span><span class=p>(</span><span class=n>activity_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>KEY</span><span class=w> </span><span class=n>idx_user_id</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>COMMENT</span><span class=o>=</span><span class=s1>&#39;秒杀参与记录表&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-秒杀订单表>2. 秒杀订单表</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>seckill_order</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=n>AUTO_INCREMENT</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;主键ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>activity_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;秒杀活动ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>user_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;用户ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dish_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;商品ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>quantity</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;购买数量&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>seckill_price</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;秒杀价格&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>total_amount</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;总金额&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>status</span><span class=w> </span><span class=n>TINYINT</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;订单状态：0-待支付，1-已支付，2-已取消&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>create_time</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;创建时间&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>update_time</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;更新时间&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>KEY</span><span class=w> </span><span class=n>idx_activity_id</span><span class=w> </span><span class=p>(</span><span class=n>activity_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>KEY</span><span class=w> </span><span class=n>idx_user_id</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>COMMENT</span><span class=o>=</span><span class=s1>&#39;秒杀订单表&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-库存扣减记录表>3. 库存扣减记录表</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>seckill_stock_log</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=n>AUTO_INCREMENT</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;主键ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>activity_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;秒杀活动ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>user_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;用户ID&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>quantity</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;扣减数量&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>before_stock</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;扣减前库存&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>after_stock</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;扣减后库存&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>status</span><span class=w> </span><span class=n>TINYINT</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;状态：1-成功，0-失败&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>create_time</span><span class=w> </span><span class=n>DATETIME</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>COMMENT</span><span class=w> </span><span class=s1>&#39;创建时间&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>KEY</span><span class=w> </span><span class=n>idx_activity_id</span><span class=w> </span><span class=p>(</span><span class=n>activity_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>KEY</span><span class=w> </span><span class=n>idx_user_id</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>COMMENT</span><span class=o>=</span><span class=s1>&#39;库存扣减记录表&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=后端核心功能实现>后端核心功能实现</h2><h3 id=1-创建实体类>1. 创建实体类</h3><h4 id=11-秒杀参与记录实体>1.1 秒杀参与记录实体</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillParticipant.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AllArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Builder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeckillParticipant</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>createTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>updateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=12-秒杀订单实体>1.2 秒杀订单实体</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillOrder.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.AllArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Builder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.math.BigDecimal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeckillOrder</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>dishId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>seckillPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>totalAmount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>createTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>updateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-创建dto类>2. 创建DTO类</h3><h4 id=21-秒杀参与dto>2.1 秒杀参与DTO</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 文件路径: sky-pojo/src/main/java/com/sky/dto/SeckillParticipateDTO.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.dto</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeckillParticipateDTO</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-创建mapper接口>3. 创建Mapper接口</h3><h4 id=31-秒杀参与记录mapper>3.1 秒杀参与记录Mapper</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillParticipantMapper.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.entity.SeckillParticipant</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.ibatis.annotations.Mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.ibatis.annotations.Param</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Mapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>SeckillParticipantMapper</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>insert</span><span class=p>(</span><span class=n>SeckillParticipant</span><span class=w> </span><span class=n>participant</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SeckillParticipant</span><span class=w> </span><span class=nf>getByUserAndActivity</span><span class=p>(</span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                           </span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;activityId&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>updateStatus</span><span class=p>(</span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;status&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=32-秒杀订单mapper>3.2 秒杀订单Mapper</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillOrderMapper.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.entity.SeckillOrder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.ibatis.annotations.Mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.ibatis.annotations.Param</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Mapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>SeckillOrderMapper</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>insert</span><span class=p>(</span><span class=n>SeckillOrder</span><span class=w> </span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SeckillOrder</span><span class=w> </span><span class=nf>getById</span><span class=p>(</span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>updateStatus</span><span class=p>(</span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nd>@Param</span><span class=p>(</span><span class=s>&#34;status&#34;</span><span class=p>)</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=4-创建mapper-xml文件>4. 创建Mapper XML文件</h3><h4 id=41-秒杀参与记录mapper-xml>4.1 秒杀参与记录Mapper XML</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- 文件路径: sky-server/src/main/resources/mapper/SeckillParticipantMapper.xml --&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE mapper PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span></span></span><span class=line><span class=cl><span class=cp>        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34; &gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;mapper</span> <span class=na>namespace=</span><span class=s>&#34;com.sky.mapper.SeckillParticipantMapper&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;insert</span> <span class=na>id=</span><span class=s>&#34;insert&#34;</span> <span class=na>useGeneratedKeys=</span><span class=s>&#34;true&#34;</span> <span class=na>keyProperty=</span><span class=s>&#34;id&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        INSERT INTO seckill_participant 
</span></span><span class=line><span class=cl>        (activity_id, user_id, quantity, status, create_time, update_time)
</span></span><span class=line><span class=cl>        VALUES 
</span></span><span class=line><span class=cl>        (#{activityId}, #{userId}, #{quantity}, #{status}, #{createTime}, #{updateTime})
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/insert&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;select</span> <span class=na>id=</span><span class=s>&#34;getByUserAndActivity&#34;</span> <span class=na>resultType=</span><span class=s>&#34;com.sky.entity.SeckillParticipant&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        SELECT * FROM seckill_participant 
</span></span><span class=line><span class=cl>        WHERE user_id = #{userId} AND activity_id = #{activityId}
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/select&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;update</span> <span class=na>id=</span><span class=s>&#34;updateStatus&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        UPDATE seckill_participant 
</span></span><span class=line><span class=cl>        SET status = #{status}, update_time = NOW() 
</span></span><span class=line><span class=cl>        WHERE id = #{id}
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/update&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/mapper&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=42-秒杀订单mapper-xml>4.2 秒杀订单Mapper XML</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- 文件路径: sky-server/src/main/resources/mapper/SeckillOrderMapper.xml --&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE mapper PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span></span></span><span class=line><span class=cl><span class=cp>        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34; &gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;mapper</span> <span class=na>namespace=</span><span class=s>&#34;com.sky.mapper.SeckillOrderMapper&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;insert</span> <span class=na>id=</span><span class=s>&#34;insert&#34;</span> <span class=na>useGeneratedKeys=</span><span class=s>&#34;true&#34;</span> <span class=na>keyProperty=</span><span class=s>&#34;id&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        INSERT INTO seckill_order 
</span></span><span class=line><span class=cl>        (activity_id, user_id, dish_id, quantity, seckill_price, total_amount, status, create_time, update_time)
</span></span><span class=line><span class=cl>        VALUES 
</span></span><span class=line><span class=cl>        (#{activityId}, #{userId}, #{dishId}, #{quantity}, #{seckillPrice}, #{totalAmount}, #{status}, #{createTime}, #{updateTime})
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/insert&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;select</span> <span class=na>id=</span><span class=s>&#34;getById&#34;</span> <span class=na>resultType=</span><span class=s>&#34;com.sky.entity.SeckillOrder&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        SELECT * FROM seckill_order WHERE id = #{id}
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/select&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;update</span> <span class=na>id=</span><span class=s>&#34;updateStatus&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        UPDATE seckill_order 
</span></span><span class=line><span class=cl>        SET status = #{status}, update_time = NOW() 
</span></span><span class=line><span class=cl>        WHERE id = #{id}
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/update&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/mapper&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=5-创建lua脚本>5. 创建Lua脚本</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- 文件路径: sky-server/src/main/resources/seckill_participate.lua</span>
</span></span><span class=line><span class=cl><span class=c1>-- 秒杀参与Lua脚本</span>
</span></span><span class=line><span class=cl><span class=c1>-- KEYS[1] = seckill:stock:{activityId}</span>
</span></span><span class=line><span class=cl><span class=c1>-- KEYS[2] = seckill:participants:{activityId}</span>
</span></span><span class=line><span class=cl><span class=c1>-- ARGV[1] = userId</span>
</span></span><span class=line><span class=cl><span class=c1>-- ARGV[2] = quantity</span>
</span></span><span class=line><span class=cl><span class=c1>-- ARGV[3] = perUserLimit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 检查用户是否已参与</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>isParticipated</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;SISMEMBER&#39;</span><span class=p>,</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>ARGV</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>isParticipated</span> <span class=o>==</span> <span class=mi>1</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;用户已参与该活动&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 检查库存是否充足</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>stock</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=ow>not</span> <span class=n>stock</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;活动不存在&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>stock</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>quantity</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>perUserLimit</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>stock</span> <span class=o>&lt;</span> <span class=n>quantity</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;库存不足&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>quantity</span> <span class=o>&gt;</span> <span class=n>perUserLimit</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;超过限购数量&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 扣减库存</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>newStock</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;DECRBY&#39;</span><span class=p>,</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>newStock</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=c1>-- 回滚库存</span>
</span></span><span class=line><span class=cl>    <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;INCRBY&#39;</span><span class=p>,</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;库存不足&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 记录用户参与</span>
</span></span><span class=line><span class=cl><span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;SADD&#39;</span><span class=p>,</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>ARGV</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 设置过期时间（活动结束后清理）</span>
</span></span><span class=line><span class=cl><span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;EXPIRE&#39;</span><span class=p>,</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>86400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;参与成功&#39;</span><span class=p>,</span> <span class=n>newStock</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=6-增强seckillactivityservice>6. 增强SeckillActivityService</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 在 SeckillActivityServiceImpl.java 中添加以下方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>RedissonClient</span><span class=w> </span><span class=n>redissonClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>SeckillParticipantMapper</span><span class=w> </span><span class=n>seckillParticipantMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>SeckillOrderMapper</span><span class=w> </span><span class=n>seckillOrderMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${sky.redis.seckill.prefix:seckill:}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>seckillPrefix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 参与秒杀活动
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>participateSeckill</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. 获取活动信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SeckillActivity</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getById</span><span class=p>(</span><span class=n>activityId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;活动不存在&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. 检查活动状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;活动已禁用&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>now</span><span class=p>.</span><span class=na>isBefore</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getStartTime</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;活动未开始&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>now</span><span class=p>.</span><span class=na>isAfter</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getEndTime</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;活动已结束&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3. 使用分布式锁防止重复参与</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillPrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;lock:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redissonClient</span><span class=p>.</span><span class=na>getLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 4. 执行Lua脚本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>stockKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillPrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;stock:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>participantsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillPrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;participants:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>activityId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DefaultRedisScript</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&gt;</span><span class=w> </span><span class=n>script</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>script</span><span class=p>.</span><span class=na>setScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ResourceScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ClassPathResource</span><span class=p>(</span><span class=s>&#34;seckill_participate.lua&#34;</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>script</span><span class=p>.</span><span class=na>setResultType</span><span class=p>(</span><span class=n>List</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>stockKey</span><span class=p>,</span><span class=w> </span><span class=n>participantsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>userId</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>quantity</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getPerUserLimit</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>script</span><span class=p>,</span><span class=w> </span><span class=n>keys</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=na>toArray</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Integer</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>success</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 5. 记录参与记录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SeckillParticipant</span><span class=w> </span><span class=n>participant</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SeckillParticipant</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>activityId</span><span class=p>(</span><span class=n>activityId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>quantity</span><span class=p>(</span><span class=n>quantity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>createTime</span><span class=p>(</span><span class=n>now</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>updateTime</span><span class=p>(</span><span class=n>now</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>seckillParticipantMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>participant</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 6. 异步处理订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>processSeckillOrderAsync</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>quantity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;参与成功&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;参与失败&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;系统繁忙，请稍后重试&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;参与秒杀活动异常&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;参与失败，请重试&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>isHeldByCurrentThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 异步处理秒杀订单
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Async</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processSeckillOrderAsync</span><span class=p>(</span><span class=n>SeckillActivity</span><span class=w> </span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建秒杀订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SeckillOrder</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SeckillOrder</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>activityId</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>dishId</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getDishId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>quantity</span><span class=p>(</span><span class=n>quantity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>seckillPrice</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getSeckillPrice</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>totalAmount</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getSeckillPrice</span><span class=p>().</span><span class=na>multiply</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>BigDecimal</span><span class=p>(</span><span class=n>quantity</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>createTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>updateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>seckillOrderMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 更新数据库库存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateDatabaseStock</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>quantity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;秒杀订单创建成功：orderId={}, userId={}, activityId={}&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>order</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;处理秒杀订单异常&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 更新数据库库存
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Async</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateDatabaseStock</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>activityId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>seckillActivityMapper</span><span class=p>.</span><span class=na>reduceStock</span><span class=p>(</span><span class=n>activityId</span><span class=p>,</span><span class=w> </span><span class=n>quantity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>seckillActivityMapper</span><span class=p>.</span><span class=na>increaseSoldCount</span><span class=p>(</span><span class=n>activityId</span><span class=p>,</span><span class=w> </span><span class=n>quantity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;更新数据库库存异常&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=7-创建用户端控制器>7. 创建用户端控制器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 文件路径: sky-server/src/main/java/com/sky/controller/user/SeckillActivityController.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.controller.user</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.entity.SeckillActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.result.Result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.service.SeckillActivityService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.Api</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.ApiOperation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/user/seckill/activity&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;用户端秒杀活动&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeckillActivityController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>SeckillActivityService</span><span class=w> </span><span class=n>seckillActivityService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/current&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;获取当前进行中的秒杀活动&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>SeckillActivity</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getCurrentActivities</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;获取当前进行中的秒杀活动&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SeckillActivity</span><span class=o>&gt;</span><span class=w> </span><span class=n>activities</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillActivityService</span><span class=p>.</span><span class=na>getCurrentActivities</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>activities</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;根据id查询秒杀活动详情&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>SeckillActivity</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getById</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;根据id查询秒杀活动详情：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SeckillActivity</span><span class=w> </span><span class=n>seckillActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillActivityService</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>seckillActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/participate/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;参与秒杀活动&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>participateSeckill</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                           </span><span class=nd>@RequestParam</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>quantity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;用户参与秒杀活动：id={}, quantity={}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>quantity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这里需要从JWT中获取用户ID，暂时使用固定值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w> </span><span class=c1>// 实际项目中从JWT中获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seckillActivityService</span><span class=p>.</span><span class=na>participateSeckill</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>quantity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=总结>总结</h2><p>第一部分涵盖了秒杀活动功能的核心后端实现，包括：</p><ol><li><strong>数据库设计</strong> - 完整的表结构和索引设计</li><li><strong>实体类创建</strong> - 秒杀参与记录和订单实体</li><li><strong>数据访问层</strong> - Mapper接口和XML配置</li><li><strong>核心业务逻辑</strong> - 分布式锁、Redis缓存、Lua脚本</li><li><strong>API接口</strong> - 用户端控制器</li></ol><p>这些是构建高并发秒杀系统的基础，下一部分将介绍前端界面开发和微信小程序集成。</p><hr><p><em>继续阅读：<a class=link href=./%e7%a7%92%e6%9d%80%e6%b4%bb%e5%8a%a8%e5%8a%9f%e8%83%bd%e5%ae%8c%e5%96%84%e6%8c%87%e5%8d%97-%e7%ac%ac%e4%ba%8c%e9%83%a8%e5%88%86.md>秒杀活动功能完善指南 - 第二部分</a></em></p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 Cecilia-塞西莉娅</section><section class=powerby>Never give up<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>