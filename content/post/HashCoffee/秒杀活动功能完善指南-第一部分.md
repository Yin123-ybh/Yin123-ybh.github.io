---
title: "秒杀活动功能完善指南 - 第一部分"
date: 2025-01-12
draft: false
tags: ["Java", "Spring Boot", "Redis", "高并发", "秒杀系统"]
categories: ["Web开发"]
description: "详细介绍如何从零开始构建一个高并发的秒杀活动系统，包括防超卖、分布式锁、Redis缓存等核心技术实现。"
---

# 秒杀活动功能完善指南 - 第一部分

## 目录
1. [项目概述](#项目概述)
2. [数据库设计](#数据库设计)
3. [后端核心功能实现](#后端核心功能实现)

---

## 项目概述

### 功能目标
- 实现高并发的秒杀活动系统
- 防止超卖和重复参与
- 支持分布式部署
- 提供用户友好的界面

### 技术栈
- **后端**: Spring Boot + MyBatis + Redis + Redisson
- **前端**: Vue.js + Element UI
- **数据库**: MySQL
- **缓存**: Redis
- **分布式锁**: Redisson

---

## 数据库设计

### 1. 秒杀参与记录表

```sql
CREATE TABLE seckill_participant (
    id BIGINT AUTO_INCREMENT COMMENT '主键ID',
    activity_id BIGINT NOT NULL COMMENT '秒杀活动ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    quantity INT NOT NULL COMMENT '参与数量',
    status TINYINT(1) DEFAULT 0 COMMENT '状态：0-待处理，1-成功，2-失败',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_activity (user_id, activity_id),
    KEY idx_activity_id (activity_id),
    KEY idx_user_id (user_id)
) COMMENT='秒杀参与记录表';
```

### 2. 秒杀订单表

```sql
CREATE TABLE seckill_order (
    id BIGINT AUTO_INCREMENT COMMENT '主键ID',
    activity_id BIGINT NOT NULL COMMENT '秒杀活动ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    dish_id BIGINT NOT NULL COMMENT '商品ID',
    quantity INT NOT NULL COMMENT '购买数量',
    seckill_price DECIMAL(10,2) NOT NULL COMMENT '秒杀价格',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '总金额',
    status TINYINT(1) DEFAULT 0 COMMENT '订单状态：0-待支付，1-已支付，2-已取消',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (id),
    KEY idx_activity_id (activity_id),
    KEY idx_user_id (user_id)
) COMMENT='秒杀订单表';
```

### 3. 库存扣减记录表

```sql
CREATE TABLE seckill_stock_log (
    id BIGINT AUTO_INCREMENT COMMENT '主键ID',
    activity_id BIGINT NOT NULL COMMENT '秒杀活动ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    quantity INT NOT NULL COMMENT '扣减数量',
    before_stock INT NOT NULL COMMENT '扣减前库存',
    after_stock INT NOT NULL COMMENT '扣减后库存',
    status TINYINT(1) DEFAULT 1 COMMENT '状态：1-成功，0-失败',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (id),
    KEY idx_activity_id (activity_id),
    KEY idx_user_id (user_id)
) COMMENT='库存扣减记录表';
```

---

## 后端核心功能实现

### 1. 创建实体类

#### 1.1 秒杀参与记录实体

```java
// 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillParticipant.java
package com.sky.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.io.Serializable;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SeckillParticipant implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private Long id;
    private Long activityId;
    private Long userId;
    private Integer quantity;
    private Integer status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

#### 1.2 秒杀订单实体

```java
// 文件路径: sky-pojo/src/main/java/com/sky/entity/SeckillOrder.java
package com.sky.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.io.Serializable;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SeckillOrder implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private Long id;
    private Long activityId;
    private Long userId;
    private Long dishId;
    private Integer quantity;
    private BigDecimal seckillPrice;
    private BigDecimal totalAmount;
    private Integer status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

### 2. 创建DTO类

#### 2.1 秒杀参与DTO

```java
// 文件路径: sky-pojo/src/main/java/com/sky/dto/SeckillParticipateDTO.java
package com.sky.dto;

import lombok.Data;
import java.io.Serializable;

@Data
public class SeckillParticipateDTO implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private Long activityId;
    private Long userId;
    private Integer quantity;
}
```

### 3. 创建Mapper接口

#### 3.1 秒杀参与记录Mapper

```java
// 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillParticipantMapper.java
package com.sky.mapper;

import com.sky.entity.SeckillParticipant;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface SeckillParticipantMapper {
    
    void insert(SeckillParticipant participant);
    
    SeckillParticipant getByUserAndActivity(@Param("userId") Long userId, 
                                           @Param("activityId") Long activityId);
    
    void updateStatus(@Param("id") Long id, @Param("status") Integer status);
}
```

#### 3.2 秒杀订单Mapper

```java
// 文件路径: sky-server/src/main/java/com/sky/mapper/SeckillOrderMapper.java
package com.sky.mapper;

import com.sky.entity.SeckillOrder;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface SeckillOrderMapper {
    
    void insert(SeckillOrder order);
    
    SeckillOrder getById(@Param("id") Long id);
    
    void updateStatus(@Param("id") Long id, @Param("status") Integer status);
}
```

### 4. 创建Mapper XML文件

#### 4.1 秒杀参与记录Mapper XML

```xml
<!-- 文件路径: sky-server/src/main/resources/mapper/SeckillParticipantMapper.xml -->
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.mapper.SeckillParticipantMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO seckill_participant 
        (activity_id, user_id, quantity, status, create_time, update_time)
        VALUES 
        (#{activityId}, #{userId}, #{quantity}, #{status}, #{createTime}, #{updateTime})
    </insert>

    <select id="getByUserAndActivity" resultType="com.sky.entity.SeckillParticipant">
        SELECT * FROM seckill_participant 
        WHERE user_id = #{userId} AND activity_id = #{activityId}
    </select>

    <update id="updateStatus">
        UPDATE seckill_participant 
        SET status = #{status}, update_time = NOW() 
        WHERE id = #{id}
    </update>

</mapper>
```

#### 4.2 秒杀订单Mapper XML

```xml
<!-- 文件路径: sky-server/src/main/resources/mapper/SeckillOrderMapper.xml -->
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.mapper.SeckillOrderMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO seckill_order 
        (activity_id, user_id, dish_id, quantity, seckill_price, total_amount, status, create_time, update_time)
        VALUES 
        (#{activityId}, #{userId}, #{dishId}, #{quantity}, #{seckillPrice}, #{totalAmount}, #{status}, #{createTime}, #{updateTime})
    </insert>

    <select id="getById" resultType="com.sky.entity.SeckillOrder">
        SELECT * FROM seckill_order WHERE id = #{id}
    </select>

    <update id="updateStatus">
        UPDATE seckill_order 
        SET status = #{status}, update_time = NOW() 
        WHERE id = #{id}
    </update>

</mapper>
```

### 5. 创建Lua脚本

```lua
-- 文件路径: sky-server/src/main/resources/seckill_participate.lua
-- 秒杀参与Lua脚本
-- KEYS[1] = seckill:stock:{activityId}
-- KEYS[2] = seckill:participants:{activityId}
-- ARGV[1] = userId
-- ARGV[2] = quantity
-- ARGV[3] = perUserLimit

-- 检查用户是否已参与
local isParticipated = redis.call('SISMEMBER', KEYS[2], ARGV[1])
if isParticipated == 1 then
    return {0, '用户已参与该活动'}
end

-- 检查库存是否充足
local stock = redis.call('GET', KEYS[1])
if not stock then
    return {0, '活动不存在'}
end

stock = tonumber(stock)
local quantity = tonumber(ARGV[2])
local perUserLimit = tonumber(ARGV[3])

if stock < quantity then
    return {0, '库存不足'}
end

if quantity > perUserLimit then
    return {0, '超过限购数量'}
end

-- 扣减库存
local newStock = redis.call('DECRBY', KEYS[1], quantity)
if newStock < 0 then
    -- 回滚库存
    redis.call('INCRBY', KEYS[1], quantity)
    return {0, '库存不足'}
end

-- 记录用户参与
redis.call('SADD', KEYS[2], ARGV[1])

-- 设置过期时间（活动结束后清理）
redis.call('EXPIRE', KEYS[2], 86400)

return {1, '参与成功', newStock}
```

### 6. 增强SeckillActivityService

```java
// 在 SeckillActivityServiceImpl.java 中添加以下方法

@Autowired
private RedisTemplate redisTemplate;

@Autowired
private RedissonClient redissonClient;

@Autowired
private SeckillParticipantMapper seckillParticipantMapper;

@Autowired
private SeckillOrderMapper seckillOrderMapper;

@Value("${sky.redis.seckill.prefix:seckill:}")
private String seckillPrefix;

/**
 * 参与秒杀活动
 */
@Override
public String participateSeckill(Long activityId, Long userId, Integer quantity) {
    // 1. 获取活动信息
    SeckillActivity activity = getById(activityId);
    if (activity == null) {
        return "活动不存在";
    }
    
    // 2. 检查活动状态
    if (activity.getStatus() != 1) {
        return "活动已禁用";
    }
    
    LocalDateTime now = LocalDateTime.now();
    if (now.isBefore(activity.getStartTime())) {
        return "活动未开始";
    }
    if (now.isAfter(activity.getEndTime())) {
        return "活动已结束";
    }
    
    // 3. 使用分布式锁防止重复参与
    String lockKey = seckillPrefix + "lock:" + activityId;
    RLock lock = redissonClient.getLock(lockKey);
    
    try {
    if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
        // 4. 执行Lua脚本
        String stockKey = seckillPrefix + "stock:" + activityId;
        String participantsKey = seckillPrefix + "participants:" + activityId;
        
        DefaultRedisScript<Object> script = new DefaultRedisScript<>();
        script.setScriptSource(new ResourceScriptSource(new ClassPathResource("seckill_participate.lua")));
        script.setResultType(Object.class);
        
        List<String> keys = Arrays.asList(stockKey, participantsKey);
        Object[] args = {userId.toString(), quantity.toString(), activity.getPerUserLimit().toString()};
        
        Object result = redisTemplate.execute(script, keys, args);
        
        if (result != null && result instanceof List) {
            List resultList = (List) result;
            if (resultList.size() > 0) {
                Integer success = (Integer) resultList.get(0);
                if (success == 1) {
                    // 5. 记录参与记录
                    SeckillParticipant participant = SeckillParticipant.builder()
                            .activityId(activityId)
                            .userId(userId)
                            .quantity(quantity)
                            .status(1)
                            .createTime(now)
                            .updateTime(now)
                            .build();
                    seckillParticipantMapper.insert(participant);
                    
                    // 6. 异步处理订单
                    processSeckillOrderAsync(activity, userId, quantity);
                    
                    return "参与成功";
                } else {
                    return (String) resultList.get(1);
                }
            }
        }
        
        return "参与失败";
    } else {
        return "系统繁忙，请稍后重试";
    }
} catch (Exception e) {
    log.error("参与秒杀活动异常", e);
    return "参与失败，请重试";
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}

/**
 * 异步处理秒杀订单
 */
@Async
public void processSeckillOrderAsync(SeckillActivity activity, Long userId, Integer quantity) {
    try {
        // 创建秒杀订单
        SeckillOrder order = SeckillOrder.builder()
                .activityId(activity.getId())
                .userId(userId)
                .dishId(activity.getDishId())
                .quantity(quantity)
                .seckillPrice(activity.getSeckillPrice())
                .totalAmount(activity.getSeckillPrice().multiply(new BigDecimal(quantity)))
                .status(0)
                .createTime(LocalDateTime.now())
                .updateTime(LocalDateTime.now())
                .build();
        
        seckillOrderMapper.insert(order);
        
        // 更新数据库库存
        updateDatabaseStock(activity.getId(), quantity);
        
        log.info("秒杀订单创建成功：orderId={}, userId={}, activityId={}", 
                order.getId(), userId, activity.getId());
    } catch (Exception e) {
        log.error("处理秒杀订单异常", e);
    }
}

/**
 * 更新数据库库存
 */
@Async
public void updateDatabaseStock(Long activityId, Integer quantity) {
    try {
        seckillActivityMapper.reduceStock(activityId, quantity);
        seckillActivityMapper.increaseSoldCount(activityId, quantity);
    } catch (Exception e) {
        log.error("更新数据库库存异常", e);
    }
}
```

### 7. 创建用户端控制器

```java
// 文件路径: sky-server/src/main/java/com/sky/controller/user/SeckillActivityController.java
package com.sky.controller.user;

import com.sky.entity.SeckillActivity;
import com.sky.result.Result;
import com.sky.service.SeckillActivityService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/user/seckill/activity")
@Api(tags = "用户端秒杀活动")
@Slf4j
public class SeckillActivityController {

    @Autowired
    private SeckillActivityService seckillActivityService;

    @GetMapping("/current")
    @ApiOperation("获取当前进行中的秒杀活动")
    public Result<List<SeckillActivity>> getCurrentActivities() {
        log.info("获取当前进行中的秒杀活动");
        List<SeckillActivity> activities = seckillActivityService.getCurrentActivities();
        return Result.success(activities);
    }

    @GetMapping("/{id}")
    @ApiOperation("根据id查询秒杀活动详情")
    public Result<SeckillActivity> getById(@PathVariable Long id) {
        log.info("根据id查询秒杀活动详情：{}", id);
        SeckillActivity seckillActivity = seckillActivityService.getById(id);
        return Result.success(seckillActivity);
    }

    @PostMapping("/participate/{id}")
    @ApiOperation("参与秒杀活动")
    public Result<String> participateSeckill(@PathVariable Long id, 
                                           @RequestParam Integer quantity) {
        log.info("用户参与秒杀活动：id={}, quantity={}", id, quantity);
        // 这里需要从JWT中获取用户ID，暂时使用固定值
        Long userId = 1L; // 实际项目中从JWT中获取
        String result = seckillActivityService.participateSeckill(id, userId, quantity);
        return Result.success(result);
    }
}
```

---

## 总结

第一部分涵盖了秒杀活动功能的核心后端实现，包括：

1. **数据库设计** - 完整的表结构和索引设计
2. **实体类创建** - 秒杀参与记录和订单实体
3. **数据访问层** - Mapper接口和XML配置
4. **核心业务逻辑** - 分布式锁、Redis缓存、Lua脚本
5. **API接口** - 用户端控制器

这些是构建高并发秒杀系统的基础，下一部分将介绍前端界面开发和微信小程序集成。

---

*继续阅读：[秒杀活动功能完善指南 - 第二部分](./秒杀活动功能完善指南-第二部分.md)*
