<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="æ·±å…¥è§£æRabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ã€å®Œæ•´ä»£ç å®ç°å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿ"><title>RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ</title><link rel=canonical href=https://Yin123-ybh.github.io/p/rabbitmq-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ"><meta property='og:description' content="æ·±å…¥è§£æRabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ã€å®Œæ•´ä»£ç å®ç°å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿ"><meta property='og:url' content='https://Yin123-ybh.github.io/p/rabbitmq-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90/'><meta property='og:site_name' content='Cecilia-å¡è¥¿è‰å¨…'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Java'><meta property='article:tag' content='RabbitMQ'><meta property='article:tag' content='æ¶ˆæ¯é˜Ÿåˆ—'><meta property='article:tag' content='å¯é æ€§'><meta property='article:tag' content='ç”Ÿäº§è€…ç¡®è®¤'><meta property='article:tag' content='åˆ†å¸ƒå¼ç³»ç»Ÿ'><meta property='article:published_time' content='2025-01-14T00:00:00+00:00'><meta property='article:modified_time' content='2025-01-14T00:00:00+00:00'><meta name=twitter:title content="RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ"><meta name=twitter:description content="æ·±å…¥è§£æRabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ã€å®Œæ•´ä»£ç å®ç°å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿ"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_8636e4c1b17bd1a4.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ§‘â€ğŸ’»</span></figure><div class=site-meta><h1 class=site-name><a href=/>Cecilia-å¡è¥¿è‰å¨…</a></h1><h2 class=site-description>Welcome to my website</h2></div></header><ol class=menu-social><li><a href=https://github.com/Yin123-ybh target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://Yin123-ybh.github.io/ selected>English</option><option value=https://Yin123-ybh.github.io/zh-cn/>ç®€ä½“ä¸­æ–‡</option><option value=https://Yin123-ybh.github.io/ar/>Ø¹Ø±Ø¨ÙŠ</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ç›®å½•>ç›®å½•</a></li><li><a href=#ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶>ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶</a><ol><li><a href=#æ¶ˆæ¯ä¸¢å¤±åœºæ™¯>æ¶ˆæ¯ä¸¢å¤±åœºæ™¯</a></li><li><a href=#é—®é¢˜ä»£ç ç¤ºä¾‹ä¸å¯é å®ç°>é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆä¸å¯é å®ç°ï¼‰</a></li><li><a href=#å¯é å®ç°å¯¹æ¯”>å¯é å®ç°å¯¹æ¯”</a></li></ol></li><li><a href=#rabbitmq-æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯>RabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯</a><ol><li><a href=#å®Œæ•´æŠ•é€’é“¾è·¯>å®Œæ•´æŠ•é€’é“¾è·¯</a><ol><li><a href=#è¯¦ç»†æµç¨‹è¯´æ˜>è¯¦ç»†æµç¨‹è¯´æ˜ï¼š</a></li><li><a href=#å…³é”®æœºåˆ¶å¯¹æ¯”è¡¨>å…³é”®æœºåˆ¶å¯¹æ¯”è¡¨ï¼š</a></li><li><a href=#æ¶ˆæ¯çŠ¶æ€æµè½¬>æ¶ˆæ¯çŠ¶æ€æµè½¬ï¼š</a></li></ol></li><li><a href=#è¯¦ç»†æµç¨‹è¯´æ˜-1>è¯¦ç»†æµç¨‹è¯´æ˜</a></li></ol></li><li><a href=#æ ¸å¿ƒæ¦‚å¿µè¯¦è§£>æ ¸å¿ƒæ¦‚å¿µè¯¦è§£</a><ol><li><a href=#1-broker>1. Broker</a></li><li><a href=#2-connection>2. Connection</a></li><li><a href=#3-channel>3. Channel</a></li><li><a href=#4-exchange>4. Exchange</a></li><li><a href=#5-queue>5. Queue</a></li><li><a href=#6-binding>6. Binding</a></li><li><a href=#7-basicpublish>7. Basic.Publish</a></li></ol></li><li><a href=#ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†>ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†</a><ol><li><a href=#deliverytag>deliveryTag</a></li><li><a href=#æœªç¡®è®¤æ¶ˆæ¯-map>æœªç¡®è®¤æ¶ˆæ¯ Map</a></li><li><a href=#multiple-æ ‡å¿—ä½>multiple æ ‡å¿—ä½</a></li><li><a href=#acknack-è§¦å‘æ—¶æœº>Ack/Nack è§¦å‘æ—¶æœº</a></li></ol></li><li><a href=#åŒæ­¥-confirm-æ¨¡å¼>åŒæ­¥ Confirm æ¨¡å¼</a><ol><li><a href=#å®ç°æ–¹å¼>å®ç°æ–¹å¼</a></li><li><a href=#ç¤ºä¾‹ä»£ç >ç¤ºä¾‹ä»£ç </a></li><li><a href=#ç‰¹ç‚¹>ç‰¹ç‚¹</a></li></ol></li><li><a href=#å¼‚æ­¥-confirm-æ¨¡å¼>å¼‚æ­¥ Confirm æ¨¡å¼</a><ol><li><a href=#å®ç°æ–¹å¼-1>å®ç°æ–¹å¼</a></li><li><a href=#ç¤ºä¾‹ä»£ç -1>ç¤ºä¾‹ä»£ç </a></li><li><a href=#å¼‚æ­¥çš„åŸç†>å¼‚æ­¥çš„åŸç†</a></li><li><a href=#ä¸åŒæ­¥çš„å¯¹æ¯”>ä¸åŒæ­¥çš„å¯¹æ¯”</a></li></ol></li><li><a href=#return-æœºåˆ¶>Return æœºåˆ¶</a><ol><li><a href=#èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#mandatory-æ ‡å¿—>Mandatory æ ‡å¿—</a></li><li><a href=#returncallback-å®ç°>ReturnCallback å®ç°</a></li><li><a href=#ä¸-confirm-çš„åŒºåˆ«>ä¸ Confirm çš„åŒºåˆ«</a></li></ol></li><li><a href=#publisher-confirm-type-é…ç½®>publisher-confirm-type é…ç½®</a><ol><li><a href=#ç±»å‹è¯´æ˜>ç±»å‹è¯´æ˜</a></li><li><a href=#spring-amqp-é…ç½®ç±»>Spring AMQP é…ç½®ç±»</a></li><li><a href=#ä¸å¼‚æ­¥-confirm-çš„å…³ç³»>ä¸å¼‚æ­¥ Confirm çš„å…³ç³»</a></li></ol></li><li><a href=#ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ>ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ</a><ol><li><a href=#1-confirm--return-ç»„åˆ>1. Confirm + Return ç»„åˆ</a></li><li><a href=#2-å¹‚ç­‰æ€§ä¸æ¶ˆæ¯å»é‡>2. å¹‚ç­‰æ€§ä¸æ¶ˆæ¯å»é‡</a></li><li><a href=#3-æ¶ˆæ¯æŒä¹…åŒ–ä¸ç£ç›˜å†™å…¥>3. æ¶ˆæ¯æŒä¹…åŒ–ä¸ç£ç›˜å†™å…¥</a></li><li><a href=#4-åº”ç”¨å±‚è¡¥å¿æœºåˆ¶>4. åº”ç”¨å±‚è¡¥å¿æœºåˆ¶</a></li></ol></li><li><a href=#å®Œæ•´ä»£ç å®ç°>å®Œæ•´ä»£ç å®ç°</a><ol><li><a href=#é¡¹ç›®ç»“æ„>é¡¹ç›®ç»“æ„</a></li><li><a href=#æ ¸å¿ƒé…ç½®ç±»>æ ¸å¿ƒé…ç½®ç±»</a></li><li><a href=#å¯é æ¶ˆæ¯ç”Ÿäº§è€…>å¯é æ¶ˆæ¯ç”Ÿäº§è€…</a></li><li><a href=#æ¶ˆæ¯æ¶ˆè´¹è€…>æ¶ˆæ¯æ¶ˆè´¹è€…</a></li><li><a href=#æ¶ˆæ¯å¯é æ€§æœåŠ¡>æ¶ˆæ¯å¯é æ€§æœåŠ¡</a></li></ol></li><li><a href=#æœ€ä½³å®è·µä¸æ€»ç»“>æœ€ä½³å®è·µä¸æ€»ç»“</a><ol><li><a href=#1-æ€§èƒ½ä¼˜åŒ–å»ºè®®>1. æ€§èƒ½ä¼˜åŒ–å»ºè®®</a></li><li><a href=#2-ç›‘æ§å’Œå‘Šè­¦>2. ç›‘æ§å’Œå‘Šè­¦</a></li><li><a href=#3-æ€»ç»“>3. æ€»ç»“</a><ol><li><a href=#confirm-æœºåˆ¶è§£å†³äº†æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾-brokerçš„é—®é¢˜>Confirm æœºåˆ¶è§£å†³äº†"æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ Broker"çš„é—®é¢˜</a></li><li><a href=#return-æœºåˆ¶è§£å†³äº†æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—çš„é—®é¢˜>Return æœºåˆ¶è§£å†³äº†"æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—"çš„é—®é¢˜</a></li><li><a href=#deliverytag--multiple-æ„æˆäº†-confirm-çš„æ ¸å¿ƒé€»è¾‘>deliveryTag + multiple æ„æˆäº† Confirm çš„æ ¸å¿ƒé€»è¾‘</a></li><li><a href=#spring-amqp-çš„-publisher-confirm-typecorrelated-å°±æ˜¯å¼‚æ­¥-confirm-çš„å°è£…>Spring AMQP çš„ publisher-confirm-type=correlated å°±æ˜¯å¼‚æ­¥ Confirm çš„å°è£…</a></li><li><a href=#ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¼š-confirm--return--æ¶ˆæ¯æŒä¹…åŒ–--åº”ç”¨å±‚è¡¥å¿-ç»„åˆä½¿ç”¨>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼š Confirm + Return + æ¶ˆæ¯æŒä¹…åŒ– + åº”ç”¨å±‚è¡¥å¿ ç»„åˆä½¿ç”¨</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%8A%80%E6%9C%AF/>æ¶ˆæ¯é˜Ÿåˆ—æŠ€æœ¯</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/rabbitmq-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90/>RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ</a></h2><h3 class=article-subtitle>æ·±å…¥è§£æRabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ã€å®Œæ•´ä»£ç å®ç°å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿ</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-01-14</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>19 minute read</time></div></footer></div></header><section class=article-content><h1 id=rabbitmq-ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ>RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ</h1><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºè§£è€¦å’Œå¼‚æ­¥å¤„ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…¶å¯é æ€§è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†ä»ç”Ÿäº§è€…è§’åº¦æ·±å…¥è§£æRabbitMQçš„ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ï¼Œä»¥åŠå®Œæ•´çš„ä»£ç å®ç°å’Œæœ€ä½³å®è·µã€‚</p><hr><h2 id=ç›®å½•>ç›®å½•</h2><ol><li><a class=link href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e7%94%9f%e4%ba%a7%e8%80%85%e7%a1%ae%e8%ae%a4%e6%9c%ba%e5%88%b6>ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶</a></li><li><a class=link href=#rabbitmq-%e6%b6%88%e6%81%af%e6%8a%95%e9%80%92%e9%93%be%e8%b7%af%e5%85%a8%e6%99%af>RabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯</a></li><li><a class=link href=#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e8%af%a6%e8%a7%a3>æ ¸å¿ƒæ¦‚å¿µè¯¦è§£</a></li><li><a class=link href=#%e7%94%9f%e4%ba%a7%e8%80%85%e7%a1%ae%e8%ae%a4%e6%9c%ba%e5%88%b6%e7%9a%84%e5%8e%9f%e7%90%86>ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†</a></li><li><a class=link href=#%e5%90%8c%e6%ad%a5-confirm-%e6%a8%a1%e5%bc%8f>åŒæ­¥ Confirm æ¨¡å¼</a></li><li><a class=link href=#%e5%bc%82%e6%ad%a5-confirm-%e6%a8%a1%e5%bc%8f>å¼‚æ­¥ Confirm æ¨¡å¼</a></li><li><a class=link href=#return-%e6%9c%ba%e5%88%b6>Return æœºåˆ¶</a></li><li><a class=link href=#publisher-confirm-type-%e9%85%8d%e7%bd%ae>publisher-confirm-type é…ç½®</a></li><li><a class=link href=#%e7%94%9f%e4%ba%a7%e8%80%85%e5%8f%af%e9%9d%a0%e6%80%a7%e4%bf%9d%e9%9a%9c%e7%9a%84%e5%85%a8%e9%93%be%e8%b7%af%e6%95%b4%e5%90%88>ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ</a></li><li><a class=link href=#%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0>å®Œæ•´ä»£ç å®ç°</a></li><li><a class=link href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%bb%e7%bb%93>æœ€ä½³å®è·µä¸æ€»ç»“</a></li></ol><hr><h2 id=ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶>ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶</h2><p>åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ç¡®è®¤ï¼ˆConsumer Ackï¼‰æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå®ƒä¿è¯äº†æ¶ˆæ¯ä¸ä¼š"ç™½ç™½ä¸¢å¤±"ã€‚</p><p>ä½†å¾€å¾€è¢«å¿½è§†çš„ä¸€ç‚¹æ˜¯ï¼š<strong>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ° RabbitMQ Broker çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯èƒ½ä¸¢å¤±æ¶ˆæ¯</strong>ã€‚å¸¸è§æƒ…å†µåŒ…æ‹¬ï¼š</p><h3 id=æ¶ˆæ¯ä¸¢å¤±åœºæ™¯>æ¶ˆæ¯ä¸¢å¤±åœºæ™¯</h3><ol><li><strong>ç½‘ç»œç¬æ—¶ä¸­æ–­</strong>ï¼šæ¶ˆæ¯æ²¡æœ‰åˆ°è¾¾ Broker</li><li><strong>Broker æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†å°šæœªæŒä¹…åŒ–å°±å´©æºƒ</strong></li><li><strong>Exchange è·¯ç”±å¤±è´¥</strong>ï¼šæ¶ˆæ¯æ²¡æœ‰è¿›å…¥ä»»ä½•é˜Ÿåˆ—</li><li><strong>å†…å­˜ä¸è¶³</strong>ï¼šBroker å†…å­˜æº¢å‡ºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</li><li><strong>ç£ç›˜æ•…éšœ</strong>ï¼šæŒä¹…åŒ–æ¶ˆæ¯æ—¶ç£ç›˜å†™å…¥å¤±è´¥</li></ol><h3 id=é—®é¢˜ä»£ç ç¤ºä¾‹ä¸å¯é å®ç°>é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆä¸å¯é å®ç°ï¼‰</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// âŒ é”™è¯¯å®ç°ï¼šæ²¡æœ‰ç¡®è®¤æœºåˆ¶ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnreliableMessageProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>rabbitTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç›´æ¥å‘é€ï¼Œä¸çŸ¥é“æ˜¯å¦æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>convertAndSend</span><span class=p>(</span><span class=s>&#34;exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;routingKey&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å·²å‘é€&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// è¿™é‡Œå¯èƒ½æ¶ˆæ¯å·²ç»ä¸¢å¤±äº†ï¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å¯é å®ç°å¯¹æ¯”>å¯é å®ç°å¯¹æ¯”</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// âœ… æ­£ç¡®å®ç°ï¼šå¸¦ç¡®è®¤æœºåˆ¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReliableMessageProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>rabbitTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¼€å¯ç¡®è®¤æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>setConfirmCallback</span><span class=p>((</span><span class=n>correlationData</span><span class=p>,</span><span class=w> </span><span class=n>ack</span><span class=p>,</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>cause</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>convertAndSend</span><span class=p>(</span><span class=s>&#34;exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;routingKey&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæ²¡æœ‰å¯é çš„ç¡®è®¤æœºåˆ¶ï¼Œç”Ÿäº§è€…ä¼šè®¤ä¸ºæ¶ˆæ¯å·²ç»æˆåŠŸæŠ•é€’ï¼Œä½†å®é™…ä¸Šæ¶ˆæ¯å¯èƒ½åœ¨åŠè·¯ä¸¢äº†ã€‚</p><p>å› æ­¤ï¼ŒRabbitMQ æä¾›äº† <strong>Publisher Confirms å’Œ Return æœºåˆ¶</strong> æ¥ä¿è¯ç”Ÿäº§è€…ä¾§çš„å¯é æ€§ã€‚</p><hr><h2 id=rabbitmq-æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯>RabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯</h2><p>è®©æˆ‘ä»¬ä»æ•´ä½“é“¾è·¯çœ‹ä¸€æ¬¡æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„ç”Ÿå‘½å‘¨æœŸï¼š</p><h3 id=å®Œæ•´æŠ•é€’é“¾è·¯>å®Œæ•´æŠ•é€’é“¾è·¯</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ç”Ÿäº§è€… â†’ Channel â†’ Broker â†’ æ¶ˆæ¯æŒä¹…åŒ– â†’ Exchange â†’ è·¯ç”±æ£€æŸ¥ â†’ Queue â†’ æ¶ˆè´¹è€…
</span></span><span class=line><span class=cl>   â†“         â†“         â†“           â†“           â†“         â†“        â†“        â†“
</span></span><span class=line><span class=cl>deliveryTag  æœªç¡®è®¤æ¶ˆæ¯Map  Confirmæœºåˆ¶   æŒä¹…åŒ–ç»“æœ   è·¯ç”±ç»“æœ   æ¶ˆæ¯çŠ¶æ€   æ¶ˆè´¹ç»“æœ
</span></span><span class=line><span class=cl>   â†“         â†“         â†“           â†“           â†“         â†“        â†“        â†“
</span></span><span class=line><span class=cl>ç”Ÿæˆå”¯ä¸€ID   è®°å½•å¾…ç¡®è®¤   å¤„ç†Ack/Nack  æˆåŠŸâ†’Ack    æˆåŠŸâ†’è¿›å…¥Queue  ç­‰å¾…æ¶ˆè´¹  æˆåŠŸâ†’Ack
</span></span><span class=line><span class=cl>            æ¶ˆæ¯ä¿¡æ¯     å¤±è´¥â†’Nack    å¤±è´¥â†’Returnæœºåˆ¶  å¤±è´¥â†’ReturnCallback  å¤±è´¥â†’Nack
</span></span></code></pre></td></tr></table></div></div><h4 id=è¯¦ç»†æµç¨‹è¯´æ˜>è¯¦ç»†æµç¨‹è¯´æ˜ï¼š</h4><p><strong>1. ç”Ÿäº§è€…å‘é€é˜¶æ®µ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ç”Ÿäº§è€… â†’ Channel
</span></span><span class=line><span class=cl>â”œâ”€â”€ ç”Ÿæˆ deliveryTagï¼ˆé€’å¢è®¡æ•°å™¨ï¼‰
</span></span><span class=line><span class=cl>â”œâ”€â”€ åŠ å…¥æœªç¡®è®¤æ¶ˆæ¯Map
</span></span><span class=line><span class=cl>â””â”€â”€ å‘é€æ¶ˆæ¯åˆ°Broker
</span></span></code></pre></td></tr></table></div></div><p><strong>2. Brokerå¤„ç†é˜¶æ®µ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Broker â†’ æ¶ˆæ¯æŒä¹…åŒ–
</span></span><span class=line><span class=cl>â”œâ”€â”€ æŒä¹…åŒ–æˆåŠŸ â†’ è¿”å›Ack â†’ è§¦å‘Confirmæœºåˆ¶
</span></span><span class=line><span class=cl>â””â”€â”€ æŒä¹…åŒ–å¤±è´¥ â†’ è¿”å›Nack â†’ è§¦å‘Confirmæœºåˆ¶
</span></span></code></pre></td></tr></table></div></div><p><strong>3. æ¶ˆæ¯è·¯ç”±é˜¶æ®µ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Exchange â†’ è·¯ç”±æ£€æŸ¥
</span></span><span class=line><span class=cl>â”œâ”€â”€ è·¯ç”±æˆåŠŸ â†’ æ¶ˆæ¯è¿›å…¥Queue â†’ ç­‰å¾…æ¶ˆè´¹è€…
</span></span><span class=line><span class=cl>â””â”€â”€ è·¯ç”±å¤±è´¥ â†’ è§¦å‘Returnæœºåˆ¶ â†’ è°ƒç”¨ReturnCallback
</span></span></code></pre></td></tr></table></div></div><p><strong>4. æ¶ˆè´¹è€…å¤„ç†é˜¶æ®µ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>æ¶ˆè´¹è€… â†’ å¤„ç†æ¶ˆæ¯
</span></span><span class=line><span class=cl>â”œâ”€â”€ æ¶ˆè´¹æˆåŠŸ â†’ å‘é€Consumer Ack
</span></span><span class=line><span class=cl>â””â”€â”€ æ¶ˆè´¹å¤±è´¥ â†’ å‘é€Consumer Nack
</span></span></code></pre></td></tr></table></div></div><h4 id=å…³é”®æœºåˆ¶å¯¹æ¯”è¡¨>å…³é”®æœºåˆ¶å¯¹æ¯”è¡¨ï¼š</h4><div class=table-wrapper><table><thead><tr><th>æœºåˆ¶</th><th>è§¦å‘æ—¶æœº</th><th>è¿”å›ç»“æœ</th><th>ä½œç”¨èŒƒå›´</th><th>å¤„ç†æ–¹å¼</th></tr></thead><tbody><tr><td><strong>Confirmæœºåˆ¶</strong></td><td>æ¶ˆæ¯åˆ°è¾¾Brokerå</td><td>Ack/Nack</td><td>ç”Ÿäº§è€…â†’Broker</td><td>å¼‚æ­¥å›è°ƒ/åŒæ­¥ç­‰å¾…</td></tr><tr><td><strong>Returnæœºåˆ¶</strong></td><td>è·¯ç”±å¤±è´¥æ—¶</td><td>Basic.Return</td><td>Exchangeâ†’Queue</td><td>ReturnCallback</td></tr><tr><td><strong>Consumer Ack</strong></td><td>æ¶ˆè´¹å®Œæˆå</td><td>Consumer Ack/Nack</td><td>Queueâ†’æ¶ˆè´¹è€…</td><td>æ‰‹åŠ¨ç¡®è®¤/è‡ªåŠ¨ç¡®è®¤</td></tr></tbody></table></div><h4 id=æ¶ˆæ¯çŠ¶æ€æµè½¬>æ¶ˆæ¯çŠ¶æ€æµè½¬ï¼š</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>æ¶ˆæ¯çŠ¶æ€: å‘é€ä¸­ â†’ å·²æŒä¹…åŒ– â†’ å·²è·¯ç”± â†’ å·²æ¶ˆè´¹
</span></span><span class=line><span class=cl>         â†“        â†“        â†“        â†“
</span></span><span class=line><span class=cl>ç¡®è®¤æœºåˆ¶: æ—       Confirm   Return   Consumer Ack
</span></span><span class=line><span class=cl>         â†“        â†“        â†“        â†“
</span></span><span class=line><span class=cl>å¤„ç†ç»“æœ: ç­‰å¾…    æˆåŠŸ/å¤±è´¥  æˆåŠŸ/å¤±è´¥  æˆåŠŸ/å¤±è´¥
</span></span></code></pre></td></tr></table></div></div><h3 id=è¯¦ç»†æµç¨‹è¯´æ˜-1>è¯¦ç»†æµç¨‹è¯´æ˜</h3><ol><li><p><strong>ç”Ÿäº§è€…è°ƒç”¨ channel.basicPublish</strong></p><ul><li>å°†æ¶ˆæ¯é€šè¿‡ Channel å‘é€åˆ° Broker</li><li>åŒæ—¶ï¼ŒChannel å†…éƒ¨ä¼šä¸ºè¯¥æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ª <strong>é€’å¢çš„ deliveryTag</strong></li><li>æŠŠå®ƒæ”¾åˆ°ä¸€ä¸ª"æœªç¡®è®¤æ¶ˆæ¯ Map"ä¸­ï¼ˆä»…åœ¨å¼€å¯ Confirm æ¨¡å¼æ—¶ï¼‰</li></ul></li><li><p><strong>Broker æ”¶åˆ°æ¶ˆæ¯å¹¶ç«‹å³æŒä¹…åŒ–</strong></p><ul><li>æ ¹æ® BasicPropertiesï¼ˆåŒ…æ‹¬æŒä¹…åŒ–æ ‡å¿—ï¼‰å°è¯•å­˜å‚¨æ¶ˆæ¯</li><li><strong>æŒä¹…åŒ–æˆåŠŸ</strong> â†’ å‡†å¤‡è¿”å› Ack</li><li><strong>æŒä¹…åŒ–å¤±è´¥</strong> â†’ å‡†å¤‡è¿”å› Nack</li></ul></li><li><p><strong>æ¶ˆæ¯è·¯ç”±å¤„ç†</strong></p><ul><li>æŒä¹…åŒ–æˆåŠŸåï¼Œå°†æ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº”çš„ Exchange</li><li>Exchange è¿›è¡Œè·¯ç”±æ£€æŸ¥ï¼š<ul><li><strong>è·¯ç”±æˆåŠŸ</strong> â†’ æ¶ˆæ¯è¿›å…¥ç›®æ ‡ Queue</li><li><strong>è·¯ç”±å¤±è´¥</strong> â†’ è§¦å‘ Return æœºåˆ¶ï¼ˆå¦‚æœè®¾ç½®äº† mandatory=trueï¼‰</li></ul></li></ul></li><li><p><strong>Confirm æœºåˆ¶å¤„ç†</strong></p><ul><li>Broker é€šè¿‡ AMQP åè®®è¿”å› Confirm æ¶ˆæ¯å¸§ï¼ˆåŒ…å« deliveryTagã€ack/nackã€multipleï¼‰</li><li>ç”Ÿäº§è€…çš„ Channel æ”¶åˆ°åï¼Œè§¦å‘å†…éƒ¨ Confirm å¤„ç†é€»è¾‘</li><li>Channel ä»"æœªç¡®è®¤ Map"ä¸­æ‰¾åˆ°å¯¹åº” deliveryTag çš„æ¶ˆæ¯ï¼Œç§»é™¤å¹¶è§¦å‘å›è°ƒ</li></ul></li><li><p><strong>Return æœºåˆ¶å¤„ç†ï¼ˆå¯é€‰ï¼‰</strong></p><ul><li>å¦‚æœè·¯ç”±å¤±è´¥ä¸”è®¾ç½®äº† mandatory=true</li><li>Broker è¿”å› Basic.Return æ¶ˆæ¯å¸§</li><li>ç”Ÿäº§è€…é€šè¿‡ ReturnCallback æ¥æ”¶è¯¥äº‹ä»¶ï¼Œå†³å®šæ˜¯å¦é‡è¯•æˆ–ä¸¢å¼ƒ</li></ul></li><li><p><strong>æ¶ˆè´¹è€…å¤„ç†</strong></p><ul><li>æ¶ˆè´¹è€…ä» Queue è·å–æ¶ˆæ¯</li><li><strong>æ¶ˆè´¹æˆåŠŸ</strong> â†’ å‘é€ Consumer Ack</li><li><strong>æ¶ˆè´¹å¤±è´¥</strong> â†’ å‘é€ Consumer Nack</li></ul></li></ol><p>è¿™ä¸€è¿‡ç¨‹ç¡®ä¿äº† <strong>ç”Ÿäº§è€…å¯ä»¥æ˜ç¡®çŸ¥é“æ¶ˆæ¯çš„å®Œæ•´æŠ•é€’çŠ¶æ€</strong>ï¼Œé¿å…äº†"é»‘ç®±å‘é€"ï¼Œå®ç°äº†ç«¯åˆ°ç«¯çš„æ¶ˆæ¯å¯é æ€§ä¿éšœã€‚</p><hr><h2 id=æ ¸å¿ƒæ¦‚å¿µè¯¦è§£>æ ¸å¿ƒæ¦‚å¿µè¯¦è§£</h2><h3 id=1-broker>1. Broker</h3><p>RabbitMQ æœåŠ¡å™¨æœ¬èº«å°±æ˜¯ä¸€ä¸ª Brokerï¼Œè´Ÿè´£æ¥æ”¶ã€å­˜å‚¨ã€è·¯ç”±å’ŒæŠ•é€’æ¶ˆæ¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Broker è¿æ¥é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RabbitMQConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ConnectionFactory</span><span class=w> </span><span class=nf>connectionFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setHost</span><span class=p>(</span><span class=s>&#34;localhost&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPort</span><span class=p>(</span><span class=n>5672</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setUsername</span><span class=p>(</span><span class=s>&#34;guest&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=s>&#34;guest&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setVirtualHost</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¼€å¯ç¡®è®¤æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherConfirmType</span><span class=p>(</span><span class=n>CachingConnectionFactory</span><span class=p>.</span><span class=na>ConfirmType</span><span class=p>.</span><span class=na>CORRELATED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherReturns</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-connection>2. Connection</h3><p>ç”Ÿäº§è€…ä¸ Broker å»ºç«‹çš„ TCP é•¿è¿æ¥ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConnectionManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostConstruct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initConnection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;è¿æ¥å»ºç«‹æˆåŠŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;è¿æ¥å»ºç«‹å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PreDestroy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>closeConnection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connection</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>isOpen</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>connection</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;è¿æ¥å·²å…³é—­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å…³é—­è¿æ¥å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-channel>3. Channel</h3><p>åœ¨ Connection ä¸Šçš„é€»è¾‘é€šé“ã€‚</p><ul><li>æ¶ˆæ¯çš„å‘é€ã€ç¡®è®¤éƒ½é€šè¿‡ Channel å®Œæˆ</li><li>ConfirmListener ç»‘å®šåœ¨ Channel ä¸Š</li><li>deliveryTag ä¹Ÿæ˜¯ä»¥ Channel ä¸ºä½œç”¨åŸŸç”Ÿæˆçš„</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ChannelManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Channel</span><span class=w> </span><span class=nf>getChannel</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>channel</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>channel</span><span class=p>.</span><span class=na>isOpen</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>createChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¼€å¯ç¡®è®¤æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>confirmSelect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>channel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=4-exchange>4. Exchange</h3><p>æ¶ˆæ¯è·¯ç”±å™¨ã€‚ç”Ÿäº§è€…åªèƒ½æŠŠæ¶ˆæ¯æŠ•é€’åˆ° Exchangeï¼Œç”± Exchange æ ¹æ®ç±»å‹ï¼ˆDirect/Topic/Fanout/Headersï¼‰å’Œ Binding è§„åˆ™è·¯ç”±åˆ° Queueã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExchangeConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DirectExchange</span><span class=w> </span><span class=nf>directExchange</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DirectExchange</span><span class=p>(</span><span class=s>&#34;direct.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TopicExchange</span><span class=w> </span><span class=nf>topicExchange</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TopicExchange</span><span class=p>(</span><span class=s>&#34;topic.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>FanoutExchange</span><span class=w> </span><span class=nf>fanoutExchange</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FanoutExchange</span><span class=p>(</span><span class=s>&#34;fanout.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=5-queue>5. Queue</h3><p>æ¶ˆæ¯çš„å­˜å‚¨å®¹å™¨ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>QueueConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Queue</span><span class=w> </span><span class=nf>reliableQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>QueueBuilder</span><span class=p>.</span><span class=na>durable</span><span class=p>(</span><span class=s>&#34;reliable.queue&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withArgument</span><span class=p>(</span><span class=s>&#34;x-message-ttl&#34;</span><span class=p>,</span><span class=w> </span><span class=n>60000</span><span class=p>)</span><span class=w> </span><span class=c1>// æ¶ˆæ¯TTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withArgument</span><span class=p>(</span><span class=s>&#34;x-max-length&#34;</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>)</span><span class=w>   </span><span class=c1>// é˜Ÿåˆ—æœ€å¤§é•¿åº¦</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Queue</span><span class=w> </span><span class=nf>deadLetterQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>QueueBuilder</span><span class=p>.</span><span class=na>durable</span><span class=p>(</span><span class=s>&#34;dead.letter.queue&#34;</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=6-binding>6. Binding</h3><p>Exchange ä¸ Queue çš„ç»‘å®šå…³ç³»ï¼Œå†³å®šæ¶ˆæ¯çš„æµå‘ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BindingConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Binding</span><span class=w> </span><span class=nf>reliableBinding</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>BindingBuilder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>reliableQueue</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=n>directExchange</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=s>&#34;reliable.key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=7-basicpublish>7. Basic.Publish</h3><p>AMQP åè®®ä¸­çš„æ¶ˆæ¯å‘é€å‘½ä»¤ã€‚è°ƒç”¨ channel.basicPublish å°±æ˜¯å‘ Broker å‘é€ Basic.Publish æŒ‡ä»¤ï¼Œé™„å¸¦æ¶ˆæ¯ä½“å’Œå±æ€§ã€‚</p><hr><h2 id=ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†>ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†</h2><h3 id=deliverytag>deliveryTag</h3><ul><li>æ¯ä¸ª Channel å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ª <strong>é€’å¢çš„è®¡æ•°å™¨</strong></li><li>æ¯è°ƒç”¨ä¸€æ¬¡ basicPublishï¼Œè¿™ä¸ªè®¡æ•°å™¨åŠ  1ï¼Œå¾—åˆ°ä¸€ä¸ª deliveryTag</li><li>deliveryTag ä½œä¸ºæ¶ˆæ¯çš„"å”¯ä¸€åºå·"ï¼Œç”¨äºåç»­ Ack/Nack å¯¹åº”</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// deliveryTag ç”Ÿæˆç¤ºä¾‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DeliveryTagGenerator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicLong</span><span class=w> </span><span class=n>deliveryTagCounter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>generateDeliveryTag</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>deliveryTagCounter</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reset</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>deliveryTagCounter</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=æœªç¡®è®¤æ¶ˆæ¯-map>æœªç¡®è®¤æ¶ˆæ¯ Map</h3><ul><li>Channel å†…éƒ¨ä¿å­˜ä¸€ä¸ª <strong>æœ‰åº Map</strong>ï¼Œkey æ˜¯ deliveryTagï¼Œvalue æ˜¯æ¶ˆæ¯ä¿¡æ¯</li><li>åªæœ‰åœ¨å¼€å¯ Confirm æ¨¡å¼åï¼Œè¿™ä¸ª Map æ‰ä¼šå¯ç”¨</li><li>Ack/Nack åˆ°æ¥æ—¶ï¼ŒChannel ä¼šæŸ¥ Map æ¥æ‰¾åˆ°éœ€è¦ç¡®è®¤çš„æ¶ˆæ¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æœªç¡®è®¤æ¶ˆæ¯ç®¡ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnconfirmedMessageManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=o>&gt;</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addUnconfirmedMessage</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=nf>removeUnconfirmedMessage</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeMultipleMessages</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>removeIf</span><span class=p>(</span><span class=n>entry</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUnconfirmedCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnconfirmedMessage</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>body</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timestamp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=multiple-æ ‡å¿—ä½>multiple æ ‡å¿—ä½</h3><ul><li>Ack/Nack æ¶ˆæ¯ä¸­å¸¦æœ‰ multiple å¸ƒå°”å€¼</li><li><strong>false</strong>ï¼šåªç¡®è®¤å½“å‰ deliveryTag</li><li><strong>true</strong>ï¼šç¡®è®¤ <strong>å°äºç­‰äºå½“å‰ deliveryTag çš„æ‰€æœ‰æ¶ˆæ¯</strong></li></ul><p>è¿™æ˜¯ä¸€ç§æ‰¹é‡ç¡®è®¤æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œäº¤äº’ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// multiple æ ‡å¿—ä½å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MultipleConfirmHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleConfirm</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>multiple</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰¹é‡ç¡®è®¤ï¼šç¡®è®¤æ‰€æœ‰å°äºç­‰äº deliveryTag çš„æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleMultipleConfirm</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>ack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å•ä¸ªç¡®è®¤ï¼šåªç¡®è®¤å½“å‰ deliveryTag</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleSingleConfirm</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>ack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMultipleConfirm</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¤„ç†æ‰¹é‡ç¡®è®¤é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡ç¡®è®¤ deliveryTag: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deliveryTag</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, ack: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleSingleConfirm</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¤„ç†å•ä¸ªç¡®è®¤é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å•ä¸ªç¡®è®¤ deliveryTag: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deliveryTag</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, ack: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=acknack-è§¦å‘æ—¶æœº>Ack/Nack è§¦å‘æ—¶æœº</h3><ul><li><strong>Ack</strong>ï¼šæ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸï¼Œæˆ–æŠ•é€’åˆ°é˜Ÿåˆ—æˆåŠŸ</li><li><strong>Nack</strong>ï¼šå­˜å‚¨å¤±è´¥ã€Broker å†…éƒ¨å¼‚å¸¸</li></ul><hr><h2 id=åŒæ­¥-confirm-æ¨¡å¼>åŒæ­¥ Confirm æ¨¡å¼</h2><h3 id=å®ç°æ–¹å¼>å®ç°æ–¹å¼</h3><ol><li>è°ƒç”¨ <code>channel.confirmSelect()</code> å¼€å¯ Confirm æ¨¡å¼</li><li>æ¯æ¬¡ <code>basicPublish</code> ä¹‹åè°ƒç”¨ <code>channel.waitForConfirms()</code> é˜»å¡ç­‰å¾…</li></ol><h3 id=ç¤ºä¾‹ä»£ç >ç¤ºä¾‹ä»£ç </h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SynchronousConfirmProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessageWithSyncConfirm</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1. å»ºç«‹è¿æ¥å’Œé€šé“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>createChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 2. å¼€å¯ç¡®è®¤æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>confirmSelect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 3. å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>basicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 4. åŒæ­¥ç­‰å¾…ç¡®è®¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>confirmed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>waitForConfirms</span><span class=p>(</span><span class=n>5000</span><span class=p>);</span><span class=w> </span><span class=c1>// 5ç§’è¶…æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>confirmed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 5. å…³é—­èµ„æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>closeResources</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>connection</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMultipleMessagesWithSyncConfirm</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>messages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>createChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>confirmSelect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰¹é‡å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>messages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>channel</span><span class=p>.</span><span class=na>basicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰¹é‡ç­‰å¾…ç¡®è®¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>confirmed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>waitForConfirms</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w> </span><span class=c1>// 10ç§’è¶…æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>confirmed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡æ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œæ•°é‡: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messages</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡æ¶ˆæ¯æŠ•é€’å¤±è´¥&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡å‘é€æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>closeResources</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>connection</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>closeResources</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>channel</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>isOpen</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>channel</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connection</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>isOpen</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>connection</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å…³é—­èµ„æºå¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç‰¹ç‚¹>ç‰¹ç‚¹</h3><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•æ˜“æ‡‚ï¼Œå®æ—¶çŸ¥é“ç»“æœ</li><li><strong>ç¼ºç‚¹</strong>ï¼šæ€§èƒ½å·®ï¼Œå› ä¸ºæ¯æ¡æ¶ˆæ¯éƒ½è¦é˜»å¡ç­‰å¾…</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šä½ååã€å¼ºä¸€è‡´åœºæ™¯</li></ul><hr><h2 id=å¼‚æ­¥-confirm-æ¨¡å¼>å¼‚æ­¥ Confirm æ¨¡å¼</h2><h3 id=å®ç°æ–¹å¼-1>å®ç°æ–¹å¼</h3><ol><li>è°ƒç”¨ <code>channel.confirmSelect()</code> å¼€å¯ Confirm æ¨¡å¼</li><li>æ³¨å†Œ <code>ConfirmListener</code></li><li>è°ƒç”¨ <code>basicPublish</code> æ—¶ä¸é˜»å¡ï¼Œä¾èµ–å¼‚æ­¥å›è°ƒå¤„ç† Ack/Nack</li></ol><h3 id=ç¤ºä¾‹ä»£ç -1>ç¤ºä¾‹ä»£ç </h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AsynchronousConfirmProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=o>&gt;</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicLong</span><span class=w> </span><span class=n>deliveryTagCounter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessageWithAsyncConfirm</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>createChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>confirmSelect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ³¨å†Œå¼‚æ­¥ç¡®è®¤ç›‘å¬å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>addConfirmListener</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// ack å›è°ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>handleAck</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// nack å›è°ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>handleNack</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¼‚æ­¥å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deliveryTagCounter</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>basicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®°å½•æœªç¡®è®¤æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleAck</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰¹é‡ç¡®è®¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>removeIf</span><span class=p>(</span><span class=n>entry</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡ACKï¼ŒdeliveryTag: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å•ä¸ªç¡®è®¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>message</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯ç¡®è®¤æˆåŠŸï¼ŒdeliveryTag: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deliveryTag</span><span class=w> </span><span class=o>+</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;, message: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleNack</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰¹é‡æ‹’ç»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>removeIf</span><span class=p>(</span><span class=n>entry</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡NACKï¼ŒdeliveryTag: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å•ä¸ªæ‹’ç»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>message</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯ç¡®è®¤å¤±è´¥ï¼ŒdeliveryTag: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deliveryTag</span><span class=w> </span><span class=o>+</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;, message: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿™é‡Œå¯ä»¥å®ç°é‡è¯•é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>retryMessage</span><span class=p>(</span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>retryMessage</span><span class=p>(</span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å®ç°é‡è¯•é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;é‡è¯•æ¶ˆæ¯: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMultipleMessagesWithAsyncConfirm</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>messages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>createChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>confirmSelect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ³¨å†Œç¡®è®¤ç›‘å¬å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>addConfirmListener</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>handleAck</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>handleNack</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=n>multiple</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰¹é‡å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>messages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deliveryTagCounter</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>channel</span><span class=p>.</span><span class=na>basicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡æ¶ˆæ¯å·²å‘é€ï¼Œæ•°é‡: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messages</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰¹é‡å‘é€æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å¼‚æ­¥çš„åŸç†>å¼‚æ­¥çš„åŸç†</h3><ol><li><strong>å‘é€æ¶ˆæ¯æ—¶</strong>ï¼šæ¶ˆæ¯ç«‹å³æ”¾å…¥æœªç¡®è®¤ Map</li><li><strong>Broker åœ¨åå°å¼‚æ­¥è¿”å› Confirm å¸§</strong></li><li><strong>Channel å†…éƒ¨çš„ IO çº¿ç¨‹è§£æ Confirm å¸§</strong>ï¼Œæ‰¾åˆ° deliveryTag å¯¹åº”çš„æ¶ˆæ¯ï¼Œä» Map ç§»é™¤ï¼Œå¹¶è§¦å‘å›è°ƒ</li></ol><h3 id=ä¸åŒæ­¥çš„å¯¹æ¯”>ä¸åŒæ­¥çš„å¯¹æ¯”</h3><div class=table-wrapper><table><thead><tr><th>ç‰¹æ€§</th><th>åŒæ­¥ Confirm</th><th>å¼‚æ­¥ Confirm</th></tr></thead><tbody><tr><td><strong>æ€§èƒ½</strong></td><td>ä½ï¼ˆé˜»å¡ç­‰å¾…ï¼‰</td><td>é«˜ï¼ˆéé˜»å¡ï¼‰</td></tr><tr><td><strong>ååé‡</strong></td><td>ä½</td><td>é«˜</td></tr><tr><td><strong>å®æ—¶æ€§</strong></td><td>å®æ—¶çŸ¥é“ç»“æœ</td><td>é€šè¿‡å›è°ƒå¼‚æ­¥å¤„ç†</td></tr><tr><td><strong>å¤æ‚åº¦</strong></td><td>ç®€å•</td><td>ç›¸å¯¹å¤æ‚</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>ä½å¹¶å‘ã€å¼ºä¸€è‡´</td><td>é«˜å¹¶å‘ã€é«˜åå</td></tr></tbody></table></div><hr><h2 id=return-æœºåˆ¶>Return æœºåˆ¶</h2><h3 id=èƒŒæ™¯>èƒŒæ™¯</h3><p>å³ä½¿æ¶ˆæ¯åˆ°è¾¾äº† Brokerï¼Œå¦‚æœ Exchange æ— æ³•å°†æ¶ˆæ¯è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šè¢«ä¸¢å¼ƒã€‚</p><p>ä¸ºé¿å…æ— å£°ä¸¢å¤±ï¼Œå¯ä»¥å¼€å¯ Return æœºåˆ¶ã€‚</p><h3 id=mandatory-æ ‡å¿—>Mandatory æ ‡å¿—</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// mandatory å‚æ•°è¯´æ˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>channel</span><span class=p>.</span><span class=na>basicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>mandatory</span><span class=p>,</span><span class=w> </span><span class=n>props</span><span class=p>,</span><span class=w> </span><span class=n>body</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>mandatory=false</strong>ï¼šè·¯ç”±å¤±è´¥æ—¶ï¼ŒBroker ä¸¢å¼ƒæ¶ˆæ¯</li><li><strong>mandatory=true</strong>ï¼šè·¯ç”±å¤±è´¥æ—¶ï¼ŒBroker é€šè¿‡ Basic.Return è¿”å›æ¶ˆæ¯ç»™ç”Ÿäº§è€…</li></ul><h3 id=returncallback-å®ç°>ReturnCallback å®ç°</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReturnCallbackProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessageWithReturnCallback</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>newConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>createChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ³¨å†Œ Return ç›‘å¬å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>addReturnListener</span><span class=p>((</span><span class=n>replyCode</span><span class=p>,</span><span class=w> </span><span class=n>replyText</span><span class=p>,</span><span class=w> </span><span class=n>exchangeName</span><span class=p>,</span><span class=w> </span><span class=n>routingKeyName</span><span class=p>,</span><span class=w> </span><span class=n>properties</span><span class=p>,</span><span class=w> </span><span class=n>body</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æ— æ³•è·¯ç”±ï¼Œè¢«é€€å›:&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  replyCode: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>replyCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  replyText: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>replyText</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  exchange: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>exchangeName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  routingKey: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>routingKeyName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  message: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>body</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¤„ç†é€€å›çš„æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handleReturnedMessage</span><span class=p>(</span><span class=n>replyCode</span><span class=p>,</span><span class=w> </span><span class=n>replyText</span><span class=p>,</span><span class=w> </span><span class=n>exchangeName</span><span class=p>,</span><span class=w> </span><span class=n>routingKeyName</span><span class=p>,</span><span class=w> </span><span class=n>body</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å‘é€æ¶ˆæ¯ï¼Œè®¾ç½® mandatory=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>basicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…è·¯ç”±ç»“æœ: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleReturnedMessage</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>replyCode</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>replyText</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>body</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ ¹æ®ä¸åŒçš„é”™è¯¯ç å¤„ç†é€€å›æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>replyCode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>312</span><span class=p>:</span><span class=w> </span><span class=c1>// NO_ROUTE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é˜Ÿåˆ—ï¼Œæ¶ˆæ¯è¢«é€€å›&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¯ä»¥å®ç°é‡è¯•æˆ–è®°å½•æ—¥å¿—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>313</span><span class=p>:</span><span class=w> </span><span class=c1>// NO_CONSUMERS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ²¡æœ‰æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è¢«é€€å›&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æœªçŸ¥é”™è¯¯ï¼Œæ¶ˆæ¯è¢«é€€å›: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>replyCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ä¸-confirm-çš„åŒºåˆ«>ä¸ Confirm çš„åŒºåˆ«</h3><div class=table-wrapper><table><thead><tr><th>æœºåˆ¶</th><th>ä½œç”¨</th><th>è§¦å‘æ—¶æœº</th></tr></thead><tbody><tr><td><strong>Confirm</strong></td><td>ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¿›å…¥ Broker</td><td>æ¶ˆæ¯åˆ°è¾¾ Broker å</td></tr><tr><td><strong>Return</strong></td><td>ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¢«è·¯ç”±åˆ°é˜Ÿåˆ—</td><td>æ¶ˆæ¯æ— æ³•è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶</td></tr><tr><td><strong>ç»„åˆä½¿ç”¨</strong></td><td>å®Œæ•´è¦†ç›–ç”Ÿäº§è€…å¯é æ€§</td><td>ä¸¤è€…ç»“åˆï¼Œæ‰èƒ½å®Œæ•´è¦†ç›–</td></tr></tbody></table></div><hr><h2 id=publisher-confirm-type-é…ç½®>publisher-confirm-type é…ç½®</h2><p>åœ¨ Spring AMQP ä¸­ï¼Œå¸¸è§é…ç½®æ˜¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>publisher-confirm-type</span><span class=p>:</span><span class=w> </span><span class=l>correlated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>publisher-returns</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç±»å‹è¯´æ˜>ç±»å‹è¯´æ˜</h3><div class=table-wrapper><table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th><th>ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>none</strong></td><td>å…³é—­ confirm</td><td>æ€§èƒ½ä¼˜å…ˆï¼Œå¯é æ€§è¦æ±‚ä¸é«˜</td></tr><tr><td><strong>simple</strong></td><td>åŒæ­¥é˜»å¡ç­‰å¾…ç¡®è®¤</td><td>ä½å¹¶å‘ï¼Œå¼ºä¸€è‡´æ€§è¦æ±‚</td></tr><tr><td><strong>correlated</strong></td><td>å¼‚æ­¥å›è°ƒç¡®è®¤ï¼ˆæ¨èï¼‰</td><td>é«˜å¹¶å‘ï¼Œé«˜ååé‡</td></tr></tbody></table></div><h3 id=spring-amqp-é…ç½®ç±»>Spring AMQP é…ç½®ç±»</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableRabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RabbitMQConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=nf>connectionFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setHost</span><span class=p>(</span><span class=s>&#34;localhost&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPort</span><span class=p>(</span><span class=n>5672</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setUsername</span><span class=p>(</span><span class=s>&#34;guest&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=s>&#34;guest&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setVirtualHost</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¼€å¯ç¡®è®¤æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherConfirmType</span><span class=p>(</span><span class=n>CachingConnectionFactory</span><span class=p>.</span><span class=na>ConfirmType</span><span class=p>.</span><span class=na>CORRELATED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherReturns</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=nf>rabbitTemplate</span><span class=p>(</span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>template</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=p>(</span><span class=n>connectionFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®ç¡®è®¤å›è°ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setConfirmCallback</span><span class=p>((</span><span class=n>correlationData</span><span class=p>,</span><span class=w> </span><span class=n>ack</span><span class=p>,</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>correlationData</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>cause</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®è¿”å›å›è°ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setReturnCallback</span><span class=p>((</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>replyCode</span><span class=p>,</span><span class=w> </span><span class=n>replyText</span><span class=p>,</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯è¢«é€€å›:&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  replyCode: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>replyCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  replyText: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>replyText</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  exchange: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>exchange</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  routingKey: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>routingKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;  message: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>template</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ä¸å¼‚æ­¥-confirm-çš„å…³ç³»>ä¸å¼‚æ­¥ Confirm çš„å…³ç³»</h3><p><code>correlated</code> å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨ RabbitMQ çš„ <strong>å¼‚æ­¥ ConfirmListener</strong>ï¼›</p><p>Spring å°è£…äº† <code>ConfirmCallback</code> æ¥å£ï¼ŒæŠŠ deliveryTag ä¸æ¶ˆæ¯å…³è”èµ·æ¥ï¼Œä¾¿äºå¼€å‘ã€‚</p><hr><h2 id=ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ>ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ</h2><p>å®Œæ•´çš„å¯é æ€§é“¾è·¯é€šå¸¸éœ€è¦ï¼š</p><h3 id=1-confirm--return-ç»„åˆ>1. Confirm + Return ç»„åˆ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReliableMessageProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>rabbitTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendReliableMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®¾ç½®æ¶ˆæ¯å±æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>MessageProperties</span><span class=w> </span><span class=n>properties</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MessageProperties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setDeliveryMode</span><span class=p>(</span><span class=n>MessageDeliveryMode</span><span class=p>.</span><span class=na>PERSISTENT</span><span class=p>);</span><span class=w> </span><span class=c1>// æŒä¹…åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setMessageId</span><span class=p>(</span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setTimestamp</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>messageObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Message</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=n>properties</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>convertAndSend</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>messageObj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å¯é æ¶ˆæ¯å·²å‘é€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å‘é€å¯é æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å®ç°é‡è¯•é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>retryMessage</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>retryMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å®ç°é‡è¯•é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;é‡è¯•å‘é€æ¶ˆæ¯: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-å¹‚ç­‰æ€§ä¸æ¶ˆæ¯å»é‡>2. å¹‚ç­‰æ€§ä¸æ¶ˆæ¯å»é‡</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>IdempotentMessageProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>rabbitTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendIdempotentMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;message:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messageId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>hasKey</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>convertAndSend</span><span class=p>(</span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è®°å½•æ¶ˆæ¯IDï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=s>&#34;sent&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Duration</span><span class=p>.</span><span class=na>ofHours</span><span class=p>(</span><span class=n>24</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å¹‚ç­‰æ¶ˆæ¯å·²å‘é€: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å‘é€å¹‚ç­‰æ¶ˆæ¯å¼‚å¸¸: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-æ¶ˆæ¯æŒä¹…åŒ–ä¸ç£ç›˜å†™å…¥>3. æ¶ˆæ¯æŒä¹…åŒ–ä¸ç£ç›˜å†™å…¥</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PersistentMessageConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DirectExchange</span><span class=w> </span><span class=nf>persistentExchange</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DirectExchange</span><span class=p>(</span><span class=s>&#34;persistent.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Queue</span><span class=w> </span><span class=nf>persistentQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>QueueBuilder</span><span class=p>.</span><span class=na>durable</span><span class=p>(</span><span class=s>&#34;persistent.queue&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withArgument</span><span class=p>(</span><span class=s>&#34;x-message-ttl&#34;</span><span class=p>,</span><span class=w> </span><span class=n>60000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Binding</span><span class=w> </span><span class=nf>persistentBinding</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>BindingBuilder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>persistentQueue</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=n>persistentExchange</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=s>&#34;persistent.key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=4-åº”ç”¨å±‚è¡¥å¿æœºåˆ¶>4. åº”ç”¨å±‚è¡¥å¿æœºåˆ¶</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CompensatingMessageProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>rabbitTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=o>&gt;</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>fixedRate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30000</span><span class=p>)</span><span class=w> </span><span class=c1>// 30ç§’æ£€æŸ¥ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkUnconfirmedMessages</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>currentTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>removeIf</span><span class=p>(</span><span class=n>entry</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getTimestamp</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>60000</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1åˆ†é’Ÿè¶…æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯è¶…æ—¶æœªç¡®è®¤ï¼Œå‡†å¤‡é‡å‘: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>retryMessage</span><span class=p>(</span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>retryMessage</span><span class=p>(</span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>convertAndSend</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>message</span><span class=p>.</span><span class=na>getExchange</span><span class=p>(),</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>message</span><span class=p>.</span><span class=na>getRoutingKey</span><span class=p>(),</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯é‡å‘æˆåŠŸ: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯é‡å‘å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=å®Œæ•´ä»£ç å®ç°>å®Œæ•´ä»£ç å®ç°</h2><h3 id=é¡¹ç›®ç»“æ„>é¡¹ç›®ç»“æ„</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rabbitmq-reliability/
</span></span><span class=line><span class=cl>â”œâ”€â”€ src/main/java/com/reliability/
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ config/
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ RabbitMQConfig.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ MessageConfig.java
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ producer/
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ ReliableMessageProducer.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ AsyncConfirmProducer.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ SyncConfirmProducer.java
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ consumer/
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ ReliableMessageConsumer.java
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ entity/
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ UnconfirmedMessage.java
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ service/
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ MessageReliabilityService.java
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ util/
</span></span><span class=line><span class=cl>â”‚       â””â”€â”€ MessageUtils.java
</span></span></code></pre></td></tr></table></div></div><h3 id=æ ¸å¿ƒé…ç½®ç±»>æ ¸å¿ƒé…ç½®ç±»</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableRabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RabbitMQConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=nf>connectionFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setHost</span><span class=p>(</span><span class=s>&#34;localhost&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPort</span><span class=p>(</span><span class=n>5672</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setUsername</span><span class=p>(</span><span class=s>&#34;guest&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=s>&#34;guest&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setVirtualHost</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿æ¥æ± é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setChannelCacheSize</span><span class=p>(</span><span class=n>50</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setChannelCheckoutTimeout</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¼€å¯ç¡®è®¤æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherConfirmType</span><span class=p>(</span><span class=n>CachingConnectionFactory</span><span class=p>.</span><span class=na>ConfirmType</span><span class=p>.</span><span class=na>CORRELATED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherReturns</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=nf>rabbitTemplate</span><span class=p>(</span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>template</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=p>(</span><span class=n>connectionFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®ç¡®è®¤å›è°ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setConfirmCallback</span><span class=p>((</span><span class=n>correlationData</span><span class=p>,</span><span class=w> </span><span class=n>ack</span><span class=p>,</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>correlationData</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: {}, cause: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>correlationData</span><span class=p>,</span><span class=w> </span><span class=n>cause</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®è¿”å›å›è°ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setReturnCallback</span><span class=p>((</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>replyCode</span><span class=p>,</span><span class=w> </span><span class=n>replyText</span><span class=p>,</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯è¢«é€€å›: replyCode={}, replyText={}, exchange={}, routingKey={}&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>replyCode</span><span class=p>,</span><span class=w> </span><span class=n>replyText</span><span class=p>,</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>routingKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>template</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// äº¤æ¢æœºé…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DirectExchange</span><span class=w> </span><span class=nf>reliableExchange</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DirectExchange</span><span class=p>(</span><span class=s>&#34;reliable.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Queue</span><span class=w> </span><span class=nf>reliableQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>QueueBuilder</span><span class=p>.</span><span class=na>durable</span><span class=p>(</span><span class=s>&#34;reliable.queue&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withArgument</span><span class=p>(</span><span class=s>&#34;x-message-ttl&#34;</span><span class=p>,</span><span class=w> </span><span class=n>300000</span><span class=p>)</span><span class=w> </span><span class=c1>// 5åˆ†é’ŸTTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withArgument</span><span class=p>(</span><span class=s>&#34;x-max-length&#34;</span><span class=p>,</span><span class=w> </span><span class=n>10000</span><span class=p>)</span><span class=w>   </span><span class=c1>// æœ€å¤§é•¿åº¦</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Binding</span><span class=w> </span><span class=nf>reliableBinding</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>BindingBuilder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>reliableQueue</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=n>reliableExchange</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=s>&#34;reliable.key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å¯é æ¶ˆæ¯ç”Ÿäº§è€…>å¯é æ¶ˆæ¯ç”Ÿäº§è€…</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReliableMessageProducer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RabbitTemplate</span><span class=w> </span><span class=n>rabbitTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=o>&gt;</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å‘é€å¯é æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendReliableMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ï¼ˆå¹‚ç­‰æ€§ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isMessageAlreadySent</span><span class=p>(</span><span class=n>messageId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 2. æ„å»ºæ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>MessageProperties</span><span class=w> </span><span class=n>properties</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MessageProperties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setDeliveryMode</span><span class=p>(</span><span class=n>MessageDeliveryMode</span><span class=p>.</span><span class=na>PERSISTENT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setMessageId</span><span class=p>(</span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setTimestamp</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>properties</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;application/json&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>messageObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Message</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=n>properties</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 3. è®°å½•æœªç¡®è®¤æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UnconfirmedMessage</span><span class=w> </span><span class=n>unconfirmedMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnconfirmedMessage</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;reliable.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;reliable.key&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>messageId</span><span class=p>,</span><span class=w> </span><span class=n>unconfirmedMessage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 4. å‘é€æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rabbitTemplate</span><span class=p>.</span><span class=na>convertAndSend</span><span class=p>(</span><span class=s>&#34;reliable.exchange&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;reliable.key&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageObj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 5. è®°å½•æ¶ˆæ¯IDåˆ°Redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>recordMessageId</span><span class=p>(</span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å¯é æ¶ˆæ¯å·²å‘é€: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;å‘é€å¯é æ¶ˆæ¯å¼‚å¸¸: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å®ç°é‡è¯•é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>retryMessage</span><span class=p>(</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ‰¹é‡å‘é€å¯é æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendBatchReliableMessages</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>messages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>messages</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;batch_&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;_&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendReliableMessage</span><span class=p>(</span><span class=n>messages</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>),</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isMessageAlreadySent</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;message:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messageId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>hasKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®°å½•æ¶ˆæ¯ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>recordMessageId</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;message:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>messageId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=s>&#34;sent&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Duration</span><span class=p>.</span><span class=na>ofHours</span><span class=p>(</span><span class=n>24</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é‡è¯•æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>retryMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w> </span><span class=c1>// ç­‰å¾…1ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendReliableMessage</span><span class=p>(</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;_retry&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯é‡è¯•æˆåŠŸ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯é‡è¯•å¤±è´¥: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–æœªç¡®è®¤æ¶ˆæ¯æ•°é‡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUnconfirmedCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ¸…ç†å·²ç¡®è®¤æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeConfirmedMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unconfirmedMessages</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=æ¶ˆæ¯æ¶ˆè´¹è€…>æ¶ˆæ¯æ¶ˆè´¹è€…</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReliableMessageConsumer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReliableMessageProducer</span><span class=w> </span><span class=n>messageProducer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@RabbitListener</span><span class=p>(</span><span class=n>queues</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;reliable.queue&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleReliableMessage</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=nd>@Header</span><span class=p>(</span><span class=n>AmqpHeaders</span><span class=p>.</span><span class=na>DELIVERY_TAG</span><span class=p>)</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>deliveryTag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>messageId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getMessageProperties</span><span class=p>().</span><span class=na>getMessageId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>messageBody</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>getBody</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ”¶åˆ°å¯é æ¶ˆæ¯: messageId={}, body={}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=p>,</span><span class=w> </span><span class=n>messageBody</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¤„ç†ä¸šåŠ¡é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>processMessage</span><span class=p>(</span><span class=n>messageBody</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span><span class=p>.</span><span class=na>basicAck</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä»ç”Ÿäº§è€…ä¸­ç§»é™¤å·²ç¡®è®¤æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>messageProducer</span><span class=p>.</span><span class=na>removeConfirmedMessage</span><span class=p>(</span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å¤„ç†å®Œæˆ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;å¤„ç†æ¶ˆæ¯å¼‚å¸¸: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>channel</span><span class=p>.</span><span class=na>basicNack</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>ioException</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;æ‹’ç»æ¶ˆæ¯å¼‚å¸¸: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ioException</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>ioException</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å¤„ç†ä¸šåŠ¡é€»è¾‘
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>messageBody</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ä¸šåŠ¡å¤„ç†å®Œæˆ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageBody</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;ä¸šåŠ¡å¤„ç†è¢«ä¸­æ–­: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=æ¶ˆæ¯å¯é æ€§æœåŠ¡>æ¶ˆæ¯å¯é æ€§æœåŠ¡</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MessageReliabilityService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReliableMessageProducer</span><span class=w> </span><span class=n>messageProducer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ£€æŸ¥æœªç¡®è®¤æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>fixedRate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30000</span><span class=p>)</span><span class=w> </span><span class=c1>// 30ç§’æ£€æŸ¥ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkUnconfirmedMessages</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>unconfirmedCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>messageProducer</span><span class=p>.</span><span class=na>getUnconfirmedCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unconfirmedCount</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;å½“å‰æœ‰ {} æ¡æœªç¡®è®¤æ¶ˆæ¯&#34;</span><span class=p>,</span><span class=w> </span><span class=n>unconfirmedCount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ¸…ç†è¿‡æœŸçš„æ¶ˆæ¯è®°å½•
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>fixedRate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3600000</span><span class=p>)</span><span class=w> </span><span class=c1>// 1å°æ—¶æ¸…ç†ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cleanupExpiredMessages</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>keys</span><span class=p>(</span><span class=s>&#34;message:*&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>keys</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>keys</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>keys</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ¸…ç†è¿‡æœŸæ¶ˆæ¯è®°å½•: {} æ¡&#34;</span><span class=p>,</span><span class=w> </span><span class=n>keys</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;æ¸…ç†è¿‡æœŸæ¶ˆæ¯è®°å½•å¼‚å¸¸: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–æ¶ˆæ¯ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getMessageStatistics</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stats</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;unconfirmedCount&#34;</span><span class=p>,</span><span class=w> </span><span class=n>messageProducer</span><span class=p>.</span><span class=na>getUnconfirmedCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stats</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;timestamp&#34;</span><span class=p>,</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>stats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=æœ€ä½³å®è·µä¸æ€»ç»“>æœ€ä½³å®è·µä¸æ€»ç»“</h2><h3 id=1-æ€§èƒ½ä¼˜åŒ–å»ºè®®>1. æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è¿æ¥æ± é…ç½®ä¼˜åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PerformanceConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=nf>optimizedConnectionFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CachingConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CachingConnectionFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿æ¥æ± é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setChannelCacheSize</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w> </span><span class=c1>// å¢åŠ é€šé“ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setChannelCheckoutTimeout</span><span class=p>(</span><span class=n>5000</span><span class=p>);</span><span class=w> </span><span class=c1>// å‡å°‘è¶…æ—¶æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç¡®è®¤æ¨¡å¼é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherConfirmType</span><span class=p>(</span><span class=n>CachingConnectionFactory</span><span class=p>.</span><span class=na>ConfirmType</span><span class=p>.</span><span class=na>CORRELATED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setPublisherReturns</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-ç›‘æ§å’Œå‘Šè­¦>2. ç›‘æ§å’Œå‘Šè­¦</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MessageMonitor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReliableMessageProducer</span><span class=w> </span><span class=n>messageProducer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicLong</span><span class=w> </span><span class=n>successCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicLong</span><span class=w> </span><span class=n>failureCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@EventListener</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessageSuccess</span><span class=p>(</span><span class=n>MessageSuccessEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>successCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ€»æ•°: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>successCount</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@EventListener</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessageFailure</span><span class=p>(</span><span class=n>MessageFailureEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>failureCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ€»æ•°: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>failureCount</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>fixedRate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>60000</span><span class=p>)</span><span class=w> </span><span class=c1>// æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>logStatistics</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>successCount</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>failure</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>failureCount</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>total</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>failure</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>total</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>double</span><span class=w> </span><span class=n>successRate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>double</span><span class=p>)</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>total</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ¶ˆæ¯å‘é€ç»Ÿè®¡ - æˆåŠŸ: {}, å¤±è´¥: {}, æˆåŠŸç‡: {:.2f}%&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>success</span><span class=p>,</span><span class=w> </span><span class=n>failure</span><span class=p>,</span><span class=w> </span><span class=n>successRate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3-æ€»ç»“>3. æ€»ç»“</h3><h4 id=confirm-æœºåˆ¶è§£å†³äº†æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾-brokerçš„é—®é¢˜>Confirm æœºåˆ¶è§£å†³äº†"æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ Broker"çš„é—®é¢˜</h4><ul><li><strong>åŒæ­¥æ¨¡å¼</strong>ï¼šç®€å•ä½†ä½æ•ˆï¼Œé€‚åˆä½å¹¶å‘åœºæ™¯</li><li><strong>å¼‚æ­¥æ¨¡å¼</strong>ï¼šé«˜æ•ˆä¸”å¸¸ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯</li></ul><h4 id=return-æœºåˆ¶è§£å†³äº†æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—çš„é—®é¢˜>Return æœºåˆ¶è§£å†³äº†"æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—"çš„é—®é¢˜</h4><ul><li>ä¸ Confirm æœºåˆ¶ç»“åˆä½¿ç”¨</li><li>ç¡®ä¿æ¶ˆæ¯å®Œæ•´æŠ•é€’åˆ°ç›®æ ‡é˜Ÿåˆ—</li></ul><h4 id=deliverytag--multiple-æ„æˆäº†-confirm-çš„æ ¸å¿ƒé€»è¾‘>deliveryTag + multiple æ„æˆäº† Confirm çš„æ ¸å¿ƒé€»è¾‘</h4><ul><li><strong>deliveryTag</strong>ï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯†</li><li><strong>multiple</strong>ï¼šæ‰¹é‡ç¡®è®¤æœºåˆ¶</li><li><strong>æœªç¡®è®¤æ¶ˆæ¯Map</strong>ï¼šç®¡ç†å¾…ç¡®è®¤æ¶ˆæ¯</li></ul><h4 id=spring-amqp-çš„-publisher-confirm-typecorrelated-å°±æ˜¯å¼‚æ­¥-confirm-çš„å°è£…>Spring AMQP çš„ publisher-confirm-type=correlated å°±æ˜¯å¼‚æ­¥ Confirm çš„å°è£…</h4><ul><li>ç®€åŒ–äº†å¼‚æ­¥ç¡®è®¤çš„ä½¿ç”¨</li><li>æä¾›äº†ç»Ÿä¸€çš„å›è°ƒæ¥å£</li></ul><h4 id=ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¼š-confirm--return--æ¶ˆæ¯æŒä¹…åŒ–--åº”ç”¨å±‚è¡¥å¿-ç»„åˆä½¿ç”¨>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼š Confirm + Return + æ¶ˆæ¯æŒä¹…åŒ– + åº”ç”¨å±‚è¡¥å¿ ç»„åˆä½¿ç”¨</h4><ul><li><strong>Confirmæœºåˆ¶</strong>ï¼šç¡®ä¿æ¶ˆæ¯åˆ°è¾¾Broker</li><li><strong>Returnæœºåˆ¶</strong>ï¼šç¡®ä¿æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—</li><li><strong>æ¶ˆæ¯æŒä¹…åŒ–</strong>ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±</li><li><strong>åº”ç”¨å±‚è¡¥å¿</strong>ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µ</li><li><strong>å¹‚ç­‰æ€§ä¿è¯</strong>ï¼šé¿å…é‡å¤å¤„ç†</li></ul><p>é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œå®Œæ•´ä»£ç å®ç°ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹RabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚å’Œæ€§èƒ½è¦æ±‚æ¥é€‰æ‹©åˆé€‚çš„ç¡®è®¤æ¨¡å¼ï¼Œå¹¶é…åˆå…¶ä»–å¯é æ€§æœºåˆ¶æ¥æ„å»ºçœŸæ­£å¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿã€‚</p><hr><p><em>æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†RabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†å’Œå®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿã€‚</em></p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/rabbitmq/>RabbitMQ</a>
<a href=/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/>æ¶ˆæ¯é˜Ÿåˆ—</a>
<a href=/tags/%E5%8F%AF%E9%9D%A0%E6%80%A7/>å¯é æ€§</a>
<a href=/tags/%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4/>ç”Ÿäº§è€…ç¡®è®¤</a>
<a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/>åˆ†å¸ƒå¼ç³»ç»Ÿ</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%90%ABredis%E9%A2%84%E6%89%A3%E5%BA%93%E5%AD%98%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0/><div class=article-details><h2 class=article-title>å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰</h2></div></a></article><article><a href=/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E-redis-%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E5%85%A8%E8%A7%A3%E6%9E%90/><div class=article-details><h2 class=article-title>æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ</h2></div></a></article><article><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/><div class=article-details><h2 class=article-title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 Cecilia-å¡è¥¿è‰å¨…</section><section class=powerby>Never give up<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>