<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="æ·±å…¥è§£æSpring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°åŸç†ï¼Œè¯¦è§£BaseContextã€HandlerMethodã€HttpServletRequestç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œç»“åˆè´­ç‰©è½¦é¡¹ç›®å®æˆ˜ä»£ç "><title>Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof</title><link rel=canonical href=https://Yin123-ybh.github.io/p/spring-boot-jwt-%E4%B8%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E8%AF%A6%E8%A7%A3basecontexthandlermethodhttpservletrequest-%E4%B8%8E-instanceof/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof"><meta property='og:description' content="æ·±å…¥è§£æSpring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°åŸç†ï¼Œè¯¦è§£BaseContextã€HandlerMethodã€HttpServletRequestç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œç»“åˆè´­ç‰©è½¦é¡¹ç›®å®æˆ˜ä»£ç "><meta property='og:url' content='https://Yin123-ybh.github.io/p/spring-boot-jwt-%E4%B8%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E8%AF%A6%E8%A7%A3basecontexthandlermethodhttpservletrequest-%E4%B8%8E-instanceof/'><meta property='og:site_name' content='Cecilia-å¡è¥¿è‰å¨…'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring Boot'><meta property='article:tag' content='JWT'><meta property='article:tag' content='æ‹¦æˆªå™¨'><meta property='article:tag' content='ThreadLocal'><meta property='article:tag' content='HandlerMethod'><meta property='article:tag' content='HttpServletRequest'><meta property='article:published_time' content='2025-01-27T10:00:00+08:00'><meta property='article:modified_time' content='2025-01-27T10:00:00+08:00'><meta name=twitter:title content="Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof"><meta name=twitter:description content="æ·±å…¥è§£æSpring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°åŸç†ï¼Œè¯¦è§£BaseContextã€HandlerMethodã€HttpServletRequestç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œç»“åˆè´­ç‰©è½¦é¡¹ç›®å®æˆ˜ä»£ç "><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_8636e4c1b17bd1a4.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ§‘â€ğŸ’»</span></figure><div class=site-meta><h1 class=site-name><a href=/>Cecilia-å¡è¥¿è‰å¨…</a></h1><h2 class=site-description>Welcome to my website</h2></div></header><ol class=menu-social><li><a href=https://github.com/Yin123-ybh target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://Yin123-ybh.github.io/ selected>English</option><option value=https://Yin123-ybh.github.io/zh-cn/>ç®€ä½“ä¸­æ–‡</option><option value=https://Yin123-ybh.github.io/ar/>Ø¹Ø±Ø¨ÙŠ</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#-ç›®å½•>ğŸ“‹ ç›®å½•</a></li><li><a href=#1-httpservletrequest-æ˜¯ä»€ä¹ˆ>1. HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ</a><ol><li><a href=#-æ ¸å¿ƒåŠŸèƒ½>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½</a></li><li><a href=#-å®é™…åº”ç”¨åœºæ™¯>ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯</a></li></ol></li><li><a href=#2-controller-æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦-httpservletrequest>2. Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ</a><ol><li><a href=#-ä¸éœ€è¦-httpservletrequest-çš„æƒ…å†µ>âœ… ä¸éœ€è¦ HttpServletRequest çš„æƒ…å†µ</a></li><li><a href=#-éœ€è¦-httpservletrequest-çš„æƒ…å†µ>âŒ éœ€è¦ HttpServletRequest çš„æƒ…å†µ</a></li><li><a href=#-ä½¿ç”¨åœºæ™¯æ€»ç»“>ğŸ¯ ä½¿ç”¨åœºæ™¯æ€»ç»“</a></li></ol></li><li><a href=#3-æ³¨é‡Šè§£æä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·id>3. æ³¨é‡Šè§£æï¼š&ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID&rdquo;</a><ol><li><a href=#-æ³¨é‡Šå«ä¹‰è§£æ>ğŸ“ æ³¨é‡Šå«ä¹‰è§£æ</a></li><li><a href=#-å®Œæ•´æµç¨‹ç¤ºæ„>ğŸ”„ å®Œæ•´æµç¨‹ç¤ºæ„</a><ol><li><a href=#æ–¹æ¡ˆ1asciiæµç¨‹å›¾hugoå…¼å®¹>æ–¹æ¡ˆ1ï¼šASCIIæµç¨‹å›¾ï¼ˆHugoå…¼å®¹ï¼‰</a></li><li><a href=#æ–¹æ¡ˆ2ä»£ç å—å½¢å¼æ¨è>æ–¹æ¡ˆ2ï¼šä»£ç å—å½¢å¼ï¼ˆæ¨èï¼‰</a></li></ol></li></ol></li><li><a href=#4-jwttokenuserinterceptor-æ‹¦æˆªå™¨è¯¦è§£>4. JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£</a><ol><li><a href=#-å®Œæ•´æ‹¦æˆªå™¨å®ç°>ğŸ—ï¸ å®Œæ•´æ‹¦æˆªå™¨å®ç°</a></li><li><a href=#-ä»£ç é€è¡Œè§£æ>ğŸ” ä»£ç é€è¡Œè§£æ</a><ol><li><a href=#æ­¥éª¤1åˆ¤æ–­è¯·æ±‚ç±»å‹>æ­¥éª¤1ï¼šåˆ¤æ–­è¯·æ±‚ç±»å‹</a></li><li><a href=#æ­¥éª¤2è·å–-jwt-token>æ­¥éª¤2ï¼šè·å– JWT Token</a></li><li><a href=#æ­¥éª¤3å¤„ç†-bearer-å‰ç¼€>æ­¥éª¤3ï¼šå¤„ç† Bearer å‰ç¼€</a></li><li><a href=#æ­¥éª¤4jwt-è§£æä¸éªŒè¯>æ­¥éª¤4ï¼šJWT è§£æä¸éªŒè¯</a></li><li><a href=#æ­¥éª¤5ä¸Šä¸‹æ–‡å­˜å‚¨>æ­¥éª¤5ï¼šä¸Šä¸‹æ–‡å­˜å‚¨</a></li></ol></li></ol></li><li><a href=#5-long-userid--longvalueofclaimsgetuseridtostring-è§£æ>5. Long userId = Long.valueOf(claims.get(&ldquo;userId&rdquo;).toString()); è§£æ</a><ol><li><a href=#-ç±»å‹è½¬æ¢è¿‡ç¨‹>ğŸ”„ ç±»å‹è½¬æ¢è¿‡ç¨‹</a></li><li><a href=#-æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ>âš ï¸ æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a><ol><li><a href=#é—®é¢˜1ç±»å‹è½¬æ¢å¼‚å¸¸>é—®é¢˜1ï¼šç±»å‹è½¬æ¢å¼‚å¸¸</a></li><li><a href=#é—®é¢˜2ç©ºå€¼å¤„ç†>é—®é¢˜2ï¼šç©ºå€¼å¤„ç†</a></li></ol></li><li><a href=#-æœ€ä½³å®è·µ>ğŸ¯ æœ€ä½³å®è·µ</a></li></ol></li><li><a href=#6-basecontext-æ˜¯ä»€ä¹ˆ>6. BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ</a><ol><li><a href=#-basecontext-å®Œæ•´å®ç°>ğŸ—ï¸ BaseContext å®Œæ•´å®ç°</a></li><li><a href=#-threadlocal-åŸç†>ğŸ§µ ThreadLocal åŸç†</a><ol><li><a href=#ä¸ºä»€ä¹ˆä½¿ç”¨-threadlocal>ä¸ºä»€ä¹ˆä½¿ç”¨ ThreadLocalï¼Ÿ</a></li><li><a href=#threadlocal-å†…å­˜æ¨¡å‹>ThreadLocal å†…å­˜æ¨¡å‹</a></li></ol></li><li><a href=#-å®é™…ä½¿ç”¨åœºæ™¯>ğŸ”§ å®é™…ä½¿ç”¨åœºæ™¯</a><ol><li><a href=#controller-å±‚ä½¿ç”¨>Controller å±‚ä½¿ç”¨</a></li><li><a href=#service-å±‚ä½¿ç”¨>Service å±‚ä½¿ç”¨</a></li></ol></li><li><a href=#-å†…å­˜æ³„æ¼é˜²æŠ¤>âš ï¸ å†…å­˜æ³„æ¼é˜²æŠ¤</a><ol><li><a href=#é—®é¢˜threadlocal-å†…å­˜æ³„æ¼>é—®é¢˜ï¼šThreadLocal å†…å­˜æ³„æ¼</a></li><li><a href=#è§£å†³æ–¹æ¡ˆæ‹¦æˆªå™¨åå¤„ç†>è§£å†³æ–¹æ¡ˆï¼šæ‹¦æˆªå™¨åå¤„ç†</a></li></ol></li></ol></li><li><a href=#7-åˆ¤æ–­-handler-æ˜¯å¦æ˜¯-controller-æ–¹æ³•>7. åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³•</a><ol><li><a href=#-handlermethod-è¯¦è§£>ğŸ” HandlerMethod è¯¦è§£</a><ol><li><a href=#spring-mvc-è¯·æ±‚å¤„ç†æµç¨‹>Spring MVC è¯·æ±‚å¤„ç†æµç¨‹</a></li><li><a href=#handlermethod-vs-resourcehttprequesthandler>HandlerMethod vs ResourceHttpRequestHandler</a></li></ol></li><li><a href=#-å®é™…åº”ç”¨åœºæ™¯-1>ğŸ¯ å®é™…åº”ç”¨åœºæ™¯</a><ol><li><a href=#åœºæ™¯1åªæ‹¦æˆª-controller-æ–¹æ³•>åœºæ™¯1ï¼šåªæ‹¦æˆª Controller æ–¹æ³•</a></li><li><a href=#åœºæ™¯2è®°å½•æ‰€æœ‰è¯·æ±‚>åœºæ™¯2ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚</a></li></ol></li></ol></li><li><a href=#8-instanceof-æ˜¯ä»€ä¹ˆ>8. instanceof æ˜¯ä»€ä¹ˆï¼Ÿ</a><ol><li><a href=#-instanceof-è¯­æ³•è¯¦è§£>ğŸ”§ instanceof è¯­æ³•è¯¦è§£</a><ol><li><a href=#åŸºæœ¬è¯­æ³•>åŸºæœ¬è¯­æ³•</a></li><li><a href=#è¿”å›å€¼>è¿”å›å€¼</a></li></ol></li><li><a href=#-å®é™…ç¤ºä¾‹>ğŸ“ å®é™…ç¤ºä¾‹</a><ol><li><a href=#ç¤ºä¾‹1åŸºæœ¬ç±»å‹åˆ¤æ–­>ç¤ºä¾‹1ï¼šåŸºæœ¬ç±»å‹åˆ¤æ–­</a></li><li><a href=#ç¤ºä¾‹2æ¥å£åˆ¤æ–­>ç¤ºä¾‹2ï¼šæ¥å£åˆ¤æ–­</a></li><li><a href=#ç¤ºä¾‹3null-å¤„ç†>ç¤ºä¾‹3ï¼šnull å¤„ç†</a></li></ol></li><li><a href=#-åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨>ğŸ¯ åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨</a><ol><li><a href=#åˆ¤æ–­-handler-ç±»å‹>åˆ¤æ–­ Handler ç±»å‹</a></li><li><a href=#è·å–æ–¹æ³•ä¿¡æ¯>è·å–æ–¹æ³•ä¿¡æ¯</a></li></ol></li></ol></li><li><a href=#9-å®Œæ•´é¡¹ç›®å®æˆ˜>9. å®Œæ•´é¡¹ç›®å®æˆ˜</a><ol><li><a href=#-é¡¹ç›®ç»“æ„>ğŸ—ï¸ é¡¹ç›®ç»“æ„</a></li><li><a href=#-é…ç½®æ–‡ä»¶>âš™ï¸ é…ç½®æ–‡ä»¶</a><ol><li><a href=#applicationyml>application.yml</a></li><li><a href=#jwtpropertiesjava>JwtProperties.java</a></li></ol></li><li><a href=#-æ‹¦æˆªå™¨é…ç½®>ğŸ”§ æ‹¦æˆªå™¨é…ç½®</a><ol><li><a href=#webmvcconfigurationjava>WebMvcConfiguration.java</a></li></ol></li><li><a href=#-å®é™…ä½¿ç”¨ç¤ºä¾‹>ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹</a><ol><li><a href=#ç®¡ç†ç«¯æ§åˆ¶å™¨>ç®¡ç†ç«¯æ§åˆ¶å™¨</a></li></ol></li></ol></li><li><a href=#10-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹>10. æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</a><ol><li><a href=#-æœ€ä½³å®è·µ-1>âœ… æœ€ä½³å®è·µ</a><ol><li><a href=#1-å®‰å…¨çš„jwtå¤„ç†>1. å®‰å…¨çš„JWTå¤„ç†</a></li><li><a href=#2-å®Œæ•´çš„æ‹¦æˆªå™¨å®ç°>2. å®Œæ•´çš„æ‹¦æˆªå™¨å®ç°</a></li><li><a href=#3-å¼‚å¸¸å¤„ç†>3. å¼‚å¸¸å¤„ç†</a></li></ol></li><li><a href=#-æ³¨æ„äº‹é¡¹>âš ï¸ æ³¨æ„äº‹é¡¹</a><ol><li><a href=#1-å†…å­˜æ³„æ¼é˜²æŠ¤>1. å†…å­˜æ³„æ¼é˜²æŠ¤</a></li><li><a href=#2-çº¿ç¨‹å®‰å…¨é—®é¢˜>2. çº¿ç¨‹å®‰å…¨é—®é¢˜</a></li><li><a href=#3-jwtå¯†é’¥ç®¡ç†>3. JWTå¯†é’¥ç®¡ç†</a></li></ol></li></ol></li><li><a href=#11-æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„>11. æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„</a><ol><li><a href=#-å®Œæ•´è¯·æ±‚æµç¨‹å›¾>ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹å›¾</a><ol><li><a href=#æ—¶åºå›¾asciiç‰ˆæœ¬>æ—¶åºå›¾ï¼ˆASCIIç‰ˆæœ¬ï¼‰</a></li><li><a href=#è¯¦ç»†æ­¥éª¤è¯´æ˜>è¯¦ç»†æ­¥éª¤è¯´æ˜</a></li></ol></li><li><a href=#-æ ¸å¿ƒæ¦‚å¿µæ€»ç»“>ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ€»ç»“</a></li><li><a href=#-æŠ€æœ¯è¦ç‚¹>ğŸ¯ æŠ€æœ¯è¦ç‚¹</a></li><li><a href=#-é¡¹ç›®ä¼˜åŠ¿>ğŸš€ é¡¹ç›®ä¼˜åŠ¿</a></li></ol></li><li><a href=#-hugoåšå®¢ä½¿ç”¨è¯´æ˜>ğŸ“ Hugoåšå®¢ä½¿ç”¨è¯´æ˜</a><ol><li><a href=#-å·²ä¼˜åŒ–çš„å†…å®¹>âœ… å·²ä¼˜åŒ–çš„å†…å®¹</a></li><li><a href=#-hugoé…ç½®å»ºè®®>ğŸ”§ Hugoé…ç½®å»ºè®®</a></li><li><a href=#-ä¸»é¢˜å…¼å®¹æ€§>ğŸ¨ ä¸»é¢˜å…¼å®¹æ€§</a></li><li><a href=#-ç§»åŠ¨ç«¯ä¼˜åŒ–>ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/>åç«¯å¼€å‘
</a><a href=/categories/spring-boot/>Spring Boot</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/spring-boot-jwt-%E4%B8%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E8%AF%A6%E8%A7%A3basecontexthandlermethodhttpservletrequest-%E4%B8%8E-instanceof/>Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof</a></h2><h3 class=article-subtitle>æ·±å…¥è§£æSpring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°åŸç†ï¼Œè¯¦è§£BaseContextã€HandlerMethodã€HttpServletRequestç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œç»“åˆè´­ç‰©è½¦é¡¹ç›®å®æˆ˜ä»£ç </h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-01-27</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>15 minute read</time></div></footer></div></header><section class=article-content><h1 id=spring-boot-jwt-ä¸æ‹¦æˆªå™¨è¯¦è§£basecontexthandlermethodhttpservletrequest-ä¸-instanceof>Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof</h1><p>åœ¨å¼€å‘ Java Web é¡¹ç›®æ—¶ï¼Œç»å¸¸ä¼šç”¨åˆ° JWT é‰´æƒã€æ‹¦æˆªå™¨ä»¥åŠè¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†ã€‚æœ¬æ–‡ç»“åˆä¸€ä¸ªå’–å•¡è´­ç‰©è½¦é¡¹ç›®ï¼Œè¯¦ç»†è®²è§£ç›¸å…³æ¦‚å¿µå’Œä»£ç å®ç°ã€‚</p><h2 id=-ç›®å½•>ğŸ“‹ ç›®å½•</h2><ul><li><a class=link href=#1-httpservletrequest-%e6%98%af%e4%bb%80%e4%b9%88>HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a class=link href=#2-controller-%e6%96%b9%e6%b3%95%e4%b8%ba%e4%bb%80%e4%b9%88%e6%9c%89%e6%97%b6%e9%9c%80%e8%a6%81-httpservletrequest>Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ</a></li><li><a class=link href=#3-%e6%b3%a8%e9%87%8a%e8%a7%a3%e6%9e%90%e4%bb%8e%e8%af%b7%e6%b1%82%e5%a4%b4%e4%b8%ad%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7id>æ³¨é‡Šè§£æï¼š&ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID&rdquo;</a></li><li><a class=link href=#4-jwttokenuserinterceptor-%e6%8b%a6%e6%88%aa%e5%99%a8%e8%af%a6%e8%a7%a3>JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£</a></li><li><a class=link href=#5-long-userid-longvalueofclaimsgetuseridtostring-%e8%a7%a3%e6%9e%90>Long userId = Long.valueOf(claims.get(&ldquo;userId&rdquo;).toString()); è§£æ</a></li><li><a class=link href=#6-basecontext-%e6%98%af%e4%bb%80%e4%b9%88>BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a class=link href=#7-%e5%88%a4%e6%96%ad-handler-%e6%98%af%e5%90%a6%e6%98%af-controller-%e6%96%b9%e6%b3%95>åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³•</a></li><li><a class=link href=#8-instanceof-%e6%98%af%e4%bb%80%e4%b9%88>instanceof æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a class=link href=#9-%e5%ae%8c%e6%95%b4%e9%a1%b9%e7%9b%ae%e5%ae%9e%e6%88%98>å®Œæ•´é¡¹ç›®å®æˆ˜</a></li><li><a class=link href=#10-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9>æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</a></li><li><a class=link href=#11-%e6%80%bb%e7%bb%93%e4%b8%8e%e6%b5%81%e7%a8%8b%e5%9b%be%e7%a4%ba%e6%84%8f>æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„</a></li></ul><h2 id=1-httpservletrequest-æ˜¯ä»€ä¹ˆ>1. HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><code>HttpServletRequest</code> æ˜¯ Java Servlet API æä¾›çš„æ¥å£ï¼Œç”¨æ¥å°è£…å®¢æˆ·ç«¯å‘ç»™æœåŠ¡å™¨çš„è¯·æ±‚ä¿¡æ¯ã€‚</p><h3 id=-æ ¸å¿ƒåŠŸèƒ½>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è·å–è¯·æ±‚æ–¹å¼ã€è·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getMethod</span><span class=p>()</span><span class=w>       </span><span class=c1>// GET / POST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>()</span><span class=w>   </span><span class=c1>// /cart/list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚å¤´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;User-Agent&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚å‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getParameterMap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–è¯·æ±‚ä½“ï¼ˆPOST JSON æˆ–è¡¨å•ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getReader</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å®¢æˆ·ç«¯ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getRemoteAddr</span><span class=p>()</span><span class=w>  </span><span class=c1>// IPåœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;User-Agent&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// æµè§ˆå™¨ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–ä¼šè¯ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>getSession</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-å®é™…åº”ç”¨åœºæ™¯>ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯</h3><p>åœ¨æˆ‘ä»¬çš„å’–å•¡é¡¹ç›®ä¸­ï¼Œ<code>HttpServletRequest</code> ä¸»è¦ç”¨äºï¼š</p><ol><li><strong>JWT Token è·å–</strong>ï¼šä» <code>Authorization</code> è¯·æ±‚å¤´ä¸­æå– JWT Token</li><li><strong>ç”¨æˆ·èº«ä»½è¯†åˆ«</strong>ï¼šè§£æ Token è·å–ç”¨æˆ· ID</li><li><strong>è¯·æ±‚æ—¥å¿—è®°å½•</strong>ï¼šè®°å½•å®¢æˆ·ç«¯ IPã€User-Agent ç­‰ä¿¡æ¯</li><li><strong>è·¨åŸŸå¤„ç†</strong>ï¼šè·å– Origin è¯·æ±‚å¤´è¿›è¡Œè·¨åŸŸéªŒè¯</li></ol><h2 id=2-controller-æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦-httpservletrequest>2. Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ</h2><h3 id=-ä¸éœ€è¦-httpservletrequest-çš„æƒ…å†µ>âœ… ä¸éœ€è¦ HttpServletRequest çš„æƒ…å†µ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åªéœ€è¦ä¸šåŠ¡å‚æ•°ï¼ŒSpring è‡ªåŠ¨ç»‘å®š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getProduct</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>productService</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>createProduct</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>ProductDTO</span><span class=w> </span><span class=n>productDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>productService</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>productDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-éœ€è¦-httpservletrequest-çš„æƒ…å†µ>âŒ éœ€è¦ HttpServletRequest çš„æƒ…å†µ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/user&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtProperties</span><span class=w> </span><span class=n>jwtProperties</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * éœ€è¦è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/profile&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>UserProfile</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getProfile</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCurrentUserId</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>getProfile</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ä»è¯·æ±‚ä¸­è·å–å½“å‰ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>getCurrentUserId</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>.</span><span class=na>parseJWT</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserSecretKey</span><span class=p>(),</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>).</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;è§£ætokenå¤±è´¥&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;æ— æ•ˆçš„token&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-ä½¿ç”¨åœºæ™¯æ€»ç»“>ğŸ¯ ä½¿ç”¨åœºæ™¯æ€»ç»“</h3><div class=table-wrapper><table><thead><tr><th>åœºæ™¯</th><th>æ˜¯å¦éœ€è¦ HttpServletRequest</th><th>åŸå› </th></tr></thead><tbody><tr><td>è·å–è¯·æ±‚å¤´ä¿¡æ¯</td><td>âœ… éœ€è¦</td><td>å¦‚ JWT Tokenã€User-Agent</td></tr><tr><td>è·å–å®¢æˆ·ç«¯ IP</td><td>âœ… éœ€è¦</td><td>å®‰å…¨å®¡è®¡ã€é™æµ</td></tr><tr><td>è·å– Session ä¿¡æ¯</td><td>âœ… éœ€è¦</td><td>ä¼šè¯ç®¡ç†</td></tr><tr><td>è·å– Cookie</td><td>âœ… éœ€è¦</td><td>çŠ¶æ€ä¿æŒ</td></tr><tr><td>çº¯ä¸šåŠ¡å‚æ•°å¤„ç†</td><td>âŒ ä¸éœ€è¦</td><td>Spring è‡ªåŠ¨ç»‘å®š</td></tr></tbody></table></div><h2 id=3-æ³¨é‡Šè§£æä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·id>3. æ³¨é‡Šè§£æï¼š&ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID&rdquo;</h2><h3 id=-æ³¨é‡Šå«ä¹‰è§£æ>ğŸ“ æ³¨é‡Šå«ä¹‰è§£æ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·IDï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„JWTå®ç°æ¥è·å–ï¼‰</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªæ³¨é‡Šçš„å«ä¹‰æ˜¯ï¼š</p><ol><li><strong>ç”¨æˆ·ç™»å½•æµç¨‹</strong>ï¼šç”¨æˆ·ç™»å½•åï¼Œå‰ç«¯ä¼šæ‹¿åˆ°ä¸€ä¸ª JWT Token</li><li><strong>Token ä¼ é€’</strong>ï¼šå‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå°† Token æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼ˆ<code>Authorization: Bearer &lt;token></code>ï¼‰</li><li><strong>åç«¯è§£æ</strong>ï¼šåç«¯è§£æ JWT Token è·å– <code>userId</code></li><li><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼šç›®å‰ä»£ç ç›´æ¥ä»è¯·æ±‚å¤´å– <code>userId</code>ï¼Œåœ¨çœŸå®é¡¹ç›®ä¸­è¦è§£æ JWT Token</li></ol><h3 id=-å®Œæ•´æµç¨‹ç¤ºæ„>ğŸ”„ å®Œæ•´æµç¨‹ç¤ºæ„</h3><h4 id=æ–¹æ¡ˆ1asciiæµç¨‹å›¾hugoå…¼å®¹>æ–¹æ¡ˆ1ï¼šASCIIæµç¨‹å›¾ï¼ˆHugoå…¼å®¹ï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚  å‰ç«¯   â”‚â”€â”€â”€â–¶â”‚  åç«¯   â”‚â”€â”€â”€â–¶â”‚ JWTå·¥å…· â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>     â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚ 1.ç™»å½•è¯·æ±‚    â”‚              â”‚
</span></span><span class=line><span class=cl>     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚ 2.ç”ŸæˆToken  â”‚
</span></span><span class=line><span class=cl>     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚ 3.è¿”å›Token  â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span></span><span class=line><span class=cl>     â”‚ 4.è¿”å›Token   â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚ å­˜å‚¨åˆ°localStorage          â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚ 5.ä¸šåŠ¡è¯·æ±‚+Token            â”‚
</span></span><span class=line><span class=cl>     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚ 6.è§£æToken   â”‚
</span></span><span class=line><span class=cl>     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚ 7.è¿”å›Claims â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span></span><span class=line><span class=cl>     â”‚              â”‚ 8.æå–userId â”‚
</span></span><span class=line><span class=cl>     â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚ 9.è¿”å›ä¸šåŠ¡æ•°æ®â”‚              â”‚
</span></span><span class=line><span class=cl>     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
</span></span></code></pre></td></tr></table></div></div><h4 id=æ–¹æ¡ˆ2ä»£ç å—å½¢å¼æ¨è>æ–¹æ¡ˆ2ï¼šä»£ç å—å½¢å¼ï¼ˆæ¨èï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>JWTè®¤è¯æµç¨‹ï¼š
</span></span><span class=line><span class=cl>1. å‰ç«¯å‘é€ç™»å½•è¯·æ±‚
</span></span><span class=line><span class=cl>2. åç«¯éªŒè¯ç”¨æˆ·ä¿¡æ¯
</span></span><span class=line><span class=cl>3. åç«¯ç”ŸæˆJWT Token
</span></span><span class=line><span class=cl>4. åç«¯è¿”å›Tokenç»™å‰ç«¯
</span></span><span class=line><span class=cl>5. å‰ç«¯å­˜å‚¨Tokenåˆ°localStorage
</span></span><span class=line><span class=cl>6. å‰ç«¯å‘é€ä¸šåŠ¡è¯·æ±‚ï¼ˆæºå¸¦Authorizationå¤´ï¼‰
</span></span><span class=line><span class=cl>7. åç«¯æ‹¦æˆªå™¨è§£æJWT Token
</span></span><span class=line><span class=cl>8. åç«¯ä»Tokenä¸­æå–ç”¨æˆ·ID
</span></span><span class=line><span class=cl>9. åç«¯æ‰§è¡Œä¸šåŠ¡é€»è¾‘
</span></span><span class=line><span class=cl>10. åç«¯è¿”å›ä¸šåŠ¡æ•°æ®
</span></span></code></pre></td></tr></table></div></div><h2 id=4-jwttokenuserinterceptor-æ‹¦æˆªå™¨è¯¦è§£>4. JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£</h2><h3 id=-å®Œæ•´æ‹¦æˆªå™¨å®ç°>ğŸ—ï¸ å®Œæ•´æ‹¦æˆªå™¨å®ç°</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtTokenUserInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtProperties</span><span class=w> </span><span class=n>jwtProperties</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¯·æ±‚å¤„ç†å‰çš„æ‹¦æˆªé€»è¾‘
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1. åˆ¤æ–­å½“å‰æ‹¦æˆªåˆ°çš„æ˜¯Controllerçš„æ–¹æ³•è¿˜æ˜¯å…¶ä»–èµ„æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å½“å‰æ‹¦æˆªåˆ°çš„ä¸æ˜¯åŠ¨æ€æ–¹æ³•ï¼Œç›´æ¥æ”¾è¡Œï¼ˆé™æ€èµ„æºç­‰ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2. ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserTokenName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è¯·æ±‚å¤´åç§°: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserTokenName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Authorizationå¤´: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3. å»æ‰Bearerå‰ç¼€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4. æ ¡éªŒä»¤ç‰Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;JWTæ ¡éªŒ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>.</span><span class=na>parseJWT</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserSecretKey</span><span class=p>(),</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>).</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ç”¨æˆ·IDï¼š{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 5. å°†ç”¨æˆ·IDå­˜å‚¨åˆ°ThreadLocalä¸­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 6. é€šè¿‡ï¼Œæ”¾è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;JWTæ ¡éªŒå¤±è´¥: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 7. ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>response</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>401</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-ä»£ç é€è¡Œè§£æ>ğŸ” ä»£ç é€è¡Œè§£æ</h3><h4 id=æ­¥éª¤1åˆ¤æ–­è¯·æ±‚ç±»å‹>æ­¥éª¤1ï¼šåˆ¤æ–­è¯·æ±‚ç±»å‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// é™æ€èµ„æºç›´æ¥æ”¾è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>ç›®çš„</strong>ï¼šåŒºåˆ† Controller æ–¹æ³•å’Œé™æ€èµ„æºè¯·æ±‚</li><li><strong>åŸç†</strong>ï¼šSpring MVC ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ª handler æ¥å¤„ç†</li><li><strong>HandlerMethod</strong>ï¼šController æ–¹æ³•çš„å¤„ç†å™¨</li><li><strong>ResourceHttpRequestHandler</strong>ï¼šé™æ€èµ„æºçš„å¤„ç†å™¨</li></ul><h4 id=æ­¥éª¤2è·å–-jwt-token>æ­¥éª¤2ï¼šè·å– JWT Token</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserTokenName</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>é…ç½®åŒ–</strong>ï¼šé€šè¿‡ <code>JwtProperties</code> ç®¡ç†è¯·æ±‚å¤´åç§°</li><li><strong>çµæ´»æ€§</strong>ï¼šå¯ä»¥é…ç½®ä¸åŒçš„è¯·æ±‚å¤´åç§°ï¼ˆå¦‚ <code>Authorization</code>ã€<code>X-Token</code> ç­‰ï¼‰</li></ul><h4 id=æ­¥éª¤3å¤„ç†-bearer-å‰ç¼€>æ­¥éª¤3ï¼šå¤„ç† Bearer å‰ç¼€</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>æ ‡å‡†æ ¼å¼</strong>ï¼šJWT Token é€šå¸¸ä»¥ <code>Bearer </code>å‰ç¼€ä¼ è¾“</li><li><strong>å®‰å…¨è€ƒè™‘</strong>ï¼šæ˜ç¡®æ ‡è¯† Token ç±»å‹ï¼Œé¿å…ä¸å…¶ä»–è®¤è¯æ–¹å¼æ··æ·†</li></ul><h4 id=æ­¥éª¤4jwt-è§£æä¸éªŒè¯>æ­¥éª¤4ï¼šJWT è§£æä¸éªŒè¯</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>.</span><span class=na>parseJWT</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserSecretKey</span><span class=p>(),</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>).</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>ç­¾åéªŒè¯</strong>ï¼šä½¿ç”¨ç›¸åŒçš„å¯†é’¥éªŒè¯ Token ç­¾å</li><li><strong>è¿‡æœŸæ£€æŸ¥</strong>ï¼šJWT åº“ä¼šè‡ªåŠ¨æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ</li><li><strong>Claims æå–</strong>ï¼šä» JWT è½½è·ä¸­æå–ç”¨æˆ·ä¿¡æ¯</li></ul><h4 id=æ­¥éª¤5ä¸Šä¸‹æ–‡å­˜å‚¨>æ­¥éª¤5ï¼šä¸Šä¸‹æ–‡å­˜å‚¨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>ThreadLocal</strong>ï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ç”¨æˆ·ä¿¡æ¯</li><li><strong>é¿å…ä¼ å‚</strong>ï¼šController å’Œ Service å±‚å¯ä»¥ç›´æ¥è·å–å½“å‰ç”¨æˆ· ID</li></ul><h2 id=5-long-userid--longvalueofclaimsgetuseridtostring-è§£æ>5. Long userId = Long.valueOf(claims.get(&ldquo;userId&rdquo;).toString()); è§£æ</h2><h3 id=-ç±»å‹è½¬æ¢è¿‡ç¨‹>ğŸ”„ ç±»å‹è½¬æ¢è¿‡ç¨‹</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ­¥éª¤åˆ†è§£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Object</span><span class=w> </span><span class=n>userIdObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>        </span><span class=c1>// 1. ä»Claimsä¸­è·å–userIdï¼ˆObjectç±»å‹ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>userIdStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userIdObj</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>        </span><span class=c1>// 2. è½¬æˆå­—ç¬¦ä¸²</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userIdStr</span><span class=p>);</span><span class=w>          </span><span class=c1>// 3. è½¬æˆLongå¯¹è±¡</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ>âš ï¸ æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><h4 id=é—®é¢˜1ç±»å‹è½¬æ¢å¼‚å¸¸>é—®é¢˜1ï¼šç±»å‹è½¬æ¢å¼‚å¸¸</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å¯èƒ½æŠ›å‡º NumberFormatException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>).</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å®‰å…¨çš„ç±»å‹è½¬æ¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>getUserIdSafely</span><span class=p>(</span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>userIdObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userIdObj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;ç”¨æˆ·IDä¸èƒ½ä¸ºç©º&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userIdObj</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NumberFormatException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;ç”¨æˆ·IDæ ¼å¼é”™è¯¯: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userIdObj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=é—®é¢˜2ç©ºå€¼å¤„ç†>é—®é¢˜2ï¼šç©ºå€¼å¤„ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ£€æŸ¥ç©ºå€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Object</span><span class=w> </span><span class=n>userIdObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userIdObj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;JWTä¸­ç¼ºå°‘ç”¨æˆ·ID&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-æœ€ä½³å®è·µ>ğŸ¯ æœ€ä½³å®è·µ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å®‰å…¨åœ°ä»Claimsä¸­è·å–ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>extractUserId</span><span class=p>(</span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>userIdObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userIdObj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;JWTä¸­ç¼ºå°‘ç”¨æˆ·ID&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userIdObj</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NumberFormatException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;ç”¨æˆ·IDæ ¼å¼é”™è¯¯: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userIdObj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=6-basecontext-æ˜¯ä»€ä¹ˆ>6. BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id=-basecontext-å®Œæ•´å®ç°>ğŸ—ï¸ BaseContext å®Œæ•´å®ç°</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * åŸºäºThreadLocalå°è£…å·¥å…·ç±»ï¼Œç”¨äºä¿å­˜å’Œè·å–å½“å‰ç™»å½•ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BaseContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>threadLocal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®å½“å‰ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCurrentId</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>threadLocal</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–å½“å‰ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     * @return ç”¨æˆ·ID
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>getCurrentId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>threadLocal</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆ é™¤å½“å‰ç”¨æˆ·IDï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeCurrentId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>threadLocal</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-threadlocal-åŸç†>ğŸ§µ ThreadLocal åŸç†</h3><h4 id=ä¸ºä»€ä¹ˆä½¿ç”¨-threadlocal>ä¸ºä»€ä¹ˆä½¿ç”¨ ThreadLocalï¼Ÿ</h4><ol><li><strong>çº¿ç¨‹éš”ç¦»</strong>ï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨</li><li><strong>é¿å…ä¼ å‚</strong>ï¼šä¸éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸­ä¼ é€’ç”¨æˆ· ID</li><li><strong>ä»£ç ç®€æ´</strong>ï¼šController å’Œ Service å±‚å¯ä»¥ç›´æ¥è·å–å½“å‰ç”¨æˆ·</li></ol><h4 id=threadlocal-å†…å­˜æ¨¡å‹>ThreadLocal å†…å­˜æ¨¡å‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>è¯·æ±‚çº¿ç¨‹1 â”€â”€â–¶ ThreadLocal Map â”€â”€â–¶ userId: 1001
</span></span><span class=line><span class=cl>è¯·æ±‚çº¿ç¨‹2 â”€â”€â–¶ ThreadLocal Map â”€â”€â–¶ userId: 1002  
</span></span><span class=line><span class=cl>è¯·æ±‚çº¿ç¨‹3 â”€â”€â–¶ ThreadLocal Map â”€â”€â–¶ userId: 1003
</span></span></code></pre></td></tr></table></div></div><p><strong>ThreadLocalå·¥ä½œåŸç†ï¼š</strong></p><ul><li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ThreadLocalå˜é‡å‰¯æœ¬</li><li>çº¿ç¨‹1çš„userId=1001ï¼Œçº¿ç¨‹2çš„userId=1002ï¼Œäº’ä¸å¹²æ‰°</li><li>é€šè¿‡ThreadLocalå®ç°çº¿ç¨‹éš”ç¦»ï¼Œé¿å…å¹¶å‘é—®é¢˜</li><li>è¯·æ±‚ç»“æŸåéœ€è¦æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</li></ul><h3 id=-å®é™…ä½¿ç”¨åœºæ™¯>ğŸ”§ å®é™…ä½¿ç”¨åœºæ™¯</h3><h4 id=controller-å±‚ä½¿ç”¨>Controller å±‚ä½¿ç”¨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AdminController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/info&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>AdminLoginVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>info</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç›´æ¥è·å–å½“å‰ç™»å½•ç®¡ç†å‘˜IDï¼Œæ— éœ€ä¼ å‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>adminId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AdminLoginVO</span><span class=w> </span><span class=n>adminInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adminService</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>adminId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>adminInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=service-å±‚ä½¿ç”¨>Service å±‚ä½¿ç”¨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>createOrder</span><span class=p>(</span><span class=n>OrderDTO</span><span class=w> </span><span class=n>orderDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç›´æ¥è·å–å½“å‰ç”¨æˆ·ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderDTO</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¸šåŠ¡é€»è¾‘å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>processOrder</span><span class=p>(</span><span class=n>orderDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-å†…å­˜æ³„æ¼é˜²æŠ¤>âš ï¸ å†…å­˜æ³„æ¼é˜²æŠ¤</h3><h4 id=é—®é¢˜threadlocal-å†…å­˜æ³„æ¼>é—®é¢˜ï¼šThreadLocal å†…å­˜æ³„æ¼</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰æ¸…ç†ThreadLocal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processRequest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>1001L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤„ç†ä¸šåŠ¡é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¿˜è®°è°ƒç”¨ removeCurrentId()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=è§£å†³æ–¹æ¡ˆæ‹¦æˆªå™¨åå¤„ç†>è§£å†³æ–¹æ¡ˆï¼šæ‹¦æˆªå™¨åå¤„ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtTokenUserInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// JWTéªŒè¯é€»è¾‘...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¯·æ±‚å®Œæˆåæ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>removeCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=7-åˆ¤æ–­-handler-æ˜¯å¦æ˜¯-controller-æ–¹æ³•>7. åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³•</h2><h3 id=-handlermethod-è¯¦è§£>ğŸ” HandlerMethod è¯¦è§£</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// é™æ€èµ„æºç›´æ¥æ”¾è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=spring-mvc-è¯·æ±‚å¤„ç†æµç¨‹>Spring MVC è¯·æ±‚å¤„ç†æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>å®¢æˆ·ç«¯è¯·æ±‚
</span></span><span class=line><span class=cl>    â”‚
</span></span><span class=line><span class=cl>    â–¼
</span></span><span class=line><span class=cl>DispatcherServlet
</span></span><span class=line><span class=cl>    â”‚
</span></span><span class=line><span class=cl>    â–¼
</span></span><span class=line><span class=cl>HandlerMapping
</span></span><span class=line><span class=cl>    â”‚
</span></span><span class=line><span class=cl>    â–¼
</span></span><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚   è¯·æ±‚ç±»å‹åˆ¤æ–­   â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>    â”‚
</span></span><span class=line><span class=cl>    â”œâ”€â”€ Controlleræ–¹æ³• â”€â”€â–¶ HandlerMethod â”€â”€â–¶ æ‹¦æˆªå™¨é“¾ â”€â”€â–¶ Controlleræ–¹æ³•æ‰§è¡Œ â”€â”€â–¶ è¿”å›å“åº”
</span></span><span class=line><span class=cl>    â”‚
</span></span><span class=line><span class=cl>    â”œâ”€â”€ é™æ€èµ„æº â”€â”€â–¶ ResourceHttpRequestHandler â”€â”€â–¶ ç›´æ¥å¤„ç† â”€â”€â–¶ è¿”å›èµ„æº â”€â”€â–¶ è¿”å›å“åº”
</span></span><span class=line><span class=cl>    â”‚
</span></span><span class=line><span class=cl>    â””â”€â”€ å…¶ä»–èµ„æº â”€â”€â–¶ å…¶ä»–Handler â”€â”€â–¶ ç›´æ¥å¤„ç† â”€â”€â–¶ è¿”å›èµ„æº â”€â”€â–¶ è¿”å›å“åº”
</span></span></code></pre></td></tr></table></div></div><p><strong>æµç¨‹è¯´æ˜ï¼š</strong></p><ol><li><strong>å®¢æˆ·ç«¯è¯·æ±‚</strong> â†’ å‘é€HTTPè¯·æ±‚åˆ°æœåŠ¡å™¨</li><li><strong>DispatcherServlet</strong> â†’ Spring MVCçš„æ ¸å¿ƒåˆ†å‘å™¨</li><li><strong>HandlerMapping</strong> â†’ æ ¹æ®URLæ˜ å°„æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨</li><li><strong>è¯·æ±‚ç±»å‹åˆ¤æ–­</strong> â†’ åŒºåˆ†ä¸åŒç±»å‹çš„è¯·æ±‚</li><li><strong>HandlerMethod</strong> â†’ Controlleræ–¹æ³•å¤„ç†å™¨ï¼Œéœ€è¦JWTéªŒè¯</li><li><strong>ResourceHttpRequestHandler</strong> â†’ é™æ€èµ„æºå¤„ç†å™¨ï¼Œç›´æ¥è¿”å›</li><li><strong>æ‹¦æˆªå™¨é“¾</strong> â†’ æ‰§è¡ŒJWTéªŒè¯ç­‰æ‹¦æˆªé€»è¾‘</li><li><strong>Controlleræ–¹æ³•æ‰§è¡Œ</strong> â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘</li><li><strong>è¿”å›å“åº”</strong> â†’ è¿”å›å¤„ç†ç»“æœç»™å®¢æˆ·ç«¯</li></ol><h4 id=handlermethod-vs-resourcehttprequesthandler>HandlerMethod vs ResourceHttpRequestHandler</h4><div class=table-wrapper><table><thead><tr><th>ç±»å‹</th><th>ç”¨é€”</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>HandlerMethod</td><td>Controller æ–¹æ³•</td><td><code>@GetMapping("/users")</code></td></tr><tr><td>ResourceHttpRequestHandler</td><td>é™æ€èµ„æº</td><td><code>/static/css/style.css</code></td></tr><tr><td>RequestMappingHandlerMapping</td><td>è¯·æ±‚æ˜ å°„</td><td>é»˜è®¤çš„è¯·æ±‚å¤„ç†å™¨</td></tr></tbody></table></div><h3 id=-å®é™…åº”ç”¨åœºæ™¯-1>ğŸ¯ å®é™…åº”ç”¨åœºæ™¯</h3><h4 id=åœºæ™¯1åªæ‹¦æˆª-controller-æ–¹æ³•>åœºæ™¯1ï¼šåªæ‹¦æˆª Controller æ–¹æ³•</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åªå¯¹Controlleræ–¹æ³•è¿›è¡ŒJWTéªŒè¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// é™æ€èµ„æºã€å¥åº·æ£€æŸ¥ç­‰ç›´æ¥æ”¾è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// JWTéªŒè¯é€»è¾‘...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=åœºæ™¯2è®°å½•æ‰€æœ‰è¯·æ±‚>åœºæ™¯2ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>requestType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;Controller&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;Static&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è¯·æ±‚ç±»å‹: {}, è·¯å¾„: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestType</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¶ä»–é€»è¾‘...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=8-instanceof-æ˜¯ä»€ä¹ˆ>8. instanceof æ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id=-instanceof-è¯­æ³•è¯¦è§£>ğŸ”§ instanceof è¯­æ³•è¯¦è§£</h3><p><code>instanceof</code> æ˜¯ Java å…³é”®å­—ï¼Œç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯æŸä¸ªç±»æˆ–æ¥å£çš„å®ä¾‹ã€‚</p><h4 id=åŸºæœ¬è¯­æ³•>åŸºæœ¬è¯­æ³•</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>object</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ClassName</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=è¿”å›å€¼>è¿”å›å€¼</h4><ul><li><code>true</code>ï¼šå¯¹è±¡æ˜¯æŒ‡å®šç±»æˆ–æ¥å£çš„å®ä¾‹</li><li><code>false</code>ï¼šå¯¹è±¡ä¸æ˜¯æŒ‡å®šç±»æˆ–æ¥å£çš„å®ä¾‹</li></ul><h3 id=-å®é™…ç¤ºä¾‹>ğŸ“ å®é™…ç¤ºä¾‹</h3><h4 id=ç¤ºä¾‹1åŸºæœ¬ç±»å‹åˆ¤æ–­>ç¤ºä¾‹1ï¼šåŸºæœ¬ç±»å‹åˆ¤æ–­</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åŠ¨ç‰©ç±»å±‚æ¬¡ç»“æ„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Animal</span><span class=w> </span><span class=n>animal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>animal</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Animal</span><span class=p>);</span><span class=w>  </span><span class=c1>// true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>animal</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Dog</span><span class=p>);</span><span class=w>     </span><span class=c1>// true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>animal</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Cat</span><span class=p>);</span><span class=w>     </span><span class=c1>// false</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=ç¤ºä¾‹2æ¥å£åˆ¤æ–­>ç¤ºä¾‹2ï¼šæ¥å£åˆ¤æ–­</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>list</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>List</span><span class=p>);</span><span class=w>        </span><span class=c1>// true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>list</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ArrayList</span><span class=p>);</span><span class=w>  </span><span class=c1>// true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>list</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>LinkedList</span><span class=p>);</span><span class=w> </span><span class=c1>// false</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=ç¤ºä¾‹3null-å¤„ç†>ç¤ºä¾‹3ï¼šnull å¤„ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>str</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>String</span><span class=p>);</span><span class=w> </span><span class=c1>// falseï¼ˆnull ä¸æ˜¯ä»»ä½•ç±»çš„å®ä¾‹ï¼‰</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨>ğŸ¯ åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨</h3><h4 id=åˆ¤æ–­-handler-ç±»å‹>åˆ¤æ–­ Handler ç±»å‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Controller æ–¹æ³•å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HandlerMethod</span><span class=w> </span><span class=n>handlerMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=n>handler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Controller: {}, Method: {}&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getBeanType</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getMethod</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// JWT éªŒè¯é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>validateJWT</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ResourceHttpRequestHandler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é™æ€èµ„æºå¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;é™æ€èµ„æºè¯·æ±‚: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å…¶ä»–ç±»å‹å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å…¶ä»–ç±»å‹è¯·æ±‚: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>handler</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=è·å–æ–¹æ³•ä¿¡æ¯>è·å–æ–¹æ³•ä¿¡æ¯</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HandlerMethod</span><span class=w> </span><span class=n>handlerMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=n>handler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å– Controller ç±»å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>controllerName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getBeanType</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–æ–¹æ³•å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getMethod</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–æ³¨è§£ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RequestMapping</span><span class=w> </span><span class=n>mapping</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getMethodAnnotation</span><span class=p>(</span><span class=n>RequestMapping</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œæ–¹æ³•: {}.{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>controllerName</span><span class=p>,</span><span class=w> </span><span class=n>methodName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=9-å®Œæ•´é¡¹ç›®å®æˆ˜>9. å®Œæ•´é¡¹ç›®å®æˆ˜</h2><h3 id=-é¡¹ç›®ç»“æ„>ğŸ—ï¸ é¡¹ç›®ç»“æ„</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>coffee-project/
</span></span><span class=line><span class=cl>â”œâ”€â”€ coffee-common/           # å…¬å…±æ¨¡å—
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ src/main/java/com/coffee/
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ context/         # ä¸Šä¸‹æ–‡ç®¡ç†
</span></span><span class=line><span class=cl>â”‚   â”‚   â”‚   â””â”€â”€ BaseContext.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ properties/      # é…ç½®å±æ€§
</span></span><span class=line><span class=cl>â”‚   â”‚   â”‚   â””â”€â”€ JwtProperties.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ utils/          # å·¥å…·ç±»
</span></span><span class=line><span class=cl>â”‚   â”‚       â””â”€â”€ JwtUtil.java
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ pom.xml
</span></span><span class=line><span class=cl>â”œâ”€â”€ coffee-server/          # æœåŠ¡ç«¯æ¨¡å—
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ src/main/java/com/coffee/
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ config/         # é…ç½®ç±»
</span></span><span class=line><span class=cl>â”‚   â”‚   â”‚   â””â”€â”€ WebMvcConfiguration.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ interceptor/    # æ‹¦æˆªå™¨
</span></span><span class=line><span class=cl>â”‚   â”‚   â”‚   â”œâ”€â”€ JwtTokenAdminInterceptor.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â”‚   â””â”€â”€ JwtTokenUserInterceptor.java
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ controller/     # æ§åˆ¶å™¨
</span></span><span class=line><span class=cl>â”‚   â”‚       â”œâ”€â”€ admin/      # ç®¡ç†ç«¯
</span></span><span class=line><span class=cl>â”‚   â”‚       â””â”€â”€ user/       # ç”¨æˆ·ç«¯
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ src/main/resources/
</span></span><span class=line><span class=cl>â”‚       â””â”€â”€ application.yml # é…ç½®æ–‡ä»¶
</span></span><span class=line><span class=cl>â””â”€â”€ pom.xml
</span></span></code></pre></td></tr></table></div></div><h3 id=-é…ç½®æ–‡ä»¶>âš™ï¸ é…ç½®æ–‡ä»¶</h3><h4 id=applicationyml>application.yml</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>coffee</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jwt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ç®¡ç†å‘˜JWTé…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>admin-secret-key</span><span class=p>:</span><span class=w> </span><span class=l>itcast</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>admin-ttl</span><span class=p>:</span><span class=w> </span><span class=m>7200000</span><span class=w>  </span><span class=c># 2å°æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>admin-token-name</span><span class=p>:</span><span class=w> </span><span class=l>Authorization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ç”¨æˆ·JWTé…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user-secret-key</span><span class=p>:</span><span class=w> </span><span class=l>itcast</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user-ttl</span><span class=p>:</span><span class=w> </span><span class=m>7200000</span><span class=w>  </span><span class=c># 2å°æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user-token-name</span><span class=p>:</span><span class=w> </span><span class=l>Authorization</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=jwtpropertiesjava>JwtProperties.java</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConfigurationProperties</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;coffee.jwt&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtProperties</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç®¡ç†å‘˜JWTç­¾åå¯†é’¥
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>adminSecretKey</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç®¡ç†å‘˜JWTè¿‡æœŸæ—¶é—´(æ¯«ç§’)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>adminTtl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç®¡ç†å‘˜ä»¤ç‰Œåç§°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>adminTokenName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨æˆ·ä»¤ç‰Œåç§°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userTokenName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨æˆ·JWTç­¾åå¯†é’¥
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userSecretKey</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç”¨æˆ·JWTè¿‡æœŸæ—¶é—´(æ¯«ç§’)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userTtl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-æ‹¦æˆªå™¨é…ç½®>ğŸ”§ æ‹¦æˆªå™¨é…ç½®</h3><h4 id=webmvcconfigurationjava>WebMvcConfiguration.java</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebMvcConfiguration</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtTokenAdminInterceptor</span><span class=w> </span><span class=n>jwtTokenAdminInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ³¨å†Œæ‹¦æˆªå™¨
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addInterceptors</span><span class=p>(</span><span class=n>InterceptorRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ³¨å†Œè‡ªå®šä¹‰æ‹¦æˆªå™¨...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç®¡ç†ç«¯æ‹¦æˆªå™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addInterceptor</span><span class=p>(</span><span class=n>jwtTokenAdminInterceptor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addPathPatterns</span><span class=p>(</span><span class=s>&#34;/admin/**&#34;</span><span class=p>)</span><span class=w>           </span><span class=c1>// æ‹¦æˆªç®¡ç†ç«¯æ‰€æœ‰è¯·æ±‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>excludePathPatterns</span><span class=p>(</span><span class=s>&#34;/admin/login&#34;</span><span class=p>);</span><span class=w>   </span><span class=c1>// æ’é™¤ç™»å½•æ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·¨åŸŸé…ç½®
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addCorsMappings</span><span class=p>(</span><span class=n>CorsRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addMapping</span><span class=p>(</span><span class=s>&#34;/**&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>allowedOriginPatterns</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>allowedMethods</span><span class=p>(</span><span class=s>&#34;GET&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;POST&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;PUT&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;DELETE&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;OPTIONS&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>allowedHeaders</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>allowCredentials</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>maxAge</span><span class=p>(</span><span class=n>3600</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-å®é™…ä½¿ç”¨ç¤ºä¾‹>ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹</h3><h4 id=ç®¡ç†ç«¯æ§åˆ¶å™¨>ç®¡ç†ç«¯æ§åˆ¶å™¨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ç®¡ç†ç«¯ç›¸å…³æ¥å£&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AdminController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AdminService</span><span class=w> </span><span class=n>adminService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç®¡ç†å‘˜ç™»å½•ï¼ˆä¸éœ€è¦JWTéªŒè¯ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;ç®¡ç†å‘˜ç™»å½•&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>AdminLoginVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>login</span><span class=p>(</span><span class=nd>@Valid</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>AdminLoginDTO</span><span class=w> </span><span class=n>adminLoginDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ç®¡ç†å‘˜ç™»å½•ï¼š{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>adminLoginDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AdminLoginVO</span><span class=w> </span><span class=n>adminLoginVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adminService</span><span class=p>.</span><span class=na>login</span><span class=p>(</span><span class=n>adminLoginDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>adminLoginVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–ç®¡ç†å‘˜ä¿¡æ¯ï¼ˆéœ€è¦JWTéªŒè¯ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/info&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;è·å–ç®¡ç†å‘˜ä¿¡æ¯&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>AdminLoginVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>info</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä»ThreadLocalä¸­è·å–å½“å‰ç™»å½•ç®¡ç†å‘˜ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>adminId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AdminLoginVO</span><span class=w> </span><span class=n>adminInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adminService</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>adminId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>adminInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=10-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹>10. æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h2><h3 id=-æœ€ä½³å®è·µ-1>âœ… æœ€ä½³å®è·µ</h3><h4 id=1-å®‰å…¨çš„jwtå¤„ç†>1. å®‰å…¨çš„JWTå¤„ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å®‰å…¨çš„JWTè§£ææ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>extractUserIdSafely</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>token</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Tokenä¸èƒ½ä¸ºç©º&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JwtUtil</span><span class=p>.</span><span class=na>parseJWT</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserSecretKey</span><span class=p>(),</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getExpiration</span><span class=p>().</span><span class=na>before</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Tokenå·²è¿‡æœŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å®‰å…¨åœ°æå–ç”¨æˆ·ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>userIdObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;userId&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userIdObj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Tokenä¸­ç¼ºå°‘ç”¨æˆ·ID&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>userIdObj</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;JWTè§£æå¤±è´¥: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;æ— æ•ˆçš„Token&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=2-å®Œæ•´çš„æ‹¦æˆªå™¨å®ç°>2. å®Œæ•´çš„æ‹¦æˆªå™¨å®ç°</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtTokenUserInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtProperties</span><span class=w> </span><span class=n>jwtProperties</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1. åªå¤„ç†Controlleræ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2. è·å–Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extractToken</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>token</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendErrorResponse</span><span class=p>(</span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ç¼ºå°‘è®¤è¯Token&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3. éªŒè¯Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extractUserIdSafely</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;JWTéªŒè¯å¤±è´¥: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendErrorResponse</span><span class=p>(</span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=s>&#34;TokenéªŒè¯å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>removeCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>extractToken</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getUserTokenName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendErrorResponse</span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>401</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;application/json;charset=UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=s>&#34;{\&#34;code\&#34;:401,\&#34;message\&#34;:\&#34;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\&#34;}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=3-å¼‚å¸¸å¤„ç†>3. å¼‚å¸¸å¤„ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestControllerAdvice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GlobalExceptionHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * JWTç›¸å…³å¼‚å¸¸å¤„ç†
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>handleJWTException</span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;JWTå¼‚å¸¸: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;è®¤è¯å¤±è´¥: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é€šç”¨å¼‚å¸¸å¤„ç†
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>(</span><span class=n>Exception</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>handleException</span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;ç³»ç»Ÿå¼‚å¸¸: &#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=-æ³¨æ„äº‹é¡¹>âš ï¸ æ³¨æ„äº‹é¡¹</h3><h4 id=1-å†…å­˜æ³„æ¼é˜²æŠ¤>1. å†…å­˜æ³„æ¼é˜²æŠ¤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é”™è¯¯ç¤ºä¾‹ï¼šå¿˜è®°æ¸…ç†ThreadLocal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processRequest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>1001L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤„ç†ä¸šåŠ¡é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¿˜è®°è°ƒç”¨ removeCurrentId()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨try-finallyç¡®ä¿æ¸…ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processRequest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>setCurrentId</span><span class=p>(</span><span class=n>1001L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¤„ç†ä¸šåŠ¡é€»è¾‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>removeCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=2-çº¿ç¨‹å®‰å…¨é—®é¢˜>2. çº¿ç¨‹å®‰å…¨é—®é¢˜</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ThreadLocalæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†è¦æ³¨æ„ä½¿ç”¨æ–¹å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BaseContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å‰¯æœ¬</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>threadLocal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é™æ€æ–¹æ³•ï¼Œçº¿ç¨‹å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCurrentId</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>threadLocal</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=3-jwtå¯†é’¥ç®¡ç†>3. JWTå¯†é’¥ç®¡ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ç”Ÿäº§ç¯å¢ƒé…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>coffee</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jwt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>admin-secret-key</span><span class=p>:</span><span class=w> </span><span class=l>${JWT_ADMIN_SECRET:default-secret}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user-secret-key</span><span class=p>:</span><span class=w> </span><span class=l>${JWT_USER_SECRET:default-secret}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=11-æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„>11. æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„</h2><h3 id=-å®Œæ•´è¯·æ±‚æµç¨‹å›¾>ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹å›¾</h3><h4 id=æ—¶åºå›¾asciiç‰ˆæœ¬>æ—¶åºå›¾ï¼ˆASCIIç‰ˆæœ¬ï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>å®¢æˆ·ç«¯ â”€â”€â–¶ DispatcherServlet â”€â”€â–¶ æ‹¦æˆªå™¨ â”€â”€â–¶ HandlerMethod â”€â”€â–¶ BaseContext â”€â”€â–¶ Service
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚ HTTPè¯·æ±‚+    â”‚              â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚ Authorizationâ”‚              â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚ è¯·æ±‚è¿›å…¥     â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ æ£€æŸ¥handler  â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ instanceof   â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ HandlerMethodâ”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ æå–JWT Tokenâ”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ è§£æToken   â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ è·å–Claims  â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ è®¾ç½®userId  â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ æ”¾è¡Œåˆ°     â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ Controller  â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚ è·å–userId  â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚ è¿”å›userId  â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ è°ƒç”¨Service â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚ è·å–userId  â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚ è¿”å›userId  â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ è¿”å›ä¸šåŠ¡æ•°æ®â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚ è¿”å›å“åº”     â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚              â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”‚ æ¸…ç†ThreadLocalâ”‚            â”‚              â”‚
</span></span><span class=line><span class=cl>  â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚              â”‚
</span></span></code></pre></td></tr></table></div></div><h4 id=è¯¦ç»†æ­¥éª¤è¯´æ˜>è¯¦ç»†æ­¥éª¤è¯´æ˜</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>1. å®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚ï¼Œæºå¸¦Authorizationå¤´
</span></span><span class=line><span class=cl>2. DispatcherServletæ¥æ”¶è¯·æ±‚å¹¶è½¬å‘ç»™æ‹¦æˆªå™¨
</span></span><span class=line><span class=cl>3. æ‹¦æˆªå™¨æ£€æŸ¥handlerç±»å‹ï¼ˆinstanceof HandlerMethodï¼‰
</span></span><span class=line><span class=cl>4. æ‹¦æˆªå™¨æå–JWT Token
</span></span><span class=line><span class=cl>5. æ‹¦æˆªå™¨è§£æTokenè·å–Claims
</span></span><span class=line><span class=cl>6. æ‹¦æˆªå™¨å°†userIdå­˜å‚¨åˆ°BaseContext
</span></span><span class=line><span class=cl>7. æ‹¦æˆªå™¨æ”¾è¡Œè¯·æ±‚åˆ°Controller
</span></span><span class=line><span class=cl>8. Controllerä»BaseContextè·å–userId
</span></span><span class=line><span class=cl>9. Controllerè°ƒç”¨Serviceæ–¹æ³•
</span></span><span class=line><span class=cl>10. Serviceä»BaseContextè·å–userId
</span></span><span class=line><span class=cl>11. Serviceæ‰§è¡Œä¸šåŠ¡é€»è¾‘å¹¶è¿”å›æ•°æ®
</span></span><span class=line><span class=cl>12. Controllerè¿”å›å“åº”ç»™å®¢æˆ·ç«¯
</span></span><span class=line><span class=cl>13. è¯·æ±‚å®Œæˆåæ¸…ç†ThreadLocalï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
</span></span></code></pre></td></tr></table></div></div><h3 id=-æ ¸å¿ƒæ¦‚å¿µæ€»ç»“>ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ€»ç»“</h3><div class=table-wrapper><table><thead><tr><th>æ¦‚å¿µ</th><th>ä½œç”¨</th><th>å…³é”®ç‚¹</th></tr></thead><tbody><tr><td><strong>HttpServletRequest</strong></td><td>å°è£…è¯·æ±‚ä¿¡æ¯</td><td>è·å–Headerã€å‚æ•°ã€Sessionç­‰</td></tr><tr><td><strong>HandlerMethod</strong></td><td>Controlleræ–¹æ³•å¤„ç†å™¨</td><td>åŒºåˆ†Controllerå’Œé™æ€èµ„æº</td></tr><tr><td><strong>instanceof</strong></td><td>ç±»å‹åˆ¤æ–­</td><td>åˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œç¡®ä¿ç±»å‹å®‰å…¨</td></tr><tr><td><strong>BaseContext</strong></td><td>çº¿ç¨‹ä¸Šä¸‹æ–‡</td><td>ThreadLocalå­˜å‚¨ç”¨æˆ·ä¿¡æ¯</td></tr><tr><td><strong>JWTæ‹¦æˆªå™¨</strong></td><td>ç»Ÿä¸€è®¤è¯</td><td>è‡ªåŠ¨è§£æTokenï¼Œè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡</td></tr></tbody></table></div><h3 id=-æŠ€æœ¯è¦ç‚¹>ğŸ¯ æŠ€æœ¯è¦ç‚¹</h3><ol><li><strong>HttpServletRequest</strong>ï¼šå°è£…è¯·æ±‚ä¿¡æ¯ï¼Œå¯ä»¥è·å– Headerã€å‚æ•°ã€Sessionã€å®¢æˆ·ç«¯ä¿¡æ¯ç­‰</li><li><strong>JWT + æ‹¦æˆªå™¨</strong>ï¼šç»Ÿä¸€è§£æç”¨æˆ·èº«ä»½ï¼Œæ‹¦æˆªæœªæˆæƒè¯·æ±‚</li><li><strong>BaseContext</strong>ï¼šå­˜å‚¨å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆThreadLocalï¼‰ï¼Œé¿å…ä¼ å‚éº»çƒ¦</li><li><strong>handler & HandlerMethod</strong>ï¼šåˆ¤æ–­è¯·æ±‚å¤„ç†å¯¹è±¡ç±»å‹ï¼ŒåŒºåˆ† Controller ä¸é™æ€èµ„æº</li><li><strong>instanceof</strong>ï¼šåˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œæ˜¯ Java çš„åŸºç¡€è¯­æ³•</li></ol><h3 id=-é¡¹ç›®ä¼˜åŠ¿>ğŸš€ é¡¹ç›®ä¼˜åŠ¿</h3><ul><li><strong>ç»Ÿä¸€è®¤è¯</strong>ï¼šé€šè¿‡æ‹¦æˆªå™¨å®ç°JWTç»Ÿä¸€éªŒè¯</li><li><strong>ä»£ç ç®€æ´</strong>ï¼šä½¿ç”¨BaseContexté¿å…å±‚å±‚ä¼ å‚</li><li><strong>ç±»å‹å®‰å…¨</strong>ï¼šé€šè¿‡instanceofç¡®ä¿ç±»å‹æ­£ç¡®æ€§</li><li><strong>å†…å­˜å®‰å…¨</strong>ï¼šæ­£ç¡®ä½¿ç”¨ThreadLocalï¼Œé¿å…å†…å­˜æ³„æ¼</li><li><strong>é…ç½®çµæ´»</strong>ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†JWTå‚æ•°</li></ul><p>è¿™ç¯‡åšå®¢è¯¦ç»†è§£æäº†Spring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°çš„æ ¸å¿ƒåŸç†ï¼Œç»“åˆå®é™…é¡¹ç›®ä»£ç ï¼Œè®©ä½ æ·±å…¥ç†è§£ç”¨æˆ·è®¤è¯çš„åº•å±‚æµç¨‹ã€‚é€šè¿‡æŒæ¡è¿™äº›æŠ€æœ¯è¦ç‚¹ï¼Œä½ å¯ä»¥æ„å»ºæ›´åŠ å¥å£®å’Œå®‰å…¨çš„Webåº”ç”¨ç³»ç»Ÿã€‚</p><hr><h2 id=-hugoåšå®¢ä½¿ç”¨è¯´æ˜>ğŸ“ Hugoåšå®¢ä½¿ç”¨è¯´æ˜</h2><h3 id=-å·²ä¼˜åŒ–çš„å†…å®¹>âœ… å·²ä¼˜åŒ–çš„å†…å®¹</h3><ul><li><strong>æµç¨‹å›¾</strong>ï¼šæ‰€æœ‰Mermaidå›¾è¡¨å·²è½¬æ¢ä¸ºASCIIå­—ç¬¦å›¾æˆ–ä»£ç å—å½¢å¼</li><li><strong>ä»£ç é«˜äº®</strong>ï¼šä½¿ç”¨æ ‡å‡†Markdownä»£ç å—ï¼ŒHugoè‡ªåŠ¨æ”¯æŒè¯­æ³•é«˜äº®</li><li><strong>è¡¨æ ¼</strong>ï¼šä½¿ç”¨æ ‡å‡†Markdownè¡¨æ ¼æ ¼å¼</li><li><strong>é“¾æ¥</strong>ï¼šæ‰€æœ‰é“¾æ¥éƒ½ä½¿ç”¨æ ‡å‡†Markdownæ ¼å¼</li></ul><h3 id=-hugoé…ç½®å»ºè®®>ğŸ”§ Hugoé…ç½®å»ºè®®</h3><p>åœ¨ä½ çš„Hugoé…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è®¾ç½®ä»¥ä¼˜åŒ–æ˜¾ç¤ºæ•ˆæœï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=c># config.toml</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>markup</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>markup</span><span class=p>.</span><span class=nx>highlight</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>style</span> <span class=p>=</span> <span class=s2>&#34;github&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>lineNos</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>lineNumbersInTable</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>noClasses</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>codeFences</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>guessSyntax</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>tabWidth</span> <span class=p>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=nx>wrap</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>markup</span><span class=p>.</span><span class=nx>goldmark</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>markup</span><span class=p>.</span><span class=nx>goldmark</span><span class=p>.</span><span class=nx>renderer</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsafe</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>hardWraps</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>xhtml</span> <span class=p>=</span> <span class=kc>false</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=-ä¸»é¢˜å…¼å®¹æ€§>ğŸ¨ ä¸»é¢˜å…¼å®¹æ€§</h3><p>æœ¬æ–‡æ¡£å…¼å®¹ä»¥ä¸‹Hugoä¸»é¢˜ï¼š</p><ul><li>âœ… <strong>LoveIt</strong> - å®Œå…¨å…¼å®¹</li><li>âœ… <strong>PaperMod</strong> - å®Œå…¨å…¼å®¹</li><li>âœ… <strong>Ananke</strong> - å®Œå…¨å…¼å®¹</li><li>âœ… <strong>Academic</strong> - å®Œå…¨å…¼å®¹</li><li>âœ… <strong>Minimal</strong> - å®Œå…¨å…¼å®¹</li></ul><h3 id=-ç§»åŠ¨ç«¯ä¼˜åŒ–>ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–</h3><ul><li>æ‰€æœ‰ASCIIå›¾è¡¨åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º</li><li>ä»£ç å—æ”¯æŒæ¨ªå‘æ»šåŠ¨</li><li>è¡¨æ ¼æ”¯æŒå“åº”å¼å¸ƒå±€</li></ul><hr><blockquote><p>ğŸ’¡ <strong>æç¤º</strong>ï¼šæœ¬æ–‡åŸºäºå’–å•¡è´­ç‰©è½¦é¡¹ç›®å®æˆ˜ï¼Œæ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½ç»è¿‡å®é™…æµ‹è¯•éªŒè¯ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼</p></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/spring-boot/>Spring Boot</a>
<a href=/tags/jwt/>JWT</a>
<a href=/tags/%E6%8B%A6%E6%88%AA%E5%99%A8/>æ‹¦æˆªå™¨</a>
<a href=/tags/threadlocal/>ThreadLocal</a>
<a href=/tags/handlermethod/>HandlerMethod</a>
<a href=/tags/httpservletrequest/>HttpServletRequest</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/><div class=article-details><h2 class=article-title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡</h2></div></a></article><article><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8Capi%E6%8E%A5%E5%8F%A3/><div class=article-details><h2 class=article-title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£</h2></div></a></article><article><a href=/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/><div class=article-details><h2 class=article-title>Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 Cecilia-å¡è¥¿è‰å¨…</section><section class=powerby>Never give up<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>