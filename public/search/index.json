[{"content":"Redisson å¯é‡å…¥é”åŸç†è¯¦è§£ 1. ä¸ºä»€ä¹ˆéœ€è¦å¯é‡å…¥é”ï¼Ÿ åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œé” æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„é‡è¦æ‰‹æ®µã€‚ä½†æœ‰æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶ï¼Œä¼šè°ƒç”¨å¦ä¸€ä¸ªä¹Ÿéœ€è¦åŒä¸€æŠŠé”çš„æ–¹æ³•ï¼Œè¿™æ—¶é—®é¢˜å°±æ¥äº†ï¼š\nå¦‚æœé” ä¸å¯é‡å…¥ï¼Œçº¿ç¨‹åœ¨ç¬¬äºŒæ¬¡å°è¯•åŠ é”æ—¶ä¼šå¤±è´¥ï¼Œå› ä¸ºé”å·²ç»å­˜åœ¨ï¼Œå®ƒç›¸å½“äº æŠŠè‡ªå·±å¡æ­»äº†ã€‚ å¦‚æœé” å¯é‡å…¥ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–è¿™æŠŠé”ï¼Œç›´åˆ°æœ€åé‡Šæ”¾æ—¶æ‰çœŸæ­£è§£é”ã€‚ æ‰€ä»¥ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºï¼šé¿å…åŒä¸€çº¿ç¨‹å› ä¸ºæ–¹æ³•åµŒå¥—è°ƒç”¨è€Œæ­»é”ã€‚\n2. æ™®é€šåˆ†å¸ƒå¼é”çš„é—®é¢˜ æœ€ç®€å•çš„åˆ†å¸ƒå¼é”é€šå¸¸ç”¨ Redis çš„ SETNX å®ç°ï¼š\n1 SET key value NX EX 30 NX è¡¨ç¤ºå¦‚æœ key ä¸å­˜åœ¨æ‰è®¾ç½®ï¼Œä¿è¯åŸå­æ€§ã€‚ EX 30 è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ã€‚ é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ å½“ä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰é”æ—¶ï¼Œå¦‚æœåœ¨æ–¹æ³•åµŒå¥—ä¸­å†æ¬¡å°è¯•è·å–é”ï¼š\nRedis å‘ç° key å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›å¤±è´¥ã€‚ è™½ç„¶æ˜¯ åŒä¸€ä¸ªçº¿ç¨‹ æƒ³å†æ¬¡è·å–é”ï¼Œä½†å› ä¸ºé”å®ç°é‡ŒåªåŒºåˆ† \u0026ldquo;æœ‰é” / æ— é”\u0026rdquo;ï¼Œå¹¶ä¸ä¼šè¯†åˆ«çº¿ç¨‹ã€‚ ç»“æœå°±æ˜¯ï¼šè‡ªå·±æŠŠè‡ªå·±é”æ­»äº†ã€‚ 3. Redisson çš„æ”¹è¿›ï¼ˆå¯é‡å…¥å®ç°ï¼‰ Redisson åœ¨ value çš„å­˜å‚¨ä¸Šåšäº†æ”¹è¿›ï¼Œå®ƒå¹¶ä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ª Hash ç»“æ„ï¼š\n1 2 3 lockKey -\u0026gt; { threadId : reentrantCount } threadIdï¼šå”¯ä¸€æ ‡è¯†æŸä¸ª JVM é‡Œçš„æŸä¸ªçº¿ç¨‹ï¼ˆä¸€èˆ¬æ˜¯ UUID:threadIdï¼‰ã€‚ reentrantCountï¼šè®°å½•è¿™ä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ¬¡æ•°ã€‚ è¿™æ ·å°±å¯ä»¥æ”¯æŒ å¯é‡å…¥ äº†ã€‚\n4. æ‰§è¡Œæµç¨‹ä¸¾ä¾‹ å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public void methodA() { lock.lock(); try { methodB(); } finally { lock.unlock(); } } public void methodB() { lock.lock(); try { // æ‰§è¡Œé€»è¾‘ } finally { lock.unlock(); } } 4.1 ç¬¬ä¸€æ¬¡åŠ é”ï¼ˆmethodAï¼‰ Redis é‡Œè¿˜æ²¡æœ‰ lockKeyã€‚ Redisson ä¼šå†™å…¥ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 1 } è¡¨ç¤ºçº¿ç¨‹ thread-1 ç¬¬ä¸€æ¬¡è·å–é”ï¼Œé‡å…¥æ¬¡æ•° = 1ã€‚ 4.2 ç¬¬äºŒæ¬¡åŠ é”ï¼ˆmethodBï¼‰ Redis å‘ç° lockKey å·²å­˜åœ¨ï¼Œä½† owner æ˜¯ åŒä¸€ä¸ªçº¿ç¨‹ã€‚ å…è®¸é‡å…¥ï¼Œè®¡æ•° +1ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 2 } 4.3 methodB æ‰§è¡Œå®Œé‡Šæ”¾é” è°ƒç”¨ unlock()ï¼Œè®¡æ•° -1ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 1 } é”ä»ç„¶ç”±å½“å‰çº¿ç¨‹æŒæœ‰ã€‚ 4.4 methodA æ‰§è¡Œå®Œé‡Šæ”¾é” å†æ¬¡è°ƒç”¨ unlock()ï¼Œè®¡æ•° -1 â†’ å˜æˆ 0ã€‚ Redisson åˆ é™¤ lockKeyï¼š 1 lockKey åˆ é™¤ æ­¤æ—¶é”æ‰çœŸæ­£é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šè·å–ã€‚ 5. é€šä¿—è§£é‡Š ç”¨é€šä¿—çš„è¯å†æè¿°ä¸€æ¬¡ï¼š\nå‡å¦‚ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å¤šä¸ªæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªæ–¹æ³•ç”¨äº†é”å»è°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œç¬¬äºŒä¸ªæ–¹æ³•å†æ¬¡è°ƒç”¨è¿™ä¸ªçº¿ç¨‹çš„é”å°±ä¼šå¤±è´¥ã€‚å› ä¸ºè™½ç„¶é”çš„ key ä¸€æ ·ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è·å–é”çš„æ—¶å€™ä¼šå‘ç°é”å·²ç»å­˜åœ¨äº†ï¼Œå°±è·å–å¤±è´¥ã€‚\nRedisson åœ¨è¿™ä¸ªåŸºç¡€ä¸Šåšäº†æ”¹è¿›ï¼šå®ƒåœ¨é”çš„ value é‡ŒåŠ ä¸Šäº†ä¸€ä¸ª é‡å…¥æ¬¡æ•°ï¼Œå¹¶åˆ©ç”¨ Redis Hash ç»“æ„æ¥å­˜å‚¨ã€‚\nHash ç»“æ„é‡Œæœ‰ä¸¤ä¸ªå€¼ï¼š\nfieldï¼šå½“å‰çº¿ç¨‹çš„æ ‡è¯†ï¼ˆUUID + threadIdï¼‰ valueï¼šé‡å…¥æ¬¡æ•° æ‰§è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\næ–¹æ³•ä¸€ç¬¬ä¸€æ¬¡è·å–é”ï¼šé‡å…¥æ¬¡æ•° +1ï¼Œå˜æˆ 1 æ–¹æ³•ä¸€è°ƒç”¨æ–¹æ³•äºŒï¼Œæ–¹æ³•äºŒåˆè¦ç”¨é”ï¼šé‡å…¥æ¬¡æ•°å† +1ï¼Œå˜æˆ 2 æ–¹æ³•äºŒæ‰§è¡Œå®Œé‡Šæ”¾é”ï¼šé‡å…¥æ¬¡æ•° -1ï¼Œå˜å› 1 æ–¹æ³•ä¸€æ‰§è¡Œå®Œé‡Šæ”¾é”ï¼šé‡å…¥æ¬¡æ•° -1ï¼Œå˜å› 0ï¼Œé”æ‰çœŸæ­£é‡Šæ”¾ è¿™æ ·å°±é¿å…äº†åŒä¸€ä¸ªçº¿ç¨‹å› ä¸ºåµŒå¥—è°ƒç”¨è€Œæ­»é”ã€‚\n6. æ ¸å¿ƒå®ç°åŸç† 6.1 åŠ é”æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 -- åŠ é”è„šæœ¬ if (redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) == 0) then redis.call(\u0026#39;hset\u0026#39;, KEYS[1], ARGV[2], 1); redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); return nil; end; if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[2]) == 1) then redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); return nil; end; return redis.call(\u0026#39;pttl\u0026#39;, KEYS[1]); 6.2 é‡Šæ”¾é”æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 -- é‡Šæ”¾é”è„šæœ¬ if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[3]) == 0) then return nil; end; local counter = redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[3], -1); if (counter \u0026gt; 0) then redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[2]); return 0; else redis.call(\u0026#39;del\u0026#39;, KEYS[1]); redis.call(\u0026#39;publish\u0026#39;, KEYS[2], ARGV[1]); return 1; end; 7. å…³é”®ç‰¹æ€§ 7.1 çº¿ç¨‹å®‰å…¨ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ é¿å…ç«æ€æ¡ä»¶ 7.2 è‡ªåŠ¨ç»­æœŸ é€šè¿‡ pexpire è‡ªåŠ¨ç»­æœŸ é˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ 7.3 å…¬å¹³æ€§ æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é” é€šè¿‡é˜Ÿåˆ—æœºåˆ¶ä¿è¯è·å–é”çš„é¡ºåº 7.4 å¯é‡å…¥æ€§ åŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å–é” é€šè¿‡é‡å…¥è®¡æ•°å™¨å®ç° 8. ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // è·å–å¯é‡å…¥é” RLock lock = redisson.getLock(\u0026#34;myLock\u0026#34;); try { // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…100ç§’ï¼Œä¸Šé”ä»¥å10ç§’è‡ªåŠ¨è§£é” boolean res = lock.tryLock(100, 10, TimeUnit.SECONDS); if (res) { try { // ä¸šåŠ¡é€»è¾‘ doSomething(); } finally { lock.unlock(); } } } catch (InterruptedException e) { e.printStackTrace(); } 9. æ€»ç»“å‡å æ™®é€šåˆ†å¸ƒå¼é”åªå…³å¿ƒ \u0026ldquo;æœ‰é” / æ— é”\u0026rdquo;ï¼Œä¸å…³å¿ƒæ˜¯è°åŠ çš„é”ï¼Œå¯¼è‡´ åŒä¸€çº¿ç¨‹é‡å…¥æ—¶ä¹Ÿä¼šå¤±è´¥ã€‚\nRedisson é€šè¿‡åœ¨ Redis çš„ Hash ç»“æ„ ä¸­è®°å½• \u0026ldquo;çº¿ç¨‹æ ‡è¯† + é‡å…¥è®¡æ•°\u0026rdquo;ï¼Œè®©é”å…·å¤‡äº† å¯é‡å…¥èƒ½åŠ›ã€‚\næ„ä¹‰ï¼šå¯é‡å…¥é”é¿å…äº†ä¸€ä¸ªçº¿ç¨‹åœ¨åµŒå¥—è°ƒç”¨ä¸­æŠŠè‡ªå·±å¡æ­»ï¼ŒåŒæ—¶å¯¹å¤–ä»ç„¶ä¿æŒåˆ†å¸ƒå¼é”çš„ç‰¹æ€§ã€‚\nä¸€å¥è¯æ€»ç»“ï¼š Redisson çš„å¯é‡å…¥é”ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç”¨ Redis Hash å­˜å‚¨çº¿ç¨‹ ID å’Œé‡å…¥æ¬¡æ•°ï¼Œç›´åˆ°é‡å…¥æ¬¡æ•°å½’é›¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\n10. æ‰©å±•é˜…è¯» Redisson å®˜æ–¹æ–‡æ¡£ Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ Java å¹¶å‘ç¼–ç¨‹å®æˆ˜ æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† Redisson å¯é‡å…¥é”çš„å®ç°åŸç†ï¼Œå¸®åŠ©å¼€å‘è€…æ·±å…¥ç†è§£åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæœºåˆ¶ã€‚\n","date":"2025-09-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/redisson-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/","title":"Redisson å¯é‡å…¥é”åŸç†è¯¦è§£"},{"content":"æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨ åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå°¤å…¶æ˜¯ç§’æ€ç³»ç»Ÿï¼Œå¦‚ä½•ä¿è¯åº“å­˜æ‰£å‡çš„æ­£ç¡®æ€§å’Œç”¨æˆ·é™è´­çš„å‡†ç¡®æ€§ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„é—®é¢˜ã€‚\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹ï¼Œè¯¦ç»†è®²è§£ Redis + Lua è„šæœ¬ åœ¨ç§’æ€æ´»åŠ¨ä¸­çš„ä½¿ç”¨æ–¹å¼ã€‚\nä¸€ã€èƒŒæ™¯ä»‹ç» åœ¨ç§’æ€åœºæ™¯ä¸­ï¼Œå¦‚æœå•çº¯ä¾èµ–åç«¯æ•°æ®åº“è¿›è¡Œåº“å­˜æ‰£å‡ä¸ç”¨æˆ·æ ¡éªŒï¼Œå¾€å¾€ä¼šäº§ç”Ÿä»¥ä¸‹é—®é¢˜ï¼š\né«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼šå¤§é‡ç”¨æˆ·åŒæ—¶ä¸‹å•ï¼Œæ•°æ®åº“å®¹æ˜“è¢«æ‰“çˆ†ã€‚ è¶…å–é—®é¢˜ï¼šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°åº“å­˜è¢«æ‰£æˆè´Ÿæ•°çš„æƒ…å†µã€‚ é™è´­é€»è¾‘å¤±æ•ˆï¼šå¦‚æœå¹¶å‘æ§åˆ¶ä¸å¥½ï¼ŒåŒä¸€ç”¨æˆ·å¯èƒ½ç»•è¿‡é™è´­é™åˆ¶ã€‚ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬é€šå¸¸ä¼š å°†ç§’æ€çš„æ ¸å¿ƒé€»è¾‘æ”¾åˆ° Redis é‡Œï¼Œåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½ä¸ Lua è„šæœ¬çš„åŸå­æ€§ï¼Œæ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\näºŒã€Redis Key è®¾è®¡ åœ¨è¿™ä¸ªç§’æ€ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªæ´»åŠ¨è®¾è®¡äº†ä¸¤ä¸ªå…³é”®çš„ Redis Keyï¼š\n1. åº“å­˜ Key 1 seckill:stock:{activityId} ä½œç”¨ï¼šå­˜æ”¾æŸä¸ªæ´»åŠ¨çš„å‰©ä½™åº“å­˜æ•°é‡ã€‚\nç¤ºä¾‹ï¼š\n1 SET seckill:stock:1001 50 è¡¨ç¤ºæ´»åŠ¨ 1001 è¿˜æœ‰ 50 ä»¶å•†å“ã€‚\n2. å‚ä¸ç”¨æˆ· Key 1 seckill:participants:{activityId} ä½œç”¨ï¼šå­˜æ”¾æŸä¸ªæ´»åŠ¨æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€‚\nç¤ºä¾‹ï¼š\n1 2 HSET seckill:participants:1001 12345 1 HSET seckill:participants:1001 67890 2 è¡¨ç¤ºï¼š\nç”¨æˆ· 12345 å·²ç»è´­ä¹° 1 ä»¶ ç”¨æˆ· 67890 å·²ç»è´­ä¹° 2 ä»¶ ä¸‰ã€Java ä»£ç è°ƒç”¨ Lua è„šæœ¬ åœ¨åç«¯ä¸­ï¼Œè°ƒç”¨ Lua è„šæœ¬çš„æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 String stockKey = seckillPrefix + \u0026#34;stock:\u0026#34; + activityId; String participantsKey = seckillPrefix + \u0026#34;participants:\u0026#34; + activityId; DefaultRedisScript\u0026lt;List\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptSource(new ResourceScriptSource(new ClassPathResource(\u0026#34;seckill_participate.lua\u0026#34;))); script.setResultType(List.class); List\u0026lt;String\u0026gt; keys = Arrays.asList(stockKey, participantsKey); List\u0026lt;Object\u0026gt; args = Arrays.asList( userId.toString(), quantity.toString(), activity.getPerUserLimit().toString() ); List result = redisTemplate.execute(script, keys, args.toArray()); å‚æ•°ä¼ é€’è¯´æ˜ è¿™é‡Œéœ€è¦é‡ç‚¹ç†è§£çš„æœ‰ä¸¤éƒ¨åˆ†ï¼š\nkeys â†’ ä¼ é€’ç»™ Lua çš„ Redis Keyï¼Œè„šæœ¬é‡Œç”¨ KEYS[] è®¿é—®ï¼š\nKEYS[1] = \u0026quot;seckill:stock:1001\u0026quot; ï¼ˆè¿™ä¸ªæ´»åŠ¨çš„åº“å­˜ï¼‰ KEYS[2] = \u0026quot;seckill:participants:1001\u0026quot; ï¼ˆè®°å½•äº†è¿™ä¸ªæ´»åŠ¨æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼‰ args â†’ é™„åŠ å‚æ•°ï¼Œè„šæœ¬é‡Œç”¨ ARGV[] è®¿é—®ï¼š\nARGV[1] = userId ï¼ˆå½“å‰ç”¨æˆ· IDï¼‰ ARGV[2] = quantity ï¼ˆæœ¬æ¬¡è´­ä¹°æ•°é‡ï¼‰ ARGV[3] = perUserLimit ï¼ˆæ¯äººé™è´­æ•°é‡ï¼‰ å››ã€Lua è„šæœ¬é€»è¾‘è¯¦è§£ Lua è„šæœ¬å…·æœ‰åŸå­æ€§ï¼Œåœ¨ Redis ä¸­æ‰§è¡Œæ—¶ä¸ä¼šè¢«æ‰“æ–­ï¼Œéå¸¸é€‚åˆç§’æ€åœºæ™¯ã€‚\nå…¸å‹çš„ seckill_participate.lua è„šæœ¬å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 -- è·å–å‚æ•° local stock = tonumber(redis.call(\u0026#34;GET\u0026#34;, KEYS[1])) local userId = ARGV[1] local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) -- æŸ¥è¯¢ç”¨æˆ·å·²è´­ä¹°æ•°é‡ local userBought = tonumber(redis.call(\u0026#34;HGET\u0026#34;, KEYS[2], userId) or \u0026#34;0\u0026#34;) -- 1. æ ¡éªŒæ˜¯å¦è¶…è¿‡ä¸ªäººé™è´­ if userBought + quantity \u0026gt; perUserLimit then return {0, \u0026#34;è¶…è¿‡ä¸ªäººé™è´­\u0026#34;} end -- 2. æ ¡éªŒåº“å­˜æ˜¯å¦è¶³å¤Ÿ if stock \u0026lt; quantity then return {0, \u0026#34;åº“å­˜ä¸è¶³\u0026#34;} end -- 3. æ‰£å‡åº“å­˜ redis.call(\u0026#34;DECRBY\u0026#34;, KEYS[1], quantity) -- 4. æ›´æ–°ç”¨æˆ·è´­ä¹°æ•°é‡ redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, quantity) -- 5. è¿”å›æˆåŠŸ return {1, \u0026#34;æˆåŠŸ\u0026#34;} è„šæœ¬æ‰§è¡Œæµç¨‹è¯¦è§£ è®©æˆ‘ä»¬é€æ­¥åˆ†æè¿™ä¸ªè„šæœ¬çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\n1. å‚æ•°æ¥æ”¶ 1 2 3 local userId = ARGV[1] -- æ¥æ”¶ç”¨æˆ·ID local quantity = tonumber(ARGV[2]) -- æ¥æ”¶è´­ä¹°æ•°é‡ local perUserLimit = tonumber(ARGV[3]) -- æ¥æ”¶é™è´­æ•°é‡ åç«¯é€šè¿‡ redisTemplate.execute(...) ä¼ å…¥è¿™äº› ARGV å‚æ•°ç»™ Lua è„šæœ¬ï¼Œè„šæœ¬æ¥æ”¶æ¯ä¸ªå‚æ•°ã€‚\n2. æŸ¥è¯¢ç”¨æˆ·è´­ä¹°è®°å½• 1 local userBought = tonumber(redis.call(\u0026#34;HGET\u0026#34;, KEYS[2], userId) or \u0026#34;0\u0026#34;) è¿™æ®µä»£ç çš„ä½œç”¨ï¼šæŸ¥è¯¢å½“å‰ userId çš„è´­ä¹°è®°å½•ã€‚\nåŸç†ï¼šå› ä¸ºä¼ å…¥äº† participantsKeyï¼ˆè¿™ä¸ªæ´»åŠ¨çš„ç”¨æˆ·è´­ä¹°è®°å½•ï¼‰å’Œ userIdï¼ˆè¿™ä¸ªç”¨æˆ·ï¼‰ï¼Œå°±å¯ä»¥æ ¹æ® userId åœ¨ participantsKey é‡Œé¢æŸ¥å‡ºå¯¹åº”çš„ç”¨æˆ·è´­ä¹°è®°å½•ã€‚\n3. é™è´­æ ¡éªŒ 1 2 3 if userBought + quantity \u0026gt; perUserLimit then return {0, \u0026#34;è¶…è¿‡ä¸ªäººé™è´­\u0026#34;} end åˆ¤æ–­é€»è¾‘ï¼šç”¨æˆ·ç›®å‰å·²è´­ä¹°æ•° + æ–°è´­ä¹°æ•° quantity æ˜¯å¦å¤§äºæœ€å¤§è´­ä¹°é‡ perUserLimitã€‚\nå¦‚æœæ˜¯ï¼Œè¿”å› {0, \u0026quot;è¶…è¿‡ä¸ªäººé™è´­\u0026quot;} å¦‚æœä¸æ˜¯ï¼Œç»§ç»­ä¸‹ä¸€æ­¥ 4. åº“å­˜æ ¡éªŒ 1 2 3 if stock \u0026lt; quantity then return {0, \u0026#34;åº“å­˜ä¸è¶³\u0026#34;} end æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿï¼Œåˆ™è¿”å› {0, \u0026quot;åº“å­˜ä¸è¶³\u0026quot;}ã€‚\n5. æ‰§è¡Œè´­ä¹°æ“ä½œ 1 2 3 4 5 -- æ‰£å‡åº“å­˜ redis.call(\u0026#34;DECRBY\u0026#34;, KEYS[1], quantity) -- è®°å½•ç”¨æˆ·è´­ä¹°æ•°é‡ redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, quantity) å¦‚æœåº“å­˜è¶³å¤Ÿï¼Œåˆ™ï¼š\næ‰£å‡åº“å­˜ï¼šDECRBY å‘½ä»¤å°†åº“å­˜å‡å°‘ quantity æ•°é‡ è®°å½•ç”¨æˆ·è´­ä¹°æ•°é‡ï¼šHINCRBY å‘½ä»¤å°†ç”¨æˆ·çš„è´­ä¹°è®°å½•å¢åŠ  quantity æ•°é‡ 6. è¿”å›æˆåŠŸ 1 return {1, \u0026#34;æˆåŠŸ\u0026#34;} æœ€åè¿”å› {1, \u0026quot;æˆåŠŸ\u0026quot;}ï¼Œè¡¨ç¤ºè´­ä¹°æˆåŠŸã€‚\näº”ã€æ‰§è¡Œæµç¨‹ç¤ºä¾‹ æˆ‘ä»¬ä»¥ç”¨æˆ· 12345 å‚ä¸æ´»åŠ¨ 1001 ä¸ºä¾‹ï¼Œå‡è®¾åˆå§‹åº“å­˜ä¸º 10ï¼Œé™è´­ä¸º 3ï¼š\nç¬¬ä¸€æ¬¡è´­ä¹°ï¼ˆä¹° 2 ä»¶ï¼‰ è¾“å…¥å‚æ•°ï¼š\nKEYS[1] = seckill:stock:1001 KEYS[2] = seckill:participants:1001 ARGV[1] = \u0026quot;12345\u0026quot; ARGV[2] = \u0026quot;2\u0026quot; ARGV[3] = \u0026quot;3\u0026quot; è„šæœ¬æ‰§è¡Œï¼š\nuserBought = 0ï¼ˆæ²¡ä¹°è¿‡ï¼‰ stock = 10ï¼Œè¶³å¤Ÿ æ‰£å‡åº“å­˜ï¼šDECRBY seckill:stock:1001 2 â†’ åº“å­˜å˜ 8 æ›´æ–°è´­ä¹°è®°å½•ï¼šHINCRBY seckill:participants:1001 12345 2 â†’ ç”¨æˆ·ä¹°äº† 2 ä»¶ è¿”å› {1, \u0026quot;æˆåŠŸ\u0026quot;} ç¬¬äºŒæ¬¡è´­ä¹°ï¼ˆå†ä¹° 2 ä»¶ï¼‰ è¾“å…¥å‚æ•°ï¼š\nARGV[1] = \u0026quot;12345\u0026quot; ARGV[2] = \u0026quot;2\u0026quot; ARGV[3] = \u0026quot;3\u0026quot; è„šæœ¬æ‰§è¡Œï¼š\nuserBought = 2ï¼ˆä¸Šæ¬¡ä¹°äº† 2 ä»¶ï¼‰ æœ¬æ¬¡è¦ä¹° 2 ä»¶ï¼Œæ€»æ•° = 4 \u0026gt; é™è´­ 3 è¿”å› {0, \u0026quot;è¶…è¿‡ä¸ªäººé™è´­\u0026quot;} å…­ã€æ ¸å¿ƒä¼˜åŠ¿ é€šè¿‡ Redis Key è®¾è®¡ + Lua è„šæœ¬åŸå­æ‰§è¡Œï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š\n1. é˜²æ­¢è¶…å– åº“å­˜æ‰£å‡å’Œç”¨æˆ·è´­ä¹°è®°å½•æ›´æ–°åœ¨åŒä¸€ä¸ªè„šæœ¬é‡Œå®Œæˆï¼Œä¿è¯äº†åŸå­æ€§ã€‚\n2. é™è´­æ§åˆ¶ åˆ©ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ç”¨æˆ·è´­ä¹°è®°å½•ï¼Œç»“åˆ Lua è„šæœ¬æ ¡éªŒï¼Œé¿å…äº†ç”¨æˆ·ç»•è¿‡é™è´­ã€‚\n3. é«˜å¹¶å‘æ€§èƒ½ é€»è¾‘å…¨éƒ¨åœ¨ Redis å†…éƒ¨æ‰§è¡Œï¼Œä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œæ€§èƒ½æé«˜ã€‚\n4. æ•°æ®ä¸€è‡´æ€§ Lua è„šæœ¬çš„åŸå­æ€§ä¿è¯äº†æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nä¸ƒã€å®é™…åº”ç”¨åœºæ™¯ è¿™ç§æ–¹å¼æ˜¯å¾ˆå¤šç”µå•†å¹³å°åœ¨ç§’æ€åœºæ™¯ä¸­çš„æ ‡å‡†åšæ³•ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œå¸¸è§çš„\u0026quot;æ•°æ®åº“å‰Šå³°\u0026quot;ä¸\u0026quot;Redis é™æµ\u0026quot;çš„ç»“åˆåº”ç”¨ã€‚\né€‚ç”¨åœºæ™¯ ç§’æ€æ´»åŠ¨ é™æ—¶æŠ¢è´­ é™é‡å•†å“é”€å”® ä¼˜æƒ åˆ¸å‘æ”¾ ç§¯åˆ†å…‘æ¢ æŠ€æœ¯ç‰¹ç‚¹ é«˜æ€§èƒ½ï¼šRedis å†…å­˜æ“ä½œï¼Œå“åº”é€Ÿåº¦å¿« åŸå­æ€§ï¼šLua è„šæœ¬ä¿è¯æ“ä½œåŸå­æ€§ å¯æ‰©å±•ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² å¯é æ€§ï¼šé¿å…è¶…å–å’Œé‡å¤è´­ä¹° å…«ã€å»¶ä¼¸æ€è€ƒ 1. é€€æ¬¾é€€è´§æ”¯æŒ å¦‚æœè¦æ”¯æŒé€€æ¬¾é€€è´§ï¼Œéœ€è¦åœ¨ Lua è„šæœ¬é‡Œå¢åŠ åº“å­˜å›æ»šé€»è¾‘ï¼š\n1 2 3 4 -- é€€æ¬¾æ—¶å›æ»šåº“å­˜ redis.call(\u0026#34;INCRBY\u0026#34;, KEYS[1], quantity) -- å‡å°‘ç”¨æˆ·è´­ä¹°è®°å½• redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, -quantity) 2. åˆ†ç‰‡å­˜å‚¨ä¼˜åŒ– å¦‚æœæ´»åŠ¨å•†å“æ•°é‡éå¸¸å¤§ï¼Œå¯ä»¥è€ƒè™‘åˆ†ç‰‡å­˜å‚¨åº“å­˜ï¼Œè¿›ä¸€æ­¥æé«˜å¹¶å‘æ€§èƒ½ï¼š\n1 2 -- æ ¹æ®ç”¨æˆ·IDè¿›è¡Œåˆ†ç‰‡ local shardKey = \u0026#34;seckill:stock:\u0026#34; .. activityId .. \u0026#34;:\u0026#34; .. (userId % 10) 3. å¼‚æ­¥å¤„ç† åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿˜éœ€è¦é…åˆæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰å’Œå¼‚æ­¥ä¸‹å•ï¼Œä»¥ä¿è¯åç»­æ•°æ®åº“å†™å…¥çš„å¯é æ€§ã€‚ è¯¦æƒ…å¯å‰å¾€æ­¤å¤„äº†è§£https://yin123-ybh.github.io/p/å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æå«redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°/\n4. ç›‘æ§å’Œå‘Šè­¦ ç›‘æ§ Redis æ€§èƒ½æŒ‡æ ‡ è®¾ç½®åº“å­˜å‘Šè­¦é˜ˆå€¼ è®°å½•ç”¨æˆ·è´­ä¹°è¡Œä¸ºæ—¥å¿— ä¹ã€æ€»ç»“ Redis + Lua è„šæœ¬åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ ¸å¿ƒé—®é¢˜ï¼š\nåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½ï¼šå°†æ ¸å¿ƒé€»è¾‘ä»æ•°æ®åº“è½¬ç§»åˆ°å†…å­˜ ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼šLua è„šæœ¬ç¡®ä¿æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ å®ç°ç²¾ç¡®çš„é™è´­æ§åˆ¶ï¼šé€šè¿‡å“ˆå¸Œè¡¨è®°å½•ç”¨æˆ·è´­ä¹°å†å² é¿å…è¶…å–é—®é¢˜ï¼šåº“å­˜æ‰£å‡å’Œç”¨æˆ·è®°å½•æ›´æ–°åœ¨åŒä¸€è„šæœ¬ä¸­å®Œæˆ è¿™ç§æ–¹æ¡ˆä¸ä»…é€‚ç”¨äºç§’æ€ç³»ç»Ÿï¼Œåœ¨éœ€è¦é«˜å¹¶å‘ã€å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä¸­éƒ½æœ‰å¹¿æ³›åº”ç”¨ä»·å€¼ã€‚\nä»¥ä¸Šå°±æ˜¯å…³äºç§’æ€ç³»ç»Ÿä¸­ Redis + Lua è„šæœ¬çš„å®Œæ•´åº”ç”¨è§£æã€‚é€šè¿‡æ·±å…¥ç†è§£è¿™äº›æ ¸å¿ƒæ¦‚å¿µï¼Œä½ å°±èƒ½åœ¨å®é™…é¡¹ç›®ä¸­çµæ´»è¿ç”¨è¿™äº›æŠ€æœ¯ï¼Œæ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯é çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\n","date":"2025-09-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-redis--lua-%E5%9C%A8%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/","title":"æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨"},{"content":"å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰ ç§’æ€ç³»ç»Ÿæ˜¯ç”µå•†é«˜å¹¶å‘åœºæ™¯çš„å…¸å‹åº”ç”¨ï¼ŒçŸ­æ—¶é—´å†…å¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­æœ‰é™å•†å“ï¼Œå¦‚ä½•ä¿è¯åº“å­˜ä¸è¶…å–ã€ç³»ç»Ÿé«˜å¯ç”¨ã€å“åº”å¿«é€Ÿï¼Œæ˜¯æŠ€æœ¯è®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ã€‚æœ¬æ–‡å°†ç»“åˆå¼‚æ­¥ç§’æ€æ€è·¯ã€Redisåº“å­˜é¢„æ‰£ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å‰åç«¯è§£è€¦ç­‰æŠ€æœ¯ç‚¹ï¼Œæ·±å…¥è®²è§£ç§’æ€ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼Œå¹¶ç”¨ç±»æ¯”å’Œæµç¨‹è§£æï¼Œå¸®åŠ©ä½ ç†è§£é«˜å¹¶å‘å¤„ç†èƒŒåçš„åŸç†ã€‚\n1ï¸âƒ£ ç§’æ€åœºæ™¯é—®é¢˜åˆ†æ ç§’æ€åœºæ™¯ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜å¹¶å‘ï¼šçŸ­æ—¶é—´å†…æˆåƒä¸Šä¸‡ç”¨æˆ·æŠ¢è´­åŒä¸€å•†å“ åº“å­˜æœ‰é™ï¼šå•†å“æ•°é‡æœ‰é™ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶ ç³»ç»Ÿå‹åŠ›å¤§ï¼šæ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ å¸¸è§é—®é¢˜ï¼š è¶…å–ï¼šåº“å­˜è¢«å¤šæ¬¡æ‰£å‡ï¼Œå–å‡ºè¶…è¿‡å®é™…æ•°é‡ æ•°æ®åº“å‹åŠ›å¤§ï¼šå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ï¼Œå®¹æ˜“å¯¼è‡´å®•æœº ç½‘ç»œå»¶è¿Ÿå’Œå“åº”æ…¢ï¼šç”¨æˆ·ä½“éªŒå·® å¹¶å‘äº‹åŠ¡å†²çªï¼šæ™®é€šé”æˆ–äº‹åŠ¡å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆé”™è¯¯å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // âŒ é”™è¯¯å®ç°ï¼šç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå®¹æ˜“è¶…å– @RestController public class SeckillController { @Autowired private ProductService productService; @Autowired private OrderService orderService; @PostMapping(\u0026#34;/seckill\u0026#34;) public Result seckill(@RequestParam Long productId, @RequestParam Long userId) { // 1. æŸ¥è¯¢åº“å­˜ Product product = productService.getById(productId); if (product.getStock() \u0026lt;= 0) { return Result.fail(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); } // 2. æ‰£å‡åº“å­˜ - è¿™é‡Œå¯èƒ½å‡ºç°è¶…å–ï¼ product.setStock(product.getStock() - 1); productService.updateById(product); // 3. åˆ›å»ºè®¢å• Order order = new Order(); order.setProductId(productId); order.setUserId(userId); orderService.save(order); return Result.success(\u0026#34;ç§’æ€æˆåŠŸ\u0026#34;); } } 2ï¸âƒ£ åŒæ­¥ vs å¼‚æ­¥ç§’æ€ ç§’æ€å¤„ç†å¯ä»¥åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š\næ–¹å¼ ç”¨æˆ·è¯·æ±‚ åç«¯å¤„ç† ä¼˜ç¼ºç‚¹ åŒæ­¥ ç”¨æˆ·è¯·æ±‚ç›´æ¥è°ƒç”¨æ•°æ®åº“ ç«‹å³å¤„ç†åº“å­˜å’Œè®¢å• é«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›å¤§ï¼Œå®¹æ˜“é˜»å¡ï¼Œè¶…å–é£é™©é«˜ å¼‚æ­¥ ç”¨æˆ·è¯·æ±‚å…ˆè¿›å…¥é˜Ÿåˆ—æˆ–ç¼“å­˜ åå°å¼‚æ­¥æ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¾æ¬¡å¤„ç†åº“å­˜å’Œè®¢å• å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œå‰Šå³°å¡«è°·ï¼Œé˜²æ­¢è¶…å– æ ¸å¿ƒåŒºåˆ«ï¼š åŒæ­¥æ¨¡å¼ï¼šå‰ç«¯ç­‰å¾…åç«¯å®Œæˆæ‰€æœ‰æ“ä½œ å¼‚æ­¥æ¨¡å¼ï¼šå‰ç«¯è¯·æ±‚å…ˆæ’é˜Ÿï¼Œåå°æ…¢æ…¢å¤„ç†ä¸šåŠ¡ï¼Œè¯·æ±‚å¤„ç†ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦ 3ï¸âƒ£ å¼‚æ­¥ç§’æ€æ ¸å¿ƒæ€è·¯ å¼‚æ­¥ç§’æ€é€šè¿‡ä»¥ä¸‹æµç¨‹å®ç°é«˜å¹¶å‘å¤„ç†ï¼š\næ­¥éª¤ 1ï¼šæ¥æ”¶è¯·æ±‚ï¼ˆæ¥å£å±‚ï¼‰ ç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®ï¼Œå‰ç«¯è¯·æ±‚ç§’æ€æ¥å£ã€‚\næ¥å£å±‚å¿«é€Ÿåˆ¤æ–­ï¼š\nå•†å“æ˜¯å¦è¿˜æœ‰åº“å­˜ ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å• åˆ¤æ–­é€šè¿‡ï¼š\nä½¿ç”¨ Redis + Lua è„šæœ¬è¿›è¡Œåº“å­˜é¢„æ‰£ï¼ˆåŸå­æ“ä½œï¼‰ ç”Ÿæˆè®¢å• ID æˆ–è¯·æ±‚ ID å°†è¯·æ±‚å°è£…æˆæ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQã€Kafkaã€Redis Stream ç­‰ï¼‰ æ¥å£ç«‹å³è¿”å›ç»™å‰ç«¯ï¼š\n\u0026ldquo;æ’é˜ŸæˆåŠŸ\u0026quot;æˆ–\u0026quot;è¯·æ±‚å·²æ¥æ”¶\u0026rdquo; âš¡ æ³¨æ„ï¼šå‰ç«¯ç”¨æˆ·æ­¤æ—¶å¹¶æœªç›´æ¥æ‹¿åˆ°æœ€ç»ˆè®¢å•ï¼Œåªæ˜¯æ‹¿åˆ°ä¸€ä¸ª\u0026quot;æŠ¢è´­å‡­è¯\u0026quot;ã€‚\næ­¥éª¤ 2ï¼šå¼‚æ­¥å¤„ç†è¯·æ±‚ï¼ˆåå°æœåŠ¡ï¼‰ æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ï¼š\næ‰£æ•°æ®åº“åº“å­˜ åˆ›å»ºè®¢å•è®°å½• æ ‡è®°ç”¨æˆ·å·²ä¸‹å• å¤„ç†å®Œæˆåé€šçŸ¥ç”¨æˆ·ï¼š\nç§’æ€æˆåŠŸï¼ˆè®¢å•ç”ŸæˆæˆåŠŸï¼‰ ç§’æ€å¤±è´¥ï¼ˆåº“å­˜ä¸è¶³ï¼‰ æ­¥éª¤ 3ï¼šåº“å­˜æ§åˆ¶ Redisåº“å­˜é¢„å‡ï¼š\nç§’æ€å‰ï¼Œå°†å•†å“åº“å­˜åŠ è½½åˆ° Redis ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œç”¨ Redis åŸå­æ“ä½œ DECR æ‰£å‡åº“å­˜ æ‰£å‡æˆåŠŸ â†’ æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ— æ‰£å‡å¤±è´¥ â†’ ç§’æ€ç»“æŸï¼Œè¿”å›å¤±è´¥ å¯ä½¿ç”¨ Lua è„šæœ¬å°† åˆ¤æ–­åº“å­˜ \u0026gt; 0 + æ‰£å‡åº“å­˜ åšæˆåŸå­æ“ä½œï¼Œé¿å…è¶…å–\næ­¥éª¤ 4ï¼šç”¨æˆ·é€šçŸ¥ ç§’æ€ç»“æœå¼‚æ­¥è¿”å›ï¼š\nè½®è¯¢æ¥å£ WebSocket æ¶ˆæ¯æ¨é€ å‰ç«¯ç”¨æˆ·æ‹¿åˆ°æœ€ç»ˆç»“æœåï¼Œç¡®è®¤æ˜¯å¦æŠ¢è´­æˆåŠŸ\n4ï¸âƒ£ æ¥å£å±‚å¿«é€Ÿåˆ¤æ–­åº“å­˜ä¸ç”¨æˆ·èµ„æ ¼ æ¥å£å±‚ä¸ºä»€ä¹ˆå¯ä»¥å¿«é€Ÿåˆ¤æ–­åº“å­˜å’Œç”¨æˆ·æ˜¯å¦ç¬¦åˆä¸‹å•è¦æ±‚ï¼Ÿæ ¸å¿ƒæ˜¯æå‰æŠŠå…³é”®æ•°æ®ç¼“å­˜åœ¨ Redisï¼š\n4.1 åº“å­˜åˆ¤æ–­ ç§’æ€å¼€å§‹å‰ï¼Œå°†å•†å“åº“å­˜åŠ è½½åˆ° Redisï¼š\n1 2 Key: \u0026#34;stock:å•†å“ID\u0026#34; Value: å‰©ä½™åº“å­˜æ•°é‡ è¯·æ±‚åˆ°æ¥æ—¶ï¼š\n1 DECR stock:å•†å“ID // åŸå­æ“ä½œ è¿”å›å€¼åˆ¤æ–­ï¼š\nâ‰¥0 â†’ åº“å­˜è¿˜æœ‰ï¼Œå…è®¸ä¸‹å• \u0026lt;0 â†’ åº“å­˜ä¸è¶³ï¼Œç§’æ€ç»“æŸ Lua è„šæœ¬å¯å°†\u0026quot;åˆ¤æ–­åº“å­˜ + æ‰£å‡åº“å­˜\u0026quot;åŸå­åŒ–å¤„ç†ï¼Œé¿å…è¶…å–\n4.2 ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• æ¯ä½ç”¨æˆ·åªèƒ½ä¸‹å•ä¸€æ¬¡ï¼š\n1 2 Key: \u0026#34;order:ç”¨æˆ·ID:å•†å“ID\u0026#34; Value: 1 // å·²ä¸‹å• æ¥å£å±‚åˆ¤æ–­ï¼š\n1 2 EXISTS order:ç”¨æˆ·ID:å•†å“ID â†’ å·²ä¸‹å•ï¼Œæ‹’ç» ä¸å­˜åœ¨ â†’ å…è®¸åŠ å…¥é˜Ÿåˆ— âœ… é€šè¿‡ Redis åˆ¤æ–­åº“å­˜ä¸ç”¨æˆ·çŠ¶æ€ï¼Œå®ç°ç§’æ€æ¥å£å¿«é€Ÿå“åº”ï¼Œé¿å…é«˜å¹¶å‘ç›´æ¥æ‰“æ•°æ®åº“ã€‚\n4.3 æ¥å£å±‚å®Œæ•´æµç¨‹ ç”¨æˆ·å‘èµ·è¯·æ±‚ æ¥å£å±‚åˆ¤æ–­åº“å­˜ + ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• åˆ¤æ–­é€šè¿‡ï¼š Redisé¢„æ‰£åº“å­˜ï¼ˆLuaè„šæœ¬ï¼‰ ç”Ÿæˆè®¢å•ID æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ— è¿”å›\u0026quot;æ’é˜ŸæˆåŠŸ\u0026quot;ï¼Œå‰ç«¯æ— éœ€ç­‰å¾…æ•°æ®åº“æ“ä½œ 5ï¸âƒ£ å¼‚æ­¥çš„æ€§èƒ½ä¼˜åŠ¿ å¼‚æ­¥æ¨¡å¼æ¯”åŒæ­¥æ¨¡å¼æ€§èƒ½æ›´å¥½ï¼ŒåŸå› åœ¨äºè§£è€¦è¯·æ±‚å¤„ç†å’Œæ•°æ®åº“æ“ä½œï¼Œé¿å…é˜»å¡ï¼š\nè¯·æ±‚å¤„ç†å¿«ï¼šçº¿ç¨‹åªåšè½»é‡åˆ¤æ–­ + Redis + æ¶ˆæ¯å…¥é˜Ÿ â†’ ç«‹å³é‡Šæ”¾ æµé‡å‰Šå³°å¡«è°·ï¼šé˜Ÿåˆ—ç¼“å†²é«˜å³°è¯·æ±‚ï¼Œæ•°æ®åº“å¹³æ»‘æ¶ˆè´¹ é¿å…è¶…å–ï¼šRedisåŸå­æ‰£å‡ + é˜Ÿåˆ—é¡ºåºæ¶ˆè´¹ ç³»ç»Ÿååé‡é«˜ï¼šWebå±‚å¿«é€Ÿå“åº” + åç«¯å¤šçº¿ç¨‹æˆ–åˆ†å¸ƒå¼å¤„ç† ç±»æ¯”è¯´æ˜ åŒæ­¥ï¼šå‰ç«¯ç›´æ¥ç­‰èœåšå¥½ â†’ é«˜å³°æœŸæ’é•¿é˜Ÿï¼Œå¨æˆ¿å¿™ä¸è¿‡æ¥ å¼‚æ­¥ï¼šå‰ç«¯å…ˆæ‹¿åˆ°å–é¤å· â†’ å¨æˆ¿æŒ‰é¡ºåºåšèœ â†’ ç³»ç»Ÿç¨³å®šï¼Œç”¨æˆ·ä½“éªŒå¥½ 6ï¸âƒ£ æ ¸å¿ƒæŠ€æœ¯å®ç°è¦ç‚¹ æŠ€æœ¯ç¯èŠ‚ å®ç°å…³é”® æ¥å…¥å±‚ é™æµï¼ˆNginx/ç½‘å…³ï¼‰é˜²æ­¢è¯·æ±‚æš´æ¶¨ åº“å­˜åˆ¤æ–­ RedisåŸå­æ“ä½œ DECR + Luaè„šæœ¬ è¯·æ±‚æ’é˜Ÿ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼ˆRabbitMQ/Kafka/Redis Streamï¼‰ è®¢å•å¤„ç† æ¶ˆè´¹ç«¯äº‹åŠ¡å†™æ•°æ®åº“ å»é‡ ç”¨æˆ·ä¸‹å•å‰æ£€æŸ¥æ˜¯å¦å·²ä¸‹å• å‰Šå³°å¡«è°· æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯å¹³æ»‘æ¶ˆè´¹ å¹‚ç­‰æ€§ æ¶ˆè´¹ç«¯ä¿è¯é‡å¤æ¶ˆè´¹ä¸ä¼šäº§ç”Ÿé‡å¤è®¢å• 7ï¸âƒ£ å®Œæ•´ä»£ç å®ç° 7.1 é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 seckill-system/ â”œâ”€â”€ src/main/java/com/seckill/ â”‚ â”œâ”€â”€ controller/ â”‚ â”‚ â””â”€â”€ SeckillController.java â”‚ â”œâ”€â”€ service/ â”‚ â”‚ â”œâ”€â”€ SeckillService.java â”‚ â”‚ â”œâ”€â”€ OrderService.java â”‚ â”‚ â””â”€â”€ ProductService.java â”‚ â”œâ”€â”€ config/ â”‚ â”‚ â”œâ”€â”€ RedisConfig.java â”‚ â”‚ â””â”€â”€ RabbitMQConfig.java â”‚ â”œâ”€â”€ entity/ â”‚ â”‚ â”œâ”€â”€ SeckillOrder.java â”‚ â”‚ â””â”€â”€ SeckillProduct.java â”‚ â”œâ”€â”€ dto/ â”‚ â”‚ â””â”€â”€ SeckillMessage.java â”‚ â”œâ”€â”€ consumer/ â”‚ â”‚ â””â”€â”€ SeckillConsumer.java â”‚ â””â”€â”€ util/ â”‚ â””â”€â”€ RedisLuaScript.java 7.2 å®ä½“ç±»å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // ç§’æ€å•†å“å®ä½“ @Data @Entity @Table(name = \u0026#34;seckill_product\u0026#34;) public class SeckillProduct { @Id private Long id; private String name; private BigDecimal price; private Integer stock; private LocalDateTime startTime; private LocalDateTime endTime; private Integer status; // 0-æœªå¼€å§‹ 1-è¿›è¡Œä¸­ 2-å·²ç»“æŸ } // ç§’æ€è®¢å•å®ä½“ @Data @Entity @Table(name = \u0026#34;seckill_order\u0026#34;) public class SeckillOrder { @Id private String id; private Long userId; private Long productId; private BigDecimal price; private Integer status; // 0-å¾…æ”¯ä»˜ 1-å·²æ”¯ä»˜ 2-å·²å–æ¶ˆ private LocalDateTime createTime; private LocalDateTime payTime; } 7.3 Redisé…ç½®å’ŒLuaè„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @Configuration public class RedisConfig { @Bean public RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate(RedisConnectionFactory factory) { RedisTemplate\u0026lt;String, Object\u0026gt; template = new RedisTemplate\u0026lt;\u0026gt;(); template.setConnectionFactory(factory); // è®¾ç½®åºåˆ—åŒ– Jackson2JsonRedisSerializer\u0026lt;Object\u0026gt; serializer = new Jackson2JsonRedisSerializer\u0026lt;\u0026gt;(Object.class); ObjectMapper mapper = new ObjectMapper(); mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); mapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL); serializer.setObjectMapper(mapper); template.setValueSerializer(serializer); template.setKeySerializer(new StringRedisSerializer()); template.setHashKeySerializer(new StringRedisSerializer()); template.setHashValueSerializer(serializer); template.afterPropertiesSet(); return template; } } // Luaè„šæœ¬å·¥å…·ç±» @Component public class RedisLuaScript { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; // åº“å­˜é¢„æ‰£Luaè„šæœ¬ private static final String STOCK_DECR_SCRIPT = \u0026#34;local stock = redis.call(\u0026#39;get\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if stock == false or tonumber(stock) \u0026lt;= 0 then \u0026#34; + \u0026#34; return -1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;local newStock = redis.call(\u0026#39;decr\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if newStock \u0026lt; 0 then \u0026#34; + \u0026#34; redis.call(\u0026#39;incr\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34; return -1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;return newStock\u0026#34;; // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• private static final String CHECK_USER_ORDER_SCRIPT = \u0026#34;local exists = redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if exists == 1 then \u0026#34; + \u0026#34; return 1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;redis.call(\u0026#39;setex\u0026#39;, KEYS[1], ARGV[1], \u0026#39;1\u0026#39;) \u0026#34; + \u0026#34;return 0\u0026#34;; /** * åŸå­æ€§æ‰£å‡åº“å­˜ */ public Long decrStock(String stockKey) { DefaultRedisScript\u0026lt;Long\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptText(STOCK_DECR_SCRIPT); script.setResultType(Long.class); return redisTemplate.execute(script, Collections.singletonList(stockKey)); } /** * æ£€æŸ¥å¹¶æ ‡è®°ç”¨æˆ·å·²ä¸‹å• */ public Boolean checkAndSetUserOrder(String userOrderKey, int expireSeconds) { DefaultRedisScript\u0026lt;Long\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptText(CHECK_USER_ORDER_SCRIPT); script.setResultType(Long.class); Long result = redisTemplate.execute(script, Collections.singletonList(userOrderKey), String.valueOf(expireSeconds)); return result != null \u0026amp;\u0026amp; result == 0; // 0è¡¨ç¤ºæˆåŠŸè®¾ç½®ï¼Œ1è¡¨ç¤ºå·²å­˜åœ¨ } } 7.4 æ¶ˆæ¯é˜Ÿåˆ—é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 @Configuration public class RabbitMQConfig { // ç§’æ€æ¶ˆæ¯é˜Ÿåˆ— public static final String SECKILL_QUEUE = \u0026#34;seckill.queue\u0026#34;; public static final String SECKILL_EXCHANGE = \u0026#34;seckill.exchange\u0026#34;; public static final String SECKILL_ROUTING_KEY = \u0026#34;seckill.message\u0026#34;; @Bean public Queue seckillQueue() { return QueueBuilder.durable(SECKILL_QUEUE).build(); } @Bean public DirectExchange seckillExchange() { return new DirectExchange(SECKILL_EXCHANGE); } @Bean public Binding seckillBinding() { return BindingBuilder .bind(seckillQueue()) .to(seckillExchange()) .with(SECKILL_ROUTING_KEY); } @Bean public MessageConverter messageConverter() { return new Jackson2JsonMessageConverter(); } } // ç§’æ€æ¶ˆæ¯DTO @Data @AllArgsConstructor @NoArgsConstructor public class SeckillMessage { private Long userId; private Long productId; private String orderId; private LocalDateTime createTime; } 7.5 ç§’æ€æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @RestController @RequestMapping(\u0026#34;/seckill\u0026#34;) @Slf4j public class SeckillController { @Autowired private SeckillService seckillService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * ç§’æ€æ¥å£ */ @PostMapping(\u0026#34;/{productId}\u0026#34;) public Result\u0026lt;String\u0026gt; seckill(@PathVariable Long productId, @RequestParam Long userId) { try { // 1. å‚æ•°æ ¡éªŒ if (productId == null || userId == null) { return Result.fail(\u0026#34;å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34;); } // 2. æ£€æŸ¥ç§’æ€æ´»åŠ¨çŠ¶æ€ if (!seckillService.isSeckillActive(productId)) { return Result.fail(\u0026#34;ç§’æ€æ´»åŠ¨æœªå¼€å§‹æˆ–å·²ç»“æŸ\u0026#34;); } // 3. æ‰§è¡Œç§’æ€ String orderId = seckillService.executeSeckill(productId, userId); if (orderId != null) { return Result.success(\u0026#34;æ’é˜ŸæˆåŠŸï¼Œè®¢å•å·ï¼š\u0026#34; + orderId); } else { return Result.fail(\u0026#34;ç§’æ€å¤±è´¥ï¼Œè¯·é‡è¯•\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;ç§’æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId, e); return Result.fail(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } } /** * æŸ¥è¯¢ç§’æ€ç»“æœ */ @GetMapping(\u0026#34;/result/{orderId}\u0026#34;) public Result\u0026lt;SeckillOrder\u0026gt; getSeckillResult(@PathVariable String orderId) { try { SeckillOrder order = seckillService.getSeckillOrder(orderId); if (order != null) { return Result.success(order); } else { return Result.fail(\u0026#34;è®¢å•ä¸å­˜åœ¨æˆ–å¤„ç†ä¸­\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;æŸ¥è¯¢ç§’æ€ç»“æœå¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return Result.fail(\u0026#34;æŸ¥è¯¢å¤±è´¥\u0026#34;); } } /** * è·å–å•†å“åº“å­˜ */ @GetMapping(\u0026#34;/stock/{productId}\u0026#34;) public Result\u0026lt;Integer\u0026gt; getStock(@PathVariable Long productId) { try { String stockKey = \u0026#34;stock:\u0026#34; + productId; Object stock = redisTemplate.opsForValue().get(stockKey); if (stock != null) { return Result.success(Integer.valueOf(stock.toString())); } else { return Result.success(0); } } catch (Exception e) { log.error(\u0026#34;è·å–åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return Result.fail(\u0026#34;è·å–åº“å­˜å¤±è´¥\u0026#34;); } } } 7.6 ç§’æ€æœåŠ¡å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 @Service @Slf4j public class SeckillService { @Autowired private ProductService productService; @Autowired private OrderService orderService; @Autowired private RedisLuaScript redisLuaScript; @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String STOCK_PREFIX = \u0026#34;stock:\u0026#34;; private static final String USER_ORDER_PREFIX = \u0026#34;user_order:\u0026#34;; private static final int USER_ORDER_EXPIRE = 3600; // 1å°æ—¶ /** * æ£€æŸ¥ç§’æ€æ´»åŠ¨æ˜¯å¦è¿›è¡Œä¸­ */ public boolean isSeckillActive(Long productId) { try { SeckillProduct product = productService.getById(productId); if (product == null) { return false; } LocalDateTime now = LocalDateTime.now(); return product.getStatus() == 1 \u0026amp;\u0026amp; now.isAfter(product.getStartTime()) \u0026amp;\u0026amp; now.isBefore(product.getEndTime()); } catch (Exception e) { log.error(\u0026#34;æ£€æŸ¥ç§’æ€æ´»åŠ¨çŠ¶æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return false; } } /** * æ‰§è¡Œç§’æ€ */ public String executeSeckill(Long productId, Long userId) { try { // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• String userOrderKey = USER_ORDER_PREFIX + userId + \u0026#34;:\u0026#34; + productId; if (!redisLuaScript.checkAndSetUserOrder(userOrderKey, USER_ORDER_EXPIRE)) { log.warn(\u0026#34;ç”¨æˆ·å·²ä¸‹å•ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, userId, productId); return null; } // 2. åŸå­æ€§æ‰£å‡åº“å­˜ String stockKey = STOCK_PREFIX + productId; Long remainingStock = redisLuaScript.decrStock(stockKey); if (remainingStock == null || remainingStock \u0026lt; 0) { log.warn(\u0026#34;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId); return null; } // 3. ç”Ÿæˆè®¢å•ID String orderId = generateOrderId(); // 4. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ— SeckillMessage message = new SeckillMessage(); message.setUserId(userId); message.setProductId(productId); message.setOrderId(orderId); message.setCreateTime(LocalDateTime.now()); rabbitTemplate.convertAndSend( RabbitMQConfig.SECKILL_EXCHANGE, RabbitMQConfig.SECKILL_ROUTING_KEY, message ); log.info(\u0026#34;ç§’æ€è¯·æ±‚å·²å…¥é˜Ÿï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, orderId, userId, productId); return orderId; } catch (Exception e) { log.error(\u0026#34;æ‰§è¡Œç§’æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId, e); return null; } } /** * è·å–ç§’æ€è®¢å• */ public SeckillOrder getSeckillOrder(String orderId) { try { return orderService.getByOrderId(orderId); } catch (Exception e) { log.error(\u0026#34;è·å–ç§’æ€è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return null; } } /** * é¢„çƒ­å•†å“åº“å­˜åˆ°Redis */ public void warmUpStock(Long productId) { try { SeckillProduct product = productService.getById(productId); if (product != null \u0026amp;\u0026amp; product.getStock() \u0026gt; 0) { String stockKey = STOCK_PREFIX + productId; redisTemplate.opsForValue().set(stockKey, product.getStock()); log.info(\u0026#34;å•†å“åº“å­˜é¢„çƒ­æˆåŠŸï¼Œå•†å“IDï¼š{}ï¼Œåº“å­˜ï¼š{}\u0026#34;, productId, product.getStock()); } } catch (Exception e) { log.error(\u0026#34;é¢„çƒ­å•†å“åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); } } /** * ç”Ÿæˆè®¢å•ID */ private String generateOrderId() { return \u0026#34;SK\u0026#34; + System.currentTimeMillis() + ThreadLocalRandom.current().nextInt(1000, 9999); } } 7.7 æ¶ˆæ¯æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component @Slf4j public class SeckillConsumer { @Autowired private OrderService orderService; @Autowired private ProductService productService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * æ¶ˆè´¹ç§’æ€æ¶ˆæ¯ */ @RabbitListener(queues = RabbitMQConfig.SECKILL_QUEUE) public void handleSeckillMessage(SeckillMessage message) { log.info(\u0026#34;å¼€å§‹å¤„ç†ç§’æ€æ¶ˆæ¯ï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, message.getOrderId(), message.getUserId(), message.getProductId()); try { // 1. å†æ¬¡æ£€æŸ¥åº“å­˜ï¼ˆåŒé‡ä¿é™©ï¼‰ SeckillProduct product = productService.getById(message.getProductId()); if (product == null || product.getStock() \u0026lt;= 0) { log.warn(\u0026#34;å•†å“ä¸å­˜åœ¨æˆ–åº“å­˜ä¸è¶³ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId()); return; } // 2. åˆ›å»ºè®¢å• SeckillOrder order = new SeckillOrder(); order.setId(message.getOrderId()); order.setUserId(message.getUserId()); order.setProductId(message.getProductId()); order.setPrice(product.getPrice()); order.setStatus(0); // å¾…æ”¯ä»˜ order.setCreateTime(LocalDateTime.now()); // 3. æ‰£å‡æ•°æ®åº“åº“å­˜ boolean stockUpdated = productService.decrStock(message.getProductId()); if (!stockUpdated) { log.warn(\u0026#34;æ‰£å‡æ•°æ®åº“åº“å­˜å¤±è´¥ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId()); return; } // 4. ä¿å­˜è®¢å• orderService.save(order); log.info(\u0026#34;ç§’æ€è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, message.getOrderId(), message.getUserId(), message.getProductId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç§’æ€æ¶ˆæ¯å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId(), e); } } } 7.8 å•†å“æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Service @Transactional public class ProductService { @Autowired private SeckillProductMapper productMapper; /** * æ‰£å‡æ•°æ®åº“åº“å­˜ */ public boolean decrStock(Long productId) { try { int result = productMapper.decrStock(productId); return result \u0026gt; 0; } catch (Exception e) { log.error(\u0026#34;æ‰£å‡æ•°æ®åº“åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return false; } } /** * è·å–å•†å“ä¿¡æ¯ */ public SeckillProduct getById(Long productId) { try { return productMapper.selectById(productId); } catch (Exception e) { log.error(\u0026#34;è·å–å•†å“ä¿¡æ¯å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return null; } } } 7.9 è®¢å•æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Service public class OrderService { @Autowired private SeckillOrderMapper orderMapper; /** * ä¿å­˜è®¢å• */ public void save(SeckillOrder order) { try { orderMapper.insert(order); } catch (Exception e) { log.error(\u0026#34;ä¿å­˜è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, order.getId(), e); throw new RuntimeException(\u0026#34;ä¿å­˜è®¢å•å¤±è´¥\u0026#34;, e); } } /** * æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å• */ public SeckillOrder getByOrderId(String orderId) { try { return orderMapper.selectByOrderId(orderId); } catch (Exception e) { log.error(\u0026#34;æŸ¥è¯¢è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return null; } } } 7.10 æ•°æ®åº“Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // å•†å“Mapper @Mapper public interface SeckillProductMapper extends BaseMapper\u0026lt;SeckillProduct\u0026gt; { /** * æ‰£å‡åº“å­˜ */ @Update(\u0026#34;UPDATE seckill_product SET stock = stock - 1 WHERE id = #{productId} AND stock \u0026gt; 0\u0026#34;) int decrStock(@Param(\u0026#34;productId\u0026#34;) Long productId); } // è®¢å•Mapper @Mapper public interface SeckillOrderMapper extends BaseMapper\u0026lt;SeckillOrder\u0026gt; { /** * æ ¹æ®è®¢å•IDæŸ¥è¯¢ */ @Select(\u0026#34;SELECT * FROM seckill_order WHERE id = #{orderId}\u0026#34;) SeckillOrder selectByOrderId(@Param(\u0026#34;orderId\u0026#34;) String orderId); } 8ï¸âƒ£ å¼‚æ­¥ç§’æ€ä¼˜åŒ–æŠ€å·§ 8.1 æœ¬åœ°ç¼“å­˜åº“å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Component public class LocalStockCache { private final Map\u0026lt;Long, AtomicInteger\u0026gt; localStockMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * è·å–æœ¬åœ°åº“å­˜ */ public int getLocalStock(Long productId) { AtomicInteger stock = localStockMap.get(productId); return stock != null ? stock.get() : 0; } /** * æ‰£å‡æœ¬åœ°åº“å­˜ */ public boolean decrLocalStock(Long productId) { AtomicInteger stock = localStockMap.computeIfAbsent(productId, k -\u0026gt; new AtomicInteger(0)); return stock.decrementAndGet() \u0026gt;= 0; } /** * åŒæ­¥Redisåº“å­˜åˆ°æœ¬åœ° */ @Scheduled(fixedRate = 1000) // æ¯ç§’åŒæ­¥ä¸€æ¬¡ public void syncStockFromRedis() { for (Long productId : localStockMap.keySet()) { String stockKey = \u0026#34;stock:\u0026#34; + productId; Object redisStock = redisTemplate.opsForValue().get(stockKey); if (redisStock != null) { int stock = Integer.parseInt(redisStock.toString()); localStockMap.put(productId, new AtomicInteger(stock)); } } } } 8.2 é™æµé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Configuration public class RateLimitConfig { @Bean public RedisRateLimiter redisRateLimiter() { return new RedisRateLimiter(100, 200); // æ¯ç§’100ä¸ªè¯·æ±‚ï¼Œçªå‘200ä¸ª } } // é™æµæ³¨è§£ @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface RateLimit { String key() default \u0026#34;rate_limit\u0026#34;; int time() default 60; int count() default 100; } // é™æµåˆ‡é¢ @Aspect @Component public class RateLimitAspect { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Around(\u0026#34;@annotation(rateLimit)\u0026#34;) public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable { String key = rateLimit.key(); int time = rateLimit.time(); int count = rateLimit.count(); String rateLimitKey = \u0026#34;rate_limit:\u0026#34; + key + \u0026#34;:\u0026#34; + System.currentTimeMillis() / 1000; Long current = redisTemplate.opsForValue().increment(rateLimitKey); if (current == 1) { redisTemplate.expire(rateLimitKey, time, TimeUnit.SECONDS); } if (current \u0026gt; count) { throw new RuntimeException(\u0026#34;è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } return point.proceed(); } } 8.3 çƒ­ç‚¹å•†å“é¢„çƒ­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class HotProductPreheater { @Autowired private SeckillService seckillService; @Autowired private ProductService productService; /** * é¢„çƒ­çƒ­ç‚¹å•†å“ */ @Scheduled(cron = \u0026#34;0 0 0 * * ?\u0026#34;) // æ¯å¤©å‡Œæ™¨æ‰§è¡Œ public void preheatHotProducts() { List\u0026lt;SeckillProduct\u0026gt; hotProducts = productService.getHotProducts(); for (SeckillProduct product : hotProducts) { seckillService.warmUpStock(product.getId()); } log.info(\u0026#34;çƒ­ç‚¹å•†å“é¢„çƒ­å®Œæˆï¼Œé¢„çƒ­å•†å“æ•°é‡ï¼š{}\u0026#34;, hotProducts.size()); } } 9ï¸âƒ£ ç›‘æ§å’Œå‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Component public class SeckillMonitor { @Autowired private MeterRegistry meterRegistry; private final Counter successCounter = Counter.builder(\u0026#34;seckill.success\u0026#34;).register(meterRegistry); private final Counter failCounter = Counter.builder(\u0026#34;seckill.fail\u0026#34;).register(meterRegistry); private final Timer processTimer = Timer.builder(\u0026#34;seckill.process.time\u0026#34;).register(meterRegistry); /** * è®°å½•ç§’æ€æˆåŠŸ */ public void recordSuccess() { successCounter.increment(); } /** * è®°å½•ç§’æ€å¤±è´¥ */ public void recordFail() { failCounter.increment(); } /** * è®°å½•å¤„ç†æ—¶é—´ */ public void recordProcessTime(Duration duration) { processTimer.record(duration); } } ğŸ”Ÿ å‰ç«¯å®ç°ç¤ºä¾‹ 10.1 Vue.js å‰ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;seckill-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;product-info\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;{{ product.name }}\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;ä»·æ ¼ï¼šÂ¥{{ product.price }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;åº“å­˜ï¼š{{ stock }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;seckill-button\u0026#34;\u0026gt; \u0026lt;button v-if=\u0026#34;!isSeckilling \u0026amp;\u0026amp; stock \u0026gt; 0\u0026#34; @click=\u0026#34;startSeckill\u0026#34; :disabled=\u0026#34;isSeckilling\u0026#34; \u0026gt; ç«‹å³ç§’æ€ \u0026lt;/button\u0026gt; \u0026lt;button v-else-if=\u0026#34;isSeckilling\u0026#34; disabled\u0026gt; æ’é˜Ÿä¸­... \u0026lt;/button\u0026gt; \u0026lt;button v-else disabled\u0026gt; å·²å”®ç½„ \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div v-if=\u0026#34;orderResult\u0026#34; class=\u0026#34;result\u0026#34;\u0026gt; \u0026lt;p v-if=\u0026#34;orderResult.success\u0026#34;\u0026gt;ç§’æ€æˆåŠŸï¼è®¢å•å·ï¼š{{ orderResult.orderId }}\u0026lt;/p\u0026gt; \u0026lt;p v-else\u0026gt;{{ orderResult.message }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; export default { data() { return { product: {}, stock: 0, isSeckilling: false, orderResult: null, pollTimer: null } }, mounted() { this.loadProductInfo(); this.startStockPolling(); }, beforeDestroy() { if (this.pollTimer) { clearInterval(this.pollTimer); } }, methods: { async loadProductInfo() { try { const response = await this.$http.get(`/api/product/${this.$route.params.productId}`); this.product = response.data; } catch (error) { console.error(\u0026#39;åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥\u0026#39;, error); } }, async getStock() { try { const response = await this.$http.get(`/api/seckill/stock/${this.$route.params.productId}`); this.stock = response.data; } catch (error) { console.error(\u0026#39;è·å–åº“å­˜å¤±è´¥\u0026#39;, error); } }, startStockPolling() { this.getStock(); this.pollTimer = setInterval(() =\u0026gt; { this.getStock(); }, 1000); }, async startSeckill() { this.isSeckilling = true; this.orderResult = null; try { const response = await this.$http.post(`/api/seckill/${this.$route.params.productId}`, { userId: this.getCurrentUserId() }); if (response.data.success) { this.orderResult = { success: true, orderId: response.data.data }; this.pollOrderResult(response.data.data); } else { this.orderResult = { success: false, message: response.data.message }; } } catch (error) { this.orderResult = { success: false, message: \u0026#39;ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•\u0026#39; }; } finally { this.isSeckilling = false; } }, async pollOrderResult(orderId) { const maxAttempts = 30; // æœ€å¤šè½®è¯¢30æ¬¡ let attempts = 0; const poll = async () =\u0026gt; { try { const response = await this.$http.get(`/api/seckill/result/${orderId}`); if (response.data.success) { this.orderResult = { success: true, orderId: orderId, order: response.data.data }; return; } attempts++; if (attempts \u0026lt; maxAttempts) { setTimeout(poll, 1000); // 1ç§’åé‡è¯• } else { this.orderResult = { success: false, message: \u0026#39;è®¢å•å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥è¯¢\u0026#39; }; } } catch (error) { console.error(\u0026#39;æŸ¥è¯¢è®¢å•ç»“æœå¤±è´¥\u0026#39;, error); attempts++; if (attempts \u0026lt; maxAttempts) { setTimeout(poll, 1000); } } }; poll(); }, getCurrentUserId() { // è·å–å½“å‰ç”¨æˆ·IDçš„é€»è¾‘ return localStorage.getItem(\u0026#39;userId\u0026#39;) || \u0026#39;1\u0026#39;; } } } \u0026lt;/script\u0026gt; 1ï¸âƒ£1ï¸âƒ£ æ€»ç»“ä¸ç›´è§‚æ¯”å–» æ ¸å¿ƒæµç¨‹æ€»ç»“ï¼š å‰ç«¯ï¼šæ‹¿åˆ°\u0026quot;æŠ¢è´­å‡­è¯\u0026quot;ï¼Œæ— éœ€ç›´æ¥ç­‰å¾…æ•°æ®åº“å®Œæˆè®¢å• æ¥å£å±‚ï¼šå¿«é€Ÿåˆ¤æ–­åº“å­˜å’Œç”¨æˆ·èµ„æ ¼ï¼Œå…¥é˜Ÿ â†’ é«˜å¹¶å‘ä¸‹çº¿ç¨‹ä¸è¢«é˜»å¡ åå°ï¼šæ¶ˆè´¹é˜Ÿåˆ— â†’ æ‰£æ•°æ®åº“åº“å­˜ â†’ åˆ›å»ºè®¢å• â†’ é€šçŸ¥ç”¨æˆ· Redis + æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¿è¯åº“å­˜åŸå­æ€§ã€é¡ºåºå¤„ç†ã€ç³»ç»Ÿå¹³ç¨³è¿è¡Œ âš¡ å¼‚æ­¥ç§’æ€çš„æ ¸å¿ƒç†å¿µï¼š å¿«é€Ÿæ¥æ”¶è¯·æ±‚ + æ’é˜Ÿ + å¼‚æ­¥å¤„ç†ï¼Œå®ç°å‰Šå³°å¡«è°·ã€é˜²æ­¢è¶…å–ã€æå‡ç³»ç»Ÿååé‡ã€‚\nğŸ’¡ ç›´è§‚ç±»æ¯”ï¼š å‰ç«¯ç”¨æˆ·ï¼šæ‹¿åˆ°å–é¤å· åå°ç³»ç»Ÿï¼šå¨æˆ¿æŒ‰é¡ºåºåšèœ ç”¨æˆ·æœ€ç»ˆèƒ½æ‹¿åˆ°èœï¼Œä½†ç³»ç»Ÿä¸ä¼šè¢«ç¬æ—¶æµé‡å‹å® æŠ€æœ¯ä¼˜åŠ¿ï¼š é«˜å¹¶å‘å¤„ç†ï¼šRedis + æ¶ˆæ¯é˜Ÿåˆ—å®ç°å‰Šå³°å¡«è°· é˜²æ­¢è¶…å–ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ ç³»ç»Ÿç¨³å®šï¼šå¼‚æ­¥å¤„ç†é¿å…æ•°æ®åº“å‹åŠ› ç”¨æˆ·ä½“éªŒï¼šå¿«é€Ÿå“åº”ï¼Œæ— éœ€é•¿æ—¶é—´ç­‰å¾… å¯æ‰©å±•æ€§ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²å’Œæ°´å¹³æ‰©å±• é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œå®Œæ•´ä»£ç å®ç°ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹å¼‚æ­¥ç§’æ€ç³»ç»Ÿæœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚å¯¹ä»£ç è¿›è¡Œç›¸åº”çš„è°ƒæ•´å’Œä¼˜åŒ–ã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å¼‚æ­¥ç§’æ€ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œä¼˜åŒ–æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ç§’æ€ç³»ç»Ÿã€‚\n","date":"2025-09-10T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%90%ABredis%E9%A2%84%E6%89%A3%E5%BA%93%E5%AD%98%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0/","title":"å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰"},{"content":"åŸºäº Session çš„çŸ­ä¿¡ç™»å½•å®Œæ•´è§£æ åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼ŒçŸ­ä¿¡éªŒè¯ç ç™»å½• æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ— å¯†ç è®¤è¯æ–¹å¼ã€‚å®ƒçš„å¥½å¤„æ˜¯ç®€å•ã€å®‰å…¨ï¼Œç”¨æˆ·åªéœ€è¦è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç å³å¯ç™»å½•ï¼Œè€Œä¸ç”¨è®°å¤æ‚çš„å¯†ç ã€‚\nå¾ˆå¤šåˆå­¦è€…åœ¨å®ç°æ—¶ä¼šæœ‰ç–‘æƒ‘ï¼šéªŒè¯ç å­˜å“ªï¼Ÿæ€ä¹ˆæ¯”å¯¹ï¼Ÿç™»å½•çŠ¶æ€å¦‚ä½•ä¿æŒï¼Ÿ è¿™ç¯‡æ–‡ç« å°†é€šè¿‡æ¨å¯¼çš„æ–¹å¼ï¼Œé€æ­¥è§£é‡Šæ¸…æ¥šï¼Œå¹¶ç»™å‡ºå®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Session è¦ç†è§£çŸ­ä¿¡ç™»å½•ï¼Œå¿…é¡»å…ˆææ¸…æ¥š Session çš„æ¦‚å¿µã€‚\nHTTP åè®®çš„ä¸€ä¸ªæœ€å¤§ç‰¹ç‚¹æ˜¯ï¼šæ— çŠ¶æ€ã€‚\nè¿™æ„å‘³ç€æ¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨éƒ½ä¸ä¼šè®°å¾—ä½ æ˜¯è°ã€‚\nä½†æ˜¯åœ¨å®é™…åº”ç”¨é‡Œï¼Œæˆ‘ä»¬éœ€è¦ï¼š\nç™»å½•ä¹‹åï¼Œä¿æŒç™»å½•çŠ¶æ€ è´­ç‰©è½¦å†…å®¹èƒ½å¤Ÿä¸€ç›´ä¿å­˜ éªŒè¯ç å‘é€åï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°æ ¡éªŒ è¿™æ—¶å€™å°±éœ€è¦ Sessionã€‚\n1.1 Session çš„ç±»æ¯” ä½ å¯ä»¥æŠŠ Session æƒ³è±¡æˆæœåŠ¡å™¨ç»™ç”¨æˆ·å¼€çš„ä¸€é—´å°å‚¨ç‰©æŸœï¼š\nå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼ŒæœåŠ¡å™¨ï¼ˆtomcatï¼‰åˆ†é…ä¸€ä¸ªå‚¨ç‰©æŸœï¼ˆSessionï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ç¼–å·ï¼ˆSession IDï¼‰ æœåŠ¡å™¨æŠŠè¿™ä¸ªç¼–å·å†™åœ¨ä¸€å¼ å°çº¸æ¡ä¸Šï¼ˆCookieï¼‰ï¼Œäº¤ç»™æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ä¿å­˜ ä»¥åæµè§ˆå™¨æ¯æ¬¡è®¿é—®æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šè¿™å¼ å°çº¸æ¡ æœåŠ¡å™¨æ ¹æ®çº¸æ¡ä¸Šçš„ç¼–å·ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å‚¨ç‰©æŸœï¼Œä»é‡Œé¢å–å‡ºå±äºè¯¥ç”¨æˆ·çš„æ•°æ® 1.2 Session vs Cookie ç‰¹æ€§ Cookieï¼ˆå°çº¸æ¡ï¼‰ Sessionï¼ˆå‚¨ç‰©æŸœï¼‰ å­˜å‚¨ä½ç½® æµè§ˆå™¨ç«¯ æœåŠ¡å™¨ç«¯ å®‰å…¨æ€§ è¾ƒä½ï¼ˆå®¹æ˜“è¢«ç¯¡æ”¹ï¼‰ è¾ƒé«˜ï¼ˆç”±æœåŠ¡å™¨ç»´æŠ¤ï¼‰ å®¹é‡ 4KB å·¦å³ å–å†³äºæœåŠ¡å™¨å†…å­˜ ç”Ÿå‘½å‘¨æœŸ å¯è®¾ç½®é•¿æ—¶é—´ä¿å­˜ é»˜è®¤éšæµè§ˆå™¨å…³é—­æˆ–è¶…æ—¶æ¸…é™¤ äºŒã€çŸ­ä¿¡ç™»å½•çš„æ¨å¯¼è¿‡ç¨‹ ç°åœ¨æˆ‘ä»¬æŠŠ Session çš„åŸç†æ”¾åˆ° çŸ­ä¿¡éªŒè¯ç ç™»å½• çš„åœºæ™¯ä¸­ï¼Œæ¥ä¸€æ­¥æ­¥æ¨å¯¼ã€‚\n2.1 ç”¨æˆ·æäº¤æ‰‹æœºå· ç”¨æˆ·åœ¨å‰ç«¯é¡µé¢è¾“å…¥æ‰‹æœºå· å‰ç«¯æŠŠæ‰‹æœºå·å‘é€ç»™åç«¯ 2.2 æœåŠ¡å™¨ç”ŸæˆéªŒè¯ç  åç«¯ç”Ÿæˆä¸€ä¸ª 6 ä½éšæœºæ•°ï¼ˆä¾‹å¦‚ 123456ï¼‰ æŠŠè¿™ä¸ªéªŒè¯ç ä¿å­˜åˆ° Session å‚¨ç‰©æŸœ é‡Œ åŒæ—¶è°ƒç”¨çŸ­ä¿¡æœåŠ¡å•†çš„ APIï¼ŒæŠŠéªŒè¯ç å‘é€åˆ°ç”¨æˆ·æ‰‹æœº æ­¤æ—¶ï¼ŒSession ä¸­ä¿å­˜çš„æ˜¯ï¼š key = \u0026ldquo;SMS_CODE_æ‰‹æœºå·\u0026rdquo; value = \u0026ldquo;123456\u0026rdquo;\n2.3 ç”¨æˆ·è¾“å…¥éªŒè¯ç ç™»å½• ç”¨æˆ·æ”¶åˆ°éªŒè¯ç ï¼Œåœ¨é¡µé¢è¾“å…¥ æµè§ˆå™¨åœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šè‡ªåŠ¨å¸¦ä¸Š Session ID çš„å°çº¸æ¡ï¼ˆCookieï¼‰ åç«¯æ ¹æ® Session ID æ‰¾åˆ°å‚¨ç‰©æŸœï¼Œä»ä¸­å–å‡ºéªŒè¯ç  æ¯”å¯¹ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç ä¸ Session ä¸­ä¿å­˜çš„éªŒè¯ç  ä¸€è‡´ âœ… â†’ ç™»å½•æˆåŠŸ ä¸ä¸€è‡´ âŒ â†’ ç™»å½•å¤±è´¥ ä¸‰ã€ä»£ç å®ç°ç¤ºä¾‹ï¼ˆSpring Bootï¼‰ æ¥ä¸‹æ¥ç”¨ Java + Spring Boot æ¥å®ç°ä¸€ä¸ªæœ€ç®€åŒ–çš„ åŸºäº Session çš„çŸ­ä¿¡ç™»å½•ã€‚\n3.1 å‘é€éªŒè¯ç æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @RestController @RequestMapping(\u0026#34;/auth\u0026#34;) public class SmsLoginController { @PostMapping(\u0026#34;/sendCode\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; sendCode(@RequestParam String phone, HttpSession session) { // ç”Ÿæˆ 6 ä½éªŒè¯ç  String code = String.valueOf((int)((Math.random() * 9 + 1) * 100000)); // æ¨¡æ‹Ÿå‘é€çŸ­ä¿¡ï¼ˆçœŸå®æƒ…å†µéœ€æ¥å…¥çŸ­ä¿¡æœåŠ¡å•† APIï¼‰ System.out.println(\u0026#34;å‘æ‰‹æœºå· \u0026#34; + phone + \u0026#34; å‘é€éªŒè¯ç ï¼š\u0026#34; + code); // ä¿å­˜åˆ° session session.setAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone, code); session.setAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone, System.currentTimeMillis()); return ResponseEntity.ok(\u0026#34;éªŒè¯ç å·²å‘é€\u0026#34;); } } è¯´æ˜ï¼š éªŒè¯ç ä¿å­˜åœ¨ Session ä¸­ï¼Œä¸å­˜å‰ç«¯ å»ºè®®åŒæ—¶ä¿å­˜éªŒè¯ç ç”Ÿæˆæ—¶é—´ï¼Œæ–¹ä¾¿åç»­åˆ¤æ–­æ˜¯å¦è¿‡æœŸ\n3.2 éªŒè¯ç™»å½•æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping(\u0026#34;/login\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; login(@RequestParam String phone, @RequestParam String code, HttpSession session) { String sessionCode = (String) session.getAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); Long codeTime = (Long) session.getAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); if (sessionCode == null) { return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç æœªå‘é€æˆ–å·²è¿‡æœŸ\u0026#34;); } // éªŒè¯æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰ if (System.currentTimeMillis() - codeTime \u0026gt; 5 * 60 * 1000) { session.removeAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); session.removeAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç å·²è¿‡æœŸ\u0026#34;); } if (!sessionCode.equals(code)) { return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç é”™è¯¯\u0026#34;); } // ç™»å½•æˆåŠŸï¼Œå†™å…¥ç”¨æˆ·ç™»å½•çŠ¶æ€ session.setAttribute(\u0026#34;LOGIN_USER\u0026#34;, phone); // æ¸…ç†éªŒè¯ç  session.removeAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); session.removeAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); return ResponseEntity.ok(\u0026#34;ç™»å½•æˆåŠŸ\u0026#34;); } è¯´æ˜ï¼š æ ¸å¿ƒé€»è¾‘åœ¨ åç«¯æ¯”å¯¹ï¼Œå‰ç«¯åªè´Ÿè´£æ”¶é›†è¾“å…¥ éªŒè¯ç è¿‡æœŸæœºåˆ¶å¿…é¡»æœ‰ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨\n3.3 è·å–å½“å‰ç™»å½•ç”¨æˆ·æ¥å£ 1 2 3 4 5 6 7 8 @GetMapping(\u0026#34;/me\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; getUser(HttpSession session) { String phone = (String) session.getAttribute(\u0026#34;LOGIN_USER\u0026#34;); if (phone == null) { return ResponseEntity.status(401).body(\u0026#34;æœªç™»å½•\u0026#34;); } return ResponseEntity.ok(\u0026#34;å½“å‰ç™»å½•ç”¨æˆ·ï¼š\u0026#34; + phone); } å››ã€å…³é”®ç‚¹æ€»ç»“ 1.Session æ˜¯å‚¨ç‰©æŸœï¼ŒCookie æ˜¯å‚¨ç‰©æŸœçš„å–ä»¶å‡­è¯è¯ éªŒè¯ç å­˜æ”¾åœ¨ Sessionï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼Œä¸å­˜æµè§ˆå™¨ æµè§ˆå™¨åªä¿ç•™ Session IDï¼ˆCookieï¼‰ 2.æ¯”å¯¹é€»è¾‘å¿…é¡»åœ¨åç«¯å®Œæˆ å‰ç«¯åªè´Ÿè´£æ”¶é›†å’Œæäº¤æ‰‹æœºå·ã€éªŒè¯ç  æœåŠ¡å™¨æ ¹æ® Session æ‰¾åˆ°éªŒè¯ç å¹¶æ¯”å¯¹ï¼Œå†³å®šæ˜¯å¦ç™»å½• 3.å®‰å…¨æ€§æªæ–½ éªŒè¯ç è¦æœ‰è¿‡æœŸæ—¶é—´ï¼ˆä¸€èˆ¬ 5 åˆ†é’Ÿï¼‰ éªŒè¯ç è¦æœ‰å‘é€é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢è¢«æ¶æ„åˆ· äº”ã€æµç¨‹å›é¡¾ è®©æˆ‘ä»¬å›é¡¾æ•´ä¸ªçŸ­ä¿¡ç™»å½•çš„è¿‡ç¨‹ï¼š 1.ç”¨æˆ·è¾“å…¥æ‰‹æœºå· 2.æœåŠ¡å™¨ç”ŸæˆéªŒè¯ç ï¼Œå­˜åˆ° Sessionï¼Œå¹¶é€šè¿‡çŸ­ä¿¡å‘é€ 3.ç”¨æˆ·æ”¶åˆ°éªŒè¯ç ï¼Œè¾“å…¥åˆ°å‰ç«¯é¡µé¢ 4.æµè§ˆå™¨è¯·æ±‚æ—¶å¸¦ä¸Š Cookieï¼ˆSession IDï¼‰ 5.æœåŠ¡å™¨ç”¨ Session ID æ‰¾åˆ°å‚¨ç‰©æŸœï¼Œå–å‡ºéªŒè¯ç è¿›è¡Œæ¯”å¯¹ ä¸€è‡´ â†’ ç™»å½•æˆåŠŸï¼› ä¸ä¸€è‡´/è¿‡æœŸ â†’ ç™»å½•å¤±è´¥ 6.æ‰©å±•æ€è€ƒ åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒSession å¯èƒ½å­˜æ”¾åœ¨ Redis é‡Œï¼Œä»¥ä¾¿æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚\nå¦å¤–ï¼Œä¹Ÿå¯ä»¥æ›¿ä»£ Sessionï¼Œç”¨ JWTï¼ˆJSON Web Tokenï¼‰ å®ç°æ— çŠ¶æ€çš„ç™»å½•ã€‚ ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ï¼š\néªŒè¯ç å¿…é¡»åœ¨åç«¯ä¿å­˜å’Œæ¯”å¯¹ å‰ç«¯åªè´Ÿè´£å±•ç¤ºå’Œè¾“å…¥ 7.ç»“è¯­ é€šè¿‡ä¸Šé¢çš„æ¨å¯¼ï¼Œæˆ‘ä»¬æŠŠâ€œçŸ­ä¿¡ç™»å½•â€è¿™ä¸ªå¸¸è§éœ€æ±‚ï¼Œå®Œæ•´åœ°æ‹†è§£æˆäº† ä¸šåŠ¡æµç¨‹ + Session åŸç† + å®ç°ä»£ç ã€‚\nå¦‚æœä½ åˆšå¼€å§‹å­¦ä¹ åç«¯å¼€å‘ï¼Œå¸Œæœ›ä½ èƒ½ä»è¿™ç¯‡æ–‡ç« ä¸­çœŸæ­£ç†è§£ï¼š\nä¸ºä»€ä¹ˆè¦ç”¨ Session çŸ­ä¿¡éªŒè¯ç åº”è¯¥å­˜æ”¾åœ¨å“ªé‡Œ éªŒè¯é€»è¾‘ä¸ºä»€ä¹ˆè¦åœ¨åç«¯ è¿™æ ·ï¼Œä¸ç®¡æ˜¯åšä¸€ä¸ªå° demoï¼Œè¿˜æ˜¯å°†æ¥åº”å¯¹ç”Ÿäº§çº§çš„é¡¹ç›®ï¼Œä½ éƒ½èƒ½ä¸¾ä¸€åä¸‰ã€‚\n","date":"2025-08-26T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E5%9F%BA%E4%BA%8E-session-%E7%9A%84%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90/","title":"åŸºäº Session çš„çŸ­ä¿¡ç™»å½•å®Œæ•´è§£æ"},{"content":"æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼ŒRedis ä½œä¸ºç¼“å­˜å±‚ï¼ŒMySQL ä½œä¸ºå­˜å‚¨å±‚çš„ç»„åˆå‡ ä¹æ˜¯æ ‡é…ã€‚Redis çš„é«˜æ€§èƒ½æå¤§ç¼“è§£äº†æ•°æ®åº“çš„å‹åŠ›ï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªæ ¸å¿ƒéš¾é¢˜ï¼šå¦‚ä½•ä¿è¯æ•°æ®åº“ä¸ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næœ¬æ–‡å°†å…¨é¢åˆ†ææ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒ…æ‹¬ ä¸ä¸€è‡´äº§ç”Ÿçš„åŸå› ã€å¸¸è§è§£å†³æ–¹æ¡ˆã€ä¼˜ç¼ºç‚¹åˆ†æã€ä»£ç ç¤ºä¾‹ï¼Œä»¥åŠé€šä¿—çš„ç”Ÿæ´»ç±»æ¯”ã€‚è¯»å®Œæœ¬æ–‡ï¼Œä½ å°†å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ‰ç³»ç»Ÿã€æ·±åˆ»çš„ç†è§£ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆæ•°æ®åº“å’Œç¼“å­˜å¯èƒ½ä¸ä¸€è‡´ï¼Ÿ å¾ˆå¤šäººä¸€å¼€å§‹ä¼šç–‘æƒ‘ï¼šæ•°æ®åº“å’Œç¼“å­˜éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±åœ¨æ§åˆ¶ï¼Œä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´ï¼Ÿ\nå…¶å®ï¼Œé—®é¢˜çš„æ ¹æºåœ¨äº ç¼“å­˜å’Œæ•°æ®åº“æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç³»ç»Ÿï¼Œæ•°æ®åŒæ­¥ä¸æ˜¯åŸå­æ“ä½œï¼Œä¸­é—´å­˜åœ¨æ—¶é—´å·®å’Œå¤±è´¥çš„å¯èƒ½ã€‚\n1.1 å¸¸è§ä¸ä¸€è‡´åŸå›  â‘  å†™æ•°æ®åº“æˆåŠŸï¼Œä½†ç¼“å­˜æ²¡æ›´æ–° åŸå› ï¼šä¸šåŠ¡ä»£ç é‡Œå…ˆå†™æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ã€‚å¦‚æœæ›´æ–°ç¼“å­˜å¤±è´¥ï¼ˆæ¯”å¦‚ Redis å®•æœºæˆ–ç½‘ç»œæŠ–åŠ¨ï¼‰ï¼Œå°±ä¼šå‡ºç° æ•°æ®åº“æ–°å€¼ã€ç¼“å­˜æ—§å€¼ çš„æƒ…å†µã€‚\né€šä¿—ç±»æ¯”ï¼šä½ æ¢äº†æ‰‹æœºå·ç ï¼Œä½†å¿˜äº†å‘Šè¯‰æœ‹å‹ã€‚ç»“æœæœ‹å‹æ‰“ç”µè¯æ—¶ï¼Œè¿˜æ˜¯æ‰“åˆ°ä½ æ—§å·ç ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Service public class UserService { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public void updateUser(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ userMapper.updateById(user); // 2. æ›´æ–°ç¼“å­˜ - è¿™é‡Œå¯èƒ½å¤±è´¥ï¼ redisTemplate.opsForValue().set(\u0026#34;user:\u0026#34; + user.getId(), user); } catch (Exception e) { // å¦‚æœç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œæ•°æ®åº“å·²ç»æ›´æ–°äº†ï¼Œä½†ç¼“å­˜è¿˜æ˜¯æ—§å€¼ log.error(\u0026#34;æ›´æ–°ç¼“å­˜å¤±è´¥\u0026#34;, e); } } } â‘¡ æ›´æ–°é¡ºåºå¯¼è‡´çš„é—®é¢˜ å†™æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ï¼šå¦‚æœå†™æ•°æ®åº“æˆåŠŸï¼Œä½†åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œé‚£ä¹ˆç¼“å­˜é‡Œä¾æ—§æ˜¯æ—§æ•°æ®ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¼šç›´æ¥æ‹¿æ—§ç¼“å­˜ã€‚\nåˆ é™¤ç¼“å­˜ â†’ å†™æ•°æ®åº“ï¼šå¦‚æœåœ¨åˆ é™¤ç¼“å­˜åã€å†™æ•°æ®åº“å‰ï¼Œæ°å¥½æœ‰è¯·æ±‚æŸ¥è¯¢æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿ ç¼“å­˜å›å¡«æ—§å€¼ çš„é—®é¢˜ã€‚\né€šä¿—ç±»æ¯”ï¼š\nä½ è¦æ¢å®¶é‡Œçš„é”ã€‚ æ–¹æ¡ˆä¸€ï¼ˆå…ˆæ¢é”ï¼Œå†æ‰”æ—§é’¥åŒ™ï¼‰ï¼šå®‰å…¨ï¼Œä½†ä¸‡ä¸€æ‰”é’¥åŒ™æ—¶æ‰‹æ»‘æ²¡æ‰”æ‰ï¼ˆç¼“å­˜æ²¡åˆ æ‰ï¼‰ï¼Œåˆ«äººè¿˜èƒ½ç”¨æ—§é’¥åŒ™å¼€é—¨ã€‚ æ–¹æ¡ˆäºŒï¼ˆå…ˆæ‰”é’¥åŒ™ï¼Œå†æ¢é”ï¼‰ï¼šåœ¨ä½ æ¢é”çš„å‡ åˆ†é’Ÿé‡Œï¼Œåˆ«äººå¯èƒ½æ­£å¥½ç”¨æ—§é’¥åŒ™å¼€é—¨ï¼ˆç¼“å­˜è¢«æ—§å€¼å›å¡«ï¼‰ã€‚ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // æ–¹æ¡ˆä¸€ï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜ public void updateUserV1(User user) { // 1. æ›´æ–°æ•°æ®åº“ userMapper.updateById(user); // 2. åˆ é™¤ç¼“å­˜ - å¯èƒ½å¤±è´¥ try { redisTemplate.delete(\u0026#34;user:\u0026#34; + user.getId()); } catch (Exception e) { // åˆ é™¤å¤±è´¥ï¼Œç¼“å­˜è¿˜æ˜¯æ—§å€¼ log.error(\u0026#34;åˆ é™¤ç¼“å­˜å¤±è´¥\u0026#34;, e); } } // æ–¹æ¡ˆäºŒï¼šå…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“ public void updateUserV2(User user) { // 1. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;user:\u0026#34; + user.getId()); // 2. æ›´æ–°æ•°æ®åº“ - åœ¨åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´ï¼Œå¯èƒ½æœ‰æŸ¥è¯¢è¯·æ±‚å›å¡«æ—§å€¼ userMapper.updateById(user); } â‘¢ å¹¶å‘è¦†ç›–é—®é¢˜ åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶ä¿®æ”¹åŒä¸€æ¡æ•°æ®ï¼Œå¯èƒ½å‡ºç°è¦†ç›–ã€‚\nåœºæ™¯ä¸¾ä¾‹ï¼š\nè¯·æ±‚ Aï¼šæ›´æ–°ç”¨æˆ·ä½™é¢ä¸º 100 â†’ æ›´æ–°æ•°æ®åº“æˆåŠŸ â†’ åˆ é™¤ç¼“å­˜ è¯·æ±‚ Bï¼šæ›´æ–°ç”¨æˆ·ä½™é¢ä¸º 200 â†’ æ›´æ–°æ•°æ®åº“æˆåŠŸ â†’ åˆ é™¤ç¼“å­˜ è¯·æ±‚ A çº¿ç¨‹è¾ƒæ…¢ï¼Œåœ¨ B æ›´æ–°å®Œæˆååˆå›å¡«äº† 100 åˆ°ç¼“å­˜ ç»“æœï¼šæ•°æ®åº“æ˜¯ 200ï¼Œç¼“å­˜å´æ˜¯ 100ï¼Œäº§ç”Ÿäº†è„æ•°æ®ã€‚ é€šä¿—ç±»æ¯”ï¼šä¸¤ä¸ªäººåŒæ—¶å¾€ä¸€ä¸ªæ–‡æ¡£é‡Œå†™æ•°æ®ã€‚ç”²å†™äº†æ–°ç‰ˆå†…å®¹ï¼Œä¹™å†™å®Œæ—§ç‰ˆåä¿å­˜ï¼Œæœ€ç»ˆçš„æ–‡æ¡£è¢«ä¹™è¦†ç›–ï¼Œç”²çš„ä¿®æ”¹æ¶ˆå¤±ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Service public class AccountService { @Autowired private AccountMapper accountMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; // å¹¶å‘æ›´æ–°ä½™é¢çš„é—®é¢˜ç¤ºä¾‹ public void updateBalance(Long userId, BigDecimal amount) { // 1. æŸ¥è¯¢å½“å‰ä½™é¢ Account account = accountMapper.selectById(userId); // 2. è®¡ç®—æ–°ä½™é¢ BigDecimal newBalance = account.getBalance().add(amount); account.setBalance(newBalance); // 3. æ›´æ–°æ•°æ®åº“ accountMapper.updateById(account); // 4. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;account:\u0026#34; + userId); // é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå¯èƒ½å‡ºç°è¦†ç›– } // æŸ¥è¯¢ä½™é¢ public BigDecimal getBalance(Long userId) { // 1. å…ˆæŸ¥ç¼“å­˜ String cacheKey = \u0026#34;account:\u0026#34; + userId; BigDecimal balance = (BigDecimal) redisTemplate.opsForValue().get(cacheKey); if (balance != null) { return balance; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ Account account = accountMapper.selectById(userId); balance = account.getBalance(); // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, balance, 30, TimeUnit.MINUTES); return balance; } } â‘£ ç¼“å­˜å›å¡«é—®é¢˜ å½“ç¼“å­˜è¿‡æœŸæˆ–è¢«åˆ é™¤æ—¶ï¼Œå¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢ï¼Œä¼šå‡ºç° ç¼“å­˜å‡»ç©¿ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚å¦‚æœæ•°æ®åº“çš„æ•°æ®æ°å¥½æ­£åœ¨è¢«æ›´æ–°ï¼Œå°±å¯èƒ½å›å¡«æ—§å€¼åˆ°ç¼“å­˜ã€‚\né€šä¿—ç±»æ¯”ï¼šå¤§å®¶éƒ½åœ¨æŸ¥å¿«é€’å•å·ã€‚ç¼“å­˜é‡Œè¿‡æœŸäº†ï¼Œå¤§å®¶éƒ½å»é—®å¿«é€’å…¬å¸ã€‚æ­£å¥½å¿«é€’å…¬å¸ç³»ç»Ÿè¿˜æ²¡æ›´æ–°ï¼Œæœ‰äººæŠŠæ—§çš„ç‰©æµä¿¡æ¯æ‹¿å›æ¥ï¼Œåˆé‡æ–°å­˜è¿›ç¼“å­˜ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Service public class ProductService { @Autowired private ProductMapper productMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public Product getProduct(Long productId) { String cacheKey = \u0026#34;product:\u0026#34; + productId; // 1. å…ˆæŸ¥ç¼“å­˜ Product product = (Product) redisTemplate.opsForValue().get(cacheKey); if (product != null) { return product; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ product = productMapper.selectById(productId); // 3. å›å¡«ç¼“å­˜ - è¿™é‡Œå¯èƒ½å›å¡«æ—§å€¼ if (product != null) { redisTemplate.opsForValue().set(cacheKey, product, 30, TimeUnit.MINUTES); } return product; } public void updateProduct(Product product) { // 1. æ›´æ–°æ•°æ®åº“ productMapper.updateById(product); // 2. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;product:\u0026#34; + product.getId()); // é—®é¢˜ï¼šåœ¨åˆ é™¤ç¼“å­˜åï¼Œå¦‚æœæœ‰æŸ¥è¯¢è¯·æ±‚ï¼Œå¯èƒ½å›å¡«æ—§å€¼ } } â‘¤ å¼‚å¸¸æˆ–æ¶ˆæ¯ä¸¢å¤± åœ¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ã€Binlog åŒæ­¥çš„åœºæ™¯é‡Œï¼Œå¦‚æœæ¶ˆæ¯ä¸¢å¤±æˆ–æ¶ˆè´¹å¤±è´¥ï¼Œä¹Ÿä¼šé€ æˆæ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´ã€‚\né€šä¿—ç±»æ¯”ï¼šä½ è®©æœ‹å‹å¸®å¿™è½¬å‘Šä¸€ä¸ªä¿¡æ¯ã€‚å¦‚æœæœ‹å‹å¿˜äº†è¯´ï¼ˆæ¶ˆæ¯ä¸¢äº†ï¼‰ï¼Œæ¥æ”¶æ–¹å°±æ°¸è¿œæ‹¿ä¸åˆ°æœ€æ–°æ•°æ®ã€‚\nå°ç»“ æ•°æ®åº“ä¸ç¼“å­˜çš„ä¸ä¸€è‡´ï¼Œå½’æ ¹åˆ°åº•æ˜¯å› ä¸º æ›´æ–°ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå†åŠ ä¸Š ç½‘ç»œã€å¹¶å‘ã€å»¶è¿Ÿã€å¼‚å¸¸ ç­‰å› ç´ ï¼Œå¯¼è‡´ä¸åŒæ­¥ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹å¸¸è§çš„è§£å†³æ–¹æ¡ˆã€‚\näºŒã€å¸¸è§åŒæ­¥ç­–ç•¥ä¸å®ç° 2.1 Cache Asideï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰ è¿™æ˜¯æœ€å¸¸è§çš„ç¼“å­˜ç­–ç•¥ï¼š\nè¯»ï¼šå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜æ²¡æœ‰å°±è¯»æ•°æ®åº“ï¼Œç„¶åå›å¡«åˆ°ç¼“å­˜ã€‚ å†™ï¼šæ›´æ–°æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ç¼“å­˜ã€‚ æµç¨‹å›¾ 1 2 3 4 è¯»è¯·æ±‚ï¼š å…ˆæŸ¥ç¼“å­˜ â†’ ç¼“å­˜å‘½ä¸­ â†’ è¿”å› ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å› å†™è¯·æ±‚ï¼š å…ˆå†™æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ ä¼˜ç‚¹ ç®€å•æ˜“å®ç° æ›´æ–°é¢‘ç‡ä½ã€è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹æ€§èƒ½å¥½ ç¼ºç‚¹ å†™ååˆ é™¤ç¼“å­˜ä¸æ˜¯åŸå­æ“ä½œï¼Œå¯èƒ½äº§ç”Ÿä¸ä¸€è‡´ åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´æœ‰çª—å£æœŸï¼Œå®¹æ˜“è¢«å¹¶å‘è¦†ç›– é€šä¿—ç±»æ¯” ä½ è®°ä¸ä½æœ‹å‹çš„æ‰‹æœºå·ï¼ˆæ•°æ®åº“ï¼‰ï¼Œäºæ˜¯å†™åœ¨çº¸æ¡ä¸Šæ”¾åœ¨å£è¢‹é‡Œï¼ˆç¼“å­˜ï¼‰ã€‚æ¯æ¬¡æŸ¥å·ç æ—¶ï¼Œå…ˆæ‘¸å£è¢‹ã€‚å¦‚æœå·ç å˜äº†ï¼Œä½ æ”¹æ‰‹æœºé€šè®¯å½•ï¼ˆæ•°æ®åº“ï¼‰ï¼Œç„¶åæŠŠçº¸æ¡æ‰”æ‰ï¼ˆåˆ ç¼“å­˜ï¼‰ã€‚ä¸‹æ¬¡å†æœ‰äººé—®ï¼Œå°±ä¼šä»æ‰‹æœºæŸ¥å‡ºæ–°å·ç ï¼Œå†æŠ„ä¸€å¼ æ–°çº¸æ¡ã€‚\nä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 @Service public class UserService { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final int CACHE_EXPIRE_TIME = 30; // åˆ†é’Ÿ /** * æŸ¥è¯¢ç”¨æˆ· - Cache Aside è¯»ç­–ç•¥ */ public User getUser(Long userId) { String cacheKey = USER_CACHE_PREFIX + userId; // 1. å…ˆæŸ¥ç¼“å­˜ User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { log.info(\u0026#34;ç¼“å­˜å‘½ä¸­ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ log.info(\u0026#34;ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, CACHE_EXPIRE_TIME, TimeUnit.MINUTES); log.info(\u0026#34;æ•°æ®å›å¡«ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } return user; } /** * æ›´æ–°ç”¨æˆ· - Cache Aside å†™ç­–ç•¥ */ @Transactional public boolean updateUser(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * åˆ é™¤ç”¨æˆ· */ @Transactional public boolean deleteUser(Long userId) { try { // 1. åˆ é™¤æ•°æ®åº“è®°å½• int result = userMapper.deleteById(userId); if (result \u0026lt;= 0) { log.warn(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + userId; redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return true; } catch (Exception e) { log.error(\u0026#34;åˆ é™¤ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); throw new RuntimeException(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } } 2.2 å»¶æ—¶åŒåˆ ç­–ç•¥ åœ¨ å†™æ•°æ®åº“ + åˆ é™¤ç¼“å­˜ çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€æ¬¡å»¶æ—¶åˆ é™¤ã€‚\n1 2 3 4 updateDB(); delCache(); Thread.sleep(500); delCache(); ä¸ºä»€ä¹ˆè¦å¤šåˆ ä¸€æ¬¡ï¼Ÿ å› ä¸ºç¬¬ä¸€æ¬¡åˆ ç¼“å­˜åï¼Œå¯èƒ½æœ‰å¹¶å‘è¯·æ±‚æŸ¥è¯¢ï¼Œå›å¡«äº†æ—§å€¼ã€‚ç¬¬äºŒæ¬¡å»¶è¿Ÿåˆ é™¤ï¼Œå¯ä»¥æŠŠæ—§å€¼å†æ¸…ç†æ‰ã€‚\nä¼˜ç‚¹ æ€è·¯ç®€å•ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£å¹¶å‘è¦†ç›–é—®é¢˜ ç¼ºç‚¹ å»¶è¿Ÿæ—¶é—´ä¸å¥½ç¡®å®šï¼Œæ—¶é—´è¿‡é•¿ â†’ è„æ•°æ®å­˜åœ¨å¤ªä¹…ï¼›æ—¶é—´è¿‡çŸ­ â†’ è¦†ç›–é—®é¢˜ä»å¯èƒ½å‘ç”Ÿ ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ é€šä¿—ç±»æ¯” ä½ æ¢äº†é—¨é”ã€‚å…ˆæŠŠæ—§é’¥åŒ™æ”¶èµ°ï¼ˆåˆ ç¼“å­˜ï¼‰ã€‚ä½†æ‹…å¿ƒæœ‰äººæ‰‹é‡Œè¿˜æœ‰å¤‡ä»½é’¥åŒ™ï¼Œäºæ˜¯è¿‡å‡ åˆ†é’Ÿå†æ¥æ£€æŸ¥ä¸€æ¬¡ï¼ŒæŠŠå¯èƒ½å†’å‡ºæ¥çš„æ—§é’¥åŒ™ä¹Ÿæ”¶èµ°ã€‚\nä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 @Service public class UserServiceWithDelayDoubleDelete { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private ThreadPoolTaskExecutor taskExecutor; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final int DELAY_TIME = 500; // æ¯«ç§’ /** * å»¶æ—¶åŒåˆ ç­–ç•¥æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithDelayDoubleDelete(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { return false; } // 2. ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); // 3. å¼‚æ­¥å»¶æ—¶åˆ é™¤ç¼“å­˜ taskExecutor.execute(() -\u0026gt; { try { Thread.sleep(DELAY_TIME); redisTemplate.delete(cacheKey); log.info(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜å®Œæˆï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜è¢«ä¸­æ–­ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); } catch (Exception e) { log.error(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); } }); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * æŸ¥è¯¢ç”¨æˆ· */ public User getUser(Long userId) { String cacheKey = USER_CACHE_PREFIX + userId; // 1. å…ˆæŸ¥ç¼“å­˜ User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); } return user; } } 2.3 åŠ é”ç­–ç•¥ï¼ˆè¯»å†™é”ã€åˆ†å¸ƒå¼é”ï¼‰ é€šè¿‡åŠ é”æ¥ä¿è¯å†™æ“ä½œå’Œè¯»æ“ä½œçš„äº’æ–¥ï¼Œé¿å…å¹¶å‘ä¸ä¸€è‡´ã€‚\nè¯»å†™é” è¯»é”ï¼ˆå…±äº«é”ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½å†™ã€‚ å†™é”ï¼ˆæ’ä»–é”ï¼‰ï¼šå†™æ—¶ç‹¬å ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ã€‚ ä»£ç å®ç°ï¼ˆRedisson å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 @Service public class UserServiceWithLock { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RedissonClient redissonClient; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String LOCK_PREFIX = \u0026#34;lock:user:\u0026#34;; /** * ä½¿ç”¨è¯»å†™é”æŸ¥è¯¢ç”¨æˆ· */ public User getUserWithReadLock(Long userId) { String lockKey = LOCK_PREFIX + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock readLock = rwLock.readLock(); try { readLock.lock(); // 1. å…ˆæŸ¥ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + userId; User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { log.info(\u0026#34;ç¼“å­˜å‘½ä¸­ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ log.info(\u0026#34;ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;æ•°æ®å›å¡«ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } return user; } finally { readLock.unlock(); } } /** * ä½¿ç”¨å†™é”æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithWriteLock(User user) { String lockKey = LOCK_PREFIX + user.getId(); RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock writeLock = rwLock.writeLock(); try { writeLock.lock(); // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } finally { writeLock.unlock(); } } /** * ä½¿ç”¨åˆ†å¸ƒå¼é”æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithDistributedLock(User user) { String lockKey = LOCK_PREFIX + user.getId(); RLock lock = redissonClient.getLock(lockKey); try { // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”æŒæœ‰æ—¶é—´30ç§’ boolean acquired = lock.tryLock(10, 30, TimeUnit.SECONDS); if (!acquired) { log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;è·å–åˆ†å¸ƒå¼é”è¢«ä¸­æ–­ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); return false; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } } ä¼˜ç‚¹ èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œé¿å…è„è¯»ã€è„å†™ ç‰¹åˆ«é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ ç¼ºç‚¹ æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œé«˜å¹¶å‘ä¸‹å®¹æ˜“æˆä¸ºç“¶é¢ˆ å¦‚æœé”é‡Šæ”¾å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´æ­»é” é€šä¿—ç±»æ¯” å›¾ä¹¦é¦†å€Ÿä¹¦ï¼šå¤šä¸ªäººåŒæ—¶çœ‹åŒä¸€æœ¬ä¹¦æ²¡é—®é¢˜ï¼ˆè¯»è¯»ä¸äº’æ–¥ï¼‰ã€‚å¦‚æœæœ‰äººè¦åœ¨ä¹¦ä¸Šå†™ç¬”è®°ï¼ˆå†™æ“ä½œï¼‰ï¼Œé‚£å¿…é¡»ç‹¬å è¿™æœ¬ä¹¦ï¼Œåˆ«äººä¸èƒ½å†çœ‹ï¼ˆè¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ï¼‰ã€‚\n2.4 æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ æ›´æ–°æ•°æ®åº“åï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ›´æ–°äº‹ä»¶ï¼Œæ¶ˆè´¹è€…è®¢é˜…åæ›´æ–°ç¼“å­˜ã€‚\nä»£ç å®ç° ç”Ÿäº§è€…ï¼ˆæ›´æ–°æ•°æ®åº“åå‘é€æ¶ˆæ¯ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 @Service public class UserServiceWithMQ { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RabbitTemplate rabbitTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String USER_UPDATE_QUEUE = \u0026#34;user.update.queue\u0026#34;; private static final String USER_DELETE_QUEUE = \u0026#34;user.delete.queue\u0026#34;; /** * æ›´æ–°ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ */ @Transactional public boolean updateUserWithMQ(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { return false; } // 2. å‘é€æ›´æ–°æ¶ˆæ¯ UserUpdateEvent event = new UserUpdateEvent(); event.setUserId(user.getId()); event.setOperation(\u0026#34;UPDATE\u0026#34;); event.setTimestamp(System.currentTimeMillis()); rabbitTemplate.convertAndSend(USER_UPDATE_QUEUE, event); log.info(\u0026#34;å‘é€ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * åˆ é™¤ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ */ @Transactional public boolean deleteUserWithMQ(Long userId) { try { // 1. åˆ é™¤æ•°æ®åº“è®°å½• int result = userMapper.deleteById(userId); if (result \u0026lt;= 0) { return false; } // 2. å‘é€åˆ é™¤æ¶ˆæ¯ UserDeleteEvent event = new UserDeleteEvent(); event.setUserId(userId); event.setOperation(\u0026#34;DELETE\u0026#34;); event.setTimestamp(System.currentTimeMillis()); rabbitTemplate.convertAndSend(USER_DELETE_QUEUE, event); log.info(\u0026#34;å‘é€ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return true; } catch (Exception e) { log.error(\u0026#34;åˆ é™¤ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); throw new RuntimeException(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } } // äº‹ä»¶ç±» @Data public class UserUpdateEvent { private Long userId; private String operation; private Long timestamp; } @Data public class UserDeleteEvent { private Long userId; private String operation; private Long timestamp; } æ¶ˆè´¹è€…ï¼ˆå¤„ç†æ¶ˆæ¯å¹¶æ›´æ–°ç¼“å­˜ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component public class UserCacheConsumer { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; /** * å¤„ç†ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;user.update.queue\u0026#34;) public void handleUserUpdate(UserUpdateEvent event) { try { log.info(\u0026#34;æ”¶åˆ°ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); // 1. æŸ¥è¯¢æœ€æ–°æ•°æ® User user = userMapper.selectById(event.getUserId()); if (user != null) { // 2. æ›´æ–°ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;ç¼“å­˜æ›´æ–°æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } else { // 3. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + event.getUserId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ é™¤ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); } } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç”¨æˆ·æ›´æ–°æ¶ˆæ¯å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId(), e); // è¿™é‡Œå¯ä»¥å®ç°é‡è¯•æœºåˆ¶æˆ–æ­»ä¿¡é˜Ÿåˆ— } } /** * å¤„ç†ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;user.delete.queue\u0026#34;) public void handleUserDelete(UserDeleteEvent event) { try { log.info(\u0026#34;æ”¶åˆ°ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); // åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + event.getUserId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç¼“å­˜åˆ é™¤æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç”¨æˆ·åˆ é™¤æ¶ˆæ¯å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId(), e); } } } ä¼˜ç‚¹ æ•°æ®åº“ä¸ç¼“å­˜è§£è€¦ï¼Œä¿è¯å¼‚æ­¥æœ€ç»ˆä¸€è‡´æ€§ èƒ½æ‰¿å—æ›´é«˜çš„å¹¶å‘é‡ ç¼ºç‚¹ å¼•å…¥ MQ å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ æ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤æ¶ˆè´¹éœ€è¦é¢å¤–å¤„ç† é€šä¿—ç±»æ¯” ä½ æ¬å®¶äº†ï¼Œå…ˆåœ¨ç³»ç»Ÿé‡Œæ”¹äº†åœ°å€ï¼ˆæ•°æ®åº“ï¼‰ã€‚ç³»ç»Ÿå‘äº†ä¸€æ¡é€šçŸ¥ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œå‘Šè¯‰å¿«é€’å…¬å¸æ›´æ–°æ”¶ä»¶åœ°å€ï¼ˆç¼“å­˜ï¼‰ã€‚\n2.5 åŸºäº Binlog çš„ Canal åŒæ­¥ é€šè¿‡ç›‘å¬ MySQL çš„ Binlogï¼Œæ•è·æ•°æ®å˜æ›´äº‹ä»¶ï¼Œç„¶åæ›´æ–° Redisã€‚\næµç¨‹ MySQL å¼€å¯ Binlog Canal ä½œä¸ºä»åº“ä¼ªè£…ï¼Œè®¢é˜… Binlog Binlog é‡Œè®°å½•äº† INSERT/UPDATE/DELETE Canal è§£æäº‹ä»¶å¹¶å›å†™ Redis ä»£ç å®ç° Canal é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # canal.properties canal.port = 11111 canal.metrics.pull.port = 11112 canal.zkServers = localhost:2181 # å®ä¾‹é…ç½® canal.destinations = example canal.conf.dir = /opt/canal/conf canal.instance.global.master.address = 127.0.0.1:3306 canal.instance.global.master.journal.name = canal.instance.global.master.position = canal.instance.global.master.timestamp = canal.instance.global.master.gtid = canal.instance.dbUsername = canal canal.instance.dbPassword = canal canal.instance.connectionCharset = UTF-8 canal.instance.filter.regex = .*\\\\..* canal.instance.master.address = 127.0.0.1:3306 canal.instance.master.journal.name = canal.instance.master.position = canal.instance.master.timestamp = canal.instance.master.gtid = Canal å®¢æˆ·ç«¯ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 @Component public class CanalClient { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String USER_TABLE = \u0026#34;t_user\u0026#34;; @PostConstruct public void startCanalClient() { // åˆ›å»ºCanalè¿æ¥ CanalConnector connector = CanalConnectors.newSingleConnector( new InetSocketAddress(\u0026#34;127.0.0.1\u0026#34;, 11111), \u0026#34;example\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34; ); try { connector.connect(); connector.subscribe(\u0026#34;.*\\\\..*\u0026#34;); connector.rollback(); while (true) { Message message = connector.getWithoutAck(1000); long batchId = message.getBatchId(); int size = message.getEntries().size(); if (batchId == -1 || size == 0) { Thread.sleep(1000); } else { printEntry(message.getEntries()); connector.ack(batchId); } } } catch (Exception e) { log.error(\u0026#34;Canalå®¢æˆ·ç«¯å¼‚å¸¸\u0026#34;, e); } finally { connector.disconnect(); } } private void printEntry(List\u0026lt;Entry\u0026gt; entries) { for (Entry entry : entries) { if (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) { continue; } RowChange rowChange = null; try { rowChange = RowChange.parseFrom(entry.getStoreValue()); } catch (Exception e) { throw new RuntimeException(\u0026#34;è§£æbinlogå¼‚å¸¸\u0026#34;, e); } EventType eventType = rowChange.getEventType(); String tableName = entry.getHeader().getTableName(); // åªå¤„ç†ç”¨æˆ·è¡¨ if (!USER_TABLE.equals(tableName)) { continue; } for (RowData rowData : rowChange.getRowDatasList()) { if (eventType == EventType.DELETE) { handleDelete(rowData.getBeforeColumnsList()); } else if (eventType == EventType.INSERT) { handleInsert(rowData.getAfterColumnsList()); } else if (eventType == EventType.UPDATE) { handleUpdate(rowData.getAfterColumnsList()); } } } } private void handleInsert(List\u0026lt;Column\u0026gt; columns) { try { User user = buildUserFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;CanalåŒæ­¥æ–°å¢ç”¨æˆ·åˆ°ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ–°å¢ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private void handleUpdate(List\u0026lt;Column\u0026gt; columns) { try { User user = buildUserFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;CanalåŒæ­¥æ›´æ–°ç”¨æˆ·åˆ°ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ›´æ–°ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private void handleDelete(List\u0026lt;Column\u0026gt; columns) { try { Long userId = getUserIdFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + userId; redisTemplate.delete(cacheKey); log.info(\u0026#34;CanalåŒæ­¥åˆ é™¤ç”¨æˆ·ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } catch (Exception e) { log.error(\u0026#34;å¤„ç†åˆ é™¤ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private User buildUserFromColumns(List\u0026lt;Column\u0026gt; columns) { User user = new User(); for (Column column : columns) { String name = column.getName(); String value = column.getValue(); switch (name) { case \u0026#34;id\u0026#34;: user.setId(Long.valueOf(value)); break; case \u0026#34;username\u0026#34;: user.setUsername(value); break; case \u0026#34;email\u0026#34;: user.setEmail(value); break; case \u0026#34;phone\u0026#34;: user.setPhone(value); break; case \u0026#34;create_time\u0026#34;: user.setCreateTime(LocalDateTime.parse(value)); break; case \u0026#34;update_time\u0026#34;: user.setUpdateTime(LocalDateTime.parse(value)); break; } } return user; } private Long getUserIdFromColumns(List\u0026lt;Column\u0026gt; columns) { for (Column column : columns) { if (\u0026#34;id\u0026#34;.equals(column.getName())) { return Long.valueOf(column.getValue()); } } return null; } } ä¼˜ç‚¹ æ•°æ®åº“æ˜¯æœ€ç»ˆæ•°æ®æºï¼ŒCanal ä¿è¯æ•°æ®åº“å’Œç¼“å­˜é«˜åº¦ä¸€è‡´ é€‚åˆå¼ºä¸€è‡´æ€§ã€è¯»å†™é¢‘ç¹çš„åœºæ™¯ ç¼ºç‚¹ Canal éƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ å®æ—¶æ€§å–å†³äº Binlog è§£æå’Œæ¶ˆè´¹é€Ÿåº¦ é€šä¿—ç±»æ¯” å°±åƒä½ ç»™å®¶é‡Œè£…äº†ä¸€ä¸ªç›‘æ§ï¼ˆCanalï¼‰ï¼Œæ¯æ¬¡æœ‰äººå¼€é—¨æ¢é”ï¼ˆæ•°æ®åº“æ›´æ–°ï¼‰ï¼Œç›‘æ§ç«‹åˆ»é€šçŸ¥ä¿å®‰ï¼ˆRedis æ›´æ–°ï¼‰ã€‚\nä¸‰ã€æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“ æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ é«˜ ä½ è¯»å¤šå†™å°‘ï¼Œæ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´ å»¶æ—¶åŒåˆ  è¾ƒå¼ºä¸€è‡´æ€§ ä¸­ ä¸­ èƒ½å®¹å¿çŸ­å»¶è¿Ÿï¼Œå†™è¯·æ±‚è¾ƒå¤šæ—¶ åŠ é”ç­–ç•¥ å¼ºä¸€è‡´æ€§ ä½ ä¸­ é‡‘èã€ç”µå•†ç­‰å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ æœ€ç»ˆä¸€è‡´æ€§ é«˜ é«˜ é«˜å¹¶å‘ã€å¼‚æ­¥åœºæ™¯ Canal Binlog åŒæ­¥ å‡†å®æ—¶å¼ºä¸€è‡´æ€§ ä¸­ é«˜ æ ¸å¿ƒä¸šåŠ¡ï¼Œå¼ºä¸€è‡´è¦æ±‚ å››ã€æœ€ä½³å®è·µå»ºè®® è¯»å¤šå†™å°‘ï¼Œæ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´ â†’ ä½¿ç”¨ Cache Aside é«˜å¹¶å‘å†™åœºæ™¯ â†’ å»¶æ—¶åŒåˆ  + åˆç†æ—¶é—´çª—å£ é‡‘èã€äº¤æ˜“ä¸šåŠ¡ â†’ åˆ†å¸ƒå¼è¯»å†™é”ï¼Œä¿è¯å¼ºä¸€è‡´æ€§ é«˜å¯æ‰©å±•ã€é«˜å¹¶å‘ â†’ æ•°æ®åº“å†™ + MQ å¼‚æ­¥æ›´æ–°ç¼“å­˜ ä¼ä¸šçº§æ ¸å¿ƒä¸šåŠ¡ â†’ Binlog + Canalï¼Œä¿è¯æ•°æ®åº“ä¸ç¼“å­˜å®æ—¶åŒæ­¥ äº”ã€å®é™…é¡¹ç›®ä¸­çš„ç»¼åˆæ–¹æ¡ˆ åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¾€å¾€éœ€è¦æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 @Service public class UserServiceComprehensive { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RedissonClient redissonClient; @Autowired private RabbitTemplate rabbitTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String LOCK_PREFIX = \u0026#34;lock:user:\u0026#34;; /** * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„ç¼“å­˜ç­–ç•¥ */ public User getUser(Long userId, CacheStrategy strategy) { switch (strategy) { case CACHE_ASIDE: return getUserWithCacheAside(userId); case READ_WRITE_LOCK: return getUserWithReadWriteLock(userId); case MQ_SYNC: return getUserWithMQSync(userId); default: return getUserWithCacheAside(userId); } } /** * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„æ›´æ–°ç­–ç•¥ */ public boolean updateUser(User user, CacheStrategy strategy) { switch (strategy) { case CACHE_ASIDE: return updateUserWithCacheAside(user); case DELAY_DOUBLE_DELETE: return updateUserWithDelayDoubleDelete(user); case READ_WRITE_LOCK: return updateUserWithReadWriteLock(user); case MQ_SYNC: return updateUserWithMQSync(user); default: return updateUserWithCacheAside(user); } } // å„ç§ç­–ç•¥çš„å…·ä½“å®ç°... } enum CacheStrategy { CACHE_ASIDE, // æ—è·¯ç¼“å­˜ DELAY_DOUBLE_DELETE, // å»¶æ—¶åŒåˆ  READ_WRITE_LOCK, // è¯»å†™é” MQ_SYNC, // æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ CANAL_SYNC // CanalåŒæ­¥ } å…­ã€ç›‘æ§å’Œå‘Šè­¦ ä¸ºäº†ä¿è¯ç¼“å­˜ä¸€è‡´æ€§ï¼Œè¿˜éœ€è¦å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 @Component public class CacheConsistencyMonitor { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private UserMapper userMapper; /** * å®šæœŸæ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§ */ @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ public void checkCacheConsistency() { // éšæœºæŠ½æ ·æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§ List\u0026lt;Long\u0026gt; userIds = getRandomUserIds(100); for (Long userId : userIds) { try { // 1. æŸ¥è¯¢æ•°æ®åº“ User dbUser = userMapper.selectById(userId); // 2. æŸ¥è¯¢ç¼“å­˜ String cacheKey = \u0026#34;user:\u0026#34; + userId; User cacheUser = (User) redisTemplate.opsForValue().get(cacheKey); // 3. æ¯”è¾ƒæ•°æ® if (dbUser != null \u0026amp;\u0026amp; cacheUser != null) { if (!Objects.equals(dbUser.getUsername(), cacheUser.getUsername()) || !Objects.equals(dbUser.getEmail(), cacheUser.getEmail())) { // æ•°æ®ä¸ä¸€è‡´ï¼Œè®°å½•å‘Šè­¦ log.warn(\u0026#34;å‘ç°ç¼“å­˜ä¸ä¸€è‡´ï¼Œç”¨æˆ·ID: {}, æ•°æ®åº“: {}, ç¼“å­˜: {}\u0026#34;, userId, dbUser, cacheUser); // ä¿®å¤ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES); } } } catch (Exception e) { log.error(\u0026#34;æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); } } } private List\u0026lt;Long\u0026gt; getRandomUserIds(int count) { // å®ç°éšæœºè·å–ç”¨æˆ·IDçš„é€»è¾‘ return userMapper.selectRandomUserIds(count); } } ä¸ƒã€ç»“è¯­ æ•°æ®åº“ä¸ Redis çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ å¦‚ä½•å¤„ç†\u0026quot;ä¸¤ä¸ªå‰¯æœ¬æ•°æ®çš„ä¸åŒæ­¥\u0026quot;ã€‚\næ²¡æœ‰ä¸€ç§ä¸‡èƒ½æ–¹æ¡ˆï¼Œéœ€è¦ç»“åˆä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©ï¼š\næ€§èƒ½ä¼˜å…ˆ â†’ Cache Aside ä¸€è‡´æ€§ä¼˜å…ˆ â†’ åŠ é” / Canal æŠ˜ä¸­ â†’ å»¶æ—¶åŒåˆ  / MQ åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œå¾€å¾€æ˜¯ å¤šç§æ–¹æ¡ˆç»“åˆ ä½¿ç”¨ï¼Œæ‰èƒ½æ—¢ä¿è¯æ€§èƒ½ï¼Œåˆä¿è¯æ•°æ®å¯é ã€‚\né€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œä»£ç ç¤ºä¾‹ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯ã€æ€§èƒ½è¦æ±‚ã€ä¸€è‡´æ€§è¦æ±‚æ¥é€‰æ‹©æœ€é€‚åˆçš„æ–¹æ¡ˆï¼Œå¹¶åœ¨å¿…è¦æ—¶ç»“åˆå¤šç§ç­–ç•¥æ¥å®ç°æœ€ä½³æ•ˆæœã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†æ•°æ®åº“ä¸RedisåŒå†™ä¸€è‡´æ€§é—®é¢˜çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºæ­£ç¡®çš„æŠ€æœ¯é€‰æ‹©ã€‚\n","date":"2025-08-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E-redis-%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E5%85%A8%E8%A7%A3%E6%9E%90/","title":"æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ"},{"content":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡ ç›®å½• é¡¹ç›®æ¦‚è¿° æŠ€æœ¯æ ˆè¯´æ˜ æ•´ä½“æ¶æ„è®¾è®¡ æ•°æ®åº“è®¾è®¡å®Œå–„ ä¸‹ä¸€æ­¥è®¡åˆ’ é¡¹ç›®æ¦‚è¿° æœ¬æŒ‡å—å°†åŸºäºç°æœ‰çš„Hashå’–å•¡é¡¹ç›®ï¼Œå®ç°ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼ç§’æ€ç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\nåˆ†å¸ƒå¼é”é˜²è¶…å–ï¼šåŸºäºRedissonå’ŒLuaè„šæœ¬å®ç°é«˜å¹¶å‘åœºæ™¯ä¸‹çš„åº“å­˜æ§åˆ¶ æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ï¼šRabbitMQå¼‚æ­¥å¤„ç†è®¢å•æ”¯ä»˜å’Œç§¯åˆ†ç³»ç»Ÿ å¤šç«¯æ”¯æŒï¼šç®¡ç†ç«¯ã€ç”¨æˆ·ç«¯ã€å¾®ä¿¡å°ç¨‹åºç»Ÿä¸€åç«¯æœåŠ¡ å®Œæ•´éƒ¨ç½²ï¼šDocker + Nginxé…ç½®ï¼Œæ”¯æŒç”Ÿäº§ç¯å¢ƒéƒ¨ç½² åŠŸèƒ½ç›®æ ‡ å®ç°é«˜å¹¶å‘çš„ç§’æ€æ´»åŠ¨ç³»ç»Ÿ é˜²æ­¢è¶…å–å’Œé‡å¤å‚ä¸ æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² æä¾›ç”¨æˆ·å‹å¥½çš„ç•Œé¢ ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿç¨³å®šæ€§ æŠ€æœ¯æ ˆè¯´æ˜ ç»„ä»¶ æŠ€æœ¯é€‰å‹ ç‰ˆæœ¬ ä½œç”¨ åç«¯æ¡†æ¶ Spring Boot 2.7.3 ä¸»æ¡†æ¶ï¼Œæä¾›åŸºç¡€åŠŸèƒ½ æ•°æ®åº“ MySQL 8.0 æ•°æ®æŒä¹…åŒ–å­˜å‚¨ ç¼“å­˜ Redis 6.2 ç¼“å­˜å’Œåˆ†å¸ƒå¼é” æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ 3.9 å¼‚æ­¥æ¶ˆæ¯å¤„ç† åˆ†å¸ƒå¼é” Redisson 3.17.7 é˜²è¶…å–å’Œå¹¶å‘æ§åˆ¶ ç®¡ç†ç«¯å‰ç«¯ Vue.js + Element UI - ç®¡ç†ç«¯ç•Œé¢ï¼ˆè‹ç©¹å¤–å–å‰ç«¯-frontendï¼‰ ç”¨æˆ·ç«¯ UniApp - å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç«¯ï¼ˆproject-rjwm-weixin-uniapp-develop-wsyï¼‰ åå‘ä»£ç† Nginx - è´Ÿè½½å‡è¡¡å’Œé™æ€èµ„æºæœåŠ¡ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§ é«˜å¹¶å‘å¤„ç†ï¼šRedisç¼“å­˜ + åˆ†å¸ƒå¼é” å¼‚æ­¥è§£è€¦ï¼šRabbitMQæ¶ˆæ¯é˜Ÿåˆ— æ•°æ®ä¸€è‡´æ€§ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ ç³»ç»Ÿç›‘æ§ï¼šå¥åº·æ£€æŸ¥å’Œæ—¥å¿—è®°å½• é™æµä¿æŠ¤ï¼šNginxå±‚é¢çš„è¯·æ±‚é™æµ æ•´ä½“æ¶æ„è®¾è®¡ æ¶æ„å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç®¡ç†ç«¯å‰ç«¯ â”‚ â”‚ å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç«¯ â”‚ â”‚ Hashå’–å•¡å‰ç«¯-frontend â”‚ â”‚ project-rjwm-weixin-uniapp- â”‚ â”‚ Vue.js + Element UI â”‚ â”‚ develop-wsy (UniApp) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Nginx åå‘ä»£ç† â”‚ â”‚ (è´Ÿè½½å‡è¡¡ + é™æµ) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Hash Coffee åç«¯ â”‚ â”‚ Spring Boot + MyBatis â”‚ â”‚ (ç«¯å£: 8084) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Redis ç¼“å­˜ â”‚ â”‚ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ— â”‚ â”‚ Redisson åˆ†å¸ƒå¼é” â”‚ â”‚ åˆ†å¸ƒå¼é”+ç§’æ€ç¼“å­˜â”‚ â”‚ å¼‚æ­¥å¤„ç†+å»¶è¿Ÿæ¶ˆæ¯ â”‚ â”‚ é˜²è¶…å–+å¹‚ç­‰æ€§ â”‚ â”‚ (ç«¯å£: 6379) â”‚ â”‚ (ç«¯å£: 5672) â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ MySQL æ•°æ®åº“ â”‚ â”‚ (ä¸»ä»å¤åˆ¶ + äº‹åŠ¡) â”‚ â”‚ (ç«¯å£: 3306) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ•°æ®æµå‘ ç®¡ç†å‘˜è®¿é—®æµç¨‹ï¼š\nç®¡ç†å‘˜é€šè¿‡ç®¡ç†ç«¯å‰ç«¯(Vue.js)å‘èµ·è¯·æ±‚ Nginxæ¥æ”¶è¯·æ±‚å¹¶è¿›è¡Œåå‘ä»£ç† åç«¯æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘ è¿”å›å“åº”ç»™ç®¡ç†å‘˜ ç”¨æˆ·è®¿é—®æµç¨‹ï¼š\nç”¨æˆ·é€šè¿‡å¾®ä¿¡å°ç¨‹åº(UniApp)å‘èµ·è¯·æ±‚ Nginxæ¥æ”¶è¯·æ±‚å¹¶è¿›è¡Œåå‘ä»£ç† åç«¯æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘ è¿”å›å“åº”ç»™ç”¨æˆ· ç§’æ€æµç¨‹ï¼š\nç”¨æˆ·å‚ä¸ç§’æ€æ´»åŠ¨ Redisåˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤å‚ä¸ Luaè„šæœ¬ä¿è¯åº“å­˜æ‰£å‡åŸå­æ€§ å¼‚æ­¥åˆ›å»ºè®¢å•å’Œæ›´æ–°æ•°æ®åº“ æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹ï¼š\nè®¢å•æ”¯ä»˜æˆåŠŸåå‘é€æ¶ˆæ¯ RabbitMQå¼‚æ­¥å¤„ç†ç§¯åˆ†è®¡ç®— è§£è€¦æ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡ æ•°æ®åº“è®¾è®¡å®Œå–„ ç°æœ‰æ•°æ®åº“è¡¨ç»“æ„ é¡¹ç›®å·²ç»åŒ…å«äº†å®Œæ•´çš„æ•°æ®åº“è®¾è®¡ï¼ˆscript3.sqlï¼‰ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ ¸å¿ƒä¸šåŠ¡è¡¨ 1. ç§’æ€æ´»åŠ¨è¡¨ (seckill_activity)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 CREATE TABLE seckill_activity ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;æ´»åŠ¨ID\u0026#39; PRIMARY KEY, name VARCHAR(100) NOT NULL COMMENT \u0026#39;æ´»åŠ¨åç§°\u0026#39;, description TEXT COMMENT \u0026#39;æ´»åŠ¨æè¿°\u0026#39;, dish_id BIGINT NOT NULL COMMENT \u0026#39;èœå“ID\u0026#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT \u0026#39;ç§’æ€ä»·æ ¼\u0026#39;, original_price DECIMAL(10,2) NOT NULL COMMENT \u0026#39;åŸä»·\u0026#39;, stock INT NOT NULL COMMENT \u0026#39;ç§’æ€åº“å­˜\u0026#39;, sold_count INT DEFAULT 0 COMMENT \u0026#39;å·²å”®æ•°é‡\u0026#39;, per_user_limit INT DEFAULT 1 COMMENT \u0026#39;æ¯äººé™è´­æ•°é‡\u0026#39;, start_time DATETIME NOT NULL COMMENT \u0026#39;å¼€å§‹æ—¶é—´\u0026#39;, end_time DATETIME NOT NULL COMMENT \u0026#39;ç»“æŸæ—¶é—´\u0026#39;, status TINYINT(1) DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, create_user BIGINT COMMENT \u0026#39;åˆ›å»ºäºº\u0026#39;, update_user BIGINT COMMENT \u0026#39;ä¿®æ”¹äºº\u0026#39; ); 2. ç§’æ€è®¢å•è¡¨ (seckill_order)\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE TABLE seckill_order ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®ID\u0026#39; PRIMARY KEY, activity_id BIGINT NOT NULL COMMENT \u0026#39;ç§’æ€æ´»åŠ¨ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, dish_id BIGINT NOT NULL COMMENT \u0026#39;å•†å“ID\u0026#39;, quantity INT NOT NULL COMMENT \u0026#39;è´­ä¹°æ•°é‡\u0026#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT \u0026#39;ç§’æ€ä»·æ ¼\u0026#39;, total_amount DECIMAL(10,2) NOT NULL COMMENT \u0026#39;æ€»é‡‘é¢\u0026#39;, status TINYINT(1) DEFAULT 0 COMMENT \u0026#39;è®¢å•çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æ”¯ä»˜ï¼Œ2-å·²å–æ¶ˆ\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39; ); 3. ç§’æ€å‚ä¸è®°å½•è¡¨ (seckill_participant)\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE seckill_participant ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®ID\u0026#39; PRIMARY KEY, activity_id BIGINT NOT NULL COMMENT \u0026#39;ç§’æ€æ´»åŠ¨ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, quantity INT NOT NULL COMMENT \u0026#39;å‚ä¸æ•°é‡\u0026#39;, status TINYINT(1) DEFAULT 0 COMMENT \u0026#39;çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-æˆåŠŸï¼Œ2-å¤±è´¥\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, UNIQUE KEY uk_user_activity (user_id, activity_id) ); 4. åº“å­˜æ‰£å‡è®°å½•è¡¨ (seckill_stock_log)\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE seckill_stock_log ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®ID\u0026#39; PRIMARY KEY, activity_id BIGINT NOT NULL COMMENT \u0026#39;ç§’æ€æ´»åŠ¨ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, quantity INT NOT NULL COMMENT \u0026#39;æ‰£å‡æ•°é‡\u0026#39;, before_stock INT NOT NULL COMMENT \u0026#39;æ‰£å‡å‰åº“å­˜\u0026#39;, after_stock INT NOT NULL COMMENT \u0026#39;æ‰£å‡ååº“å­˜\u0026#39;, status TINYINT(1) DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-æˆåŠŸï¼Œ0-å¤±è´¥\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39; ); ä¼˜æƒ åˆ¸ç›¸å…³è¡¨ 5. ä¼˜æƒ åˆ¸æ¨¡æ¿è¡¨ (coupon_template)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 CREATE TABLE coupon_template ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;æ¨¡æ¿ID\u0026#39; PRIMARY KEY, name VARCHAR(100) NOT NULL COMMENT \u0026#39;ä¼˜æƒ åˆ¸åç§°\u0026#39;, description VARCHAR(500) COMMENT \u0026#39;ä¼˜æƒ åˆ¸æè¿°\u0026#39;, type TINYINT(1) NOT NULL COMMENT \u0026#39;ä¼˜æƒ åˆ¸ç±»å‹ï¼š1-æ»¡å‡åˆ¸ï¼Œ2-æŠ˜æ‰£åˆ¸ï¼Œ3-ä»£é‡‘åˆ¸\u0026#39;, discount_type TINYINT(1) NOT NULL COMMENT \u0026#39;æŠ˜æ‰£ç±»å‹ï¼š1-å›ºå®šé‡‘é¢ï¼Œ2-ç™¾åˆ†æ¯”\u0026#39;, discount_value DECIMAL(10,2) NOT NULL COMMENT \u0026#39;æŠ˜æ‰£å€¼\u0026#39;, min_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT \u0026#39;æœ€ä½æ¶ˆè´¹é‡‘é¢\u0026#39;, total_count INT NOT NULL COMMENT \u0026#39;å‘æ”¾æ€»æ•°é‡\u0026#39;, used_count INT DEFAULT 0 COMMENT \u0026#39;å·²ä½¿ç”¨æ•°é‡\u0026#39;, per_user_limit INT DEFAULT 1 COMMENT \u0026#39;æ¯äººé™é¢†æ•°é‡\u0026#39;, valid_days INT COMMENT \u0026#39;æœ‰æ•ˆå¤©æ•°\u0026#39;, start_time DATETIME NOT NULL COMMENT \u0026#39;å¼€å§‹æ—¶é—´\u0026#39;, end_time DATETIME NOT NULL COMMENT \u0026#39;ç»“æŸæ—¶é—´\u0026#39;, status TINYINT(1) DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨\u0026#39; ); 6. ä¼˜æƒ åˆ¸è¡¨ (coupon)\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE TABLE coupon ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¼˜æƒ åˆ¸ID\u0026#39; PRIMARY KEY, template_id BIGINT NOT NULL COMMENT \u0026#39;æ¨¡æ¿ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, code VARCHAR(32) NOT NULL COMMENT \u0026#39;ä¼˜æƒ åˆ¸ç \u0026#39;, status TINYINT(1) DEFAULT 0 COMMENT \u0026#39;çŠ¶æ€ï¼š0-æœªä½¿ç”¨ï¼Œ1-å·²ä½¿ç”¨ï¼Œ2-å·²è¿‡æœŸ\u0026#39;, used_time DATETIME COMMENT \u0026#39;ä½¿ç”¨æ—¶é—´\u0026#39;, order_id BIGINT COMMENT \u0026#39;ä½¿ç”¨è®¢å•ID\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, UNIQUE KEY uk_code (code) ); ç³»ç»Ÿé…ç½®è¡¨ 7. ç³»ç»Ÿé…ç½®è¡¨ (system_config)\n1 2 3 4 5 6 7 8 9 CREATE TABLE system_config ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ID\u0026#39; PRIMARY KEY, config_key VARCHAR(100) NOT NULL COMMENT \u0026#39;é…ç½®é”®\u0026#39;, config_value TEXT COMMENT \u0026#39;é…ç½®å€¼\u0026#39;, description VARCHAR(255) COMMENT \u0026#39;æè¿°\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, UNIQUE KEY uk_config_key (config_key) ); 8. ç”¨æˆ·ç§¯åˆ†è®°å½•è¡¨ (user_points_log)\n1 2 3 4 5 6 7 8 9 CREATE TABLE user_points_log ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ID\u0026#39; PRIMARY KEY, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, order_id BIGINT COMMENT \u0026#39;è®¢å•ID\u0026#39;, points INT NOT NULL COMMENT \u0026#39;ç§¯åˆ†å˜åŒ–\u0026#39;, type TINYINT(1) NOT NULL COMMENT \u0026#39;ç±»å‹ï¼š1-è·å¾—ï¼Œ2-æ¶ˆè´¹\u0026#39;, description VARCHAR(255) COMMENT \u0026#39;æè¿°\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39; ); æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– ä¸ºäº†æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹ç´¢å¼•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- ç§’æ€æ´»åŠ¨è¡¨ç´¢å¼• CREATE INDEX idx_seckill_time_status ON seckill_activity(start_time, end_time, status); CREATE INDEX idx_seckill_dish_time ON seckill_activity(dish_id, start_time, end_time, status); -- ç§’æ€è®¢å•è¡¨ç´¢å¼• CREATE INDEX idx_seckill_order_user_time ON seckill_order(user_id, create_time); CREATE INDEX idx_seckill_order_activity_status ON seckill_order(activity_id, status); -- ç§’æ€å‚ä¸è®°å½•è¡¨ç´¢å¼• CREATE INDEX idx_participant_activity ON seckill_participant(activity_id); CREATE INDEX idx_participant_user ON seckill_participant(user_id); -- ä¼˜æƒ åˆ¸è¡¨ç´¢å¼• CREATE INDEX idx_coupon_user_status ON coupon(user_id, status); CREATE INDEX idx_coupon_template_time ON coupon_template(start_time, end_time, status); æ•°æ®åº“è®¾è®¡ç‰¹ç‚¹ å®Œæ•´æ€§ï¼šåŒ…å«ç§’æ€æ´»åŠ¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç† ä¸€è‡´æ€§ï¼šé€šè¿‡å¤–é”®çº¦æŸä¿è¯æ•°æ®ä¸€è‡´æ€§ æ€§èƒ½ï¼šåˆç†çš„ç´¢å¼•è®¾è®¡æå‡æŸ¥è¯¢æ•ˆç‡ æ‰©å±•æ€§ï¼šé¢„ç•™å­—æ®µæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±• å®¡è®¡ï¼šå®Œæ•´çš„åˆ›å»ºå’Œæ›´æ–°æ—¶é—´è®°å½• ä¸‹ä¸€æ­¥è®¡åˆ’ åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è®²è§£ï¼š\nç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°\nå®ä½“ç±»è®¾è®¡ï¼ˆSeckillParticipantã€SeckillOrderã€SeckillStockLogï¼‰ DTOç±»åˆ›å»ºï¼ˆSeckillParticipateDTOã€SeckillOrderDTOï¼‰ Mapperæ¥å£å®ç°å’ŒXMLé…ç½® åˆ†å¸ƒå¼é”æœåŠ¡ï¼ˆDistributedLockServiceï¼‰ Luaè„šæœ¬å®ç°ï¼ˆé˜²è¶…å–æ ¸å¿ƒé€»è¾‘ï¼‰ æœåŠ¡å±‚å¢å¼ºï¼ˆSeckillActivityServiceImplï¼‰ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£\nRabbitMQé…ç½®å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶æ„ æ¶ˆæ¯å®ä½“ç±»è®¾è®¡ï¼ˆOrderPayMessageã€PointsEarnMessageç­‰ï¼‰ æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ï¼ˆMessageProducerServiceï¼‰ æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ï¼ˆMessageConsumerServiceï¼‰ APIæ¥å£å¼€å‘ï¼ˆç”¨æˆ·ç«¯æ§åˆ¶å™¨ï¼‰ é…ç½®æ–‡ä»¶å®Œå–„å’Œéƒ¨ç½²æµ‹è¯• æ¯ä¸ªéƒ¨åˆ†éƒ½ä¼šæä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œè¯¦ç»†çš„å®ç°è¯´æ˜ï¼Œç¡®ä¿ä½ å¯ä»¥æŒ‰ç…§æŒ‡å—é€æ­¥å®Œæˆåç«¯æ”¹é€ ã€‚\nç»§ç»­é˜…è¯»ï¼šHashå’–å•¡åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/","title":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡"},{"content":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£ ç›®å½• æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„è®¾è®¡ RabbitMQé…ç½® æ¶ˆæ¯å®ä½“ç±»è®¾è®¡ æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ APIæ¥å£å¼€å‘ é…ç½®æ–‡ä»¶å®Œå–„ éƒ¨ç½²å’Œæµ‹è¯• æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„è®¾è®¡ 1. æ¶ˆæ¯é˜Ÿåˆ—ä½œç”¨ åœ¨ç§’æ€ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦ç”¨äºï¼š\nè§£è€¦æœåŠ¡ï¼šæ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡è§£è€¦ å¼‚æ­¥å¤„ç†ï¼šè®¢å•æ”¯ä»˜åå¼‚æ­¥å¤„ç†ç§¯åˆ†è®¡ç®— å‰Šå³°å¡«è°·ï¼šåº”å¯¹é«˜å¹¶å‘åœºæ™¯ å¯é æ€§ï¼šæ¶ˆæ¯æŒä¹…åŒ–å’Œé‡è¯•æœºåˆ¶ 2. æ¶ˆæ¯æµå‘å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ è®¢å•æ”¯ä»˜ â”‚ â”‚ ç§¯åˆ†è®¡ç®— â”‚ â”‚ è®¢å•è¶…æ—¶ â”‚ â”‚ (åŒæ­¥) â”‚ â”‚ (å¼‚æ­¥) â”‚ â”‚ (å»¶è¿Ÿ) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â–¼ â–¼ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Order Pay â”‚ â”‚ Points Earn â”‚ â”‚ Order Timeout â”‚ â”‚ Message â”‚ â”‚ Message â”‚ â”‚ Message â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ RabbitMQ â”‚ â”‚ (æ¶ˆæ¯é˜Ÿåˆ—) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æ¶ˆæ¯æ¶ˆè´¹è€… â”‚ â”‚ (å¼‚æ­¥å¤„ç†) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ RabbitMQé…ç½® 1. æ·»åŠ é¡¹ç›®ä¾èµ– ä¿®æ”¹ sky-server/pom.xmlï¼š\n1 2 3 4 5 6 7 \u0026lt;!-- åœ¨ç°æœ‰ä¾èµ–åæ·»åŠ ä»¥ä¸‹å†…å®¹ --\u0026gt; \u0026lt;!-- RabbitMQ æ¶ˆæ¯é˜Ÿåˆ— --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-amqp\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; 2. åˆ›å»ºRabbitMQé…ç½®ç±» åˆ›å»º sky-server/src/main/java/com/sky/config/RabbitMQConfig.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 package com.sky.config; import org.springframework.amqp.core.*; import org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory; import org.springframework.amqp.rabbit.connection.ConnectionFactory; import org.springframework.amqp.rabbit.core.RabbitTemplate; import org.springframework.amqp.rabbit.listener.RabbitListenerContainerFactory; import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; /** * RabbitMQé…ç½® */ @Configuration public class RabbitMQConfig { // è®¢å•ç›¸å…³é˜Ÿåˆ— public static final String ORDER_QUEUE = \u0026#34;order.queue\u0026#34;; public static final String ORDER_EXCHANGE = \u0026#34;order.exchange\u0026#34;; public static final String ORDER_ROUTING_KEY = \u0026#34;order.pay\u0026#34;; // ç§¯åˆ†ç›¸å…³é˜Ÿåˆ— public static final String POINTS_QUEUE = \u0026#34;points.queue\u0026#34;; public static final String POINTS_EXCHANGE = \u0026#34;points.exchange\u0026#34;; public static final String POINTS_ROUTING_KEY = \u0026#34;points.earn\u0026#34;; // è®¢å•è¶…æ—¶é˜Ÿåˆ— public static final String ORDER_TIMEOUT_QUEUE = \u0026#34;order.timeout.queue\u0026#34;; public static final String ORDER_TIMEOUT_EXCHANGE = \u0026#34;order.timeout.exchange\u0026#34;; public static final String ORDER_TIMEOUT_ROUTING_KEY = \u0026#34;order.timeout\u0026#34;; // æ­»ä¿¡é˜Ÿåˆ— public static final String ORDER_DLX_QUEUE = \u0026#34;order.dlx.queue\u0026#34;; public static final String ORDER_DLX_EXCHANGE = \u0026#34;order.dlx.exchange\u0026#34;; /** * è®¢å•äº¤æ¢æœº */ @Bean public DirectExchange orderExchange() { return new DirectExchange(ORDER_EXCHANGE, true, false); } /** * è®¢å•é˜Ÿåˆ— */ @Bean public Queue orderQueue() { return QueueBuilder.durable(ORDER_QUEUE) .withArgument(\u0026#34;x-dead-letter-exchange\u0026#34;, ORDER_DLX_EXCHANGE) .withArgument(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;order.dlx\u0026#34;) .build(); } /** * è®¢å•é˜Ÿåˆ—ç»‘å®š */ @Bean public Binding orderBinding() { return BindingBuilder.bind(orderQueue()).to(orderExchange()).with(ORDER_ROUTING_KEY); } /** * ç§¯åˆ†äº¤æ¢æœº */ @Bean public DirectExchange pointsExchange() { return new DirectExchange(POINTS_EXCHANGE, true, false); } /** * ç§¯åˆ†é˜Ÿåˆ— */ @Bean public Queue pointsQueue() { return QueueBuilder.durable(POINTS_QUEUE).build(); } /** * ç§¯åˆ†é˜Ÿåˆ—ç»‘å®š */ @Bean public Binding pointsBinding() { return BindingBuilder.bind(pointsQueue()).to(pointsExchange()).with(POINTS_ROUTING_KEY); } /** * è®¢å•è¶…æ—¶äº¤æ¢æœº */ @Bean public DirectExchange orderTimeoutExchange() { return new DirectExchange(ORDER_TIMEOUT_EXCHANGE, true, false); } /** * è®¢å•è¶…æ—¶é˜Ÿåˆ— */ @Bean public Queue orderTimeoutQueue() { return QueueBuilder.durable(ORDER_TIMEOUT_QUEUE) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 15 * 60 * 1000) // 15åˆ†é’ŸTTL .withArgument(\u0026#34;x-dead-letter-exchange\u0026#34;, ORDER_DLX_EXCHANGE) .withArgument(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;order.timeout\u0026#34;) .build(); } /** * è®¢å•è¶…æ—¶é˜Ÿåˆ—ç»‘å®š */ @Bean public Binding orderTimeoutBinding() { return BindingBuilder.bind(orderTimeoutQueue()).to(orderTimeoutExchange()).with(ORDER_TIMEOUT_ROUTING_KEY); } /** * æ­»ä¿¡äº¤æ¢æœº */ @Bean public DirectExchange orderDlxExchange() { return new DirectExchange(ORDER_DLX_EXCHANGE, true, false); } /** * æ­»ä¿¡é˜Ÿåˆ— */ @Bean public Queue orderDlxQueue() { return QueueBuilder.durable(ORDER_DLX_QUEUE).build(); } /** * æ­»ä¿¡é˜Ÿåˆ—ç»‘å®š */ @Bean public Binding orderDlxBinding() { return BindingBuilder.bind(orderDlxQueue()).to(orderDlxExchange()).with(\u0026#34;order.dlx\u0026#34;); } /** * JSONæ¶ˆæ¯è½¬æ¢å™¨ */ @Bean public Jackson2JsonMessageConverter messageConverter() { return new Jackson2JsonMessageConverter(); } /** * RabbitTemplateé…ç½® */ @Bean public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); template.setMessageConverter(messageConverter()); return template; } /** * æ¶ˆè´¹è€…å®¹å™¨å·¥å‚é…ç½® */ @Bean public RabbitListenerContainerFactory\u0026lt;?\u0026gt; rabbitListenerContainerFactory(ConnectionFactory connectionFactory) { SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); // è®¾ç½®å¹¶å‘æ¶ˆè´¹è€…æ•°é‡ factory.setConcurrentConsumers(3); factory.setMaxConcurrentConsumers(10); // è®¾ç½®é¢„å–æ•°é‡ factory.setPrefetchCount(1); // è®¾ç½®æ‰‹åŠ¨ç¡®è®¤ factory.setAcknowledgeMode(AcknowledgeMode.MANUAL); return factory; } } æ¶ˆæ¯å®ä½“ç±»è®¾è®¡ 1. è®¢å•æ”¯ä»˜æ¶ˆæ¯ åˆ›å»º sky-pojo/src/main/java/com/sky/entity/message/OrderPayMessage.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package com.sky.entity.message; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.math.BigDecimal; import java.time.LocalDateTime; /** * è®¢å•æ”¯ä»˜æ¶ˆæ¯ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class OrderPayMessage implements Serializable { private static final long serialVersionUID = 1L; /** * è®¢å•ID */ private Long orderId; /** * ç”¨æˆ·ID */ private Long userId; /** * æ”¯ä»˜é‡‘é¢ */ private BigDecimal amount; /** * æ”¯ä»˜æ—¶é—´ */ private LocalDateTime payTime; /** * æ”¯ä»˜æ–¹å¼ */ private Integer payMethod; } 2. ç§¯åˆ†è·å¾—æ¶ˆæ¯ åˆ›å»º sky-pojo/src/main/java/com/sky/entity/message/PointsEarnMessage.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package com.sky.entity.message; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; /** * ç§¯åˆ†è·å¾—æ¶ˆæ¯ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class PointsEarnMessage implements Serializable { private static final long serialVersionUID = 1L; /** * ç”¨æˆ·ID */ private Long userId; /** * è®¢å•ID */ private Long orderId; /** * è·å¾—ç§¯åˆ† */ private Integer points; /** * è·å¾—æ—¶é—´ */ private LocalDateTime earnTime; } 3. è®¢å•è¶…æ—¶æ¶ˆæ¯ åˆ›å»º sky-pojo/src/main/java/com/sky/entity/message/OrderTimeoutMessage.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package com.sky.entity.message; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; /** * è®¢å•è¶…æ—¶æ¶ˆæ¯ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class OrderTimeoutMessage implements Serializable { private static final long serialVersionUID = 1L; /** * è®¢å•ID */ private Long orderId; /** * ç”¨æˆ·ID */ private Long userId; /** * è¶…æ—¶æ—¶é—´ */ private LocalDateTime timeoutTime; } æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ 1. åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ åˆ›å»º sky-server/src/main/java/com/sky/service/MessageProducerService.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 package com.sky.service; import com.sky.entity.message.OrderPayMessage; import com.sky.entity.message.OrderTimeoutMessage; import com.sky.entity.message.PointsEarnMessage; import lombok.extern.slf4j.Slf4j; import org.springframework.amqp.core.MessageDeliveryMode; import org.springframework.amqp.rabbit.core.RabbitTemplate; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Service; /** * æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ */ @Service @Slf4j public class MessageProducerService { @Autowired private RabbitTemplate rabbitTemplate; /** * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ */ public void sendOrderPayMessage(OrderPayMessage message) { try { rabbitTemplate.convertAndSend( \u0026#34;order.exchange\u0026#34;, \u0026#34;order.pay\u0026#34;, message, msg -\u0026gt; { msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); return msg; } ); log.info(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å‘é€æˆåŠŸï¼šorderId={}, userId={}\u0026#34;, message.getOrderId(), message.getUserId()); } catch (Exception e) { log.error(\u0026#34;å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤±è´¥ï¼š{}\u0026#34;, e.getMessage(), e); } } /** * å‘é€ç§¯åˆ†è·å¾—æ¶ˆæ¯ */ public void sendPointsEarnMessage(PointsEarnMessage message) { try { rabbitTemplate.convertAndSend( \u0026#34;points.exchange\u0026#34;, \u0026#34;points.earn\u0026#34;, message, msg -\u0026gt; { msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); return msg; } ); log.info(\u0026#34;ç§¯åˆ†è·å¾—æ¶ˆæ¯å‘é€æˆåŠŸï¼šuserId={}, points={}\u0026#34;, message.getUserId(), message.getPoints()); } catch (Exception e) { log.error(\u0026#34;å‘é€ç§¯åˆ†è·å¾—æ¶ˆæ¯å¤±è´¥ï¼š{}\u0026#34;, e.getMessage(), e); } } /** * å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯ */ public void sendOrderTimeoutMessage(OrderTimeoutMessage message) { try { rabbitTemplate.convertAndSend( \u0026#34;order.timeout.exchange\u0026#34;, \u0026#34;order.timeout\u0026#34;, message, msg -\u0026gt; { msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); msg.getMessageProperties().setExpiration(\u0026#34;900000\u0026#34;); // 15åˆ†é’Ÿ return msg; } ); log.info(\u0026#34;è®¢å•è¶…æ—¶æ¶ˆæ¯å‘é€æˆåŠŸï¼šorderId={}, userId={}\u0026#34;, message.getOrderId(), message.getUserId()); } catch (Exception e) { log.error(\u0026#34;å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯å¤±è´¥ï¼š{}\u0026#34;, e.getMessage(), e); } } } æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ 1. åˆ›å»ºæ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ åˆ›å»º sky-server/src/main/java/com/sky/service/MessageConsumerService.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 package com.sky.service; import com.rabbitmq.client.Channel; import com.sky.entity.message.OrderPayMessage; import com.sky.entity.message.OrderTimeoutMessage; import com.sky.entity.message.PointsEarnMessage; import lombok.extern.slf4j.Slf4j; import org.springframework.amqp.rabbit.annotation.RabbitListener; import org.springframework.amqp.support.AmqpHeaders; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.messaging.handler.annotation.Header; import org.springframework.stereotype.Service; import java.io.IOException; /** * æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ */ @Service @Slf4j public class MessageConsumerService { @Autowired private UserService userService; @Autowired private OrderService orderService; @Autowired private MessageProducerService messageProducerService; /** * å¤„ç†è®¢å•æ”¯ä»˜æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;order.queue\u0026#34;, containerFactory = \u0026#34;rabbitListenerContainerFactory\u0026#34;) public void handleOrderPayMessage(OrderPayMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { log.info(\u0026#34;å¼€å§‹å¤„ç†è®¢å•æ”¯ä»˜æ¶ˆæ¯ï¼šorderId={}, userId={}\u0026#34;, message.getOrderId(), message.getUserId()); // å¤„ç†è®¢å•æ”¯ä»˜é€»è¾‘ orderService.processOrderPayment(message.getOrderId(), message.getAmount()); // å‘é€ç§¯åˆ†è·å¾—æ¶ˆæ¯ PointsEarnMessage pointsMessage = PointsEarnMessage.builder() .userId(message.getUserId()) .orderId(message.getOrderId()) .points((int) (message.getAmount().doubleValue() * 0.01)) // 1%ç§¯åˆ† .earnTime(message.getPayTime()) .build(); messageProducerService.sendPointsEarnMessage(pointsMessage); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤„ç†æˆåŠŸï¼šorderId={}\u0026#34;, message.getOrderId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤±è´¥ï¼šorderId={}, error={}\u0026#34;, message.getOrderId(), e.getMessage(), e); try { // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, true); } catch (IOException ioException) { log.error(\u0026#34;æ‹’ç»æ¶ˆæ¯å¤±è´¥ï¼š{}\u0026#34;, ioException.getMessage(), ioException); } } } /** * å¤„ç†ç§¯åˆ†è·å¾—æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;points.queue\u0026#34;, containerFactory = \u0026#34;rabbitListenerContainerFactory\u0026#34;) public void handlePointsEarnMessage(PointsEarnMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { log.info(\u0026#34;å¼€å§‹å¤„ç†ç§¯åˆ†è·å¾—æ¶ˆæ¯ï¼šuserId={}, points={}\u0026#34;, message.getUserId(), message.getPoints()); // å¤„ç†ç§¯åˆ†è·å¾—é€»è¾‘ userService.addUserPoints(message.getUserId(), message.getPoints(), message.getOrderId()); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;ç§¯åˆ†è·å¾—æ¶ˆæ¯å¤„ç†æˆåŠŸï¼šuserId={}, points={}\u0026#34;, message.getUserId(), message.getPoints()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç§¯åˆ†è·å¾—æ¶ˆæ¯å¤±è´¥ï¼šuserId={}, error={}\u0026#34;, message.getUserId(), e.getMessage(), e); try { // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, true); } catch (IOException ioException) { log.error(\u0026#34;æ‹’ç»æ¶ˆæ¯å¤±è´¥ï¼š{}\u0026#34;, ioException.getMessage(), ioException); } } } /** * å¤„ç†è®¢å•è¶…æ—¶æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;order.dlx.queue\u0026#34;, containerFactory = \u0026#34;rabbitListenerContainerFactory\u0026#34;) public void handleOrderTimeoutMessage(OrderTimeoutMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { log.info(\u0026#34;å¼€å§‹å¤„ç†è®¢å•è¶…æ—¶æ¶ˆæ¯ï¼šorderId={}, userId={}\u0026#34;, message.getOrderId(), message.getUserId()); // å¤„ç†è®¢å•è¶…æ—¶é€»è¾‘ orderService.cancelTimeoutOrder(message.getOrderId()); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;è®¢å•è¶…æ—¶æ¶ˆæ¯å¤„ç†æˆåŠŸï¼šorderId={}\u0026#34;, message.getOrderId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†è®¢å•è¶…æ—¶æ¶ˆæ¯å¤±è´¥ï¼šorderId={}, error={}\u0026#34;, message.getOrderId(), e.getMessage(), e); try { // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, true); } catch (IOException ioException) { log.error(\u0026#34;æ‹’ç»æ¶ˆæ¯å¤±è´¥ï¼š{}\u0026#34;, ioException.getMessage(), ioException); } } } } APIæ¥å£å¼€å‘ 1. ç”¨æˆ·ç«¯ç§’æ€æ§åˆ¶å™¨ åˆ›å»º sky-server/src/main/java/com/sky/controller/user/SeckillActivityController.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package com.sky.controller.user; import com.sky.entity.SeckillActivity; import com.sky.result.Result; import com.sky.service.SeckillActivityService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.util.List; /** * ç”¨æˆ·ç«¯ç§’æ€æ´»åŠ¨æ§åˆ¶å™¨ */ @RestController @RequestMapping(\u0026#34;/user/seckill/activity\u0026#34;) @Api(tags = \u0026#34;ç”¨æˆ·ç«¯ç§’æ€æ´»åŠ¨\u0026#34;) @Slf4j public class SeckillActivityController { @Autowired private SeckillActivityService seckillActivityService; @GetMapping(\u0026#34;/current\u0026#34;) @ApiOperation(\u0026#34;è·å–å½“å‰è¿›è¡Œä¸­çš„ç§’æ€æ´»åŠ¨\u0026#34;) public Result\u0026lt;List\u0026lt;SeckillActivity\u0026gt;\u0026gt; getCurrentActivities() { log.info(\u0026#34;è·å–å½“å‰è¿›è¡Œä¸­çš„ç§’æ€æ´»åŠ¨\u0026#34;); List\u0026lt;SeckillActivity\u0026gt; activities = seckillActivityService.getCurrentActivities(); return Result.success(activities); } @GetMapping(\u0026#34;/{id}\u0026#34;) @ApiOperation(\u0026#34;æ ¹æ®idæŸ¥è¯¢ç§’æ€æ´»åŠ¨è¯¦æƒ…\u0026#34;) public Result\u0026lt;SeckillActivity\u0026gt; getById(@PathVariable Long id) { log.info(\u0026#34;æ ¹æ®idæŸ¥è¯¢ç§’æ€æ´»åŠ¨è¯¦æƒ…ï¼š{}\u0026#34;, id); SeckillActivity seckillActivity = seckillActivityService.getById(id); return Result.success(seckillActivity); } @PostMapping(\u0026#34;/participate/{id}\u0026#34;) @ApiOperation(\u0026#34;å‚ä¸ç§’æ€æ´»åŠ¨\u0026#34;) public Result\u0026lt;String\u0026gt; participateSeckill(@PathVariable Long id, @RequestParam Integer quantity, @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;ç”¨æˆ·å‚ä¸ç§’æ€æ´»åŠ¨ï¼šid={}, quantity={}, userId={}\u0026#34;, id, quantity, userId); String result = seckillActivityService.participateSeckill(id, userId, quantity); return Result.success(result); } } 2. ç”¨æˆ·ç«¯ä¼˜æƒ åˆ¸æ§åˆ¶å™¨ åˆ›å»º sky-server/src/main/java/com/sky/controller/user/CouponController.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package com.sky.controller.user; import com.sky.entity.Coupon; import com.sky.entity.CouponTemplate; import com.sky.result.Result; import com.sky.service.CouponService; import com.sky.service.CouponTemplateService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.util.List; /** * ç”¨æˆ·ç«¯ä¼˜æƒ åˆ¸æ§åˆ¶å™¨ */ @RestController @RequestMapping(\u0026#34;/user/coupon\u0026#34;) @Api(tags = \u0026#34;ç”¨æˆ·ç«¯ä¼˜æƒ åˆ¸\u0026#34;) @Slf4j public class CouponController { @Autowired private CouponTemplateService couponTemplateService; @Autowired private CouponService couponService; @GetMapping(\u0026#34;/templates/available\u0026#34;) @ApiOperation(\u0026#34;è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿\u0026#34;) public Result\u0026lt;List\u0026lt;CouponTemplate\u0026gt;\u0026gt; getAvailableTemplates() { log.info(\u0026#34;è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿\u0026#34;); List\u0026lt;CouponTemplate\u0026gt; templates = couponTemplateService.getAvailableTemplates(); return Result.success(templates); } @PostMapping(\u0026#34;/claim\u0026#34;) @ApiOperation(\u0026#34;é¢†å–ä¼˜æƒ åˆ¸\u0026#34;) public Result\u0026lt;String\u0026gt; claimCoupon(@RequestParam Long templateId, @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸ï¼štemplateId={}, userId={}\u0026#34;, templateId, userId); String result = couponService.claimCoupon(templateId, userId); return Result.success(result); } @GetMapping(\u0026#34;/my\u0026#34;) @ApiOperation(\u0026#34;è·å–æˆ‘çš„ä¼˜æƒ åˆ¸\u0026#34;) public Result\u0026lt;List\u0026lt;Coupon\u0026gt;\u0026gt; getMyCoupons(@RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;è·å–ç”¨æˆ·ä¼˜æƒ åˆ¸ï¼šuserId={}\u0026#34;, userId); List\u0026lt;Coupon\u0026gt; coupons = couponService.getUserCoupons(userId); return Result.success(coupons); } } 3. å¥åº·æ£€æŸ¥æ§åˆ¶å™¨ åˆ›å»º sky-server/src/main/java/com/sky/controller/HealthController.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package com.sky.controller; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import java.util.HashMap; import java.util.Map; /** * å¥åº·æ£€æŸ¥æ§åˆ¶å™¨ */ @RestController @RequestMapping(\u0026#34;/health\u0026#34;) public class HealthController { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @GetMapping(\u0026#34;/check\u0026#34;) public Map\u0026lt;String, Object\u0026gt; healthCheck() { Map\u0026lt;String, Object\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); // æ£€æŸ¥Redisè¿æ¥ try { redisTemplate.opsForValue().get(\u0026#34;health:check\u0026#34;); result.put(\u0026#34;redis\u0026#34;, \u0026#34;UP\u0026#34;); } catch (Exception e) { result.put(\u0026#34;redis\u0026#34;, \u0026#34;DOWN\u0026#34;); } result.put(\u0026#34;status\u0026#34;, \u0026#34;UP\u0026#34;); result.put(\u0026#34;timestamp\u0026#34;, System.currentTimeMillis()); return result; } } é…ç½®æ–‡ä»¶å®Œå–„ 1. æ›´æ–°application.yml ä¿®æ”¹ sky-server/src/main/resources/application.ymlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 server: port: 8084 spring: application: name: sky-server # æ•°æ®åº“é…ç½® datasource: druid: driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3306/pet-cafe-shop?useUnicode=true\u0026amp;characterEncoding=utf-8\u0026amp;useSSL=false\u0026amp;serverTimezone=GMT%2B8 username: root password: 123456 # Redisé…ç½® redis: host: localhost port: 6379 password: database: 0 timeout: 5000ms lettuce: pool: max-active: 8 max-wait: -1ms max-idle: 8 min-idle: 0 # RabbitMQé…ç½® rabbitmq: host: localhost port: 5672 username: guest password: guest virtual-host: / connection-timeout: 15000 publisher-confirm-type: correlated publisher-returns: true listener: simple: acknowledge-mode: manual retry: enabled: true max-attempts: 3 initial-interval: 1000 max-interval: 10000 multiplier: 2 # MyBatisé…ç½® mybatis: mapper-locations: classpath:mapper/*.xml type-aliases-package: com.sky.entity configuration: map-underscore-to-camel-case: true log-impl: org.apache.ibatis.logging.stdout.StdOutImpl # æ—¥å¿—é…ç½® logging: level: com.sky: debug org.springframework.amqp: debug pattern: console: \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34; file: \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34; file: name: logs/sky-server.log max-size: 100MB max-history: 30 2. åˆ›å»ºRedissoné…ç½® åˆ›å»º sky-server/src/main/java/com/sky/config/RedissonConfig.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package com.sky.config; import org.redisson.Redisson; import org.redisson.api.RedissonClient; import org.redisson.config.Config; import org.springframework.beans.factory.annotation.Value; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; /** * Redissoné…ç½® */ @Configuration public class RedissonConfig { @Value(\u0026#34;${spring.redis.host}\u0026#34;) private String host; @Value(\u0026#34;${spring.redis.port}\u0026#34;) private int port; @Value(\u0026#34;${spring.redis.password:}\u0026#34;) private String password; @Value(\u0026#34;${spring.redis.database:0}\u0026#34;) private int database; @Bean public RedissonClient redissonClient() { Config config = new Config(); String address = \u0026#34;redis://\u0026#34; + host + \u0026#34;:\u0026#34; + port; config.useSingleServer() .setAddress(address) .setPassword(password.isEmpty() ? null : password) .setDatabase(database) .setConnectionPoolSize(64) .setConnectionMinimumIdleSize(10) .setIdleConnectionTimeout(10000) .setConnectTimeout(10000) .setTimeout(3000) .setRetryAttempts(3) .setRetryInterval(1500); return Redisson.create(config); } } éƒ¨ç½²å’Œæµ‹è¯• 1. å¯åŠ¨é¡ºåº å¯åŠ¨åŸºç¡€æœåŠ¡ï¼š\n1 2 3 4 5 6 7 8 # å¯åŠ¨MySQL docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:8.0 # å¯åŠ¨Redis docker run -d --name redis -p 6379:6379 redis:6.2-alpine # å¯åŠ¨RabbitMQ docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.9-management-alpine å¯¼å…¥æ•°æ®åº“ï¼š\n1 mysql -u root -p123456 pet-cafe-shop \u0026lt; script3.sql å¯åŠ¨åç«¯æœåŠ¡ï¼š\n1 2 cd sky-server mvn spring-boot:run 2. æµ‹è¯•æ¥å£ æµ‹è¯•ç§’æ€æ´»åŠ¨æ¥å£ï¼š\n1 2 3 4 5 6 # è·å–å½“å‰ç§’æ€æ´»åŠ¨ curl -X GET \u0026#34;http://localhost:8084/user/seckill/activity/current\u0026#34; # å‚ä¸ç§’æ€æ´»åŠ¨ curl -X POST \u0026#34;http://localhost:8084/user/seckill/activity/participate/1?quantity=1\u0026#34; \\ -H \u0026#34;userId: 1\u0026#34; æµ‹è¯•ä¼˜æƒ åˆ¸æ¥å£ï¼š\n1 2 3 4 5 6 # è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸ curl -X GET \u0026#34;http://localhost:8084/user/coupon/templates/available\u0026#34; # é¢†å–ä¼˜æƒ åˆ¸ curl -X POST \u0026#34;http://localhost:8084/user/coupon/claim?templateId=1\u0026#34; \\ -H \u0026#34;userId: 1\u0026#34; æµ‹è¯•å¥åº·æ£€æŸ¥ï¼š\n1 2 # å¥åº·æ£€æŸ¥ curl -X GET \u0026#34;http://localhost:8084/health/check\u0026#34; 3. æ¶ˆæ¯é˜Ÿåˆ—æµ‹è¯• è®¿é—®RabbitMQç®¡ç†ç•Œé¢ï¼š\nåœ°å€ï¼šhttp://localhost:15672 ç”¨æˆ·åï¼šguest å¯†ç ï¼šguest åœ¨ç®¡ç†ç•Œé¢ä¸­å¯ä»¥æŸ¥çœ‹ï¼š\né˜Ÿåˆ—çŠ¶æ€ æ¶ˆæ¯æ•°é‡ æ¶ˆè´¹è€…è¿æ¥ æ¶ˆæ¯è·¯ç”±æƒ…å†µ æ ¸å¿ƒç‰¹æ€§æ€»ç»“ 1. æ¶ˆæ¯é˜Ÿåˆ—ç‰¹æ€§ å¯é æ€§ï¼šæ¶ˆæ¯æŒä¹…åŒ–ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤± è§£è€¦æ€§ï¼šæ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡å®Œå…¨è§£è€¦ å¼‚æ­¥æ€§ï¼šæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ å‰Šå³°å¡«è°·ï¼šåº”å¯¹é«˜å¹¶å‘åœºæ™¯ 2. APIæ¥å£ç‰¹æ€§ RESTfulè®¾è®¡ï¼šç¬¦åˆRESTè§„èŒƒ ç»Ÿä¸€å“åº”æ ¼å¼ï¼šä½¿ç”¨Resultç»Ÿä¸€å°è£… Swaggeræ–‡æ¡£ï¼šè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ å¥åº·æ£€æŸ¥ï¼šç³»ç»ŸçŠ¶æ€ç›‘æ§ 3. é…ç½®ç®¡ç† ç¯å¢ƒéš”ç¦»ï¼šæ”¯æŒå¤šç¯å¢ƒé…ç½® å¤–éƒ¨åŒ–é…ç½®ï¼šé…ç½®ä¸ä»£ç åˆ†ç¦» çƒ­æ›´æ–°ï¼šæ”¯æŒé…ç½®åŠ¨æ€æ›´æ–° æ€»ç»“ ç¬¬ä¸‰éƒ¨åˆ†å®Œæˆäº†æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„å’ŒAPIæ¥å£çš„å¼€å‘ï¼ŒåŒ…æ‹¬ï¼š\nâœ… RabbitMQé…ç½® - å®Œæ•´çš„æ¶ˆæ¯é˜Ÿåˆ—é…ç½® âœ… æ¶ˆæ¯å®ä½“è®¾è®¡ - è®¢å•æ”¯ä»˜ã€ç§¯åˆ†è·å¾—ã€è®¢å•è¶…æ—¶æ¶ˆæ¯ âœ… ç”Ÿäº§è€…æ¶ˆè´¹è€… - æ¶ˆæ¯å‘é€å’Œæ¥æ”¶å¤„ç† âœ… APIæ¥å£å¼€å‘ - ç”¨æˆ·ç«¯ç§’æ€å’Œä¼˜æƒ åˆ¸æ¥å£ âœ… é…ç½®æ–‡ä»¶å®Œå–„ - å®Œæ•´çš„åº”ç”¨é…ç½® âœ… éƒ¨ç½²æµ‹è¯• - å¯åŠ¨å’Œæµ‹è¯•æ–¹æ¡ˆ\næ•´ä¸ªåç«¯æ”¹é€ æŒ‡å—çš„ä¸‰ä¸ªéƒ¨åˆ†å·²ç»å®Œæˆï¼Œæ¶µç›–äº†ä»æ•°æ®åº“è®¾è®¡åˆ°APIæ¥å£çš„å®Œæ•´å¼€å‘æµç¨‹ã€‚ä½ å¯ä»¥æŒ‰ç…§è¿™ä¸ªæŒ‡å—é€æ­¥å®ç°ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼ç§’æ€ç³»ç»Ÿã€‚\nç›¸å…³é˜…è¯»ï¼š\nHashå’–å•¡åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡ Hashå’–å•¡åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç° ","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8Capi%E6%8E%A5%E5%8F%A3/","title":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£"},{"content":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç° ç›®å½• å®ä½“ç±»è®¾è®¡ DTOç±»åˆ›å»º Mapperæ¥å£å®ç° åˆ†å¸ƒå¼é”æœåŠ¡ Luaè„šæœ¬å®ç° æœåŠ¡å±‚å¢å¼º å®ä½“ç±»è®¾è®¡ 1. ç§’æ€å‚ä¸è®°å½•å®ä½“ åˆ›å»º sky-pojo/src/main/java/com/sky/entity/SeckillParticipant.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; /** * ç§’æ€å‚ä¸è®°å½•è¡¨ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillParticipant implements Serializable { private static final long serialVersionUID = 1L; /** * ä¸»é”®ID */ private Long id; /** * ç§’æ€æ´»åŠ¨ID */ private Long activityId; /** * ç”¨æˆ·ID */ private Long userId; /** * å‚ä¸æ•°é‡ */ private Integer quantity; /** * çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-æˆåŠŸï¼Œ2-å¤±è´¥ */ private Integer status; /** * åˆ›å»ºæ—¶é—´ */ private LocalDateTime createTime; /** * æ›´æ–°æ—¶é—´ */ private LocalDateTime updateTime; } 2. ç§’æ€è®¢å•å®ä½“ åˆ›å»º sky-pojo/src/main/java/com/sky/entity/SeckillOrder.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.math.BigDecimal; import java.time.LocalDateTime; /** * ç§’æ€è®¢å•è¡¨ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillOrder implements Serializable { private static final long serialVersionUID = 1L; /** * ä¸»é”®ID */ private Long id; /** * ç§’æ€æ´»åŠ¨ID */ private Long activityId; /** * ç”¨æˆ·ID */ private Long userId; /** * å•†å“ID */ private Long dishId; /** * è´­ä¹°æ•°é‡ */ private Integer quantity; /** * ç§’æ€ä»·æ ¼ */ private BigDecimal seckillPrice; /** * æ€»é‡‘é¢ */ private BigDecimal totalAmount; /** * è®¢å•çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æ”¯ä»˜ï¼Œ2-å·²å–æ¶ˆ */ private Integer status; /** * åˆ›å»ºæ—¶é—´ */ private LocalDateTime createTime; /** * æ›´æ–°æ—¶é—´ */ private LocalDateTime updateTime; } 3. åº“å­˜æ‰£å‡è®°å½•å®ä½“ åˆ›å»º sky-pojo/src/main/java/com/sky/entity/SeckillStockLog.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; /** * åº“å­˜æ‰£å‡è®°å½•è¡¨ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class SeckillStockLog implements Serializable { private static final long serialVersionUID = 1L; /** * ä¸»é”®ID */ private Long id; /** * ç§’æ€æ´»åŠ¨ID */ private Long activityId; /** * ç”¨æˆ·ID */ private Long userId; /** * æ‰£å‡æ•°é‡ */ private Integer quantity; /** * æ‰£å‡å‰åº“å­˜ */ private Integer beforeStock; /** * æ‰£å‡ååº“å­˜ */ private Integer afterStock; /** * çŠ¶æ€ï¼š1-æˆåŠŸï¼Œ0-å¤±è´¥ */ private Integer status; /** * åˆ›å»ºæ—¶é—´ */ private LocalDateTime createTime; } DTOç±»åˆ›å»º 1. ç§’æ€å‚ä¸DTO åˆ›å»º sky-pojo/src/main/java/com/sky/dto/SeckillParticipateDTO.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package com.sky.dto; import lombok.Data; import java.io.Serializable; /** * ç§’æ€å‚ä¸DTO */ @Data public class SeckillParticipateDTO implements Serializable { private static final long serialVersionUID = 1L; /** * æ´»åŠ¨ID */ private Long activityId; /** * ç”¨æˆ·ID */ private Long userId; /** * å‚ä¸æ•°é‡ */ private Integer quantity; } 2. ç§’æ€è®¢å•DTO åˆ›å»º sky-pojo/src/main/java/com/sky/dto/SeckillOrderDTO.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 package com.sky.dto; import lombok.Data; import java.io.Serializable; import java.math.BigDecimal; /** * ç§’æ€è®¢å•DTO */ @Data public class SeckillOrderDTO implements Serializable { private static final long serialVersionUID = 1L; /** * æ´»åŠ¨ID */ private Long activityId; /** * ç”¨æˆ·ID */ private Long userId; /** * å•†å“ID */ private Long dishId; /** * è´­ä¹°æ•°é‡ */ private Integer quantity; /** * ç§’æ€ä»·æ ¼ */ private BigDecimal seckillPrice; /** * æ€»é‡‘é¢ */ private BigDecimal totalAmount; } Mapperæ¥å£å®ç° 1. ç§’æ€å‚ä¸è®°å½•Mapper åˆ›å»º sky-server/src/main/java/com/sky/mapper/SeckillParticipantMapper.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package com.sky.mapper; import com.sky.annotation.AutoFill; import com.sky.entity.SeckillParticipant; import com.sky.enumeration.OperationType; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; @Mapper public interface SeckillParticipantMapper { /** * æ’å…¥ç§’æ€å‚ä¸è®°å½• */ @AutoFill(value = OperationType.INSERT) void insert(SeckillParticipant participant); /** * æ ¹æ®ç”¨æˆ·å’Œæ´»åŠ¨æŸ¥è¯¢å‚ä¸è®°å½• */ SeckillParticipant getByUserAndActivity(@Param(\u0026#34;userId\u0026#34;) Long userId, @Param(\u0026#34;activityId\u0026#34;) Long activityId); /** * æ›´æ–°å‚ä¸çŠ¶æ€ */ @AutoFill(value = OperationType.UPDATE) void updateStatus(@Param(\u0026#34;id\u0026#34;) Long id, @Param(\u0026#34;status\u0026#34;) Integer status); /** * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å‚ä¸ */ int checkUserParticipated(@Param(\u0026#34;userId\u0026#34;) Long userId, @Param(\u0026#34;activityId\u0026#34;) Long activityId); } 2. ç§’æ€è®¢å•Mapper åˆ›å»º sky-server/src/main/java/com/sky/mapper/SeckillOrderMapper.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package com.sky.mapper; import com.sky.annotation.AutoFill; import com.sky.entity.SeckillOrder; import com.sky.enumeration.OperationType; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; import java.util.List; @Mapper public interface SeckillOrderMapper { /** * æ’å…¥ç§’æ€è®¢å• */ @AutoFill(value = OperationType.INSERT) void insert(SeckillOrder order); /** * æ ¹æ®IDæŸ¥è¯¢è®¢å• */ SeckillOrder getById(@Param(\u0026#34;id\u0026#34;) Long id); /** * æ›´æ–°è®¢å•çŠ¶æ€ */ @AutoFill(value = OperationType.UPDATE) void updateStatus(@Param(\u0026#34;id\u0026#34;) Long id, @Param(\u0026#34;status\u0026#34;) Integer status); /** * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ */ List\u0026lt;SeckillOrder\u0026gt; getByUserId(@Param(\u0026#34;userId\u0026#34;) Long userId); /** * æ ¹æ®æ´»åŠ¨IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ */ List\u0026lt;SeckillOrder\u0026gt; getByActivityId(@Param(\u0026#34;activityId\u0026#34;) Long activityId); } 3. åº“å­˜æ‰£å‡è®°å½•Mapper åˆ›å»º sky-server/src/main/java/com/sky/mapper/SeckillStockLogMapper.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package com.sky.mapper; import com.sky.annotation.AutoFill; import com.sky.entity.SeckillStockLog; import com.sky.enumeration.OperationType; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; import java.util.List; @Mapper public interface SeckillStockLogMapper { /** * æ’å…¥åº“å­˜æ‰£å‡è®°å½• */ @AutoFill(value = OperationType.INSERT) void insert(SeckillStockLog stockLog); /** * æ ¹æ®æ´»åŠ¨IDæŸ¥è¯¢åº“å­˜è®°å½• */ List\u0026lt;SeckillStockLog\u0026gt; getByActivityId(@Param(\u0026#34;activityId\u0026#34;) Long activityId); /** * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢åº“å­˜è®°å½• */ List\u0026lt;SeckillStockLog\u0026gt; getByUserId(@Param(\u0026#34;userId\u0026#34;) Long userId); } 4. Mapper XMLæ–‡ä»¶ åˆ›å»º sky-server/src/main/resources/mapper/SeckillParticipantMapper.xmlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;!DOCTYPE mapper PUBLIC \u0026#34;-//mybatis.org//DTD Mapper 3.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd\u0026#34; \u0026gt; \u0026lt;mapper namespace=\u0026#34;com.sky.mapper.SeckillParticipantMapper\u0026#34;\u0026gt; \u0026lt;insert id=\u0026#34;insert\u0026#34; useGeneratedKeys=\u0026#34;true\u0026#34; keyProperty=\u0026#34;id\u0026#34;\u0026gt; INSERT INTO seckill_participant (activity_id, user_id, quantity, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{quantity}, #{status}, #{createTime}, #{updateTime}) \u0026lt;/insert\u0026gt; \u0026lt;select id=\u0026#34;getByUserAndActivity\u0026#34; resultType=\u0026#34;com.sky.entity.SeckillParticipant\u0026#34;\u0026gt; SELECT * FROM seckill_participant WHERE user_id = #{userId} AND activity_id = #{activityId} \u0026lt;/select\u0026gt; \u0026lt;update id=\u0026#34;updateStatus\u0026#34;\u0026gt; UPDATE seckill_participant SET status = #{status}, update_time = NOW() WHERE id = #{id} \u0026lt;/update\u0026gt; \u0026lt;select id=\u0026#34;checkUserParticipated\u0026#34; resultType=\u0026#34;int\u0026#34;\u0026gt; SELECT COUNT(*) FROM seckill_participant WHERE user_id = #{userId} AND activity_id = #{activityId} \u0026lt;/select\u0026gt; \u0026lt;/mapper\u0026gt; åˆ›å»º sky-server/src/main/resources/mapper/SeckillOrderMapper.xmlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;!DOCTYPE mapper PUBLIC \u0026#34;-//mybatis.org//DTD Mapper 3.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd\u0026#34; \u0026gt; \u0026lt;mapper namespace=\u0026#34;com.sky.mapper.SeckillOrderMapper\u0026#34;\u0026gt; \u0026lt;insert id=\u0026#34;insert\u0026#34; useGeneratedKeys=\u0026#34;true\u0026#34; keyProperty=\u0026#34;id\u0026#34;\u0026gt; INSERT INTO seckill_order (activity_id, user_id, dish_id, quantity, seckill_price, total_amount, status, create_time, update_time) VALUES (#{activityId}, #{userId}, #{dishId}, #{quantity}, #{seckillPrice}, #{totalAmount}, #{status}, #{createTime}, #{updateTime}) \u0026lt;/insert\u0026gt; \u0026lt;select id=\u0026#34;getById\u0026#34; resultType=\u0026#34;com.sky.entity.SeckillOrder\u0026#34;\u0026gt; SELECT * FROM seckill_order WHERE id = #{id} \u0026lt;/select\u0026gt; \u0026lt;update id=\u0026#34;updateStatus\u0026#34;\u0026gt; UPDATE seckill_order SET status = #{status}, update_time = NOW() WHERE id = #{id} \u0026lt;/update\u0026gt; \u0026lt;select id=\u0026#34;getByUserId\u0026#34; resultType=\u0026#34;com.sky.entity.SeckillOrder\u0026#34;\u0026gt; SELECT * FROM seckill_order WHERE user_id = #{userId} ORDER BY create_time DESC \u0026lt;/select\u0026gt; \u0026lt;select id=\u0026#34;getByActivityId\u0026#34; resultType=\u0026#34;com.sky.entity.SeckillOrder\u0026#34;\u0026gt; SELECT * FROM seckill_order WHERE activity_id = #{activityId} ORDER BY create_time DESC \u0026lt;/select\u0026gt; \u0026lt;/mapper\u0026gt; åˆ›å»º sky-server/src/main/resources/mapper/SeckillStockLogMapper.xmlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;!DOCTYPE mapper PUBLIC \u0026#34;-//mybatis.org//DTD Mapper 3.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd\u0026#34; \u0026gt; \u0026lt;mapper namespace=\u0026#34;com.sky.mapper.SeckillStockLogMapper\u0026#34;\u0026gt; \u0026lt;insert id=\u0026#34;insert\u0026#34; useGeneratedKeys=\u0026#34;true\u0026#34; keyProperty=\u0026#34;id\u0026#34;\u0026gt; INSERT INTO seckill_stock_log (activity_id, user_id, quantity, before_stock, after_stock, status, create_time) VALUES (#{activityId}, #{userId}, #{quantity}, #{beforeStock}, #{afterStock}, #{status}, #{createTime}) \u0026lt;/insert\u0026gt; \u0026lt;select id=\u0026#34;getByActivityId\u0026#34; resultType=\u0026#34;com.sky.entity.SeckillStockLog\u0026#34;\u0026gt; SELECT * FROM seckill_stock_log WHERE activity_id = #{activityId} ORDER BY create_time DESC \u0026lt;/select\u0026gt; \u0026lt;select id=\u0026#34;getByUserId\u0026#34; resultType=\u0026#34;com.sky.entity.SeckillStockLog\u0026#34;\u0026gt; SELECT * FROM seckill_stock_log WHERE user_id = #{userId} ORDER BY create_time DESC \u0026lt;/select\u0026gt; \u0026lt;/mapper\u0026gt; åˆ†å¸ƒå¼é”æœåŠ¡ 1. æ·»åŠ é¡¹ç›®ä¾èµ– ä¿®æ”¹ sky-server/pom.xmlï¼š\n1 2 3 4 5 6 7 8 \u0026lt;!-- åœ¨ç°æœ‰ä¾èµ–åæ·»åŠ ä»¥ä¸‹å†…å®¹ --\u0026gt; \u0026lt;!-- Redisson åˆ†å¸ƒå¼é” --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.redisson\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;redisson-spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.17.7\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; 2. åˆ›å»ºåˆ†å¸ƒå¼é”æœåŠ¡ åˆ›å»º sky-server/src/main/java/com/sky/service/DistributedLockService.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 package com.sky.service; import lombok.extern.slf4j.Slf4j; import org.redisson.api.RLock; import org.redisson.api.RedissonClient; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Value; import org.springframework.core.io.ClassPathResource; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.data.redis.core.script.DefaultRedisScript; import org.springframework.scripting.support.ResourceScriptSource; import org.springframework.stereotype.Service; import java.util.Arrays; import java.util.List; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.TimeUnit; import java.util.function.Supplier; /** * åˆ†å¸ƒå¼é”æœåŠ¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ */ @Slf4j @Service public class DistributedLockService { @Autowired private RedissonClient redissonClient; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Value(\u0026#34;${sky.redis.seckill.prefix:seckill:}\u0026#34;) private String seckillPrefix; // é”ç¼“å­˜ï¼Œé¿å…é‡å¤è·å–é”å¯¹è±¡ private final ConcurrentHashMap\u0026lt;String, RLock\u0026gt; lockCache = new ConcurrentHashMap\u0026lt;\u0026gt;(); // ç§’æ€å‚ä¸è„šæœ¬ private final DefaultRedisScript\u0026lt;List\u0026gt; seckillParticipateScript; public DistributedLockService() { // åˆå§‹åŒ–ç§’æ€å‚ä¸è„šæœ¬ this.seckillParticipateScript = new DefaultRedisScript\u0026lt;\u0026gt;(); this.seckillParticipateScript.setScriptSource( new ResourceScriptSource(new ClassPathResource(\u0026#34;scripts/seckill_participate.lua\u0026#34;)) ); this.seckillParticipateScript.setResultType(List.class); } /** * è·å–é”å¯¹è±¡ï¼ˆå¸¦ç¼“å­˜ï¼‰ */ private RLock getLock(String lockKey) { return lockCache.computeIfAbsent(lockKey, key -\u0026gt; redissonClient.getLock(key)); } /** * ç§’æ€å‚ä¸ */ public List\u0026lt;Object\u0026gt; seckillParticipate(Long activityId, Long userId, Integer quantity, Integer perUserLimit) { String stockKey = seckillPrefix + \u0026#34;stock:\u0026#34; + activityId; String participantsKey = seckillPrefix + \u0026#34;participants:\u0026#34; + activityId; List\u0026lt;String\u0026gt; keys = Arrays.asList(stockKey, participantsKey); Object[] args = {userId.toString(), quantity.toString(), perUserLimit.toString()}; return redisTemplate.execute(seckillParticipateScript, keys, args); } /** * å°è¯•è·å–é”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ */ public boolean tryLock(String lockKey, long waitTime, long leaseTime, TimeUnit unit) { RLock lock = getLock(lockKey); try { return lock.tryLock(waitTime, leaseTime, unit); } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;è·å–é”è¢«ä¸­æ–­\u0026#34;, e); } } /** * é‡Šæ”¾é”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ */ public void unlock(String lockKey) { RLock lock = getLock(lockKey); try { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } catch (Exception e) { log.warn(\u0026#34;é‡Šæ”¾é”å¤±è´¥: {}\u0026#34;, lockKey, e); } } /** * æ‰§è¡Œå¸¦é”çš„æ“ä½œï¼ˆæ¨èä½¿ç”¨ï¼‰ */ public \u0026lt;T\u0026gt; T executeWithLock(String lockKey, long waitTime, long leaseTime, TimeUnit unit, Supplier\u0026lt;T\u0026gt; supplier) { RLock lock = getLock(lockKey); try { if (lock.tryLock(waitTime, leaseTime, unit)) { return supplier.get(); } else { throw new RuntimeException(\u0026#34;è·å–é”å¤±è´¥: \u0026#34; + lockKey); } } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;è·å–é”è¢«ä¸­æ–­: \u0026#34; + lockKey, e); } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } /** * æ£€æŸ¥é”çŠ¶æ€ */ public boolean isLocked(String lockKey) { RLock lock = getLock(lockKey); return lock.isLocked(); } /** * è·å–é”å‰©ä½™æ—¶é—´ */ public long getLockRemainingTime(String lockKey) { RLock lock = getLock(lockKey); return lock.remainTimeToLive(); } } Luaè„šæœ¬å®ç° 1. ç§’æ€å‚ä¸Luaè„šæœ¬ åˆ›å»º sky-server/src/main/resources/scripts/seckill_participate.luaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 -- ç§’æ€å‚ä¸Luaè„šæœ¬ -- KEYS[1] = seckill:stock:{activityId} -- KEYS[2] = seckill:participants:{activityId} -- ARGV[1] = userId -- ARGV[2] = quantity -- ARGV[3] = perUserLimit -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å‚ä¸ local isParticipated = redis.call(\u0026#39;SISMEMBER\u0026#39;, KEYS[2], ARGV[1]) if isParticipated == 1 then return {0, \u0026#39;ç”¨æˆ·å·²å‚ä¸è¯¥æ´»åŠ¨\u0026#39;} end -- æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ local stock = redis.call(\u0026#39;GET\u0026#39;, KEYS[1]) if not stock then return {0, \u0026#39;æ´»åŠ¨ä¸å­˜åœ¨\u0026#39;} end stock = tonumber(stock) local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) if stock \u0026lt; quantity then return {0, \u0026#39;åº“å­˜ä¸è¶³\u0026#39;} end if quantity \u0026gt; perUserLimit then return {0, \u0026#39;è¶…è¿‡é™è´­æ•°é‡\u0026#39;} end -- æ‰£å‡åº“å­˜ local newStock = redis.call(\u0026#39;DECRBY\u0026#39;, KEYS[1], quantity) if newStock \u0026lt; 0 then -- å›æ»šåº“å­˜ redis.call(\u0026#39;INCRBY\u0026#39;, KEYS[1], quantity) return {0, \u0026#39;åº“å­˜ä¸è¶³\u0026#39;} end -- è®°å½•ç”¨æˆ·å‚ä¸ redis.call(\u0026#39;SADD\u0026#39;, KEYS[2], ARGV[1]) -- è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ´»åŠ¨ç»“æŸåæ¸…ç†ï¼‰ redis.call(\u0026#39;EXPIRE\u0026#39;, KEYS[2], 86400) return {1, \u0026#39;å‚ä¸æˆåŠŸ\u0026#39;, newStock} 2. Luaè„šæœ¬åŸç†è§£æ ä¸ºä»€ä¹ˆä½¿ç”¨Luaè„šæœ¬ï¼Ÿ\nåŸå­æ€§ï¼šLuaè„šæœ¬åœ¨Redisä¸­æ‰§è¡Œæ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­ æ€§èƒ½ï¼šå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ ä¸€è‡´æ€§ï¼šä¿è¯å¤šä¸ªRedisæ“ä½œçš„åŸå­æ€§ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ è„šæœ¬æ‰§è¡Œæµç¨‹ï¼š\næ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å‚ä¸ï¼ˆä½¿ç”¨Seté›†åˆï¼‰ éªŒè¯åº“å­˜æ˜¯å¦å……è¶³ æ£€æŸ¥è´­ä¹°æ•°é‡æ˜¯å¦è¶…è¿‡é™è´­ åŸå­æ€§æ‰£å‡åº“å­˜ è®°å½•ç”¨æˆ·å‚ä¸ä¿¡æ¯ è®¾ç½®è¿‡æœŸæ—¶é—´ æœåŠ¡å±‚å¢å¼º 1. å¢å¼ºSeckillActivityService ä¿®æ”¹ sky-server/src/main/java/com/sky/service/impl/SeckillActivityServiceImpl.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 package com.sky.service.impl; import com.github.pagehelper.Page; import com.sky.dto.SeckillActivityDTO; import com.sky.dto.SeckillActivityPageQueryDTO; import com.sky.entity.SeckillActivity; import com.sky.entity.SeckillOrder; import com.sky.entity.SeckillParticipant; import com.sky.entity.SeckillStockLog; import com.sky.mapper.SeckillActivityMapper; import com.sky.mapper.SeckillOrderMapper; import com.sky.mapper.SeckillParticipantMapper; import com.sky.mapper.SeckillStockLogMapper; import com.sky.service.DistributedLockService; import com.sky.service.SeckillActivityService; import com.sky.vo.SeckillStatisticsVO; import lombok.extern.slf4j.Slf4j; import org.redisson.api.RLock; import org.springframework.beans.BeanUtils; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.scheduling.annotation.Async; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional; import java.math.BigDecimal; import java.time.LocalDateTime; import java.util.List; import java.util.concurrent.TimeUnit; @Service @Slf4j public class SeckillActivityServiceImpl implements SeckillActivityService { @Autowired private SeckillActivityMapper seckillActivityMapper; @Autowired private SeckillParticipantMapper seckillParticipantMapper; @Autowired private SeckillOrderMapper seckillOrderMapper; @Autowired private SeckillStockLogMapper seckillStockLogMapper; @Autowired private DistributedLockService distributedLockService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Override public Page\u0026lt;SeckillActivity\u0026gt; pageQuery(SeckillActivityPageQueryDTO seckillActivityPageQueryDTO) { return seckillActivityMapper.pageQuery(seckillActivityPageQueryDTO); } @Override public SeckillActivity getById(Long id) { return seckillActivityMapper.getById(id); } @Override @Transactional public void save(SeckillActivityDTO seckillActivityDTO) { SeckillActivity seckillActivity = new SeckillActivity(); BeanUtils.copyProperties(seckillActivityDTO, seckillActivity); seckillActivity.setSoldCount(0); seckillActivityMapper.insert(seckillActivity); // åˆå§‹åŒ–Redisåº“å­˜ String stockKey = \u0026#34;seckill:stock:\u0026#34; + seckillActivity.getId(); redisTemplate.opsForValue().set(stockKey, seckillActivity.getStock()); log.info(\u0026#34;ç§’æ€æ´»åŠ¨åˆ›å»ºæˆåŠŸï¼Œæ´»åŠ¨IDï¼š{}ï¼Œåº“å­˜ï¼š{}\u0026#34;, seckillActivity.getId(), seckillActivity.getStock()); } @Override @Transactional public void update(SeckillActivityDTO seckillActivityDTO) { SeckillActivity seckillActivity = new SeckillActivity(); BeanUtils.copyProperties(seckillActivityDTO, seckillActivity); seckillActivityMapper.update(seckillActivity); // æ›´æ–°Redisåº“å­˜ String stockKey = \u0026#34;seckill:stock:\u0026#34; + seckillActivity.getId(); redisTemplate.opsForValue().set(stockKey, seckillActivity.getStock()); } @Override public void deleteById(Long id) { seckillActivityMapper.deleteById(id); // åˆ é™¤Redisåº“å­˜ String stockKey = \u0026#34;seckill:stock:\u0026#34; + id; redisTemplate.delete(stockKey); } @Override public void updateStatus(Long id, Integer status) { seckillActivityMapper.updateStatus(id, status); } @Override public List\u0026lt;SeckillStatisticsVO\u0026gt; getStatistics(LocalDateTime startTime, LocalDateTime endTime) { return seckillActivityMapper.getStatistics(startTime, endTime); } @Override public List\u0026lt;SeckillActivity\u0026gt; getCurrentActivities() { return seckillActivityMapper.getCurrentActivities(LocalDateTime.now()); } @Override public boolean reduceStock(Long id, Integer quantity) { return seckillActivityMapper.reduceStock(id, quantity) \u0026gt; 0; } @Override public void increaseSoldCount(Long id, Integer quantity) { seckillActivityMapper.increaseSoldCount(id, quantity); } /** * å‚ä¸ç§’æ€æ´»åŠ¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ */ @Override @Transactional public String participateSeckill(Long activityId, Long userId, Integer quantity) { // 1. è·å–æ´»åŠ¨ä¿¡æ¯ SeckillActivity activity = getById(activityId); if (activity == null) { return \u0026#34;æ´»åŠ¨ä¸å­˜åœ¨\u0026#34;; } // 2. æ£€æŸ¥æ´»åŠ¨çŠ¶æ€ if (activity.getStatus() != 1) { return \u0026#34;æ´»åŠ¨å·²ç¦ç”¨\u0026#34;; } LocalDateTime now = LocalDateTime.now(); if (now.isBefore(activity.getStartTime())) { return \u0026#34;æ´»åŠ¨æœªå¼€å§‹\u0026#34;; } if (now.isAfter(activity.getEndTime())) { return \u0026#34;æ´»åŠ¨å·²ç»“æŸ\u0026#34;; } // 3. ä½¿ç”¨ä¼˜åŒ–åçš„åˆ†å¸ƒå¼é”æœåŠ¡ String lockKey = \u0026#34;seckill:lock:\u0026#34; + activityId; return distributedLockService.executeWithLock(lockKey, 10, 30, TimeUnit.SECONDS, () -\u0026gt; { // 4. æ‰§è¡Œç§’æ€å‚ä¸ List\u0026lt;Object\u0026gt; result = distributedLockService.seckillParticipate( activityId, userId, quantity, activity.getPerUserLimit() ); if (result != null \u0026amp;\u0026amp; result.size() \u0026gt; 0) { Integer success = (Integer) result.get(0); if (success == 1) { // 5. è®°å½•å‚ä¸è®°å½• SeckillParticipant participant = SeckillParticipant.builder() .activityId(activityId) .userId(userId) .quantity(quantity) .status(1) .createTime(now) .updateTime(now) .build(); seckillParticipantMapper.insert(participant); // 6. å¼‚æ­¥å¤„ç†è®¢å• processSeckillOrderAsync(activity, userId, quantity); return \u0026#34;å‚ä¸æˆåŠŸ\u0026#34;; } else { return (String) result.get(1); } } return \u0026#34;å‚ä¸å¤±è´¥\u0026#34;; }); } /** * å¼‚æ­¥å¤„ç†ç§’æ€è®¢å• */ @Async public void processSeckillOrderAsync(SeckillActivity activity, Long userId, Integer quantity) { try { // åˆ›å»ºç§’æ€è®¢å• SeckillOrder order = SeckillOrder.builder() .activityId(activity.getId()) .userId(userId) .dishId(activity.getDishId()) .quantity(quantity) .seckillPrice(activity.getSeckillPrice()) .totalAmount(activity.getSeckillPrice().multiply(new BigDecimal(quantity))) .status(0) .createTime(LocalDateTime.now()) .updateTime(LocalDateTime.now()) .build(); seckillOrderMapper.insert(order); // æ›´æ–°æ•°æ®åº“åº“å­˜ updateDatabaseStock(activity.getId(), quantity); log.info(\u0026#34;ç§’æ€è®¢å•åˆ›å»ºæˆåŠŸï¼šorderId={}, userId={}, activityId={}\u0026#34;, order.getId(), userId, activity.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç§’æ€è®¢å•å¼‚å¸¸\u0026#34;, e); } } /** * æ›´æ–°æ•°æ®åº“åº“å­˜ */ @Async public void updateDatabaseStock(Long activityId, Integer quantity) { try { // è®°å½•åº“å­˜æ‰£å‡æ—¥å¿— SeckillActivity activity = getById(activityId); SeckillStockLog stockLog = SeckillStockLog.builder() .activityId(activityId) .userId(0L) // ç³»ç»Ÿæ‰£å‡ .quantity(quantity) .beforeStock(activity.getStock()) .afterStock(activity.getStock() - quantity) .status(1) .createTime(LocalDateTime.now()) .build(); seckillStockLogMapper.insert(stockLog); // æ›´æ–°æ•°æ®åº“åº“å­˜ seckillActivityMapper.reduceStock(activityId, quantity); seckillActivityMapper.increaseSoldCount(activityId, quantity); } catch (Exception e) { log.error(\u0026#34;æ›´æ–°æ•°æ®åº“åº“å­˜å¼‚å¸¸\u0026#34;, e); } } } 2. æ›´æ–°SeckillActivityServiceæ¥å£ ä¿®æ”¹ sky-server/src/main/java/com/sky/service/SeckillActivityService.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 package com.sky.service; import com.github.pagehelper.Page; import com.sky.dto.SeckillActivityDTO; import com.sky.dto.SeckillActivityPageQueryDTO; import com.sky.entity.SeckillActivity; import com.sky.vo.SeckillStatisticsVO; import java.time.LocalDateTime; import java.util.List; public interface SeckillActivityService { /** * åˆ†é¡µæŸ¥è¯¢ç§’æ€æ´»åŠ¨ */ Page\u0026lt;SeckillActivity\u0026gt; pageQuery(SeckillActivityPageQueryDTO seckillActivityPageQueryDTO); /** * æ ¹æ®idæŸ¥è¯¢ç§’æ€æ´»åŠ¨ */ SeckillActivity getById(Long id); /** * æ–°å¢ç§’æ€æ´»åŠ¨ */ void save(SeckillActivityDTO seckillActivityDTO); /** * ä¿®æ”¹ç§’æ€æ´»åŠ¨ */ void update(SeckillActivityDTO seckillActivityDTO); /** * æ ¹æ®idåˆ é™¤ç§’æ€æ´»åŠ¨ */ void deleteById(Long id); /** * æ›´æ–°ç§’æ€æ´»åŠ¨çŠ¶æ€ */ void updateStatus(Long id, Integer status); /** * è·å–ç§’æ€æ´»åŠ¨ç»Ÿè®¡ä¿¡æ¯ */ List\u0026lt;SeckillStatisticsVO\u0026gt; getStatistics(LocalDateTime startTime, LocalDateTime endTime); /** * è·å–å½“å‰è¿›è¡Œä¸­çš„ç§’æ€æ´»åŠ¨ */ List\u0026lt;SeckillActivity\u0026gt; getCurrentActivities(); /** * æ‰£å‡ç§’æ€åº“å­˜ */ boolean reduceStock(Long id, Integer quantity); /** * å¢åŠ å·²å”®æ•°é‡ */ void increaseSoldCount(Long id, Integer quantity); /** * å‚ä¸ç§’æ€æ´»åŠ¨ */ String participateSeckill(Long activityId, Long userId, Integer quantity); } åˆ†å¸ƒå¼é”æœåŠ¡ä¼˜åŒ–è¯´æ˜ 1. ä¼˜åŒ–ç‚¹æ€»ç»“ æ€§èƒ½ä¼˜åŒ–ï¼š\né”ç¼“å­˜ï¼šä½¿ç”¨ConcurrentHashMapç¼“å­˜é”å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»º è„šæœ¬é¢„åŠ è½½ï¼šåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–Luaè„šæœ¬ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ é…ç½®åŒ–ï¼šæ”¯æŒRedisé”®å‰ç¼€é…ç½®ï¼Œæé«˜çµæ´»æ€§ ä»£ç ä¼˜åŒ–ï¼š\næ‰§è¡Œå¸¦é”æ“ä½œï¼šæä¾›executeWithLockæ–¹æ³•ï¼Œè‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œæä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ é”çŠ¶æ€ç›‘æ§ï¼šæ”¯æŒé”çŠ¶æ€æ£€æŸ¥å’Œå‰©ä½™æ—¶é—´æŸ¥è¯¢ ä½¿ç”¨ä¼˜åŒ–ï¼š\nä»£ç ç®€æ´ï¼šä¸šåŠ¡ä»£ç æ›´ç®€æ´ï¼Œé”ç®¡ç†é€»è¾‘é›†ä¸­ é¿å…æ­»é”ï¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…å¿˜è®°é‡Šæ”¾é”å¯¼è‡´çš„é—®é¢˜ æ˜“äºç»´æŠ¤ï¼šé”ç›¸å…³é€»è¾‘é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±• 2. ä½¿ç”¨ç¤ºä¾‹å¯¹æ¯” åŸå§‹æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public String participateSeckill(Long activityId, Long userId, Integer quantity) { String lockKey = \u0026#34;seckill:lock:\u0026#34; + activityId; RLock lock = redissonClient.getLock(lockKey); try { if (lock.tryLock(10, 30, TimeUnit.SECONDS)) { // ä¸šåŠ¡é€»è¾‘ return \u0026#34;å‚ä¸æˆåŠŸ\u0026#34;; } else { return \u0026#34;è·å–é”å¤±è´¥\u0026#34;; } } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } ä¼˜åŒ–åæ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 public String participateSeckill(Long activityId, Long userId, Integer quantity) { String lockKey = \u0026#34;seckill:lock:\u0026#34; + activityId; return distributedLockService.executeWithLock(lockKey, 10, 30, TimeUnit.SECONDS, () -\u0026gt; { // ä¸šåŠ¡é€»è¾‘ return \u0026#34;å‚ä¸æˆåŠŸ\u0026#34;; }); } ä¼˜åŒ–æ•ˆæœï¼š\nä»£ç è¡Œæ•°å‡å°‘50% è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ æ›´å¥½çš„å¼‚å¸¸å¤„ç† æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ æ ¸å¿ƒç‰¹æ€§æ€»ç»“ 1. é˜²è¶…å–æœºåˆ¶ Redisåˆ†å¸ƒå¼é”ï¼šé˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤å‚ä¸ Luaè„šæœ¬ï¼šä¿è¯åº“å­˜æ‰£å‡çš„åŸå­æ€§ æ•°æ®åº“é”ï¼šé˜²æ­¢æ•°æ®åº“å±‚é¢çš„å¹¶å‘é—®é¢˜ 2. æ€§èƒ½ä¼˜åŒ– Redisç¼“å­˜ï¼šç§’æ€åº“å­˜å­˜å‚¨åœ¨Redisä¸­ï¼Œæé«˜è®¿é—®é€Ÿåº¦ å¼‚æ­¥å¤„ç†ï¼šè®¢å•åˆ›å»ºå’Œåº“å­˜æ›´æ–°å¼‚æ­¥æ‰§è¡Œ æ‰¹é‡æ“ä½œï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•° 3. æ•°æ®ä¸€è‡´æ€§ äº‹åŠ¡ç®¡ç†ï¼šå…³é”®æ“ä½œä½¿ç”¨@Transactionalä¿è¯ä¸€è‡´æ€§ è¡¥å¿æœºåˆ¶ï¼šå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šRedisåº“å­˜ æ—¥å¿—è®°å½•ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥ ç»§ç»­é˜…è¯»ï¼šHashå’–å•¡åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/","title":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°"}]