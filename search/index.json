[{"content":"Redisson å¯é‡å…¥é”åŸç†è¯¦è§£ 1. ä¸ºä»€ä¹ˆéœ€è¦å¯é‡å…¥é”ï¼Ÿ åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œé” æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„é‡è¦æ‰‹æ®µã€‚ä½†æœ‰æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶ï¼Œä¼šè°ƒç”¨å¦ä¸€ä¸ªä¹Ÿéœ€è¦åŒä¸€æŠŠé”çš„æ–¹æ³•ï¼Œè¿™æ—¶é—®é¢˜å°±æ¥äº†ï¼š\nå¦‚æœé” ä¸å¯é‡å…¥ï¼Œçº¿ç¨‹åœ¨ç¬¬äºŒæ¬¡å°è¯•åŠ é”æ—¶ä¼šå¤±è´¥ï¼Œå› ä¸ºé”å·²ç»å­˜åœ¨ï¼Œå®ƒç›¸å½“äº æŠŠè‡ªå·±å¡æ­»äº†ã€‚ å¦‚æœé” å¯é‡å…¥ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–è¿™æŠŠé”ï¼Œç›´åˆ°æœ€åé‡Šæ”¾æ—¶æ‰çœŸæ­£è§£é”ã€‚ æ‰€ä»¥ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºï¼šé¿å…åŒä¸€çº¿ç¨‹å› ä¸ºæ–¹æ³•åµŒå¥—è°ƒç”¨è€Œæ­»é”ã€‚\n2. æ™®é€šåˆ†å¸ƒå¼é”çš„é—®é¢˜ æœ€ç®€å•çš„åˆ†å¸ƒå¼é”é€šå¸¸ç”¨ Redis çš„ SETNX å®ç°ï¼š\n1 SET key value NX EX 30 NX è¡¨ç¤ºå¦‚æœ key ä¸å­˜åœ¨æ‰è®¾ç½®ï¼Œä¿è¯åŸå­æ€§ã€‚ EX 30 è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ã€‚ é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ å½“ä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰é”æ—¶ï¼Œå¦‚æœåœ¨æ–¹æ³•åµŒå¥—ä¸­å†æ¬¡å°è¯•è·å–é”ï¼š\nRedis å‘ç° key å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›å¤±è´¥ã€‚ è™½ç„¶æ˜¯ åŒä¸€ä¸ªçº¿ç¨‹ æƒ³å†æ¬¡è·å–é”ï¼Œä½†å› ä¸ºé”å®ç°é‡ŒåªåŒºåˆ† \u0026ldquo;æœ‰é” / æ— é”\u0026rdquo;ï¼Œå¹¶ä¸ä¼šè¯†åˆ«çº¿ç¨‹ã€‚ ç»“æœå°±æ˜¯ï¼šè‡ªå·±æŠŠè‡ªå·±é”æ­»äº†ã€‚ 3. Redisson çš„æ”¹è¿›ï¼ˆå¯é‡å…¥å®ç°ï¼‰ Redisson åœ¨ value çš„å­˜å‚¨ä¸Šåšäº†æ”¹è¿›ï¼Œå®ƒå¹¶ä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ª Hash ç»“æ„ï¼š\n1 2 3 lockKey -\u0026gt; { threadId : reentrantCount } threadIdï¼šå”¯ä¸€æ ‡è¯†æŸä¸ª JVM é‡Œçš„æŸä¸ªçº¿ç¨‹ï¼ˆä¸€èˆ¬æ˜¯ UUID:threadIdï¼‰ã€‚ reentrantCountï¼šè®°å½•è¿™ä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ¬¡æ•°ã€‚ è¿™æ ·å°±å¯ä»¥æ”¯æŒ å¯é‡å…¥ äº†ã€‚\n4. æ‰§è¡Œæµç¨‹ä¸¾ä¾‹ å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public void methodA() { lock.lock(); try { methodB(); } finally { lock.unlock(); } } public void methodB() { lock.lock(); try { // æ‰§è¡Œé€»è¾‘ } finally { lock.unlock(); } } 4.1 ç¬¬ä¸€æ¬¡åŠ é”ï¼ˆmethodAï¼‰ Redis é‡Œè¿˜æ²¡æœ‰ lockKeyã€‚ Redisson ä¼šå†™å…¥ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 1 } è¡¨ç¤ºçº¿ç¨‹ thread-1 ç¬¬ä¸€æ¬¡è·å–é”ï¼Œé‡å…¥æ¬¡æ•° = 1ã€‚ 4.2 ç¬¬äºŒæ¬¡åŠ é”ï¼ˆmethodBï¼‰ Redis å‘ç° lockKey å·²å­˜åœ¨ï¼Œä½† owner æ˜¯ åŒä¸€ä¸ªçº¿ç¨‹ã€‚ å…è®¸é‡å…¥ï¼Œè®¡æ•° +1ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 2 } 4.3 methodB æ‰§è¡Œå®Œé‡Šæ”¾é” è°ƒç”¨ unlock()ï¼Œè®¡æ•° -1ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 1 } é”ä»ç„¶ç”±å½“å‰çº¿ç¨‹æŒæœ‰ã€‚ 4.4 methodA æ‰§è¡Œå®Œé‡Šæ”¾é” å†æ¬¡è°ƒç”¨ unlock()ï¼Œè®¡æ•° -1 â†’ å˜æˆ 0ã€‚ Redisson åˆ é™¤ lockKeyï¼š 1 lockKey åˆ é™¤ æ­¤æ—¶é”æ‰çœŸæ­£é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šè·å–ã€‚ 5. é€šä¿—è§£é‡Š ç”¨é€šä¿—çš„è¯å†æè¿°ä¸€æ¬¡ï¼š\nå‡å¦‚ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å¤šä¸ªæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªæ–¹æ³•ç”¨äº†é”å»è°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œç¬¬äºŒä¸ªæ–¹æ³•å†æ¬¡è°ƒç”¨è¿™ä¸ªçº¿ç¨‹çš„é”å°±ä¼šå¤±è´¥ã€‚å› ä¸ºè™½ç„¶é”çš„ key ä¸€æ ·ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è·å–é”çš„æ—¶å€™ä¼šå‘ç°é”å·²ç»å­˜åœ¨äº†ï¼Œå°±è·å–å¤±è´¥ã€‚\nRedisson åœ¨è¿™ä¸ªåŸºç¡€ä¸Šåšäº†æ”¹è¿›ï¼šå®ƒåœ¨é”çš„ value é‡ŒåŠ ä¸Šäº†ä¸€ä¸ª é‡å…¥æ¬¡æ•°ï¼Œå¹¶åˆ©ç”¨ Redis Hash ç»“æ„æ¥å­˜å‚¨ã€‚\nHash ç»“æ„é‡Œæœ‰ä¸¤ä¸ªå€¼ï¼š\nfieldï¼šå½“å‰çº¿ç¨‹çš„æ ‡è¯†ï¼ˆUUID + threadIdï¼‰ valueï¼šé‡å…¥æ¬¡æ•° æ‰§è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\næ–¹æ³•ä¸€ç¬¬ä¸€æ¬¡è·å–é”ï¼šé‡å…¥æ¬¡æ•° +1ï¼Œå˜æˆ 1 æ–¹æ³•ä¸€è°ƒç”¨æ–¹æ³•äºŒï¼Œæ–¹æ³•äºŒåˆè¦ç”¨é”ï¼šé‡å…¥æ¬¡æ•°å† +1ï¼Œå˜æˆ 2 æ–¹æ³•äºŒæ‰§è¡Œå®Œé‡Šæ”¾é”ï¼šé‡å…¥æ¬¡æ•° -1ï¼Œå˜å› 1 æ–¹æ³•ä¸€æ‰§è¡Œå®Œé‡Šæ”¾é”ï¼šé‡å…¥æ¬¡æ•° -1ï¼Œå˜å› 0ï¼Œé”æ‰çœŸæ­£é‡Šæ”¾ è¿™æ ·å°±é¿å…äº†åŒä¸€ä¸ªçº¿ç¨‹å› ä¸ºåµŒå¥—è°ƒç”¨è€Œæ­»é”ã€‚\n6. æ ¸å¿ƒå®ç°åŸç† 6.1 åŠ é”æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 -- åŠ é”è„šæœ¬ if (redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) == 0) then redis.call(\u0026#39;hset\u0026#39;, KEYS[1], ARGV[2], 1); redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); return nil; end; if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[2]) == 1) then redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); return nil; end; return redis.call(\u0026#39;pttl\u0026#39;, KEYS[1]); 6.2 é‡Šæ”¾é”æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 -- é‡Šæ”¾é”è„šæœ¬ if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[3]) == 0) then return nil; end; local counter = redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[3], -1); if (counter \u0026gt; 0) then redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[2]); return 0; else redis.call(\u0026#39;del\u0026#39;, KEYS[1]); redis.call(\u0026#39;publish\u0026#39;, KEYS[2], ARGV[1]); return 1; end; 7. å…³é”®ç‰¹æ€§ 7.1 çº¿ç¨‹å®‰å…¨ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ é¿å…ç«æ€æ¡ä»¶ 7.2 è‡ªåŠ¨ç»­æœŸ é€šè¿‡ pexpire è‡ªåŠ¨ç»­æœŸ é˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ 7.3 å…¬å¹³æ€§ æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é” é€šè¿‡é˜Ÿåˆ—æœºåˆ¶ä¿è¯è·å–é”çš„é¡ºåº 7.4 å¯é‡å…¥æ€§ åŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å–é” é€šè¿‡é‡å…¥è®¡æ•°å™¨å®ç° 8. ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // è·å–å¯é‡å…¥é” RLock lock = redisson.getLock(\u0026#34;myLock\u0026#34;); try { // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…100ç§’ï¼Œä¸Šé”ä»¥å10ç§’è‡ªåŠ¨è§£é” boolean res = lock.tryLock(100, 10, TimeUnit.SECONDS); if (res) { try { // ä¸šåŠ¡é€»è¾‘ doSomething(); } finally { lock.unlock(); } } } catch (InterruptedException e) { e.printStackTrace(); } 9. æ€»ç»“å‡å æ™®é€šåˆ†å¸ƒå¼é”åªå…³å¿ƒ \u0026ldquo;æœ‰é” / æ— é”\u0026rdquo;ï¼Œä¸å…³å¿ƒæ˜¯è°åŠ çš„é”ï¼Œå¯¼è‡´ åŒä¸€çº¿ç¨‹é‡å…¥æ—¶ä¹Ÿä¼šå¤±è´¥ã€‚\nRedisson é€šè¿‡åœ¨ Redis çš„ Hash ç»“æ„ ä¸­è®°å½• \u0026ldquo;çº¿ç¨‹æ ‡è¯† + é‡å…¥è®¡æ•°\u0026rdquo;ï¼Œè®©é”å…·å¤‡äº† å¯é‡å…¥èƒ½åŠ›ã€‚\næ„ä¹‰ï¼šå¯é‡å…¥é”é¿å…äº†ä¸€ä¸ªçº¿ç¨‹åœ¨åµŒå¥—è°ƒç”¨ä¸­æŠŠè‡ªå·±å¡æ­»ï¼ŒåŒæ—¶å¯¹å¤–ä»ç„¶ä¿æŒåˆ†å¸ƒå¼é”çš„ç‰¹æ€§ã€‚\nä¸€å¥è¯æ€»ç»“ï¼š Redisson çš„å¯é‡å…¥é”ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç”¨ Redis Hash å­˜å‚¨çº¿ç¨‹ ID å’Œé‡å…¥æ¬¡æ•°ï¼Œç›´åˆ°é‡å…¥æ¬¡æ•°å½’é›¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\n10. æ‰©å±•é˜…è¯» Redisson å®˜æ–¹æ–‡æ¡£ Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ Java å¹¶å‘ç¼–ç¨‹å®æˆ˜ æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† Redisson å¯é‡å…¥é”çš„å®ç°åŸç†ï¼Œå¸®åŠ©å¼€å‘è€…æ·±å…¥ç†è§£åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæœºåˆ¶ã€‚\n","date":"2025-09-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/redisson-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/","title":"Redisson å¯é‡å…¥é”åŸç†è¯¦è§£"},{"content":"æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨ åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå°¤å…¶æ˜¯ç§’æ€ç³»ç»Ÿï¼Œå¦‚ä½•ä¿è¯åº“å­˜æ‰£å‡çš„æ­£ç¡®æ€§å’Œç”¨æˆ·é™è´­çš„å‡†ç¡®æ€§ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„é—®é¢˜ã€‚\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹ï¼Œè¯¦ç»†è®²è§£ Redis + Lua è„šæœ¬ åœ¨ç§’æ€æ´»åŠ¨ä¸­çš„ä½¿ç”¨æ–¹å¼ã€‚\nä¸€ã€èƒŒæ™¯ä»‹ç» åœ¨ç§’æ€åœºæ™¯ä¸­ï¼Œå¦‚æœå•çº¯ä¾èµ–åç«¯æ•°æ®åº“è¿›è¡Œåº“å­˜æ‰£å‡ä¸ç”¨æˆ·æ ¡éªŒï¼Œå¾€å¾€ä¼šäº§ç”Ÿä»¥ä¸‹é—®é¢˜ï¼š\né«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼šå¤§é‡ç”¨æˆ·åŒæ—¶ä¸‹å•ï¼Œæ•°æ®åº“å®¹æ˜“è¢«æ‰“çˆ†ã€‚ è¶…å–é—®é¢˜ï¼šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°åº“å­˜è¢«æ‰£æˆè´Ÿæ•°çš„æƒ…å†µã€‚ é™è´­é€»è¾‘å¤±æ•ˆï¼šå¦‚æœå¹¶å‘æ§åˆ¶ä¸å¥½ï¼ŒåŒä¸€ç”¨æˆ·å¯èƒ½ç»•è¿‡é™è´­é™åˆ¶ã€‚ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬é€šå¸¸ä¼š å°†ç§’æ€çš„æ ¸å¿ƒé€»è¾‘æ”¾åˆ° Redis é‡Œï¼Œåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½ä¸ Lua è„šæœ¬çš„åŸå­æ€§ï¼Œæ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\näºŒã€Redis Key è®¾è®¡ åœ¨è¿™ä¸ªç§’æ€ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªæ´»åŠ¨è®¾è®¡äº†ä¸¤ä¸ªå…³é”®çš„ Redis Keyï¼š\n1. åº“å­˜ Key 1 seckill:stock:{activityId} ä½œç”¨ï¼šå­˜æ”¾æŸä¸ªæ´»åŠ¨çš„å‰©ä½™åº“å­˜æ•°é‡ã€‚\nç¤ºä¾‹ï¼š\n1 SET seckill:stock:1001 50 è¡¨ç¤ºæ´»åŠ¨ 1001 è¿˜æœ‰ 50 ä»¶å•†å“ã€‚\n2. å‚ä¸ç”¨æˆ· Key 1 seckill:participants:{activityId} ä½œç”¨ï¼šå­˜æ”¾æŸä¸ªæ´»åŠ¨æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€‚\nç¤ºä¾‹ï¼š\n1 2 HSET seckill:participants:1001 12345 1 HSET seckill:participants:1001 67890 2 è¡¨ç¤ºï¼š\nç”¨æˆ· 12345 å·²ç»è´­ä¹° 1 ä»¶ ç”¨æˆ· 67890 å·²ç»è´­ä¹° 2 ä»¶ ä¸‰ã€Java ä»£ç è°ƒç”¨ Lua è„šæœ¬ åœ¨åç«¯ä¸­ï¼Œè°ƒç”¨ Lua è„šæœ¬çš„æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 String stockKey = seckillPrefix + \u0026#34;stock:\u0026#34; + activityId; String participantsKey = seckillPrefix + \u0026#34;participants:\u0026#34; + activityId; DefaultRedisScript\u0026lt;List\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptSource(new ResourceScriptSource(new ClassPathResource(\u0026#34;seckill_participate.lua\u0026#34;))); script.setResultType(List.class); List\u0026lt;String\u0026gt; keys = Arrays.asList(stockKey, participantsKey); List\u0026lt;Object\u0026gt; args = Arrays.asList( userId.toString(), quantity.toString(), activity.getPerUserLimit().toString() ); List result = redisTemplate.execute(script, keys, args.toArray()); å‚æ•°ä¼ é€’è¯´æ˜ è¿™é‡Œéœ€è¦é‡ç‚¹ç†è§£çš„æœ‰ä¸¤éƒ¨åˆ†ï¼š\nkeys â†’ ä¼ é€’ç»™ Lua çš„ Redis Keyï¼Œè„šæœ¬é‡Œç”¨ KEYS[] è®¿é—®ï¼š\nKEYS[1] = \u0026quot;seckill:stock:1001\u0026quot; ï¼ˆè¿™ä¸ªæ´»åŠ¨çš„åº“å­˜ï¼‰ KEYS[2] = \u0026quot;seckill:participants:1001\u0026quot; ï¼ˆè®°å½•äº†è¿™ä¸ªæ´»åŠ¨æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼‰ args â†’ é™„åŠ å‚æ•°ï¼Œè„šæœ¬é‡Œç”¨ ARGV[] è®¿é—®ï¼š\nARGV[1] = userId ï¼ˆå½“å‰ç”¨æˆ· IDï¼‰ ARGV[2] = quantity ï¼ˆæœ¬æ¬¡è´­ä¹°æ•°é‡ï¼‰ ARGV[3] = perUserLimit ï¼ˆæ¯äººé™è´­æ•°é‡ï¼‰ å››ã€Lua è„šæœ¬é€»è¾‘è¯¦è§£ Lua è„šæœ¬å…·æœ‰åŸå­æ€§ï¼Œåœ¨ Redis ä¸­æ‰§è¡Œæ—¶ä¸ä¼šè¢«æ‰“æ–­ï¼Œéå¸¸é€‚åˆç§’æ€åœºæ™¯ã€‚\nå…¸å‹çš„ seckill_participate.lua è„šæœ¬å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 -- è·å–å‚æ•° local stock = tonumber(redis.call(\u0026#34;GET\u0026#34;, KEYS[1])) local userId = ARGV[1] local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) -- æŸ¥è¯¢ç”¨æˆ·å·²è´­ä¹°æ•°é‡ local userBought = tonumber(redis.call(\u0026#34;HGET\u0026#34;, KEYS[2], userId) or \u0026#34;0\u0026#34;) -- 1. æ ¡éªŒæ˜¯å¦è¶…è¿‡ä¸ªäººé™è´­ if userBought + quantity \u0026gt; perUserLimit then return {0, \u0026#34;è¶…è¿‡ä¸ªäººé™è´­\u0026#34;} end -- 2. æ ¡éªŒåº“å­˜æ˜¯å¦è¶³å¤Ÿ if stock \u0026lt; quantity then return {0, \u0026#34;åº“å­˜ä¸è¶³\u0026#34;} end -- 3. æ‰£å‡åº“å­˜ redis.call(\u0026#34;DECRBY\u0026#34;, KEYS[1], quantity) -- 4. æ›´æ–°ç”¨æˆ·è´­ä¹°æ•°é‡ redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, quantity) -- 5. è¿”å›æˆåŠŸ return {1, \u0026#34;æˆåŠŸ\u0026#34;} è„šæœ¬æ‰§è¡Œæµç¨‹è¯¦è§£ è®©æˆ‘ä»¬é€æ­¥åˆ†æè¿™ä¸ªè„šæœ¬çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\n1. å‚æ•°æ¥æ”¶ 1 2 3 local userId = ARGV[1] -- æ¥æ”¶ç”¨æˆ·ID local quantity = tonumber(ARGV[2]) -- æ¥æ”¶è´­ä¹°æ•°é‡ local perUserLimit = tonumber(ARGV[3]) -- æ¥æ”¶é™è´­æ•°é‡ åç«¯é€šè¿‡ redisTemplate.execute(...) ä¼ å…¥è¿™äº› ARGV å‚æ•°ç»™ Lua è„šæœ¬ï¼Œè„šæœ¬æ¥æ”¶æ¯ä¸ªå‚æ•°ã€‚\n2. æŸ¥è¯¢ç”¨æˆ·è´­ä¹°è®°å½• 1 local userBought = tonumber(redis.call(\u0026#34;HGET\u0026#34;, KEYS[2], userId) or \u0026#34;0\u0026#34;) è¿™æ®µä»£ç çš„ä½œç”¨ï¼šæŸ¥è¯¢å½“å‰ userId çš„è´­ä¹°è®°å½•ã€‚\nåŸç†ï¼šå› ä¸ºä¼ å…¥äº† participantsKeyï¼ˆè¿™ä¸ªæ´»åŠ¨çš„ç”¨æˆ·è´­ä¹°è®°å½•ï¼‰å’Œ userIdï¼ˆè¿™ä¸ªç”¨æˆ·ï¼‰ï¼Œå°±å¯ä»¥æ ¹æ® userId åœ¨ participantsKey é‡Œé¢æŸ¥å‡ºå¯¹åº”çš„ç”¨æˆ·è´­ä¹°è®°å½•ã€‚\n3. é™è´­æ ¡éªŒ 1 2 3 if userBought + quantity \u0026gt; perUserLimit then return {0, \u0026#34;è¶…è¿‡ä¸ªäººé™è´­\u0026#34;} end åˆ¤æ–­é€»è¾‘ï¼šç”¨æˆ·ç›®å‰å·²è´­ä¹°æ•° + æ–°è´­ä¹°æ•° quantity æ˜¯å¦å¤§äºæœ€å¤§è´­ä¹°é‡ perUserLimitã€‚\nå¦‚æœæ˜¯ï¼Œè¿”å› {0, \u0026quot;è¶…è¿‡ä¸ªäººé™è´­\u0026quot;} å¦‚æœä¸æ˜¯ï¼Œç»§ç»­ä¸‹ä¸€æ­¥ 4. åº“å­˜æ ¡éªŒ 1 2 3 if stock \u0026lt; quantity then return {0, \u0026#34;åº“å­˜ä¸è¶³\u0026#34;} end æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿï¼Œåˆ™è¿”å› {0, \u0026quot;åº“å­˜ä¸è¶³\u0026quot;}ã€‚\n5. æ‰§è¡Œè´­ä¹°æ“ä½œ 1 2 3 4 5 -- æ‰£å‡åº“å­˜ redis.call(\u0026#34;DECRBY\u0026#34;, KEYS[1], quantity) -- è®°å½•ç”¨æˆ·è´­ä¹°æ•°é‡ redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, quantity) å¦‚æœåº“å­˜è¶³å¤Ÿï¼Œåˆ™ï¼š\næ‰£å‡åº“å­˜ï¼šDECRBY å‘½ä»¤å°†åº“å­˜å‡å°‘ quantity æ•°é‡ è®°å½•ç”¨æˆ·è´­ä¹°æ•°é‡ï¼šHINCRBY å‘½ä»¤å°†ç”¨æˆ·çš„è´­ä¹°è®°å½•å¢åŠ  quantity æ•°é‡ 6. è¿”å›æˆåŠŸ 1 return {1, \u0026#34;æˆåŠŸ\u0026#34;} æœ€åè¿”å› {1, \u0026quot;æˆåŠŸ\u0026quot;}ï¼Œè¡¨ç¤ºè´­ä¹°æˆåŠŸã€‚\näº”ã€æ‰§è¡Œæµç¨‹ç¤ºä¾‹ æˆ‘ä»¬ä»¥ç”¨æˆ· 12345 å‚ä¸æ´»åŠ¨ 1001 ä¸ºä¾‹ï¼Œå‡è®¾åˆå§‹åº“å­˜ä¸º 10ï¼Œé™è´­ä¸º 3ï¼š\nç¬¬ä¸€æ¬¡è´­ä¹°ï¼ˆä¹° 2 ä»¶ï¼‰ è¾“å…¥å‚æ•°ï¼š\nKEYS[1] = seckill:stock:1001 KEYS[2] = seckill:participants:1001 ARGV[1] = \u0026quot;12345\u0026quot; ARGV[2] = \u0026quot;2\u0026quot; ARGV[3] = \u0026quot;3\u0026quot; è„šæœ¬æ‰§è¡Œï¼š\nuserBought = 0ï¼ˆæ²¡ä¹°è¿‡ï¼‰ stock = 10ï¼Œè¶³å¤Ÿ æ‰£å‡åº“å­˜ï¼šDECRBY seckill:stock:1001 2 â†’ åº“å­˜å˜ 8 æ›´æ–°è´­ä¹°è®°å½•ï¼šHINCRBY seckill:participants:1001 12345 2 â†’ ç”¨æˆ·ä¹°äº† 2 ä»¶ è¿”å› {1, \u0026quot;æˆåŠŸ\u0026quot;} ç¬¬äºŒæ¬¡è´­ä¹°ï¼ˆå†ä¹° 2 ä»¶ï¼‰ è¾“å…¥å‚æ•°ï¼š\nARGV[1] = \u0026quot;12345\u0026quot; ARGV[2] = \u0026quot;2\u0026quot; ARGV[3] = \u0026quot;3\u0026quot; è„šæœ¬æ‰§è¡Œï¼š\nuserBought = 2ï¼ˆä¸Šæ¬¡ä¹°äº† 2 ä»¶ï¼‰ æœ¬æ¬¡è¦ä¹° 2 ä»¶ï¼Œæ€»æ•° = 4 \u0026gt; é™è´­ 3 è¿”å› {0, \u0026quot;è¶…è¿‡ä¸ªäººé™è´­\u0026quot;} å…­ã€æ ¸å¿ƒä¼˜åŠ¿ é€šè¿‡ Redis Key è®¾è®¡ + Lua è„šæœ¬åŸå­æ‰§è¡Œï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š\n1. é˜²æ­¢è¶…å– åº“å­˜æ‰£å‡å’Œç”¨æˆ·è´­ä¹°è®°å½•æ›´æ–°åœ¨åŒä¸€ä¸ªè„šæœ¬é‡Œå®Œæˆï¼Œä¿è¯äº†åŸå­æ€§ã€‚\n2. é™è´­æ§åˆ¶ åˆ©ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ç”¨æˆ·è´­ä¹°è®°å½•ï¼Œç»“åˆ Lua è„šæœ¬æ ¡éªŒï¼Œé¿å…äº†ç”¨æˆ·ç»•è¿‡é™è´­ã€‚\n3. é«˜å¹¶å‘æ€§èƒ½ é€»è¾‘å…¨éƒ¨åœ¨ Redis å†…éƒ¨æ‰§è¡Œï¼Œä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œæ€§èƒ½æé«˜ã€‚\n4. æ•°æ®ä¸€è‡´æ€§ Lua è„šæœ¬çš„åŸå­æ€§ä¿è¯äº†æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nä¸ƒã€å®é™…åº”ç”¨åœºæ™¯ è¿™ç§æ–¹å¼æ˜¯å¾ˆå¤šç”µå•†å¹³å°åœ¨ç§’æ€åœºæ™¯ä¸­çš„æ ‡å‡†åšæ³•ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œå¸¸è§çš„\u0026quot;æ•°æ®åº“å‰Šå³°\u0026quot;ä¸\u0026quot;Redis é™æµ\u0026quot;çš„ç»“åˆåº”ç”¨ã€‚\né€‚ç”¨åœºæ™¯ ç§’æ€æ´»åŠ¨ é™æ—¶æŠ¢è´­ é™é‡å•†å“é”€å”® ä¼˜æƒ åˆ¸å‘æ”¾ ç§¯åˆ†å…‘æ¢ æŠ€æœ¯ç‰¹ç‚¹ é«˜æ€§èƒ½ï¼šRedis å†…å­˜æ“ä½œï¼Œå“åº”é€Ÿåº¦å¿« åŸå­æ€§ï¼šLua è„šæœ¬ä¿è¯æ“ä½œåŸå­æ€§ å¯æ‰©å±•ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² å¯é æ€§ï¼šé¿å…è¶…å–å’Œé‡å¤è´­ä¹° å…«ã€å»¶ä¼¸æ€è€ƒ 1. é€€æ¬¾é€€è´§æ”¯æŒ å¦‚æœè¦æ”¯æŒé€€æ¬¾é€€è´§ï¼Œéœ€è¦åœ¨ Lua è„šæœ¬é‡Œå¢åŠ åº“å­˜å›æ»šé€»è¾‘ï¼š\n1 2 3 4 -- é€€æ¬¾æ—¶å›æ»šåº“å­˜ redis.call(\u0026#34;INCRBY\u0026#34;, KEYS[1], quantity) -- å‡å°‘ç”¨æˆ·è´­ä¹°è®°å½• redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, -quantity) 2. åˆ†ç‰‡å­˜å‚¨ä¼˜åŒ– å¦‚æœæ´»åŠ¨å•†å“æ•°é‡éå¸¸å¤§ï¼Œå¯ä»¥è€ƒè™‘åˆ†ç‰‡å­˜å‚¨åº“å­˜ï¼Œè¿›ä¸€æ­¥æé«˜å¹¶å‘æ€§èƒ½ï¼š\n1 2 -- æ ¹æ®ç”¨æˆ·IDè¿›è¡Œåˆ†ç‰‡ local shardKey = \u0026#34;seckill:stock:\u0026#34; .. activityId .. \u0026#34;:\u0026#34; .. (userId % 10) 3. å¼‚æ­¥å¤„ç† åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿˜éœ€è¦é…åˆæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰å’Œå¼‚æ­¥ä¸‹å•ï¼Œä»¥ä¿è¯åç»­æ•°æ®åº“å†™å…¥çš„å¯é æ€§ã€‚ è¯¦æƒ…å¯å‰å¾€æ­¤å¤„äº†è§£https://yin123-ybh.github.io/p/å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æå«redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°/\n4. ç›‘æ§å’Œå‘Šè­¦ ç›‘æ§ Redis æ€§èƒ½æŒ‡æ ‡ è®¾ç½®åº“å­˜å‘Šè­¦é˜ˆå€¼ è®°å½•ç”¨æˆ·è´­ä¹°è¡Œä¸ºæ—¥å¿— ä¹ã€æ€»ç»“ Redis + Lua è„šæœ¬åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ ¸å¿ƒé—®é¢˜ï¼š\nåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½ï¼šå°†æ ¸å¿ƒé€»è¾‘ä»æ•°æ®åº“è½¬ç§»åˆ°å†…å­˜ ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼šLua è„šæœ¬ç¡®ä¿æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ å®ç°ç²¾ç¡®çš„é™è´­æ§åˆ¶ï¼šé€šè¿‡å“ˆå¸Œè¡¨è®°å½•ç”¨æˆ·è´­ä¹°å†å² é¿å…è¶…å–é—®é¢˜ï¼šåº“å­˜æ‰£å‡å’Œç”¨æˆ·è®°å½•æ›´æ–°åœ¨åŒä¸€è„šæœ¬ä¸­å®Œæˆ è¿™ç§æ–¹æ¡ˆä¸ä»…é€‚ç”¨äºç§’æ€ç³»ç»Ÿï¼Œåœ¨éœ€è¦é«˜å¹¶å‘ã€å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä¸­éƒ½æœ‰å¹¿æ³›åº”ç”¨ä»·å€¼ã€‚\nä»¥ä¸Šå°±æ˜¯å…³äºç§’æ€ç³»ç»Ÿä¸­ Redis + Lua è„šæœ¬çš„å®Œæ•´åº”ç”¨è§£æã€‚é€šè¿‡æ·±å…¥ç†è§£è¿™äº›æ ¸å¿ƒæ¦‚å¿µï¼Œä½ å°±èƒ½åœ¨å®é™…é¡¹ç›®ä¸­çµæ´»è¿ç”¨è¿™äº›æŠ€æœ¯ï¼Œæ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯é çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\n","date":"2025-09-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-redis--lua-%E5%9C%A8%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/","title":"æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨"},{"content":"å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰ ç§’æ€ç³»ç»Ÿæ˜¯ç”µå•†é«˜å¹¶å‘åœºæ™¯çš„å…¸å‹åº”ç”¨ï¼ŒçŸ­æ—¶é—´å†…å¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­æœ‰é™å•†å“ï¼Œå¦‚ä½•ä¿è¯åº“å­˜ä¸è¶…å–ã€ç³»ç»Ÿé«˜å¯ç”¨ã€å“åº”å¿«é€Ÿï¼Œæ˜¯æŠ€æœ¯è®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ã€‚æœ¬æ–‡å°†ç»“åˆå¼‚æ­¥ç§’æ€æ€è·¯ã€Redisåº“å­˜é¢„æ‰£ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å‰åç«¯è§£è€¦ç­‰æŠ€æœ¯ç‚¹ï¼Œæ·±å…¥è®²è§£ç§’æ€ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼Œå¹¶ç”¨ç±»æ¯”å’Œæµç¨‹è§£æï¼Œå¸®åŠ©ä½ ç†è§£é«˜å¹¶å‘å¤„ç†èƒŒåçš„åŸç†ã€‚\n1ï¸âƒ£ ç§’æ€åœºæ™¯é—®é¢˜åˆ†æ ç§’æ€åœºæ™¯ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜å¹¶å‘ï¼šçŸ­æ—¶é—´å†…æˆåƒä¸Šä¸‡ç”¨æˆ·æŠ¢è´­åŒä¸€å•†å“ åº“å­˜æœ‰é™ï¼šå•†å“æ•°é‡æœ‰é™ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶ ç³»ç»Ÿå‹åŠ›å¤§ï¼šæ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ å¸¸è§é—®é¢˜ï¼š è¶…å–ï¼šåº“å­˜è¢«å¤šæ¬¡æ‰£å‡ï¼Œå–å‡ºè¶…è¿‡å®é™…æ•°é‡ æ•°æ®åº“å‹åŠ›å¤§ï¼šå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ï¼Œå®¹æ˜“å¯¼è‡´å®•æœº ç½‘ç»œå»¶è¿Ÿå’Œå“åº”æ…¢ï¼šç”¨æˆ·ä½“éªŒå·® å¹¶å‘äº‹åŠ¡å†²çªï¼šæ™®é€šé”æˆ–äº‹åŠ¡å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆé”™è¯¯å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // âŒ é”™è¯¯å®ç°ï¼šç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå®¹æ˜“è¶…å– @RestController public class SeckillController { @Autowired private ProductService productService; @Autowired private OrderService orderService; @PostMapping(\u0026#34;/seckill\u0026#34;) public Result seckill(@RequestParam Long productId, @RequestParam Long userId) { // 1. æŸ¥è¯¢åº“å­˜ Product product = productService.getById(productId); if (product.getStock() \u0026lt;= 0) { return Result.fail(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); } // 2. æ‰£å‡åº“å­˜ - è¿™é‡Œå¯èƒ½å‡ºç°è¶…å–ï¼ product.setStock(product.getStock() - 1); productService.updateById(product); // 3. åˆ›å»ºè®¢å• Order order = new Order(); order.setProductId(productId); order.setUserId(userId); orderService.save(order); return Result.success(\u0026#34;ç§’æ€æˆåŠŸ\u0026#34;); } } 2ï¸âƒ£ åŒæ­¥ vs å¼‚æ­¥ç§’æ€ ç§’æ€å¤„ç†å¯ä»¥åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š\næ–¹å¼ ç”¨æˆ·è¯·æ±‚ åç«¯å¤„ç† ä¼˜ç¼ºç‚¹ åŒæ­¥ ç”¨æˆ·è¯·æ±‚ç›´æ¥è°ƒç”¨æ•°æ®åº“ ç«‹å³å¤„ç†åº“å­˜å’Œè®¢å• é«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›å¤§ï¼Œå®¹æ˜“é˜»å¡ï¼Œè¶…å–é£é™©é«˜ å¼‚æ­¥ ç”¨æˆ·è¯·æ±‚å…ˆè¿›å…¥é˜Ÿåˆ—æˆ–ç¼“å­˜ åå°å¼‚æ­¥æ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¾æ¬¡å¤„ç†åº“å­˜å’Œè®¢å• å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œå‰Šå³°å¡«è°·ï¼Œé˜²æ­¢è¶…å– æ ¸å¿ƒåŒºåˆ«ï¼š åŒæ­¥æ¨¡å¼ï¼šå‰ç«¯ç­‰å¾…åç«¯å®Œæˆæ‰€æœ‰æ“ä½œ å¼‚æ­¥æ¨¡å¼ï¼šå‰ç«¯è¯·æ±‚å…ˆæ’é˜Ÿï¼Œåå°æ…¢æ…¢å¤„ç†ä¸šåŠ¡ï¼Œè¯·æ±‚å¤„ç†ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦ 3ï¸âƒ£ å¼‚æ­¥ç§’æ€æ ¸å¿ƒæ€è·¯ å¼‚æ­¥ç§’æ€é€šè¿‡ä»¥ä¸‹æµç¨‹å®ç°é«˜å¹¶å‘å¤„ç†ï¼š\næ­¥éª¤ 1ï¼šæ¥æ”¶è¯·æ±‚ï¼ˆæ¥å£å±‚ï¼‰ ç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®ï¼Œå‰ç«¯è¯·æ±‚ç§’æ€æ¥å£ã€‚\næ¥å£å±‚å¿«é€Ÿåˆ¤æ–­ï¼š\nå•†å“æ˜¯å¦è¿˜æœ‰åº“å­˜ ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å• åˆ¤æ–­é€šè¿‡ï¼š\nä½¿ç”¨ Redis + Lua è„šæœ¬è¿›è¡Œåº“å­˜é¢„æ‰£ï¼ˆåŸå­æ“ä½œï¼‰ ç”Ÿæˆè®¢å• ID æˆ–è¯·æ±‚ ID å°†è¯·æ±‚å°è£…æˆæ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQã€Kafkaã€Redis Stream ç­‰ï¼‰ æ¥å£ç«‹å³è¿”å›ç»™å‰ç«¯ï¼š\n\u0026ldquo;æ’é˜ŸæˆåŠŸ\u0026quot;æˆ–\u0026quot;è¯·æ±‚å·²æ¥æ”¶\u0026rdquo; âš¡ æ³¨æ„ï¼šå‰ç«¯ç”¨æˆ·æ­¤æ—¶å¹¶æœªç›´æ¥æ‹¿åˆ°æœ€ç»ˆè®¢å•ï¼Œåªæ˜¯æ‹¿åˆ°ä¸€ä¸ª\u0026quot;æŠ¢è´­å‡­è¯\u0026quot;ã€‚\næ­¥éª¤ 2ï¼šå¼‚æ­¥å¤„ç†è¯·æ±‚ï¼ˆåå°æœåŠ¡ï¼‰ æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ï¼š\næ‰£æ•°æ®åº“åº“å­˜ åˆ›å»ºè®¢å•è®°å½• æ ‡è®°ç”¨æˆ·å·²ä¸‹å• å¤„ç†å®Œæˆåé€šçŸ¥ç”¨æˆ·ï¼š\nç§’æ€æˆåŠŸï¼ˆè®¢å•ç”ŸæˆæˆåŠŸï¼‰ ç§’æ€å¤±è´¥ï¼ˆåº“å­˜ä¸è¶³ï¼‰ æ­¥éª¤ 3ï¼šåº“å­˜æ§åˆ¶ Redisåº“å­˜é¢„å‡ï¼š\nç§’æ€å‰ï¼Œå°†å•†å“åº“å­˜åŠ è½½åˆ° Redis ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œç”¨ Redis åŸå­æ“ä½œ DECR æ‰£å‡åº“å­˜ æ‰£å‡æˆåŠŸ â†’ æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ— æ‰£å‡å¤±è´¥ â†’ ç§’æ€ç»“æŸï¼Œè¿”å›å¤±è´¥ å¯ä½¿ç”¨ Lua è„šæœ¬å°† åˆ¤æ–­åº“å­˜ \u0026gt; 0 + æ‰£å‡åº“å­˜ åšæˆåŸå­æ“ä½œï¼Œé¿å…è¶…å–\næ­¥éª¤ 4ï¼šç”¨æˆ·é€šçŸ¥ ç§’æ€ç»“æœå¼‚æ­¥è¿”å›ï¼š\nè½®è¯¢æ¥å£ WebSocket æ¶ˆæ¯æ¨é€ å‰ç«¯ç”¨æˆ·æ‹¿åˆ°æœ€ç»ˆç»“æœåï¼Œç¡®è®¤æ˜¯å¦æŠ¢è´­æˆåŠŸ\n4ï¸âƒ£ æ¥å£å±‚å¿«é€Ÿåˆ¤æ–­åº“å­˜ä¸ç”¨æˆ·èµ„æ ¼ æ¥å£å±‚ä¸ºä»€ä¹ˆå¯ä»¥å¿«é€Ÿåˆ¤æ–­åº“å­˜å’Œç”¨æˆ·æ˜¯å¦ç¬¦åˆä¸‹å•è¦æ±‚ï¼Ÿæ ¸å¿ƒæ˜¯æå‰æŠŠå…³é”®æ•°æ®ç¼“å­˜åœ¨ Redisï¼š\n4.1 åº“å­˜åˆ¤æ–­ ç§’æ€å¼€å§‹å‰ï¼Œå°†å•†å“åº“å­˜åŠ è½½åˆ° Redisï¼š\n1 2 Key: \u0026#34;stock:å•†å“ID\u0026#34; Value: å‰©ä½™åº“å­˜æ•°é‡ è¯·æ±‚åˆ°æ¥æ—¶ï¼š\n1 DECR stock:å•†å“ID // åŸå­æ“ä½œ è¿”å›å€¼åˆ¤æ–­ï¼š\nâ‰¥0 â†’ åº“å­˜è¿˜æœ‰ï¼Œå…è®¸ä¸‹å• \u0026lt;0 â†’ åº“å­˜ä¸è¶³ï¼Œç§’æ€ç»“æŸ Lua è„šæœ¬å¯å°†\u0026quot;åˆ¤æ–­åº“å­˜ + æ‰£å‡åº“å­˜\u0026quot;åŸå­åŒ–å¤„ç†ï¼Œé¿å…è¶…å–\n4.2 ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• æ¯ä½ç”¨æˆ·åªèƒ½ä¸‹å•ä¸€æ¬¡ï¼š\n1 2 Key: \u0026#34;order:ç”¨æˆ·ID:å•†å“ID\u0026#34; Value: 1 // å·²ä¸‹å• æ¥å£å±‚åˆ¤æ–­ï¼š\n1 2 EXISTS order:ç”¨æˆ·ID:å•†å“ID â†’ å·²ä¸‹å•ï¼Œæ‹’ç» ä¸å­˜åœ¨ â†’ å…è®¸åŠ å…¥é˜Ÿåˆ— âœ… é€šè¿‡ Redis åˆ¤æ–­åº“å­˜ä¸ç”¨æˆ·çŠ¶æ€ï¼Œå®ç°ç§’æ€æ¥å£å¿«é€Ÿå“åº”ï¼Œé¿å…é«˜å¹¶å‘ç›´æ¥æ‰“æ•°æ®åº“ã€‚\n4.3 æ¥å£å±‚å®Œæ•´æµç¨‹ ç”¨æˆ·å‘èµ·è¯·æ±‚ æ¥å£å±‚åˆ¤æ–­åº“å­˜ + ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• åˆ¤æ–­é€šè¿‡ï¼š Redisé¢„æ‰£åº“å­˜ï¼ˆLuaè„šæœ¬ï¼‰ ç”Ÿæˆè®¢å•ID æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ— è¿”å›\u0026quot;æ’é˜ŸæˆåŠŸ\u0026quot;ï¼Œå‰ç«¯æ— éœ€ç­‰å¾…æ•°æ®åº“æ“ä½œ 5ï¸âƒ£ å¼‚æ­¥çš„æ€§èƒ½ä¼˜åŠ¿ å¼‚æ­¥æ¨¡å¼æ¯”åŒæ­¥æ¨¡å¼æ€§èƒ½æ›´å¥½ï¼ŒåŸå› åœ¨äºè§£è€¦è¯·æ±‚å¤„ç†å’Œæ•°æ®åº“æ“ä½œï¼Œé¿å…é˜»å¡ï¼š\nè¯·æ±‚å¤„ç†å¿«ï¼šçº¿ç¨‹åªåšè½»é‡åˆ¤æ–­ + Redis + æ¶ˆæ¯å…¥é˜Ÿ â†’ ç«‹å³é‡Šæ”¾ æµé‡å‰Šå³°å¡«è°·ï¼šé˜Ÿåˆ—ç¼“å†²é«˜å³°è¯·æ±‚ï¼Œæ•°æ®åº“å¹³æ»‘æ¶ˆè´¹ é¿å…è¶…å–ï¼šRedisåŸå­æ‰£å‡ + é˜Ÿåˆ—é¡ºåºæ¶ˆè´¹ ç³»ç»Ÿååé‡é«˜ï¼šWebå±‚å¿«é€Ÿå“åº” + åç«¯å¤šçº¿ç¨‹æˆ–åˆ†å¸ƒå¼å¤„ç† ç±»æ¯”è¯´æ˜ åŒæ­¥ï¼šå‰ç«¯ç›´æ¥ç­‰èœåšå¥½ â†’ é«˜å³°æœŸæ’é•¿é˜Ÿï¼Œå¨æˆ¿å¿™ä¸è¿‡æ¥ å¼‚æ­¥ï¼šå‰ç«¯å…ˆæ‹¿åˆ°å–é¤å· â†’ å¨æˆ¿æŒ‰é¡ºåºåšèœ â†’ ç³»ç»Ÿç¨³å®šï¼Œç”¨æˆ·ä½“éªŒå¥½ 6ï¸âƒ£ æ ¸å¿ƒæŠ€æœ¯å®ç°è¦ç‚¹ æŠ€æœ¯ç¯èŠ‚ å®ç°å…³é”® æ¥å…¥å±‚ é™æµï¼ˆNginx/ç½‘å…³ï¼‰é˜²æ­¢è¯·æ±‚æš´æ¶¨ åº“å­˜åˆ¤æ–­ RedisåŸå­æ“ä½œ DECR + Luaè„šæœ¬ è¯·æ±‚æ’é˜Ÿ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼ˆRabbitMQ/Kafka/Redis Streamï¼‰ è®¢å•å¤„ç† æ¶ˆè´¹ç«¯äº‹åŠ¡å†™æ•°æ®åº“ å»é‡ ç”¨æˆ·ä¸‹å•å‰æ£€æŸ¥æ˜¯å¦å·²ä¸‹å• å‰Šå³°å¡«è°· æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯å¹³æ»‘æ¶ˆè´¹ å¹‚ç­‰æ€§ æ¶ˆè´¹ç«¯ä¿è¯é‡å¤æ¶ˆè´¹ä¸ä¼šäº§ç”Ÿé‡å¤è®¢å• 7ï¸âƒ£ å®Œæ•´ä»£ç å®ç° 7.1 é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 seckill-system/ â”œâ”€â”€ src/main/java/com/seckill/ â”‚ â”œâ”€â”€ controller/ â”‚ â”‚ â””â”€â”€ SeckillController.java â”‚ â”œâ”€â”€ service/ â”‚ â”‚ â”œâ”€â”€ SeckillService.java â”‚ â”‚ â”œâ”€â”€ OrderService.java â”‚ â”‚ â””â”€â”€ ProductService.java â”‚ â”œâ”€â”€ config/ â”‚ â”‚ â”œâ”€â”€ RedisConfig.java â”‚ â”‚ â””â”€â”€ RabbitMQConfig.java â”‚ â”œâ”€â”€ entity/ â”‚ â”‚ â”œâ”€â”€ SeckillOrder.java â”‚ â”‚ â””â”€â”€ SeckillProduct.java â”‚ â”œâ”€â”€ dto/ â”‚ â”‚ â””â”€â”€ SeckillMessage.java â”‚ â”œâ”€â”€ consumer/ â”‚ â”‚ â””â”€â”€ SeckillConsumer.java â”‚ â””â”€â”€ util/ â”‚ â””â”€â”€ RedisLuaScript.java 7.2 å®ä½“ç±»å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // ç§’æ€å•†å“å®ä½“ @Data @Entity @Table(name = \u0026#34;seckill_product\u0026#34;) public class SeckillProduct { @Id private Long id; private String name; private BigDecimal price; private Integer stock; private LocalDateTime startTime; private LocalDateTime endTime; private Integer status; // 0-æœªå¼€å§‹ 1-è¿›è¡Œä¸­ 2-å·²ç»“æŸ } // ç§’æ€è®¢å•å®ä½“ @Data @Entity @Table(name = \u0026#34;seckill_order\u0026#34;) public class SeckillOrder { @Id private String id; private Long userId; private Long productId; private BigDecimal price; private Integer status; // 0-å¾…æ”¯ä»˜ 1-å·²æ”¯ä»˜ 2-å·²å–æ¶ˆ private LocalDateTime createTime; private LocalDateTime payTime; } 7.3 Redisé…ç½®å’ŒLuaè„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @Configuration public class RedisConfig { @Bean public RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate(RedisConnectionFactory factory) { RedisTemplate\u0026lt;String, Object\u0026gt; template = new RedisTemplate\u0026lt;\u0026gt;(); template.setConnectionFactory(factory); // è®¾ç½®åºåˆ—åŒ– Jackson2JsonRedisSerializer\u0026lt;Object\u0026gt; serializer = new Jackson2JsonRedisSerializer\u0026lt;\u0026gt;(Object.class); ObjectMapper mapper = new ObjectMapper(); mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); mapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL); serializer.setObjectMapper(mapper); template.setValueSerializer(serializer); template.setKeySerializer(new StringRedisSerializer()); template.setHashKeySerializer(new StringRedisSerializer()); template.setHashValueSerializer(serializer); template.afterPropertiesSet(); return template; } } // Luaè„šæœ¬å·¥å…·ç±» @Component public class RedisLuaScript { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; // åº“å­˜é¢„æ‰£Luaè„šæœ¬ private static final String STOCK_DECR_SCRIPT = \u0026#34;local stock = redis.call(\u0026#39;get\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if stock == false or tonumber(stock) \u0026lt;= 0 then \u0026#34; + \u0026#34; return -1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;local newStock = redis.call(\u0026#39;decr\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if newStock \u0026lt; 0 then \u0026#34; + \u0026#34; redis.call(\u0026#39;incr\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34; return -1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;return newStock\u0026#34;; // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• private static final String CHECK_USER_ORDER_SCRIPT = \u0026#34;local exists = redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if exists == 1 then \u0026#34; + \u0026#34; return 1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;redis.call(\u0026#39;setex\u0026#39;, KEYS[1], ARGV[1], \u0026#39;1\u0026#39;) \u0026#34; + \u0026#34;return 0\u0026#34;; /** * åŸå­æ€§æ‰£å‡åº“å­˜ */ public Long decrStock(String stockKey) { DefaultRedisScript\u0026lt;Long\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptText(STOCK_DECR_SCRIPT); script.setResultType(Long.class); return redisTemplate.execute(script, Collections.singletonList(stockKey)); } /** * æ£€æŸ¥å¹¶æ ‡è®°ç”¨æˆ·å·²ä¸‹å• */ public Boolean checkAndSetUserOrder(String userOrderKey, int expireSeconds) { DefaultRedisScript\u0026lt;Long\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptText(CHECK_USER_ORDER_SCRIPT); script.setResultType(Long.class); Long result = redisTemplate.execute(script, Collections.singletonList(userOrderKey), String.valueOf(expireSeconds)); return result != null \u0026amp;\u0026amp; result == 0; // 0è¡¨ç¤ºæˆåŠŸè®¾ç½®ï¼Œ1è¡¨ç¤ºå·²å­˜åœ¨ } } 7.4 æ¶ˆæ¯é˜Ÿåˆ—é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 @Configuration public class RabbitMQConfig { // ç§’æ€æ¶ˆæ¯é˜Ÿåˆ— public static final String SECKILL_QUEUE = \u0026#34;seckill.queue\u0026#34;; public static final String SECKILL_EXCHANGE = \u0026#34;seckill.exchange\u0026#34;; public static final String SECKILL_ROUTING_KEY = \u0026#34;seckill.message\u0026#34;; @Bean public Queue seckillQueue() { return QueueBuilder.durable(SECKILL_QUEUE).build(); } @Bean public DirectExchange seckillExchange() { return new DirectExchange(SECKILL_EXCHANGE); } @Bean public Binding seckillBinding() { return BindingBuilder .bind(seckillQueue()) .to(seckillExchange()) .with(SECKILL_ROUTING_KEY); } @Bean public MessageConverter messageConverter() { return new Jackson2JsonMessageConverter(); } } // ç§’æ€æ¶ˆæ¯DTO @Data @AllArgsConstructor @NoArgsConstructor public class SeckillMessage { private Long userId; private Long productId; private String orderId; private LocalDateTime createTime; } 7.5 ç§’æ€æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @RestController @RequestMapping(\u0026#34;/seckill\u0026#34;) @Slf4j public class SeckillController { @Autowired private SeckillService seckillService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * ç§’æ€æ¥å£ */ @PostMapping(\u0026#34;/{productId}\u0026#34;) public Result\u0026lt;String\u0026gt; seckill(@PathVariable Long productId, @RequestParam Long userId) { try { // 1. å‚æ•°æ ¡éªŒ if (productId == null || userId == null) { return Result.fail(\u0026#34;å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34;); } // 2. æ£€æŸ¥ç§’æ€æ´»åŠ¨çŠ¶æ€ if (!seckillService.isSeckillActive(productId)) { return Result.fail(\u0026#34;ç§’æ€æ´»åŠ¨æœªå¼€å§‹æˆ–å·²ç»“æŸ\u0026#34;); } // 3. æ‰§è¡Œç§’æ€ String orderId = seckillService.executeSeckill(productId, userId); if (orderId != null) { return Result.success(\u0026#34;æ’é˜ŸæˆåŠŸï¼Œè®¢å•å·ï¼š\u0026#34; + orderId); } else { return Result.fail(\u0026#34;ç§’æ€å¤±è´¥ï¼Œè¯·é‡è¯•\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;ç§’æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId, e); return Result.fail(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } } /** * æŸ¥è¯¢ç§’æ€ç»“æœ */ @GetMapping(\u0026#34;/result/{orderId}\u0026#34;) public Result\u0026lt;SeckillOrder\u0026gt; getSeckillResult(@PathVariable String orderId) { try { SeckillOrder order = seckillService.getSeckillOrder(orderId); if (order != null) { return Result.success(order); } else { return Result.fail(\u0026#34;è®¢å•ä¸å­˜åœ¨æˆ–å¤„ç†ä¸­\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;æŸ¥è¯¢ç§’æ€ç»“æœå¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return Result.fail(\u0026#34;æŸ¥è¯¢å¤±è´¥\u0026#34;); } } /** * è·å–å•†å“åº“å­˜ */ @GetMapping(\u0026#34;/stock/{productId}\u0026#34;) public Result\u0026lt;Integer\u0026gt; getStock(@PathVariable Long productId) { try { String stockKey = \u0026#34;stock:\u0026#34; + productId; Object stock = redisTemplate.opsForValue().get(stockKey); if (stock != null) { return Result.success(Integer.valueOf(stock.toString())); } else { return Result.success(0); } } catch (Exception e) { log.error(\u0026#34;è·å–åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return Result.fail(\u0026#34;è·å–åº“å­˜å¤±è´¥\u0026#34;); } } } 7.6 ç§’æ€æœåŠ¡å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 @Service @Slf4j public class SeckillService { @Autowired private ProductService productService; @Autowired private OrderService orderService; @Autowired private RedisLuaScript redisLuaScript; @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String STOCK_PREFIX = \u0026#34;stock:\u0026#34;; private static final String USER_ORDER_PREFIX = \u0026#34;user_order:\u0026#34;; private static final int USER_ORDER_EXPIRE = 3600; // 1å°æ—¶ /** * æ£€æŸ¥ç§’æ€æ´»åŠ¨æ˜¯å¦è¿›è¡Œä¸­ */ public boolean isSeckillActive(Long productId) { try { SeckillProduct product = productService.getById(productId); if (product == null) { return false; } LocalDateTime now = LocalDateTime.now(); return product.getStatus() == 1 \u0026amp;\u0026amp; now.isAfter(product.getStartTime()) \u0026amp;\u0026amp; now.isBefore(product.getEndTime()); } catch (Exception e) { log.error(\u0026#34;æ£€æŸ¥ç§’æ€æ´»åŠ¨çŠ¶æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return false; } } /** * æ‰§è¡Œç§’æ€ */ public String executeSeckill(Long productId, Long userId) { try { // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• String userOrderKey = USER_ORDER_PREFIX + userId + \u0026#34;:\u0026#34; + productId; if (!redisLuaScript.checkAndSetUserOrder(userOrderKey, USER_ORDER_EXPIRE)) { log.warn(\u0026#34;ç”¨æˆ·å·²ä¸‹å•ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, userId, productId); return null; } // 2. åŸå­æ€§æ‰£å‡åº“å­˜ String stockKey = STOCK_PREFIX + productId; Long remainingStock = redisLuaScript.decrStock(stockKey); if (remainingStock == null || remainingStock \u0026lt; 0) { log.warn(\u0026#34;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId); return null; } // 3. ç”Ÿæˆè®¢å•ID String orderId = generateOrderId(); // 4. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ— SeckillMessage message = new SeckillMessage(); message.setUserId(userId); message.setProductId(productId); message.setOrderId(orderId); message.setCreateTime(LocalDateTime.now()); rabbitTemplate.convertAndSend( RabbitMQConfig.SECKILL_EXCHANGE, RabbitMQConfig.SECKILL_ROUTING_KEY, message ); log.info(\u0026#34;ç§’æ€è¯·æ±‚å·²å…¥é˜Ÿï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, orderId, userId, productId); return orderId; } catch (Exception e) { log.error(\u0026#34;æ‰§è¡Œç§’æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId, e); return null; } } /** * è·å–ç§’æ€è®¢å• */ public SeckillOrder getSeckillOrder(String orderId) { try { return orderService.getByOrderId(orderId); } catch (Exception e) { log.error(\u0026#34;è·å–ç§’æ€è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return null; } } /** * é¢„çƒ­å•†å“åº“å­˜åˆ°Redis */ public void warmUpStock(Long productId) { try { SeckillProduct product = productService.getById(productId); if (product != null \u0026amp;\u0026amp; product.getStock() \u0026gt; 0) { String stockKey = STOCK_PREFIX + productId; redisTemplate.opsForValue().set(stockKey, product.getStock()); log.info(\u0026#34;å•†å“åº“å­˜é¢„çƒ­æˆåŠŸï¼Œå•†å“IDï¼š{}ï¼Œåº“å­˜ï¼š{}\u0026#34;, productId, product.getStock()); } } catch (Exception e) { log.error(\u0026#34;é¢„çƒ­å•†å“åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); } } /** * ç”Ÿæˆè®¢å•ID */ private String generateOrderId() { return \u0026#34;SK\u0026#34; + System.currentTimeMillis() + ThreadLocalRandom.current().nextInt(1000, 9999); } } 7.7 æ¶ˆæ¯æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component @Slf4j public class SeckillConsumer { @Autowired private OrderService orderService; @Autowired private ProductService productService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * æ¶ˆè´¹ç§’æ€æ¶ˆæ¯ */ @RabbitListener(queues = RabbitMQConfig.SECKILL_QUEUE) public void handleSeckillMessage(SeckillMessage message) { log.info(\u0026#34;å¼€å§‹å¤„ç†ç§’æ€æ¶ˆæ¯ï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, message.getOrderId(), message.getUserId(), message.getProductId()); try { // 1. å†æ¬¡æ£€æŸ¥åº“å­˜ï¼ˆåŒé‡ä¿é™©ï¼‰ SeckillProduct product = productService.getById(message.getProductId()); if (product == null || product.getStock() \u0026lt;= 0) { log.warn(\u0026#34;å•†å“ä¸å­˜åœ¨æˆ–åº“å­˜ä¸è¶³ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId()); return; } // 2. åˆ›å»ºè®¢å• SeckillOrder order = new SeckillOrder(); order.setId(message.getOrderId()); order.setUserId(message.getUserId()); order.setProductId(message.getProductId()); order.setPrice(product.getPrice()); order.setStatus(0); // å¾…æ”¯ä»˜ order.setCreateTime(LocalDateTime.now()); // 3. æ‰£å‡æ•°æ®åº“åº“å­˜ boolean stockUpdated = productService.decrStock(message.getProductId()); if (!stockUpdated) { log.warn(\u0026#34;æ‰£å‡æ•°æ®åº“åº“å­˜å¤±è´¥ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId()); return; } // 4. ä¿å­˜è®¢å• orderService.save(order); log.info(\u0026#34;ç§’æ€è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, message.getOrderId(), message.getUserId(), message.getProductId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç§’æ€æ¶ˆæ¯å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId(), e); } } } 7.8 å•†å“æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Service @Transactional public class ProductService { @Autowired private SeckillProductMapper productMapper; /** * æ‰£å‡æ•°æ®åº“åº“å­˜ */ public boolean decrStock(Long productId) { try { int result = productMapper.decrStock(productId); return result \u0026gt; 0; } catch (Exception e) { log.error(\u0026#34;æ‰£å‡æ•°æ®åº“åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return false; } } /** * è·å–å•†å“ä¿¡æ¯ */ public SeckillProduct getById(Long productId) { try { return productMapper.selectById(productId); } catch (Exception e) { log.error(\u0026#34;è·å–å•†å“ä¿¡æ¯å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return null; } } } 7.9 è®¢å•æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Service public class OrderService { @Autowired private SeckillOrderMapper orderMapper; /** * ä¿å­˜è®¢å• */ public void save(SeckillOrder order) { try { orderMapper.insert(order); } catch (Exception e) { log.error(\u0026#34;ä¿å­˜è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, order.getId(), e); throw new RuntimeException(\u0026#34;ä¿å­˜è®¢å•å¤±è´¥\u0026#34;, e); } } /** * æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å• */ public SeckillOrder getByOrderId(String orderId) { try { return orderMapper.selectByOrderId(orderId); } catch (Exception e) { log.error(\u0026#34;æŸ¥è¯¢è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return null; } } } 7.10 æ•°æ®åº“Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // å•†å“Mapper @Mapper public interface SeckillProductMapper extends BaseMapper\u0026lt;SeckillProduct\u0026gt; { /** * æ‰£å‡åº“å­˜ */ @Update(\u0026#34;UPDATE seckill_product SET stock = stock - 1 WHERE id = #{productId} AND stock \u0026gt; 0\u0026#34;) int decrStock(@Param(\u0026#34;productId\u0026#34;) Long productId); } // è®¢å•Mapper @Mapper public interface SeckillOrderMapper extends BaseMapper\u0026lt;SeckillOrder\u0026gt; { /** * æ ¹æ®è®¢å•IDæŸ¥è¯¢ */ @Select(\u0026#34;SELECT * FROM seckill_order WHERE id = #{orderId}\u0026#34;) SeckillOrder selectByOrderId(@Param(\u0026#34;orderId\u0026#34;) String orderId); } 8ï¸âƒ£ å¼‚æ­¥ç§’æ€ä¼˜åŒ–æŠ€å·§ 8.1 æœ¬åœ°ç¼“å­˜åº“å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Component public class LocalStockCache { private final Map\u0026lt;Long, AtomicInteger\u0026gt; localStockMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * è·å–æœ¬åœ°åº“å­˜ */ public int getLocalStock(Long productId) { AtomicInteger stock = localStockMap.get(productId); return stock != null ? stock.get() : 0; } /** * æ‰£å‡æœ¬åœ°åº“å­˜ */ public boolean decrLocalStock(Long productId) { AtomicInteger stock = localStockMap.computeIfAbsent(productId, k -\u0026gt; new AtomicInteger(0)); return stock.decrementAndGet() \u0026gt;= 0; } /** * åŒæ­¥Redisåº“å­˜åˆ°æœ¬åœ° */ @Scheduled(fixedRate = 1000) // æ¯ç§’åŒæ­¥ä¸€æ¬¡ public void syncStockFromRedis() { for (Long productId : localStockMap.keySet()) { String stockKey = \u0026#34;stock:\u0026#34; + productId; Object redisStock = redisTemplate.opsForValue().get(stockKey); if (redisStock != null) { int stock = Integer.parseInt(redisStock.toString()); localStockMap.put(productId, new AtomicInteger(stock)); } } } } 8.2 é™æµé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Configuration public class RateLimitConfig { @Bean public RedisRateLimiter redisRateLimiter() { return new RedisRateLimiter(100, 200); // æ¯ç§’100ä¸ªè¯·æ±‚ï¼Œçªå‘200ä¸ª } } // é™æµæ³¨è§£ @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface RateLimit { String key() default \u0026#34;rate_limit\u0026#34;; int time() default 60; int count() default 100; } // é™æµåˆ‡é¢ @Aspect @Component public class RateLimitAspect { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Around(\u0026#34;@annotation(rateLimit)\u0026#34;) public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable { String key = rateLimit.key(); int time = rateLimit.time(); int count = rateLimit.count(); String rateLimitKey = \u0026#34;rate_limit:\u0026#34; + key + \u0026#34;:\u0026#34; + System.currentTimeMillis() / 1000; Long current = redisTemplate.opsForValue().increment(rateLimitKey); if (current == 1) { redisTemplate.expire(rateLimitKey, time, TimeUnit.SECONDS); } if (current \u0026gt; count) { throw new RuntimeException(\u0026#34;è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } return point.proceed(); } } 8.3 çƒ­ç‚¹å•†å“é¢„çƒ­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class HotProductPreheater { @Autowired private SeckillService seckillService; @Autowired private ProductService productService; /** * é¢„çƒ­çƒ­ç‚¹å•†å“ */ @Scheduled(cron = \u0026#34;0 0 0 * * ?\u0026#34;) // æ¯å¤©å‡Œæ™¨æ‰§è¡Œ public void preheatHotProducts() { List\u0026lt;SeckillProduct\u0026gt; hotProducts = productService.getHotProducts(); for (SeckillProduct product : hotProducts) { seckillService.warmUpStock(product.getId()); } log.info(\u0026#34;çƒ­ç‚¹å•†å“é¢„çƒ­å®Œæˆï¼Œé¢„çƒ­å•†å“æ•°é‡ï¼š{}\u0026#34;, hotProducts.size()); } } 9ï¸âƒ£ ç›‘æ§å’Œå‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Component public class SeckillMonitor { @Autowired private MeterRegistry meterRegistry; private final Counter successCounter = Counter.builder(\u0026#34;seckill.success\u0026#34;).register(meterRegistry); private final Counter failCounter = Counter.builder(\u0026#34;seckill.fail\u0026#34;).register(meterRegistry); private final Timer processTimer = Timer.builder(\u0026#34;seckill.process.time\u0026#34;).register(meterRegistry); /** * è®°å½•ç§’æ€æˆåŠŸ */ public void recordSuccess() { successCounter.increment(); } /** * è®°å½•ç§’æ€å¤±è´¥ */ public void recordFail() { failCounter.increment(); } /** * è®°å½•å¤„ç†æ—¶é—´ */ public void recordProcessTime(Duration duration) { processTimer.record(duration); } } ğŸ”Ÿ å‰ç«¯å®ç°ç¤ºä¾‹ 10.1 Vue.js å‰ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;seckill-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;product-info\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;{{ product.name }}\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;ä»·æ ¼ï¼šÂ¥{{ product.price }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;åº“å­˜ï¼š{{ stock }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;seckill-button\u0026#34;\u0026gt; \u0026lt;button v-if=\u0026#34;!isSeckilling \u0026amp;\u0026amp; stock \u0026gt; 0\u0026#34; @click=\u0026#34;startSeckill\u0026#34; :disabled=\u0026#34;isSeckilling\u0026#34; \u0026gt; ç«‹å³ç§’æ€ \u0026lt;/button\u0026gt; \u0026lt;button v-else-if=\u0026#34;isSeckilling\u0026#34; disabled\u0026gt; æ’é˜Ÿä¸­... \u0026lt;/button\u0026gt; \u0026lt;button v-else disabled\u0026gt; å·²å”®ç½„ \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div v-if=\u0026#34;orderResult\u0026#34; class=\u0026#34;result\u0026#34;\u0026gt; \u0026lt;p v-if=\u0026#34;orderResult.success\u0026#34;\u0026gt;ç§’æ€æˆåŠŸï¼è®¢å•å·ï¼š{{ orderResult.orderId }}\u0026lt;/p\u0026gt; \u0026lt;p v-else\u0026gt;{{ orderResult.message }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; export default { data() { return { product: {}, stock: 0, isSeckilling: false, orderResult: null, pollTimer: null } }, mounted() { this.loadProductInfo(); this.startStockPolling(); }, beforeDestroy() { if (this.pollTimer) { clearInterval(this.pollTimer); } }, methods: { async loadProductInfo() { try { const response = await this.$http.get(`/api/product/${this.$route.params.productId}`); this.product = response.data; } catch (error) { console.error(\u0026#39;åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥\u0026#39;, error); } }, async getStock() { try { const response = await this.$http.get(`/api/seckill/stock/${this.$route.params.productId}`); this.stock = response.data; } catch (error) { console.error(\u0026#39;è·å–åº“å­˜å¤±è´¥\u0026#39;, error); } }, startStockPolling() { this.getStock(); this.pollTimer = setInterval(() =\u0026gt; { this.getStock(); }, 1000); }, async startSeckill() { this.isSeckilling = true; this.orderResult = null; try { const response = await this.$http.post(`/api/seckill/${this.$route.params.productId}`, { userId: this.getCurrentUserId() }); if (response.data.success) { this.orderResult = { success: true, orderId: response.data.data }; this.pollOrderResult(response.data.data); } else { this.orderResult = { success: false, message: response.data.message }; } } catch (error) { this.orderResult = { success: false, message: \u0026#39;ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•\u0026#39; }; } finally { this.isSeckilling = false; } }, async pollOrderResult(orderId) { const maxAttempts = 30; // æœ€å¤šè½®è¯¢30æ¬¡ let attempts = 0; const poll = async () =\u0026gt; { try { const response = await this.$http.get(`/api/seckill/result/${orderId}`); if (response.data.success) { this.orderResult = { success: true, orderId: orderId, order: response.data.data }; return; } attempts++; if (attempts \u0026lt; maxAttempts) { setTimeout(poll, 1000); // 1ç§’åé‡è¯• } else { this.orderResult = { success: false, message: \u0026#39;è®¢å•å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥è¯¢\u0026#39; }; } } catch (error) { console.error(\u0026#39;æŸ¥è¯¢è®¢å•ç»“æœå¤±è´¥\u0026#39;, error); attempts++; if (attempts \u0026lt; maxAttempts) { setTimeout(poll, 1000); } } }; poll(); }, getCurrentUserId() { // è·å–å½“å‰ç”¨æˆ·IDçš„é€»è¾‘ return localStorage.getItem(\u0026#39;userId\u0026#39;) || \u0026#39;1\u0026#39;; } } } \u0026lt;/script\u0026gt; 1ï¸âƒ£1ï¸âƒ£ æ€»ç»“ä¸ç›´è§‚æ¯”å–» æ ¸å¿ƒæµç¨‹æ€»ç»“ï¼š å‰ç«¯ï¼šæ‹¿åˆ°\u0026quot;æŠ¢è´­å‡­è¯\u0026quot;ï¼Œæ— éœ€ç›´æ¥ç­‰å¾…æ•°æ®åº“å®Œæˆè®¢å• æ¥å£å±‚ï¼šå¿«é€Ÿåˆ¤æ–­åº“å­˜å’Œç”¨æˆ·èµ„æ ¼ï¼Œå…¥é˜Ÿ â†’ é«˜å¹¶å‘ä¸‹çº¿ç¨‹ä¸è¢«é˜»å¡ åå°ï¼šæ¶ˆè´¹é˜Ÿåˆ— â†’ æ‰£æ•°æ®åº“åº“å­˜ â†’ åˆ›å»ºè®¢å• â†’ é€šçŸ¥ç”¨æˆ· Redis + æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¿è¯åº“å­˜åŸå­æ€§ã€é¡ºåºå¤„ç†ã€ç³»ç»Ÿå¹³ç¨³è¿è¡Œ âš¡ å¼‚æ­¥ç§’æ€çš„æ ¸å¿ƒç†å¿µï¼š å¿«é€Ÿæ¥æ”¶è¯·æ±‚ + æ’é˜Ÿ + å¼‚æ­¥å¤„ç†ï¼Œå®ç°å‰Šå³°å¡«è°·ã€é˜²æ­¢è¶…å–ã€æå‡ç³»ç»Ÿååé‡ã€‚\nğŸ’¡ ç›´è§‚ç±»æ¯”ï¼š å‰ç«¯ç”¨æˆ·ï¼šæ‹¿åˆ°å–é¤å· åå°ç³»ç»Ÿï¼šå¨æˆ¿æŒ‰é¡ºåºåšèœ ç”¨æˆ·æœ€ç»ˆèƒ½æ‹¿åˆ°èœï¼Œä½†ç³»ç»Ÿä¸ä¼šè¢«ç¬æ—¶æµé‡å‹å® æŠ€æœ¯ä¼˜åŠ¿ï¼š é«˜å¹¶å‘å¤„ç†ï¼šRedis + æ¶ˆæ¯é˜Ÿåˆ—å®ç°å‰Šå³°å¡«è°· é˜²æ­¢è¶…å–ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ ç³»ç»Ÿç¨³å®šï¼šå¼‚æ­¥å¤„ç†é¿å…æ•°æ®åº“å‹åŠ› ç”¨æˆ·ä½“éªŒï¼šå¿«é€Ÿå“åº”ï¼Œæ— éœ€é•¿æ—¶é—´ç­‰å¾… å¯æ‰©å±•æ€§ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²å’Œæ°´å¹³æ‰©å±• é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œå®Œæ•´ä»£ç å®ç°ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹å¼‚æ­¥ç§’æ€ç³»ç»Ÿæœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚å¯¹ä»£ç è¿›è¡Œç›¸åº”çš„è°ƒæ•´å’Œä¼˜åŒ–ã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å¼‚æ­¥ç§’æ€ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œä¼˜åŒ–æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ç§’æ€ç³»ç»Ÿã€‚\n","date":"2025-09-10T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%90%ABredis%E9%A2%84%E6%89%A3%E5%BA%93%E5%AD%98%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0/","title":"å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰"},{"content":"åŸºäº Session çš„çŸ­ä¿¡ç™»å½•å®Œæ•´è§£æ åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼ŒçŸ­ä¿¡éªŒè¯ç ç™»å½• æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ— å¯†ç è®¤è¯æ–¹å¼ã€‚å®ƒçš„å¥½å¤„æ˜¯ç®€å•ã€å®‰å…¨ï¼Œç”¨æˆ·åªéœ€è¦è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç å³å¯ç™»å½•ï¼Œè€Œä¸ç”¨è®°å¤æ‚çš„å¯†ç ã€‚\nå¾ˆå¤šåˆå­¦è€…åœ¨å®ç°æ—¶ä¼šæœ‰ç–‘æƒ‘ï¼šéªŒè¯ç å­˜å“ªï¼Ÿæ€ä¹ˆæ¯”å¯¹ï¼Ÿç™»å½•çŠ¶æ€å¦‚ä½•ä¿æŒï¼Ÿ è¿™ç¯‡æ–‡ç« å°†é€šè¿‡æ¨å¯¼çš„æ–¹å¼ï¼Œé€æ­¥è§£é‡Šæ¸…æ¥šï¼Œå¹¶ç»™å‡ºå®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Session è¦ç†è§£çŸ­ä¿¡ç™»å½•ï¼Œå¿…é¡»å…ˆææ¸…æ¥š Session çš„æ¦‚å¿µã€‚\nHTTP åè®®çš„ä¸€ä¸ªæœ€å¤§ç‰¹ç‚¹æ˜¯ï¼šæ— çŠ¶æ€ã€‚\nè¿™æ„å‘³ç€æ¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨éƒ½ä¸ä¼šè®°å¾—ä½ æ˜¯è°ã€‚\nä½†æ˜¯åœ¨å®é™…åº”ç”¨é‡Œï¼Œæˆ‘ä»¬éœ€è¦ï¼š\nç™»å½•ä¹‹åï¼Œä¿æŒç™»å½•çŠ¶æ€ è´­ç‰©è½¦å†…å®¹èƒ½å¤Ÿä¸€ç›´ä¿å­˜ éªŒè¯ç å‘é€åï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°æ ¡éªŒ è¿™æ—¶å€™å°±éœ€è¦ Sessionã€‚\n1.1 Session çš„ç±»æ¯” ä½ å¯ä»¥æŠŠ Session æƒ³è±¡æˆæœåŠ¡å™¨ç»™ç”¨æˆ·å¼€çš„ä¸€é—´å°å‚¨ç‰©æŸœï¼š\nå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼ŒæœåŠ¡å™¨ï¼ˆtomcatï¼‰åˆ†é…ä¸€ä¸ªå‚¨ç‰©æŸœï¼ˆSessionï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ç¼–å·ï¼ˆSession IDï¼‰ æœåŠ¡å™¨æŠŠè¿™ä¸ªç¼–å·å†™åœ¨ä¸€å¼ å°çº¸æ¡ä¸Šï¼ˆCookieï¼‰ï¼Œäº¤ç»™æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ä¿å­˜ ä»¥åæµè§ˆå™¨æ¯æ¬¡è®¿é—®æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šè¿™å¼ å°çº¸æ¡ æœåŠ¡å™¨æ ¹æ®çº¸æ¡ä¸Šçš„ç¼–å·ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å‚¨ç‰©æŸœï¼Œä»é‡Œé¢å–å‡ºå±äºè¯¥ç”¨æˆ·çš„æ•°æ® 1.2 Session vs Cookie ç‰¹æ€§ Cookieï¼ˆå°çº¸æ¡ï¼‰ Sessionï¼ˆå‚¨ç‰©æŸœï¼‰ å­˜å‚¨ä½ç½® æµè§ˆå™¨ç«¯ æœåŠ¡å™¨ç«¯ å®‰å…¨æ€§ è¾ƒä½ï¼ˆå®¹æ˜“è¢«ç¯¡æ”¹ï¼‰ è¾ƒé«˜ï¼ˆç”±æœåŠ¡å™¨ç»´æŠ¤ï¼‰ å®¹é‡ 4KB å·¦å³ å–å†³äºæœåŠ¡å™¨å†…å­˜ ç”Ÿå‘½å‘¨æœŸ å¯è®¾ç½®é•¿æ—¶é—´ä¿å­˜ é»˜è®¤éšæµè§ˆå™¨å…³é—­æˆ–è¶…æ—¶æ¸…é™¤ äºŒã€çŸ­ä¿¡ç™»å½•çš„æ¨å¯¼è¿‡ç¨‹ ç°åœ¨æˆ‘ä»¬æŠŠ Session çš„åŸç†æ”¾åˆ° çŸ­ä¿¡éªŒè¯ç ç™»å½• çš„åœºæ™¯ä¸­ï¼Œæ¥ä¸€æ­¥æ­¥æ¨å¯¼ã€‚\n2.1 ç”¨æˆ·æäº¤æ‰‹æœºå· ç”¨æˆ·åœ¨å‰ç«¯é¡µé¢è¾“å…¥æ‰‹æœºå· å‰ç«¯æŠŠæ‰‹æœºå·å‘é€ç»™åç«¯ 2.2 æœåŠ¡å™¨ç”ŸæˆéªŒè¯ç  åç«¯ç”Ÿæˆä¸€ä¸ª 6 ä½éšæœºæ•°ï¼ˆä¾‹å¦‚ 123456ï¼‰ æŠŠè¿™ä¸ªéªŒè¯ç ä¿å­˜åˆ° Session å‚¨ç‰©æŸœ é‡Œ åŒæ—¶è°ƒç”¨çŸ­ä¿¡æœåŠ¡å•†çš„ APIï¼ŒæŠŠéªŒè¯ç å‘é€åˆ°ç”¨æˆ·æ‰‹æœº æ­¤æ—¶ï¼ŒSession ä¸­ä¿å­˜çš„æ˜¯ï¼š key = \u0026ldquo;SMS_CODE_æ‰‹æœºå·\u0026rdquo; value = \u0026ldquo;123456\u0026rdquo;\n2.3 ç”¨æˆ·è¾“å…¥éªŒè¯ç ç™»å½• ç”¨æˆ·æ”¶åˆ°éªŒè¯ç ï¼Œåœ¨é¡µé¢è¾“å…¥ æµè§ˆå™¨åœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šè‡ªåŠ¨å¸¦ä¸Š Session ID çš„å°çº¸æ¡ï¼ˆCookieï¼‰ åç«¯æ ¹æ® Session ID æ‰¾åˆ°å‚¨ç‰©æŸœï¼Œä»ä¸­å–å‡ºéªŒè¯ç  æ¯”å¯¹ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç ä¸ Session ä¸­ä¿å­˜çš„éªŒè¯ç  ä¸€è‡´ âœ… â†’ ç™»å½•æˆåŠŸ ä¸ä¸€è‡´ âŒ â†’ ç™»å½•å¤±è´¥ ä¸‰ã€ä»£ç å®ç°ç¤ºä¾‹ï¼ˆSpring Bootï¼‰ æ¥ä¸‹æ¥ç”¨ Java + Spring Boot æ¥å®ç°ä¸€ä¸ªæœ€ç®€åŒ–çš„ åŸºäº Session çš„çŸ­ä¿¡ç™»å½•ã€‚\n3.1 å‘é€éªŒè¯ç æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @RestController @RequestMapping(\u0026#34;/auth\u0026#34;) public class SmsLoginController { @PostMapping(\u0026#34;/sendCode\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; sendCode(@RequestParam String phone, HttpSession session) { // ç”Ÿæˆ 6 ä½éªŒè¯ç  String code = String.valueOf((int)((Math.random() * 9 + 1) * 100000)); // æ¨¡æ‹Ÿå‘é€çŸ­ä¿¡ï¼ˆçœŸå®æƒ…å†µéœ€æ¥å…¥çŸ­ä¿¡æœåŠ¡å•† APIï¼‰ System.out.println(\u0026#34;å‘æ‰‹æœºå· \u0026#34; + phone + \u0026#34; å‘é€éªŒè¯ç ï¼š\u0026#34; + code); // ä¿å­˜åˆ° session session.setAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone, code); session.setAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone, System.currentTimeMillis()); return ResponseEntity.ok(\u0026#34;éªŒè¯ç å·²å‘é€\u0026#34;); } } è¯´æ˜ï¼š éªŒè¯ç ä¿å­˜åœ¨ Session ä¸­ï¼Œä¸å­˜å‰ç«¯ å»ºè®®åŒæ—¶ä¿å­˜éªŒè¯ç ç”Ÿæˆæ—¶é—´ï¼Œæ–¹ä¾¿åç»­åˆ¤æ–­æ˜¯å¦è¿‡æœŸ\n3.2 éªŒè¯ç™»å½•æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping(\u0026#34;/login\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; login(@RequestParam String phone, @RequestParam String code, HttpSession session) { String sessionCode = (String) session.getAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); Long codeTime = (Long) session.getAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); if (sessionCode == null) { return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç æœªå‘é€æˆ–å·²è¿‡æœŸ\u0026#34;); } // éªŒè¯æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰ if (System.currentTimeMillis() - codeTime \u0026gt; 5 * 60 * 1000) { session.removeAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); session.removeAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç å·²è¿‡æœŸ\u0026#34;); } if (!sessionCode.equals(code)) { return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç é”™è¯¯\u0026#34;); } // ç™»å½•æˆåŠŸï¼Œå†™å…¥ç”¨æˆ·ç™»å½•çŠ¶æ€ session.setAttribute(\u0026#34;LOGIN_USER\u0026#34;, phone); // æ¸…ç†éªŒè¯ç  session.removeAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); session.removeAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); return ResponseEntity.ok(\u0026#34;ç™»å½•æˆåŠŸ\u0026#34;); } è¯´æ˜ï¼š æ ¸å¿ƒé€»è¾‘åœ¨ åç«¯æ¯”å¯¹ï¼Œå‰ç«¯åªè´Ÿè´£æ”¶é›†è¾“å…¥ éªŒè¯ç è¿‡æœŸæœºåˆ¶å¿…é¡»æœ‰ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨\n3.3 è·å–å½“å‰ç™»å½•ç”¨æˆ·æ¥å£ 1 2 3 4 5 6 7 8 @GetMapping(\u0026#34;/me\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; getUser(HttpSession session) { String phone = (String) session.getAttribute(\u0026#34;LOGIN_USER\u0026#34;); if (phone == null) { return ResponseEntity.status(401).body(\u0026#34;æœªç™»å½•\u0026#34;); } return ResponseEntity.ok(\u0026#34;å½“å‰ç™»å½•ç”¨æˆ·ï¼š\u0026#34; + phone); } å››ã€å…³é”®ç‚¹æ€»ç»“ 1.Session æ˜¯å‚¨ç‰©æŸœï¼ŒCookie æ˜¯å‚¨ç‰©æŸœçš„å–ä»¶å‡­è¯è¯ éªŒè¯ç å­˜æ”¾åœ¨ Sessionï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼Œä¸å­˜æµè§ˆå™¨ æµè§ˆå™¨åªä¿ç•™ Session IDï¼ˆCookieï¼‰ 2.æ¯”å¯¹é€»è¾‘å¿…é¡»åœ¨åç«¯å®Œæˆ å‰ç«¯åªè´Ÿè´£æ”¶é›†å’Œæäº¤æ‰‹æœºå·ã€éªŒè¯ç  æœåŠ¡å™¨æ ¹æ® Session æ‰¾åˆ°éªŒè¯ç å¹¶æ¯”å¯¹ï¼Œå†³å®šæ˜¯å¦ç™»å½• 3.å®‰å…¨æ€§æªæ–½ éªŒè¯ç è¦æœ‰è¿‡æœŸæ—¶é—´ï¼ˆä¸€èˆ¬ 5 åˆ†é’Ÿï¼‰ éªŒè¯ç è¦æœ‰å‘é€é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢è¢«æ¶æ„åˆ· äº”ã€æµç¨‹å›é¡¾ è®©æˆ‘ä»¬å›é¡¾æ•´ä¸ªçŸ­ä¿¡ç™»å½•çš„è¿‡ç¨‹ï¼š 1.ç”¨æˆ·è¾“å…¥æ‰‹æœºå· 2.æœåŠ¡å™¨ç”ŸæˆéªŒè¯ç ï¼Œå­˜åˆ° Sessionï¼Œå¹¶é€šè¿‡çŸ­ä¿¡å‘é€ 3.ç”¨æˆ·æ”¶åˆ°éªŒè¯ç ï¼Œè¾“å…¥åˆ°å‰ç«¯é¡µé¢ 4.æµè§ˆå™¨è¯·æ±‚æ—¶å¸¦ä¸Š Cookieï¼ˆSession IDï¼‰ 5.æœåŠ¡å™¨ç”¨ Session ID æ‰¾åˆ°å‚¨ç‰©æŸœï¼Œå–å‡ºéªŒè¯ç è¿›è¡Œæ¯”å¯¹ ä¸€è‡´ â†’ ç™»å½•æˆåŠŸï¼› ä¸ä¸€è‡´/è¿‡æœŸ â†’ ç™»å½•å¤±è´¥ 6.æ‰©å±•æ€è€ƒ åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒSession å¯èƒ½å­˜æ”¾åœ¨ Redis é‡Œï¼Œä»¥ä¾¿æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚\nå¦å¤–ï¼Œä¹Ÿå¯ä»¥æ›¿ä»£ Sessionï¼Œç”¨ JWTï¼ˆJSON Web Tokenï¼‰ å®ç°æ— çŠ¶æ€çš„ç™»å½•ã€‚ ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ï¼š\néªŒè¯ç å¿…é¡»åœ¨åç«¯ä¿å­˜å’Œæ¯”å¯¹ å‰ç«¯åªè´Ÿè´£å±•ç¤ºå’Œè¾“å…¥ 7.ç»“è¯­ é€šè¿‡ä¸Šé¢çš„æ¨å¯¼ï¼Œæˆ‘ä»¬æŠŠâ€œçŸ­ä¿¡ç™»å½•â€è¿™ä¸ªå¸¸è§éœ€æ±‚ï¼Œå®Œæ•´åœ°æ‹†è§£æˆäº† ä¸šåŠ¡æµç¨‹ + Session åŸç† + å®ç°ä»£ç ã€‚\nå¦‚æœä½ åˆšå¼€å§‹å­¦ä¹ åç«¯å¼€å‘ï¼Œå¸Œæœ›ä½ èƒ½ä»è¿™ç¯‡æ–‡ç« ä¸­çœŸæ­£ç†è§£ï¼š\nä¸ºä»€ä¹ˆè¦ç”¨ Session çŸ­ä¿¡éªŒè¯ç åº”è¯¥å­˜æ”¾åœ¨å“ªé‡Œ éªŒè¯é€»è¾‘ä¸ºä»€ä¹ˆè¦åœ¨åç«¯ è¿™æ ·ï¼Œä¸ç®¡æ˜¯åšä¸€ä¸ªå° demoï¼Œè¿˜æ˜¯å°†æ¥åº”å¯¹ç”Ÿäº§çº§çš„é¡¹ç›®ï¼Œä½ éƒ½èƒ½ä¸¾ä¸€åä¸‰ã€‚\n","date":"2025-08-26T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E5%9F%BA%E4%BA%8E-session-%E7%9A%84%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90/","title":"åŸºäº Session çš„çŸ­ä¿¡ç™»å½•å®Œæ•´è§£æ"},{"content":"æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼ŒRedis ä½œä¸ºç¼“å­˜å±‚ï¼ŒMySQL ä½œä¸ºå­˜å‚¨å±‚çš„ç»„åˆå‡ ä¹æ˜¯æ ‡é…ã€‚Redis çš„é«˜æ€§èƒ½æå¤§ç¼“è§£äº†æ•°æ®åº“çš„å‹åŠ›ï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªæ ¸å¿ƒéš¾é¢˜ï¼šå¦‚ä½•ä¿è¯æ•°æ®åº“ä¸ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næœ¬æ–‡å°†å…¨é¢åˆ†ææ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒ…æ‹¬ ä¸ä¸€è‡´äº§ç”Ÿçš„åŸå› ã€å¸¸è§è§£å†³æ–¹æ¡ˆã€ä¼˜ç¼ºç‚¹åˆ†æã€ä»£ç ç¤ºä¾‹ï¼Œä»¥åŠé€šä¿—çš„ç”Ÿæ´»ç±»æ¯”ã€‚è¯»å®Œæœ¬æ–‡ï¼Œä½ å°†å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ‰ç³»ç»Ÿã€æ·±åˆ»çš„ç†è§£ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆæ•°æ®åº“å’Œç¼“å­˜å¯èƒ½ä¸ä¸€è‡´ï¼Ÿ å¾ˆå¤šäººä¸€å¼€å§‹ä¼šç–‘æƒ‘ï¼šæ•°æ®åº“å’Œç¼“å­˜éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±åœ¨æ§åˆ¶ï¼Œä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´ï¼Ÿ\nå…¶å®ï¼Œé—®é¢˜çš„æ ¹æºåœ¨äº ç¼“å­˜å’Œæ•°æ®åº“æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç³»ç»Ÿï¼Œæ•°æ®åŒæ­¥ä¸æ˜¯åŸå­æ“ä½œï¼Œä¸­é—´å­˜åœ¨æ—¶é—´å·®å’Œå¤±è´¥çš„å¯èƒ½ã€‚\n1.1 å¸¸è§ä¸ä¸€è‡´åŸå›  â‘  å†™æ•°æ®åº“æˆåŠŸï¼Œä½†ç¼“å­˜æ²¡æ›´æ–° åŸå› ï¼šä¸šåŠ¡ä»£ç é‡Œå…ˆå†™æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ã€‚å¦‚æœæ›´æ–°ç¼“å­˜å¤±è´¥ï¼ˆæ¯”å¦‚ Redis å®•æœºæˆ–ç½‘ç»œæŠ–åŠ¨ï¼‰ï¼Œå°±ä¼šå‡ºç° æ•°æ®åº“æ–°å€¼ã€ç¼“å­˜æ—§å€¼ çš„æƒ…å†µã€‚\né€šä¿—ç±»æ¯”ï¼šä½ æ¢äº†æ‰‹æœºå·ç ï¼Œä½†å¿˜äº†å‘Šè¯‰æœ‹å‹ã€‚ç»“æœæœ‹å‹æ‰“ç”µè¯æ—¶ï¼Œè¿˜æ˜¯æ‰“åˆ°ä½ æ—§å·ç ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Service public class UserService { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public void updateUser(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ userMapper.updateById(user); // 2. æ›´æ–°ç¼“å­˜ - è¿™é‡Œå¯èƒ½å¤±è´¥ï¼ redisTemplate.opsForValue().set(\u0026#34;user:\u0026#34; + user.getId(), user); } catch (Exception e) { // å¦‚æœç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œæ•°æ®åº“å·²ç»æ›´æ–°äº†ï¼Œä½†ç¼“å­˜è¿˜æ˜¯æ—§å€¼ log.error(\u0026#34;æ›´æ–°ç¼“å­˜å¤±è´¥\u0026#34;, e); } } } â‘¡ æ›´æ–°é¡ºåºå¯¼è‡´çš„é—®é¢˜ å†™æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ï¼šå¦‚æœå†™æ•°æ®åº“æˆåŠŸï¼Œä½†åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œé‚£ä¹ˆç¼“å­˜é‡Œä¾æ—§æ˜¯æ—§æ•°æ®ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¼šç›´æ¥æ‹¿æ—§ç¼“å­˜ã€‚\nåˆ é™¤ç¼“å­˜ â†’ å†™æ•°æ®åº“ï¼šå¦‚æœåœ¨åˆ é™¤ç¼“å­˜åã€å†™æ•°æ®åº“å‰ï¼Œæ°å¥½æœ‰è¯·æ±‚æŸ¥è¯¢æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿ ç¼“å­˜å›å¡«æ—§å€¼ çš„é—®é¢˜ã€‚\né€šä¿—ç±»æ¯”ï¼š\nä½ è¦æ¢å®¶é‡Œçš„é”ã€‚ æ–¹æ¡ˆä¸€ï¼ˆå…ˆæ¢é”ï¼Œå†æ‰”æ—§é’¥åŒ™ï¼‰ï¼šå®‰å…¨ï¼Œä½†ä¸‡ä¸€æ‰”é’¥åŒ™æ—¶æ‰‹æ»‘æ²¡æ‰”æ‰ï¼ˆç¼“å­˜æ²¡åˆ æ‰ï¼‰ï¼Œåˆ«äººè¿˜èƒ½ç”¨æ—§é’¥åŒ™å¼€é—¨ã€‚ æ–¹æ¡ˆäºŒï¼ˆå…ˆæ‰”é’¥åŒ™ï¼Œå†æ¢é”ï¼‰ï¼šåœ¨ä½ æ¢é”çš„å‡ åˆ†é’Ÿé‡Œï¼Œåˆ«äººå¯èƒ½æ­£å¥½ç”¨æ—§é’¥åŒ™å¼€é—¨ï¼ˆç¼“å­˜è¢«æ—§å€¼å›å¡«ï¼‰ã€‚ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // æ–¹æ¡ˆä¸€ï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜ public void updateUserV1(User user) { // 1. æ›´æ–°æ•°æ®åº“ userMapper.updateById(user); // 2. åˆ é™¤ç¼“å­˜ - å¯èƒ½å¤±è´¥ try { redisTemplate.delete(\u0026#34;user:\u0026#34; + user.getId()); } catch (Exception e) { // åˆ é™¤å¤±è´¥ï¼Œç¼“å­˜è¿˜æ˜¯æ—§å€¼ log.error(\u0026#34;åˆ é™¤ç¼“å­˜å¤±è´¥\u0026#34;, e); } } // æ–¹æ¡ˆäºŒï¼šå…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“ public void updateUserV2(User user) { // 1. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;user:\u0026#34; + user.getId()); // 2. æ›´æ–°æ•°æ®åº“ - åœ¨åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´ï¼Œå¯èƒ½æœ‰æŸ¥è¯¢è¯·æ±‚å›å¡«æ—§å€¼ userMapper.updateById(user); } â‘¢ å¹¶å‘è¦†ç›–é—®é¢˜ åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶ä¿®æ”¹åŒä¸€æ¡æ•°æ®ï¼Œå¯èƒ½å‡ºç°è¦†ç›–ã€‚\nåœºæ™¯ä¸¾ä¾‹ï¼š\nè¯·æ±‚ Aï¼šæ›´æ–°ç”¨æˆ·ä½™é¢ä¸º 100 â†’ æ›´æ–°æ•°æ®åº“æˆåŠŸ â†’ åˆ é™¤ç¼“å­˜ è¯·æ±‚ Bï¼šæ›´æ–°ç”¨æˆ·ä½™é¢ä¸º 200 â†’ æ›´æ–°æ•°æ®åº“æˆåŠŸ â†’ åˆ é™¤ç¼“å­˜ è¯·æ±‚ A çº¿ç¨‹è¾ƒæ…¢ï¼Œåœ¨ B æ›´æ–°å®Œæˆååˆå›å¡«äº† 100 åˆ°ç¼“å­˜ ç»“æœï¼šæ•°æ®åº“æ˜¯ 200ï¼Œç¼“å­˜å´æ˜¯ 100ï¼Œäº§ç”Ÿäº†è„æ•°æ®ã€‚ é€šä¿—ç±»æ¯”ï¼šä¸¤ä¸ªäººåŒæ—¶å¾€ä¸€ä¸ªæ–‡æ¡£é‡Œå†™æ•°æ®ã€‚ç”²å†™äº†æ–°ç‰ˆå†…å®¹ï¼Œä¹™å†™å®Œæ—§ç‰ˆåä¿å­˜ï¼Œæœ€ç»ˆçš„æ–‡æ¡£è¢«ä¹™è¦†ç›–ï¼Œç”²çš„ä¿®æ”¹æ¶ˆå¤±ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Service public class AccountService { @Autowired private AccountMapper accountMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; // å¹¶å‘æ›´æ–°ä½™é¢çš„é—®é¢˜ç¤ºä¾‹ public void updateBalance(Long userId, BigDecimal amount) { // 1. æŸ¥è¯¢å½“å‰ä½™é¢ Account account = accountMapper.selectById(userId); // 2. è®¡ç®—æ–°ä½™é¢ BigDecimal newBalance = account.getBalance().add(amount); account.setBalance(newBalance); // 3. æ›´æ–°æ•°æ®åº“ accountMapper.updateById(account); // 4. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;account:\u0026#34; + userId); // é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå¯èƒ½å‡ºç°è¦†ç›– } // æŸ¥è¯¢ä½™é¢ public BigDecimal getBalance(Long userId) { // 1. å…ˆæŸ¥ç¼“å­˜ String cacheKey = \u0026#34;account:\u0026#34; + userId; BigDecimal balance = (BigDecimal) redisTemplate.opsForValue().get(cacheKey); if (balance != null) { return balance; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ Account account = accountMapper.selectById(userId); balance = account.getBalance(); // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, balance, 30, TimeUnit.MINUTES); return balance; } } â‘£ ç¼“å­˜å›å¡«é—®é¢˜ å½“ç¼“å­˜è¿‡æœŸæˆ–è¢«åˆ é™¤æ—¶ï¼Œå¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢ï¼Œä¼šå‡ºç° ç¼“å­˜å‡»ç©¿ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚å¦‚æœæ•°æ®åº“çš„æ•°æ®æ°å¥½æ­£åœ¨è¢«æ›´æ–°ï¼Œå°±å¯èƒ½å›å¡«æ—§å€¼åˆ°ç¼“å­˜ã€‚\né€šä¿—ç±»æ¯”ï¼šå¤§å®¶éƒ½åœ¨æŸ¥å¿«é€’å•å·ã€‚ç¼“å­˜é‡Œè¿‡æœŸäº†ï¼Œå¤§å®¶éƒ½å»é—®å¿«é€’å…¬å¸ã€‚æ­£å¥½å¿«é€’å…¬å¸ç³»ç»Ÿè¿˜æ²¡æ›´æ–°ï¼Œæœ‰äººæŠŠæ—§çš„ç‰©æµä¿¡æ¯æ‹¿å›æ¥ï¼Œåˆé‡æ–°å­˜è¿›ç¼“å­˜ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Service public class ProductService { @Autowired private ProductMapper productMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public Product getProduct(Long productId) { String cacheKey = \u0026#34;product:\u0026#34; + productId; // 1. å…ˆæŸ¥ç¼“å­˜ Product product = (Product) redisTemplate.opsForValue().get(cacheKey); if (product != null) { return product; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ product = productMapper.selectById(productId); // 3. å›å¡«ç¼“å­˜ - è¿™é‡Œå¯èƒ½å›å¡«æ—§å€¼ if (product != null) { redisTemplate.opsForValue().set(cacheKey, product, 30, TimeUnit.MINUTES); } return product; } public void updateProduct(Product product) { // 1. æ›´æ–°æ•°æ®åº“ productMapper.updateById(product); // 2. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;product:\u0026#34; + product.getId()); // é—®é¢˜ï¼šåœ¨åˆ é™¤ç¼“å­˜åï¼Œå¦‚æœæœ‰æŸ¥è¯¢è¯·æ±‚ï¼Œå¯èƒ½å›å¡«æ—§å€¼ } } â‘¤ å¼‚å¸¸æˆ–æ¶ˆæ¯ä¸¢å¤± åœ¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ã€Binlog åŒæ­¥çš„åœºæ™¯é‡Œï¼Œå¦‚æœæ¶ˆæ¯ä¸¢å¤±æˆ–æ¶ˆè´¹å¤±è´¥ï¼Œä¹Ÿä¼šé€ æˆæ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´ã€‚\né€šä¿—ç±»æ¯”ï¼šä½ è®©æœ‹å‹å¸®å¿™è½¬å‘Šä¸€ä¸ªä¿¡æ¯ã€‚å¦‚æœæœ‹å‹å¿˜äº†è¯´ï¼ˆæ¶ˆæ¯ä¸¢äº†ï¼‰ï¼Œæ¥æ”¶æ–¹å°±æ°¸è¿œæ‹¿ä¸åˆ°æœ€æ–°æ•°æ®ã€‚\nå°ç»“ æ•°æ®åº“ä¸ç¼“å­˜çš„ä¸ä¸€è‡´ï¼Œå½’æ ¹åˆ°åº•æ˜¯å› ä¸º æ›´æ–°ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå†åŠ ä¸Š ç½‘ç»œã€å¹¶å‘ã€å»¶è¿Ÿã€å¼‚å¸¸ ç­‰å› ç´ ï¼Œå¯¼è‡´ä¸åŒæ­¥ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹å¸¸è§çš„è§£å†³æ–¹æ¡ˆã€‚\näºŒã€å¸¸è§åŒæ­¥ç­–ç•¥ä¸å®ç° 2.1 Cache Asideï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰ è¿™æ˜¯æœ€å¸¸è§çš„ç¼“å­˜ç­–ç•¥ï¼š\nè¯»ï¼šå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜æ²¡æœ‰å°±è¯»æ•°æ®åº“ï¼Œç„¶åå›å¡«åˆ°ç¼“å­˜ã€‚ å†™ï¼šæ›´æ–°æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ç¼“å­˜ã€‚ æµç¨‹å›¾ 1 2 3 4 è¯»è¯·æ±‚ï¼š å…ˆæŸ¥ç¼“å­˜ â†’ ç¼“å­˜å‘½ä¸­ â†’ è¿”å› ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å› å†™è¯·æ±‚ï¼š å…ˆå†™æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ ä¼˜ç‚¹ ç®€å•æ˜“å®ç° æ›´æ–°é¢‘ç‡ä½ã€è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹æ€§èƒ½å¥½ ç¼ºç‚¹ å†™ååˆ é™¤ç¼“å­˜ä¸æ˜¯åŸå­æ“ä½œï¼Œå¯èƒ½äº§ç”Ÿä¸ä¸€è‡´ åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´æœ‰çª—å£æœŸï¼Œå®¹æ˜“è¢«å¹¶å‘è¦†ç›– é€šä¿—ç±»æ¯” ä½ è®°ä¸ä½æœ‹å‹çš„æ‰‹æœºå·ï¼ˆæ•°æ®åº“ï¼‰ï¼Œäºæ˜¯å†™åœ¨çº¸æ¡ä¸Šæ”¾åœ¨å£è¢‹é‡Œï¼ˆç¼“å­˜ï¼‰ã€‚æ¯æ¬¡æŸ¥å·ç æ—¶ï¼Œå…ˆæ‘¸å£è¢‹ã€‚å¦‚æœå·ç å˜äº†ï¼Œä½ æ”¹æ‰‹æœºé€šè®¯å½•ï¼ˆæ•°æ®åº“ï¼‰ï¼Œç„¶åæŠŠçº¸æ¡æ‰”æ‰ï¼ˆåˆ ç¼“å­˜ï¼‰ã€‚ä¸‹æ¬¡å†æœ‰äººé—®ï¼Œå°±ä¼šä»æ‰‹æœºæŸ¥å‡ºæ–°å·ç ï¼Œå†æŠ„ä¸€å¼ æ–°çº¸æ¡ã€‚\nä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 @Service public class UserService { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final int CACHE_EXPIRE_TIME = 30; // åˆ†é’Ÿ /** * æŸ¥è¯¢ç”¨æˆ· - Cache Aside è¯»ç­–ç•¥ */ public User getUser(Long userId) { String cacheKey = USER_CACHE_PREFIX + userId; // 1. å…ˆæŸ¥ç¼“å­˜ User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { log.info(\u0026#34;ç¼“å­˜å‘½ä¸­ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ log.info(\u0026#34;ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, CACHE_EXPIRE_TIME, TimeUnit.MINUTES); log.info(\u0026#34;æ•°æ®å›å¡«ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } return user; } /** * æ›´æ–°ç”¨æˆ· - Cache Aside å†™ç­–ç•¥ */ @Transactional public boolean updateUser(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * åˆ é™¤ç”¨æˆ· */ @Transactional public boolean deleteUser(Long userId) { try { // 1. åˆ é™¤æ•°æ®åº“è®°å½• int result = userMapper.deleteById(userId); if (result \u0026lt;= 0) { log.warn(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + userId; redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return true; } catch (Exception e) { log.error(\u0026#34;åˆ é™¤ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); throw new RuntimeException(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } } 2.2 å»¶æ—¶åŒåˆ ç­–ç•¥ åœ¨ å†™æ•°æ®åº“ + åˆ é™¤ç¼“å­˜ çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€æ¬¡å»¶æ—¶åˆ é™¤ã€‚\n1 2 3 4 updateDB(); delCache(); Thread.sleep(500); delCache(); ä¸ºä»€ä¹ˆè¦å¤šåˆ ä¸€æ¬¡ï¼Ÿ å› ä¸ºç¬¬ä¸€æ¬¡åˆ ç¼“å­˜åï¼Œå¯èƒ½æœ‰å¹¶å‘è¯·æ±‚æŸ¥è¯¢ï¼Œå›å¡«äº†æ—§å€¼ã€‚ç¬¬äºŒæ¬¡å»¶è¿Ÿåˆ é™¤ï¼Œå¯ä»¥æŠŠæ—§å€¼å†æ¸…ç†æ‰ã€‚\nä¼˜ç‚¹ æ€è·¯ç®€å•ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£å¹¶å‘è¦†ç›–é—®é¢˜ ç¼ºç‚¹ å»¶è¿Ÿæ—¶é—´ä¸å¥½ç¡®å®šï¼Œæ—¶é—´è¿‡é•¿ â†’ è„æ•°æ®å­˜åœ¨å¤ªä¹…ï¼›æ—¶é—´è¿‡çŸ­ â†’ è¦†ç›–é—®é¢˜ä»å¯èƒ½å‘ç”Ÿ ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ é€šä¿—ç±»æ¯” ä½ æ¢äº†é—¨é”ã€‚å…ˆæŠŠæ—§é’¥åŒ™æ”¶èµ°ï¼ˆåˆ ç¼“å­˜ï¼‰ã€‚ä½†æ‹…å¿ƒæœ‰äººæ‰‹é‡Œè¿˜æœ‰å¤‡ä»½é’¥åŒ™ï¼Œäºæ˜¯è¿‡å‡ åˆ†é’Ÿå†æ¥æ£€æŸ¥ä¸€æ¬¡ï¼ŒæŠŠå¯èƒ½å†’å‡ºæ¥çš„æ—§é’¥åŒ™ä¹Ÿæ”¶èµ°ã€‚\nä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 @Service public class UserServiceWithDelayDoubleDelete { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private ThreadPoolTaskExecutor taskExecutor; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final int DELAY_TIME = 500; // æ¯«ç§’ /** * å»¶æ—¶åŒåˆ ç­–ç•¥æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithDelayDoubleDelete(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { return false; } // 2. ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); // 3. å¼‚æ­¥å»¶æ—¶åˆ é™¤ç¼“å­˜ taskExecutor.execute(() -\u0026gt; { try { Thread.sleep(DELAY_TIME); redisTemplate.delete(cacheKey); log.info(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜å®Œæˆï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜è¢«ä¸­æ–­ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); } catch (Exception e) { log.error(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); } }); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * æŸ¥è¯¢ç”¨æˆ· */ public User getUser(Long userId) { String cacheKey = USER_CACHE_PREFIX + userId; // 1. å…ˆæŸ¥ç¼“å­˜ User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); } return user; } } 2.3 åŠ é”ç­–ç•¥ï¼ˆè¯»å†™é”ã€åˆ†å¸ƒå¼é”ï¼‰ é€šè¿‡åŠ é”æ¥ä¿è¯å†™æ“ä½œå’Œè¯»æ“ä½œçš„äº’æ–¥ï¼Œé¿å…å¹¶å‘ä¸ä¸€è‡´ã€‚\nè¯»å†™é” è¯»é”ï¼ˆå…±äº«é”ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½å†™ã€‚ å†™é”ï¼ˆæ’ä»–é”ï¼‰ï¼šå†™æ—¶ç‹¬å ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ã€‚ ä»£ç å®ç°ï¼ˆRedisson å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 @Service public class UserServiceWithLock { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RedissonClient redissonClient; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String LOCK_PREFIX = \u0026#34;lock:user:\u0026#34;; /** * ä½¿ç”¨è¯»å†™é”æŸ¥è¯¢ç”¨æˆ· */ public User getUserWithReadLock(Long userId) { String lockKey = LOCK_PREFIX + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock readLock = rwLock.readLock(); try { readLock.lock(); // 1. å…ˆæŸ¥ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + userId; User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { log.info(\u0026#34;ç¼“å­˜å‘½ä¸­ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ log.info(\u0026#34;ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;æ•°æ®å›å¡«ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } return user; } finally { readLock.unlock(); } } /** * ä½¿ç”¨å†™é”æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithWriteLock(User user) { String lockKey = LOCK_PREFIX + user.getId(); RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock writeLock = rwLock.writeLock(); try { writeLock.lock(); // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } finally { writeLock.unlock(); } } /** * ä½¿ç”¨åˆ†å¸ƒå¼é”æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithDistributedLock(User user) { String lockKey = LOCK_PREFIX + user.getId(); RLock lock = redissonClient.getLock(lockKey); try { // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”æŒæœ‰æ—¶é—´30ç§’ boolean acquired = lock.tryLock(10, 30, TimeUnit.SECONDS); if (!acquired) { log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;è·å–åˆ†å¸ƒå¼é”è¢«ä¸­æ–­ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); return false; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } } ä¼˜ç‚¹ èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œé¿å…è„è¯»ã€è„å†™ ç‰¹åˆ«é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ ç¼ºç‚¹ æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œé«˜å¹¶å‘ä¸‹å®¹æ˜“æˆä¸ºç“¶é¢ˆ å¦‚æœé”é‡Šæ”¾å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´æ­»é” é€šä¿—ç±»æ¯” å›¾ä¹¦é¦†å€Ÿä¹¦ï¼šå¤šä¸ªäººåŒæ—¶çœ‹åŒä¸€æœ¬ä¹¦æ²¡é—®é¢˜ï¼ˆè¯»è¯»ä¸äº’æ–¥ï¼‰ã€‚å¦‚æœæœ‰äººè¦åœ¨ä¹¦ä¸Šå†™ç¬”è®°ï¼ˆå†™æ“ä½œï¼‰ï¼Œé‚£å¿…é¡»ç‹¬å è¿™æœ¬ä¹¦ï¼Œåˆ«äººä¸èƒ½å†çœ‹ï¼ˆè¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ï¼‰ã€‚\n2.4 æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ æ›´æ–°æ•°æ®åº“åï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ›´æ–°äº‹ä»¶ï¼Œæ¶ˆè´¹è€…è®¢é˜…åæ›´æ–°ç¼“å­˜ã€‚\nä»£ç å®ç° ç”Ÿäº§è€…ï¼ˆæ›´æ–°æ•°æ®åº“åå‘é€æ¶ˆæ¯ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 @Service public class UserServiceWithMQ { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RabbitTemplate rabbitTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String USER_UPDATE_QUEUE = \u0026#34;user.update.queue\u0026#34;; private static final String USER_DELETE_QUEUE = \u0026#34;user.delete.queue\u0026#34;; /** * æ›´æ–°ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ */ @Transactional public boolean updateUserWithMQ(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { return false; } // 2. å‘é€æ›´æ–°æ¶ˆæ¯ UserUpdateEvent event = new UserUpdateEvent(); event.setUserId(user.getId()); event.setOperation(\u0026#34;UPDATE\u0026#34;); event.setTimestamp(System.currentTimeMillis()); rabbitTemplate.convertAndSend(USER_UPDATE_QUEUE, event); log.info(\u0026#34;å‘é€ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * åˆ é™¤ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ */ @Transactional public boolean deleteUserWithMQ(Long userId) { try { // 1. åˆ é™¤æ•°æ®åº“è®°å½• int result = userMapper.deleteById(userId); if (result \u0026lt;= 0) { return false; } // 2. å‘é€åˆ é™¤æ¶ˆæ¯ UserDeleteEvent event = new UserDeleteEvent(); event.setUserId(userId); event.setOperation(\u0026#34;DELETE\u0026#34;); event.setTimestamp(System.currentTimeMillis()); rabbitTemplate.convertAndSend(USER_DELETE_QUEUE, event); log.info(\u0026#34;å‘é€ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return true; } catch (Exception e) { log.error(\u0026#34;åˆ é™¤ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); throw new RuntimeException(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } } // äº‹ä»¶ç±» @Data public class UserUpdateEvent { private Long userId; private String operation; private Long timestamp; } @Data public class UserDeleteEvent { private Long userId; private String operation; private Long timestamp; } æ¶ˆè´¹è€…ï¼ˆå¤„ç†æ¶ˆæ¯å¹¶æ›´æ–°ç¼“å­˜ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component public class UserCacheConsumer { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; /** * å¤„ç†ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;user.update.queue\u0026#34;) public void handleUserUpdate(UserUpdateEvent event) { try { log.info(\u0026#34;æ”¶åˆ°ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); // 1. æŸ¥è¯¢æœ€æ–°æ•°æ® User user = userMapper.selectById(event.getUserId()); if (user != null) { // 2. æ›´æ–°ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;ç¼“å­˜æ›´æ–°æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } else { // 3. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + event.getUserId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ é™¤ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); } } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç”¨æˆ·æ›´æ–°æ¶ˆæ¯å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId(), e); // è¿™é‡Œå¯ä»¥å®ç°é‡è¯•æœºåˆ¶æˆ–æ­»ä¿¡é˜Ÿåˆ— } } /** * å¤„ç†ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;user.delete.queue\u0026#34;) public void handleUserDelete(UserDeleteEvent event) { try { log.info(\u0026#34;æ”¶åˆ°ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); // åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + event.getUserId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç¼“å­˜åˆ é™¤æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç”¨æˆ·åˆ é™¤æ¶ˆæ¯å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId(), e); } } } ä¼˜ç‚¹ æ•°æ®åº“ä¸ç¼“å­˜è§£è€¦ï¼Œä¿è¯å¼‚æ­¥æœ€ç»ˆä¸€è‡´æ€§ èƒ½æ‰¿å—æ›´é«˜çš„å¹¶å‘é‡ ç¼ºç‚¹ å¼•å…¥ MQ å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ æ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤æ¶ˆè´¹éœ€è¦é¢å¤–å¤„ç† é€šä¿—ç±»æ¯” ä½ æ¬å®¶äº†ï¼Œå…ˆåœ¨ç³»ç»Ÿé‡Œæ”¹äº†åœ°å€ï¼ˆæ•°æ®åº“ï¼‰ã€‚ç³»ç»Ÿå‘äº†ä¸€æ¡é€šçŸ¥ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œå‘Šè¯‰å¿«é€’å…¬å¸æ›´æ–°æ”¶ä»¶åœ°å€ï¼ˆç¼“å­˜ï¼‰ã€‚\n2.5 åŸºäº Binlog çš„ Canal åŒæ­¥ é€šè¿‡ç›‘å¬ MySQL çš„ Binlogï¼Œæ•è·æ•°æ®å˜æ›´äº‹ä»¶ï¼Œç„¶åæ›´æ–° Redisã€‚\næµç¨‹ MySQL å¼€å¯ Binlog Canal ä½œä¸ºä»åº“ä¼ªè£…ï¼Œè®¢é˜… Binlog Binlog é‡Œè®°å½•äº† INSERT/UPDATE/DELETE Canal è§£æäº‹ä»¶å¹¶å›å†™ Redis ä»£ç å®ç° Canal é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # canal.properties canal.port = 11111 canal.metrics.pull.port = 11112 canal.zkServers = localhost:2181 # å®ä¾‹é…ç½® canal.destinations = example canal.conf.dir = /opt/canal/conf canal.instance.global.master.address = 127.0.0.1:3306 canal.instance.global.master.journal.name = canal.instance.global.master.position = canal.instance.global.master.timestamp = canal.instance.global.master.gtid = canal.instance.dbUsername = canal canal.instance.dbPassword = canal canal.instance.connectionCharset = UTF-8 canal.instance.filter.regex = .*\\\\..* canal.instance.master.address = 127.0.0.1:3306 canal.instance.master.journal.name = canal.instance.master.position = canal.instance.master.timestamp = canal.instance.master.gtid = Canal å®¢æˆ·ç«¯ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 @Component public class CanalClient { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String USER_TABLE = \u0026#34;t_user\u0026#34;; @PostConstruct public void startCanalClient() { // åˆ›å»ºCanalè¿æ¥ CanalConnector connector = CanalConnectors.newSingleConnector( new InetSocketAddress(\u0026#34;127.0.0.1\u0026#34;, 11111), \u0026#34;example\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34; ); try { connector.connect(); connector.subscribe(\u0026#34;.*\\\\..*\u0026#34;); connector.rollback(); while (true) { Message message = connector.getWithoutAck(1000); long batchId = message.getBatchId(); int size = message.getEntries().size(); if (batchId == -1 || size == 0) { Thread.sleep(1000); } else { printEntry(message.getEntries()); connector.ack(batchId); } } } catch (Exception e) { log.error(\u0026#34;Canalå®¢æˆ·ç«¯å¼‚å¸¸\u0026#34;, e); } finally { connector.disconnect(); } } private void printEntry(List\u0026lt;Entry\u0026gt; entries) { for (Entry entry : entries) { if (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) { continue; } RowChange rowChange = null; try { rowChange = RowChange.parseFrom(entry.getStoreValue()); } catch (Exception e) { throw new RuntimeException(\u0026#34;è§£æbinlogå¼‚å¸¸\u0026#34;, e); } EventType eventType = rowChange.getEventType(); String tableName = entry.getHeader().getTableName(); // åªå¤„ç†ç”¨æˆ·è¡¨ if (!USER_TABLE.equals(tableName)) { continue; } for (RowData rowData : rowChange.getRowDatasList()) { if (eventType == EventType.DELETE) { handleDelete(rowData.getBeforeColumnsList()); } else if (eventType == EventType.INSERT) { handleInsert(rowData.getAfterColumnsList()); } else if (eventType == EventType.UPDATE) { handleUpdate(rowData.getAfterColumnsList()); } } } } private void handleInsert(List\u0026lt;Column\u0026gt; columns) { try { User user = buildUserFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;CanalåŒæ­¥æ–°å¢ç”¨æˆ·åˆ°ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ–°å¢ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private void handleUpdate(List\u0026lt;Column\u0026gt; columns) { try { User user = buildUserFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;CanalåŒæ­¥æ›´æ–°ç”¨æˆ·åˆ°ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ›´æ–°ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private void handleDelete(List\u0026lt;Column\u0026gt; columns) { try { Long userId = getUserIdFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + userId; redisTemplate.delete(cacheKey); log.info(\u0026#34;CanalåŒæ­¥åˆ é™¤ç”¨æˆ·ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } catch (Exception e) { log.error(\u0026#34;å¤„ç†åˆ é™¤ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private User buildUserFromColumns(List\u0026lt;Column\u0026gt; columns) { User user = new User(); for (Column column : columns) { String name = column.getName(); String value = column.getValue(); switch (name) { case \u0026#34;id\u0026#34;: user.setId(Long.valueOf(value)); break; case \u0026#34;username\u0026#34;: user.setUsername(value); break; case \u0026#34;email\u0026#34;: user.setEmail(value); break; case \u0026#34;phone\u0026#34;: user.setPhone(value); break; case \u0026#34;create_time\u0026#34;: user.setCreateTime(LocalDateTime.parse(value)); break; case \u0026#34;update_time\u0026#34;: user.setUpdateTime(LocalDateTime.parse(value)); break; } } return user; } private Long getUserIdFromColumns(List\u0026lt;Column\u0026gt; columns) { for (Column column : columns) { if (\u0026#34;id\u0026#34;.equals(column.getName())) { return Long.valueOf(column.getValue()); } } return null; } } ä¼˜ç‚¹ æ•°æ®åº“æ˜¯æœ€ç»ˆæ•°æ®æºï¼ŒCanal ä¿è¯æ•°æ®åº“å’Œç¼“å­˜é«˜åº¦ä¸€è‡´ é€‚åˆå¼ºä¸€è‡´æ€§ã€è¯»å†™é¢‘ç¹çš„åœºæ™¯ ç¼ºç‚¹ Canal éƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ å®æ—¶æ€§å–å†³äº Binlog è§£æå’Œæ¶ˆè´¹é€Ÿåº¦ é€šä¿—ç±»æ¯” å°±åƒä½ ç»™å®¶é‡Œè£…äº†ä¸€ä¸ªç›‘æ§ï¼ˆCanalï¼‰ï¼Œæ¯æ¬¡æœ‰äººå¼€é—¨æ¢é”ï¼ˆæ•°æ®åº“æ›´æ–°ï¼‰ï¼Œç›‘æ§ç«‹åˆ»é€šçŸ¥ä¿å®‰ï¼ˆRedis æ›´æ–°ï¼‰ã€‚\nä¸‰ã€æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“ æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ é«˜ ä½ è¯»å¤šå†™å°‘ï¼Œæ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´ å»¶æ—¶åŒåˆ  è¾ƒå¼ºä¸€è‡´æ€§ ä¸­ ä¸­ èƒ½å®¹å¿çŸ­å»¶è¿Ÿï¼Œå†™è¯·æ±‚è¾ƒå¤šæ—¶ åŠ é”ç­–ç•¥ å¼ºä¸€è‡´æ€§ ä½ ä¸­ é‡‘èã€ç”µå•†ç­‰å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ æœ€ç»ˆä¸€è‡´æ€§ é«˜ é«˜ é«˜å¹¶å‘ã€å¼‚æ­¥åœºæ™¯ Canal Binlog åŒæ­¥ å‡†å®æ—¶å¼ºä¸€è‡´æ€§ ä¸­ é«˜ æ ¸å¿ƒä¸šåŠ¡ï¼Œå¼ºä¸€è‡´è¦æ±‚ å››ã€æœ€ä½³å®è·µå»ºè®® è¯»å¤šå†™å°‘ï¼Œæ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´ â†’ ä½¿ç”¨ Cache Aside é«˜å¹¶å‘å†™åœºæ™¯ â†’ å»¶æ—¶åŒåˆ  + åˆç†æ—¶é—´çª—å£ é‡‘èã€äº¤æ˜“ä¸šåŠ¡ â†’ åˆ†å¸ƒå¼è¯»å†™é”ï¼Œä¿è¯å¼ºä¸€è‡´æ€§ é«˜å¯æ‰©å±•ã€é«˜å¹¶å‘ â†’ æ•°æ®åº“å†™ + MQ å¼‚æ­¥æ›´æ–°ç¼“å­˜ ä¼ä¸šçº§æ ¸å¿ƒä¸šåŠ¡ â†’ Binlog + Canalï¼Œä¿è¯æ•°æ®åº“ä¸ç¼“å­˜å®æ—¶åŒæ­¥ äº”ã€å®é™…é¡¹ç›®ä¸­çš„ç»¼åˆæ–¹æ¡ˆ åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¾€å¾€éœ€è¦æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 @Service public class UserServiceComprehensive { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RedissonClient redissonClient; @Autowired private RabbitTemplate rabbitTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String LOCK_PREFIX = \u0026#34;lock:user:\u0026#34;; /** * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„ç¼“å­˜ç­–ç•¥ */ public User getUser(Long userId, CacheStrategy strategy) { switch (strategy) { case CACHE_ASIDE: return getUserWithCacheAside(userId); case READ_WRITE_LOCK: return getUserWithReadWriteLock(userId); case MQ_SYNC: return getUserWithMQSync(userId); default: return getUserWithCacheAside(userId); } } /** * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„æ›´æ–°ç­–ç•¥ */ public boolean updateUser(User user, CacheStrategy strategy) { switch (strategy) { case CACHE_ASIDE: return updateUserWithCacheAside(user); case DELAY_DOUBLE_DELETE: return updateUserWithDelayDoubleDelete(user); case READ_WRITE_LOCK: return updateUserWithReadWriteLock(user); case MQ_SYNC: return updateUserWithMQSync(user); default: return updateUserWithCacheAside(user); } } // å„ç§ç­–ç•¥çš„å…·ä½“å®ç°... } enum CacheStrategy { CACHE_ASIDE, // æ—è·¯ç¼“å­˜ DELAY_DOUBLE_DELETE, // å»¶æ—¶åŒåˆ  READ_WRITE_LOCK, // è¯»å†™é” MQ_SYNC, // æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ CANAL_SYNC // CanalåŒæ­¥ } å…­ã€ç›‘æ§å’Œå‘Šè­¦ ä¸ºäº†ä¿è¯ç¼“å­˜ä¸€è‡´æ€§ï¼Œè¿˜éœ€è¦å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 @Component public class CacheConsistencyMonitor { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private UserMapper userMapper; /** * å®šæœŸæ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§ */ @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ public void checkCacheConsistency() { // éšæœºæŠ½æ ·æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§ List\u0026lt;Long\u0026gt; userIds = getRandomUserIds(100); for (Long userId : userIds) { try { // 1. æŸ¥è¯¢æ•°æ®åº“ User dbUser = userMapper.selectById(userId); // 2. æŸ¥è¯¢ç¼“å­˜ String cacheKey = \u0026#34;user:\u0026#34; + userId; User cacheUser = (User) redisTemplate.opsForValue().get(cacheKey); // 3. æ¯”è¾ƒæ•°æ® if (dbUser != null \u0026amp;\u0026amp; cacheUser != null) { if (!Objects.equals(dbUser.getUsername(), cacheUser.getUsername()) || !Objects.equals(dbUser.getEmail(), cacheUser.getEmail())) { // æ•°æ®ä¸ä¸€è‡´ï¼Œè®°å½•å‘Šè­¦ log.warn(\u0026#34;å‘ç°ç¼“å­˜ä¸ä¸€è‡´ï¼Œç”¨æˆ·ID: {}, æ•°æ®åº“: {}, ç¼“å­˜: {}\u0026#34;, userId, dbUser, cacheUser); // ä¿®å¤ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES); } } } catch (Exception e) { log.error(\u0026#34;æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); } } } private List\u0026lt;Long\u0026gt; getRandomUserIds(int count) { // å®ç°éšæœºè·å–ç”¨æˆ·IDçš„é€»è¾‘ return userMapper.selectRandomUserIds(count); } } ä¸ƒã€ç»“è¯­ æ•°æ®åº“ä¸ Redis çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ å¦‚ä½•å¤„ç†\u0026quot;ä¸¤ä¸ªå‰¯æœ¬æ•°æ®çš„ä¸åŒæ­¥\u0026quot;ã€‚\næ²¡æœ‰ä¸€ç§ä¸‡èƒ½æ–¹æ¡ˆï¼Œéœ€è¦ç»“åˆä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©ï¼š\næ€§èƒ½ä¼˜å…ˆ â†’ Cache Aside ä¸€è‡´æ€§ä¼˜å…ˆ â†’ åŠ é” / Canal æŠ˜ä¸­ â†’ å»¶æ—¶åŒåˆ  / MQ åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œå¾€å¾€æ˜¯ å¤šç§æ–¹æ¡ˆç»“åˆ ä½¿ç”¨ï¼Œæ‰èƒ½æ—¢ä¿è¯æ€§èƒ½ï¼Œåˆä¿è¯æ•°æ®å¯é ã€‚\né€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œä»£ç ç¤ºä¾‹ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯ã€æ€§èƒ½è¦æ±‚ã€ä¸€è‡´æ€§è¦æ±‚æ¥é€‰æ‹©æœ€é€‚åˆçš„æ–¹æ¡ˆï¼Œå¹¶åœ¨å¿…è¦æ—¶ç»“åˆå¤šç§ç­–ç•¥æ¥å®ç°æœ€ä½³æ•ˆæœã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†æ•°æ®åº“ä¸RedisåŒå†™ä¸€è‡´æ€§é—®é¢˜çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºæ­£ç¡®çš„æŠ€æœ¯é€‰æ‹©ã€‚\n","date":"2025-08-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E-redis-%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E5%85%A8%E8%A7%A3%E6%9E%90/","title":"æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ"},{"content":"Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof åœ¨å¼€å‘ Java Web é¡¹ç›®æ—¶ï¼Œç»å¸¸ä¼šç”¨åˆ° JWT é‰´æƒã€æ‹¦æˆªå™¨ä»¥åŠè¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†ã€‚æœ¬æ–‡ç»“åˆä¸€ä¸ªå’–å•¡è´­ç‰©è½¦é¡¹ç›®ï¼Œè¯¦ç»†è®²è§£ç›¸å…³æ¦‚å¿µå’Œä»£ç å®ç°ã€‚\nğŸ“‹ ç›®å½• HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ æ³¨é‡Šè§£æï¼š\u0026ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID\u0026rdquo; JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£ Long userId = Long.valueOf(claims.get(\u0026ldquo;userId\u0026rdquo;).toString()); è§£æ BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³• instanceof æ˜¯ä»€ä¹ˆï¼Ÿ å®Œæ•´é¡¹ç›®å®æˆ˜ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„ 1. HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ HttpServletRequest æ˜¯ Java Servlet API æä¾›çš„æ¥å£ï¼Œç”¨æ¥å°è£…å®¢æˆ·ç«¯å‘ç»™æœåŠ¡å™¨çš„è¯·æ±‚ä¿¡æ¯ã€‚\nğŸ”§ æ ¸å¿ƒåŠŸèƒ½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // è·å–è¯·æ±‚æ–¹å¼ã€è·¯å¾„ request.getMethod() // GET / POST request.getRequestURI() // /cart/list // è·å–è¯·æ±‚å¤´ request.getHeader(\u0026#34;Authorization\u0026#34;) request.getHeader(\u0026#34;User-Agent\u0026#34;) // è·å–è¯·æ±‚å‚æ•° request.getParameter(\u0026#34;name\u0026#34;) request.getParameterMap() // è·å–è¯·æ±‚ä½“ï¼ˆPOST JSON æˆ–è¡¨å•ï¼‰ request.getReader() // è·å–å®¢æˆ·ç«¯ä¿¡æ¯ request.getRemoteAddr() // IPåœ°å€ request.getHeader(\u0026#34;User-Agent\u0026#34;) // æµè§ˆå™¨ä¿¡æ¯ // è·å–ä¼šè¯ä¿¡æ¯ request.getSession() ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯ åœ¨æˆ‘ä»¬çš„å’–å•¡é¡¹ç›®ä¸­ï¼ŒHttpServletRequest ä¸»è¦ç”¨äºï¼š\nJWT Token è·å–ï¼šä» Authorization è¯·æ±‚å¤´ä¸­æå– JWT Token ç”¨æˆ·èº«ä»½è¯†åˆ«ï¼šè§£æ Token è·å–ç”¨æˆ· ID è¯·æ±‚æ—¥å¿—è®°å½•ï¼šè®°å½•å®¢æˆ·ç«¯ IPã€User-Agent ç­‰ä¿¡æ¯ è·¨åŸŸå¤„ç†ï¼šè·å– Origin è¯·æ±‚å¤´è¿›è¡Œè·¨åŸŸéªŒè¯ 2. Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ âœ… ä¸éœ€è¦ HttpServletRequest çš„æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @RestController @RequestMapping(\u0026#34;/products\u0026#34;) public class ProductController { // åªéœ€è¦ä¸šåŠ¡å‚æ•°ï¼ŒSpring è‡ªåŠ¨ç»‘å®š @GetMapping(\u0026#34;/{id}\u0026#34;) public Result\u0026lt;Product\u0026gt; getProduct(@PathVariable Long id) { return productService.getById(id); } @PostMapping public Result\u0026lt;String\u0026gt; createProduct(@RequestBody ProductDTO productDTO) { return productService.create(productDTO); } } âŒ éœ€è¦ HttpServletRequest çš„æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @RestController @RequestMapping(\u0026#34;/user\u0026#34;) public class UserController { @Autowired private JwtProperties jwtProperties; /** * éœ€è¦è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ */ @GetMapping(\u0026#34;/profile\u0026#34;) public Result\u0026lt;UserProfile\u0026gt; getProfile(HttpServletRequest request) { // ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID Long userId = getCurrentUserId(request); return userService.getProfile(userId); } /** * ä»è¯·æ±‚ä¸­è·å–å½“å‰ç”¨æˆ·ID */ private Long getCurrentUserId(HttpServletRequest request) { String token = request.getHeader(\u0026#34;Authorization\u0026#34;); if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { token = token.substring(7); } try { Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); return Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); } catch (Exception e) { log.error(\u0026#34;è§£ætokenå¤±è´¥\u0026#34;, e); throw new RuntimeException(\u0026#34;æ— æ•ˆçš„token\u0026#34;); } } } ğŸ¯ ä½¿ç”¨åœºæ™¯æ€»ç»“ åœºæ™¯ æ˜¯å¦éœ€è¦ HttpServletRequest åŸå›  è·å–è¯·æ±‚å¤´ä¿¡æ¯ âœ… éœ€è¦ å¦‚ JWT Tokenã€User-Agent è·å–å®¢æˆ·ç«¯ IP âœ… éœ€è¦ å®‰å…¨å®¡è®¡ã€é™æµ è·å– Session ä¿¡æ¯ âœ… éœ€è¦ ä¼šè¯ç®¡ç† è·å– Cookie âœ… éœ€è¦ çŠ¶æ€ä¿æŒ çº¯ä¸šåŠ¡å‚æ•°å¤„ç† âŒ ä¸éœ€è¦ Spring è‡ªåŠ¨ç»‘å®š 3. æ³¨é‡Šè§£æï¼š\u0026ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID\u0026rdquo; ğŸ“ æ³¨é‡Šå«ä¹‰è§£æ 1 // ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·IDï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„JWTå®ç°æ¥è·å–ï¼‰ è¿™ä¸ªæ³¨é‡Šçš„å«ä¹‰æ˜¯ï¼š\nç”¨æˆ·ç™»å½•æµç¨‹ï¼šç”¨æˆ·ç™»å½•åï¼Œå‰ç«¯ä¼šæ‹¿åˆ°ä¸€ä¸ª JWT Token Token ä¼ é€’ï¼šå‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå°† Token æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼ˆAuthorization: Bearer \u0026lt;token\u0026gt;ï¼‰ åç«¯è§£æï¼šåç«¯è§£æ JWT Token è·å– userId æ³¨é‡Šè¯´æ˜ï¼šç›®å‰ä»£ç ç›´æ¥ä»è¯·æ±‚å¤´å– userIdï¼Œåœ¨çœŸå®é¡¹ç›®ä¸­è¦è§£æ JWT Token ğŸ”„ å®Œæ•´æµç¨‹ç¤ºæ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 sequenceDiagram participant F as å‰ç«¯ participant B as åç«¯ participant J as JWTå·¥å…· F-\u0026gt;\u0026gt;B: ç™»å½•è¯·æ±‚ B-\u0026gt;\u0026gt;J: ç”ŸæˆJWT Token J--\u0026gt;\u0026gt;B: è¿”å›Token B--\u0026gt;\u0026gt;F: è¿”å›Token Note over F: å­˜å‚¨Tokenåˆ°localStorage F-\u0026gt;\u0026gt;B: ä¸šåŠ¡è¯·æ±‚ + Authorization: Bearer \u0026lt;token\u0026gt; B-\u0026gt;\u0026gt;J: è§£æToken J--\u0026gt;\u0026gt;B: è¿”å›Claims(userId) B-\u0026gt;\u0026gt;B: ä»Claimsä¸­æå–userId B--\u0026gt;\u0026gt;F: è¿”å›ä¸šåŠ¡æ•°æ® 4. JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£ ğŸ—ï¸ å®Œæ•´æ‹¦æˆªå™¨å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 @Component @Slf4j public class JwtTokenUserInterceptor implements HandlerInterceptor { @Autowired private JwtProperties jwtProperties; /** * è¯·æ±‚å¤„ç†å‰çš„æ‹¦æˆªé€»è¾‘ */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // 1. åˆ¤æ–­å½“å‰æ‹¦æˆªåˆ°çš„æ˜¯Controllerçš„æ–¹æ³•è¿˜æ˜¯å…¶ä»–èµ„æº if (!(handler instanceof HandlerMethod)) { // å½“å‰æ‹¦æˆªåˆ°çš„ä¸æ˜¯åŠ¨æ€æ–¹æ³•ï¼Œç›´æ¥æ”¾è¡Œï¼ˆé™æ€èµ„æºç­‰ï¼‰ return true; } // 2. ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ String token = request.getHeader(jwtProperties.getUserTokenName()); log.info(\u0026#34;è¯·æ±‚å¤´åç§°: {}\u0026#34;, jwtProperties.getUserTokenName()); log.info(\u0026#34;Authorizationå¤´: {}\u0026#34;, request.getHeader(\u0026#34;Authorization\u0026#34;)); // 3. å»æ‰Bearerå‰ç¼€ if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { token = token.substring(7); } // 4. æ ¡éªŒä»¤ç‰Œ try { log.info(\u0026#34;JWTæ ¡éªŒ: {}\u0026#34;, token); Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); Long userId = Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); log.info(\u0026#34;å½“å‰ç”¨æˆ·IDï¼š{}\u0026#34;, userId); // 5. å°†ç”¨æˆ·IDå­˜å‚¨åˆ°ThreadLocalä¸­ BaseContext.setCurrentId(userId); // 6. é€šè¿‡ï¼Œæ”¾è¡Œ return true; } catch (Exception ex) { log.error(\u0026#34;JWTæ ¡éªŒå¤±è´¥: {}\u0026#34;, ex.getMessage()); // 7. ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç  response.setStatus(401); return false; } } } ğŸ” ä»£ç é€è¡Œè§£æ æ­¥éª¤1ï¼šåˆ¤æ–­è¯·æ±‚ç±»å‹ 1 2 3 if (!(handler instanceof HandlerMethod)) { return true; // é™æ€èµ„æºç›´æ¥æ”¾è¡Œ } ç›®çš„ï¼šåŒºåˆ† Controller æ–¹æ³•å’Œé™æ€èµ„æºè¯·æ±‚ åŸç†ï¼šSpring MVC ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ª handler æ¥å¤„ç† HandlerMethodï¼šController æ–¹æ³•çš„å¤„ç†å™¨ ResourceHttpRequestHandlerï¼šé™æ€èµ„æºçš„å¤„ç†å™¨ æ­¥éª¤2ï¼šè·å– JWT Token 1 String token = request.getHeader(jwtProperties.getUserTokenName()); é…ç½®åŒ–ï¼šé€šè¿‡ JwtProperties ç®¡ç†è¯·æ±‚å¤´åç§° çµæ´»æ€§ï¼šå¯ä»¥é…ç½®ä¸åŒçš„è¯·æ±‚å¤´åç§°ï¼ˆå¦‚ Authorizationã€X-Token ç­‰ï¼‰ æ­¥éª¤3ï¼šå¤„ç† Bearer å‰ç¼€ 1 2 3 if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { token = token.substring(7); } æ ‡å‡†æ ¼å¼ï¼šJWT Token é€šå¸¸ä»¥ Bearer å‰ç¼€ä¼ è¾“ å®‰å…¨è€ƒè™‘ï¼šæ˜ç¡®æ ‡è¯† Token ç±»å‹ï¼Œé¿å…ä¸å…¶ä»–è®¤è¯æ–¹å¼æ··æ·† æ­¥éª¤4ï¼šJWT è§£æä¸éªŒè¯ 1 2 Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); Long userId = Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); ç­¾åéªŒè¯ï¼šä½¿ç”¨ç›¸åŒçš„å¯†é’¥éªŒè¯ Token ç­¾å è¿‡æœŸæ£€æŸ¥ï¼šJWT åº“ä¼šè‡ªåŠ¨æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ Claims æå–ï¼šä» JWT è½½è·ä¸­æå–ç”¨æˆ·ä¿¡æ¯ æ­¥éª¤5ï¼šä¸Šä¸‹æ–‡å­˜å‚¨ 1 BaseContext.setCurrentId(userId); ThreadLocalï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ é¿å…ä¼ å‚ï¼šController å’Œ Service å±‚å¯ä»¥ç›´æ¥è·å–å½“å‰ç”¨æˆ· ID 5. Long userId = Long.valueOf(claims.get(\u0026ldquo;userId\u0026rdquo;).toString()); è§£æ ğŸ”„ ç±»å‹è½¬æ¢è¿‡ç¨‹ 1 2 3 4 // æ­¥éª¤åˆ†è§£ Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); // 1. ä»Claimsä¸­è·å–userIdï¼ˆObjectç±»å‹ï¼‰ String userIdStr = userIdObj.toString(); // 2. è½¬æˆå­—ç¬¦ä¸² Long userId = Long.valueOf(userIdStr); // 3. è½¬æˆLongå¯¹è±¡ âš ï¸ æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ é—®é¢˜1ï¼šç±»å‹è½¬æ¢å¼‚å¸¸ 1 2 // å¯èƒ½æŠ›å‡º NumberFormatException Long userId = Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); è§£å†³æ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // å®‰å…¨çš„ç±»å‹è½¬æ¢ public static Long getUserIdSafely(Claims claims) { try { Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ·IDä¸èƒ½ä¸ºç©º\u0026#34;); } return Long.valueOf(userIdObj.toString()); } catch (NumberFormatException e) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ·IDæ ¼å¼é”™è¯¯: \u0026#34; + userIdObj); } } é—®é¢˜2ï¼šç©ºå€¼å¤„ç† 1 2 3 4 5 // æ£€æŸ¥ç©ºå€¼ Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;JWTä¸­ç¼ºå°‘ç”¨æˆ·ID\u0026#34;); } ğŸ¯ æœ€ä½³å®è·µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * å®‰å…¨åœ°ä»Claimsä¸­è·å–ç”¨æˆ·ID */ private Long extractUserId(Claims claims) { Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;JWTä¸­ç¼ºå°‘ç”¨æˆ·ID\u0026#34;); } try { return Long.valueOf(userIdObj.toString()); } catch (NumberFormatException e) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ·IDæ ¼å¼é”™è¯¯: \u0026#34; + userIdObj); } } 6. BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ—ï¸ BaseContext å®Œæ•´å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 /** * åŸºäºThreadLocalå°è£…å·¥å…·ç±»ï¼Œç”¨äºä¿å­˜å’Œè·å–å½“å‰ç™»å½•ç”¨æˆ·ID */ public class BaseContext { private static ThreadLocal\u0026lt;Long\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); /** * è®¾ç½®å½“å‰ç”¨æˆ·ID * @param id ç”¨æˆ·ID */ public static void setCurrentId(Long id) { threadLocal.set(id); } /** * è·å–å½“å‰ç”¨æˆ·ID * @return ç”¨æˆ·ID */ public static Long getCurrentId() { return threadLocal.get(); } /** * åˆ é™¤å½“å‰ç”¨æˆ·IDï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰ */ public static void removeCurrentId() { threadLocal.remove(); } } ğŸ§µ ThreadLocal åŸç† ä¸ºä»€ä¹ˆä½¿ç”¨ ThreadLocalï¼Ÿ çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ é¿å…ä¼ å‚ï¼šä¸éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸­ä¼ é€’ç”¨æˆ· ID ä»£ç ç®€æ´ï¼šController å’Œ Service å±‚å¯ä»¥ç›´æ¥è·å–å½“å‰ç”¨æˆ· ThreadLocal å†…å­˜æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 graph TD A[è¯·æ±‚çº¿ç¨‹1] --\u0026gt; B[ThreadLocal Map] C[è¯·æ±‚çº¿ç¨‹2] --\u0026gt; D[ThreadLocal Map] E[è¯·æ±‚çº¿ç¨‹3] --\u0026gt; F[ThreadLocal Map] B --\u0026gt; G[userId: 1001] D --\u0026gt; H[userId: 1002] F --\u0026gt; I[userId: 1003] style A fill:#e1f5fe style C fill:#e8f5e8 style E fill:#fff3e0 ğŸ”§ å®é™…ä½¿ç”¨åœºæ™¯ Controller å±‚ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 @RestController @RequestMapping(\u0026#34;/admin\u0026#34;) public class AdminController { @GetMapping(\u0026#34;/info\u0026#34;) public Result\u0026lt;AdminLoginVO\u0026gt; info() { // ç›´æ¥è·å–å½“å‰ç™»å½•ç®¡ç†å‘˜IDï¼Œæ— éœ€ä¼ å‚ Long adminId = BaseContext.getCurrentId(); AdminLoginVO adminInfo = adminService.getById(adminId); return Result.success(adminInfo); } } Service å±‚ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 @Service public class OrderServiceImpl implements OrderService { @Override public Result\u0026lt;String\u0026gt; createOrder(OrderDTO orderDTO) { // ç›´æ¥è·å–å½“å‰ç”¨æˆ·ID Long userId = BaseContext.getCurrentId(); orderDTO.setUserId(userId); // ä¸šåŠ¡é€»è¾‘å¤„ç† return processOrder(orderDTO); } } âš ï¸ å†…å­˜æ³„æ¼é˜²æŠ¤ é—®é¢˜ï¼šThreadLocal å†…å­˜æ³„æ¼ 1 2 3 4 5 6 // é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰æ¸…ç†ThreadLocal public void processRequest() { BaseContext.setCurrentId(1001L); // å¤„ç†ä¸šåŠ¡é€»è¾‘ // å¿˜è®°è°ƒç”¨ removeCurrentId() } è§£å†³æ–¹æ¡ˆï¼šæ‹¦æˆªå™¨åå¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Component @Slf4j public class JwtTokenUserInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // JWTéªŒè¯é€»è¾‘... BaseContext.setCurrentId(userId); return true; } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { // è¯·æ±‚å®Œæˆåæ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ BaseContext.removeCurrentId(); } } 7. åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³• ğŸ” HandlerMethod è¯¦è§£ 1 2 3 if (!(handler instanceof HandlerMethod)) { return true; // é™æ€èµ„æºç›´æ¥æ”¾è¡Œ } Spring MVC è¯·æ±‚å¤„ç†æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 graph TD A[å®¢æˆ·ç«¯è¯·æ±‚] --\u0026gt; B[DispatcherServlet] B --\u0026gt; C[HandlerMapping] C --\u0026gt; D{è¯·æ±‚ç±»å‹åˆ¤æ–­} D --\u0026gt;|Controlleræ–¹æ³•| E[HandlerMethod] D --\u0026gt;|é™æ€èµ„æº| F[ResourceHttpRequestHandler] D --\u0026gt;|å…¶ä»–èµ„æº| G[å…¶ä»–Handler] E --\u0026gt; H[æ‹¦æˆªå™¨é“¾] F --\u0026gt; I[ç›´æ¥å¤„ç†] G --\u0026gt; I H --\u0026gt; J[Controlleræ–¹æ³•æ‰§è¡Œ] I --\u0026gt; K[è¿”å›èµ„æº] J --\u0026gt; L[è¿”å›å“åº”] K --\u0026gt; L HandlerMethod vs ResourceHttpRequestHandler ç±»å‹ ç”¨é€” ç¤ºä¾‹ HandlerMethod Controller æ–¹æ³• @GetMapping(\u0026quot;/users\u0026quot;) ResourceHttpRequestHandler é™æ€èµ„æº /static/css/style.css RequestMappingHandlerMapping è¯·æ±‚æ˜ å°„ é»˜è®¤çš„è¯·æ±‚å¤„ç†å™¨ ğŸ¯ å®é™…åº”ç”¨åœºæ™¯ åœºæ™¯1ï¼šåªæ‹¦æˆª Controller æ–¹æ³• 1 2 3 4 5 6 7 8 9 @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // åªå¯¹Controlleræ–¹æ³•è¿›è¡ŒJWTéªŒè¯ if (!(handler instanceof HandlerMethod)) { return true; // é™æ€èµ„æºã€å¥åº·æ£€æŸ¥ç­‰ç›´æ¥æ”¾è¡Œ } // JWTéªŒè¯é€»è¾‘... } åœºæ™¯2ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚ 1 2 3 4 5 6 7 8 9 10 11 @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String requestType = handler instanceof HandlerMethod ? \u0026#34;Controller\u0026#34; : \u0026#34;Static\u0026#34;; log.info(\u0026#34;è¯·æ±‚ç±»å‹: {}, è·¯å¾„: {}\u0026#34;, requestType, request.getRequestURI()); if (!(handler instanceof HandlerMethod)) { return true; } // å…¶ä»–é€»è¾‘... } 8. instanceof æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ”§ instanceof è¯­æ³•è¯¦è§£ instanceof æ˜¯ Java å…³é”®å­—ï¼Œç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯æŸä¸ªç±»æˆ–æ¥å£çš„å®ä¾‹ã€‚\nåŸºæœ¬è¯­æ³• 1 object instanceof ClassName è¿”å›å€¼ trueï¼šå¯¹è±¡æ˜¯æŒ‡å®šç±»æˆ–æ¥å£çš„å®ä¾‹ falseï¼šå¯¹è±¡ä¸æ˜¯æŒ‡å®šç±»æˆ–æ¥å£çš„å®ä¾‹ ğŸ“ å®é™…ç¤ºä¾‹ ç¤ºä¾‹1ï¼šåŸºæœ¬ç±»å‹åˆ¤æ–­ 1 2 3 4 5 // åŠ¨ç‰©ç±»å±‚æ¬¡ç»“æ„ Animal animal = new Dog(); System.out.println(animal instanceof Animal); // true System.out.println(animal instanceof Dog); // true System.out.println(animal instanceof Cat); // false ç¤ºä¾‹2ï¼šæ¥å£åˆ¤æ–­ 1 2 3 4 List\u0026lt;String\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(); System.out.println(list instanceof List); // true System.out.println(list instanceof ArrayList); // true System.out.println(list instanceof LinkedList); // false ç¤ºä¾‹3ï¼šnull å¤„ç† 1 2 String str = null; System.out.println(str instanceof String); // falseï¼ˆnull ä¸æ˜¯ä»»ä½•ç±»çš„å®ä¾‹ï¼‰ ğŸ¯ åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨ åˆ¤æ–­ Handler ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { if (handler instanceof HandlerMethod) { // Controller æ–¹æ³•å¤„ç† HandlerMethod handlerMethod = (HandlerMethod) handler; log.info(\u0026#34;Controller: {}, Method: {}\u0026#34;, handlerMethod.getBeanType().getSimpleName(), handlerMethod.getMethod().getName()); // JWT éªŒè¯é€»è¾‘ return validateJWT(request, response); } else if (handler instanceof ResourceHttpRequestHandler) { // é™æ€èµ„æºå¤„ç† log.info(\u0026#34;é™æ€èµ„æºè¯·æ±‚: {}\u0026#34;, request.getRequestURI()); return true; } else { // å…¶ä»–ç±»å‹å¤„ç† log.info(\u0026#34;å…¶ä»–ç±»å‹è¯·æ±‚: {}\u0026#34;, handler.getClass().getSimpleName()); return true; } } è·å–æ–¹æ³•ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 if (handler instanceof HandlerMethod) { HandlerMethod handlerMethod = (HandlerMethod) handler; // è·å– Controller ç±»å String controllerName = handlerMethod.getBeanType().getSimpleName(); // è·å–æ–¹æ³•å String methodName = handlerMethod.getMethod().getName(); // è·å–æ³¨è§£ä¿¡æ¯ RequestMapping mapping = handlerMethod.getMethodAnnotation(RequestMapping.class); log.info(\u0026#34;æ‰§è¡Œæ–¹æ³•: {}.{}\u0026#34;, controllerName, methodName); } 9. å®Œæ•´é¡¹ç›®å®æˆ˜ ğŸ—ï¸ é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 coffee-project/ â”œâ”€â”€ coffee-common/ # å…¬å…±æ¨¡å— â”‚ â”œâ”€â”€ src/main/java/com/coffee/ â”‚ â”‚ â”œâ”€â”€ context/ # ä¸Šä¸‹æ–‡ç®¡ç† â”‚ â”‚ â”‚ â””â”€â”€ BaseContext.java â”‚ â”‚ â”œâ”€â”€ properties/ # é…ç½®å±æ€§ â”‚ â”‚ â”‚ â””â”€â”€ JwtProperties.java â”‚ â”‚ â””â”€â”€ utils/ # å·¥å…·ç±» â”‚ â”‚ â””â”€â”€ JwtUtil.java â”‚ â””â”€â”€ pom.xml â”œâ”€â”€ coffee-server/ # æœåŠ¡ç«¯æ¨¡å— â”‚ â”œâ”€â”€ src/main/java/com/coffee/ â”‚ â”‚ â”œâ”€â”€ config/ # é…ç½®ç±» â”‚ â”‚ â”‚ â””â”€â”€ WebMvcConfiguration.java â”‚ â”‚ â”œâ”€â”€ interceptor/ # æ‹¦æˆªå™¨ â”‚ â”‚ â”‚ â”œâ”€â”€ JwtTokenAdminInterceptor.java â”‚ â”‚ â”‚ â””â”€â”€ JwtTokenUserInterceptor.java â”‚ â”‚ â””â”€â”€ controller/ # æ§åˆ¶å™¨ â”‚ â”‚ â”œâ”€â”€ admin/ # ç®¡ç†ç«¯ â”‚ â”‚ â””â”€â”€ user/ # ç”¨æˆ·ç«¯ â”‚ â””â”€â”€ src/main/resources/ â”‚ â””â”€â”€ application.yml # é…ç½®æ–‡ä»¶ â””â”€â”€ pom.xml âš™ï¸ é…ç½®æ–‡ä»¶ application.yml 1 2 3 4 5 6 7 8 9 10 11 coffee: jwt: # ç®¡ç†å‘˜JWTé…ç½® admin-secret-key: itcast admin-ttl: 7200000 # 2å°æ—¶ admin-token-name: Authorization # ç”¨æˆ·JWTé…ç½® user-secret-key: itcast user-ttl: 7200000 # 2å°æ—¶ user-token-name: Authorization JwtProperties.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 @Data @Component @ConfigurationProperties(prefix = \u0026#34;coffee.jwt\u0026#34;) public class JwtProperties { /** * ç®¡ç†å‘˜JWTç­¾åå¯†é’¥ */ private String adminSecretKey; /** * ç®¡ç†å‘˜JWTè¿‡æœŸæ—¶é—´(æ¯«ç§’) */ private Long adminTtl; /** * ç®¡ç†å‘˜ä»¤ç‰Œåç§° */ private String adminTokenName; /** * ç”¨æˆ·ä»¤ç‰Œåç§° */ private String userTokenName; /** * ç”¨æˆ·JWTç­¾åå¯†é’¥ */ private String userSecretKey; /** * ç”¨æˆ·JWTè¿‡æœŸæ—¶é—´(æ¯«ç§’) */ private Long userTtl; } ğŸ”§ æ‹¦æˆªå™¨é…ç½® WebMvcConfiguration.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Configuration @Slf4j public class WebMvcConfiguration implements WebMvcConfigurer { @Autowired private JwtTokenAdminInterceptor jwtTokenAdminInterceptor; /** * æ³¨å†Œæ‹¦æˆªå™¨ */ @Override public void addInterceptors(InterceptorRegistry registry) { log.info(\u0026#34;å¼€å§‹æ³¨å†Œè‡ªå®šä¹‰æ‹¦æˆªå™¨...\u0026#34;); // ç®¡ç†ç«¯æ‹¦æˆªå™¨ registry.addInterceptor(jwtTokenAdminInterceptor) .addPathPatterns(\u0026#34;/admin/**\u0026#34;) // æ‹¦æˆªç®¡ç†ç«¯æ‰€æœ‰è¯·æ±‚ .excludePathPatterns(\u0026#34;/admin/login\u0026#34;); // æ’é™¤ç™»å½•æ¥å£ } /** * è·¨åŸŸé…ç½® */ @Override public void addCorsMappings(CorsRegistry registry) { registry.addMapping(\u0026#34;/**\u0026#34;) .allowedOriginPatterns(\u0026#34;*\u0026#34;) .allowedMethods(\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;, \u0026#34;PUT\u0026#34;, \u0026#34;DELETE\u0026#34;, \u0026#34;OPTIONS\u0026#34;) .allowedHeaders(\u0026#34;*\u0026#34;) .allowCredentials(true) .maxAge(3600); } } ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹ ç®¡ç†ç«¯æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @RestController @RequestMapping(\u0026#34;/admin\u0026#34;) @Slf4j @Api(tags = \u0026#34;ç®¡ç†ç«¯ç›¸å…³æ¥å£\u0026#34;) public class AdminController { @Autowired private AdminService adminService; /** * ç®¡ç†å‘˜ç™»å½•ï¼ˆä¸éœ€è¦JWTéªŒè¯ï¼‰ */ @PostMapping(\u0026#34;/login\u0026#34;) @ApiOperation(\u0026#34;ç®¡ç†å‘˜ç™»å½•\u0026#34;) public Result\u0026lt;AdminLoginVO\u0026gt; login(@Valid @RequestBody AdminLoginDTO adminLoginDTO) { log.info(\u0026#34;ç®¡ç†å‘˜ç™»å½•ï¼š{}\u0026#34;, adminLoginDTO); AdminLoginVO adminLoginVO = adminService.login(adminLoginDTO); return Result.success(adminLoginVO); } /** * è·å–ç®¡ç†å‘˜ä¿¡æ¯ï¼ˆéœ€è¦JWTéªŒè¯ï¼‰ */ @GetMapping(\u0026#34;/info\u0026#34;) @ApiOperation(\u0026#34;è·å–ç®¡ç†å‘˜ä¿¡æ¯\u0026#34;) public Result\u0026lt;AdminLoginVO\u0026gt; info() { // ä»ThreadLocalä¸­è·å–å½“å‰ç™»å½•ç®¡ç†å‘˜ID Long adminId = BaseContext.getCurrentId(); AdminLoginVO adminInfo = adminService.getById(adminId); return Result.success(adminInfo); } } 10. æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ âœ… æœ€ä½³å®è·µ 1. å®‰å…¨çš„JWTå¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 /** * å®‰å…¨çš„JWTè§£ææ–¹æ³• */ private Long extractUserIdSafely(String token) { if (StringUtils.isBlank(token)) { throw new IllegalArgumentException(\u0026#34;Tokenä¸èƒ½ä¸ºç©º\u0026#34;); } try { Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ if (claims.getExpiration().before(new Date())) { throw new IllegalArgumentException(\u0026#34;Tokenå·²è¿‡æœŸ\u0026#34;); } // å®‰å…¨åœ°æå–ç”¨æˆ·ID Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;Tokenä¸­ç¼ºå°‘ç”¨æˆ·ID\u0026#34;); } return Long.valueOf(userIdObj.toString()); } catch (Exception e) { log.error(\u0026#34;JWTè§£æå¤±è´¥: {}\u0026#34;, e.getMessage()); throw new IllegalArgumentException(\u0026#34;æ— æ•ˆçš„Token\u0026#34;); } } 2. å®Œæ•´çš„æ‹¦æˆªå™¨å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 @Component @Slf4j public class JwtTokenUserInterceptor implements HandlerInterceptor { @Autowired private JwtProperties jwtProperties; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // 1. åªå¤„ç†Controlleræ–¹æ³• if (!(handler instanceof HandlerMethod)) { return true; } // 2. è·å–Token String token = extractToken(request); if (StringUtils.isBlank(token)) { sendErrorResponse(response, \u0026#34;ç¼ºå°‘è®¤è¯Token\u0026#34;); return false; } // 3. éªŒè¯Token try { Long userId = extractUserIdSafely(token); BaseContext.setCurrentId(userId); return true; } catch (Exception e) { log.error(\u0026#34;JWTéªŒè¯å¤±è´¥: {}\u0026#34;, e.getMessage()); sendErrorResponse(response, \u0026#34;TokenéªŒè¯å¤±è´¥: \u0026#34; + e.getMessage()); return false; } } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { // æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ BaseContext.removeCurrentId(); } private String extractToken(HttpServletRequest request) { String token = request.getHeader(jwtProperties.getUserTokenName()); if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { return token.substring(7); } return token; } private void sendErrorResponse(HttpServletResponse response, String message) throws IOException { response.setStatus(401); response.setContentType(\u0026#34;application/json;charset=UTF-8\u0026#34;); response.getWriter().write(\u0026#34;{\\\u0026#34;code\\\u0026#34;:401,\\\u0026#34;message\\\u0026#34;:\\\u0026#34;\u0026#34; + message + \u0026#34;\\\u0026#34;}\u0026#34;); } } 3. å¼‚å¸¸å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @RestControllerAdvice @Slf4j public class GlobalExceptionHandler { /** * JWTç›¸å…³å¼‚å¸¸å¤„ç† */ @ExceptionHandler(IllegalArgumentException.class) public Result\u0026lt;String\u0026gt; handleJWTException(IllegalArgumentException e) { log.error(\u0026#34;JWTå¼‚å¸¸: {}\u0026#34;, e.getMessage()); return Result.error(\u0026#34;è®¤è¯å¤±è´¥: \u0026#34; + e.getMessage()); } /** * é€šç”¨å¼‚å¸¸å¤„ç† */ @ExceptionHandler(Exception.class) public Result\u0026lt;String\u0026gt; handleException(Exception e) { log.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸: \u0026#34;, e); return Result.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜\u0026#34;); } } âš ï¸ æ³¨æ„äº‹é¡¹ 1. å†…å­˜æ³„æ¼é˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // é”™è¯¯ç¤ºä¾‹ï¼šå¿˜è®°æ¸…ç†ThreadLocal public void processRequest() { BaseContext.setCurrentId(1001L); // å¤„ç†ä¸šåŠ¡é€»è¾‘ // å¿˜è®°è°ƒç”¨ removeCurrentId() } // æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨try-finallyç¡®ä¿æ¸…ç† public void processRequest() { try { BaseContext.setCurrentId(1001L); // å¤„ç†ä¸šåŠ¡é€»è¾‘ } finally { BaseContext.removeCurrentId(); } } 2. çº¿ç¨‹å®‰å…¨é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 // ThreadLocalæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†è¦æ³¨æ„ä½¿ç”¨æ–¹å¼ public class BaseContext { // æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å‰¯æœ¬ private static ThreadLocal\u0026lt;Long\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); // é™æ€æ–¹æ³•ï¼Œçº¿ç¨‹å®‰å…¨ public static void setCurrentId(Long id) { threadLocal.set(id); } } 3. JWTå¯†é’¥ç®¡ç† 1 2 3 4 5 # ç”Ÿäº§ç¯å¢ƒé…ç½® coffee: jwt: admin-secret-key: ${JWT_ADMIN_SECRET:default-secret} user-secret-key: ${JWT_USER_SECRET:default-secret} 11. æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„ ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 sequenceDiagram participant C as å®¢æˆ·ç«¯ participant D as DispatcherServlet participant I as æ‹¦æˆªå™¨ participant H as HandlerMethod participant B as BaseContext participant S as Service C-\u0026gt;\u0026gt;D: HTTPè¯·æ±‚ + Authorizationå¤´ D-\u0026gt;\u0026gt;I: è¯·æ±‚è¿›å…¥æ‹¦æˆªå™¨ I-\u0026gt;\u0026gt;I: æ£€æŸ¥handler instanceof HandlerMethod I-\u0026gt;\u0026gt;I: æå–JWT Token I-\u0026gt;\u0026gt;I: è§£æTokenè·å–Claims I-\u0026gt;\u0026gt;B: BaseContext.setCurrentId(userId) I-\u0026gt;\u0026gt;H: æ”¾è¡Œåˆ°Controller H-\u0026gt;\u0026gt;B: BaseContext.getCurrentId() B--\u0026gt;\u0026gt;H: è¿”å›userId H-\u0026gt;\u0026gt;S: è°ƒç”¨Serviceæ–¹æ³• S-\u0026gt;\u0026gt;B: BaseContext.getCurrentId() B--\u0026gt;\u0026gt;S: è¿”å›userId S--\u0026gt;\u0026gt;H: è¿”å›ä¸šåŠ¡æ•°æ® H--\u0026gt;\u0026gt;C: è¿”å›å“åº” Note over I: è¯·æ±‚å®Œæˆåæ¸…ç†ThreadLocal I-\u0026gt;\u0026gt;B: BaseContext.removeCurrentId() ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ€»ç»“ æ¦‚å¿µ ä½œç”¨ å…³é”®ç‚¹ HttpServletRequest å°è£…è¯·æ±‚ä¿¡æ¯ è·å–Headerã€å‚æ•°ã€Sessionç­‰ HandlerMethod Controlleræ–¹æ³•å¤„ç†å™¨ åŒºåˆ†Controllerå’Œé™æ€èµ„æº instanceof ç±»å‹åˆ¤æ–­ åˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ BaseContext çº¿ç¨‹ä¸Šä¸‹æ–‡ ThreadLocalå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ JWTæ‹¦æˆªå™¨ ç»Ÿä¸€è®¤è¯ è‡ªåŠ¨è§£æTokenï¼Œè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ ğŸ¯ æŠ€æœ¯è¦ç‚¹ HttpServletRequestï¼šå°è£…è¯·æ±‚ä¿¡æ¯ï¼Œå¯ä»¥è·å– Headerã€å‚æ•°ã€Sessionã€å®¢æˆ·ç«¯ä¿¡æ¯ç­‰ JWT + æ‹¦æˆªå™¨ï¼šç»Ÿä¸€è§£æç”¨æˆ·èº«ä»½ï¼Œæ‹¦æˆªæœªæˆæƒè¯·æ±‚ BaseContextï¼šå­˜å‚¨å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆThreadLocalï¼‰ï¼Œé¿å…ä¼ å‚éº»çƒ¦ handler \u0026amp; HandlerMethodï¼šåˆ¤æ–­è¯·æ±‚å¤„ç†å¯¹è±¡ç±»å‹ï¼ŒåŒºåˆ† Controller ä¸é™æ€èµ„æº instanceofï¼šåˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œæ˜¯ Java çš„åŸºç¡€è¯­æ³• ğŸš€ é¡¹ç›®ä¼˜åŠ¿ ç»Ÿä¸€è®¤è¯ï¼šé€šè¿‡æ‹¦æˆªå™¨å®ç°JWTç»Ÿä¸€éªŒè¯ ä»£ç ç®€æ´ï¼šä½¿ç”¨BaseContexté¿å…å±‚å±‚ä¼ å‚ ç±»å‹å®‰å…¨ï¼šé€šè¿‡instanceofç¡®ä¿ç±»å‹æ­£ç¡®æ€§ å†…å­˜å®‰å…¨ï¼šæ­£ç¡®ä½¿ç”¨ThreadLocalï¼Œé¿å…å†…å­˜æ³„æ¼ é…ç½®çµæ´»ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†JWTå‚æ•° è¿™ç¯‡åšå®¢è¯¦ç»†è§£æäº†Spring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°çš„æ ¸å¿ƒåŸç†ï¼Œç»“åˆå®é™…é¡¹ç›®ä»£ç ï¼Œè®©ä½ æ·±å…¥ç†è§£ç”¨æˆ·è®¤è¯çš„åº•å±‚æµç¨‹ã€‚é€šè¿‡æŒæ¡è¿™äº›æŠ€æœ¯è¦ç‚¹ï¼Œä½ å¯ä»¥æ„å»ºæ›´åŠ å¥å£®å’Œå®‰å…¨çš„Webåº”ç”¨ç³»ç»Ÿã€‚\nğŸ’¡ æç¤ºï¼šæœ¬æ–‡åŸºäºå’–å•¡è´­ç‰©è½¦é¡¹ç›®å®æˆ˜ï¼Œæ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½ç»è¿‡å®é™…æµ‹è¯•éªŒè¯ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼\n","date":"2025-01-27T10:00:00+08:00","permalink":"https://Yin123-ybh.github.io/p/spring-boot-jwt-%E4%B8%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E8%AF%A6%E8%A7%A3basecontexthandlermethodhttpservletrequest-%E4%B8%8E-instanceof/","title":"Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof"},{"content":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡ ç›®å½• é¡¹ç›®æ¦‚è¿° æŠ€æœ¯æ ˆè¯´æ˜ æ•´ä½“æ¶æ„è®¾è®¡ æ•°æ®åº“è®¾è®¡å®Œå–„ ä¸‹ä¸€æ­¥è®¡åˆ’ é¡¹ç›®æ¦‚è¿° æœ¬æŒ‡å—å°†åŸºäºç°æœ‰çš„Hashå’–å•¡é¡¹ç›®ï¼Œå®ç°ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼ç§’æ€ç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\nåˆ†å¸ƒå¼é”é˜²è¶…å–ï¼šåŸºäºRedissonå’ŒLuaè„šæœ¬å®ç°é«˜å¹¶å‘åœºæ™¯ä¸‹çš„åº“å­˜æ§åˆ¶ æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ï¼šRabbitMQå¼‚æ­¥å¤„ç†è®¢å•æ”¯ä»˜å’Œç§¯åˆ†ç³»ç»Ÿ å¤šç«¯æ”¯æŒï¼šç®¡ç†ç«¯ã€ç”¨æˆ·ç«¯ã€å¾®ä¿¡å°ç¨‹åºç»Ÿä¸€åç«¯æœåŠ¡ å®Œæ•´éƒ¨ç½²ï¼šDocker + Nginxé…ç½®ï¼Œæ”¯æŒç”Ÿäº§ç¯å¢ƒéƒ¨ç½² åŠŸèƒ½ç›®æ ‡ å®ç°é«˜å¹¶å‘çš„ç§’æ€æ´»åŠ¨ç³»ç»Ÿ é˜²æ­¢è¶…å–å’Œé‡å¤å‚ä¸ æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² æä¾›ç”¨æˆ·å‹å¥½çš„ç•Œé¢ ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿç¨³å®šæ€§ æŠ€æœ¯æ ˆè¯´æ˜ ç»„ä»¶ æŠ€æœ¯é€‰å‹ ç‰ˆæœ¬ ä½œç”¨ åç«¯æ¡†æ¶ Spring Boot 2.7.3 ä¸»æ¡†æ¶ï¼Œæä¾›åŸºç¡€åŠŸèƒ½ æ•°æ®åº“ MySQL 8.0 æ•°æ®æŒä¹…åŒ–å­˜å‚¨ ç¼“å­˜ Redis 6.2 ç¼“å­˜å’Œåˆ†å¸ƒå¼é” æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ 3.9 å¼‚æ­¥æ¶ˆæ¯å¤„ç† åˆ†å¸ƒå¼é” Redisson 3.17.7 é˜²è¶…å–å’Œå¹¶å‘æ§åˆ¶ ç®¡ç†ç«¯å‰ç«¯ Vue.js + Element UI - ç®¡ç†ç«¯ç•Œé¢ï¼ˆè‹ç©¹å¤–å–å‰ç«¯-frontendï¼‰ ç”¨æˆ·ç«¯ UniApp - å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç«¯ï¼ˆproject-rjwm-weixin-uniapp-develop-wsyï¼‰ åå‘ä»£ç† Nginx - è´Ÿè½½å‡è¡¡å’Œé™æ€èµ„æºæœåŠ¡ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§ é«˜å¹¶å‘å¤„ç†ï¼šRedisç¼“å­˜ + åˆ†å¸ƒå¼é” å¼‚æ­¥è§£è€¦ï¼šRabbitMQæ¶ˆæ¯é˜Ÿåˆ— æ•°æ®ä¸€è‡´æ€§ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ ç³»ç»Ÿç›‘æ§ï¼šå¥åº·æ£€æŸ¥å’Œæ—¥å¿—è®°å½• é™æµä¿æŠ¤ï¼šNginxå±‚é¢çš„è¯·æ±‚é™æµ æ•´ä½“æ¶æ„è®¾è®¡ æ¶æ„å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç®¡ç†ç«¯å‰ç«¯ â”‚ â”‚ å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç«¯ â”‚ â”‚ Hashå’–å•¡å‰ç«¯-frontend â”‚ â”‚ project-rjwm-weixin-uniapp- â”‚ â”‚ Vue.js + Element UI â”‚ â”‚ develop-wsy (UniApp) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Nginx åå‘ä»£ç† â”‚ â”‚ (è´Ÿè½½å‡è¡¡ + é™æµ) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Hash Coffee åç«¯ â”‚ â”‚ Spring Boot + MyBatis â”‚ â”‚ (ç«¯å£: 8084) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Redis ç¼“å­˜ â”‚ â”‚ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ— â”‚ â”‚ Redisson åˆ†å¸ƒå¼é” â”‚ â”‚ åˆ†å¸ƒå¼é”+ç§’æ€ç¼“å­˜â”‚ â”‚ å¼‚æ­¥å¤„ç†+å»¶è¿Ÿæ¶ˆæ¯ â”‚ â”‚ é˜²è¶…å–+å¹‚ç­‰æ€§ â”‚ â”‚ (ç«¯å£: 6379) â”‚ â”‚ (ç«¯å£: 5672) â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ MySQL æ•°æ®åº“ â”‚ â”‚ (ä¸»ä»å¤åˆ¶ + äº‹åŠ¡) â”‚ â”‚ (ç«¯å£: 3306) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ•°æ®æµå‘ ç®¡ç†å‘˜è®¿é—®æµç¨‹ï¼š\nç®¡ç†å‘˜é€šè¿‡ç®¡ç†ç«¯å‰ç«¯(Vue.js)å‘èµ·è¯·æ±‚ Nginxæ¥æ”¶è¯·æ±‚å¹¶è¿›è¡Œåå‘ä»£ç† åç«¯æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘ è¿”å›å“åº”ç»™ç®¡ç†å‘˜ ç”¨æˆ·è®¿é—®æµç¨‹ï¼š\nç”¨æˆ·é€šè¿‡å¾®ä¿¡å°ç¨‹åº(UniApp)å‘èµ·è¯·æ±‚ Nginxæ¥æ”¶è¯·æ±‚å¹¶è¿›è¡Œåå‘ä»£ç† åç«¯æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘ è¿”å›å“åº”ç»™ç”¨æˆ· ç§’æ€æµç¨‹ï¼š\nç”¨æˆ·å‚ä¸ç§’æ€æ´»åŠ¨ Redisåˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤å‚ä¸ Luaè„šæœ¬ä¿è¯åº“å­˜æ‰£å‡åŸå­æ€§ å¼‚æ­¥åˆ›å»ºè®¢å•å’Œæ›´æ–°æ•°æ®åº“ æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹ï¼š\nè®¢å•æ”¯ä»˜æˆåŠŸåå‘é€æ¶ˆæ¯ RabbitMQå¼‚æ­¥å¤„ç†ç§¯åˆ†è®¡ç®— è§£è€¦æ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡ æ•°æ®åº“è®¾è®¡å®Œå–„ ç°æœ‰æ•°æ®åº“è¡¨ç»“æ„ é¡¹ç›®å·²ç»åŒ…å«äº†å®Œæ•´çš„æ•°æ®åº“è®¾è®¡ï¼ˆscript3.sqlï¼‰ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\næ ¸å¿ƒä¸šåŠ¡è¡¨ 1. ç§’æ€æ´»åŠ¨è¡¨ (seckill_activity)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 CREATE TABLE seckill_activity ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;æ´»åŠ¨ID\u0026#39; PRIMARY KEY, name VARCHAR(100) NOT NULL COMMENT \u0026#39;æ´»åŠ¨åç§°\u0026#39;, description TEXT COMMENT \u0026#39;æ´»åŠ¨æè¿°\u0026#39;, dish_id BIGINT NOT NULL COMMENT \u0026#39;èœå“ID\u0026#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT \u0026#39;ç§’æ€ä»·æ ¼\u0026#39;, original_price DECIMAL(10,2) NOT NULL COMMENT \u0026#39;åŸä»·\u0026#39;, stock INT NOT NULL COMMENT \u0026#39;ç§’æ€åº“å­˜\u0026#39;, sold_count INT DEFAULT 0 COMMENT \u0026#39;å·²å”®æ•°é‡\u0026#39;, per_user_limit INT DEFAULT 1 COMMENT \u0026#39;æ¯äººé™è´­æ•°é‡\u0026#39;, start_time DATETIME NOT NULL COMMENT \u0026#39;å¼€å§‹æ—¶é—´\u0026#39;, end_time DATETIME NOT NULL COMMENT \u0026#39;ç»“æŸæ—¶é—´\u0026#39;, status TINYINT(1) DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, create_user BIGINT COMMENT \u0026#39;åˆ›å»ºäºº\u0026#39;, update_user BIGINT COMMENT \u0026#39;ä¿®æ”¹äºº\u0026#39; ); 2. ç§’æ€è®¢å•è¡¨ (seckill_order)\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE TABLE seckill_order ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®ID\u0026#39; PRIMARY KEY, activity_id BIGINT NOT NULL COMMENT \u0026#39;ç§’æ€æ´»åŠ¨ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, dish_id BIGINT NOT NULL COMMENT \u0026#39;å•†å“ID\u0026#39;, quantity INT NOT NULL COMMENT \u0026#39;è´­ä¹°æ•°é‡\u0026#39;, seckill_price DECIMAL(10,2) NOT NULL COMMENT \u0026#39;ç§’æ€ä»·æ ¼\u0026#39;, total_amount DECIMAL(10,2) NOT NULL COMMENT \u0026#39;æ€»é‡‘é¢\u0026#39;, status TINYINT(1) DEFAULT 0 COMMENT \u0026#39;è®¢å•çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æ”¯ä»˜ï¼Œ2-å·²å–æ¶ˆ\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39; ); 3. ç§’æ€å‚ä¸è®°å½•è¡¨ (seckill_participant)\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE seckill_participant ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®ID\u0026#39; PRIMARY KEY, activity_id BIGINT NOT NULL COMMENT \u0026#39;ç§’æ€æ´»åŠ¨ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, quantity INT NOT NULL COMMENT \u0026#39;å‚ä¸æ•°é‡\u0026#39;, status TINYINT(1) DEFAULT 0 COMMENT \u0026#39;çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-æˆåŠŸï¼Œ2-å¤±è´¥\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, UNIQUE KEY uk_user_activity (user_id, activity_id) ); 4. åº“å­˜æ‰£å‡è®°å½•è¡¨ (seckill_stock_log)\n1 2 3 4 5 6 7 8 9 10 CREATE TABLE seckill_stock_log ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®ID\u0026#39; PRIMARY KEY, activity_id BIGINT NOT NULL COMMENT \u0026#39;ç§’æ€æ´»åŠ¨ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, quantity INT NOT NULL COMMENT \u0026#39;æ‰£å‡æ•°é‡\u0026#39;, before_stock INT NOT NULL COMMENT \u0026#39;æ‰£å‡å‰åº“å­˜\u0026#39;, after_stock INT NOT NULL COMMENT \u0026#39;æ‰£å‡ååº“å­˜\u0026#39;, status TINYINT(1) DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-æˆåŠŸï¼Œ0-å¤±è´¥\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39; ); ä¼˜æƒ åˆ¸ç›¸å…³è¡¨ 5. ä¼˜æƒ åˆ¸æ¨¡æ¿è¡¨ (coupon_template)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 CREATE TABLE coupon_template ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;æ¨¡æ¿ID\u0026#39; PRIMARY KEY, name VARCHAR(100) NOT NULL COMMENT \u0026#39;ä¼˜æƒ åˆ¸åç§°\u0026#39;, description VARCHAR(500) COMMENT \u0026#39;ä¼˜æƒ åˆ¸æè¿°\u0026#39;, type TINYINT(1) NOT NULL COMMENT \u0026#39;ä¼˜æƒ åˆ¸ç±»å‹ï¼š1-æ»¡å‡åˆ¸ï¼Œ2-æŠ˜æ‰£åˆ¸ï¼Œ3-ä»£é‡‘åˆ¸\u0026#39;, discount_type TINYINT(1) NOT NULL COMMENT \u0026#39;æŠ˜æ‰£ç±»å‹ï¼š1-å›ºå®šé‡‘é¢ï¼Œ2-ç™¾åˆ†æ¯”\u0026#39;, discount_value DECIMAL(10,2) NOT NULL COMMENT \u0026#39;æŠ˜æ‰£å€¼\u0026#39;, min_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT \u0026#39;æœ€ä½æ¶ˆè´¹é‡‘é¢\u0026#39;, total_count INT NOT NULL COMMENT \u0026#39;å‘æ”¾æ€»æ•°é‡\u0026#39;, used_count INT DEFAULT 0 COMMENT \u0026#39;å·²ä½¿ç”¨æ•°é‡\u0026#39;, per_user_limit INT DEFAULT 1 COMMENT \u0026#39;æ¯äººé™é¢†æ•°é‡\u0026#39;, valid_days INT COMMENT \u0026#39;æœ‰æ•ˆå¤©æ•°\u0026#39;, start_time DATETIME NOT NULL COMMENT \u0026#39;å¼€å§‹æ—¶é—´\u0026#39;, end_time DATETIME NOT NULL COMMENT \u0026#39;ç»“æŸæ—¶é—´\u0026#39;, status TINYINT(1) DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨\u0026#39; ); 6. ä¼˜æƒ åˆ¸è¡¨ (coupon)\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE TABLE coupon ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¼˜æƒ åˆ¸ID\u0026#39; PRIMARY KEY, template_id BIGINT NOT NULL COMMENT \u0026#39;æ¨¡æ¿ID\u0026#39;, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, code VARCHAR(32) NOT NULL COMMENT \u0026#39;ä¼˜æƒ åˆ¸ç \u0026#39;, status TINYINT(1) DEFAULT 0 COMMENT \u0026#39;çŠ¶æ€ï¼š0-æœªä½¿ç”¨ï¼Œ1-å·²ä½¿ç”¨ï¼Œ2-å·²è¿‡æœŸ\u0026#39;, used_time DATETIME COMMENT \u0026#39;ä½¿ç”¨æ—¶é—´\u0026#39;, order_id BIGINT COMMENT \u0026#39;ä½¿ç”¨è®¢å•ID\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, UNIQUE KEY uk_code (code) ); ç³»ç»Ÿé…ç½®è¡¨ 7. ç³»ç»Ÿé…ç½®è¡¨ (system_config)\n1 2 3 4 5 6 7 8 9 CREATE TABLE system_config ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ID\u0026#39; PRIMARY KEY, config_key VARCHAR(100) NOT NULL COMMENT \u0026#39;é…ç½®é”®\u0026#39;, config_value TEXT COMMENT \u0026#39;é…ç½®å€¼\u0026#39;, description VARCHAR(255) COMMENT \u0026#39;æè¿°\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, UNIQUE KEY uk_config_key (config_key) ); 8. ç”¨æˆ·ç§¯åˆ†è®°å½•è¡¨ (user_points_log)\n1 2 3 4 5 6 7 8 9 CREATE TABLE user_points_log ( id BIGINT AUTO_INCREMENT COMMENT \u0026#39;ID\u0026#39; PRIMARY KEY, user_id BIGINT NOT NULL COMMENT \u0026#39;ç”¨æˆ·ID\u0026#39;, order_id BIGINT COMMENT \u0026#39;è®¢å•ID\u0026#39;, points INT NOT NULL COMMENT \u0026#39;ç§¯åˆ†å˜åŒ–\u0026#39;, type TINYINT(1) NOT NULL COMMENT \u0026#39;ç±»å‹ï¼š1-è·å¾—ï¼Œ2-æ¶ˆè´¹\u0026#39;, description VARCHAR(255) COMMENT \u0026#39;æè¿°\u0026#39;, create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39; ); æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– ä¸ºäº†æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹ç´¢å¼•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- ç§’æ€æ´»åŠ¨è¡¨ç´¢å¼• CREATE INDEX idx_seckill_time_status ON seckill_activity(start_time, end_time, status); CREATE INDEX idx_seckill_dish_time ON seckill_activity(dish_id, start_time, end_time, status); -- ç§’æ€è®¢å•è¡¨ç´¢å¼• CREATE INDEX idx_seckill_order_user_time ON seckill_order(user_id, create_time); CREATE INDEX idx_seckill_order_activity_status ON seckill_order(activity_id, status); -- ç§’æ€å‚ä¸è®°å½•è¡¨ç´¢å¼• CREATE INDEX idx_participant_activity ON seckill_participant(activity_id); CREATE INDEX idx_participant_user ON seckill_participant(user_id); -- ä¼˜æƒ åˆ¸è¡¨ç´¢å¼• CREATE INDEX idx_coupon_user_status ON coupon(user_id, status); CREATE INDEX idx_coupon_template_time ON coupon_template(start_time, end_time, status); æ•°æ®åº“è®¾è®¡ç‰¹ç‚¹ å®Œæ•´æ€§ï¼šåŒ…å«ç§’æ€æ´»åŠ¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç† ä¸€è‡´æ€§ï¼šé€šè¿‡å¤–é”®çº¦æŸä¿è¯æ•°æ®ä¸€è‡´æ€§ æ€§èƒ½ï¼šåˆç†çš„ç´¢å¼•è®¾è®¡æå‡æŸ¥è¯¢æ•ˆç‡ æ‰©å±•æ€§ï¼šé¢„ç•™å­—æ®µæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±• å®¡è®¡ï¼šå®Œæ•´çš„åˆ›å»ºå’Œæ›´æ–°æ—¶é—´è®°å½• ä¸‹ä¸€æ­¥è®¡åˆ’ åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è®²è§£ï¼š\nç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°\nå®ä½“ç±»è®¾è®¡ï¼ˆSeckillParticipantã€SeckillOrderã€SeckillStockLogï¼‰ DTOç±»åˆ›å»ºï¼ˆSeckillParticipateDTOã€SeckillOrderDTOï¼‰ Mapperæ¥å£å®ç°å’ŒXMLé…ç½® åˆ†å¸ƒå¼é”æœåŠ¡ï¼ˆDistributedLockServiceï¼‰ Luaè„šæœ¬å®ç°ï¼ˆé˜²è¶…å–æ ¸å¿ƒé€»è¾‘ï¼‰ æœåŠ¡å±‚å¢å¼ºï¼ˆSeckillActivityServiceImplï¼‰ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£\nRabbitMQé…ç½®å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶æ„ æ¶ˆæ¯å®ä½“ç±»è®¾è®¡ï¼ˆOrderPayMessageã€PointsEarnMessageç­‰ï¼‰ æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ï¼ˆMessageProducerServiceï¼‰ æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ï¼ˆMessageConsumerServiceï¼‰ APIæ¥å£å¼€å‘ï¼ˆç”¨æˆ·ç«¯æ§åˆ¶å™¨ï¼‰ é…ç½®æ–‡ä»¶å®Œå–„å’Œéƒ¨ç½²æµ‹è¯• æ¯ä¸ªéƒ¨åˆ†éƒ½ä¼šæä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œè¯¦ç»†çš„å®ç°è¯´æ˜ï¼Œç¡®ä¿ä½ å¯ä»¥æŒ‰ç…§æŒ‡å—é€æ­¥å®Œæˆåç«¯æ”¹é€ ã€‚\nç»§ç»­é˜…è¯»ï¼šHashå’–å•¡åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/","title":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚è¿°å’Œæ•°æ®åº“è®¾è®¡"},{"content":"Hashå’–å•¡åç«¯æ”¹é€ æŒ‡å—-ç¬¬ä¸‰éƒ¨åˆ†-æ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£ ç›®å½• é¡¹ç›®æ¦‚è¿° æ¶ˆæ¯é˜Ÿåˆ—é…ç½® æ¶ˆæ¯å®ä½“ç±» æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ APIæ¥å£å®ç° Nginxé…ç½® éƒ¨ç½²æ³¨æ„äº‹é¡¹ æ¶ˆæ¯é˜Ÿåˆ—é«˜çº§ç‰¹æ€§ æµæ§å’Œç†”æ–­ ç›‘æ§å’Œå‘Šè­¦ æ€§èƒ½ä¼˜åŒ– å®‰å…¨é˜²æŠ¤ æµ‹è¯•ç­–ç•¥ æ¦‚è¿° æœ¬éƒ¨åˆ†ä¸»è¦ä»‹ç»Hashå’–å•¡é¡¹ç›®ä¸­æ¶ˆæ¯é˜Ÿåˆ—RabbitMQçš„é…ç½®ã€æ¶ˆæ¯ç”Ÿäº§è€…/æ¶ˆè´¹è€…å®ç°ï¼Œä»¥åŠç”¨æˆ·ç«¯APIæ¥å£çš„å¼€å‘ã€‚é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ç”¨æˆ·æ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡ï¼Œæ„å»ºå¼‚æ­¥é€šä¿¡æ¶æ„ï¼ŒåŒæ—¶å®ç°å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶å¤„ç†è¶…æ—¶æœªæ”¯ä»˜è®¢å•çš„è‡ªåŠ¨å–æ¶ˆã€‚\n1. RabbitMQé…ç½® 1.1 RabbitMQé…ç½®ç±» æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/config/RabbitMQConfig.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 package com.sky.config; import org.springframework.amqp.core.*; import org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory; import org.springframework.amqp.rabbit.connection.ConnectionFactory; import org.springframework.amqp.rabbit.core.RabbitTemplate; import org.springframework.amqp.rabbit.listener.RabbitListenerContainerFactory; import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; /** * RabbitMQé…ç½® * é…ç½®æ¶ˆæ¯é˜Ÿåˆ—ã€äº¤æ¢æœºã€è·¯ç”±ç­‰ï¼Œæ”¯æŒå¼‚æ­¥æ¶ˆæ¯å¤„ç† */ @Configuration public class RabbitMQConfig { // è®¢å•ç›¸å…³é˜Ÿåˆ— public static final String ORDER_QUEUE = \u0026#34;order.queue\u0026#34;; public static final String ORDER_EXCHANGE = \u0026#34;order.exchange\u0026#34;; public static final String ORDER_ROUTING_KEY = \u0026#34;order.pay\u0026#34;; // ç§¯åˆ†ç›¸å…³é˜Ÿåˆ— public static final String POINTS_QUEUE = \u0026#34;points.queue\u0026#34;; public static final String POINTS_EXCHANGE = \u0026#34;points.exchange\u0026#34;; public static final String POINTS_ROUTING_KEY = \u0026#34;points.earn\u0026#34;; // è®¢å•è¶…æ—¶é˜Ÿåˆ— public static final String ORDER_TIMEOUT_QUEUE = \u0026#34;order.timeout.queue\u0026#34;; public static final String ORDER_TIMEOUT_EXCHANGE = \u0026#34;order.timeout.exchange\u0026#34;; public static final String ORDER_TIMEOUT_ROUTING_KEY = \u0026#34;order.timeout\u0026#34;; // æ­»ä¿¡é˜Ÿåˆ— public static final String ORDER_DLX_QUEUE = \u0026#34;order.dlx.queue\u0026#34;; public static final String ORDER_DLX_EXCHANGE = \u0026#34;order.dlx.exchange\u0026#34;; public static final String ORDER_DLX_ROUTING_KEY = \u0026#34;order.dlx\u0026#34;; /** * æ¶ˆæ¯è½¬æ¢å™¨ * ä½¿ç”¨Jackson2JsonMessageConverterè¿›è¡ŒJSONåºåˆ—åŒ– */ @Bean public Jackson2JsonMessageConverter messageConverter() { return new Jackson2JsonMessageConverter(); } /** * RabbitTemplateé…ç½® * é…ç½®æ¶ˆæ¯å‘é€æ¨¡æ¿ï¼Œæ”¯æŒæ¶ˆæ¯ç¡®è®¤å’Œè¿”å›æœºåˆ¶ */ @Bean public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); template.setMessageConverter(messageConverter()); template.setMandatory(true); template.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -\u0026gt; { System.out.println(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥: \u0026#34; + message + \u0026#34;, åŸå› : \u0026#34; + replyText); }); return template; } /** * æ¶ˆè´¹è€…å®¹å™¨å·¥å‚é…ç½® * é…ç½®æ¶ˆè´¹è€…å‚æ•°ï¼Œæ”¯æŒæ‰‹åŠ¨ç¡®è®¤å’Œé™æµ */ @Bean public RabbitListenerContainerFactory\u0026lt;?\u0026gt; rabbitListenerContainerFactory(ConnectionFactory connectionFactory) { SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); factory.setMessageConverter(messageConverter()); factory.setAcknowledgeMode(AcknowledgeMode.MANUAL); factory.setConcurrentConsumers(3); factory.setMaxConcurrentConsumers(10); factory.setPrefetchCount(1); return factory; } // ========== è®¢å•ç›¸å…³é…ç½® ========== /** * è®¢å•äº¤æ¢æœº * ä½¿ç”¨DirectExchangeï¼Œæ”¯æŒç²¾ç¡®è·¯ç”± */ @Bean public DirectExchange orderExchange() { return new DirectExchange(ORDER_EXCHANGE, true, false); } /** * è®¢å•é˜Ÿåˆ— * æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ– */ @Bean public Queue orderQueue() { return QueueBuilder.durable(ORDER_QUEUE).build(); } /** * è®¢å•é˜Ÿåˆ—ç»‘å®š * ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼Œè®¾ç½®è·¯ç”±é”® */ @Bean public Binding orderBinding() { return BindingBuilder.bind(orderQueue()).to(orderExchange()).with(ORDER_ROUTING_KEY); } // ========== ç§¯åˆ†ç›¸å…³é…ç½® ========== /** * ç§¯åˆ†äº¤æ¢æœº * ä½¿ç”¨DirectExchangeï¼Œæ”¯æŒç²¾ç¡®è·¯ç”± */ @Bean public DirectExchange pointsExchange() { return new DirectExchange(POINTS_EXCHANGE, true, false); } /** * ç§¯åˆ†é˜Ÿåˆ— * æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ– */ @Bean public Queue pointsQueue() { return QueueBuilder.durable(POINTS_QUEUE).build(); } /** * ç§¯åˆ†é˜Ÿåˆ—ç»‘å®š * ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼Œè®¾ç½®è·¯ç”±é”® */ @Bean public Binding pointsBinding() { return BindingBuilder.bind(pointsQueue()).to(pointsExchange()).with(POINTS_ROUTING_KEY); } // ========== è®¢å•è¶…æ—¶ç›¸å…³é…ç½® ========== /** * è®¢å•è¶…æ—¶äº¤æ¢æœº * ä½¿ç”¨DirectExchangeï¼Œæ”¯æŒç²¾ç¡®è·¯ç”± */ @Bean public DirectExchange orderTimeoutExchange() { return new DirectExchange(ORDER_TIMEOUT_EXCHANGE, true, false); } /** * è®¢å•è¶…æ—¶é˜Ÿåˆ— * æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ– */ @Bean public Queue orderTimeoutQueue() { return QueueBuilder.durable(ORDER_TIMEOUT_QUEUE).build(); } /** * è®¢å•è¶…æ—¶é˜Ÿåˆ—ç»‘å®š * ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼Œè®¾ç½®è·¯ç”±é”® */ @Bean public Binding orderTimeoutBinding() { return BindingBuilder.bind(orderTimeoutQueue()).to(orderTimeoutExchange()).with(ORDER_TIMEOUT_ROUTING_KEY); } // ========== æ­»ä¿¡é˜Ÿåˆ—é…ç½® ========== /** * æ­»ä¿¡äº¤æ¢æœº * ä½¿ç”¨DirectExchangeï¼Œæ”¯æŒç²¾ç¡®è·¯ç”± */ @Bean public DirectExchange orderDlxExchange() { return new DirectExchange(ORDER_DLX_EXCHANGE, true, false); } /** * æ­»ä¿¡é˜Ÿåˆ— * æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ– */ @Bean public Queue orderDlxQueue() { return QueueBuilder.durable(ORDER_DLX_QUEUE).build(); } /** * æ­»ä¿¡é˜Ÿåˆ—ç»‘å®š * ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœºï¼Œè®¾ç½®è·¯ç”±é”® */ @Bean public Binding orderDlxBinding() { return BindingBuilder.bind(orderDlxQueue()).to(orderDlxExchange()).with(ORDER_DLX_ROUTING_KEY); } } é…ç½®ç‰¹ç‚¹:\næ¶ˆæ¯æŒä¹…åŒ–: ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤± æ‰‹åŠ¨ç¡®è®¤: æé«˜æ¶ˆæ¯å¤„ç†å¯é æ€§ é™æµé…ç½®: é˜²æ­¢æ¶ˆè´¹è€…è¿‡è½½ æ­»ä¿¡é˜Ÿåˆ—: å¤„ç†å¤±è´¥æ¶ˆæ¯ 1.2 é…ç½®æ–‡ä»¶æ›´æ–° æ–‡ä»¶ä½ç½®: sky-server/src/main/resources/application.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 # åœ¨ç°æœ‰é…ç½®åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹é…ç½® spring: # RabbitMQé…ç½® rabbitmq: host: ${sky.rabbitmq.host:localhost} port: ${sky.rabbitmq.port:5672} username: ${sky.rabbitmq.username:guest} password: ${sky.rabbitmq.password:guest} virtual-host: ${sky.rabbitmq.virtual-host:/} connection-timeout: 15000 publisher-confirm-type: correlated publisher-returns: true listener: simple: acknowledge-mode: manual retry: enabled: true max-attempts: 3 initial-interval: 1000 max-interval: 10000 multiplier: 2 concurrency: 3 max-concurrency: 10 prefetch: 1 # Redisé…ç½® redis: host: ${sky.redis.host} port: ${sky.redis.port} database: ${sky.redis.database} password: ${sky.redis.password} timeout: 5000ms lettuce: pool: max-active: 8 max-wait: -1ms max-idle: 8 min-idle: 0 # æ—¥å¿—é…ç½® logging: level: com: sky: mapper: debug service: info controller: info org.springframework.amqp: debug pattern: console: \u0026#34;%clr(%d{yyyy-MM-dd HH:mm:ss}){faint} %clr([%thread]){faint} %clr(%-5level) %clr(%logger{36}){cyan} %clr(-){faint} %msg%n\u0026#34; file: \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34; file: name: logs/sky-server.log max-size: 100MB max-history: 30 # è‡ªå®šä¹‰é…ç½® sky: redis: seckill: prefix: \u0026#34;seckill:\u0026#34; é…ç½®è¯´æ˜:\nè¿æ¥é…ç½®: æ”¯æŒç¯å¢ƒå˜é‡é…ç½® ç¡®è®¤æœºåˆ¶: æ”¯æŒæ¶ˆæ¯ç¡®è®¤å’Œè¿”å› é‡è¯•æœºåˆ¶: æ”¯æŒæ¶ˆæ¯é‡è¯• é™æµé…ç½®: æ”¯æŒæ¶ˆè´¹è€…é™æµ 2. æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡ 2.1 æ¶ˆæ¯ç”Ÿäº§è€…æ¥å£ æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/MessageProducerService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package com.sky.service; import com.sky.entity.message.OrderPayMessage; import com.sky.entity.message.OrderTimeoutMessage; import com.sky.entity.message.PointsEarnMessage; /** * æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡æ¥å£ * å®šä¹‰æ¶ˆæ¯å‘é€çš„æ¥å£è§„èŒƒ */ public interface MessageProducerService { /** * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ * @param message è®¢å•æ”¯ä»˜æ¶ˆæ¯ */ void sendOrderPayMessage(OrderPayMessage message); /** * å‘é€ç§¯åˆ†è·å¾—æ¶ˆæ¯ * @param message ç§¯åˆ†è·å¾—æ¶ˆæ¯ */ void sendPointsEarnMessage(PointsEarnMessage message); /** * å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯ * @param message è®¢å•è¶…æ—¶æ¶ˆæ¯ */ void sendOrderTimeoutMessage(OrderTimeoutMessage message); } 2.2 æ¶ˆæ¯ç”Ÿäº§è€…å®ç° æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/impl/MessageProducerServiceImpl.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 package com.sky.service.impl; import com.sky.entity.message.OrderPayMessage; import com.sky.entity.message.OrderTimeoutMessage; import com.sky.entity.message.PointsEarnMessage; import com.sky.service.MessageProducerService; import lombok.extern.slf4j.Slf4j; import org.springframework.amqp.core.MessageDeliveryMode; import org.springframework.amqp.rabbit.core.RabbitTemplate; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Service; /** * æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡å®ç°ç±» * å®ç°æ¶ˆæ¯å‘é€çš„å…·ä½“é€»è¾‘ */ @Service @Slf4j public class MessageProducerServiceImpl implements MessageProducerService { @Autowired private RabbitTemplate rabbitTemplate; /** * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ * ç”¨äºå¼‚æ­¥å¤„ç†è®¢å•æ”¯ä»˜åçš„ä¸šåŠ¡é€»è¾‘ */ @Override public void sendOrderPayMessage(OrderPayMessage message) { try { rabbitTemplate.convertAndSend( \u0026#34;order.exchange\u0026#34;, \u0026#34;order.pay\u0026#34;, message, msg -\u0026gt; { msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); return msg; } ); log.info(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å‘é€æˆåŠŸ: {}\u0026#34;, message); } catch (Exception e) { log.error(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, message, e); throw new RuntimeException(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥\u0026#34;, e); } } /** * å‘é€ç§¯åˆ†è·å¾—æ¶ˆæ¯ * ç”¨äºå¼‚æ­¥å¤„ç†ç”¨æˆ·ç§¯åˆ†å¢åŠ  */ @Override public void sendPointsEarnMessage(PointsEarnMessage message) { try { rabbitTemplate.convertAndSend( \u0026#34;points.exchange\u0026#34;, \u0026#34;points.earn\u0026#34;, message, msg -\u0026gt; { msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); return msg; } ); log.info(\u0026#34;ç§¯åˆ†è·å¾—æ¶ˆæ¯å‘é€æˆåŠŸ: {}\u0026#34;, message); } catch (Exception e) { log.error(\u0026#34;ç§¯åˆ†è·å¾—æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, message, e); throw new RuntimeException(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥\u0026#34;, e); } } /** * å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯ * ç”¨äºå¼‚æ­¥å¤„ç†è®¢å•è¶…æ—¶å–æ¶ˆ */ @Override public void sendOrderTimeoutMessage(OrderTimeoutMessage message) { try { rabbitTemplate.convertAndSend( \u0026#34;order.timeout.exchange\u0026#34;, \u0026#34;order.timeout\u0026#34;, message, msg -\u0026gt; { msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); return msg; } ); log.info(\u0026#34;è®¢å•è¶…æ—¶æ¶ˆæ¯å‘é€æˆåŠŸ: {}\u0026#34;, message); } catch (Exception e) { log.error(\u0026#34;è®¢å•è¶…æ—¶æ¶ˆæ¯å‘é€å¤±è´¥: {}\u0026#34;, message, e); throw new RuntimeException(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥\u0026#34;, e); } } } è®¾è®¡ç‰¹ç‚¹:\næ¶ˆæ¯æŒä¹…åŒ–: ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤± å¼‚å¸¸å¤„ç†: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ æ—¥å¿—è®°å½•: è¯¦ç»†çš„æ“ä½œæ—¥å¿— å¼‚æ­¥å¤„ç†: æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ 3. æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡ 3.1 æ¶ˆæ¯æ¶ˆè´¹è€…æ¥å£ æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/MessageConsumerService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package com.sky.service; import com.sky.entity.message.OrderPayMessage; import com.sky.entity.message.OrderTimeoutMessage; import com.sky.entity.message.PointsEarnMessage; /** * æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡æ¥å£ * å®šä¹‰æ¶ˆæ¯æ¶ˆè´¹çš„æ¥å£è§„èŒƒ */ public interface MessageConsumerService { /** * å¤„ç†è®¢å•æ”¯ä»˜æ¶ˆæ¯ * @param message è®¢å•æ”¯ä»˜æ¶ˆæ¯ */ void handleOrderPayMessage(OrderPayMessage message); /** * å¤„ç†ç§¯åˆ†è·å¾—æ¶ˆæ¯ * @param message ç§¯åˆ†è·å¾—æ¶ˆæ¯ */ void handlePointsEarnMessage(PointsEarnMessage message); /** * å¤„ç†è®¢å•è¶…æ—¶æ¶ˆæ¯ * @param message è®¢å•è¶…æ—¶æ¶ˆæ¯ */ void handleOrderTimeoutMessage(OrderTimeoutMessage message); } 3.2 æ¶ˆæ¯æ¶ˆè´¹è€…å®ç° æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/impl/MessageConsumerServiceImpl.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 package com.sky.service.impl; import com.rabbitmq.client.Channel; import com.sky.entity.message.OrderPayMessage; import com.sky.entity.message.OrderTimeoutMessage; import com.sky.entity.message.PointsEarnMessage; import com.sky.service.MessageConsumerService; import com.sky.service.MessageProducerService; import com.sky.service.OrderService; import com.sky.service.UserService; import lombok.extern.slf4j.Slf4j; import org.springframework.amqp.rabbit.annotation.RabbitListener; import org.springframework.amqp.support.AmqpHeaders; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.messaging.handler.annotation.Header; import org.springframework.stereotype.Service; import java.io.IOException; /** * æ¶ˆæ¯æ¶ˆè´¹è€…æœåŠ¡å®ç°ç±» * å®ç°æ¶ˆæ¯æ¶ˆè´¹çš„å…·ä½“é€»è¾‘ */ @Service @Slf4j public class MessageConsumerServiceImpl implements MessageConsumerService { @Autowired private OrderService orderService; @Autowired private UserService userService; @Autowired private MessageProducerService messageProducerService; /** * å¤„ç†è®¢å•æ”¯ä»˜æ¶ˆæ¯ * å¼‚æ­¥å¤„ç†è®¢å•æ”¯ä»˜åçš„ä¸šåŠ¡é€»è¾‘ */ @RabbitListener(queues = \u0026#34;order.queue\u0026#34;) public void handleOrderPayMessage(OrderPayMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { log.info(\u0026#34;æ”¶åˆ°è®¢å•æ”¯ä»˜æ¶ˆæ¯: {}\u0026#34;, message); // å¤„ç†è®¢å•æ”¯ä»˜ orderService.processOrderPayment(message.getOrderId(), message.getAmount()); // å‘é€ç§¯åˆ†è·å¾—æ¶ˆæ¯ PointsEarnMessage pointsMessage = PointsEarnMessage.builder() .userId(message.getUserId()) .orderId(message.getOrderId()) .points(calculatePoints(message.getAmount())) .earnTime(message.getPayTime()) .build(); messageProducerService.sendPointsEarnMessage(pointsMessage); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}\u0026#34;, message); } catch (Exception e) { log.error(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤„ç†å¤±è´¥: {}\u0026#34;, message, e); try { // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, false); } catch (IOException ioException) { log.error(\u0026#34;æ¶ˆæ¯æ‹’ç»å¤±è´¥\u0026#34;, ioException); } } } /** * å¤„ç†ç§¯åˆ†è·å¾—æ¶ˆæ¯ * å¼‚æ­¥å¤„ç†ç”¨æˆ·ç§¯åˆ†å¢åŠ  */ @RabbitListener(queues = \u0026#34;points.queue\u0026#34;) public void handlePointsEarnMessage(PointsEarnMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { log.info(\u0026#34;æ”¶åˆ°ç§¯åˆ†è·å¾—æ¶ˆæ¯: {}\u0026#34;, message); // æ·»åŠ ç”¨æˆ·ç§¯åˆ† userService.addUserPoints(message.getUserId(), message.getPoints(), message.getOrderId()); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;ç§¯åˆ†è·å¾—æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}\u0026#34;, message); } catch (Exception e) { log.error(\u0026#34;ç§¯åˆ†è·å¾—æ¶ˆæ¯å¤„ç†å¤±è´¥: {}\u0026#34;, message, e); try { // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, false); } catch (IOException ioException) { log.error(\u0026#34;æ¶ˆæ¯æ‹’ç»å¤±è´¥\u0026#34;, ioException); } } } /** * å¤„ç†è®¢å•è¶…æ—¶æ¶ˆæ¯ * å¼‚æ­¥å¤„ç†è®¢å•è¶…æ—¶å–æ¶ˆ */ @RabbitListener(queues = \u0026#34;order.timeout.queue\u0026#34;) public void handleOrderTimeoutMessage(OrderTimeoutMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { log.info(\u0026#34;æ”¶åˆ°è®¢å•è¶…æ—¶æ¶ˆæ¯: {}\u0026#34;, message); // å–æ¶ˆè¶…æ—¶è®¢å• orderService.cancelTimeoutOrder(message.getOrderId()); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;è®¢å•è¶…æ—¶æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}\u0026#34;, message); } catch (Exception e) { log.error(\u0026#34;è®¢å•è¶…æ—¶æ¶ˆæ¯å¤„ç†å¤±è´¥: {}\u0026#34;, message, e); try { // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, false); } catch (IOException ioException) { log.error(\u0026#34;æ¶ˆæ¯æ‹’ç»å¤±è´¥\u0026#34;, ioException); } } } /** * è®¡ç®—ç§¯åˆ† * æ ¹æ®è®¢å•é‡‘é¢è®¡ç®—ç”¨æˆ·è·å¾—çš„ç§¯åˆ† */ private Integer calculatePoints(java.math.BigDecimal amount) { // æ¯æ¶ˆè´¹1å…ƒè·å¾—1ç§¯åˆ† return amount.intValue(); } } è®¾è®¡ç‰¹ç‚¹:\næ‰‹åŠ¨ç¡®è®¤: ç¡®ä¿æ¶ˆæ¯å¤„ç†æˆåŠŸåæ‰ç¡®è®¤ å¼‚å¸¸å¤„ç†: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ ä¸šåŠ¡è§£è€¦: é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ä¸šåŠ¡é€»è¾‘ å¼‚æ­¥å¤„ç†: æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ 4. ç”¨æˆ·ç«¯APIæ¥å£ 4.1 ç”¨æˆ·ç«¯ç§’æ€æ´»åŠ¨æ§åˆ¶å™¨ æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/controller/user/UserSeckillActivityController.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 package com.sky.controller.user; import com.sky.entity.SeckillActivity; import com.sky.result.Result; import com.sky.service.SeckillActivityService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.util.List; /** * ç”¨æˆ·ç«¯ç§’æ€æ´»åŠ¨æ§åˆ¶å™¨ * æä¾›ç§’æ€æ´»åŠ¨ç›¸å…³çš„ç”¨æˆ·ç«¯æ¥å£ */ @RestController @RequestMapping(\u0026#34;/user/seckill/activity\u0026#34;) @Api(tags = \u0026#34;ç”¨æˆ·ç«¯ç§’æ€æ´»åŠ¨\u0026#34;) @Slf4j public class UserSeckillActivityController { @Autowired private SeckillActivityService seckillActivityService; @GetMapping(\u0026#34;/current\u0026#34;) @ApiOperation(\u0026#34;è·å–å½“å‰è¿›è¡Œä¸­çš„ç§’æ€æ´»åŠ¨\u0026#34;) public Result\u0026lt;List\u0026lt;SeckillActivity\u0026gt;\u0026gt; getCurrentActivities() { log.info(\u0026#34;è·å–å½“å‰è¿›è¡Œä¸­çš„ç§’æ€æ´»åŠ¨\u0026#34;); List\u0026lt;SeckillActivity\u0026gt; activities = seckillActivityService.getCurrentActivities(); return Result.success(activities); } @GetMapping(\u0026#34;/{id}\u0026#34;) @ApiOperation(\u0026#34;æ ¹æ®idæŸ¥è¯¢ç§’æ€æ´»åŠ¨è¯¦æƒ…\u0026#34;) public Result\u0026lt;SeckillActivity\u0026gt; getById(@PathVariable Long id) { log.info(\u0026#34;æ ¹æ®idæŸ¥è¯¢ç§’æ€æ´»åŠ¨è¯¦æƒ…ï¼š{}\u0026#34;, id); SeckillActivity seckillActivity = seckillActivityService.getById(id); return Result.success(seckillActivity); } @PostMapping(\u0026#34;/participate/{id}\u0026#34;) @ApiOperation(\u0026#34;å‚ä¸ç§’æ€æ´»åŠ¨\u0026#34;) public Result\u0026lt;String\u0026gt; participateSeckill(@PathVariable Long id, @RequestParam Integer quantity, @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;ç”¨æˆ·å‚ä¸ç§’æ€æ´»åŠ¨ï¼šid={}, quantity={}, userId={}\u0026#34;, id, quantity, userId); String result = seckillActivityService.participateSeckill(id, userId, quantity); return Result.success(result); } } æ¥å£è¯´æ˜:\nè·å–æ´»åŠ¨åˆ—è¡¨: è·å–å½“å‰å¯å‚ä¸çš„ç§’æ€æ´»åŠ¨ æ´»åŠ¨è¯¦æƒ…: è·å–æŒ‡å®šæ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ å‚ä¸ç§’æ€: ç”¨æˆ·å‚ä¸ç§’æ€æ´»åŠ¨ 4.2 ç”¨æˆ·ç«¯ä¼˜æƒ åˆ¸æ§åˆ¶å™¨ æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/controller/user/UserCouponController.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 package com.sky.controller.user; import com.sky.entity.Coupon; import com.sky.entity.CouponTemplate; import com.sky.result.Result; import com.sky.service.CouponService; import com.sky.service.CouponTemplateService; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; import java.math.BigDecimal; import java.util.List; /** * ç”¨æˆ·ç«¯ä¼˜æƒ åˆ¸æ§åˆ¶å™¨ * æä¾›ä¼˜æƒ åˆ¸ç›¸å…³çš„ç”¨æˆ·ç«¯æ¥å£ */ @RestController @RequestMapping(\u0026#34;/user/coupon\u0026#34;) @Api(tags = \u0026#34;ç”¨æˆ·ç«¯ä¼˜æƒ åˆ¸\u0026#34;) @Slf4j public class UserCouponController { @Autowired private CouponTemplateService couponTemplateService; @Autowired private CouponService couponService; @GetMapping(\u0026#34;/templates/available\u0026#34;) @ApiOperation(\u0026#34;è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿\u0026#34;) public Result\u0026lt;List\u0026lt;CouponTemplate\u0026gt;\u0026gt; getAvailableTemplates() { log.info(\u0026#34;è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿\u0026#34;); List\u0026lt;CouponTemplate\u0026gt; templates = couponTemplateService.getAvailableTemplates(); return Result.success(templates); } @PostMapping(\u0026#34;/claim\u0026#34;) @ApiOperation(\u0026#34;é¢†å–ä¼˜æƒ åˆ¸\u0026#34;) public Result\u0026lt;String\u0026gt; claimCoupon(@RequestParam Long templateId, @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸ï¼štemplateId={}, userId={}\u0026#34;, templateId, userId); String result = couponService.claimCoupon(templateId, userId); return Result.success(result); } @GetMapping(\u0026#34;/my\u0026#34;) @ApiOperation(\u0026#34;è·å–æˆ‘çš„ä¼˜æƒ åˆ¸\u0026#34;) public Result\u0026lt;List\u0026lt;Coupon\u0026gt;\u0026gt; getMyCoupons(@RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;è·å–ç”¨æˆ·ä¼˜æƒ åˆ¸ï¼šuserId={}\u0026#34;, userId); List\u0026lt;Coupon\u0026gt; coupons = couponService.getUserAvailableCoupons(userId); return Result.success(coupons); } @PostMapping(\u0026#34;/check\u0026#34;) @ApiOperation(\u0026#34;æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨\u0026#34;) public Result\u0026lt;String\u0026gt; checkCouponAvailable(@RequestParam Long couponId, @RequestParam BigDecimal orderAmount, @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { log.info(\u0026#34;æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨ï¼šcouponId={}, orderAmount={}, userId={}\u0026#34;, couponId, orderAmount, userId); String result = couponService.checkCouponAvailable(couponId, userId, orderAmount); return Result.success(result); } } æ¥å£è¯´æ˜:\nè·å–ä¼˜æƒ åˆ¸æ¨¡æ¿: è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿ é¢†å–ä¼˜æƒ åˆ¸: ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸ æˆ‘çš„ä¼˜æƒ åˆ¸: è·å–ç”¨æˆ·çš„ä¼˜æƒ åˆ¸åˆ—è¡¨ æ£€æŸ¥ä¼˜æƒ åˆ¸: æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨ 4.3 å¥åº·æ£€æŸ¥æ§åˆ¶å™¨ æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/controller/HealthController.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 package com.sky.controller; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import java.util.HashMap; import java.util.Map; /** * å¥åº·æ£€æŸ¥æ§åˆ¶å™¨ * æä¾›ç³»ç»Ÿå¥åº·çŠ¶æ€æ£€æŸ¥æ¥å£ */ @RestController @RequestMapping(\u0026#34;/health\u0026#34;) public class HealthController { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @GetMapping(\u0026#34;/check\u0026#34;) public Map\u0026lt;String, Object\u0026gt; healthCheck() { Map\u0026lt;String, Object\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); // æ£€æŸ¥Redisè¿æ¥ try { redisTemplate.opsForValue().get(\u0026#34;health:check\u0026#34;); result.put(\u0026#34;redis\u0026#34;, \u0026#34;UP\u0026#34;); } catch (Exception e) { result.put(\u0026#34;redis\u0026#34;, \u0026#34;DOWN\u0026#34;); } // æ£€æŸ¥åº”ç”¨çŠ¶æ€ result.put(\u0026#34;application\u0026#34;, \u0026#34;UP\u0026#34;); result.put(\u0026#34;timestamp\u0026#34;, System.currentTimeMillis()); return result; } } åŠŸèƒ½è¯´æ˜:\nRedisæ£€æŸ¥: æ£€æŸ¥Redisè¿æ¥çŠ¶æ€ åº”ç”¨çŠ¶æ€: æ£€æŸ¥åº”ç”¨è¿è¡ŒçŠ¶æ€ æ—¶é—´æˆ³: è¿”å›æ£€æŸ¥æ—¶é—´ 5. Nginxé…ç½®æ›´æ–° æ–‡ä»¶ä½ç½®: nginx-conf/New file.txt\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # åœ¨ç°æœ‰é…ç½®åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹é…ç½® # ç§’æ€æ´»åŠ¨ç›¸å…³æ¥å£ location /seckill/ { proxy_pass http://localhost:8084/user/seckill/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } # ä¼˜æƒ åˆ¸ç›¸å…³æ¥å£ location /coupon/ { proxy_pass http://localhost:8084/user/coupon/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } # å¥åº·æ£€æŸ¥æ¥å£ location /health/ { proxy_pass http://localhost:8084/health/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } é…ç½®è¯´æ˜:\nåå‘ä»£ç†: å°†è¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡ è¯·æ±‚å¤´è®¾ç½®: ä¿æŒåŸå§‹è¯·æ±‚ä¿¡æ¯ è´Ÿè½½å‡è¡¡: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½² 6. å…³é”®ç‰¹æ€§ 6.1 æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ æ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡å®Œå…¨è§£è€¦ å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½ æ¶ˆæ¯æŒä¹…åŒ–ä¿è¯å¯é æ€§ 6.2 å‰Šå³°å¡«è°· æ¶ˆè´¹è€…å®¹å™¨å·¥å‚é™æµé…ç½® æ‰‹åŠ¨ACKæœºåˆ¶ æ¶ˆæ¯é‡è¯•æœºåˆ¶ 6.3 å»¶è¿Ÿæ¶ˆæ¯å¤„ç† è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥æ¶ˆæ¯ æ¶ˆæ¯TTLè®¾ç½® 6.4 æœåŠ¡ç›‘æ§ å¥åº·æ£€æŸ¥æ¥å£ æ—¥å¿—å½©è‰²è¾“å‡º æ€§èƒ½ç›‘æ§ 7. æµ‹è¯•å»ºè®® 7.1 æ¶ˆæ¯é˜Ÿåˆ—æµ‹è¯• æ¶ˆæ¯å‘é€æµ‹è¯•: æµ‹è¯•å„ç§æ¶ˆæ¯çš„å‘é€ æ¶ˆæ¯æ¶ˆè´¹æµ‹è¯•: æµ‹è¯•æ¶ˆæ¯çš„æ¶ˆè´¹å¤„ç† å¼‚å¸¸å¤„ç†æµ‹è¯•: æµ‹è¯•æ¶ˆæ¯å¤„ç†å¼‚å¸¸æƒ…å†µ æ€§èƒ½æµ‹è¯•: æµ‹è¯•é«˜å¹¶å‘æ¶ˆæ¯å¤„ç† 7.2 APIæ¥å£æµ‹è¯• ç§’æ€æ¥å£æµ‹è¯•: æµ‹è¯•ç§’æ€æ´»åŠ¨çš„å‚ä¸ ä¼˜æƒ åˆ¸æ¥å£æµ‹è¯•: æµ‹è¯•ä¼˜æƒ åˆ¸çš„é¢†å–å’Œä½¿ç”¨ å¥åº·æ£€æŸ¥æµ‹è¯•: æµ‹è¯•ç³»ç»Ÿå¥åº·çŠ¶æ€ å¹¶å‘æµ‹è¯•: æµ‹è¯•é«˜å¹¶å‘åœºæ™¯ 8. éƒ¨ç½²æ³¨æ„äº‹é¡¹ RabbitMQé…ç½®: ç¡®ä¿RabbitMQæœåŠ¡æ­£å¸¸è¿è¡Œ Redisé…ç½®: ç¡®ä¿Redisè¿æ¥é…ç½®æ­£ç¡® æ—¥å¿—é…ç½®: ç¡®ä¿æ—¥å¿—æ–‡ä»¶è·¯å¾„å­˜åœ¨ Nginxé…ç½®: ç¡®ä¿åå‘ä»£ç†é…ç½®æ­£ç¡® 9. æ¶ˆæ¯é˜Ÿåˆ—é«˜çº§ç‰¹æ€§ 9.1 æ¶ˆæ¯å¯é æ€§ä¿è¯ 9.1.1 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ ç¡®è®¤æ¨¡å¼é…ç½®:\n1 2 3 4 5 6 spring: rabbitmq: publisher-confirm-type: correlated publisher-returns: true template: mandatory: true ç¡®è®¤å›è°ƒå¤„ç†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Configuration public class RabbitMQConfirmConfig { @Bean public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); // è®¾ç½®ç¡®è®¤å›è°ƒ template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸ: {}\u0026#34;, correlationData.getId()); } else { log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥: {}, åŸå› : {}\u0026#34;, correlationData.getId(), cause); } }); // è®¾ç½®è¿”å›å›è°ƒ template.setReturnsCallback(returned -\u0026gt; { log.error(\u0026#34;æ¶ˆæ¯è·¯ç”±å¤±è´¥: {}, å›å¤ç : {}, å›å¤æ–‡æœ¬: {}\u0026#34;, returned.getMessage(), returned.getReplyCode(), returned.getReplyText()); }); return template; } } 9.1.2 æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ æ‰‹åŠ¨ç¡®è®¤é…ç½®:\n1 2 3 4 5 6 7 8 9 spring: rabbitmq: listener: simple: acknowledge-mode: manual retry: enabled: true max-attempts: 3 initial-interval: 1000 æ¶ˆæ¯å¤„ç†ç¤ºä¾‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @RabbitListener(queues = \u0026#34;order.pay.queue\u0026#34;) public void handleOrderPay(OrderPayMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { // å¤„ç†ä¸šåŠ¡é€»è¾‘ processOrderPayment(message); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); log.info(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}\u0026#34;, message.getOrderId()); } catch (Exception e) { try { // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, true); log.error(\u0026#34;è®¢å•æ”¯ä»˜æ¶ˆæ¯å¤„ç†å¤±è´¥: {}\u0026#34;, message.getOrderId(), e); } catch (IOException ioException) { log.error(\u0026#34;æ¶ˆæ¯ç¡®è®¤å¤±è´¥\u0026#34;, ioException); } } } 9.2 æ¶ˆæ¯æŒä¹…åŒ– 9.2.1 é˜Ÿåˆ—æŒä¹…åŒ– é˜Ÿåˆ—é…ç½®:\n1 2 3 4 5 6 7 @Bean public Queue orderPayQueue() { return QueueBuilder.durable(\u0026#34;order.pay.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 300000) // æ¶ˆæ¯TTL 5åˆ†é’Ÿ .withArgument(\u0026#34;x-max-length\u0026#34;, 10000) // æœ€å¤§é•¿åº¦ .build(); } äº¤æ¢æœºæŒä¹…åŒ–:\n1 2 3 4 5 6 @Bean public TopicExchange orderExchange() { return ExchangeBuilder.topicExchange(\u0026#34;order.exchange\u0026#34;) .durable(true) .build(); } 9.2.2 æ¶ˆæ¯æŒä¹…åŒ– æ¶ˆæ¯å±æ€§è®¾ç½®:\n1 2 3 4 5 6 7 8 9 10 public void sendOrderPayMessage(OrderPayMessage message) { MessageProperties properties = new MessageProperties(); properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); properties.setPriority(5); properties.setExpiration(\u0026#34;300000\u0026#34;); // 5åˆ†é’Ÿè¿‡æœŸ Message msg = new Message(JSON.toJSONBytes(message), properties); rabbitTemplate.convertAndSend(\u0026#34;order.exchange\u0026#34;, \u0026#34;order.pay\u0026#34;, msg); } 9.3 æ­»ä¿¡é˜Ÿåˆ— 9.3.1 æ­»ä¿¡é˜Ÿåˆ—é…ç½® æ­»ä¿¡äº¤æ¢æœºé…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Bean public TopicExchange deadLetterExchange() { return ExchangeBuilder.topicExchange(\u0026#34;dead.letter.exchange\u0026#34;) .durable(true) .build(); } @Bean public Queue deadLetterQueue() { return QueueBuilder.durable(\u0026#34;dead.letter.queue\u0026#34;).build(); } @Bean public Binding deadLetterBinding() { return BindingBuilder.bind(deadLetterQueue()) .to(deadLetterExchange()) .with(\u0026#34;dead.letter.#\u0026#34;); } ä¸šåŠ¡é˜Ÿåˆ—é…ç½®:\n1 2 3 4 5 6 7 8 @Bean public Queue orderPayQueue() { return QueueBuilder.durable(\u0026#34;order.pay.queue\u0026#34;) .withArgument(\u0026#34;x-dead-letter-exchange\u0026#34;, \u0026#34;dead.letter.exchange\u0026#34;) .withArgument(\u0026#34;x-dead-letter-routing-key\u0026#34;, \u0026#34;dead.letter.order.pay\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 300000) .build(); } 9.3.2 æ­»ä¿¡å¤„ç† æ­»ä¿¡æ¶ˆæ¯å¤„ç†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 @RabbitListener(queues = \u0026#34;dead.letter.queue\u0026#34;) public void handleDeadLetter(String message, @Header(\u0026#34;x-dead-letter-reason\u0026#34;) String reason) { log.warn(\u0026#34;æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯: {}, åŸå› : {}\u0026#34;, message, reason); // æ ¹æ®æ­»ä¿¡åŸå› è¿›è¡Œä¸åŒå¤„ç† if (\u0026#34;expired\u0026#34;.equals(reason)) { // å¤„ç†è¿‡æœŸæ¶ˆæ¯ handleExpiredMessage(message); } else if (\u0026#34;rejected\u0026#34;.equals(reason)) { // å¤„ç†è¢«æ‹’ç»çš„æ¶ˆæ¯ handleRejectedMessage(message); } } 9.4 æ¶ˆæ¯å¹‚ç­‰æ€§ 9.4.1 å¹‚ç­‰æ€§ä¿è¯ æ¶ˆæ¯å»é‡:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Service public class MessageIdempotencyService { @Autowired private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; private static final String MESSAGE_PROCESSED_KEY = \u0026#34;message:processed:\u0026#34;; private static final int EXPIRE_TIME = 3600; // 1å°æ—¶ public boolean isMessageProcessed(String messageId) { String key = MESSAGE_PROCESSED_KEY + messageId; return redisTemplate.hasKey(key); } public void markMessageProcessed(String messageId) { String key = MESSAGE_PROCESSED_KEY + messageId; redisTemplate.opsForValue().set(key, \u0026#34;1\u0026#34;, EXPIRE_TIME, TimeUnit.SECONDS); } } å¹‚ç­‰æ€§å¤„ç†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 @RabbitListener(queues = \u0026#34;order.pay.queue\u0026#34;) public void handleOrderPay(OrderPayMessage message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { String messageId = message.getMessageId(); // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç† if (messageIdempotencyService.isMessageProcessed(messageId)) { log.info(\u0026#34;æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}\u0026#34;, messageId); channel.basicAck(deliveryTag, false); return; } try { // å¤„ç†ä¸šåŠ¡é€»è¾‘ processOrderPayment(message); // æ ‡è®°æ¶ˆæ¯å·²å¤„ç† messageIdempotencyService.markMessageProcessed(messageId); // ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); } catch (Exception e) { log.error(\u0026#34;æ¶ˆæ¯å¤„ç†å¤±è´¥: {}\u0026#34;, messageId, e); // æ‹’ç»æ¶ˆæ¯ channel.basicNack(deliveryTag, false, false); } } 10. æµæ§å’Œç†”æ–­ 10.1 Sentinelæµæ§ 10.1.1 æµæ§è§„åˆ™é…ç½® æµæ§è§„åˆ™å®šä¹‰:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Component public class SentinelFlowControlConfig { @PostConstruct public void initFlowRules() { List\u0026lt;FlowRule\u0026gt; rules = new ArrayList\u0026lt;\u0026gt;(); // ç§’æ€æ¥å£æµæ§ FlowRule seckillRule = new FlowRule(); seckillRule.setResource(\u0026#34;seckill:participate\u0026#34;); seckillRule.setGrade(RuleConstant.FLOW_GRADE_QPS); seckillRule.setCount(100); // æ¯ç§’100ä¸ªè¯·æ±‚ seckillRule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER); rules.add(seckillRule); // ä¼˜æƒ åˆ¸æ¥å£æµæ§ FlowRule couponRule = new FlowRule(); couponRule.setResource(\u0026#34;coupon:claim\u0026#34;); couponRule.setGrade(RuleConstant.FLOW_GRADE_QPS); couponRule.setCount(50); // æ¯ç§’50ä¸ªè¯·æ±‚ couponRule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER); rules.add(couponRule); FlowRuleManager.loadRules(rules); } } 10.1.2 æµæ§å¤„ç† æµæ§å¼‚å¸¸å¤„ç†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @RestController public class SeckillController { @SentinelResource(value = \u0026#34;seckill:participate\u0026#34;, blockHandler = \u0026#34;handleSeckillBlock\u0026#34;, fallback = \u0026#34;handleSeckillFallback\u0026#34;) @PostMapping(\u0026#34;/seckill/participate\u0026#34;) public Result participateSeckill(@RequestBody SeckillParticipateDTO dto) { return seckillService.participateSeckill(dto); } public Result handleSeckillBlock(SeckillParticipateDTO dto, BlockException ex) { log.warn(\u0026#34;ç§’æ€æ¥å£è¢«æµæ§: {}\u0026#34;, ex.getMessage()); return Result.error(\u0026#34;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } public Result handleSeckillFallback(SeckillParticipateDTO dto, Throwable ex) { log.error(\u0026#34;ç§’æ€æ¥å£å¼‚å¸¸: {}\u0026#34;, ex.getMessage()); return Result.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } } 10.2 ç†”æ–­é™çº§ 10.2.1 ç†”æ–­è§„åˆ™é…ç½® ç†”æ–­è§„åˆ™å®šä¹‰:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Component public class SentinelCircuitBreakerConfig { @PostConstruct public void initCircuitBreakerRules() { List\u0026lt;CircuitBreakerRule\u0026gt; rules = new ArrayList\u0026lt;\u0026gt;(); // æ•°æ®åº“ç†”æ–­è§„åˆ™ CircuitBreakerRule dbRule = new CircuitBreakerRule(); dbRule.setResource(\u0026#34;database:query\u0026#34;); dbRule.setGrade(RuleConstant.DEGRADE_GRADE_RT); dbRule.setCount(100); // å¹³å‡å“åº”æ—¶é—´100ms dbRule.setTimeWindow(10); // ç†”æ–­æ—¶é•¿10ç§’ dbRule.setMinRequestAmount(5); // æœ€å°è¯·æ±‚æ•° dbRule.setStatIntervalMs(1000); // ç»Ÿè®¡æ—¶é•¿1ç§’ rules.add(dbRule); // Redisç†”æ–­è§„åˆ™ CircuitBreakerRule redisRule = new CircuitBreakerRule(); redisRule.setResource(\u0026#34;redis:operation\u0026#34;); redisRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO); redisRule.setCount(0.5); // å¼‚å¸¸æ¯”ä¾‹50% redisRule.setTimeWindow(10); redisRule.setMinRequestAmount(5); redisRule.setStatIntervalMs(1000); rules.add(redisRule); CircuitBreakerRuleManager.loadRules(rules); } } 10.2.2 ç†”æ–­å¤„ç† ç†”æ–­é™çº§å¤„ç†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 @Service public class SeckillService { @SentinelResource(value = \u0026#34;database:query\u0026#34;, fallback = \u0026#34;fallbackQueryActivity\u0026#34;) public SeckillActivity queryActivity(Long activityId) { return seckillActivityMapper.selectById(activityId); } public SeckillActivity fallbackQueryActivity(Long activityId, Throwable ex) { log.error(\u0026#34;æ•°æ®åº“æŸ¥è¯¢ç†”æ–­: {}\u0026#34;, ex.getMessage()); // è¿”å›ç¼“å­˜æ•°æ®æˆ–é»˜è®¤å€¼ return getCachedActivity(activityId); } @SentinelResource(value = \u0026#34;redis:operation\u0026#34;, fallback = \u0026#34;fallbackRedisOperation\u0026#34;) public void updateStock(Long activityId, Integer quantity) { redisTemplate.opsForValue().decrement(\u0026#34;seckill:stock:\u0026#34; + activityId, quantity); } public void fallbackRedisOperation(Long activityId, Integer quantity, Throwable ex) { log.error(\u0026#34;Redisæ“ä½œç†”æ–­: {}\u0026#34;, ex.getMessage()); // é™çº§å¤„ç†ï¼šç›´æ¥æ›´æ–°æ•°æ®åº“ updateStockInDatabase(activityId, quantity); } } 11. ç›‘æ§å’Œå‘Šè­¦ 11.1 åº”ç”¨ç›‘æ§ 11.1.1 æŒ‡æ ‡æ”¶é›† è‡ªå®šä¹‰æŒ‡æ ‡:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Component public class BusinessMetrics { private final MeterRegistry meterRegistry; private final Counter seckillSuccessCounter; private final Counter seckillFailCounter; private final Timer seckillTimer; public BusinessMetrics(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.seckillSuccessCounter = Counter.builder(\u0026#34;seckill.success\u0026#34;) .description(\u0026#34;ç§’æ€æˆåŠŸæ¬¡æ•°\u0026#34;) .register(meterRegistry); this.seckillFailCounter = Counter.builder(\u0026#34;seckill.fail\u0026#34;) .description(\u0026#34;ç§’æ€å¤±è´¥æ¬¡æ•°\u0026#34;) .register(meterRegistry); this.seckillTimer = Timer.builder(\u0026#34;seckill.duration\u0026#34;) .description(\u0026#34;ç§’æ€å¤„ç†æ—¶é—´\u0026#34;) .register(meterRegistry); } public void recordSeckillSuccess() { seckillSuccessCounter.increment(); } public void recordSeckillFail() { seckillFailCounter.increment(); } public void recordSeckillDuration(Duration duration) { seckillTimer.record(duration); } } 11.1.2 å¥åº·æ£€æŸ¥ å¥åº·æ£€æŸ¥é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Component public class CustomHealthIndicator implements HealthIndicator { @Autowired private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; @Autowired private DataSource dataSource; @Override public Health health() { Health.Builder builder = new Health.Builder(); // æ£€æŸ¥Redisè¿æ¥ try { redisTemplate.opsForValue().get(\u0026#34;health:check\u0026#34;); builder.withDetail(\u0026#34;redis\u0026#34;, \u0026#34;UP\u0026#34;); } catch (Exception e) { builder.down().withDetail(\u0026#34;redis\u0026#34;, \u0026#34;DOWN: \u0026#34; + e.getMessage()); } // æ£€æŸ¥æ•°æ®åº“è¿æ¥ try { dataSource.getConnection().close(); builder.withDetail(\u0026#34;database\u0026#34;, \u0026#34;UP\u0026#34;); } catch (Exception e) { builder.down().withDetail(\u0026#34;database\u0026#34;, \u0026#34;DOWN: \u0026#34; + e.getMessage()); } return builder.build(); } } 11.2 ä¸šåŠ¡ç›‘æ§ 11.2.1 ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Service public class BusinessMonitorService { @Autowired private BusinessMetrics businessMetrics; @EventListener public void handleSeckillSuccess(SeckillSuccessEvent event) { businessMetrics.recordSeckillSuccess(); log.info(\u0026#34;ç§’æ€æˆåŠŸ: æ´»åŠ¨ID={}, ç”¨æˆ·ID={}\u0026#34;, event.getActivityId(), event.getUserId()); } @EventListener public void handleSeckillFail(SeckillFailEvent event) { businessMetrics.recordSeckillFail(); log.warn(\u0026#34;ç§’æ€å¤±è´¥: æ´»åŠ¨ID={}, ç”¨æˆ·ID={}, åŸå› ={}\u0026#34;, event.getActivityId(), event.getUserId(), event.getReason()); } @EventListener public void handleCouponClaim(CouponClaimEvent event) { log.info(\u0026#34;ä¼˜æƒ åˆ¸é¢†å–: æ¨¡æ¿ID={}, ç”¨æˆ·ID={}\u0026#34;, event.getTemplateId(), event.getUserId()); } } 11.2.2 å‘Šè­¦é…ç½® å‘Šè­¦è§„åˆ™é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 management: endpoints: web: exposure: include: health,metrics,prometheus metrics: export: prometheus: enabled: true tags: application: sky-server å‘Šè­¦è§„åˆ™:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 groups: - name: sky-server-alerts rules: - alert: HighErrorRate expr: rate(http_server_requests_seconds_count{status=~\u0026#34;5..\u0026#34;}[5m]) \u0026gt; 0.1 for: 2m labels: severity: warning annotations: summary: \u0026#34;é«˜é”™è¯¯ç‡å‘Šè­¦\u0026#34; description: \u0026#34;é”™è¯¯ç‡è¶…è¿‡10%\u0026#34; - alert: HighResponseTime expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket[5m])) \u0026gt; 1 for: 2m labels: severity: warning annotations: summary: \u0026#34;é«˜å“åº”æ—¶é—´å‘Šè­¦\u0026#34; description: \u0026#34;95%å“åº”æ—¶é—´è¶…è¿‡1ç§’\u0026#34; 12. æ€§èƒ½ä¼˜åŒ– 12.1 ç¼“å­˜ä¼˜åŒ– 12.1.1 å¤šçº§ç¼“å­˜ æœ¬åœ°ç¼“å­˜é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Configuration @EnableCaching public class CacheConfig { @Bean public CacheManager cacheManager() { CaffeineCacheManager cacheManager = new CaffeineCacheManager(); cacheManager.setCaffeine(Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(10, TimeUnit.MINUTES) .recordStats()); return cacheManager; } } å¤šçº§ç¼“å­˜å®ç°:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @Service public class SeckillActivityService { @Cacheable(value = \u0026#34;seckill:activity\u0026#34;, key = \u0026#34;#activityId\u0026#34;) public SeckillActivity getActivity(Long activityId) { // å…ˆä»æœ¬åœ°ç¼“å­˜è·å– SeckillActivity activity = localCache.get(activityId); if (activity != null) { return activity; } // ä»Redisè·å– activity = redisTemplate.opsForValue().get(\u0026#34;seckill:activity:\u0026#34; + activityId); if (activity != null) { localCache.put(activityId, activity); return activity; } // ä»æ•°æ®åº“è·å– activity = seckillActivityMapper.selectById(activityId); if (activity != null) { redisTemplate.opsForValue().set(\u0026#34;seckill:activity:\u0026#34; + activityId, activity, 10, TimeUnit.MINUTES); localCache.put(activityId, activity); } return activity; } } 12.1.2 ç¼“å­˜é¢„çƒ­ ç¼“å­˜é¢„çƒ­æœåŠ¡:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Service public class CacheWarmupService { @Autowired private SeckillActivityService seckillActivityService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @PostConstruct public void warmupCache() { // é¢„çƒ­ç§’æ€æ´»åŠ¨ç¼“å­˜ List\u0026lt;SeckillActivity\u0026gt; activities = seckillActivityService.getActiveActivities(); for (SeckillActivity activity : activities) { String key = \u0026#34;seckill:activity:\u0026#34; + activity.getId(); redisTemplate.opsForValue().set(key, activity, 10, TimeUnit.MINUTES); } // é¢„çƒ­åº“å­˜ç¼“å­˜ for (SeckillActivity activity : activities) { String stockKey = \u0026#34;seckill:stock:\u0026#34; + activity.getId(); redisTemplate.opsForValue().set(stockKey, activity.getStock()); } } } 12.2 æ•°æ®åº“ä¼˜åŒ– 12.2.1 è¯»å†™åˆ†ç¦» æ•°æ®æºé…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 spring: datasource: master: url: jdbc:mysql://localhost:3306/sky?useUnicode=true\u0026amp;characterEncoding=utf8\u0026amp;serverTimezone=GMT%2B8 username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver slave: url: jdbc:mysql://localhost:3307/sky?useUnicode=true\u0026amp;characterEncoding=utf8\u0026amp;serverTimezone=GMT%2B8 username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver è¯»å†™åˆ†ç¦»é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Configuration public class DataSourceConfig { @Bean @Primary public DataSource masterDataSource() { return DataSourceBuilder.create() .url(\u0026#34;jdbc:mysql://localhost:3306/sky\u0026#34;) .username(\u0026#34;root\u0026#34;) .password(\u0026#34;root\u0026#34;) .driverClassName(\u0026#34;com.mysql.cj.jdbc.Driver\u0026#34;) .build(); } @Bean public DataSource slaveDataSource() { return DataSourceBuilder.create() .url(\u0026#34;jdbc:mysql://localhost:3307/sky\u0026#34;) .username(\u0026#34;root\u0026#34;) .password(\u0026#34;root\u0026#34;) .driverClassName(\u0026#34;com.mysql.cj.jdbc.Driver\u0026#34;) .build(); } @Bean public DataSource routingDataSource() { DynamicRoutingDataSource routingDataSource = new DynamicRoutingDataSource(); Map\u0026lt;Object, Object\u0026gt; dataSourceMap = new HashMap\u0026lt;\u0026gt;(); dataSourceMap.put(\u0026#34;master\u0026#34;, masterDataSource()); dataSourceMap.put(\u0026#34;slave\u0026#34;, slaveDataSource()); routingDataSource.setTargetDataSources(dataSourceMap); routingDataSource.setDefaultTargetDataSource(masterDataSource()); return routingDataSource; } } 12.2.2 åˆ†åº“åˆ†è¡¨ åˆ†è¡¨ç­–ç•¥:\n1 2 3 4 5 6 7 8 9 10 11 12 13 @Component public class ShardingStrategy { public String getTableName(String baseTable, Long userId) { int shard = (int) (userId % 4); return baseTable + \u0026#34;_\u0026#34; + shard; } public String getDatabaseName(String baseDatabase, Long userId) { int shard = (int) (userId % 2); return baseDatabase + \u0026#34;_\u0026#34; + shard; } } 13. å®‰å…¨é˜²æŠ¤ 13.1 æ¥å£å®‰å…¨ 13.1.1 æ¥å£é‰´æƒ JWTé…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Configuration public class JwtConfig { @Value(\u0026#34;${jwt.secret}\u0026#34;) private String secret; @Value(\u0026#34;${jwt.expiration}\u0026#34;) private Long expiration; @Bean public JwtTokenProvider jwtTokenProvider() { return new JwtTokenProvider(secret, expiration); } } JWTå·¥å…·ç±»:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 @Component public class JwtTokenProvider { private final String secret; private final Long expiration; public JwtTokenProvider(String secret, Long expiration) { this.secret = secret; this.expiration = expiration; } public String generateToken(Long userId) { Date now = new Date(); Date expiryDate = new Date(now.getTime() + expiration); return Jwts.builder() .setSubject(userId.toString()) .setIssuedAt(now) .setExpiration(expiryDate) .signWith(SignatureAlgorithm.HS512, secret) .compact(); } public Long getUserIdFromToken(String token) { Claims claims = Jwts.parser() .setSigningKey(secret) .parseClaimsJws(token) .getBody(); return Long.parseLong(claims.getSubject()); } public boolean validateToken(String token) { try { Jwts.parser().setSigningKey(secret).parseClaimsJws(token); return true; } catch (JwtException | IllegalArgumentException e) { return false; } } } 13.1.2 æ¥å£é™æµ é™æµé…ç½®:\n1 2 3 4 5 6 7 8 @Configuration public class RateLimitConfig { @Bean public RateLimiter rateLimiter() { return RateLimiter.create(100.0); // æ¯ç§’100ä¸ªè¯·æ±‚ } } é™æµæ‹¦æˆªå™¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Component public class RateLimitInterceptor implements HandlerInterceptor { @Autowired private RateLimiter rateLimiter; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { if (rateLimiter.tryAcquire()) { return true; } else { response.setStatus(HttpStatus.TOO_MANY_REQUESTS.value()); return false; } } } 13.2 æ•°æ®å®‰å…¨ 13.2.1 æ•°æ®åŠ å¯† æ•æ„Ÿæ•°æ®åŠ å¯†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Component public class DataEncryptionService { private final AESUtil aesUtil; public DataEncryptionService() { this.aesUtil = new AESUtil(\u0026#34;your-secret-key\u0026#34;); } public String encrypt(String data) { return aesUtil.encrypt(data); } public String decrypt(String encryptedData) { return aesUtil.decrypt(encryptedData); } } 13.2.2 æ•°æ®è„±æ• æ•°æ®è„±æ•å·¥å…·:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Component public class DataMaskingService { public String maskPhone(String phone) { if (phone == null || phone.length() \u0026lt; 7) { return phone; } return phone.substring(0, 3) + \u0026#34;****\u0026#34; + phone.substring(phone.length() - 4); } public String maskEmail(String email) { if (email == null || !email.contains(\u0026#34;@\u0026#34;)) { return email; } String[] parts = email.split(\u0026#34;@\u0026#34;); String username = parts[0]; if (username.length() \u0026lt;= 2) { return email; } return username.substring(0, 2) + \u0026#34;***@\u0026#34; + parts[1]; } } 14. æµ‹è¯•ç­–ç•¥ 14.1 å•å…ƒæµ‹è¯• 14.1.1 æœåŠ¡å±‚æµ‹è¯• æµ‹è¯•ç¤ºä¾‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 @SpringBootTest class SeckillActivityServiceTest { @Autowired private SeckillActivityService seckillActivityService; @MockBean private SeckillActivityMapper seckillActivityMapper; @MockBean private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Test void testParticipateSeckill_Success() { // å‡†å¤‡æµ‹è¯•æ•°æ® SeckillParticipateDTO dto = new SeckillParticipateDTO(); dto.setActivityId(1L); dto.setUserId(1L); dto.setQuantity(1); SeckillActivity activity = new SeckillActivity(); activity.setId(1L); activity.setStock(10); activity.setStatus(1); // Mockæ–¹æ³•è°ƒç”¨ when(seckillActivityMapper.selectById(1L)).thenReturn(activity); when(redisTemplate.opsForValue().get(\u0026#34;seckill:stock:1\u0026#34;)).thenReturn(10); // æ‰§è¡Œæµ‹è¯• Result result = seckillActivityService.participateSeckill(dto); // éªŒè¯ç»“æœ assertThat(result.getCode()).isEqualTo(1); assertThat(result.getMsg()).isEqualTo(\u0026#34;å‚ä¸æˆåŠŸ\u0026#34;); } } 14.1.2 æ§åˆ¶å™¨æµ‹è¯• æµ‹è¯•ç¤ºä¾‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 @WebMvcTest(SeckillActivityController.class) class SeckillActivityControllerTest { @Autowired private MockMvc mockMvc; @MockBean private SeckillActivityService seckillActivityService; @Test void testParticipateSeckill() throws Exception { // å‡†å¤‡æµ‹è¯•æ•°æ® SeckillParticipateDTO dto = new SeckillParticipateDTO(); dto.setActivityId(1L); dto.setUserId(1L); dto.setQuantity(1); Result expectedResult = Result.success(\u0026#34;å‚ä¸æˆåŠŸ\u0026#34;); when(seckillActivityService.participateSeckill(any())).thenReturn(expectedResult); // æ‰§è¡Œæµ‹è¯• mockMvc.perform(post(\u0026#34;/seckill/participate\u0026#34;) .contentType(MediaType.APPLICATION_JSON) .content(JSON.toJSONString(dto))) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.code\u0026#34;).value(1)) .andExpect(jsonPath(\u0026#34;$.msg\u0026#34;).value(\u0026#34;å‚ä¸æˆåŠŸ\u0026#34;)); } } 14.2 é›†æˆæµ‹è¯• 14.2.1 æ•°æ®åº“é›†æˆæµ‹è¯• æµ‹è¯•é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @SpringBootTest @Testcontainers class DatabaseIntegrationTest { @Container static MySQLContainer\u0026lt;?\u0026gt; mysql = new MySQLContainer\u0026lt;\u0026gt;(\u0026#34;mysql:8.0\u0026#34;) .withDatabaseName(\u0026#34;test_sky\u0026#34;) .withUsername(\u0026#34;test\u0026#34;) .withPassword(\u0026#34;test\u0026#34;); @DynamicPropertySource static void configureProperties(DynamicPropertyRegistry registry) { registry.add(\u0026#34;spring.datasource.url\u0026#34;, mysql::getJdbcUrl); registry.add(\u0026#34;spring.datasource.username\u0026#34;, mysql::getUsername); registry.add(\u0026#34;spring.datasource.password\u0026#34;, mysql::getPassword); } @Test void testDatabaseConnection() { // æµ‹è¯•æ•°æ®åº“è¿æ¥ assertThat(mysql.isRunning()).isTrue(); } } 14.2.2 Redisé›†æˆæµ‹è¯• æµ‹è¯•é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @SpringBootTest @Testcontainers class RedisIntegrationTest { @Container static GenericContainer\u0026lt;?\u0026gt; redis = new GenericContainer\u0026lt;\u0026gt;(\u0026#34;redis:7-alpine\u0026#34;) .withExposedPorts(6379); @DynamicPropertySource static void configureProperties(DynamicPropertyRegistry registry) { registry.add(\u0026#34;spring.redis.host\u0026#34;, redis::getHost); registry.add(\u0026#34;spring.redis.port\u0026#34;, () -\u0026gt; redis.getMappedPort(6379)); } @Test void testRedisConnection() { // æµ‹è¯•Redisè¿æ¥ assertThat(redis.isRunning()).isTrue(); } } 14.3 æ€§èƒ½æµ‹è¯• 14.3.1 å‹åŠ›æµ‹è¯• JMeteræµ‹è¯•è®¡åˆ’:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;jmeterTestPlan version=\u0026#34;1.2\u0026#34;\u0026gt; \u0026lt;hashTree\u0026gt; \u0026lt;TestPlan testname=\u0026#34;Seckill Performance Test\u0026#34;\u0026gt; \u0026lt;elementProp name=\u0026#34;TestPlan.arguments\u0026#34; elementType=\u0026#34;Arguments\u0026#34; guiclass=\u0026#34;ArgumentsPanel\u0026#34;\u0026gt; \u0026lt;collectionProp name=\u0026#34;Arguments.arguments\u0026#34;/\u0026gt; \u0026lt;/elementProp\u0026gt; \u0026lt;stringProp name=\u0026#34;TestPlan.user_define_classpath\u0026#34;\u0026gt;\u0026lt;/stringProp\u0026gt; \u0026lt;boolProp name=\u0026#34;TestPlan.functional_mode\u0026#34;\u0026gt;false\u0026lt;/boolProp\u0026gt; \u0026lt;boolProp name=\u0026#34;TestPlan.serialize_threadgroups\u0026#34;\u0026gt;false\u0026lt;/boolProp\u0026gt; \u0026lt;elementProp name=\u0026#34;TestPlan.arguments\u0026#34; elementType=\u0026#34;Arguments\u0026#34; guiclass=\u0026#34;ArgumentsPanel\u0026#34;\u0026gt; \u0026lt;collectionProp name=\u0026#34;Arguments.arguments\u0026#34;/\u0026gt; \u0026lt;/elementProp\u0026gt; \u0026lt;stringProp name=\u0026#34;TestPlan.user_define_classpath\u0026#34;\u0026gt;\u0026lt;/stringProp\u0026gt; \u0026lt;boolProp name=\u0026#34;TestPlan.functional_mode\u0026#34;\u0026gt;false\u0026lt;/boolProp\u0026gt; \u0026lt;boolProp name=\u0026#34;TestPlan.serialize_threadgroups\u0026#34;\u0026gt;false\u0026lt;/boolProp\u0026gt; \u0026lt;/TestPlan\u0026gt; \u0026lt;/hashTree\u0026gt; \u0026lt;/jmeterTestPlan\u0026gt; 14.3.2 è´Ÿè½½æµ‹è¯• è´Ÿè½½æµ‹è¯•é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 @SpringBootTest class LoadTest { @Autowired private SeckillActivityService seckillActivityService; @Test void testConcurrentSeckill() throws InterruptedException { int threadCount = 100; int requestCount = 1000; CountDownLatch latch = new CountDownLatch(threadCount); AtomicInteger successCount = new AtomicInteger(0); AtomicInteger failCount = new AtomicInteger(0); for (int i = 0; i \u0026lt; threadCount; i++) { new Thread(() -\u0026gt; { for (int j = 0; j \u0026lt; requestCount / threadCount; j++) { try { SeckillParticipateDTO dto = new SeckillParticipateDTO(); dto.setActivityId(1L); dto.setUserId(Thread.currentThread().getId()); dto.setQuantity(1); Result result = seckillActivityService.participateSeckill(dto); if (result.getCode() == 1) { successCount.incrementAndGet(); } else { failCount.incrementAndGet(); } } catch (Exception e) { failCount.incrementAndGet(); } } latch.countDown(); }).start(); } latch.await(); System.out.println(\u0026#34;æˆåŠŸ: \u0026#34; + successCount.get()); System.out.println(\u0026#34;å¤±è´¥: \u0026#34; + failCount.get()); } } é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ç³»ç»Ÿï¼Œå®ç°äº†æ”¯ä»˜å’Œç§¯åˆ†æœåŠ¡çš„è§£è€¦ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œç¨³å®šæ€§ã€‚\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8Capi%E6%8E%A5%E5%8F%A3/","title":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’ŒAPIæ¥å£"},{"content":"Hashå’–å•¡åç«¯æ”¹é€ æŒ‡å—-ç¬¬äºŒéƒ¨åˆ†-å®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç° ç›®å½• é¡¹ç›®æ¦‚è¿° å®ä½“ç±»è®¾è®¡ åˆ†å¸ƒå¼é”å®ç° Luaè„šæœ¬ä¼˜åŒ– æ•°æ®åº“æ“ä½œä¼˜åŒ– ç¼“å­˜ç­–ç•¥ å¼‚å¸¸å¤„ç† æ€§èƒ½ç›‘æ§ ä¸šåŠ¡æµç¨‹è¯¦è§£ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ ç›‘æ§å’Œå‘Šè­¦ æµ‹è¯•ç­–ç•¥ éƒ¨ç½²å’Œè¿ç»´ æ¦‚è¿° æœ¬éƒ¨åˆ†ä¸»è¦ä»‹ç»Hashå’–å•¡é¡¹ç›®ä¸­ç§’æ€å’Œä¼˜æƒ åˆ¸åŠŸèƒ½çš„å®ä½“ç±»è®¾è®¡ã€åˆ†å¸ƒå¼é”å®ç°ï¼Œä»¥åŠç›¸å…³çš„Serviceå±‚æ‰©å±•ã€‚é€šè¿‡Luaè„šæœ¬ä¸Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ä¼˜æƒ åˆ¸è¶…å–ä¸é‡å¤è·å–ï¼ŒåŒæ—¶é€šè¿‡MySQLæ•°æ®åº“çš„åŸå­æ€§æ“ä½œä¿è¯åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨ã€‚\n1. å®ä½“ç±»æ‰©å±• 1.1 ç”¨æˆ·å®ä½“ç±»æ‰©å±• æ–‡ä»¶ä½ç½®: sky-pojo/src/main/java/com/sky/entity/User.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package com.sky.entity; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDate; import java.time.LocalDateTime; @Data @Builder @NoArgsConstructor @AllArgsConstructor public class User implements Serializable { private static final long serialVersionUID = 1L; private Long id; //å¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯† private String openid; //å§“å private String name; //æ‰‹æœºå· private String phone; //æ€§åˆ« 0 å¥³ 1 ç”· private String sex; //èº«ä»½è¯å· private String idNumber; //å¤´åƒ private String avatar; //ç§¯åˆ† private Integer points; //æ³¨å†Œæ—¶é—´ private LocalDateTime createTime; } ä¸»è¦å˜æ›´è¯´æ˜:\næ·»åŠ äº† points å­—æ®µç”¨äºå­˜å‚¨ç”¨æˆ·ç§¯åˆ† ç§¯åˆ†ç³»ç»Ÿæ˜¯ç”¨æˆ·å¿ è¯šåº¦ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ† ç§¯åˆ†å¯ä»¥ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸ã€æŠµæ‰£ç°é‡‘ç­‰ ä¸šåŠ¡ä»·å€¼:\nç”¨æˆ·ç•™å­˜: é€šè¿‡ç§¯åˆ†ç³»ç»Ÿæé«˜ç”¨æˆ·ç²˜æ€§ æ¶ˆè´¹æ¿€åŠ±: ç§¯åˆ†å¥–åŠ±æœºåˆ¶ä¿ƒè¿›ç”¨æˆ·æ¶ˆè´¹ æ•°æ®åˆ†æ: ç§¯åˆ†æ•°æ®å¯ç”¨äºç”¨æˆ·è¡Œä¸ºåˆ†æ 1.2 æ¶ˆæ¯å®ä½“ç±»è®¾è®¡ 1.2.1 è®¢å•æ”¯ä»˜æ¶ˆæ¯ æ–‡ä»¶ä½ç½®: sky-pojo/src/main/java/com/sky/entity/message/OrderPayMessage.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package com.sky.entity.message; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.math.BigDecimal; import java.time.LocalDateTime; /** * è®¢å•æ”¯ä»˜æ¶ˆæ¯ * ç”¨äºå¼‚æ­¥å¤„ç†è®¢å•æ”¯ä»˜åçš„ä¸šåŠ¡é€»è¾‘ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class OrderPayMessage implements Serializable { private static final long serialVersionUID = 1L; /** * è®¢å•ID */ private Long orderId; /** * ç”¨æˆ·ID */ private Long userId; /** * æ”¯ä»˜é‡‘é¢ */ private BigDecimal amount; /** * æ”¯ä»˜æ—¶é—´ */ private LocalDateTime payTime; /** * æ”¯ä»˜æ–¹å¼ * 1-å¾®ä¿¡æ”¯ä»˜ 2-æ”¯ä»˜å® 3-é“¶è¡Œå¡ */ private Integer payMethod; } è®¾è®¡ç†å¿µ:\nä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æ”¯ä»˜æœåŠ¡å’Œç§¯åˆ†æœåŠ¡ æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦å’Œç¨³å®šæ€§ æ”¯æŒå¼‚æ­¥å¤„ç†ï¼Œé¿å…åŒæ­¥é˜»å¡ 1.2.2 ç§¯åˆ†è·å¾—æ¶ˆæ¯ æ–‡ä»¶ä½ç½®: sky-pojo/src/main/java/com/sky/entity/message/PointsEarnMessage.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package com.sky.entity.message; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; /** * ç§¯åˆ†è·å¾—æ¶ˆæ¯ * ç”¨äºå¤„ç†ç”¨æˆ·ç§¯åˆ†å¢åŠ çš„ä¸šåŠ¡é€»è¾‘ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class PointsEarnMessage implements Serializable { private static final long serialVersionUID = 1L; /** * ç”¨æˆ·ID */ private Long userId; /** * è®¢å•ID */ private Long orderId; /** * è·å¾—ç§¯åˆ† */ private Integer points; /** * è·å¾—æ—¶é—´ */ private LocalDateTime earnTime; } ä¸šåŠ¡è§„åˆ™:\næ¯æ¶ˆè´¹1å…ƒè·å¾—1ç§¯åˆ† ç§¯åˆ†æœ‰æ•ˆæœŸä¸º1å¹´ ç§¯åˆ†å¯ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸ 1.2.3 è®¢å•è¶…æ—¶æ¶ˆæ¯ æ–‡ä»¶ä½ç½®: sky-pojo/src/main/java/com/sky/entity/message/OrderTimeoutMessage.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package com.sky.entity.message; import lombok.AllArgsConstructor; import lombok.Builder; import lombok.Data; import lombok.NoArgsConstructor; import java.io.Serializable; import java.time.LocalDateTime; /** * è®¢å•è¶…æ—¶æ¶ˆæ¯ * ç”¨äºå¤„ç†è®¢å•è¶…æ—¶æœªæ”¯ä»˜çš„ä¸šåŠ¡é€»è¾‘ */ @Data @Builder @NoArgsConstructor @AllArgsConstructor public class OrderTimeoutMessage implements Serializable { private static final long serialVersionUID = 1L; /** * è®¢å•ID */ private Long orderId; /** * ç”¨æˆ·ID */ private Long userId; /** * è¶…æ—¶æ—¶é—´ */ private LocalDateTime timeoutTime; } è¶…æ—¶å¤„ç†æœºåˆ¶:\nè®¢å•åˆ›å»ºå15åˆ†é’Ÿå†…æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ é‡Šæ”¾åº“å­˜ï¼Œæ¢å¤å•†å“å¯å”®çŠ¶æ€ å‘é€è¶…æ—¶é€šçŸ¥ç»™ç”¨æˆ· 2. åˆ†å¸ƒå¼é”æœåŠ¡å®ç° 2.1 åˆ†å¸ƒå¼é”æœåŠ¡ç±» æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/lock/DistributedLockService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 package com.sky.lock; import com.sky.constant.RedisKeyConstants; import lombok.extern.slf4j.Slf4j; import org.redisson.api.RLock; import org.redisson.api.RedissonClient; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Value; import org.springframework.core.io.ClassPathResource; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.data.redis.core.script.DefaultRedisScript; import org.springframework.scripting.support.ResourceScriptSource; import org.springframework.stereotype.Service; import java.util.Arrays; import java.util.List; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.TimeUnit; import java.util.function.Supplier; /** * åˆ†å¸ƒå¼é”æœåŠ¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ * åŸºäºRedissonå®ç°åˆ†å¸ƒå¼é”ï¼Œæ”¯æŒç§’æ€åœºæ™¯ä¸‹çš„é«˜å¹¶å‘æ§åˆ¶ */ @Slf4j @Service public class DistributedLockService { @Autowired private RedissonClient redissonClient; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Value(\u0026#34;${sky.redis.seckill.prefix}\u0026#34;) private String seckillPrefix; // é”ç¼“å­˜ï¼Œé¿å…é‡å¤è·å–é”å¯¹è±¡ private final ConcurrentHashMap\u0026lt;String, RLock\u0026gt; lockCache = new ConcurrentHashMap\u0026lt;\u0026gt;(); // ç§’æ€å‚ä¸è„šæœ¬ private final DefaultRedisScript\u0026lt;List\u0026gt; seckillParticipateScript; public DistributedLockService() { // åˆå§‹åŒ–ç§’æ€å‚ä¸è„šæœ¬ this.seckillParticipateScript = new DefaultRedisScript\u0026lt;\u0026gt;(); this.seckillParticipateScript.setScriptSource( new ResourceScriptSource(new ClassPathResource(\u0026#34;scripts/seckill_participate.lua\u0026#34;)) ); this.seckillParticipateScript.setResultType(List.class); } /** * è·å–é”å¯¹è±¡ï¼ˆå¸¦ç¼“å­˜ï¼‰ * ä½¿ç”¨ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åˆ›å»ºé”å¯¹è±¡ï¼Œæé«˜æ€§èƒ½ */ private RLock getLock(String lockKey) { return lockCache.computeIfAbsent(lockKey, key -\u0026gt; redissonClient.getLock(key)); } /** * ç§’æ€å‚ä¸ * ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œï¼Œé˜²æ­¢è¶…å– */ public List\u0026lt;Object\u0026gt; seckillParticipate(Long activityId, Long userId, Integer quantity, Integer perUserLimit) { // ä½¿ç”¨å·¥å…·æ–¹æ³•ç”Ÿæˆé”® String stockKey = seckillPrefix + RedisKeyConstants.getStockKey(activityId); String participantsKey = seckillPrefix + RedisKeyConstants.getParticipantsKey(activityId); List\u0026lt;String\u0026gt; keys = Arrays.asList(stockKey, participantsKey); Object[] args = {userId.toString(), quantity.toString(), perUserLimit.toString()}; return redisTemplate.execute(seckillParticipateScript, keys, args); } /** * å°è¯•è·å–é”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ * æ”¯æŒè¶…æ—¶æœºåˆ¶ï¼Œé¿å…æ­»é” */ public boolean tryLock(String lockKey, long waitTime, long leaseTime, TimeUnit unit) { RLock lock = getLock(lockKey); try { return lock.tryLock(waitTime, leaseTime, unit); } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;è·å–é”è¢«ä¸­æ–­\u0026#34;, e); } } /** * é‡Šæ”¾é”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ * ç¡®ä¿é”çš„æ­£ç¡®é‡Šæ”¾ï¼Œé¿å…èµ„æºæ³„éœ² */ public void unlock(String lockKey) { RLock lock = getLock(lockKey); try { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } catch (Exception e) { log.warn(\u0026#34;é‡Šæ”¾é”å¤±è´¥: {}\u0026#34;, lockKey, e); } } /** * æ‰§è¡Œå¸¦é”çš„æ“ä½œï¼ˆæ¨èä½¿ç”¨ï¼‰ * è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„åŸå­æ€§ */ public \u0026lt;T\u0026gt; T executeWithLock(String lockKey, long waitTime, long leaseTime, TimeUnit unit, Supplier\u0026lt;T\u0026gt; supplier) { RLock lock = getLock(lockKey); try { if (lock.tryLock(waitTime, leaseTime, unit)) { return supplier.get(); } else { throw new RuntimeException(\u0026#34;è·å–é”å¤±è´¥: \u0026#34; + lockKey); } } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;è·å–é”è¢«ä¸­æ–­: \u0026#34; + lockKey, e); } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } /** * æ£€æŸ¥é”çŠ¶æ€ * ç”¨äºç›‘æ§å’Œè°ƒè¯• */ public boolean isLocked(String lockKey) { RLock lock = getLock(lockKey); return lock.isLocked(); } /** * è·å–é”å‰©ä½™æ—¶é—´ * ç”¨äºç›‘æ§é”çš„ä½¿ç”¨æƒ…å†µ */ public long getLockRemainingTime(String lockKey) { RLock lock = getLock(lockKey); return lock.remainTimeToLive(); } } è®¾è®¡ç‰¹ç‚¹:\né”ç¼“å­˜æœºåˆ¶: é¿å…é‡å¤åˆ›å»ºé”å¯¹è±¡ï¼Œæé«˜æ€§èƒ½ Luaè„šæœ¬: ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œé˜²æ­¢è¶…å– è¶…æ—¶æœºåˆ¶: é¿å…æ­»é”ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§ å¼‚å¸¸å¤„ç†: ç¡®ä¿é”çš„æ­£ç¡®é‡Šæ”¾ 2.2 Redisé”®å¸¸é‡ç±» æ–‡ä»¶ä½ç½®: sky-common/src/main/java/com/sky/constant/RedisKeyConstants.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package com.sky.constant; /** * Redisé”®å¸¸é‡ç±» * ç»Ÿä¸€ç®¡ç†Redisé”®çš„å‘½åè§„èŒƒï¼Œé¿å…é”®å†²çª */ public class RedisKeyConstants { // ç§’æ€ç›¸å…³å‰ç¼€ public static final String SECKILL_PREFIX = \u0026#34;seckill:\u0026#34;; // ç§’æ€å­é”® public static final String STOCK_KEY = \u0026#34;stock:\u0026#34;; public static final String PARTICIPANTS_KEY = \u0026#34;participants:\u0026#34;; public static final String LOCK_KEY = \u0026#34;lock:\u0026#34;; public static final String ORDER_KEY = \u0026#34;order:\u0026#34;; /** * ç”Ÿæˆåº“å­˜é”® * æ ¼å¼: seckill:stock:æ´»åŠ¨ID */ public static String getStockKey(Long activityId) { return SECKILL_PREFIX + STOCK_KEY + activityId; } /** * ç”Ÿæˆå‚ä¸è€…é”® * æ ¼å¼: seckill:participants:æ´»åŠ¨ID */ public static String getParticipantsKey(Long activityId) { return SECKILL_PREFIX + PARTICIPANTS_KEY + activityId; } /** * ç”Ÿæˆé”é”® * æ ¼å¼: seckill:lock:ä¸šåŠ¡é”® */ public static String getLockKey(String businessKey) { return SECKILL_PREFIX + LOCK_KEY + businessKey; } /** * ç”Ÿæˆè®¢å•é”® * æ ¼å¼: seckill:order:è®¢å•ID */ public static String getOrderKey(Long orderId) { return SECKILL_PREFIX + ORDER_KEY + orderId; } } å‘½åè§„èŒƒ:\nä½¿ç”¨å†’å·åˆ†éš”å±‚çº§ç»“æ„ å‰ç¼€ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…é”®å†²çª æ”¯æŒæŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç±»ç®¡ç† 3. Serviceå±‚æ‰©å±• 3.1 UserServiceæ‰©å±• æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/UserService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package com.sky.service; import com.sky.dto.UserLoginDTO; import com.sky.entity.User; public interface UserService { /** * å¾®ä¿¡ç™»å½• * @param userLoginDTO * @return */ User wxLogin(UserLoginDTO userLoginDTO); /** * æ·»åŠ ç”¨æˆ·ç§¯åˆ† * @param userId ç”¨æˆ·ID * @param points ç§¯åˆ†æ•°é‡ * @param orderId è®¢å•ID */ void addUserPoints(Long userId, Integer points, Long orderId); /** * è·å–ç”¨æˆ·ç§¯åˆ† * @param userId ç”¨æˆ·ID * @return ç”¨æˆ·ç§¯åˆ† */ Integer getUserPoints(Long userId); } æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/impl/UserServiceImpl.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // åœ¨UserServiceImplä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * æ·»åŠ ç”¨æˆ·ç§¯åˆ† * @param userId ç”¨æˆ·ID * @param points ç§¯åˆ†æ•°é‡ * @param orderId è®¢å•ID */ @Override public void addUserPoints(Long userId, Integer points, Long orderId) { // æŸ¥è¯¢ç”¨æˆ·å½“å‰ç§¯åˆ† User user = userMapper.getById(userId); if (user != null) { // æ›´æ–°ç”¨æˆ·ç§¯åˆ† userMapper.updateUserPoints(userId, user.getPoints() + points); log.info(\u0026#34;ç”¨æˆ·ç§¯åˆ†å¢åŠ æˆåŠŸï¼šuserId={}, points={}, orderId={}\u0026#34;, userId, points, orderId); } } /** * è·å–ç”¨æˆ·ç§¯åˆ† * @param userId ç”¨æˆ·ID * @return ç”¨æˆ·ç§¯åˆ† */ @Override public Integer getUserPoints(Long userId) { User user = userMapper.getById(userId); return user != null ? user.getPoints() : 0; } ä¸šåŠ¡é€»è¾‘:\nç§¯åˆ†å¢åŠ : ç”¨æˆ·æ¶ˆè´¹åè‡ªåŠ¨å¢åŠ ç§¯åˆ† ç§¯åˆ†æŸ¥è¯¢: æ”¯æŒç”¨æˆ·æŸ¥çœ‹å½“å‰ç§¯åˆ† ç§¯åˆ†ä½¿ç”¨: ç§¯åˆ†å¯ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸ 3.2 OrderServiceæ‰©å±• æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/OrderService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // åœ¨OrderServiceæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * å¤„ç†è®¢å•æ”¯ä»˜ * @param orderId è®¢å•ID * @param amount æ”¯ä»˜é‡‘é¢ */ void processOrderPayment(Long orderId, BigDecimal amount); /** * å–æ¶ˆè¶…æ—¶è®¢å• * @param orderId è®¢å•ID */ void cancelTimeoutOrder(Long orderId); /** * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ * @param orderId è®¢å•ID * @param userId ç”¨æˆ·ID * @param amount æ”¯ä»˜é‡‘é¢ */ void sendOrderPayMessage(Long orderId, Long userId, BigDecimal amount); æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/impl/OrderServiceImpl.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // åœ¨OrderServiceImplä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * å¤„ç†è®¢å•æ”¯ä»˜ * @param orderId è®¢å•ID * @param amount æ”¯ä»˜é‡‘é¢ */ @Override public void processOrderPayment(Long orderId, BigDecimal amount) { // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ Orders orders = Orders.builder() .id(orderId) .status(Orders.TO_BE_CONFIRMED) .payStatus(Orders.PAID) .checkoutTime(LocalDateTime.now()) .build(); orderMapper.update(orders); log.info(\u0026#34;è®¢å•æ”¯ä»˜å¤„ç†æˆåŠŸï¼šorderId={}, amount={}\u0026#34;, orderId, amount); } /** * å–æ¶ˆè¶…æ—¶è®¢å• * @param orderId è®¢å•ID */ @Override public void cancelTimeoutOrder(Long orderId) { // æŸ¥è¯¢è®¢å•çŠ¶æ€ Orders ordersDB = orderMapper.getById(orderId); if (ordersDB != null \u0026amp;\u0026amp; ordersDB.getStatus().equals(Orders.PENDING_PAYMENT)) { // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ Orders orders = Orders.builder() .id(orderId) .status(Orders.CANCELLED) .cancelReason(\u0026#34;è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ\u0026#34;) .cancelTime(LocalDateTime.now()) .build(); orderMapper.update(orders); log.info(\u0026#34;è®¢å•è¶…æ—¶å–æ¶ˆæˆåŠŸï¼šorderId={}\u0026#34;, orderId); } } /** * å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ * @param orderId è®¢å•ID * @param userId ç”¨æˆ·ID * @param amount æ”¯ä»˜é‡‘é¢ */ @Override public void sendOrderPayMessage(Long orderId, Long userId, BigDecimal amount) { // è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€æ¶ˆæ¯çš„é€»è¾‘ log.info(\u0026#34;å‘é€è®¢å•æ”¯ä»˜æ¶ˆæ¯ï¼šorderId={}, userId={}, amount={}\u0026#34;, orderId, userId, amount); } ä¸šåŠ¡æµç¨‹:\næ”¯ä»˜å¤„ç†: æ›´æ–°è®¢å•çŠ¶æ€ï¼Œè®°å½•æ”¯ä»˜ä¿¡æ¯ è¶…æ—¶å–æ¶ˆ: è‡ªåŠ¨å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜è®¢å• æ¶ˆæ¯å‘é€: å¼‚æ­¥å‘é€æ”¯ä»˜æ¶ˆæ¯ 3.3 CouponServiceæ‰©å±• æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/CouponService.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // åœ¨CouponServiceæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * é¢†å–ä¼˜æƒ åˆ¸ * @param templateId ä¼˜æƒ åˆ¸æ¨¡æ¿ID * @param userId ç”¨æˆ·ID * @return é¢†å–ç»“æœ */ String claimCoupon(Long templateId, Long userId); /** * è·å–ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸ * @param userId ç”¨æˆ·ID * @return ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸åˆ—è¡¨ */ List\u0026lt;Coupon\u0026gt; getUserAvailableCoupons(Long userId); /** * æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨ * @param couponId ä¼˜æƒ åˆ¸ID * @param userId ç”¨æˆ·ID * @param orderAmount è®¢å•é‡‘é¢ * @return æ£€æŸ¥ç»“æœ */ String checkCouponAvailable(Long couponId, Long userId, BigDecimal orderAmount); æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/service/impl/CouponServiceImpl.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // åœ¨CouponServiceImplä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * é¢†å–ä¼˜æƒ åˆ¸ * @param templateId ä¼˜æƒ åˆ¸æ¨¡æ¿ID * @param userId ç”¨æˆ·ID * @return é¢†å–ç»“æœ */ @Override public String claimCoupon(Long templateId, Long userId) { // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é¢†å–è¯¥æ¨¡æ¿çš„ä¼˜æƒ åˆ¸ if (hasReceived(userId, templateId)) { return \u0026#34;æ‚¨å·²ç»é¢†å–è¿‡è¯¥ä¼˜æƒ åˆ¸äº†\u0026#34;; } // æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨ CouponTemplate template = couponTemplateMapper.getById(templateId); if (template == null || template.getStatus() != 1) { return \u0026#34;ä¼˜æƒ åˆ¸æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨\u0026#34;; } // æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†… if (template.getEndTime().isBefore(LocalDateTime.now())) { return \u0026#34;ä¼˜æƒ åˆ¸å·²è¿‡æœŸ\u0026#34;; } // åˆ›å»ºä¼˜æƒ åˆ¸ Coupon coupon = Coupon.builder() .templateId(templateId) .userId(userId) .status(0) // 0-æœªä½¿ç”¨ .createTime(LocalDateTime.now()) .updateTime(LocalDateTime.now()) .build(); couponMapper.insert(coupon); return \u0026#34;ä¼˜æƒ åˆ¸é¢†å–æˆåŠŸ\u0026#34;; } /** * è·å–ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸ * @param userId ç”¨æˆ·ID * @return ç”¨æˆ·å¯ç”¨ä¼˜æƒ åˆ¸åˆ—è¡¨ */ @Override public List\u0026lt;Coupon\u0026gt; getUserAvailableCoupons(Long userId) { return couponMapper.getByUserId(userId, 0); // 0-æœªä½¿ç”¨ } /** * æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ç”¨ * @param couponId ä¼˜æƒ åˆ¸ID * @param userId ç”¨æˆ·ID * @param orderAmount è®¢å•é‡‘é¢ * @return æ£€æŸ¥ç»“æœ */ @Override public String checkCouponAvailable(Long couponId, Long userId, BigDecimal orderAmount) { // è¿™é‡Œå¯ä»¥æ·»åŠ ä¼˜æƒ åˆ¸å¯ç”¨æ€§æ£€æŸ¥é€»è¾‘ return \u0026#34;ä¼˜æƒ åˆ¸å¯ç”¨\u0026#34;; } ä¸šåŠ¡è§„åˆ™:\né¢†å–é™åˆ¶: æ¯ä¸ªç”¨æˆ·æ¯ç§ä¼˜æƒ åˆ¸åªèƒ½é¢†å–ä¸€æ¬¡ æœ‰æ•ˆæœŸæ£€æŸ¥: ç¡®ä¿ä¼˜æƒ åˆ¸åœ¨æœ‰æ•ˆæœŸå†… ä½¿ç”¨æ¡ä»¶: æ£€æŸ¥ä¼˜æƒ åˆ¸çš„ä½¿ç”¨æ¡ä»¶ 4. Mapperå±‚æ‰©å±• 4.1 UserMapperæ‰©å±• æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/mapper/UserMapper.java\n1 2 3 4 5 6 7 8 // åœ¨UserMapperæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * æ›´æ–°ç”¨æˆ·ç§¯åˆ† * @param userId ç”¨æˆ·ID * @param points æ–°ç§¯åˆ† */ void updateUserPoints(Long userId, Integer points); æ–‡ä»¶ä½ç½®: sky-server/src/main/resources/mapper/UserMapper.xml\n1 2 3 4 5 6 7 8 \u0026lt;!-- åœ¨UserMapper.xmlä¸­æ·»åŠ ä»¥ä¸‹SQL --\u0026gt; \u0026lt;update id=\u0026#34;updateUserPoints\u0026#34;\u0026gt; UPDATE user SET points = #{points}, update_time = NOW() WHERE id = #{userId} \u0026lt;/update\u0026gt; 4.2 CouponMapperæ‰©å±• æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/mapper/CouponMapper.java\n1 2 3 4 5 6 // åœ¨CouponMapperæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * æ’å…¥ä¼˜æƒ åˆ¸ */ void insert(Coupon coupon); æ–‡ä»¶ä½ç½®: sky-server/src/main/resources/mapper/CouponMapper.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;!-- åœ¨CouponMapper.xmlä¸­æ·»åŠ ä»¥ä¸‹SQL --\u0026gt; \u0026lt;insert id=\u0026#34;insert\u0026#34; parameterType=\u0026#34;com.sky.entity.Coupon\u0026#34; useGeneratedKeys=\u0026#34;true\u0026#34; keyProperty=\u0026#34;id\u0026#34;\u0026gt; INSERT INTO coupon ( template_id, user_id, status, create_time, update_time ) VALUES ( #{templateId}, #{userId}, #{status}, #{createTime}, #{updateTime} ) \u0026lt;/insert\u0026gt; 4.3 CouponTemplateMapperæ‰©å±• æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/mapper/CouponTemplateMapper.java\n1 2 3 4 5 6 7 // åœ¨CouponTemplateMapperæ¥å£ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³• /** * è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿ * @return å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ¨¡æ¿åˆ—è¡¨ */ List\u0026lt;CouponTemplate\u0026gt; getAvailableTemplates(); æ–‡ä»¶ä½ç½®: sky-server/src/main/resources/mapper/CouponTemplateMapper.xml\n1 2 3 4 5 6 7 8 9 \u0026lt;!-- åœ¨CouponTemplateMapper.xmlä¸­æ·»åŠ ä»¥ä¸‹SQL --\u0026gt; \u0026lt;select id=\u0026#34;getAvailableTemplates\u0026#34; resultType=\u0026#34;com.sky.entity.CouponTemplate\u0026#34;\u0026gt; SELECT * FROM coupon_template WHERE status = 1 AND start_time \u0026amp;lt;= NOW() AND end_time \u0026amp;gt;= NOW() ORDER BY create_time DESC \u0026lt;/select\u0026gt; 5. é…ç½®ç±» 5.1 Redissoné…ç½® æ–‡ä»¶ä½ç½®: sky-server/src/main/java/com/sky/config/RedissonConfig.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package com.sky.config; import org.redisson.Redisson; import org.redisson.api.RedissonClient; import org.redisson.config.Config; import org.springframework.beans.factory.annotation.Value; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; /** * Redissoné…ç½® * é…ç½®åˆ†å¸ƒå¼é”å®¢æˆ·ç«¯ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯ */ @Configuration public class RedissonConfig { @Value(\u0026#34;${spring.redis.host}\u0026#34;) private String host; @Value(\u0026#34;${spring.redis.port}\u0026#34;) private int port; @Value(\u0026#34;${spring.redis.password:}\u0026#34;) private String password; @Value(\u0026#34;${spring.redis.database:0}\u0026#34;) private int database; @Bean public RedissonClient redissonClient() { Config config = new Config(); String address = \u0026#34;redis://\u0026#34; + host + \u0026#34;:\u0026#34; + port; config.useSingleServer() .setAddress(address) .setPassword(password) .setDatabase(database) .setConnectionPoolSize(10) .setConnectionMinimumIdleSize(5) .setIdleConnectionTimeout(10000) .setConnectTimeout(10000) .setRetryAttempts(3) .setRetryInterval(1500); return Redisson.create(config); } } é…ç½®è¯´æ˜:\nè¿æ¥æ± å¤§å°: 10ä¸ªè¿æ¥ï¼Œæ”¯æŒé«˜å¹¶å‘ æœ€å°ç©ºé—²è¿æ¥: 5ä¸ªï¼Œä¿è¯è¿æ¥å¯ç”¨æ€§ è¶…æ—¶è®¾ç½®: 10ç§’è¿æ¥è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾… é‡è¯•æœºåˆ¶: 3æ¬¡é‡è¯•ï¼Œæé«˜è¿æ¥æˆåŠŸç‡ 6. å…³é”®ç‰¹æ€§ 6.1 åˆ†å¸ƒå¼é”é˜²è¶…å– åŸºäºRedissonå®ç°åˆ†å¸ƒå¼é” ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ é”ç¼“å­˜æœºåˆ¶æé«˜æ€§èƒ½ 6.2 çº¿ç¨‹å®‰å…¨ MySQLæ•°æ®åº“åŸå­æ€§æ“ä½œ Redis Luaè„šæœ¬ä¿è¯ä¸€è‡´æ€§ åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é—®é¢˜ 6.3 æ€§èƒ½ä¼˜åŒ– é”å¯¹è±¡ç¼“å­˜ è¿æ¥æ± é…ç½® å¼‚æ­¥å¤„ç†æœºåˆ¶ 7. æ³¨æ„äº‹é¡¹ é”è¶…æ—¶è®¾ç½®: åˆç†è®¾ç½®é”çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ­»é” å¼‚å¸¸å¤„ç†: ç¡®ä¿é”çš„é‡Šæ”¾ï¼Œé¿å…èµ„æºæ³„éœ² æ€§èƒ½ç›‘æ§: ç›‘æ§é”çš„è·å–å’Œé‡Šæ”¾æ€§èƒ½ æ•°æ®ä¸€è‡´æ€§: ç¡®ä¿Rediså’ŒMySQLæ•°æ®çš„ä¸€è‡´æ€§ 8. æµ‹è¯•å»ºè®® å¹¶å‘æµ‹è¯•: ä½¿ç”¨JMeterç­‰å·¥å…·æµ‹è¯•é«˜å¹¶å‘åœºæ™¯ é”æµ‹è¯•: éªŒè¯åˆ†å¸ƒå¼é”çš„æ­£ç¡®æ€§ æ€§èƒ½æµ‹è¯•: æµ‹è¯•ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹çš„è¡¨ç° å¼‚å¸¸æµ‹è¯•: æµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µä¸‹çš„ç³»ç»Ÿè¡Œä¸º 9. ä¸šåŠ¡æµç¨‹è¯¦è§£ 9.1 ç§’æ€ä¸šåŠ¡æµç¨‹ 9.1.1 ç”¨æˆ·å‚ä¸ç§’æ€æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 sequenceDiagram participant U as ç”¨æˆ· participant C as æ§åˆ¶å™¨ participant S as æœåŠ¡å±‚ participant R as Redis participant D as æ•°æ®åº“ U-\u0026gt;\u0026gt;C: å‚ä¸ç§’æ€è¯·æ±‚ C-\u0026gt;\u0026gt;S: è°ƒç”¨ç§’æ€æœåŠ¡ S-\u0026gt;\u0026gt;R: è·å–åˆ†å¸ƒå¼é” R--\u0026gt;\u0026gt;S: é”è·å–æˆåŠŸ S-\u0026gt;\u0026gt;R: æ‰§è¡ŒLuaè„šæœ¬ R--\u0026gt;\u0026gt;S: è¿”å›æ‰§è¡Œç»“æœ S-\u0026gt;\u0026gt;D: æ›´æ–°æ•°æ®åº“ D--\u0026gt;\u0026gt;S: æ›´æ–°æˆåŠŸ S-\u0026gt;\u0026gt;R: é‡Šæ”¾é” R--\u0026gt;\u0026gt;S: é”é‡Šæ”¾æˆåŠŸ S--\u0026gt;\u0026gt;C: è¿”å›ç»“æœ C--\u0026gt;\u0026gt;U: è¿”å›å“åº” æµç¨‹è¯´æ˜:\nç”¨æˆ·è¯·æ±‚: ç”¨æˆ·å‘èµ·ç§’æ€å‚ä¸è¯·æ±‚ è·å–é”: ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é—®é¢˜ æ‰§è¡Œè„šæœ¬: ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ æ›´æ–°æ•°æ®åº“: æ›´æ–°åº“å­˜å’Œè®¢å•ä¿¡æ¯ é‡Šæ”¾é”: é‡Šæ”¾åˆ†å¸ƒå¼é” è¿”å›ç»“æœ: è¿”å›å¤„ç†ç»“æœç»™ç”¨æˆ· 9.1.2 é˜²è¶…å–æœºåˆ¶ Luaè„šæœ¬å®ç°:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 -- ç§’æ€å‚ä¸è„šæœ¬ local stockKey = KEYS[1] local participantsKey = KEYS[2] local userId = ARGV[1] local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) -- æ£€æŸ¥åº“å­˜ local currentStock = redis.call(\u0026#39;get\u0026#39;, stockKey) if not currentStock then return {0, \u0026#39;æ´»åŠ¨ä¸å­˜åœ¨\u0026#39;} end currentStock = tonumber(currentStock) if currentStock \u0026lt; quantity then return {0, \u0026#39;åº“å­˜ä¸è¶³\u0026#39;} end -- æ£€æŸ¥ç”¨æˆ·è´­ä¹°é™åˆ¶ local userPurchased = redis.call(\u0026#39;hget\u0026#39;, participantsKey, userId) if userPurchased then userPurchased = tonumber(userPurchased) if userPurchased + quantity \u0026gt; perUserLimit then return {0, \u0026#39;è¶…å‡ºè´­ä¹°é™åˆ¶\u0026#39;} end end -- æ‰£å‡åº“å­˜ redis.call(\u0026#39;decrby\u0026#39;, stockKey, quantity) -- è®°å½•ç”¨æˆ·è´­ä¹° redis.call(\u0026#39;hincrby\u0026#39;, participantsKey, userId, quantity) return {1, \u0026#39;å‚ä¸æˆåŠŸ\u0026#39;} é˜²è¶…å–åŸç†:\nåŸå­æ€§æ“ä½œ: Luaè„šæœ¬ä¿è¯æ“ä½œçš„åŸå­æ€§ åº“å­˜æ£€æŸ¥: å…ˆæ£€æŸ¥åº“å­˜å†æ‰£å‡ ç”¨æˆ·é™åˆ¶: æ£€æŸ¥ç”¨æˆ·è´­ä¹°é™åˆ¶ çŠ¶æ€æ›´æ–°: åŒæ—¶æ›´æ–°åº“å­˜å’Œç”¨æˆ·è®°å½• 9.2 ä¼˜æƒ åˆ¸ä¸šåŠ¡æµç¨‹ 9.2.1 ä¼˜æƒ åˆ¸é¢†å–æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 sequenceDiagram participant U as ç”¨æˆ· participant C as æ§åˆ¶å™¨ participant S as æœåŠ¡å±‚ participant D as æ•°æ®åº“ U-\u0026gt;\u0026gt;C: é¢†å–ä¼˜æƒ åˆ¸è¯·æ±‚ C-\u0026gt;\u0026gt;S: è°ƒç”¨ä¼˜æƒ åˆ¸æœåŠ¡ S-\u0026gt;\u0026gt;D: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é¢†å– D--\u0026gt;\u0026gt;S: è¿”å›æ£€æŸ¥ç»“æœ S-\u0026gt;\u0026gt;D: æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿ D--\u0026gt;\u0026gt;S: è¿”å›æ¨¡æ¿ä¿¡æ¯ S-\u0026gt;\u0026gt;D: åˆ›å»ºä¼˜æƒ åˆ¸è®°å½• D--\u0026gt;\u0026gt;S: åˆ›å»ºæˆåŠŸ S--\u0026gt;\u0026gt;C: è¿”å›ç»“æœ C--\u0026gt;\u0026gt;U: è¿”å›å“åº” ä¸šåŠ¡è§„åˆ™:\né¢†å–é™åˆ¶: æ¯ä¸ªç”¨æˆ·æ¯ç§ä¼˜æƒ åˆ¸åªèƒ½é¢†å–ä¸€æ¬¡ æœ‰æ•ˆæœŸæ£€æŸ¥: ç¡®ä¿ä¼˜æƒ åˆ¸åœ¨æœ‰æ•ˆæœŸå†… çŠ¶æ€æ£€æŸ¥: æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿æ˜¯å¦å¯ç”¨ è®°å½•åˆ›å»º: åˆ›å»ºç”¨æˆ·ä¼˜æƒ åˆ¸è®°å½• 9.2.2 ä¼˜æƒ åˆ¸ä½¿ç”¨æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 sequenceDiagram participant U as ç”¨æˆ· participant C as æ§åˆ¶å™¨ participant S as æœåŠ¡å±‚ participant D as æ•°æ®åº“ U-\u0026gt;\u0026gt;C: ä½¿ç”¨ä¼˜æƒ åˆ¸è¯·æ±‚ C-\u0026gt;\u0026gt;S: è°ƒç”¨ä¼˜æƒ åˆ¸æœåŠ¡ S-\u0026gt;\u0026gt;D: æ£€æŸ¥ä¼˜æƒ åˆ¸çŠ¶æ€ D--\u0026gt;\u0026gt;S: è¿”å›ä¼˜æƒ åˆ¸ä¿¡æ¯ S-\u0026gt;\u0026gt;D: æ£€æŸ¥ä½¿ç”¨æ¡ä»¶ D--\u0026gt;\u0026gt;S: è¿”å›æ£€æŸ¥ç»“æœ S-\u0026gt;\u0026gt;D: æ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€ D--\u0026gt;\u0026gt;S: æ›´æ–°æˆåŠŸ S--\u0026gt;\u0026gt;C: è¿”å›ç»“æœ C--\u0026gt;\u0026gt;U: è¿”å›å“åº” ä½¿ç”¨æ¡ä»¶:\nçŠ¶æ€æ£€æŸ¥: ä¼˜æƒ åˆ¸å¿…é¡»ä¸ºæœªä½¿ç”¨çŠ¶æ€ æœ‰æ•ˆæœŸæ£€æŸ¥: ä¼˜æƒ åˆ¸å¿…é¡»åœ¨æœ‰æ•ˆæœŸå†… ä½¿ç”¨æ¡ä»¶: æ£€æŸ¥è®¢å•é‡‘é¢æ˜¯å¦æ»¡è¶³ä½¿ç”¨æ¡ä»¶ çŠ¶æ€æ›´æ–°: æ›´æ–°ä¼˜æƒ åˆ¸ä¸ºå·²ä½¿ç”¨çŠ¶æ€ 9.3 ç§¯åˆ†ä¸šåŠ¡æµç¨‹ 9.3.1 ç§¯åˆ†è·å¾—æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 sequenceDiagram participant O as è®¢å•æœåŠ¡ participant M as æ¶ˆæ¯é˜Ÿåˆ— participant I as ç§¯åˆ†æœåŠ¡ participant D as æ•°æ®åº“ O-\u0026gt;\u0026gt;M: å‘é€ç§¯åˆ†æ¶ˆæ¯ M-\u0026gt;\u0026gt;I: æ¶ˆè´¹ç§¯åˆ†æ¶ˆæ¯ I-\u0026gt;\u0026gt;D: æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ† D--\u0026gt;\u0026gt;I: è¿”å›å½“å‰ç§¯åˆ† I-\u0026gt;\u0026gt;D: æ›´æ–°ç”¨æˆ·ç§¯åˆ† D--\u0026gt;\u0026gt;I: æ›´æ–°æˆåŠŸ I-\u0026gt;\u0026gt;M: ç¡®è®¤æ¶ˆæ¯ ç§¯åˆ†è§„åˆ™:\nè·å¾—è§„åˆ™: æ¯æ¶ˆè´¹1å…ƒè·å¾—1ç§¯åˆ† æœ‰æ•ˆæœŸ: ç§¯åˆ†æœ‰æ•ˆæœŸä¸º1å¹´ ä½¿ç”¨è§„åˆ™: ç§¯åˆ†å¯ç”¨äºå…‘æ¢ä¼˜æƒ åˆ¸ è®°å½•ç®¡ç†: è®°å½•ç§¯åˆ†å˜åŠ¨å†å² 9.3.2 ç§¯åˆ†ä½¿ç”¨æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 sequenceDiagram participant U as ç”¨æˆ· participant C as æ§åˆ¶å™¨ participant S as æœåŠ¡å±‚ participant D as æ•°æ®åº“ U-\u0026gt;\u0026gt;C: ä½¿ç”¨ç§¯åˆ†è¯·æ±‚ C-\u0026gt;\u0026gt;S: è°ƒç”¨ç§¯åˆ†æœåŠ¡ S-\u0026gt;\u0026gt;D: æ£€æŸ¥ç”¨æˆ·ç§¯åˆ† D--\u0026gt;\u0026gt;S: è¿”å›ç§¯åˆ†ä¿¡æ¯ S-\u0026gt;\u0026gt;D: æ‰£å‡ç”¨æˆ·ç§¯åˆ† D--\u0026gt;\u0026gt;S: æ‰£å‡æˆåŠŸ S--\u0026gt;\u0026gt;C: è¿”å›ç»“æœ C--\u0026gt;\u0026gt;U: è¿”å›å“åº” ä½¿ç”¨é™åˆ¶:\nç§¯åˆ†æ£€æŸ¥: ç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿç§¯åˆ† æœ‰æ•ˆæœŸæ£€æŸ¥: ç¡®ä¿ç§¯åˆ†åœ¨æœ‰æ•ˆæœŸå†… ä½¿ç”¨è®°å½•: è®°å½•ç§¯åˆ†ä½¿ç”¨å†å² çŠ¶æ€æ›´æ–°: æ›´æ–°ç”¨æˆ·ç§¯åˆ†ä½™é¢ 10. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ 10.1 ç¼“å­˜ç­–ç•¥ 10.1.1 Redisç¼“å­˜è®¾è®¡ ç¼“å­˜é”®è®¾è®¡:\n1 2 3 4 seckill:stock:æ´»åŠ¨ID # åº“å­˜ç¼“å­˜ seckill:participants:æ´»åŠ¨ID # å‚ä¸è€…ç¼“å­˜ seckill:lock:ä¸šåŠ¡é”® # é”ç¼“å­˜ seckill:order:è®¢å•ID # è®¢å•ç¼“å­˜ ç¼“å­˜æ›´æ–°ç­–ç•¥:\nå†™ç©¿é€: å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ ç¼“å­˜é¢„çƒ­: ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ® ç¼“å­˜æ›´æ–°: æ•°æ®å˜æ›´æ—¶åŠæ—¶æ›´æ–°ç¼“å­˜ ç¼“å­˜è¿‡æœŸ: è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ 10.1.2 ç¼“å­˜ä¸€è‡´æ€§ ä¸€è‡´æ€§ä¿è¯:\næœ€ç»ˆä¸€è‡´æ€§: å…è®¸çŸ­æš‚çš„ä¸ä¸€è‡´ ç‰ˆæœ¬æ§åˆ¶: ä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶ç¼“å­˜æ›´æ–° äº‹ä»¶é©±åŠ¨: é€šè¿‡äº‹ä»¶æœºåˆ¶æ›´æ–°ç¼“å­˜ ç›‘æ§å‘Šè­¦: ç›‘æ§ç¼“å­˜ä¸€è‡´æ€§çŠ¶æ€ 10.2 æ•°æ®åº“ä¼˜åŒ– 10.2.1 ç´¢å¼•ä¼˜åŒ– ç§’æ€æ´»åŠ¨è¡¨ç´¢å¼•:\n1 2 3 4 5 6 7 8 -- æ´»åŠ¨çŠ¶æ€ç´¢å¼• CREATE INDEX idx_seckill_activity_status ON seckill_activity(status); -- æ—¶é—´èŒƒå›´ç´¢å¼• CREATE INDEX idx_seckill_activity_time ON seckill_activity(start_time, end_time); -- å•†å“IDç´¢å¼• CREATE INDEX idx_seckill_activity_dish_id ON seckill_activity(dish_id); ä¼˜æƒ åˆ¸è¡¨ç´¢å¼•:\n1 2 3 4 5 6 7 8 -- ç”¨æˆ·IDç´¢å¼• CREATE INDEX idx_coupon_user_id ON coupon(user_id); -- çŠ¶æ€ç´¢å¼• CREATE INDEX idx_coupon_status ON coupon(status); -- æ¨¡æ¿IDç´¢å¼• CREATE INDEX idx_coupon_template_id ON coupon(template_id); 10.2.2 åˆ†åº“åˆ†è¡¨ç­–ç•¥ åˆ†è¡¨ç­–ç•¥:\næŒ‰æ—¶é—´åˆ†è¡¨: æŒ‰æœˆæˆ–æŒ‰å¹´åˆ†è¡¨ æŒ‰ç”¨æˆ·IDåˆ†è¡¨: æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†è¡¨ æŒ‰æ´»åŠ¨IDåˆ†è¡¨: æŒ‰æ´»åŠ¨IDåˆ†è¡¨ æŒ‰çŠ¶æ€åˆ†è¡¨: æŒ‰æ•°æ®çŠ¶æ€åˆ†è¡¨ 10.3 å¹¶å‘æ§åˆ¶ 10.3.1 åˆ†å¸ƒå¼é”ä¼˜åŒ– é”ç²’åº¦æ§åˆ¶:\nç»†ç²’åº¦é”: æŒ‰å•†å“IDåŠ é” é”è¶…æ—¶è®¾ç½®: è®¾ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´ é”é‡å…¥: æ”¯æŒé”é‡å…¥æœºåˆ¶ é”ç›‘æ§: ç›‘æ§é”çš„ä½¿ç”¨æƒ…å†µ é”æ€§èƒ½ä¼˜åŒ–:\né”ç¼“å­˜: ç¼“å­˜é”å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»º é”å‡çº§: æ”¯æŒé”å‡çº§æœºåˆ¶ é”é™çº§: æ”¯æŒé”é™çº§æœºåˆ¶ é”é‡Šæ”¾: ç¡®ä¿é”çš„æ­£ç¡®é‡Šæ”¾ 10.3.2 é™æµç­–ç•¥ æ¥å£é™æµ:\nä»¤ç‰Œæ¡¶ç®—æ³•: ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•é™æµ æ»‘åŠ¨çª—å£: ä½¿ç”¨æ»‘åŠ¨çª—å£é™æµ æ¼æ¡¶ç®—æ³•: ä½¿ç”¨æ¼æ¡¶ç®—æ³•é™æµ è‡ªé€‚åº”é™æµ: æ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªé€‚åº”é™æµ ç”¨æˆ·é™æµ:\nIPé™æµ: æŒ‰IPåœ°å€é™æµ ç”¨æˆ·é™æµ: æŒ‰ç”¨æˆ·IDé™æµ è®¾å¤‡é™æµ: æŒ‰è®¾å¤‡IDé™æµ è¡Œä¸ºé™æµ: æŒ‰ç”¨æˆ·è¡Œä¸ºé™æµ 11. ç›‘æ§å’Œå‘Šè­¦ 11.1 ç³»ç»Ÿç›‘æ§ 11.1.1 æ€§èƒ½ç›‘æ§ å…³é”®æŒ‡æ ‡:\nå“åº”æ—¶é—´: æ¥å£å“åº”æ—¶é—´ç›‘æ§ ååé‡: ç³»ç»Ÿååé‡ç›‘æ§ é”™è¯¯ç‡: ç³»ç»Ÿé”™è¯¯ç‡ç›‘æ§ èµ„æºä½¿ç”¨: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ ç›‘æ§å·¥å…·:\nPrometheus: æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨ Grafana: æŒ‡æ ‡å¯è§†åŒ– AlertManager: å‘Šè­¦ç®¡ç† Jaeger: åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª 11.1.2 ä¸šåŠ¡ç›‘æ§ ä¸šåŠ¡æŒ‡æ ‡:\nç§’æ€æˆåŠŸç‡: ç§’æ€æ´»åŠ¨æˆåŠŸç‡ ä¼˜æƒ åˆ¸ä½¿ç”¨ç‡: ä¼˜æƒ åˆ¸ä½¿ç”¨ç‡ ç§¯åˆ†ä½¿ç”¨ç‡: ç§¯åˆ†ä½¿ç”¨ç‡ ç”¨æˆ·æ´»è·ƒåº¦: ç”¨æˆ·æ´»è·ƒåº¦æŒ‡æ ‡ 11.2 å‘Šè­¦æœºåˆ¶ 11.2.1 å‘Šè­¦è§„åˆ™ ç³»ç»Ÿå‘Šè­¦:\nå“åº”æ—¶é—´å‘Šè­¦: å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ é”™è¯¯ç‡å‘Šè­¦: é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ èµ„æºä½¿ç”¨å‘Šè­¦: èµ„æºä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼ æœåŠ¡å¯ç”¨æ€§å‘Šè­¦: æœåŠ¡ä¸å¯ç”¨å‘Šè­¦ ä¸šåŠ¡å‘Šè­¦:\nåº“å­˜å‘Šè­¦: åº“å­˜ä¸è¶³å‘Šè­¦ æ´»åŠ¨å¼‚å¸¸å‘Šè­¦: æ´»åŠ¨å¼‚å¸¸å‘Šè­¦ æ•°æ®å¼‚å¸¸å‘Šè­¦: æ•°æ®å¼‚å¸¸å‘Šè­¦ ç”¨æˆ·å¼‚å¸¸å‘Šè­¦: ç”¨æˆ·è¡Œä¸ºå¼‚å¸¸å‘Šè­¦ 11.2.2 å‘Šè­¦å¤„ç† å‘Šè­¦æµç¨‹:\nå‘Šè­¦è§¦å‘: ç›‘æ§æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼ å‘Šè­¦å‘é€: å‘é€å‘Šè­¦é€šçŸ¥ å‘Šè­¦å¤„ç†: å¤„ç†å‘Šè­¦é—®é¢˜ å‘Šè­¦æ¢å¤: å‘Šè­¦æ¢å¤é€šçŸ¥ 12. æµ‹è¯•ç­–ç•¥ 12.1 å•å…ƒæµ‹è¯• 12.1.1 æœåŠ¡å±‚æµ‹è¯• æµ‹è¯•è¦†ç›–:\næ­£å¸¸æµç¨‹æµ‹è¯•: æµ‹è¯•æ­£å¸¸ä¸šåŠ¡æµç¨‹ å¼‚å¸¸æµç¨‹æµ‹è¯•: æµ‹è¯•å¼‚å¸¸æƒ…å†µå¤„ç† è¾¹ç•Œæ¡ä»¶æµ‹è¯•: æµ‹è¯•è¾¹ç•Œæ¡ä»¶ å¹¶å‘æµ‹è¯•: æµ‹è¯•å¹¶å‘åœºæ™¯ æµ‹è¯•å·¥å…·:\nJUnit: å•å…ƒæµ‹è¯•æ¡†æ¶ Mockito: Mockæµ‹è¯•æ¡†æ¶ TestContainers: å®¹å™¨åŒ–æµ‹è¯• WireMock: HTTPæœåŠ¡Mock 12.1.2 é›†æˆæµ‹è¯• æµ‹è¯•åœºæ™¯:\næ•°æ®åº“é›†æˆæµ‹è¯•: æµ‹è¯•æ•°æ®åº“æ“ä½œ Redisé›†æˆæµ‹è¯•: æµ‹è¯•Redisæ“ä½œ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆæµ‹è¯•: æµ‹è¯•æ¶ˆæ¯é˜Ÿåˆ—æ“ä½œ å¤–éƒ¨æœåŠ¡é›†æˆæµ‹è¯•: æµ‹è¯•å¤–éƒ¨æœåŠ¡è°ƒç”¨ 12.2 æ€§èƒ½æµ‹è¯• 12.2.1 å‹åŠ›æµ‹è¯• æµ‹è¯•å·¥å…·:\nJMeter: æ€§èƒ½æµ‹è¯•å·¥å…· Gatling: é«˜æ€§èƒ½æµ‹è¯•å·¥å…· Artillery: è½»é‡çº§æµ‹è¯•å·¥å…· K6: ç°ä»£åŒ–æµ‹è¯•å·¥å…· æµ‹è¯•åœºæ™¯:\nç§’æ€å‹åŠ›æµ‹è¯•: æµ‹è¯•ç§’æ€åœºæ™¯æ€§èƒ½ ä¼˜æƒ åˆ¸å‹åŠ›æµ‹è¯•: æµ‹è¯•ä¼˜æƒ åˆ¸åœºæ™¯æ€§èƒ½ ç§¯åˆ†å‹åŠ›æµ‹è¯•: æµ‹è¯•ç§¯åˆ†åœºæ™¯æ€§èƒ½ æ··åˆåœºæ™¯æµ‹è¯•: æµ‹è¯•æ··åˆåœºæ™¯æ€§èƒ½ 12.2.2 ç¨³å®šæ€§æµ‹è¯• æµ‹è¯•ç›®æ ‡:\né•¿æ—¶é—´è¿è¡Œ: æµ‹è¯•ç³»ç»Ÿé•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§ å†…å­˜æ³„æ¼: æµ‹è¯•å†…å­˜æ³„æ¼é—®é¢˜ èµ„æºä½¿ç”¨: æµ‹è¯•èµ„æºä½¿ç”¨æƒ…å†µ æ€§èƒ½è¡°å‡: æµ‹è¯•æ€§èƒ½è¡°å‡æƒ…å†µ 13. éƒ¨ç½²å’Œè¿ç»´ 13.1 éƒ¨ç½²ç­–ç•¥ 13.1.1 å®¹å™¨åŒ–éƒ¨ç½² Dockeré…ç½®:\n1 2 3 4 FROM openjdk:17-jre-slim COPY target/sky-server.jar app.jar EXPOSE 8084 ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;/app.jar\u0026#34;] Docker Composeé…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 version: \u0026#39;3.8\u0026#39; services: sky-server: build: . ports: - \u0026#34;8084:8084\u0026#34; environment: - SPRING_PROFILES_ACTIVE=prod depends_on: - redis - rabbitmq - mysql redis: image: redis:7-alpine ports: - \u0026#34;6379:6379\u0026#34; rabbitmq: image: rabbitmq:3-management ports: - \u0026#34;5672:5672\u0026#34; - \u0026#34;15672:15672\u0026#34; mysql: image: mysql:8.0 ports: - \u0026#34;3306:3306\u0026#34; environment: - MYSQL_ROOT_PASSWORD=root - MYSQL_DATABASE=sky 13.1.2 å¾®æœåŠ¡éƒ¨ç½² æœåŠ¡æ‹†åˆ†:\nç”¨æˆ·æœåŠ¡: ç”¨æˆ·ç›¸å…³åŠŸèƒ½ è®¢å•æœåŠ¡: è®¢å•ç›¸å…³åŠŸèƒ½ å•†å“æœåŠ¡: å•†å“ç›¸å…³åŠŸèƒ½ ä¼˜æƒ åˆ¸æœåŠ¡: ä¼˜æƒ åˆ¸ç›¸å…³åŠŸèƒ½ ç§¯åˆ†æœåŠ¡: ç§¯åˆ†ç›¸å…³åŠŸèƒ½ æœåŠ¡æ²»ç†:\næœåŠ¡æ³¨å†Œ: ä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡æ³¨å†Œ æœåŠ¡å‘ç°: ä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡å‘ç° è´Ÿè½½å‡è¡¡: ä½¿ç”¨Ribbonè¿›è¡Œè´Ÿè½½å‡è¡¡ ç†”æ–­é™çº§: ä½¿ç”¨Sentinelè¿›è¡Œç†”æ–­é™çº§ 13.2 è¿ç»´ç›‘æ§ 13.2.1 æ—¥å¿—ç®¡ç† æ—¥å¿—é…ç½®:\n1 2 3 4 5 6 7 8 9 logging: level: com.sky: INFO pattern: console: \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34; file: name: logs/sky-server.log max-size: 100MB max-history: 30 æ—¥å¿—æ”¶é›†:\nELK Stack: ä½¿ç”¨Elasticsearchã€Logstashã€Kibana Fluentd: ä½¿ç”¨Fluentdæ”¶é›†æ—¥å¿— Filebeat: ä½¿ç”¨Filebeatæ”¶é›†æ—¥å¿— Logback: ä½¿ç”¨Logbackè®°å½•æ—¥å¿— 13.2.2 ç›‘æ§å‘Šè­¦ ç›‘æ§æŒ‡æ ‡:\nç³»ç»ŸæŒ‡æ ‡: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ åº”ç”¨æŒ‡æ ‡: å“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ ä¸šåŠ¡æŒ‡æ ‡: è®¢å•é‡ã€ç”¨æˆ·é‡ã€æ”¶å…¥ åŸºç¡€è®¾æ–½æŒ‡æ ‡: æ•°æ®åº“ã€Redisã€æ¶ˆæ¯é˜Ÿåˆ— å‘Šè­¦é…ç½®:\né˜ˆå€¼å‘Šè­¦: è®¾ç½®æŒ‡æ ‡é˜ˆå€¼å‘Šè­¦ è¶‹åŠ¿å‘Šè­¦: è®¾ç½®è¶‹åŠ¿å˜åŒ–å‘Šè­¦ å¼‚å¸¸å‘Šè­¦: è®¾ç½®å¼‚å¸¸æƒ…å†µå‘Šè­¦ æ¢å¤å‘Šè­¦: è®¾ç½®æ¢å¤æƒ…å†µå‘Šè­¦ é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼é”é˜²è¶…å–ç³»ç»Ÿï¼Œç¡®ä¿äº†ç§’æ€å’Œä¼˜æƒ åˆ¸åŠŸèƒ½çš„çº¿ç¨‹å®‰å…¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§ã€‚\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/hash%E5%92%96%E5%95%A1%E9%A1%B9%E7%9B%AE%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/","title":"Hashå’–å•¡é¡¹ç›®åç«¯æ”¹é€ æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†ï¼šå®ä½“ç±»å’Œåˆ†å¸ƒå¼é”å®ç°"},{"content":"RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºè§£è€¦å’Œå¼‚æ­¥å¤„ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…¶å¯é æ€§è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†ä»ç”Ÿäº§è€…è§’åº¦æ·±å…¥è§£æRabbitMQçš„ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ï¼Œä»¥åŠå®Œæ•´çš„ä»£ç å®ç°å’Œæœ€ä½³å®è·µã€‚\nç›®å½• ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ RabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯ æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç† åŒæ­¥ Confirm æ¨¡å¼ å¼‚æ­¥ Confirm æ¨¡å¼ Return æœºåˆ¶ publisher-confirm-type é…ç½® ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ å®Œæ•´ä»£ç å®ç° æœ€ä½³å®è·µä¸æ€»ç»“ ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ç¡®è®¤ï¼ˆConsumer Ackï¼‰æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå®ƒä¿è¯äº†æ¶ˆæ¯ä¸ä¼š\u0026quot;ç™½ç™½ä¸¢å¤±\u0026quot;ã€‚\nä½†å¾€å¾€è¢«å¿½è§†çš„ä¸€ç‚¹æ˜¯ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ° RabbitMQ Broker çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯èƒ½ä¸¢å¤±æ¶ˆæ¯ã€‚å¸¸è§æƒ…å†µåŒ…æ‹¬ï¼š\næ¶ˆæ¯ä¸¢å¤±åœºæ™¯ ç½‘ç»œç¬æ—¶ä¸­æ–­ï¼šæ¶ˆæ¯æ²¡æœ‰åˆ°è¾¾ Broker Broker æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†å°šæœªæŒä¹…åŒ–å°±å´©æºƒ Exchange è·¯ç”±å¤±è´¥ï¼šæ¶ˆæ¯æ²¡æœ‰è¿›å…¥ä»»ä½•é˜Ÿåˆ— å†…å­˜ä¸è¶³ï¼šBroker å†…å­˜æº¢å‡ºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤± ç£ç›˜æ•…éšœï¼šæŒä¹…åŒ–æ¶ˆæ¯æ—¶ç£ç›˜å†™å…¥å¤±è´¥ é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆä¸å¯é å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 // âŒ é”™è¯¯å®ç°ï¼šæ²¡æœ‰ç¡®è®¤æœºåˆ¶ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤± @Service public class UnreliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; public void sendMessage(String message) { // ç›´æ¥å‘é€ï¼Œä¸çŸ¥é“æ˜¯å¦æˆåŠŸ rabbitTemplate.convertAndSend(\u0026#34;exchange\u0026#34;, \u0026#34;routingKey\u0026#34;, message); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€\u0026#34;); // è¿™é‡Œå¯èƒ½æ¶ˆæ¯å·²ç»ä¸¢å¤±äº†ï¼ } } å¯é å®ç°å¯¹æ¯” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // âœ… æ­£ç¡®å®ç°ï¼šå¸¦ç¡®è®¤æœºåˆ¶ @Service public class ReliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; public void sendMessage(String message) { try { // å¼€å¯ç¡®è®¤æ¨¡å¼ rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ\u0026#34;); } else { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: \u0026#34; + cause); } }); rabbitTemplate.convertAndSend(\u0026#34;exchange\u0026#34;, \u0026#34;routingKey\u0026#34;, message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } å¦‚æœæ²¡æœ‰å¯é çš„ç¡®è®¤æœºåˆ¶ï¼Œç”Ÿäº§è€…ä¼šè®¤ä¸ºæ¶ˆæ¯å·²ç»æˆåŠŸæŠ•é€’ï¼Œä½†å®é™…ä¸Šæ¶ˆæ¯å¯èƒ½åœ¨åŠè·¯ä¸¢äº†ã€‚\nå› æ­¤ï¼ŒRabbitMQ æä¾›äº† Publisher Confirms å’Œ Return æœºåˆ¶ æ¥ä¿è¯ç”Ÿäº§è€…ä¾§çš„å¯é æ€§ã€‚\nRabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯ è®©æˆ‘ä»¬ä»æ•´ä½“é“¾è·¯çœ‹ä¸€æ¬¡æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„ç”Ÿå‘½å‘¨æœŸï¼š\nå®Œæ•´æŠ•é€’é“¾è·¯ 1 2 3 4 5 6 ç”Ÿäº§è€… â†’ Channel â†’ Broker â†’ æ¶ˆæ¯æŒä¹…åŒ– â†’ Exchange â†’ è·¯ç”±æ£€æŸ¥ â†’ Queue â†’ æ¶ˆè´¹è€… â†“ â†“ â†“ â†“ â†“ â†“ â†“ â†“ deliveryTag æœªç¡®è®¤æ¶ˆæ¯Map Confirmæœºåˆ¶ æŒä¹…åŒ–ç»“æœ è·¯ç”±ç»“æœ æ¶ˆæ¯çŠ¶æ€ æ¶ˆè´¹ç»“æœ â†“ â†“ â†“ â†“ â†“ â†“ â†“ â†“ ç”Ÿæˆå”¯ä¸€ID è®°å½•å¾…ç¡®è®¤ å¤„ç†Ack/Nack æˆåŠŸâ†’Ack æˆåŠŸâ†’è¿›å…¥Queue ç­‰å¾…æ¶ˆè´¹ æˆåŠŸâ†’Ack æ¶ˆæ¯ä¿¡æ¯ å¤±è´¥â†’Nack å¤±è´¥â†’Returnæœºåˆ¶ å¤±è´¥â†’ReturnCallback å¤±è´¥â†’Nack è¯¦ç»†æµç¨‹è¯´æ˜ï¼š 1. ç”Ÿäº§è€…å‘é€é˜¶æ®µ\n1 2 3 4 ç”Ÿäº§è€… â†’ Channel â”œâ”€â”€ ç”Ÿæˆ deliveryTagï¼ˆé€’å¢è®¡æ•°å™¨ï¼‰ â”œâ”€â”€ åŠ å…¥æœªç¡®è®¤æ¶ˆæ¯Map â””â”€â”€ å‘é€æ¶ˆæ¯åˆ°Broker 2. Brokerå¤„ç†é˜¶æ®µ\n1 2 3 Broker â†’ æ¶ˆæ¯æŒä¹…åŒ– â”œâ”€â”€ æŒä¹…åŒ–æˆåŠŸ â†’ è¿”å›Ack â†’ è§¦å‘Confirmæœºåˆ¶ â””â”€â”€ æŒä¹…åŒ–å¤±è´¥ â†’ è¿”å›Nack â†’ è§¦å‘Confirmæœºåˆ¶ 3. æ¶ˆæ¯è·¯ç”±é˜¶æ®µ\n1 2 3 Exchange â†’ è·¯ç”±æ£€æŸ¥ â”œâ”€â”€ è·¯ç”±æˆåŠŸ â†’ æ¶ˆæ¯è¿›å…¥Queue â†’ ç­‰å¾…æ¶ˆè´¹è€… â””â”€â”€ è·¯ç”±å¤±è´¥ â†’ è§¦å‘Returnæœºåˆ¶ â†’ è°ƒç”¨ReturnCallback 4. æ¶ˆè´¹è€…å¤„ç†é˜¶æ®µ\n1 2 3 æ¶ˆè´¹è€… â†’ å¤„ç†æ¶ˆæ¯ â”œâ”€â”€ æ¶ˆè´¹æˆåŠŸ â†’ å‘é€Consumer Ack â””â”€â”€ æ¶ˆè´¹å¤±è´¥ â†’ å‘é€Consumer Nack å…³é”®æœºåˆ¶å¯¹æ¯”è¡¨ï¼š æœºåˆ¶ è§¦å‘æ—¶æœº è¿”å›ç»“æœ ä½œç”¨èŒƒå›´ å¤„ç†æ–¹å¼ Confirmæœºåˆ¶ æ¶ˆæ¯åˆ°è¾¾Brokerå Ack/Nack ç”Ÿäº§è€…â†’Broker å¼‚æ­¥å›è°ƒ/åŒæ­¥ç­‰å¾… Returnæœºåˆ¶ è·¯ç”±å¤±è´¥æ—¶ Basic.Return Exchangeâ†’Queue ReturnCallback Consumer Ack æ¶ˆè´¹å®Œæˆå Consumer Ack/Nack Queueâ†’æ¶ˆè´¹è€… æ‰‹åŠ¨ç¡®è®¤/è‡ªåŠ¨ç¡®è®¤ æ¶ˆæ¯çŠ¶æ€æµè½¬ï¼š 1 2 3 4 5 æ¶ˆæ¯çŠ¶æ€: å‘é€ä¸­ â†’ å·²æŒä¹…åŒ– â†’ å·²è·¯ç”± â†’ å·²æ¶ˆè´¹ â†“ â†“ â†“ â†“ ç¡®è®¤æœºåˆ¶: æ—  Confirm Return Consumer Ack â†“ â†“ â†“ â†“ å¤„ç†ç»“æœ: ç­‰å¾… æˆåŠŸ/å¤±è´¥ æˆåŠŸ/å¤±è´¥ æˆåŠŸ/å¤±è´¥ è¯¦ç»†æµç¨‹è¯´æ˜ ç”Ÿäº§è€…è°ƒç”¨ channel.basicPublish\nå°†æ¶ˆæ¯é€šè¿‡ Channel å‘é€åˆ° Broker åŒæ—¶ï¼ŒChannel å†…éƒ¨ä¼šä¸ºè¯¥æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ª é€’å¢çš„ deliveryTag æŠŠå®ƒæ”¾åˆ°ä¸€ä¸ª\u0026quot;æœªç¡®è®¤æ¶ˆæ¯ Map\u0026quot;ä¸­ï¼ˆä»…åœ¨å¼€å¯ Confirm æ¨¡å¼æ—¶ï¼‰ Broker æ”¶åˆ°æ¶ˆæ¯å¹¶ç«‹å³æŒä¹…åŒ–\næ ¹æ® BasicPropertiesï¼ˆåŒ…æ‹¬æŒä¹…åŒ–æ ‡å¿—ï¼‰å°è¯•å­˜å‚¨æ¶ˆæ¯ æŒä¹…åŒ–æˆåŠŸ â†’ å‡†å¤‡è¿”å› Ack æŒä¹…åŒ–å¤±è´¥ â†’ å‡†å¤‡è¿”å› Nack æ¶ˆæ¯è·¯ç”±å¤„ç†\næŒä¹…åŒ–æˆåŠŸåï¼Œå°†æ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº”çš„ Exchange Exchange è¿›è¡Œè·¯ç”±æ£€æŸ¥ï¼š è·¯ç”±æˆåŠŸ â†’ æ¶ˆæ¯è¿›å…¥ç›®æ ‡ Queue è·¯ç”±å¤±è´¥ â†’ è§¦å‘ Return æœºåˆ¶ï¼ˆå¦‚æœè®¾ç½®äº† mandatory=trueï¼‰ Confirm æœºåˆ¶å¤„ç†\nBroker é€šè¿‡ AMQP åè®®è¿”å› Confirm æ¶ˆæ¯å¸§ï¼ˆåŒ…å« deliveryTagã€ack/nackã€multipleï¼‰ ç”Ÿäº§è€…çš„ Channel æ”¶åˆ°åï¼Œè§¦å‘å†…éƒ¨ Confirm å¤„ç†é€»è¾‘ Channel ä»\u0026quot;æœªç¡®è®¤ Map\u0026quot;ä¸­æ‰¾åˆ°å¯¹åº” deliveryTag çš„æ¶ˆæ¯ï¼Œç§»é™¤å¹¶è§¦å‘å›è°ƒ Return æœºåˆ¶å¤„ç†ï¼ˆå¯é€‰ï¼‰\nå¦‚æœè·¯ç”±å¤±è´¥ä¸”è®¾ç½®äº† mandatory=true Broker è¿”å› Basic.Return æ¶ˆæ¯å¸§ ç”Ÿäº§è€…é€šè¿‡ ReturnCallback æ¥æ”¶è¯¥äº‹ä»¶ï¼Œå†³å®šæ˜¯å¦é‡è¯•æˆ–ä¸¢å¼ƒ æ¶ˆè´¹è€…å¤„ç†\næ¶ˆè´¹è€…ä» Queue è·å–æ¶ˆæ¯ æ¶ˆè´¹æˆåŠŸ â†’ å‘é€ Consumer Ack æ¶ˆè´¹å¤±è´¥ â†’ å‘é€ Consumer Nack è¿™ä¸€è¿‡ç¨‹ç¡®ä¿äº† ç”Ÿäº§è€…å¯ä»¥æ˜ç¡®çŸ¥é“æ¶ˆæ¯çš„å®Œæ•´æŠ•é€’çŠ¶æ€ï¼Œé¿å…äº†\u0026quot;é»‘ç®±å‘é€\u0026quot;ï¼Œå®ç°äº†ç«¯åˆ°ç«¯çš„æ¶ˆæ¯å¯é æ€§ä¿éšœã€‚\næ ¸å¿ƒæ¦‚å¿µè¯¦è§£ 1. Broker RabbitMQ æœåŠ¡å™¨æœ¬èº«å°±æ˜¯ä¸€ä¸ª Brokerï¼Œè´Ÿè´£æ¥æ”¶ã€å­˜å‚¨ã€è·¯ç”±å’ŒæŠ•é€’æ¶ˆæ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Broker è¿æ¥é…ç½® @Configuration public class RabbitMQConfig { @Bean public ConnectionFactory connectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(\u0026#34;localhost\u0026#34;); factory.setPort(5672); factory.setUsername(\u0026#34;guest\u0026#34;); factory.setPassword(\u0026#34;guest\u0026#34;); factory.setVirtualHost(\u0026#34;/\u0026#34;); // å¼€å¯ç¡®è®¤æ¨¡å¼ factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } } 2. Connection ç”Ÿäº§è€…ä¸ Broker å»ºç«‹çš„ TCP é•¿è¿æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Component public class ConnectionManager { @Autowired private ConnectionFactory connectionFactory; private Connection connection; @PostConstruct public void initConnection() { try { connection = connectionFactory.newConnection(); System.out.println(\u0026#34;è¿æ¥å»ºç«‹æˆåŠŸ\u0026#34;); } catch (Exception e) { System.err.println(\u0026#34;è¿æ¥å»ºç«‹å¤±è´¥: \u0026#34; + e.getMessage()); } } @PreDestroy public void closeConnection() { if (connection != null \u0026amp;\u0026amp; connection.isOpen()) { try { connection.close(); System.out.println(\u0026#34;è¿æ¥å·²å…³é—­\u0026#34;); } catch (Exception e) { System.err.println(\u0026#34;å…³é—­è¿æ¥å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } } 3. Channel åœ¨ Connection ä¸Šçš„é€»è¾‘é€šé“ã€‚\næ¶ˆæ¯çš„å‘é€ã€ç¡®è®¤éƒ½é€šè¿‡ Channel å®Œæˆ ConfirmListener ç»‘å®šåœ¨ Channel ä¸Š deliveryTag ä¹Ÿæ˜¯ä»¥ Channel ä¸ºä½œç”¨åŸŸç”Ÿæˆçš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Service public class ChannelManager { @Autowired private ConnectionFactory connectionFactory; private Channel channel; public Channel getChannel() throws IOException { if (channel == null || !channel.isOpen()) { Connection connection = connectionFactory.newConnection(); channel = connection.createChannel(); // å¼€å¯ç¡®è®¤æ¨¡å¼ channel.confirmSelect(); } return channel; } } 4. Exchange æ¶ˆæ¯è·¯ç”±å™¨ã€‚ç”Ÿäº§è€…åªèƒ½æŠŠæ¶ˆæ¯æŠ•é€’åˆ° Exchangeï¼Œç”± Exchange æ ¹æ®ç±»å‹ï¼ˆDirect/Topic/Fanout/Headersï¼‰å’Œ Binding è§„åˆ™è·¯ç”±åˆ° Queueã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Component public class ExchangeConfig { @Bean public DirectExchange directExchange() { return new DirectExchange(\u0026#34;direct.exchange\u0026#34;, true, false); } @Bean public TopicExchange topicExchange() { return new TopicExchange(\u0026#34;topic.exchange\u0026#34;, true, false); } @Bean public FanoutExchange fanoutExchange() { return new FanoutExchange(\u0026#34;fanout.exchange\u0026#34;, true, false); } } 5. Queue æ¶ˆæ¯çš„å­˜å‚¨å®¹å™¨ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Component public class QueueConfig { @Bean public Queue reliableQueue() { return QueueBuilder.durable(\u0026#34;reliable.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 60000) // æ¶ˆæ¯TTL .withArgument(\u0026#34;x-max-length\u0026#34;, 1000) // é˜Ÿåˆ—æœ€å¤§é•¿åº¦ .build(); } @Bean public Queue deadLetterQueue() { return QueueBuilder.durable(\u0026#34;dead.letter.queue\u0026#34;).build(); } } 6. Binding Exchange ä¸ Queue çš„ç»‘å®šå…³ç³»ï¼Œå†³å®šæ¶ˆæ¯çš„æµå‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 @Component public class BindingConfig { @Bean public Binding reliableBinding() { return BindingBuilder .bind(reliableQueue()) .to(directExchange()) .with(\u0026#34;reliable.key\u0026#34;); } } 7. Basic.Publish AMQP åè®®ä¸­çš„æ¶ˆæ¯å‘é€å‘½ä»¤ã€‚è°ƒç”¨ channel.basicPublish å°±æ˜¯å‘ Broker å‘é€ Basic.Publish æŒ‡ä»¤ï¼Œé™„å¸¦æ¶ˆæ¯ä½“å’Œå±æ€§ã€‚\nç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç† deliveryTag æ¯ä¸ª Channel å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ª é€’å¢çš„è®¡æ•°å™¨ æ¯è°ƒç”¨ä¸€æ¬¡ basicPublishï¼Œè¿™ä¸ªè®¡æ•°å™¨åŠ  1ï¼Œå¾—åˆ°ä¸€ä¸ª deliveryTag deliveryTag ä½œä¸ºæ¶ˆæ¯çš„\u0026quot;å”¯ä¸€åºå·\u0026quot;ï¼Œç”¨äºåç»­ Ack/Nack å¯¹åº” 1 2 3 4 5 6 7 8 9 10 11 12 13 // deliveryTag ç”Ÿæˆç¤ºä¾‹ public class DeliveryTagGenerator { private final AtomicLong deliveryTagCounter = new AtomicLong(0); public long generateDeliveryTag() { return deliveryTagCounter.incrementAndGet(); } public void reset() { deliveryTagCounter.set(0); } } æœªç¡®è®¤æ¶ˆæ¯ Map Channel å†…éƒ¨ä¿å­˜ä¸€ä¸ª æœ‰åº Mapï¼Œkey æ˜¯ deliveryTagï¼Œvalue æ˜¯æ¶ˆæ¯ä¿¡æ¯ åªæœ‰åœ¨å¼€å¯ Confirm æ¨¡å¼åï¼Œè¿™ä¸ª Map æ‰ä¼šå¯ç”¨ Ack/Nack åˆ°æ¥æ—¶ï¼ŒChannel ä¼šæŸ¥ Map æ¥æ‰¾åˆ°éœ€è¦ç¡®è®¤çš„æ¶ˆæ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // æœªç¡®è®¤æ¶ˆæ¯ç®¡ç† public class UnconfirmedMessageManager { private final Map\u0026lt;Long, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); public void addUnconfirmedMessage(long deliveryTag, UnconfirmedMessage message) { unconfirmedMessages.put(deliveryTag, message); } public UnconfirmedMessage removeUnconfirmedMessage(long deliveryTag) { return unconfirmedMessages.remove(deliveryTag); } public void removeMultipleMessages(long deliveryTag) { unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; entry.getKey() \u0026lt;= deliveryTag); } public int getUnconfirmedCount() { return unconfirmedMessages.size(); } } @Data @AllArgsConstructor public class UnconfirmedMessage { private String exchange; private String routingKey; private byte[] body; private long timestamp; } multiple æ ‡å¿—ä½ Ack/Nack æ¶ˆæ¯ä¸­å¸¦æœ‰ multiple å¸ƒå°”å€¼ falseï¼šåªç¡®è®¤å½“å‰ deliveryTag trueï¼šç¡®è®¤ å°äºç­‰äºå½“å‰ deliveryTag çš„æ‰€æœ‰æ¶ˆæ¯ è¿™æ˜¯ä¸€ç§æ‰¹é‡ç¡®è®¤æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œäº¤äº’ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // multiple æ ‡å¿—ä½å¤„ç† public class MultipleConfirmHandler { public void handleConfirm(long deliveryTag, boolean multiple, boolean ack) { if (multiple) { // æ‰¹é‡ç¡®è®¤ï¼šç¡®è®¤æ‰€æœ‰å°äºç­‰äº deliveryTag çš„æ¶ˆæ¯ handleMultipleConfirm(deliveryTag, ack); } else { // å•ä¸ªç¡®è®¤ï¼šåªç¡®è®¤å½“å‰ deliveryTag handleSingleConfirm(deliveryTag, ack); } } private void handleMultipleConfirm(long deliveryTag, boolean ack) { // å¤„ç†æ‰¹é‡ç¡®è®¤é€»è¾‘ System.out.println(\u0026#34;æ‰¹é‡ç¡®è®¤ deliveryTag: \u0026#34; + deliveryTag + \u0026#34;, ack: \u0026#34; + ack); } private void handleSingleConfirm(long deliveryTag, boolean ack) { // å¤„ç†å•ä¸ªç¡®è®¤é€»è¾‘ System.out.println(\u0026#34;å•ä¸ªç¡®è®¤ deliveryTag: \u0026#34; + deliveryTag + \u0026#34;, ack: \u0026#34; + ack); } } Ack/Nack è§¦å‘æ—¶æœº Ackï¼šæ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸï¼Œæˆ–æŠ•é€’åˆ°é˜Ÿåˆ—æˆåŠŸ Nackï¼šå­˜å‚¨å¤±è´¥ã€Broker å†…éƒ¨å¼‚å¸¸ åŒæ­¥ Confirm æ¨¡å¼ å®ç°æ–¹å¼ è°ƒç”¨ channel.confirmSelect() å¼€å¯ Confirm æ¨¡å¼ æ¯æ¬¡ basicPublish ä¹‹åè°ƒç”¨ channel.waitForConfirms() é˜»å¡ç­‰å¾… ç¤ºä¾‹ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 @Service public class SynchronousConfirmProducer { @Autowired private ConnectionFactory connectionFactory; public void sendMessageWithSyncConfirm(String exchange, String routingKey, String message) { Connection connection = null; Channel channel = null; try { // 1. å»ºç«‹è¿æ¥å’Œé€šé“ connection = connectionFactory.newConnection(); channel = connection.createChannel(); // 2. å¼€å¯ç¡®è®¤æ¨¡å¼ channel.confirmSelect(); // 3. å‘é€æ¶ˆæ¯ channel.basicPublish(exchange, routingKey, null, message.getBytes()); // 4. åŒæ­¥ç­‰å¾…ç¡®è®¤ boolean confirmed = channel.waitForConfirms(5000); // 5ç§’è¶…æ—¶ if (confirmed) { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: \u0026#34; + message); } else { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: \u0026#34; + message); } } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } finally { // 5. å…³é—­èµ„æº closeResources(channel, connection); } } public void sendMultipleMessagesWithSyncConfirm(String exchange, String routingKey, List\u0026lt;String\u0026gt; messages) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); channel.confirmSelect(); // æ‰¹é‡å‘é€æ¶ˆæ¯ for (String message : messages) { channel.basicPublish(exchange, routingKey, null, message.getBytes()); } // æ‰¹é‡ç­‰å¾…ç¡®è®¤ boolean confirmed = channel.waitForConfirms(10000); // 10ç§’è¶…æ—¶ if (confirmed) { System.out.println(\u0026#34;æ‰¹é‡æ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œæ•°é‡: \u0026#34; + messages.size()); } else { System.out.println(\u0026#34;æ‰¹é‡æ¶ˆæ¯æŠ•é€’å¤±è´¥\u0026#34;); } } catch (Exception e) { System.err.println(\u0026#34;æ‰¹é‡å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } finally { closeResources(channel, connection); } } private void closeResources(Channel channel, Connection connection) { try { if (channel != null \u0026amp;\u0026amp; channel.isOpen()) { channel.close(); } if (connection != null \u0026amp;\u0026amp; connection.isOpen()) { connection.close(); } } catch (Exception e) { System.err.println(\u0026#34;å…³é—­èµ„æºå¼‚å¸¸: \u0026#34; + e.getMessage()); } } } ç‰¹ç‚¹ ä¼˜ç‚¹ï¼šç®€å•æ˜“æ‡‚ï¼Œå®æ—¶çŸ¥é“ç»“æœ ç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå› ä¸ºæ¯æ¡æ¶ˆæ¯éƒ½è¦é˜»å¡ç­‰å¾… é€‚ç”¨åœºæ™¯ï¼šä½ååã€å¼ºä¸€è‡´åœºæ™¯ å¼‚æ­¥ Confirm æ¨¡å¼ å®ç°æ–¹å¼ è°ƒç”¨ channel.confirmSelect() å¼€å¯ Confirm æ¨¡å¼ æ³¨å†Œ ConfirmListener è°ƒç”¨ basicPublish æ—¶ä¸é˜»å¡ï¼Œä¾èµ–å¼‚æ­¥å›è°ƒå¤„ç† Ack/Nack ç¤ºä¾‹ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 @Service public class AsynchronousConfirmProducer { @Autowired private ConnectionFactory connectionFactory; private final Map\u0026lt;Long, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final AtomicLong deliveryTagCounter = new AtomicLong(0); public void sendMessageWithAsyncConfirm(String exchange, String routingKey, String message) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); channel.confirmSelect(); // æ³¨å†Œå¼‚æ­¥ç¡®è®¤ç›‘å¬å™¨ channel.addConfirmListener( (deliveryTag, multiple) -\u0026gt; { // ack å›è°ƒ handleAck(deliveryTag, multiple); }, (deliveryTag, multiple) -\u0026gt; { // nack å›è°ƒ handleNack(deliveryTag, multiple); } ); // å¼‚æ­¥å‘é€æ¶ˆæ¯ long deliveryTag = deliveryTagCounter.incrementAndGet(); channel.basicPublish(exchange, routingKey, null, message.getBytes()); // è®°å½•æœªç¡®è®¤æ¶ˆæ¯ unconfirmedMessages.put(deliveryTag, new UnconfirmedMessage( exchange, routingKey, message.getBytes(), System.currentTimeMillis() )); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤: \u0026#34; + message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } private void handleAck(long deliveryTag, boolean multiple) { if (multiple) { // æ‰¹é‡ç¡®è®¤ unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; entry.getKey() \u0026lt;= deliveryTag); System.out.println(\u0026#34;æ‰¹é‡ACKï¼ŒdeliveryTag: \u0026#34; + deliveryTag); } else { // å•ä¸ªç¡®è®¤ UnconfirmedMessage message = unconfirmedMessages.remove(deliveryTag); if (message != null) { System.out.println(\u0026#34;æ¶ˆæ¯ç¡®è®¤æˆåŠŸï¼ŒdeliveryTag: \u0026#34; + deliveryTag + \u0026#34;, message: \u0026#34; + new String(message.getBody())); } } } private void handleNack(long deliveryTag, boolean multiple) { if (multiple) { // æ‰¹é‡æ‹’ç» unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; entry.getKey() \u0026lt;= deliveryTag); System.out.println(\u0026#34;æ‰¹é‡NACKï¼ŒdeliveryTag: \u0026#34; + deliveryTag); } else { // å•ä¸ªæ‹’ç» UnconfirmedMessage message = unconfirmedMessages.remove(deliveryTag); if (message != null) { System.out.println(\u0026#34;æ¶ˆæ¯ç¡®è®¤å¤±è´¥ï¼ŒdeliveryTag: \u0026#34; + deliveryTag + \u0026#34;, message: \u0026#34; + new String(message.getBody())); // è¿™é‡Œå¯ä»¥å®ç°é‡è¯•é€»è¾‘ retryMessage(message); } } } private void retryMessage(UnconfirmedMessage message) { // å®ç°é‡è¯•é€»è¾‘ System.out.println(\u0026#34;é‡è¯•æ¶ˆæ¯: \u0026#34; + new String(message.getBody())); } public void sendMultipleMessagesWithAsyncConfirm(String exchange, String routingKey, List\u0026lt;String\u0026gt; messages) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); channel.confirmSelect(); // æ³¨å†Œç¡®è®¤ç›‘å¬å™¨ channel.addConfirmListener( (deliveryTag, multiple) -\u0026gt; handleAck(deliveryTag, multiple), (deliveryTag, multiple) -\u0026gt; handleNack(deliveryTag, multiple) ); // æ‰¹é‡å‘é€æ¶ˆæ¯ for (String message : messages) { long deliveryTag = deliveryTagCounter.incrementAndGet(); channel.basicPublish(exchange, routingKey, null, message.getBytes()); unconfirmedMessages.put(deliveryTag, new UnconfirmedMessage( exchange, routingKey, message.getBytes(), System.currentTimeMillis() )); } System.out.println(\u0026#34;æ‰¹é‡æ¶ˆæ¯å·²å‘é€ï¼Œæ•°é‡: \u0026#34; + messages.size()); } catch (Exception e) { System.err.println(\u0026#34;æ‰¹é‡å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } å¼‚æ­¥çš„åŸç† å‘é€æ¶ˆæ¯æ—¶ï¼šæ¶ˆæ¯ç«‹å³æ”¾å…¥æœªç¡®è®¤ Map Broker åœ¨åå°å¼‚æ­¥è¿”å› Confirm å¸§ Channel å†…éƒ¨çš„ IO çº¿ç¨‹è§£æ Confirm å¸§ï¼Œæ‰¾åˆ° deliveryTag å¯¹åº”çš„æ¶ˆæ¯ï¼Œä» Map ç§»é™¤ï¼Œå¹¶è§¦å‘å›è°ƒ ä¸åŒæ­¥çš„å¯¹æ¯” ç‰¹æ€§ åŒæ­¥ Confirm å¼‚æ­¥ Confirm æ€§èƒ½ ä½ï¼ˆé˜»å¡ç­‰å¾…ï¼‰ é«˜ï¼ˆéé˜»å¡ï¼‰ ååé‡ ä½ é«˜ å®æ—¶æ€§ å®æ—¶çŸ¥é“ç»“æœ é€šè¿‡å›è°ƒå¼‚æ­¥å¤„ç† å¤æ‚åº¦ ç®€å• ç›¸å¯¹å¤æ‚ é€‚ç”¨åœºæ™¯ ä½å¹¶å‘ã€å¼ºä¸€è‡´ é«˜å¹¶å‘ã€é«˜åå Return æœºåˆ¶ èƒŒæ™¯ å³ä½¿æ¶ˆæ¯åˆ°è¾¾äº† Brokerï¼Œå¦‚æœ Exchange æ— æ³•å°†æ¶ˆæ¯è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šè¢«ä¸¢å¼ƒã€‚\nä¸ºé¿å…æ— å£°ä¸¢å¤±ï¼Œå¯ä»¥å¼€å¯ Return æœºåˆ¶ã€‚\nMandatory æ ‡å¿— 1 2 // mandatory å‚æ•°è¯´æ˜ channel.basicPublish(exchange, routingKey, mandatory, props, body); mandatory=falseï¼šè·¯ç”±å¤±è´¥æ—¶ï¼ŒBroker ä¸¢å¼ƒæ¶ˆæ¯ mandatory=trueï¼šè·¯ç”±å¤±è´¥æ—¶ï¼ŒBroker é€šè¿‡ Basic.Return è¿”å›æ¶ˆæ¯ç»™ç”Ÿäº§è€… ReturnCallback å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @Service public class ReturnCallbackProducer { @Autowired private ConnectionFactory connectionFactory; public void sendMessageWithReturnCallback(String exchange, String routingKey, String message) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); // æ³¨å†Œ Return ç›‘å¬å™¨ channel.addReturnListener((replyCode, replyText, exchangeName, routingKeyName, properties, body) -\u0026gt; { System.out.println(\u0026#34;æ¶ˆæ¯æ— æ³•è·¯ç”±ï¼Œè¢«é€€å›:\u0026#34;); System.out.println(\u0026#34; replyCode: \u0026#34; + replyCode); System.out.println(\u0026#34; replyText: \u0026#34; + replyText); System.out.println(\u0026#34; exchange: \u0026#34; + exchangeName); System.out.println(\u0026#34; routingKey: \u0026#34; + routingKeyName); System.out.println(\u0026#34; message: \u0026#34; + new String(body)); // å¤„ç†é€€å›çš„æ¶ˆæ¯ handleReturnedMessage(replyCode, replyText, exchangeName, routingKeyName, body); }); // å‘é€æ¶ˆæ¯ï¼Œè®¾ç½® mandatory=true channel.basicPublish(exchange, routingKey, true, null, message.getBytes()); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…è·¯ç”±ç»“æœ: \u0026#34; + message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } private void handleReturnedMessage(int replyCode, String replyText, String exchange, String routingKey, byte[] body) { // æ ¹æ®ä¸åŒçš„é”™è¯¯ç å¤„ç†é€€å›æ¶ˆæ¯ switch (replyCode) { case 312: // NO_ROUTE System.out.println(\u0026#34;æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é˜Ÿåˆ—ï¼Œæ¶ˆæ¯è¢«é€€å›\u0026#34;); // å¯ä»¥å®ç°é‡è¯•æˆ–è®°å½•æ—¥å¿— break; case 313: // NO_CONSUMERS System.out.println(\u0026#34;æ²¡æœ‰æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è¢«é€€å›\u0026#34;); break; default: System.out.println(\u0026#34;æœªçŸ¥é”™è¯¯ï¼Œæ¶ˆæ¯è¢«é€€å›: \u0026#34; + replyCode); } } } ä¸ Confirm çš„åŒºåˆ« æœºåˆ¶ ä½œç”¨ è§¦å‘æ—¶æœº Confirm ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¿›å…¥ Broker æ¶ˆæ¯åˆ°è¾¾ Broker å Return ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¢«è·¯ç”±åˆ°é˜Ÿåˆ— æ¶ˆæ¯æ— æ³•è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶ ç»„åˆä½¿ç”¨ å®Œæ•´è¦†ç›–ç”Ÿäº§è€…å¯é æ€§ ä¸¤è€…ç»“åˆï¼Œæ‰èƒ½å®Œæ•´è¦†ç›– publisher-confirm-type é…ç½® åœ¨ Spring AMQP ä¸­ï¼Œå¸¸è§é…ç½®æ˜¯ï¼š\n1 2 3 4 spring: rabbitmq: publisher-confirm-type: correlated publisher-returns: true ç±»å‹è¯´æ˜ ç±»å‹ è¯´æ˜ ä½¿ç”¨åœºæ™¯ none å…³é—­ confirm æ€§èƒ½ä¼˜å…ˆï¼Œå¯é æ€§è¦æ±‚ä¸é«˜ simple åŒæ­¥é˜»å¡ç­‰å¾…ç¡®è®¤ ä½å¹¶å‘ï¼Œå¼ºä¸€è‡´æ€§è¦æ±‚ correlated å¼‚æ­¥å›è°ƒç¡®è®¤ï¼ˆæ¨èï¼‰ é«˜å¹¶å‘ï¼Œé«˜ååé‡ Spring AMQP é…ç½®ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Configuration @EnableRabbit public class RabbitMQConfig { @Bean public CachingConnectionFactory connectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(\u0026#34;localhost\u0026#34;); factory.setPort(5672); factory.setUsername(\u0026#34;guest\u0026#34;); factory.setPassword(\u0026#34;guest\u0026#34;); factory.setVirtualHost(\u0026#34;/\u0026#34;); // å¼€å¯ç¡®è®¤æ¨¡å¼ factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } @Bean public RabbitTemplate rabbitTemplate(CachingConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); // è®¾ç½®ç¡®è®¤å›è°ƒ template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: \u0026#34; + correlationData); } else { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: \u0026#34; + cause); } }); // è®¾ç½®è¿”å›å›è°ƒ template.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -\u0026gt; { System.out.println(\u0026#34;æ¶ˆæ¯è¢«é€€å›:\u0026#34;); System.out.println(\u0026#34; replyCode: \u0026#34; + replyCode); System.out.println(\u0026#34; replyText: \u0026#34; + replyText); System.out.println(\u0026#34; exchange: \u0026#34; + exchange); System.out.println(\u0026#34; routingKey: \u0026#34; + routingKey); System.out.println(\u0026#34; message: \u0026#34; + new String(message.getBody())); }); return template; } } ä¸å¼‚æ­¥ Confirm çš„å…³ç³» correlated å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨ RabbitMQ çš„ å¼‚æ­¥ ConfirmListenerï¼›\nSpring å°è£…äº† ConfirmCallback æ¥å£ï¼ŒæŠŠ deliveryTag ä¸æ¶ˆæ¯å…³è”èµ·æ¥ï¼Œä¾¿äºå¼€å‘ã€‚\nç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ å®Œæ•´çš„å¯é æ€§é“¾è·¯é€šå¸¸éœ€è¦ï¼š\n1. Confirm + Return ç»„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Service public class ReliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; public void sendReliableMessage(String exchange, String routingKey, String message) { try { // è®¾ç½®æ¶ˆæ¯å±æ€§ MessageProperties properties = new MessageProperties(); properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); // æŒä¹…åŒ– properties.setMessageId(UUID.randomUUID().toString()); properties.setTimestamp(new Date()); Message messageObj = new Message(message.getBytes(), properties); // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(exchange, routingKey, messageObj); System.out.println(\u0026#34;å¯é æ¶ˆæ¯å·²å‘é€: \u0026#34; + message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€å¯é æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); // å®ç°é‡è¯•é€»è¾‘ retryMessage(exchange, routingKey, message); } } private void retryMessage(String exchange, String routingKey, String message) { // å®ç°é‡è¯•é€»è¾‘ System.out.println(\u0026#34;é‡è¯•å‘é€æ¶ˆæ¯: \u0026#34; + message); } } 2. å¹‚ç­‰æ€§ä¸æ¶ˆæ¯å»é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Service public class IdempotentMessageProducer { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RabbitTemplate rabbitTemplate; public void sendIdempotentMessage(String exchange, String routingKey, String message, String messageId) { try { // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ String key = \u0026#34;message:\u0026#34; + messageId; if (redisTemplate.hasKey(key)) { System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€: \u0026#34; + messageId); return; } // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(exchange, routingKey, message); // è®°å½•æ¶ˆæ¯IDï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ redisTemplate.opsForValue().set(key, \u0026#34;sent\u0026#34;, Duration.ofHours(24)); System.out.println(\u0026#34;å¹‚ç­‰æ¶ˆæ¯å·²å‘é€: \u0026#34; + messageId); } catch (Exception e) { System.err.println(\u0026#34;å‘é€å¹‚ç­‰æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } 3. æ¶ˆæ¯æŒä¹…åŒ–ä¸ç£ç›˜å†™å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class PersistentMessageConfig { @Bean public DirectExchange persistentExchange() { return new DirectExchange(\u0026#34;persistent.exchange\u0026#34;, true, false); } @Bean public Queue persistentQueue() { return QueueBuilder.durable(\u0026#34;persistent.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 60000) .build(); } @Bean public Binding persistentBinding() { return BindingBuilder .bind(persistentQueue()) .to(persistentExchange()) .with(\u0026#34;persistent.key\u0026#34;); } } 4. åº”ç”¨å±‚è¡¥å¿æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Service public class CompensatingMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private final Map\u0026lt;String, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Scheduled(fixedRate = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡ public void checkUnconfirmedMessages() { long currentTime = System.currentTimeMillis(); unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; { UnconfirmedMessage message = entry.getValue(); if (currentTime - message.getTimestamp() \u0026gt; 60000) { // 1åˆ†é’Ÿè¶…æ—¶ System.out.println(\u0026#34;æ¶ˆæ¯è¶…æ—¶æœªç¡®è®¤ï¼Œå‡†å¤‡é‡å‘: \u0026#34; + entry.getKey()); retryMessage(message); return true; } return false; }); } private void retryMessage(UnconfirmedMessage message) { try { rabbitTemplate.convertAndSend( message.getExchange(), message.getRoutingKey(), new String(message.getBody()) ); System.out.println(\u0026#34;æ¶ˆæ¯é‡å‘æˆåŠŸ: \u0026#34; + new String(message.getBody())); } catch (Exception e) { System.err.println(\u0026#34;æ¶ˆæ¯é‡å‘å¤±è´¥: \u0026#34; + e.getMessage()); } } } å®Œæ•´ä»£ç å®ç° é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 rabbitmq-reliability/ â”œâ”€â”€ src/main/java/com/reliability/ â”‚ â”œâ”€â”€ config/ â”‚ â”‚ â”œâ”€â”€ RabbitMQConfig.java â”‚ â”‚ â””â”€â”€ MessageConfig.java â”‚ â”œâ”€â”€ producer/ â”‚ â”‚ â”œâ”€â”€ ReliableMessageProducer.java â”‚ â”‚ â”œâ”€â”€ AsyncConfirmProducer.java â”‚ â”‚ â””â”€â”€ SyncConfirmProducer.java â”‚ â”œâ”€â”€ consumer/ â”‚ â”‚ â””â”€â”€ ReliableMessageConsumer.java â”‚ â”œâ”€â”€ entity/ â”‚ â”‚ â””â”€â”€ UnconfirmedMessage.java â”‚ â”œâ”€â”€ service/ â”‚ â”‚ â””â”€â”€ MessageReliabilityService.java â”‚ â””â”€â”€ util/ â”‚ â””â”€â”€ MessageUtils.java æ ¸å¿ƒé…ç½®ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 @Configuration @EnableRabbit @Slf4j public class RabbitMQConfig { @Bean public CachingConnectionFactory connectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(\u0026#34;localhost\u0026#34;); factory.setPort(5672); factory.setUsername(\u0026#34;guest\u0026#34;); factory.setPassword(\u0026#34;guest\u0026#34;); factory.setVirtualHost(\u0026#34;/\u0026#34;); // è¿æ¥æ± é…ç½® factory.setChannelCacheSize(50); factory.setChannelCheckoutTimeout(10000); // å¼€å¯ç¡®è®¤æ¨¡å¼ factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } @Bean public RabbitTemplate rabbitTemplate(CachingConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); // è®¾ç½®ç¡®è®¤å›è°ƒ template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { log.info(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: {}\u0026#34;, correlationData); } else { log.error(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: {}, cause: {}\u0026#34;, correlationData, cause); } }); // è®¾ç½®è¿”å›å›è°ƒ template.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -\u0026gt; { log.warn(\u0026#34;æ¶ˆæ¯è¢«é€€å›: replyCode={}, replyText={}, exchange={}, routingKey={}\u0026#34;, replyCode, replyText, exchange, routingKey); }); return template; } // äº¤æ¢æœºé…ç½® @Bean public DirectExchange reliableExchange() { return new DirectExchange(\u0026#34;reliable.exchange\u0026#34;, true, false); } @Bean public Queue reliableQueue() { return QueueBuilder.durable(\u0026#34;reliable.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 300000) // 5åˆ†é’ŸTTL .withArgument(\u0026#34;x-max-length\u0026#34;, 10000) // æœ€å¤§é•¿åº¦ .build(); } @Bean public Binding reliableBinding() { return BindingBuilder .bind(reliableQueue()) .to(reliableExchange()) .with(\u0026#34;reliable.key\u0026#34;); } } å¯é æ¶ˆæ¯ç”Ÿäº§è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 @Service @Slf4j public class ReliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private final Map\u0026lt;String, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * å‘é€å¯é æ¶ˆæ¯ */ public void sendReliableMessage(String message, String messageId) { try { // 1. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ï¼ˆå¹‚ç­‰æ€§ï¼‰ if (isMessageAlreadySent(messageId)) { log.warn(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€: {}\u0026#34;, messageId); return; } // 2. æ„å»ºæ¶ˆæ¯ MessageProperties properties = new MessageProperties(); properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); properties.setMessageId(messageId); properties.setTimestamp(new Date()); properties.setContentType(\u0026#34;application/json\u0026#34;); Message messageObj = new Message(message.getBytes(), properties); // 3. è®°å½•æœªç¡®è®¤æ¶ˆæ¯ UnconfirmedMessage unconfirmedMessage = new UnconfirmedMessage( \u0026#34;reliable.exchange\u0026#34;, \u0026#34;reliable.key\u0026#34;, message.getBytes(), System.currentTimeMillis() ); unconfirmedMessages.put(messageId, unconfirmedMessage); // 4. å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(\u0026#34;reliable.exchange\u0026#34;, \u0026#34;reliable.key\u0026#34;, messageObj); // 5. è®°å½•æ¶ˆæ¯IDåˆ°Redis recordMessageId(messageId); log.info(\u0026#34;å¯é æ¶ˆæ¯å·²å‘é€: {}\u0026#34;, messageId); } catch (Exception e) { log.error(\u0026#34;å‘é€å¯é æ¶ˆæ¯å¼‚å¸¸: {}\u0026#34;, e.getMessage(), e); // å®ç°é‡è¯•é€»è¾‘ retryMessage(message, messageId); } } /** * æ‰¹é‡å‘é€å¯é æ¶ˆæ¯ */ public void sendBatchReliableMessages(List\u0026lt;String\u0026gt; messages) { for (int i = 0; i \u0026lt; messages.size(); i++) { String messageId = \u0026#34;batch_\u0026#34; + System.currentTimeMillis() + \u0026#34;_\u0026#34; + i; sendReliableMessage(messages.get(i), messageId); } } /** * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ */ private boolean isMessageAlreadySent(String messageId) { String key = \u0026#34;message:\u0026#34; + messageId; return redisTemplate.hasKey(key); } /** * è®°å½•æ¶ˆæ¯ID */ private void recordMessageId(String messageId) { String key = \u0026#34;message:\u0026#34; + messageId; redisTemplate.opsForValue().set(key, \u0026#34;sent\u0026#34;, Duration.ofHours(24)); } /** * é‡è¯•æ¶ˆæ¯ */ private void retryMessage(String message, String messageId) { try { Thread.sleep(1000); // ç­‰å¾…1ç§’ sendReliableMessage(message, messageId + \u0026#34;_retry\u0026#34;); log.info(\u0026#34;æ¶ˆæ¯é‡è¯•æˆåŠŸ: {}\u0026#34;, messageId); } catch (Exception e) { log.error(\u0026#34;æ¶ˆæ¯é‡è¯•å¤±è´¥: {}\u0026#34;, e.getMessage(), e); } } /** * è·å–æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ */ public int getUnconfirmedCount() { return unconfirmedMessages.size(); } /** * æ¸…ç†å·²ç¡®è®¤æ¶ˆæ¯ */ public void removeConfirmedMessage(String messageId) { unconfirmedMessages.remove(messageId); } } æ¶ˆæ¯æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 @Component @Slf4j public class ReliableMessageConsumer { @Autowired private ReliableMessageProducer messageProducer; @RabbitListener(queues = \u0026#34;reliable.queue\u0026#34;) public void handleReliableMessage(Message message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { String messageId = message.getMessageProperties().getMessageId(); String messageBody = new String(message.getBody()); log.info(\u0026#34;æ”¶åˆ°å¯é æ¶ˆæ¯: messageId={}, body={}\u0026#34;, messageId, messageBody); // å¤„ç†ä¸šåŠ¡é€»è¾‘ processMessage(messageBody); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); // ä»ç”Ÿäº§è€…ä¸­ç§»é™¤å·²ç¡®è®¤æ¶ˆæ¯ messageProducer.removeConfirmedMessage(messageId); log.info(\u0026#34;æ¶ˆæ¯å¤„ç†å®Œæˆ: {}\u0026#34;, messageId); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ¶ˆæ¯å¼‚å¸¸: {}\u0026#34;, e.getMessage(), e); try { // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, false); } catch (IOException ioException) { log.error(\u0026#34;æ‹’ç»æ¶ˆæ¯å¼‚å¸¸: {}\u0026#34;, ioException.getMessage(), ioException); } } } /** * å¤„ç†ä¸šåŠ¡é€»è¾‘ */ private void processMessage(String messageBody) { // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† try { Thread.sleep(100); log.info(\u0026#34;ä¸šåŠ¡å¤„ç†å®Œæˆ: {}\u0026#34;, messageBody); } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;ä¸šåŠ¡å¤„ç†è¢«ä¸­æ–­: {}\u0026#34;, e.getMessage(), e); } } } æ¶ˆæ¯å¯é æ€§æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Service @Slf4j public class MessageReliabilityService { @Autowired private ReliableMessageProducer messageProducer; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * æ£€æŸ¥æœªç¡®è®¤æ¶ˆæ¯ */ @Scheduled(fixedRate = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡ public void checkUnconfirmedMessages() { int unconfirmedCount = messageProducer.getUnconfirmedCount(); if (unconfirmedCount \u0026gt; 0) { log.warn(\u0026#34;å½“å‰æœ‰ {} æ¡æœªç¡®è®¤æ¶ˆæ¯\u0026#34;, unconfirmedCount); } } /** * æ¸…ç†è¿‡æœŸçš„æ¶ˆæ¯è®°å½• */ @Scheduled(fixedRate = 3600000) // 1å°æ—¶æ¸…ç†ä¸€æ¬¡ public void cleanupExpiredMessages() { try { Set\u0026lt;String\u0026gt; keys = redisTemplate.keys(\u0026#34;message:*\u0026#34;); if (keys != null \u0026amp;\u0026amp; !keys.isEmpty()) { redisTemplate.delete(keys); log.info(\u0026#34;æ¸…ç†è¿‡æœŸæ¶ˆæ¯è®°å½•: {} æ¡\u0026#34;, keys.size()); } } catch (Exception e) { log.error(\u0026#34;æ¸…ç†è¿‡æœŸæ¶ˆæ¯è®°å½•å¼‚å¸¸: {}\u0026#34;, e.getMessage(), e); } } /** * è·å–æ¶ˆæ¯ç»Ÿè®¡ä¿¡æ¯ */ public Map\u0026lt;String, Object\u0026gt; getMessageStatistics() { Map\u0026lt;String, Object\u0026gt; stats = new HashMap\u0026lt;\u0026gt;(); stats.put(\u0026#34;unconfirmedCount\u0026#34;, messageProducer.getUnconfirmedCount()); stats.put(\u0026#34;timestamp\u0026#34;, System.currentTimeMillis()); return stats; } } æœ€ä½³å®è·µä¸æ€»ç»“ 1. æ€§èƒ½ä¼˜åŒ–å»ºè®® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // è¿æ¥æ± é…ç½®ä¼˜åŒ– @Configuration public class PerformanceConfig { @Bean public CachingConnectionFactory optimizedConnectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); // è¿æ¥æ± é…ç½® factory.setChannelCacheSize(100); // å¢åŠ é€šé“ç¼“å­˜ factory.setChannelCheckoutTimeout(5000); // å‡å°‘è¶…æ—¶æ—¶é—´ // ç¡®è®¤æ¨¡å¼é…ç½® factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } } 2. ç›‘æ§å’Œå‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Component @Slf4j public class MessageMonitor { @Autowired private ReliableMessageProducer messageProducer; private final AtomicLong successCount = new AtomicLong(0); private final AtomicLong failureCount = new AtomicLong(0); @EventListener public void handleMessageSuccess(MessageSuccessEvent event) { successCount.incrementAndGet(); log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ€»æ•°: {}\u0026#34;, successCount.get()); } @EventListener public void handleMessageFailure(MessageFailureEvent event) { failureCount.incrementAndGet(); log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ€»æ•°: {}\u0026#34;, failureCount.get()); } @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ public void logStatistics() { long success = successCount.get(); long failure = failureCount.get(); long total = success + failure; if (total \u0026gt; 0) { double successRate = (double) success / total * 100; log.info(\u0026#34;æ¶ˆæ¯å‘é€ç»Ÿè®¡ - æˆåŠŸ: {}, å¤±è´¥: {}, æˆåŠŸç‡: {:.2f}%\u0026#34;, success, failure, successRate); } } } 3. æ€»ç»“ Confirm æœºåˆ¶è§£å†³äº†\u0026quot;æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ Broker\u0026quot;çš„é—®é¢˜ åŒæ­¥æ¨¡å¼ï¼šç®€å•ä½†ä½æ•ˆï¼Œé€‚åˆä½å¹¶å‘åœºæ™¯ å¼‚æ­¥æ¨¡å¼ï¼šé«˜æ•ˆä¸”å¸¸ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ Return æœºåˆ¶è§£å†³äº†\u0026quot;æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—\u0026quot;çš„é—®é¢˜ ä¸ Confirm æœºåˆ¶ç»“åˆä½¿ç”¨ ç¡®ä¿æ¶ˆæ¯å®Œæ•´æŠ•é€’åˆ°ç›®æ ‡é˜Ÿåˆ— deliveryTag + multiple æ„æˆäº† Confirm çš„æ ¸å¿ƒé€»è¾‘ deliveryTagï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯† multipleï¼šæ‰¹é‡ç¡®è®¤æœºåˆ¶ æœªç¡®è®¤æ¶ˆæ¯Mapï¼šç®¡ç†å¾…ç¡®è®¤æ¶ˆæ¯ Spring AMQP çš„ publisher-confirm-type=correlated å°±æ˜¯å¼‚æ­¥ Confirm çš„å°è£… ç®€åŒ–äº†å¼‚æ­¥ç¡®è®¤çš„ä½¿ç”¨ æä¾›äº†ç»Ÿä¸€çš„å›è°ƒæ¥å£ ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼š Confirm + Return + æ¶ˆæ¯æŒä¹…åŒ– + åº”ç”¨å±‚è¡¥å¿ ç»„åˆä½¿ç”¨ Confirmæœºåˆ¶ï¼šç¡®ä¿æ¶ˆæ¯åˆ°è¾¾Broker Returnæœºåˆ¶ï¼šç¡®ä¿æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ— æ¶ˆæ¯æŒä¹…åŒ–ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤± åº”ç”¨å±‚è¡¥å¿ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µ å¹‚ç­‰æ€§ä¿è¯ï¼šé¿å…é‡å¤å¤„ç† é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œå®Œæ•´ä»£ç å®ç°ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹RabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚å’Œæ€§èƒ½è¦æ±‚æ¥é€‰æ‹©åˆé€‚çš„ç¡®è®¤æ¨¡å¼ï¼Œå¹¶é…åˆå…¶ä»–å¯é æ€§æœºåˆ¶æ¥æ„å»ºçœŸæ­£å¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†RabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†å’Œå®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿã€‚\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/rabbitmq-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90/","title":"RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ"}]