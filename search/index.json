[{"content":"Redisson å¯é‡å…¥é”åŸç†è¯¦è§£ 1. ä¸ºä»€ä¹ˆéœ€è¦å¯é‡å…¥é”ï¼Ÿ åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œé” æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„é‡è¦æ‰‹æ®µã€‚ä½†æœ‰æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶ï¼Œä¼šè°ƒç”¨å¦ä¸€ä¸ªä¹Ÿéœ€è¦åŒä¸€æŠŠé”çš„æ–¹æ³•ï¼Œè¿™æ—¶é—®é¢˜å°±æ¥äº†ï¼š\nå¦‚æœé” ä¸å¯é‡å…¥ï¼Œçº¿ç¨‹åœ¨ç¬¬äºŒæ¬¡å°è¯•åŠ é”æ—¶ä¼šå¤±è´¥ï¼Œå› ä¸ºé”å·²ç»å­˜åœ¨ï¼Œå®ƒç›¸å½“äº æŠŠè‡ªå·±å¡æ­»äº†ã€‚ å¦‚æœé” å¯é‡å…¥ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–è¿™æŠŠé”ï¼Œç›´åˆ°æœ€åé‡Šæ”¾æ—¶æ‰çœŸæ­£è§£é”ã€‚ æ‰€ä»¥ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºï¼šé¿å…åŒä¸€çº¿ç¨‹å› ä¸ºæ–¹æ³•åµŒå¥—è°ƒç”¨è€Œæ­»é”ã€‚\n2. æ™®é€šåˆ†å¸ƒå¼é”çš„é—®é¢˜ æœ€ç®€å•çš„åˆ†å¸ƒå¼é”é€šå¸¸ç”¨ Redis çš„ SETNX å®ç°ï¼š\n1 SET key value NX EX 30 NX è¡¨ç¤ºå¦‚æœ key ä¸å­˜åœ¨æ‰è®¾ç½®ï¼Œä¿è¯åŸå­æ€§ã€‚ EX 30 è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ã€‚ é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ å½“ä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰é”æ—¶ï¼Œå¦‚æœåœ¨æ–¹æ³•åµŒå¥—ä¸­å†æ¬¡å°è¯•è·å–é”ï¼š\nRedis å‘ç° key å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›å¤±è´¥ã€‚ è™½ç„¶æ˜¯ åŒä¸€ä¸ªçº¿ç¨‹ æƒ³å†æ¬¡è·å–é”ï¼Œä½†å› ä¸ºé”å®ç°é‡ŒåªåŒºåˆ† \u0026ldquo;æœ‰é” / æ— é”\u0026rdquo;ï¼Œå¹¶ä¸ä¼šè¯†åˆ«çº¿ç¨‹ã€‚ ç»“æœå°±æ˜¯ï¼šè‡ªå·±æŠŠè‡ªå·±é”æ­»äº†ã€‚ 3. Redisson çš„æ”¹è¿›ï¼ˆå¯é‡å…¥å®ç°ï¼‰ Redisson åœ¨ value çš„å­˜å‚¨ä¸Šåšäº†æ”¹è¿›ï¼Œå®ƒå¹¶ä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ª Hash ç»“æ„ï¼š\n1 2 3 lockKey -\u0026gt; { threadId : reentrantCount } threadIdï¼šå”¯ä¸€æ ‡è¯†æŸä¸ª JVM é‡Œçš„æŸä¸ªçº¿ç¨‹ï¼ˆä¸€èˆ¬æ˜¯ UUID:threadIdï¼‰ã€‚ reentrantCountï¼šè®°å½•è¿™ä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ¬¡æ•°ã€‚ è¿™æ ·å°±å¯ä»¥æ”¯æŒ å¯é‡å…¥ äº†ã€‚\n4. æ‰§è¡Œæµç¨‹ä¸¾ä¾‹ å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public void methodA() { lock.lock(); try { methodB(); } finally { lock.unlock(); } } public void methodB() { lock.lock(); try { // æ‰§è¡Œé€»è¾‘ } finally { lock.unlock(); } } 4.1 ç¬¬ä¸€æ¬¡åŠ é”ï¼ˆmethodAï¼‰ Redis é‡Œè¿˜æ²¡æœ‰ lockKeyã€‚ Redisson ä¼šå†™å…¥ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 1 } è¡¨ç¤ºçº¿ç¨‹ thread-1 ç¬¬ä¸€æ¬¡è·å–é”ï¼Œé‡å…¥æ¬¡æ•° = 1ã€‚ 4.2 ç¬¬äºŒæ¬¡åŠ é”ï¼ˆmethodBï¼‰ Redis å‘ç° lockKey å·²å­˜åœ¨ï¼Œä½† owner æ˜¯ åŒä¸€ä¸ªçº¿ç¨‹ã€‚ å…è®¸é‡å…¥ï¼Œè®¡æ•° +1ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 2 } 4.3 methodB æ‰§è¡Œå®Œé‡Šæ”¾é” è°ƒç”¨ unlock()ï¼Œè®¡æ•° -1ï¼š 1 lockKey -\u0026gt; { \u0026#34;UUID:thread-1\u0026#34; : 1 } é”ä»ç„¶ç”±å½“å‰çº¿ç¨‹æŒæœ‰ã€‚ 4.4 methodA æ‰§è¡Œå®Œé‡Šæ”¾é” å†æ¬¡è°ƒç”¨ unlock()ï¼Œè®¡æ•° -1 â†’ å˜æˆ 0ã€‚ Redisson åˆ é™¤ lockKeyï¼š 1 lockKey åˆ é™¤ æ­¤æ—¶é”æ‰çœŸæ­£é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šè·å–ã€‚ 5. é€šä¿—è§£é‡Š ç”¨é€šä¿—çš„è¯å†æè¿°ä¸€æ¬¡ï¼š\nå‡å¦‚ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å¤šä¸ªæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªæ–¹æ³•ç”¨äº†é”å»è°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œç¬¬äºŒä¸ªæ–¹æ³•å†æ¬¡è°ƒç”¨è¿™ä¸ªçº¿ç¨‹çš„é”å°±ä¼šå¤±è´¥ã€‚å› ä¸ºè™½ç„¶é”çš„ key ä¸€æ ·ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è·å–é”çš„æ—¶å€™ä¼šå‘ç°é”å·²ç»å­˜åœ¨äº†ï¼Œå°±è·å–å¤±è´¥ã€‚\nRedisson åœ¨è¿™ä¸ªåŸºç¡€ä¸Šåšäº†æ”¹è¿›ï¼šå®ƒåœ¨é”çš„ value é‡ŒåŠ ä¸Šäº†ä¸€ä¸ª é‡å…¥æ¬¡æ•°ï¼Œå¹¶åˆ©ç”¨ Redis Hash ç»“æ„æ¥å­˜å‚¨ã€‚\nHash ç»“æ„é‡Œæœ‰ä¸¤ä¸ªå€¼ï¼š\nfieldï¼šå½“å‰çº¿ç¨‹çš„æ ‡è¯†ï¼ˆUUID + threadIdï¼‰ valueï¼šé‡å…¥æ¬¡æ•° æ‰§è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\næ–¹æ³•ä¸€ç¬¬ä¸€æ¬¡è·å–é”ï¼šé‡å…¥æ¬¡æ•° +1ï¼Œå˜æˆ 1 æ–¹æ³•ä¸€è°ƒç”¨æ–¹æ³•äºŒï¼Œæ–¹æ³•äºŒåˆè¦ç”¨é”ï¼šé‡å…¥æ¬¡æ•°å† +1ï¼Œå˜æˆ 2 æ–¹æ³•äºŒæ‰§è¡Œå®Œé‡Šæ”¾é”ï¼šé‡å…¥æ¬¡æ•° -1ï¼Œå˜å› 1 æ–¹æ³•ä¸€æ‰§è¡Œå®Œé‡Šæ”¾é”ï¼šé‡å…¥æ¬¡æ•° -1ï¼Œå˜å› 0ï¼Œé”æ‰çœŸæ­£é‡Šæ”¾ è¿™æ ·å°±é¿å…äº†åŒä¸€ä¸ªçº¿ç¨‹å› ä¸ºåµŒå¥—è°ƒç”¨è€Œæ­»é”ã€‚\n6. æ ¸å¿ƒå®ç°åŸç† 6.1 åŠ é”æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 -- åŠ é”è„šæœ¬ if (redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) == 0) then redis.call(\u0026#39;hset\u0026#39;, KEYS[1], ARGV[2], 1); redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); return nil; end; if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[2]) == 1) then redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[2], 1); redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[1]); return nil; end; return redis.call(\u0026#39;pttl\u0026#39;, KEYS[1]); 6.2 é‡Šæ”¾é”æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 -- é‡Šæ”¾é”è„šæœ¬ if (redis.call(\u0026#39;hexists\u0026#39;, KEYS[1], ARGV[3]) == 0) then return nil; end; local counter = redis.call(\u0026#39;hincrby\u0026#39;, KEYS[1], ARGV[3], -1); if (counter \u0026gt; 0) then redis.call(\u0026#39;pexpire\u0026#39;, KEYS[1], ARGV[2]); return 0; else redis.call(\u0026#39;del\u0026#39;, KEYS[1]); redis.call(\u0026#39;publish\u0026#39;, KEYS[2], ARGV[1]); return 1; end; 7. å…³é”®ç‰¹æ€§ 7.1 çº¿ç¨‹å®‰å…¨ ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ é¿å…ç«æ€æ¡ä»¶ 7.2 è‡ªåŠ¨ç»­æœŸ é€šè¿‡ pexpire è‡ªåŠ¨ç»­æœŸ é˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ 7.3 å…¬å¹³æ€§ æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é” é€šè¿‡é˜Ÿåˆ—æœºåˆ¶ä¿è¯è·å–é”çš„é¡ºåº 7.4 å¯é‡å…¥æ€§ åŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å–é” é€šè¿‡é‡å…¥è®¡æ•°å™¨å®ç° 8. ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // è·å–å¯é‡å…¥é” RLock lock = redisson.getLock(\u0026#34;myLock\u0026#34;); try { // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…100ç§’ï¼Œä¸Šé”ä»¥å10ç§’è‡ªåŠ¨è§£é” boolean res = lock.tryLock(100, 10, TimeUnit.SECONDS); if (res) { try { // ä¸šåŠ¡é€»è¾‘ doSomething(); } finally { lock.unlock(); } } } catch (InterruptedException e) { e.printStackTrace(); } 9. æ€»ç»“å‡å æ™®é€šåˆ†å¸ƒå¼é”åªå…³å¿ƒ \u0026ldquo;æœ‰é” / æ— é”\u0026rdquo;ï¼Œä¸å…³å¿ƒæ˜¯è°åŠ çš„é”ï¼Œå¯¼è‡´ åŒä¸€çº¿ç¨‹é‡å…¥æ—¶ä¹Ÿä¼šå¤±è´¥ã€‚\nRedisson é€šè¿‡åœ¨ Redis çš„ Hash ç»“æ„ ä¸­è®°å½• \u0026ldquo;çº¿ç¨‹æ ‡è¯† + é‡å…¥è®¡æ•°\u0026rdquo;ï¼Œè®©é”å…·å¤‡äº† å¯é‡å…¥èƒ½åŠ›ã€‚\næ„ä¹‰ï¼šå¯é‡å…¥é”é¿å…äº†ä¸€ä¸ªçº¿ç¨‹åœ¨åµŒå¥—è°ƒç”¨ä¸­æŠŠè‡ªå·±å¡æ­»ï¼ŒåŒæ—¶å¯¹å¤–ä»ç„¶ä¿æŒåˆ†å¸ƒå¼é”çš„ç‰¹æ€§ã€‚\nä¸€å¥è¯æ€»ç»“ï¼š Redisson çš„å¯é‡å…¥é”ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç”¨ Redis Hash å­˜å‚¨çº¿ç¨‹ ID å’Œé‡å…¥æ¬¡æ•°ï¼Œç›´åˆ°é‡å…¥æ¬¡æ•°å½’é›¶æ‰çœŸæ­£é‡Šæ”¾é”ã€‚\n10. æ‰©å±•é˜…è¯» Redisson å®˜æ–¹æ–‡æ¡£ Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ Java å¹¶å‘ç¼–ç¨‹å®æˆ˜ æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† Redisson å¯é‡å…¥é”çš„å®ç°åŸç†ï¼Œå¸®åŠ©å¼€å‘è€…æ·±å…¥ç†è§£åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæœºåˆ¶ã€‚\n","date":"2025-09-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/redisson-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/","title":"Redisson å¯é‡å…¥é”åŸç†è¯¦è§£"},{"content":"æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨ åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå°¤å…¶æ˜¯ç§’æ€ç³»ç»Ÿï¼Œå¦‚ä½•ä¿è¯åº“å­˜æ‰£å‡çš„æ­£ç¡®æ€§å’Œç”¨æˆ·é™è´­çš„å‡†ç¡®æ€§ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„é—®é¢˜ã€‚\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹ï¼Œè¯¦ç»†è®²è§£ Redis + Lua è„šæœ¬ åœ¨ç§’æ€æ´»åŠ¨ä¸­çš„ä½¿ç”¨æ–¹å¼ã€‚\nä¸€ã€èƒŒæ™¯ä»‹ç» åœ¨ç§’æ€åœºæ™¯ä¸­ï¼Œå¦‚æœå•çº¯ä¾èµ–åç«¯æ•°æ®åº“è¿›è¡Œåº“å­˜æ‰£å‡ä¸ç”¨æˆ·æ ¡éªŒï¼Œå¾€å¾€ä¼šäº§ç”Ÿä»¥ä¸‹é—®é¢˜ï¼š\né«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼šå¤§é‡ç”¨æˆ·åŒæ—¶ä¸‹å•ï¼Œæ•°æ®åº“å®¹æ˜“è¢«æ‰“çˆ†ã€‚ è¶…å–é—®é¢˜ï¼šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°åº“å­˜è¢«æ‰£æˆè´Ÿæ•°çš„æƒ…å†µã€‚ é™è´­é€»è¾‘å¤±æ•ˆï¼šå¦‚æœå¹¶å‘æ§åˆ¶ä¸å¥½ï¼ŒåŒä¸€ç”¨æˆ·å¯èƒ½ç»•è¿‡é™è´­é™åˆ¶ã€‚ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬é€šå¸¸ä¼š å°†ç§’æ€çš„æ ¸å¿ƒé€»è¾‘æ”¾åˆ° Redis é‡Œï¼Œåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½ä¸ Lua è„šæœ¬çš„åŸå­æ€§ï¼Œæ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\näºŒã€Redis Key è®¾è®¡ åœ¨è¿™ä¸ªç§’æ€ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªæ´»åŠ¨è®¾è®¡äº†ä¸¤ä¸ªå…³é”®çš„ Redis Keyï¼š\n1. åº“å­˜ Key 1 seckill:stock:{activityId} ä½œç”¨ï¼šå­˜æ”¾æŸä¸ªæ´»åŠ¨çš„å‰©ä½™åº“å­˜æ•°é‡ã€‚\nç¤ºä¾‹ï¼š\n1 SET seckill:stock:1001 50 è¡¨ç¤ºæ´»åŠ¨ 1001 è¿˜æœ‰ 50 ä»¶å•†å“ã€‚\n2. å‚ä¸ç”¨æˆ· Key 1 seckill:participants:{activityId} ä½œç”¨ï¼šå­˜æ”¾æŸä¸ªæ´»åŠ¨æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€‚\nç¤ºä¾‹ï¼š\n1 2 HSET seckill:participants:1001 12345 1 HSET seckill:participants:1001 67890 2 è¡¨ç¤ºï¼š\nç”¨æˆ· 12345 å·²ç»è´­ä¹° 1 ä»¶ ç”¨æˆ· 67890 å·²ç»è´­ä¹° 2 ä»¶ ä¸‰ã€Java ä»£ç è°ƒç”¨ Lua è„šæœ¬ åœ¨åç«¯ä¸­ï¼Œè°ƒç”¨ Lua è„šæœ¬çš„æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 String stockKey = seckillPrefix + \u0026#34;stock:\u0026#34; + activityId; String participantsKey = seckillPrefix + \u0026#34;participants:\u0026#34; + activityId; DefaultRedisScript\u0026lt;List\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptSource(new ResourceScriptSource(new ClassPathResource(\u0026#34;seckill_participate.lua\u0026#34;))); script.setResultType(List.class); List\u0026lt;String\u0026gt; keys = Arrays.asList(stockKey, participantsKey); List\u0026lt;Object\u0026gt; args = Arrays.asList( userId.toString(), quantity.toString(), activity.getPerUserLimit().toString() ); List result = redisTemplate.execute(script, keys, args.toArray()); å‚æ•°ä¼ é€’è¯´æ˜ è¿™é‡Œéœ€è¦é‡ç‚¹ç†è§£çš„æœ‰ä¸¤éƒ¨åˆ†ï¼š\nkeys â†’ ä¼ é€’ç»™ Lua çš„ Redis Keyï¼Œè„šæœ¬é‡Œç”¨ KEYS[] è®¿é—®ï¼š\nKEYS[1] = \u0026quot;seckill:stock:1001\u0026quot; ï¼ˆè¿™ä¸ªæ´»åŠ¨çš„åº“å­˜ï¼‰ KEYS[2] = \u0026quot;seckill:participants:1001\u0026quot; ï¼ˆè®°å½•äº†è¿™ä¸ªæ´»åŠ¨æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è®°å½•ï¼‰ args â†’ é™„åŠ å‚æ•°ï¼Œè„šæœ¬é‡Œç”¨ ARGV[] è®¿é—®ï¼š\nARGV[1] = userId ï¼ˆå½“å‰ç”¨æˆ· IDï¼‰ ARGV[2] = quantity ï¼ˆæœ¬æ¬¡è´­ä¹°æ•°é‡ï¼‰ ARGV[3] = perUserLimit ï¼ˆæ¯äººé™è´­æ•°é‡ï¼‰ å››ã€Lua è„šæœ¬é€»è¾‘è¯¦è§£ Lua è„šæœ¬å…·æœ‰åŸå­æ€§ï¼Œåœ¨ Redis ä¸­æ‰§è¡Œæ—¶ä¸ä¼šè¢«æ‰“æ–­ï¼Œéå¸¸é€‚åˆç§’æ€åœºæ™¯ã€‚\nå…¸å‹çš„ seckill_participate.lua è„šæœ¬å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 -- è·å–å‚æ•° local stock = tonumber(redis.call(\u0026#34;GET\u0026#34;, KEYS[1])) local userId = ARGV[1] local quantity = tonumber(ARGV[2]) local perUserLimit = tonumber(ARGV[3]) -- æŸ¥è¯¢ç”¨æˆ·å·²è´­ä¹°æ•°é‡ local userBought = tonumber(redis.call(\u0026#34;HGET\u0026#34;, KEYS[2], userId) or \u0026#34;0\u0026#34;) -- 1. æ ¡éªŒæ˜¯å¦è¶…è¿‡ä¸ªäººé™è´­ if userBought + quantity \u0026gt; perUserLimit then return {0, \u0026#34;è¶…è¿‡ä¸ªäººé™è´­\u0026#34;} end -- 2. æ ¡éªŒåº“å­˜æ˜¯å¦è¶³å¤Ÿ if stock \u0026lt; quantity then return {0, \u0026#34;åº“å­˜ä¸è¶³\u0026#34;} end -- 3. æ‰£å‡åº“å­˜ redis.call(\u0026#34;DECRBY\u0026#34;, KEYS[1], quantity) -- 4. æ›´æ–°ç”¨æˆ·è´­ä¹°æ•°é‡ redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, quantity) -- 5. è¿”å›æˆåŠŸ return {1, \u0026#34;æˆåŠŸ\u0026#34;} è„šæœ¬æ‰§è¡Œæµç¨‹è¯¦è§£ è®©æˆ‘ä»¬é€æ­¥åˆ†æè¿™ä¸ªè„šæœ¬çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\n1. å‚æ•°æ¥æ”¶ 1 2 3 local userId = ARGV[1] -- æ¥æ”¶ç”¨æˆ·ID local quantity = tonumber(ARGV[2]) -- æ¥æ”¶è´­ä¹°æ•°é‡ local perUserLimit = tonumber(ARGV[3]) -- æ¥æ”¶é™è´­æ•°é‡ åç«¯é€šè¿‡ redisTemplate.execute(...) ä¼ å…¥è¿™äº› ARGV å‚æ•°ç»™ Lua è„šæœ¬ï¼Œè„šæœ¬æ¥æ”¶æ¯ä¸ªå‚æ•°ã€‚\n2. æŸ¥è¯¢ç”¨æˆ·è´­ä¹°è®°å½• 1 local userBought = tonumber(redis.call(\u0026#34;HGET\u0026#34;, KEYS[2], userId) or \u0026#34;0\u0026#34;) è¿™æ®µä»£ç çš„ä½œç”¨ï¼šæŸ¥è¯¢å½“å‰ userId çš„è´­ä¹°è®°å½•ã€‚\nåŸç†ï¼šå› ä¸ºä¼ å…¥äº† participantsKeyï¼ˆè¿™ä¸ªæ´»åŠ¨çš„ç”¨æˆ·è´­ä¹°è®°å½•ï¼‰å’Œ userIdï¼ˆè¿™ä¸ªç”¨æˆ·ï¼‰ï¼Œå°±å¯ä»¥æ ¹æ® userId åœ¨ participantsKey é‡Œé¢æŸ¥å‡ºå¯¹åº”çš„ç”¨æˆ·è´­ä¹°è®°å½•ã€‚\n3. é™è´­æ ¡éªŒ 1 2 3 if userBought + quantity \u0026gt; perUserLimit then return {0, \u0026#34;è¶…è¿‡ä¸ªäººé™è´­\u0026#34;} end åˆ¤æ–­é€»è¾‘ï¼šç”¨æˆ·ç›®å‰å·²è´­ä¹°æ•° + æ–°è´­ä¹°æ•° quantity æ˜¯å¦å¤§äºæœ€å¤§è´­ä¹°é‡ perUserLimitã€‚\nå¦‚æœæ˜¯ï¼Œè¿”å› {0, \u0026quot;è¶…è¿‡ä¸ªäººé™è´­\u0026quot;} å¦‚æœä¸æ˜¯ï¼Œç»§ç»­ä¸‹ä¸€æ­¥ 4. åº“å­˜æ ¡éªŒ 1 2 3 if stock \u0026lt; quantity then return {0, \u0026#34;åº“å­˜ä¸è¶³\u0026#34;} end æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿï¼Œåˆ™è¿”å› {0, \u0026quot;åº“å­˜ä¸è¶³\u0026quot;}ã€‚\n5. æ‰§è¡Œè´­ä¹°æ“ä½œ 1 2 3 4 5 -- æ‰£å‡åº“å­˜ redis.call(\u0026#34;DECRBY\u0026#34;, KEYS[1], quantity) -- è®°å½•ç”¨æˆ·è´­ä¹°æ•°é‡ redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, quantity) å¦‚æœåº“å­˜è¶³å¤Ÿï¼Œåˆ™ï¼š\næ‰£å‡åº“å­˜ï¼šDECRBY å‘½ä»¤å°†åº“å­˜å‡å°‘ quantity æ•°é‡ è®°å½•ç”¨æˆ·è´­ä¹°æ•°é‡ï¼šHINCRBY å‘½ä»¤å°†ç”¨æˆ·çš„è´­ä¹°è®°å½•å¢åŠ  quantity æ•°é‡ 6. è¿”å›æˆåŠŸ 1 return {1, \u0026#34;æˆåŠŸ\u0026#34;} æœ€åè¿”å› {1, \u0026quot;æˆåŠŸ\u0026quot;}ï¼Œè¡¨ç¤ºè´­ä¹°æˆåŠŸã€‚\näº”ã€æ‰§è¡Œæµç¨‹ç¤ºä¾‹ æˆ‘ä»¬ä»¥ç”¨æˆ· 12345 å‚ä¸æ´»åŠ¨ 1001 ä¸ºä¾‹ï¼Œå‡è®¾åˆå§‹åº“å­˜ä¸º 10ï¼Œé™è´­ä¸º 3ï¼š\nç¬¬ä¸€æ¬¡è´­ä¹°ï¼ˆä¹° 2 ä»¶ï¼‰ è¾“å…¥å‚æ•°ï¼š\nKEYS[1] = seckill:stock:1001 KEYS[2] = seckill:participants:1001 ARGV[1] = \u0026quot;12345\u0026quot; ARGV[2] = \u0026quot;2\u0026quot; ARGV[3] = \u0026quot;3\u0026quot; è„šæœ¬æ‰§è¡Œï¼š\nuserBought = 0ï¼ˆæ²¡ä¹°è¿‡ï¼‰ stock = 10ï¼Œè¶³å¤Ÿ æ‰£å‡åº“å­˜ï¼šDECRBY seckill:stock:1001 2 â†’ åº“å­˜å˜ 8 æ›´æ–°è´­ä¹°è®°å½•ï¼šHINCRBY seckill:participants:1001 12345 2 â†’ ç”¨æˆ·ä¹°äº† 2 ä»¶ è¿”å› {1, \u0026quot;æˆåŠŸ\u0026quot;} ç¬¬äºŒæ¬¡è´­ä¹°ï¼ˆå†ä¹° 2 ä»¶ï¼‰ è¾“å…¥å‚æ•°ï¼š\nARGV[1] = \u0026quot;12345\u0026quot; ARGV[2] = \u0026quot;2\u0026quot; ARGV[3] = \u0026quot;3\u0026quot; è„šæœ¬æ‰§è¡Œï¼š\nuserBought = 2ï¼ˆä¸Šæ¬¡ä¹°äº† 2 ä»¶ï¼‰ æœ¬æ¬¡è¦ä¹° 2 ä»¶ï¼Œæ€»æ•° = 4 \u0026gt; é™è´­ 3 è¿”å› {0, \u0026quot;è¶…è¿‡ä¸ªäººé™è´­\u0026quot;} å…­ã€æ ¸å¿ƒä¼˜åŠ¿ é€šè¿‡ Redis Key è®¾è®¡ + Lua è„šæœ¬åŸå­æ‰§è¡Œï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š\n1. é˜²æ­¢è¶…å– åº“å­˜æ‰£å‡å’Œç”¨æˆ·è´­ä¹°è®°å½•æ›´æ–°åœ¨åŒä¸€ä¸ªè„šæœ¬é‡Œå®Œæˆï¼Œä¿è¯äº†åŸå­æ€§ã€‚\n2. é™è´­æ§åˆ¶ åˆ©ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ç”¨æˆ·è´­ä¹°è®°å½•ï¼Œç»“åˆ Lua è„šæœ¬æ ¡éªŒï¼Œé¿å…äº†ç”¨æˆ·ç»•è¿‡é™è´­ã€‚\n3. é«˜å¹¶å‘æ€§èƒ½ é€»è¾‘å…¨éƒ¨åœ¨ Redis å†…éƒ¨æ‰§è¡Œï¼Œä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œæ€§èƒ½æé«˜ã€‚\n4. æ•°æ®ä¸€è‡´æ€§ Lua è„šæœ¬çš„åŸå­æ€§ä¿è¯äº†æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚\nä¸ƒã€å®é™…åº”ç”¨åœºæ™¯ è¿™ç§æ–¹å¼æ˜¯å¾ˆå¤šç”µå•†å¹³å°åœ¨ç§’æ€åœºæ™¯ä¸­çš„æ ‡å‡†åšæ³•ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œå¸¸è§çš„\u0026quot;æ•°æ®åº“å‰Šå³°\u0026quot;ä¸\u0026quot;Redis é™æµ\u0026quot;çš„ç»“åˆåº”ç”¨ã€‚\né€‚ç”¨åœºæ™¯ ç§’æ€æ´»åŠ¨ é™æ—¶æŠ¢è´­ é™é‡å•†å“é”€å”® ä¼˜æƒ åˆ¸å‘æ”¾ ç§¯åˆ†å…‘æ¢ æŠ€æœ¯ç‰¹ç‚¹ é«˜æ€§èƒ½ï¼šRedis å†…å­˜æ“ä½œï¼Œå“åº”é€Ÿåº¦å¿« åŸå­æ€§ï¼šLua è„šæœ¬ä¿è¯æ“ä½œåŸå­æ€§ å¯æ‰©å±•ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² å¯é æ€§ï¼šé¿å…è¶…å–å’Œé‡å¤è´­ä¹° å…«ã€å»¶ä¼¸æ€è€ƒ 1. é€€æ¬¾é€€è´§æ”¯æŒ å¦‚æœè¦æ”¯æŒé€€æ¬¾é€€è´§ï¼Œéœ€è¦åœ¨ Lua è„šæœ¬é‡Œå¢åŠ åº“å­˜å›æ»šé€»è¾‘ï¼š\n1 2 3 4 -- é€€æ¬¾æ—¶å›æ»šåº“å­˜ redis.call(\u0026#34;INCRBY\u0026#34;, KEYS[1], quantity) -- å‡å°‘ç”¨æˆ·è´­ä¹°è®°å½• redis.call(\u0026#34;HINCRBY\u0026#34;, KEYS[2], userId, -quantity) 2. åˆ†ç‰‡å­˜å‚¨ä¼˜åŒ– å¦‚æœæ´»åŠ¨å•†å“æ•°é‡éå¸¸å¤§ï¼Œå¯ä»¥è€ƒè™‘åˆ†ç‰‡å­˜å‚¨åº“å­˜ï¼Œè¿›ä¸€æ­¥æé«˜å¹¶å‘æ€§èƒ½ï¼š\n1 2 -- æ ¹æ®ç”¨æˆ·IDè¿›è¡Œåˆ†ç‰‡ local shardKey = \u0026#34;seckill:stock:\u0026#34; .. activityId .. \u0026#34;:\u0026#34; .. (userId % 10) 3. å¼‚æ­¥å¤„ç† åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿˜éœ€è¦é…åˆæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰å’Œå¼‚æ­¥ä¸‹å•ï¼Œä»¥ä¿è¯åç»­æ•°æ®åº“å†™å…¥çš„å¯é æ€§ã€‚ è¯¦æƒ…å¯å‰å¾€æ­¤å¤„äº†è§£https://yin123-ybh.github.io/p/å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æå«redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°/\n4. ç›‘æ§å’Œå‘Šè­¦ ç›‘æ§ Redis æ€§èƒ½æŒ‡æ ‡ è®¾ç½®åº“å­˜å‘Šè­¦é˜ˆå€¼ è®°å½•ç”¨æˆ·è´­ä¹°è¡Œä¸ºæ—¥å¿— ä¹ã€æ€»ç»“ Redis + Lua è„šæœ¬åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³äº†é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ ¸å¿ƒé—®é¢˜ï¼š\nåˆ©ç”¨ Redis çš„é«˜æ€§èƒ½ï¼šå°†æ ¸å¿ƒé€»è¾‘ä»æ•°æ®åº“è½¬ç§»åˆ°å†…å­˜ ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼šLua è„šæœ¬ç¡®ä¿æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ å®ç°ç²¾ç¡®çš„é™è´­æ§åˆ¶ï¼šé€šè¿‡å“ˆå¸Œè¡¨è®°å½•ç”¨æˆ·è´­ä¹°å†å² é¿å…è¶…å–é—®é¢˜ï¼šåº“å­˜æ‰£å‡å’Œç”¨æˆ·è®°å½•æ›´æ–°åœ¨åŒä¸€è„šæœ¬ä¸­å®Œæˆ è¿™ç§æ–¹æ¡ˆä¸ä»…é€‚ç”¨äºç§’æ€ç³»ç»Ÿï¼Œåœ¨éœ€è¦é«˜å¹¶å‘ã€å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä¸­éƒ½æœ‰å¹¿æ³›åº”ç”¨ä»·å€¼ã€‚\nä»¥ä¸Šå°±æ˜¯å…³äºç§’æ€ç³»ç»Ÿä¸­ Redis + Lua è„šæœ¬çš„å®Œæ•´åº”ç”¨è§£æã€‚é€šè¿‡æ·±å…¥ç†è§£è¿™äº›æ ¸å¿ƒæ¦‚å¿µï¼Œä½ å°±èƒ½åœ¨å®é™…é¡¹ç›®ä¸­çµæ´»è¿ç”¨è¿™äº›æŠ€æœ¯ï¼Œæ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯é çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\n","date":"2025-09-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-redis--lua-%E5%9C%A8%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/","title":"æ·±å…¥ç†è§£ Redis + Lua åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„åº”ç”¨"},{"content":"å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰ ç§’æ€ç³»ç»Ÿæ˜¯ç”µå•†é«˜å¹¶å‘åœºæ™¯çš„å…¸å‹åº”ç”¨ï¼ŒçŸ­æ—¶é—´å†…å¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­æœ‰é™å•†å“ï¼Œå¦‚ä½•ä¿è¯åº“å­˜ä¸è¶…å–ã€ç³»ç»Ÿé«˜å¯ç”¨ã€å“åº”å¿«é€Ÿï¼Œæ˜¯æŠ€æœ¯è®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ã€‚æœ¬æ–‡å°†ç»“åˆå¼‚æ­¥ç§’æ€æ€è·¯ã€Redisåº“å­˜é¢„æ‰£ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å‰åç«¯è§£è€¦ç­‰æŠ€æœ¯ç‚¹ï¼Œæ·±å…¥è®²è§£ç§’æ€ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼Œå¹¶ç”¨ç±»æ¯”å’Œæµç¨‹è§£æï¼Œå¸®åŠ©ä½ ç†è§£é«˜å¹¶å‘å¤„ç†èƒŒåçš„åŸç†ã€‚\n1ï¸âƒ£ ç§’æ€åœºæ™¯é—®é¢˜åˆ†æ ç§’æ€åœºæ™¯ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜å¹¶å‘ï¼šçŸ­æ—¶é—´å†…æˆåƒä¸Šä¸‡ç”¨æˆ·æŠ¢è´­åŒä¸€å•†å“ åº“å­˜æœ‰é™ï¼šå•†å“æ•°é‡æœ‰é™ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶ ç³»ç»Ÿå‹åŠ›å¤§ï¼šæ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ å¸¸è§é—®é¢˜ï¼š è¶…å–ï¼šåº“å­˜è¢«å¤šæ¬¡æ‰£å‡ï¼Œå–å‡ºè¶…è¿‡å®é™…æ•°é‡ æ•°æ®åº“å‹åŠ›å¤§ï¼šå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ï¼Œå®¹æ˜“å¯¼è‡´å®•æœº ç½‘ç»œå»¶è¿Ÿå’Œå“åº”æ…¢ï¼šç”¨æˆ·ä½“éªŒå·® å¹¶å‘äº‹åŠ¡å†²çªï¼šæ™®é€šé”æˆ–äº‹åŠ¡å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆé”™è¯¯å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // âŒ é”™è¯¯å®ç°ï¼šç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå®¹æ˜“è¶…å– @RestController public class SeckillController { @Autowired private ProductService productService; @Autowired private OrderService orderService; @PostMapping(\u0026#34;/seckill\u0026#34;) public Result seckill(@RequestParam Long productId, @RequestParam Long userId) { // 1. æŸ¥è¯¢åº“å­˜ Product product = productService.getById(productId); if (product.getStock() \u0026lt;= 0) { return Result.fail(\u0026#34;åº“å­˜ä¸è¶³\u0026#34;); } // 2. æ‰£å‡åº“å­˜ - è¿™é‡Œå¯èƒ½å‡ºç°è¶…å–ï¼ product.setStock(product.getStock() - 1); productService.updateById(product); // 3. åˆ›å»ºè®¢å• Order order = new Order(); order.setProductId(productId); order.setUserId(userId); orderService.save(order); return Result.success(\u0026#34;ç§’æ€æˆåŠŸ\u0026#34;); } } 2ï¸âƒ£ åŒæ­¥ vs å¼‚æ­¥ç§’æ€ ç§’æ€å¤„ç†å¯ä»¥åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š\næ–¹å¼ ç”¨æˆ·è¯·æ±‚ åç«¯å¤„ç† ä¼˜ç¼ºç‚¹ åŒæ­¥ ç”¨æˆ·è¯·æ±‚ç›´æ¥è°ƒç”¨æ•°æ®åº“ ç«‹å³å¤„ç†åº“å­˜å’Œè®¢å• é«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›å¤§ï¼Œå®¹æ˜“é˜»å¡ï¼Œè¶…å–é£é™©é«˜ å¼‚æ­¥ ç”¨æˆ·è¯·æ±‚å…ˆè¿›å…¥é˜Ÿåˆ—æˆ–ç¼“å­˜ åå°å¼‚æ­¥æ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¾æ¬¡å¤„ç†åº“å­˜å’Œè®¢å• å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œå‰Šå³°å¡«è°·ï¼Œé˜²æ­¢è¶…å– æ ¸å¿ƒåŒºåˆ«ï¼š åŒæ­¥æ¨¡å¼ï¼šå‰ç«¯ç­‰å¾…åç«¯å®Œæˆæ‰€æœ‰æ“ä½œ å¼‚æ­¥æ¨¡å¼ï¼šå‰ç«¯è¯·æ±‚å…ˆæ’é˜Ÿï¼Œåå°æ…¢æ…¢å¤„ç†ä¸šåŠ¡ï¼Œè¯·æ±‚å¤„ç†ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦ 3ï¸âƒ£ å¼‚æ­¥ç§’æ€æ ¸å¿ƒæ€è·¯ å¼‚æ­¥ç§’æ€é€šè¿‡ä»¥ä¸‹æµç¨‹å®ç°é«˜å¹¶å‘å¤„ç†ï¼š\næ­¥éª¤ 1ï¼šæ¥æ”¶è¯·æ±‚ï¼ˆæ¥å£å±‚ï¼‰ ç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®ï¼Œå‰ç«¯è¯·æ±‚ç§’æ€æ¥å£ã€‚\næ¥å£å±‚å¿«é€Ÿåˆ¤æ–­ï¼š\nå•†å“æ˜¯å¦è¿˜æœ‰åº“å­˜ ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å• åˆ¤æ–­é€šè¿‡ï¼š\nä½¿ç”¨ Redis + Lua è„šæœ¬è¿›è¡Œåº“å­˜é¢„æ‰£ï¼ˆåŸå­æ“ä½œï¼‰ ç”Ÿæˆè®¢å• ID æˆ–è¯·æ±‚ ID å°†è¯·æ±‚å°è£…æˆæ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQã€Kafkaã€Redis Stream ç­‰ï¼‰ æ¥å£ç«‹å³è¿”å›ç»™å‰ç«¯ï¼š\n\u0026ldquo;æ’é˜ŸæˆåŠŸ\u0026quot;æˆ–\u0026quot;è¯·æ±‚å·²æ¥æ”¶\u0026rdquo; âš¡ æ³¨æ„ï¼šå‰ç«¯ç”¨æˆ·æ­¤æ—¶å¹¶æœªç›´æ¥æ‹¿åˆ°æœ€ç»ˆè®¢å•ï¼Œåªæ˜¯æ‹¿åˆ°ä¸€ä¸ª\u0026quot;æŠ¢è´­å‡­è¯\u0026quot;ã€‚\næ­¥éª¤ 2ï¼šå¼‚æ­¥å¤„ç†è¯·æ±‚ï¼ˆåå°æœåŠ¡ï¼‰ æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ï¼š\næ‰£æ•°æ®åº“åº“å­˜ åˆ›å»ºè®¢å•è®°å½• æ ‡è®°ç”¨æˆ·å·²ä¸‹å• å¤„ç†å®Œæˆåé€šçŸ¥ç”¨æˆ·ï¼š\nç§’æ€æˆåŠŸï¼ˆè®¢å•ç”ŸæˆæˆåŠŸï¼‰ ç§’æ€å¤±è´¥ï¼ˆåº“å­˜ä¸è¶³ï¼‰ æ­¥éª¤ 3ï¼šåº“å­˜æ§åˆ¶ Redisåº“å­˜é¢„å‡ï¼š\nç§’æ€å‰ï¼Œå°†å•†å“åº“å­˜åŠ è½½åˆ° Redis ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œç”¨ Redis åŸå­æ“ä½œ DECR æ‰£å‡åº“å­˜ æ‰£å‡æˆåŠŸ â†’ æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ— æ‰£å‡å¤±è´¥ â†’ ç§’æ€ç»“æŸï¼Œè¿”å›å¤±è´¥ å¯ä½¿ç”¨ Lua è„šæœ¬å°† åˆ¤æ–­åº“å­˜ \u0026gt; 0 + æ‰£å‡åº“å­˜ åšæˆåŸå­æ“ä½œï¼Œé¿å…è¶…å–\næ­¥éª¤ 4ï¼šç”¨æˆ·é€šçŸ¥ ç§’æ€ç»“æœå¼‚æ­¥è¿”å›ï¼š\nè½®è¯¢æ¥å£ WebSocket æ¶ˆæ¯æ¨é€ å‰ç«¯ç”¨æˆ·æ‹¿åˆ°æœ€ç»ˆç»“æœåï¼Œç¡®è®¤æ˜¯å¦æŠ¢è´­æˆåŠŸ\n4ï¸âƒ£ æ¥å£å±‚å¿«é€Ÿåˆ¤æ–­åº“å­˜ä¸ç”¨æˆ·èµ„æ ¼ æ¥å£å±‚ä¸ºä»€ä¹ˆå¯ä»¥å¿«é€Ÿåˆ¤æ–­åº“å­˜å’Œç”¨æˆ·æ˜¯å¦ç¬¦åˆä¸‹å•è¦æ±‚ï¼Ÿæ ¸å¿ƒæ˜¯æå‰æŠŠå…³é”®æ•°æ®ç¼“å­˜åœ¨ Redisï¼š\n4.1 åº“å­˜åˆ¤æ–­ ç§’æ€å¼€å§‹å‰ï¼Œå°†å•†å“åº“å­˜åŠ è½½åˆ° Redisï¼š\n1 2 Key: \u0026#34;stock:å•†å“ID\u0026#34; Value: å‰©ä½™åº“å­˜æ•°é‡ è¯·æ±‚åˆ°æ¥æ—¶ï¼š\n1 DECR stock:å•†å“ID // åŸå­æ“ä½œ è¿”å›å€¼åˆ¤æ–­ï¼š\nâ‰¥0 â†’ åº“å­˜è¿˜æœ‰ï¼Œå…è®¸ä¸‹å• \u0026lt;0 â†’ åº“å­˜ä¸è¶³ï¼Œç§’æ€ç»“æŸ Lua è„šæœ¬å¯å°†\u0026quot;åˆ¤æ–­åº“å­˜ + æ‰£å‡åº“å­˜\u0026quot;åŸå­åŒ–å¤„ç†ï¼Œé¿å…è¶…å–\n4.2 ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• æ¯ä½ç”¨æˆ·åªèƒ½ä¸‹å•ä¸€æ¬¡ï¼š\n1 2 Key: \u0026#34;order:ç”¨æˆ·ID:å•†å“ID\u0026#34; Value: 1 // å·²ä¸‹å• æ¥å£å±‚åˆ¤æ–­ï¼š\n1 2 EXISTS order:ç”¨æˆ·ID:å•†å“ID â†’ å·²ä¸‹å•ï¼Œæ‹’ç» ä¸å­˜åœ¨ â†’ å…è®¸åŠ å…¥é˜Ÿåˆ— âœ… é€šè¿‡ Redis åˆ¤æ–­åº“å­˜ä¸ç”¨æˆ·çŠ¶æ€ï¼Œå®ç°ç§’æ€æ¥å£å¿«é€Ÿå“åº”ï¼Œé¿å…é«˜å¹¶å‘ç›´æ¥æ‰“æ•°æ®åº“ã€‚\n4.3 æ¥å£å±‚å®Œæ•´æµç¨‹ ç”¨æˆ·å‘èµ·è¯·æ±‚ æ¥å£å±‚åˆ¤æ–­åº“å­˜ + ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• åˆ¤æ–­é€šè¿‡ï¼š Redisé¢„æ‰£åº“å­˜ï¼ˆLuaè„šæœ¬ï¼‰ ç”Ÿæˆè®¢å•ID æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ— è¿”å›\u0026quot;æ’é˜ŸæˆåŠŸ\u0026quot;ï¼Œå‰ç«¯æ— éœ€ç­‰å¾…æ•°æ®åº“æ“ä½œ 5ï¸âƒ£ å¼‚æ­¥çš„æ€§èƒ½ä¼˜åŠ¿ å¼‚æ­¥æ¨¡å¼æ¯”åŒæ­¥æ¨¡å¼æ€§èƒ½æ›´å¥½ï¼ŒåŸå› åœ¨äºè§£è€¦è¯·æ±‚å¤„ç†å’Œæ•°æ®åº“æ“ä½œï¼Œé¿å…é˜»å¡ï¼š\nè¯·æ±‚å¤„ç†å¿«ï¼šçº¿ç¨‹åªåšè½»é‡åˆ¤æ–­ + Redis + æ¶ˆæ¯å…¥é˜Ÿ â†’ ç«‹å³é‡Šæ”¾ æµé‡å‰Šå³°å¡«è°·ï¼šé˜Ÿåˆ—ç¼“å†²é«˜å³°è¯·æ±‚ï¼Œæ•°æ®åº“å¹³æ»‘æ¶ˆè´¹ é¿å…è¶…å–ï¼šRedisåŸå­æ‰£å‡ + é˜Ÿåˆ—é¡ºåºæ¶ˆè´¹ ç³»ç»Ÿååé‡é«˜ï¼šWebå±‚å¿«é€Ÿå“åº” + åç«¯å¤šçº¿ç¨‹æˆ–åˆ†å¸ƒå¼å¤„ç† ç±»æ¯”è¯´æ˜ åŒæ­¥ï¼šå‰ç«¯ç›´æ¥ç­‰èœåšå¥½ â†’ é«˜å³°æœŸæ’é•¿é˜Ÿï¼Œå¨æˆ¿å¿™ä¸è¿‡æ¥ å¼‚æ­¥ï¼šå‰ç«¯å…ˆæ‹¿åˆ°å–é¤å· â†’ å¨æˆ¿æŒ‰é¡ºåºåšèœ â†’ ç³»ç»Ÿç¨³å®šï¼Œç”¨æˆ·ä½“éªŒå¥½ 6ï¸âƒ£ æ ¸å¿ƒæŠ€æœ¯å®ç°è¦ç‚¹ æŠ€æœ¯ç¯èŠ‚ å®ç°å…³é”® æ¥å…¥å±‚ é™æµï¼ˆNginx/ç½‘å…³ï¼‰é˜²æ­¢è¯·æ±‚æš´æ¶¨ åº“å­˜åˆ¤æ–­ RedisåŸå­æ“ä½œ DECR + Luaè„šæœ¬ è¯·æ±‚æ’é˜Ÿ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼ˆRabbitMQ/Kafka/Redis Streamï¼‰ è®¢å•å¤„ç† æ¶ˆè´¹ç«¯äº‹åŠ¡å†™æ•°æ®åº“ å»é‡ ç”¨æˆ·ä¸‹å•å‰æ£€æŸ¥æ˜¯å¦å·²ä¸‹å• å‰Šå³°å¡«è°· æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯å¹³æ»‘æ¶ˆè´¹ å¹‚ç­‰æ€§ æ¶ˆè´¹ç«¯ä¿è¯é‡å¤æ¶ˆè´¹ä¸ä¼šäº§ç”Ÿé‡å¤è®¢å• 7ï¸âƒ£ å®Œæ•´ä»£ç å®ç° 7.1 é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 seckill-system/ â”œâ”€â”€ src/main/java/com/seckill/ â”‚ â”œâ”€â”€ controller/ â”‚ â”‚ â””â”€â”€ SeckillController.java â”‚ â”œâ”€â”€ service/ â”‚ â”‚ â”œâ”€â”€ SeckillService.java â”‚ â”‚ â”œâ”€â”€ OrderService.java â”‚ â”‚ â””â”€â”€ ProductService.java â”‚ â”œâ”€â”€ config/ â”‚ â”‚ â”œâ”€â”€ RedisConfig.java â”‚ â”‚ â””â”€â”€ RabbitMQConfig.java â”‚ â”œâ”€â”€ entity/ â”‚ â”‚ â”œâ”€â”€ SeckillOrder.java â”‚ â”‚ â””â”€â”€ SeckillProduct.java â”‚ â”œâ”€â”€ dto/ â”‚ â”‚ â””â”€â”€ SeckillMessage.java â”‚ â”œâ”€â”€ consumer/ â”‚ â”‚ â””â”€â”€ SeckillConsumer.java â”‚ â””â”€â”€ util/ â”‚ â””â”€â”€ RedisLuaScript.java 7.2 å®ä½“ç±»å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // ç§’æ€å•†å“å®ä½“ @Data @Entity @Table(name = \u0026#34;seckill_product\u0026#34;) public class SeckillProduct { @Id private Long id; private String name; private BigDecimal price; private Integer stock; private LocalDateTime startTime; private LocalDateTime endTime; private Integer status; // 0-æœªå¼€å§‹ 1-è¿›è¡Œä¸­ 2-å·²ç»“æŸ } // ç§’æ€è®¢å•å®ä½“ @Data @Entity @Table(name = \u0026#34;seckill_order\u0026#34;) public class SeckillOrder { @Id private String id; private Long userId; private Long productId; private BigDecimal price; private Integer status; // 0-å¾…æ”¯ä»˜ 1-å·²æ”¯ä»˜ 2-å·²å–æ¶ˆ private LocalDateTime createTime; private LocalDateTime payTime; } 7.3 Redisé…ç½®å’ŒLuaè„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @Configuration public class RedisConfig { @Bean public RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate(RedisConnectionFactory factory) { RedisTemplate\u0026lt;String, Object\u0026gt; template = new RedisTemplate\u0026lt;\u0026gt;(); template.setConnectionFactory(factory); // è®¾ç½®åºåˆ—åŒ– Jackson2JsonRedisSerializer\u0026lt;Object\u0026gt; serializer = new Jackson2JsonRedisSerializer\u0026lt;\u0026gt;(Object.class); ObjectMapper mapper = new ObjectMapper(); mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); mapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL); serializer.setObjectMapper(mapper); template.setValueSerializer(serializer); template.setKeySerializer(new StringRedisSerializer()); template.setHashKeySerializer(new StringRedisSerializer()); template.setHashValueSerializer(serializer); template.afterPropertiesSet(); return template; } } // Luaè„šæœ¬å·¥å…·ç±» @Component public class RedisLuaScript { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; // åº“å­˜é¢„æ‰£Luaè„šæœ¬ private static final String STOCK_DECR_SCRIPT = \u0026#34;local stock = redis.call(\u0026#39;get\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if stock == false or tonumber(stock) \u0026lt;= 0 then \u0026#34; + \u0026#34; return -1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;local newStock = redis.call(\u0026#39;decr\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if newStock \u0026lt; 0 then \u0026#34; + \u0026#34; redis.call(\u0026#39;incr\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34; return -1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;return newStock\u0026#34;; // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• private static final String CHECK_USER_ORDER_SCRIPT = \u0026#34;local exists = redis.call(\u0026#39;exists\u0026#39;, KEYS[1]) \u0026#34; + \u0026#34;if exists == 1 then \u0026#34; + \u0026#34; return 1 \u0026#34; + \u0026#34;end \u0026#34; + \u0026#34;redis.call(\u0026#39;setex\u0026#39;, KEYS[1], ARGV[1], \u0026#39;1\u0026#39;) \u0026#34; + \u0026#34;return 0\u0026#34;; /** * åŸå­æ€§æ‰£å‡åº“å­˜ */ public Long decrStock(String stockKey) { DefaultRedisScript\u0026lt;Long\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptText(STOCK_DECR_SCRIPT); script.setResultType(Long.class); return redisTemplate.execute(script, Collections.singletonList(stockKey)); } /** * æ£€æŸ¥å¹¶æ ‡è®°ç”¨æˆ·å·²ä¸‹å• */ public Boolean checkAndSetUserOrder(String userOrderKey, int expireSeconds) { DefaultRedisScript\u0026lt;Long\u0026gt; script = new DefaultRedisScript\u0026lt;\u0026gt;(); script.setScriptText(CHECK_USER_ORDER_SCRIPT); script.setResultType(Long.class); Long result = redisTemplate.execute(script, Collections.singletonList(userOrderKey), String.valueOf(expireSeconds)); return result != null \u0026amp;\u0026amp; result == 0; // 0è¡¨ç¤ºæˆåŠŸè®¾ç½®ï¼Œ1è¡¨ç¤ºå·²å­˜åœ¨ } } 7.4 æ¶ˆæ¯é˜Ÿåˆ—é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 @Configuration public class RabbitMQConfig { // ç§’æ€æ¶ˆæ¯é˜Ÿåˆ— public static final String SECKILL_QUEUE = \u0026#34;seckill.queue\u0026#34;; public static final String SECKILL_EXCHANGE = \u0026#34;seckill.exchange\u0026#34;; public static final String SECKILL_ROUTING_KEY = \u0026#34;seckill.message\u0026#34;; @Bean public Queue seckillQueue() { return QueueBuilder.durable(SECKILL_QUEUE).build(); } @Bean public DirectExchange seckillExchange() { return new DirectExchange(SECKILL_EXCHANGE); } @Bean public Binding seckillBinding() { return BindingBuilder .bind(seckillQueue()) .to(seckillExchange()) .with(SECKILL_ROUTING_KEY); } @Bean public MessageConverter messageConverter() { return new Jackson2JsonMessageConverter(); } } // ç§’æ€æ¶ˆæ¯DTO @Data @AllArgsConstructor @NoArgsConstructor public class SeckillMessage { private Long userId; private Long productId; private String orderId; private LocalDateTime createTime; } 7.5 ç§’æ€æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @RestController @RequestMapping(\u0026#34;/seckill\u0026#34;) @Slf4j public class SeckillController { @Autowired private SeckillService seckillService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * ç§’æ€æ¥å£ */ @PostMapping(\u0026#34;/{productId}\u0026#34;) public Result\u0026lt;String\u0026gt; seckill(@PathVariable Long productId, @RequestParam Long userId) { try { // 1. å‚æ•°æ ¡éªŒ if (productId == null || userId == null) { return Result.fail(\u0026#34;å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34;); } // 2. æ£€æŸ¥ç§’æ€æ´»åŠ¨çŠ¶æ€ if (!seckillService.isSeckillActive(productId)) { return Result.fail(\u0026#34;ç§’æ€æ´»åŠ¨æœªå¼€å§‹æˆ–å·²ç»“æŸ\u0026#34;); } // 3. æ‰§è¡Œç§’æ€ String orderId = seckillService.executeSeckill(productId, userId); if (orderId != null) { return Result.success(\u0026#34;æ’é˜ŸæˆåŠŸï¼Œè®¢å•å·ï¼š\u0026#34; + orderId); } else { return Result.fail(\u0026#34;ç§’æ€å¤±è´¥ï¼Œè¯·é‡è¯•\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;ç§’æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId, e); return Result.fail(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } } /** * æŸ¥è¯¢ç§’æ€ç»“æœ */ @GetMapping(\u0026#34;/result/{orderId}\u0026#34;) public Result\u0026lt;SeckillOrder\u0026gt; getSeckillResult(@PathVariable String orderId) { try { SeckillOrder order = seckillService.getSeckillOrder(orderId); if (order != null) { return Result.success(order); } else { return Result.fail(\u0026#34;è®¢å•ä¸å­˜åœ¨æˆ–å¤„ç†ä¸­\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;æŸ¥è¯¢ç§’æ€ç»“æœå¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return Result.fail(\u0026#34;æŸ¥è¯¢å¤±è´¥\u0026#34;); } } /** * è·å–å•†å“åº“å­˜ */ @GetMapping(\u0026#34;/stock/{productId}\u0026#34;) public Result\u0026lt;Integer\u0026gt; getStock(@PathVariable Long productId) { try { String stockKey = \u0026#34;stock:\u0026#34; + productId; Object stock = redisTemplate.opsForValue().get(stockKey); if (stock != null) { return Result.success(Integer.valueOf(stock.toString())); } else { return Result.success(0); } } catch (Exception e) { log.error(\u0026#34;è·å–åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return Result.fail(\u0026#34;è·å–åº“å­˜å¤±è´¥\u0026#34;); } } } 7.6 ç§’æ€æœåŠ¡å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 @Service @Slf4j public class SeckillService { @Autowired private ProductService productService; @Autowired private OrderService orderService; @Autowired private RedisLuaScript redisLuaScript; @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String STOCK_PREFIX = \u0026#34;stock:\u0026#34;; private static final String USER_ORDER_PREFIX = \u0026#34;user_order:\u0026#34;; private static final int USER_ORDER_EXPIRE = 3600; // 1å°æ—¶ /** * æ£€æŸ¥ç§’æ€æ´»åŠ¨æ˜¯å¦è¿›è¡Œä¸­ */ public boolean isSeckillActive(Long productId) { try { SeckillProduct product = productService.getById(productId); if (product == null) { return false; } LocalDateTime now = LocalDateTime.now(); return product.getStatus() == 1 \u0026amp;\u0026amp; now.isAfter(product.getStartTime()) \u0026amp;\u0026amp; now.isBefore(product.getEndTime()); } catch (Exception e) { log.error(\u0026#34;æ£€æŸ¥ç§’æ€æ´»åŠ¨çŠ¶æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return false; } } /** * æ‰§è¡Œç§’æ€ */ public String executeSeckill(Long productId, Long userId) { try { // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ä¸‹å• String userOrderKey = USER_ORDER_PREFIX + userId + \u0026#34;:\u0026#34; + productId; if (!redisLuaScript.checkAndSetUserOrder(userOrderKey, USER_ORDER_EXPIRE)) { log.warn(\u0026#34;ç”¨æˆ·å·²ä¸‹å•ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, userId, productId); return null; } // 2. åŸå­æ€§æ‰£å‡åº“å­˜ String stockKey = STOCK_PREFIX + productId; Long remainingStock = redisLuaScript.decrStock(stockKey); if (remainingStock == null || remainingStock \u0026lt; 0) { log.warn(\u0026#34;åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId); return null; } // 3. ç”Ÿæˆè®¢å•ID String orderId = generateOrderId(); // 4. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ— SeckillMessage message = new SeckillMessage(); message.setUserId(userId); message.setProductId(productId); message.setOrderId(orderId); message.setCreateTime(LocalDateTime.now()); rabbitTemplate.convertAndSend( RabbitMQConfig.SECKILL_EXCHANGE, RabbitMQConfig.SECKILL_ROUTING_KEY, message ); log.info(\u0026#34;ç§’æ€è¯·æ±‚å·²å…¥é˜Ÿï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, orderId, userId, productId); return orderId; } catch (Exception e) { log.error(\u0026#34;æ‰§è¡Œç§’æ€å¼‚å¸¸ï¼Œå•†å“IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}\u0026#34;, productId, userId, e); return null; } } /** * è·å–ç§’æ€è®¢å• */ public SeckillOrder getSeckillOrder(String orderId) { try { return orderService.getByOrderId(orderId); } catch (Exception e) { log.error(\u0026#34;è·å–ç§’æ€è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return null; } } /** * é¢„çƒ­å•†å“åº“å­˜åˆ°Redis */ public void warmUpStock(Long productId) { try { SeckillProduct product = productService.getById(productId); if (product != null \u0026amp;\u0026amp; product.getStock() \u0026gt; 0) { String stockKey = STOCK_PREFIX + productId; redisTemplate.opsForValue().set(stockKey, product.getStock()); log.info(\u0026#34;å•†å“åº“å­˜é¢„çƒ­æˆåŠŸï¼Œå•†å“IDï¼š{}ï¼Œåº“å­˜ï¼š{}\u0026#34;, productId, product.getStock()); } } catch (Exception e) { log.error(\u0026#34;é¢„çƒ­å•†å“åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); } } /** * ç”Ÿæˆè®¢å•ID */ private String generateOrderId() { return \u0026#34;SK\u0026#34; + System.currentTimeMillis() + ThreadLocalRandom.current().nextInt(1000, 9999); } } 7.7 æ¶ˆæ¯æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component @Slf4j public class SeckillConsumer { @Autowired private OrderService orderService; @Autowired private ProductService productService; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * æ¶ˆè´¹ç§’æ€æ¶ˆæ¯ */ @RabbitListener(queues = RabbitMQConfig.SECKILL_QUEUE) public void handleSeckillMessage(SeckillMessage message) { log.info(\u0026#34;å¼€å§‹å¤„ç†ç§’æ€æ¶ˆæ¯ï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, message.getOrderId(), message.getUserId(), message.getProductId()); try { // 1. å†æ¬¡æ£€æŸ¥åº“å­˜ï¼ˆåŒé‡ä¿é™©ï¼‰ SeckillProduct product = productService.getById(message.getProductId()); if (product == null || product.getStock() \u0026lt;= 0) { log.warn(\u0026#34;å•†å“ä¸å­˜åœ¨æˆ–åº“å­˜ä¸è¶³ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId()); return; } // 2. åˆ›å»ºè®¢å• SeckillOrder order = new SeckillOrder(); order.setId(message.getOrderId()); order.setUserId(message.getUserId()); order.setProductId(message.getProductId()); order.setPrice(product.getPrice()); order.setStatus(0); // å¾…æ”¯ä»˜ order.setCreateTime(LocalDateTime.now()); // 3. æ‰£å‡æ•°æ®åº“åº“å­˜ boolean stockUpdated = productService.decrStock(message.getProductId()); if (!stockUpdated) { log.warn(\u0026#34;æ‰£å‡æ•°æ®åº“åº“å­˜å¤±è´¥ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId()); return; } // 4. ä¿å­˜è®¢å• orderService.save(order); log.info(\u0026#34;ç§’æ€è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•IDï¼š{}ï¼Œç”¨æˆ·IDï¼š{}ï¼Œå•†å“IDï¼š{}\u0026#34;, message.getOrderId(), message.getUserId(), message.getProductId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç§’æ€æ¶ˆæ¯å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, message.getOrderId(), e); } } } 7.8 å•†å“æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Service @Transactional public class ProductService { @Autowired private SeckillProductMapper productMapper; /** * æ‰£å‡æ•°æ®åº“åº“å­˜ */ public boolean decrStock(Long productId) { try { int result = productMapper.decrStock(productId); return result \u0026gt; 0; } catch (Exception e) { log.error(\u0026#34;æ‰£å‡æ•°æ®åº“åº“å­˜å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return false; } } /** * è·å–å•†å“ä¿¡æ¯ */ public SeckillProduct getById(Long productId) { try { return productMapper.selectById(productId); } catch (Exception e) { log.error(\u0026#34;è·å–å•†å“ä¿¡æ¯å¼‚å¸¸ï¼Œå•†å“IDï¼š{}\u0026#34;, productId, e); return null; } } } 7.9 è®¢å•æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Service public class OrderService { @Autowired private SeckillOrderMapper orderMapper; /** * ä¿å­˜è®¢å• */ public void save(SeckillOrder order) { try { orderMapper.insert(order); } catch (Exception e) { log.error(\u0026#34;ä¿å­˜è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, order.getId(), e); throw new RuntimeException(\u0026#34;ä¿å­˜è®¢å•å¤±è´¥\u0026#34;, e); } } /** * æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å• */ public SeckillOrder getByOrderId(String orderId) { try { return orderMapper.selectByOrderId(orderId); } catch (Exception e) { log.error(\u0026#34;æŸ¥è¯¢è®¢å•å¼‚å¸¸ï¼Œè®¢å•IDï¼š{}\u0026#34;, orderId, e); return null; } } } 7.10 æ•°æ®åº“Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // å•†å“Mapper @Mapper public interface SeckillProductMapper extends BaseMapper\u0026lt;SeckillProduct\u0026gt; { /** * æ‰£å‡åº“å­˜ */ @Update(\u0026#34;UPDATE seckill_product SET stock = stock - 1 WHERE id = #{productId} AND stock \u0026gt; 0\u0026#34;) int decrStock(@Param(\u0026#34;productId\u0026#34;) Long productId); } // è®¢å•Mapper @Mapper public interface SeckillOrderMapper extends BaseMapper\u0026lt;SeckillOrder\u0026gt; { /** * æ ¹æ®è®¢å•IDæŸ¥è¯¢ */ @Select(\u0026#34;SELECT * FROM seckill_order WHERE id = #{orderId}\u0026#34;) SeckillOrder selectByOrderId(@Param(\u0026#34;orderId\u0026#34;) String orderId); } 8ï¸âƒ£ å¼‚æ­¥ç§’æ€ä¼˜åŒ–æŠ€å·§ 8.1 æœ¬åœ°ç¼“å­˜åº“å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Component public class LocalStockCache { private final Map\u0026lt;Long, AtomicInteger\u0026gt; localStockMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * è·å–æœ¬åœ°åº“å­˜ */ public int getLocalStock(Long productId) { AtomicInteger stock = localStockMap.get(productId); return stock != null ? stock.get() : 0; } /** * æ‰£å‡æœ¬åœ°åº“å­˜ */ public boolean decrLocalStock(Long productId) { AtomicInteger stock = localStockMap.computeIfAbsent(productId, k -\u0026gt; new AtomicInteger(0)); return stock.decrementAndGet() \u0026gt;= 0; } /** * åŒæ­¥Redisåº“å­˜åˆ°æœ¬åœ° */ @Scheduled(fixedRate = 1000) // æ¯ç§’åŒæ­¥ä¸€æ¬¡ public void syncStockFromRedis() { for (Long productId : localStockMap.keySet()) { String stockKey = \u0026#34;stock:\u0026#34; + productId; Object redisStock = redisTemplate.opsForValue().get(stockKey); if (redisStock != null) { int stock = Integer.parseInt(redisStock.toString()); localStockMap.put(productId, new AtomicInteger(stock)); } } } } 8.2 é™æµé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Configuration public class RateLimitConfig { @Bean public RedisRateLimiter redisRateLimiter() { return new RedisRateLimiter(100, 200); // æ¯ç§’100ä¸ªè¯·æ±‚ï¼Œçªå‘200ä¸ª } } // é™æµæ³¨è§£ @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface RateLimit { String key() default \u0026#34;rate_limit\u0026#34;; int time() default 60; int count() default 100; } // é™æµåˆ‡é¢ @Aspect @Component public class RateLimitAspect { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Around(\u0026#34;@annotation(rateLimit)\u0026#34;) public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable { String key = rateLimit.key(); int time = rateLimit.time(); int count = rateLimit.count(); String rateLimitKey = \u0026#34;rate_limit:\u0026#34; + key + \u0026#34;:\u0026#34; + System.currentTimeMillis() / 1000; Long current = redisTemplate.opsForValue().increment(rateLimitKey); if (current == 1) { redisTemplate.expire(rateLimitKey, time, TimeUnit.SECONDS); } if (current \u0026gt; count) { throw new RuntimeException(\u0026#34;è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•\u0026#34;); } return point.proceed(); } } 8.3 çƒ­ç‚¹å•†å“é¢„çƒ­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class HotProductPreheater { @Autowired private SeckillService seckillService; @Autowired private ProductService productService; /** * é¢„çƒ­çƒ­ç‚¹å•†å“ */ @Scheduled(cron = \u0026#34;0 0 0 * * ?\u0026#34;) // æ¯å¤©å‡Œæ™¨æ‰§è¡Œ public void preheatHotProducts() { List\u0026lt;SeckillProduct\u0026gt; hotProducts = productService.getHotProducts(); for (SeckillProduct product : hotProducts) { seckillService.warmUpStock(product.getId()); } log.info(\u0026#34;çƒ­ç‚¹å•†å“é¢„çƒ­å®Œæˆï¼Œé¢„çƒ­å•†å“æ•°é‡ï¼š{}\u0026#34;, hotProducts.size()); } } 9ï¸âƒ£ ç›‘æ§å’Œå‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Component public class SeckillMonitor { @Autowired private MeterRegistry meterRegistry; private final Counter successCounter = Counter.builder(\u0026#34;seckill.success\u0026#34;).register(meterRegistry); private final Counter failCounter = Counter.builder(\u0026#34;seckill.fail\u0026#34;).register(meterRegistry); private final Timer processTimer = Timer.builder(\u0026#34;seckill.process.time\u0026#34;).register(meterRegistry); /** * è®°å½•ç§’æ€æˆåŠŸ */ public void recordSuccess() { successCounter.increment(); } /** * è®°å½•ç§’æ€å¤±è´¥ */ public void recordFail() { failCounter.increment(); } /** * è®°å½•å¤„ç†æ—¶é—´ */ public void recordProcessTime(Duration duration) { processTimer.record(duration); } } ğŸ”Ÿ å‰ç«¯å®ç°ç¤ºä¾‹ 10.1 Vue.js å‰ç«¯å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;seckill-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;product-info\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;{{ product.name }}\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;ä»·æ ¼ï¼šÂ¥{{ product.price }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;åº“å­˜ï¼š{{ stock }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;seckill-button\u0026#34;\u0026gt; \u0026lt;button v-if=\u0026#34;!isSeckilling \u0026amp;\u0026amp; stock \u0026gt; 0\u0026#34; @click=\u0026#34;startSeckill\u0026#34; :disabled=\u0026#34;isSeckilling\u0026#34; \u0026gt; ç«‹å³ç§’æ€ \u0026lt;/button\u0026gt; \u0026lt;button v-else-if=\u0026#34;isSeckilling\u0026#34; disabled\u0026gt; æ’é˜Ÿä¸­... \u0026lt;/button\u0026gt; \u0026lt;button v-else disabled\u0026gt; å·²å”®ç½„ \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div v-if=\u0026#34;orderResult\u0026#34; class=\u0026#34;result\u0026#34;\u0026gt; \u0026lt;p v-if=\u0026#34;orderResult.success\u0026#34;\u0026gt;ç§’æ€æˆåŠŸï¼è®¢å•å·ï¼š{{ orderResult.orderId }}\u0026lt;/p\u0026gt; \u0026lt;p v-else\u0026gt;{{ orderResult.message }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; export default { data() { return { product: {}, stock: 0, isSeckilling: false, orderResult: null, pollTimer: null } }, mounted() { this.loadProductInfo(); this.startStockPolling(); }, beforeDestroy() { if (this.pollTimer) { clearInterval(this.pollTimer); } }, methods: { async loadProductInfo() { try { const response = await this.$http.get(`/api/product/${this.$route.params.productId}`); this.product = response.data; } catch (error) { console.error(\u0026#39;åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥\u0026#39;, error); } }, async getStock() { try { const response = await this.$http.get(`/api/seckill/stock/${this.$route.params.productId}`); this.stock = response.data; } catch (error) { console.error(\u0026#39;è·å–åº“å­˜å¤±è´¥\u0026#39;, error); } }, startStockPolling() { this.getStock(); this.pollTimer = setInterval(() =\u0026gt; { this.getStock(); }, 1000); }, async startSeckill() { this.isSeckilling = true; this.orderResult = null; try { const response = await this.$http.post(`/api/seckill/${this.$route.params.productId}`, { userId: this.getCurrentUserId() }); if (response.data.success) { this.orderResult = { success: true, orderId: response.data.data }; this.pollOrderResult(response.data.data); } else { this.orderResult = { success: false, message: response.data.message }; } } catch (error) { this.orderResult = { success: false, message: \u0026#39;ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•\u0026#39; }; } finally { this.isSeckilling = false; } }, async pollOrderResult(orderId) { const maxAttempts = 30; // æœ€å¤šè½®è¯¢30æ¬¡ let attempts = 0; const poll = async () =\u0026gt; { try { const response = await this.$http.get(`/api/seckill/result/${orderId}`); if (response.data.success) { this.orderResult = { success: true, orderId: orderId, order: response.data.data }; return; } attempts++; if (attempts \u0026lt; maxAttempts) { setTimeout(poll, 1000); // 1ç§’åé‡è¯• } else { this.orderResult = { success: false, message: \u0026#39;è®¢å•å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥è¯¢\u0026#39; }; } } catch (error) { console.error(\u0026#39;æŸ¥è¯¢è®¢å•ç»“æœå¤±è´¥\u0026#39;, error); attempts++; if (attempts \u0026lt; maxAttempts) { setTimeout(poll, 1000); } } }; poll(); }, getCurrentUserId() { // è·å–å½“å‰ç”¨æˆ·IDçš„é€»è¾‘ return localStorage.getItem(\u0026#39;userId\u0026#39;) || \u0026#39;1\u0026#39;; } } } \u0026lt;/script\u0026gt; 1ï¸âƒ£1ï¸âƒ£ æ€»ç»“ä¸ç›´è§‚æ¯”å–» æ ¸å¿ƒæµç¨‹æ€»ç»“ï¼š å‰ç«¯ï¼šæ‹¿åˆ°\u0026quot;æŠ¢è´­å‡­è¯\u0026quot;ï¼Œæ— éœ€ç›´æ¥ç­‰å¾…æ•°æ®åº“å®Œæˆè®¢å• æ¥å£å±‚ï¼šå¿«é€Ÿåˆ¤æ–­åº“å­˜å’Œç”¨æˆ·èµ„æ ¼ï¼Œå…¥é˜Ÿ â†’ é«˜å¹¶å‘ä¸‹çº¿ç¨‹ä¸è¢«é˜»å¡ åå°ï¼šæ¶ˆè´¹é˜Ÿåˆ— â†’ æ‰£æ•°æ®åº“åº“å­˜ â†’ åˆ›å»ºè®¢å• â†’ é€šçŸ¥ç”¨æˆ· Redis + æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¿è¯åº“å­˜åŸå­æ€§ã€é¡ºåºå¤„ç†ã€ç³»ç»Ÿå¹³ç¨³è¿è¡Œ âš¡ å¼‚æ­¥ç§’æ€çš„æ ¸å¿ƒç†å¿µï¼š å¿«é€Ÿæ¥æ”¶è¯·æ±‚ + æ’é˜Ÿ + å¼‚æ­¥å¤„ç†ï¼Œå®ç°å‰Šå³°å¡«è°·ã€é˜²æ­¢è¶…å–ã€æå‡ç³»ç»Ÿååé‡ã€‚\nğŸ’¡ ç›´è§‚ç±»æ¯”ï¼š å‰ç«¯ç”¨æˆ·ï¼šæ‹¿åˆ°å–é¤å· åå°ç³»ç»Ÿï¼šå¨æˆ¿æŒ‰é¡ºåºåšèœ ç”¨æˆ·æœ€ç»ˆèƒ½æ‹¿åˆ°èœï¼Œä½†ç³»ç»Ÿä¸ä¼šè¢«ç¬æ—¶æµé‡å‹å® æŠ€æœ¯ä¼˜åŠ¿ï¼š é«˜å¹¶å‘å¤„ç†ï¼šRedis + æ¶ˆæ¯é˜Ÿåˆ—å®ç°å‰Šå³°å¡«è°· é˜²æ­¢è¶…å–ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§æ“ä½œ ç³»ç»Ÿç¨³å®šï¼šå¼‚æ­¥å¤„ç†é¿å…æ•°æ®åº“å‹åŠ› ç”¨æˆ·ä½“éªŒï¼šå¿«é€Ÿå“åº”ï¼Œæ— éœ€é•¿æ—¶é—´ç­‰å¾… å¯æ‰©å±•æ€§ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²å’Œæ°´å¹³æ‰©å±• é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œå®Œæ•´ä»£ç å®ç°ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹å¼‚æ­¥ç§’æ€ç³»ç»Ÿæœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚å¯¹ä»£ç è¿›è¡Œç›¸åº”çš„è°ƒæ•´å’Œä¼˜åŒ–ã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å¼‚æ­¥ç§’æ€ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œä¼˜åŒ–æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ç§’æ€ç³»ç»Ÿã€‚\n","date":"2025-09-10T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%90%ABredis%E9%A2%84%E6%89%A3%E5%BA%93%E5%AD%98%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0/","title":"å¼‚æ­¥ç§’æ€ç³»ç»Ÿæ·±åº¦è§£æï¼ˆå«Redisé¢„æ‰£åº“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼‰"},{"content":"åŸºäº Session çš„çŸ­ä¿¡ç™»å½•å®Œæ•´è§£æ åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼ŒçŸ­ä¿¡éªŒè¯ç ç™»å½• æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ— å¯†ç è®¤è¯æ–¹å¼ã€‚å®ƒçš„å¥½å¤„æ˜¯ç®€å•ã€å®‰å…¨ï¼Œç”¨æˆ·åªéœ€è¦è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç å³å¯ç™»å½•ï¼Œè€Œä¸ç”¨è®°å¤æ‚çš„å¯†ç ã€‚\nå¾ˆå¤šåˆå­¦è€…åœ¨å®ç°æ—¶ä¼šæœ‰ç–‘æƒ‘ï¼šéªŒè¯ç å­˜å“ªï¼Ÿæ€ä¹ˆæ¯”å¯¹ï¼Ÿç™»å½•çŠ¶æ€å¦‚ä½•ä¿æŒï¼Ÿ è¿™ç¯‡æ–‡ç« å°†é€šè¿‡æ¨å¯¼çš„æ–¹å¼ï¼Œé€æ­¥è§£é‡Šæ¸…æ¥šï¼Œå¹¶ç»™å‡ºå®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Session è¦ç†è§£çŸ­ä¿¡ç™»å½•ï¼Œå¿…é¡»å…ˆææ¸…æ¥š Session çš„æ¦‚å¿µã€‚\nHTTP åè®®çš„ä¸€ä¸ªæœ€å¤§ç‰¹ç‚¹æ˜¯ï¼šæ— çŠ¶æ€ã€‚\nè¿™æ„å‘³ç€æ¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨éƒ½ä¸ä¼šè®°å¾—ä½ æ˜¯è°ã€‚\nä½†æ˜¯åœ¨å®é™…åº”ç”¨é‡Œï¼Œæˆ‘ä»¬éœ€è¦ï¼š\nç™»å½•ä¹‹åï¼Œä¿æŒç™»å½•çŠ¶æ€ è´­ç‰©è½¦å†…å®¹èƒ½å¤Ÿä¸€ç›´ä¿å­˜ éªŒè¯ç å‘é€åï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°æ ¡éªŒ è¿™æ—¶å€™å°±éœ€è¦ Sessionã€‚\n1.1 Session çš„ç±»æ¯” ä½ å¯ä»¥æŠŠ Session æƒ³è±¡æˆæœåŠ¡å™¨ç»™ç”¨æˆ·å¼€çš„ä¸€é—´å°å‚¨ç‰©æŸœï¼š\nå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼ŒæœåŠ¡å™¨ï¼ˆtomcatï¼‰åˆ†é…ä¸€ä¸ªå‚¨ç‰©æŸœï¼ˆSessionï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ç¼–å·ï¼ˆSession IDï¼‰ æœåŠ¡å™¨æŠŠè¿™ä¸ªç¼–å·å†™åœ¨ä¸€å¼ å°çº¸æ¡ä¸Šï¼ˆCookieï¼‰ï¼Œäº¤ç»™æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ä¿å­˜ ä»¥åæµè§ˆå™¨æ¯æ¬¡è®¿é—®æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šè¿™å¼ å°çº¸æ¡ æœåŠ¡å™¨æ ¹æ®çº¸æ¡ä¸Šçš„ç¼–å·ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å‚¨ç‰©æŸœï¼Œä»é‡Œé¢å–å‡ºå±äºè¯¥ç”¨æˆ·çš„æ•°æ® 1.2 Session vs Cookie ç‰¹æ€§ Cookieï¼ˆå°çº¸æ¡ï¼‰ Sessionï¼ˆå‚¨ç‰©æŸœï¼‰ å­˜å‚¨ä½ç½® æµè§ˆå™¨ç«¯ æœåŠ¡å™¨ç«¯ å®‰å…¨æ€§ è¾ƒä½ï¼ˆå®¹æ˜“è¢«ç¯¡æ”¹ï¼‰ è¾ƒé«˜ï¼ˆç”±æœåŠ¡å™¨ç»´æŠ¤ï¼‰ å®¹é‡ 4KB å·¦å³ å–å†³äºæœåŠ¡å™¨å†…å­˜ ç”Ÿå‘½å‘¨æœŸ å¯è®¾ç½®é•¿æ—¶é—´ä¿å­˜ é»˜è®¤éšæµè§ˆå™¨å…³é—­æˆ–è¶…æ—¶æ¸…é™¤ äºŒã€çŸ­ä¿¡ç™»å½•çš„æ¨å¯¼è¿‡ç¨‹ ç°åœ¨æˆ‘ä»¬æŠŠ Session çš„åŸç†æ”¾åˆ° çŸ­ä¿¡éªŒè¯ç ç™»å½• çš„åœºæ™¯ä¸­ï¼Œæ¥ä¸€æ­¥æ­¥æ¨å¯¼ã€‚\n2.1 ç”¨æˆ·æäº¤æ‰‹æœºå· ç”¨æˆ·åœ¨å‰ç«¯é¡µé¢è¾“å…¥æ‰‹æœºå· å‰ç«¯æŠŠæ‰‹æœºå·å‘é€ç»™åç«¯ 2.2 æœåŠ¡å™¨ç”ŸæˆéªŒè¯ç  åç«¯ç”Ÿæˆä¸€ä¸ª 6 ä½éšæœºæ•°ï¼ˆä¾‹å¦‚ 123456ï¼‰ æŠŠè¿™ä¸ªéªŒè¯ç ä¿å­˜åˆ° Session å‚¨ç‰©æŸœ é‡Œ åŒæ—¶è°ƒç”¨çŸ­ä¿¡æœåŠ¡å•†çš„ APIï¼ŒæŠŠéªŒè¯ç å‘é€åˆ°ç”¨æˆ·æ‰‹æœº æ­¤æ—¶ï¼ŒSession ä¸­ä¿å­˜çš„æ˜¯ï¼š key = \u0026ldquo;SMS_CODE_æ‰‹æœºå·\u0026rdquo; value = \u0026ldquo;123456\u0026rdquo;\n2.3 ç”¨æˆ·è¾“å…¥éªŒè¯ç ç™»å½• ç”¨æˆ·æ”¶åˆ°éªŒè¯ç ï¼Œåœ¨é¡µé¢è¾“å…¥ æµè§ˆå™¨åœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šè‡ªåŠ¨å¸¦ä¸Š Session ID çš„å°çº¸æ¡ï¼ˆCookieï¼‰ åç«¯æ ¹æ® Session ID æ‰¾åˆ°å‚¨ç‰©æŸœï¼Œä»ä¸­å–å‡ºéªŒè¯ç  æ¯”å¯¹ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç ä¸ Session ä¸­ä¿å­˜çš„éªŒè¯ç  ä¸€è‡´ âœ… â†’ ç™»å½•æˆåŠŸ ä¸ä¸€è‡´ âŒ â†’ ç™»å½•å¤±è´¥ ä¸‰ã€ä»£ç å®ç°ç¤ºä¾‹ï¼ˆSpring Bootï¼‰ æ¥ä¸‹æ¥ç”¨ Java + Spring Boot æ¥å®ç°ä¸€ä¸ªæœ€ç®€åŒ–çš„ åŸºäº Session çš„çŸ­ä¿¡ç™»å½•ã€‚\n3.1 å‘é€éªŒè¯ç æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @RestController @RequestMapping(\u0026#34;/auth\u0026#34;) public class SmsLoginController { @PostMapping(\u0026#34;/sendCode\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; sendCode(@RequestParam String phone, HttpSession session) { // ç”Ÿæˆ 6 ä½éªŒè¯ç  String code = String.valueOf((int)((Math.random() * 9 + 1) * 100000)); // æ¨¡æ‹Ÿå‘é€çŸ­ä¿¡ï¼ˆçœŸå®æƒ…å†µéœ€æ¥å…¥çŸ­ä¿¡æœåŠ¡å•† APIï¼‰ System.out.println(\u0026#34;å‘æ‰‹æœºå· \u0026#34; + phone + \u0026#34; å‘é€éªŒè¯ç ï¼š\u0026#34; + code); // ä¿å­˜åˆ° session session.setAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone, code); session.setAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone, System.currentTimeMillis()); return ResponseEntity.ok(\u0026#34;éªŒè¯ç å·²å‘é€\u0026#34;); } } è¯´æ˜ï¼š éªŒè¯ç ä¿å­˜åœ¨ Session ä¸­ï¼Œä¸å­˜å‰ç«¯ å»ºè®®åŒæ—¶ä¿å­˜éªŒè¯ç ç”Ÿæˆæ—¶é—´ï¼Œæ–¹ä¾¿åç»­åˆ¤æ–­æ˜¯å¦è¿‡æœŸ\n3.2 éªŒè¯ç™»å½•æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping(\u0026#34;/login\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; login(@RequestParam String phone, @RequestParam String code, HttpSession session) { String sessionCode = (String) session.getAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); Long codeTime = (Long) session.getAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); if (sessionCode == null) { return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç æœªå‘é€æˆ–å·²è¿‡æœŸ\u0026#34;); } // éªŒè¯æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰ if (System.currentTimeMillis() - codeTime \u0026gt; 5 * 60 * 1000) { session.removeAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); session.removeAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç å·²è¿‡æœŸ\u0026#34;); } if (!sessionCode.equals(code)) { return ResponseEntity.status(400).body(\u0026#34;éªŒè¯ç é”™è¯¯\u0026#34;); } // ç™»å½•æˆåŠŸï¼Œå†™å…¥ç”¨æˆ·ç™»å½•çŠ¶æ€ session.setAttribute(\u0026#34;LOGIN_USER\u0026#34;, phone); // æ¸…ç†éªŒè¯ç  session.removeAttribute(\u0026#34;SMS_CODE_\u0026#34; + phone); session.removeAttribute(\u0026#34;SMS_CODE_TIME_\u0026#34; + phone); return ResponseEntity.ok(\u0026#34;ç™»å½•æˆåŠŸ\u0026#34;); } è¯´æ˜ï¼š æ ¸å¿ƒé€»è¾‘åœ¨ åç«¯æ¯”å¯¹ï¼Œå‰ç«¯åªè´Ÿè´£æ”¶é›†è¾“å…¥ éªŒè¯ç è¿‡æœŸæœºåˆ¶å¿…é¡»æœ‰ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨\n3.3 è·å–å½“å‰ç™»å½•ç”¨æˆ·æ¥å£ 1 2 3 4 5 6 7 8 @GetMapping(\u0026#34;/me\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; getUser(HttpSession session) { String phone = (String) session.getAttribute(\u0026#34;LOGIN_USER\u0026#34;); if (phone == null) { return ResponseEntity.status(401).body(\u0026#34;æœªç™»å½•\u0026#34;); } return ResponseEntity.ok(\u0026#34;å½“å‰ç™»å½•ç”¨æˆ·ï¼š\u0026#34; + phone); } å››ã€å…³é”®ç‚¹æ€»ç»“ 1.Session æ˜¯å‚¨ç‰©æŸœï¼ŒCookie æ˜¯å‚¨ç‰©æŸœçš„å–ä»¶å‡­è¯è¯ éªŒè¯ç å­˜æ”¾åœ¨ Sessionï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼Œä¸å­˜æµè§ˆå™¨ æµè§ˆå™¨åªä¿ç•™ Session IDï¼ˆCookieï¼‰ 2.æ¯”å¯¹é€»è¾‘å¿…é¡»åœ¨åç«¯å®Œæˆ å‰ç«¯åªè´Ÿè´£æ”¶é›†å’Œæäº¤æ‰‹æœºå·ã€éªŒè¯ç  æœåŠ¡å™¨æ ¹æ® Session æ‰¾åˆ°éªŒè¯ç å¹¶æ¯”å¯¹ï¼Œå†³å®šæ˜¯å¦ç™»å½• 3.å®‰å…¨æ€§æªæ–½ éªŒè¯ç è¦æœ‰è¿‡æœŸæ—¶é—´ï¼ˆä¸€èˆ¬ 5 åˆ†é’Ÿï¼‰ éªŒè¯ç è¦æœ‰å‘é€é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢è¢«æ¶æ„åˆ· äº”ã€æµç¨‹å›é¡¾ è®©æˆ‘ä»¬å›é¡¾æ•´ä¸ªçŸ­ä¿¡ç™»å½•çš„è¿‡ç¨‹ï¼š 1.ç”¨æˆ·è¾“å…¥æ‰‹æœºå· 2.æœåŠ¡å™¨ç”ŸæˆéªŒè¯ç ï¼Œå­˜åˆ° Sessionï¼Œå¹¶é€šè¿‡çŸ­ä¿¡å‘é€ 3.ç”¨æˆ·æ”¶åˆ°éªŒè¯ç ï¼Œè¾“å…¥åˆ°å‰ç«¯é¡µé¢ 4.æµè§ˆå™¨è¯·æ±‚æ—¶å¸¦ä¸Š Cookieï¼ˆSession IDï¼‰ 5.æœåŠ¡å™¨ç”¨ Session ID æ‰¾åˆ°å‚¨ç‰©æŸœï¼Œå–å‡ºéªŒè¯ç è¿›è¡Œæ¯”å¯¹ ä¸€è‡´ â†’ ç™»å½•æˆåŠŸï¼› ä¸ä¸€è‡´/è¿‡æœŸ â†’ ç™»å½•å¤±è´¥ 6.æ‰©å±•æ€è€ƒ åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒSession å¯èƒ½å­˜æ”¾åœ¨ Redis é‡Œï¼Œä»¥ä¾¿æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚\nå¦å¤–ï¼Œä¹Ÿå¯ä»¥æ›¿ä»£ Sessionï¼Œç”¨ JWTï¼ˆJSON Web Tokenï¼‰ å®ç°æ— çŠ¶æ€çš„ç™»å½•ã€‚ ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ï¼š\néªŒè¯ç å¿…é¡»åœ¨åç«¯ä¿å­˜å’Œæ¯”å¯¹ å‰ç«¯åªè´Ÿè´£å±•ç¤ºå’Œè¾“å…¥ 7.ç»“è¯­ é€šè¿‡ä¸Šé¢çš„æ¨å¯¼ï¼Œæˆ‘ä»¬æŠŠâ€œçŸ­ä¿¡ç™»å½•â€è¿™ä¸ªå¸¸è§éœ€æ±‚ï¼Œå®Œæ•´åœ°æ‹†è§£æˆäº† ä¸šåŠ¡æµç¨‹ + Session åŸç† + å®ç°ä»£ç ã€‚\nå¦‚æœä½ åˆšå¼€å§‹å­¦ä¹ åç«¯å¼€å‘ï¼Œå¸Œæœ›ä½ èƒ½ä»è¿™ç¯‡æ–‡ç« ä¸­çœŸæ­£ç†è§£ï¼š\nä¸ºä»€ä¹ˆè¦ç”¨ Session çŸ­ä¿¡éªŒè¯ç åº”è¯¥å­˜æ”¾åœ¨å“ªé‡Œ éªŒè¯é€»è¾‘ä¸ºä»€ä¹ˆè¦åœ¨åç«¯ è¿™æ ·ï¼Œä¸ç®¡æ˜¯åšä¸€ä¸ªå° demoï¼Œè¿˜æ˜¯å°†æ¥åº”å¯¹ç”Ÿäº§çº§çš„é¡¹ç›®ï¼Œä½ éƒ½èƒ½ä¸¾ä¸€åä¸‰ã€‚\n","date":"2025-08-26T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E5%9F%BA%E4%BA%8E-session-%E7%9A%84%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%9E%90/","title":"åŸºäº Session çš„çŸ­ä¿¡ç™»å½•å®Œæ•´è§£æ"},{"content":"æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼ŒRedis ä½œä¸ºç¼“å­˜å±‚ï¼ŒMySQL ä½œä¸ºå­˜å‚¨å±‚çš„ç»„åˆå‡ ä¹æ˜¯æ ‡é…ã€‚Redis çš„é«˜æ€§èƒ½æå¤§ç¼“è§£äº†æ•°æ®åº“çš„å‹åŠ›ï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªæ ¸å¿ƒéš¾é¢˜ï¼šå¦‚ä½•ä¿è¯æ•°æ®åº“ä¸ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ\næœ¬æ–‡å°†å…¨é¢åˆ†ææ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒ…æ‹¬ ä¸ä¸€è‡´äº§ç”Ÿçš„åŸå› ã€å¸¸è§è§£å†³æ–¹æ¡ˆã€ä¼˜ç¼ºç‚¹åˆ†æã€ä»£ç ç¤ºä¾‹ï¼Œä»¥åŠé€šä¿—çš„ç”Ÿæ´»ç±»æ¯”ã€‚è¯»å®Œæœ¬æ–‡ï¼Œä½ å°†å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ‰ç³»ç»Ÿã€æ·±åˆ»çš„ç†è§£ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆæ•°æ®åº“å’Œç¼“å­˜å¯èƒ½ä¸ä¸€è‡´ï¼Ÿ å¾ˆå¤šäººä¸€å¼€å§‹ä¼šç–‘æƒ‘ï¼šæ•°æ®åº“å’Œç¼“å­˜éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±åœ¨æ§åˆ¶ï¼Œä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´ï¼Ÿ\nå…¶å®ï¼Œé—®é¢˜çš„æ ¹æºåœ¨äº ç¼“å­˜å’Œæ•°æ®åº“æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç³»ç»Ÿï¼Œæ•°æ®åŒæ­¥ä¸æ˜¯åŸå­æ“ä½œï¼Œä¸­é—´å­˜åœ¨æ—¶é—´å·®å’Œå¤±è´¥çš„å¯èƒ½ã€‚\n1.1 å¸¸è§ä¸ä¸€è‡´åŸå›  â‘  å†™æ•°æ®åº“æˆåŠŸï¼Œä½†ç¼“å­˜æ²¡æ›´æ–° åŸå› ï¼šä¸šåŠ¡ä»£ç é‡Œå…ˆå†™æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ã€‚å¦‚æœæ›´æ–°ç¼“å­˜å¤±è´¥ï¼ˆæ¯”å¦‚ Redis å®•æœºæˆ–ç½‘ç»œæŠ–åŠ¨ï¼‰ï¼Œå°±ä¼šå‡ºç° æ•°æ®åº“æ–°å€¼ã€ç¼“å­˜æ—§å€¼ çš„æƒ…å†µã€‚\né€šä¿—ç±»æ¯”ï¼šä½ æ¢äº†æ‰‹æœºå·ç ï¼Œä½†å¿˜äº†å‘Šè¯‰æœ‹å‹ã€‚ç»“æœæœ‹å‹æ‰“ç”µè¯æ—¶ï¼Œè¿˜æ˜¯æ‰“åˆ°ä½ æ—§å·ç ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Service public class UserService { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public void updateUser(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ userMapper.updateById(user); // 2. æ›´æ–°ç¼“å­˜ - è¿™é‡Œå¯èƒ½å¤±è´¥ï¼ redisTemplate.opsForValue().set(\u0026#34;user:\u0026#34; + user.getId(), user); } catch (Exception e) { // å¦‚æœç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œæ•°æ®åº“å·²ç»æ›´æ–°äº†ï¼Œä½†ç¼“å­˜è¿˜æ˜¯æ—§å€¼ log.error(\u0026#34;æ›´æ–°ç¼“å­˜å¤±è´¥\u0026#34;, e); } } } â‘¡ æ›´æ–°é¡ºåºå¯¼è‡´çš„é—®é¢˜ å†™æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ï¼šå¦‚æœå†™æ•°æ®åº“æˆåŠŸï¼Œä½†åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œé‚£ä¹ˆç¼“å­˜é‡Œä¾æ—§æ˜¯æ—§æ•°æ®ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¼šç›´æ¥æ‹¿æ—§ç¼“å­˜ã€‚\nåˆ é™¤ç¼“å­˜ â†’ å†™æ•°æ®åº“ï¼šå¦‚æœåœ¨åˆ é™¤ç¼“å­˜åã€å†™æ•°æ®åº“å‰ï¼Œæ°å¥½æœ‰è¯·æ±‚æŸ¥è¯¢æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿ ç¼“å­˜å›å¡«æ—§å€¼ çš„é—®é¢˜ã€‚\né€šä¿—ç±»æ¯”ï¼š\nä½ è¦æ¢å®¶é‡Œçš„é”ã€‚ æ–¹æ¡ˆä¸€ï¼ˆå…ˆæ¢é”ï¼Œå†æ‰”æ—§é’¥åŒ™ï¼‰ï¼šå®‰å…¨ï¼Œä½†ä¸‡ä¸€æ‰”é’¥åŒ™æ—¶æ‰‹æ»‘æ²¡æ‰”æ‰ï¼ˆç¼“å­˜æ²¡åˆ æ‰ï¼‰ï¼Œåˆ«äººè¿˜èƒ½ç”¨æ—§é’¥åŒ™å¼€é—¨ã€‚ æ–¹æ¡ˆäºŒï¼ˆå…ˆæ‰”é’¥åŒ™ï¼Œå†æ¢é”ï¼‰ï¼šåœ¨ä½ æ¢é”çš„å‡ åˆ†é’Ÿé‡Œï¼Œåˆ«äººå¯èƒ½æ­£å¥½ç”¨æ—§é’¥åŒ™å¼€é—¨ï¼ˆç¼“å­˜è¢«æ—§å€¼å›å¡«ï¼‰ã€‚ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // æ–¹æ¡ˆä¸€ï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜ public void updateUserV1(User user) { // 1. æ›´æ–°æ•°æ®åº“ userMapper.updateById(user); // 2. åˆ é™¤ç¼“å­˜ - å¯èƒ½å¤±è´¥ try { redisTemplate.delete(\u0026#34;user:\u0026#34; + user.getId()); } catch (Exception e) { // åˆ é™¤å¤±è´¥ï¼Œç¼“å­˜è¿˜æ˜¯æ—§å€¼ log.error(\u0026#34;åˆ é™¤ç¼“å­˜å¤±è´¥\u0026#34;, e); } } // æ–¹æ¡ˆäºŒï¼šå…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“ public void updateUserV2(User user) { // 1. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;user:\u0026#34; + user.getId()); // 2. æ›´æ–°æ•°æ®åº“ - åœ¨åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´ï¼Œå¯èƒ½æœ‰æŸ¥è¯¢è¯·æ±‚å›å¡«æ—§å€¼ userMapper.updateById(user); } â‘¢ å¹¶å‘è¦†ç›–é—®é¢˜ åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶ä¿®æ”¹åŒä¸€æ¡æ•°æ®ï¼Œå¯èƒ½å‡ºç°è¦†ç›–ã€‚\nåœºæ™¯ä¸¾ä¾‹ï¼š\nè¯·æ±‚ Aï¼šæ›´æ–°ç”¨æˆ·ä½™é¢ä¸º 100 â†’ æ›´æ–°æ•°æ®åº“æˆåŠŸ â†’ åˆ é™¤ç¼“å­˜ è¯·æ±‚ Bï¼šæ›´æ–°ç”¨æˆ·ä½™é¢ä¸º 200 â†’ æ›´æ–°æ•°æ®åº“æˆåŠŸ â†’ åˆ é™¤ç¼“å­˜ è¯·æ±‚ A çº¿ç¨‹è¾ƒæ…¢ï¼Œåœ¨ B æ›´æ–°å®Œæˆååˆå›å¡«äº† 100 åˆ°ç¼“å­˜ ç»“æœï¼šæ•°æ®åº“æ˜¯ 200ï¼Œç¼“å­˜å´æ˜¯ 100ï¼Œäº§ç”Ÿäº†è„æ•°æ®ã€‚ é€šä¿—ç±»æ¯”ï¼šä¸¤ä¸ªäººåŒæ—¶å¾€ä¸€ä¸ªæ–‡æ¡£é‡Œå†™æ•°æ®ã€‚ç”²å†™äº†æ–°ç‰ˆå†…å®¹ï¼Œä¹™å†™å®Œæ—§ç‰ˆåä¿å­˜ï¼Œæœ€ç»ˆçš„æ–‡æ¡£è¢«ä¹™è¦†ç›–ï¼Œç”²çš„ä¿®æ”¹æ¶ˆå¤±ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Service public class AccountService { @Autowired private AccountMapper accountMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; // å¹¶å‘æ›´æ–°ä½™é¢çš„é—®é¢˜ç¤ºä¾‹ public void updateBalance(Long userId, BigDecimal amount) { // 1. æŸ¥è¯¢å½“å‰ä½™é¢ Account account = accountMapper.selectById(userId); // 2. è®¡ç®—æ–°ä½™é¢ BigDecimal newBalance = account.getBalance().add(amount); account.setBalance(newBalance); // 3. æ›´æ–°æ•°æ®åº“ accountMapper.updateById(account); // 4. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;account:\u0026#34; + userId); // é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå¯èƒ½å‡ºç°è¦†ç›– } // æŸ¥è¯¢ä½™é¢ public BigDecimal getBalance(Long userId) { // 1. å…ˆæŸ¥ç¼“å­˜ String cacheKey = \u0026#34;account:\u0026#34; + userId; BigDecimal balance = (BigDecimal) redisTemplate.opsForValue().get(cacheKey); if (balance != null) { return balance; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ Account account = accountMapper.selectById(userId); balance = account.getBalance(); // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, balance, 30, TimeUnit.MINUTES); return balance; } } â‘£ ç¼“å­˜å›å¡«é—®é¢˜ å½“ç¼“å­˜è¿‡æœŸæˆ–è¢«åˆ é™¤æ—¶ï¼Œå¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢ï¼Œä¼šå‡ºç° ç¼“å­˜å‡»ç©¿ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚å¦‚æœæ•°æ®åº“çš„æ•°æ®æ°å¥½æ­£åœ¨è¢«æ›´æ–°ï¼Œå°±å¯èƒ½å›å¡«æ—§å€¼åˆ°ç¼“å­˜ã€‚\né€šä¿—ç±»æ¯”ï¼šå¤§å®¶éƒ½åœ¨æŸ¥å¿«é€’å•å·ã€‚ç¼“å­˜é‡Œè¿‡æœŸäº†ï¼Œå¤§å®¶éƒ½å»é—®å¿«é€’å…¬å¸ã€‚æ­£å¥½å¿«é€’å…¬å¸ç³»ç»Ÿè¿˜æ²¡æ›´æ–°ï¼Œæœ‰äººæŠŠæ—§çš„ç‰©æµä¿¡æ¯æ‹¿å›æ¥ï¼Œåˆé‡æ–°å­˜è¿›ç¼“å­˜ã€‚\nä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Service public class ProductService { @Autowired private ProductMapper productMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public Product getProduct(Long productId) { String cacheKey = \u0026#34;product:\u0026#34; + productId; // 1. å…ˆæŸ¥ç¼“å­˜ Product product = (Product) redisTemplate.opsForValue().get(cacheKey); if (product != null) { return product; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ product = productMapper.selectById(productId); // 3. å›å¡«ç¼“å­˜ - è¿™é‡Œå¯èƒ½å›å¡«æ—§å€¼ if (product != null) { redisTemplate.opsForValue().set(cacheKey, product, 30, TimeUnit.MINUTES); } return product; } public void updateProduct(Product product) { // 1. æ›´æ–°æ•°æ®åº“ productMapper.updateById(product); // 2. åˆ é™¤ç¼“å­˜ redisTemplate.delete(\u0026#34;product:\u0026#34; + product.getId()); // é—®é¢˜ï¼šåœ¨åˆ é™¤ç¼“å­˜åï¼Œå¦‚æœæœ‰æŸ¥è¯¢è¯·æ±‚ï¼Œå¯èƒ½å›å¡«æ—§å€¼ } } â‘¤ å¼‚å¸¸æˆ–æ¶ˆæ¯ä¸¢å¤± åœ¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ã€Binlog åŒæ­¥çš„åœºæ™¯é‡Œï¼Œå¦‚æœæ¶ˆæ¯ä¸¢å¤±æˆ–æ¶ˆè´¹å¤±è´¥ï¼Œä¹Ÿä¼šé€ æˆæ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´ã€‚\né€šä¿—ç±»æ¯”ï¼šä½ è®©æœ‹å‹å¸®å¿™è½¬å‘Šä¸€ä¸ªä¿¡æ¯ã€‚å¦‚æœæœ‹å‹å¿˜äº†è¯´ï¼ˆæ¶ˆæ¯ä¸¢äº†ï¼‰ï¼Œæ¥æ”¶æ–¹å°±æ°¸è¿œæ‹¿ä¸åˆ°æœ€æ–°æ•°æ®ã€‚\nå°ç»“ æ•°æ®åº“ä¸ç¼“å­˜çš„ä¸ä¸€è‡´ï¼Œå½’æ ¹åˆ°åº•æ˜¯å› ä¸º æ›´æ–°ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå†åŠ ä¸Š ç½‘ç»œã€å¹¶å‘ã€å»¶è¿Ÿã€å¼‚å¸¸ ç­‰å› ç´ ï¼Œå¯¼è‡´ä¸åŒæ­¥ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹å¸¸è§çš„è§£å†³æ–¹æ¡ˆã€‚\näºŒã€å¸¸è§åŒæ­¥ç­–ç•¥ä¸å®ç° 2.1 Cache Asideï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰ è¿™æ˜¯æœ€å¸¸è§çš„ç¼“å­˜ç­–ç•¥ï¼š\nè¯»ï¼šå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜æ²¡æœ‰å°±è¯»æ•°æ®åº“ï¼Œç„¶åå›å¡«åˆ°ç¼“å­˜ã€‚ å†™ï¼šæ›´æ–°æ•°æ®åº“ï¼Œç„¶ååˆ é™¤ç¼“å­˜ã€‚ æµç¨‹å›¾ 1 2 3 4 è¯»è¯·æ±‚ï¼š å…ˆæŸ¥ç¼“å­˜ â†’ ç¼“å­˜å‘½ä¸­ â†’ è¿”å› ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å› å†™è¯·æ±‚ï¼š å…ˆå†™æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ ä¼˜ç‚¹ ç®€å•æ˜“å®ç° æ›´æ–°é¢‘ç‡ä½ã€è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹æ€§èƒ½å¥½ ç¼ºç‚¹ å†™ååˆ é™¤ç¼“å­˜ä¸æ˜¯åŸå­æ“ä½œï¼Œå¯èƒ½äº§ç”Ÿä¸ä¸€è‡´ åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´æœ‰çª—å£æœŸï¼Œå®¹æ˜“è¢«å¹¶å‘è¦†ç›– é€šä¿—ç±»æ¯” ä½ è®°ä¸ä½æœ‹å‹çš„æ‰‹æœºå·ï¼ˆæ•°æ®åº“ï¼‰ï¼Œäºæ˜¯å†™åœ¨çº¸æ¡ä¸Šæ”¾åœ¨å£è¢‹é‡Œï¼ˆç¼“å­˜ï¼‰ã€‚æ¯æ¬¡æŸ¥å·ç æ—¶ï¼Œå…ˆæ‘¸å£è¢‹ã€‚å¦‚æœå·ç å˜äº†ï¼Œä½ æ”¹æ‰‹æœºé€šè®¯å½•ï¼ˆæ•°æ®åº“ï¼‰ï¼Œç„¶åæŠŠçº¸æ¡æ‰”æ‰ï¼ˆåˆ ç¼“å­˜ï¼‰ã€‚ä¸‹æ¬¡å†æœ‰äººé—®ï¼Œå°±ä¼šä»æ‰‹æœºæŸ¥å‡ºæ–°å·ç ï¼Œå†æŠ„ä¸€å¼ æ–°çº¸æ¡ã€‚\nä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 @Service public class UserService { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final int CACHE_EXPIRE_TIME = 30; // åˆ†é’Ÿ /** * æŸ¥è¯¢ç”¨æˆ· - Cache Aside è¯»ç­–ç•¥ */ public User getUser(Long userId) { String cacheKey = USER_CACHE_PREFIX + userId; // 1. å…ˆæŸ¥ç¼“å­˜ User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { log.info(\u0026#34;ç¼“å­˜å‘½ä¸­ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ log.info(\u0026#34;ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, CACHE_EXPIRE_TIME, TimeUnit.MINUTES); log.info(\u0026#34;æ•°æ®å›å¡«ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } return user; } /** * æ›´æ–°ç”¨æˆ· - Cache Aside å†™ç­–ç•¥ */ @Transactional public boolean updateUser(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * åˆ é™¤ç”¨æˆ· */ @Transactional public boolean deleteUser(Long userId) { try { // 1. åˆ é™¤æ•°æ®åº“è®°å½• int result = userMapper.deleteById(userId); if (result \u0026lt;= 0) { log.warn(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + userId; redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return true; } catch (Exception e) { log.error(\u0026#34;åˆ é™¤ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); throw new RuntimeException(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } } 2.2 å»¶æ—¶åŒåˆ ç­–ç•¥ åœ¨ å†™æ•°æ®åº“ + åˆ é™¤ç¼“å­˜ çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€æ¬¡å»¶æ—¶åˆ é™¤ã€‚\n1 2 3 4 updateDB(); delCache(); Thread.sleep(500); delCache(); ä¸ºä»€ä¹ˆè¦å¤šåˆ ä¸€æ¬¡ï¼Ÿ å› ä¸ºç¬¬ä¸€æ¬¡åˆ ç¼“å­˜åï¼Œå¯èƒ½æœ‰å¹¶å‘è¯·æ±‚æŸ¥è¯¢ï¼Œå›å¡«äº†æ—§å€¼ã€‚ç¬¬äºŒæ¬¡å»¶è¿Ÿåˆ é™¤ï¼Œå¯ä»¥æŠŠæ—§å€¼å†æ¸…ç†æ‰ã€‚\nä¼˜ç‚¹ æ€è·¯ç®€å•ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£å¹¶å‘è¦†ç›–é—®é¢˜ ç¼ºç‚¹ å»¶è¿Ÿæ—¶é—´ä¸å¥½ç¡®å®šï¼Œæ—¶é—´è¿‡é•¿ â†’ è„æ•°æ®å­˜åœ¨å¤ªä¹…ï¼›æ—¶é—´è¿‡çŸ­ â†’ è¦†ç›–é—®é¢˜ä»å¯èƒ½å‘ç”Ÿ ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ é€šä¿—ç±»æ¯” ä½ æ¢äº†é—¨é”ã€‚å…ˆæŠŠæ—§é’¥åŒ™æ”¶èµ°ï¼ˆåˆ ç¼“å­˜ï¼‰ã€‚ä½†æ‹…å¿ƒæœ‰äººæ‰‹é‡Œè¿˜æœ‰å¤‡ä»½é’¥åŒ™ï¼Œäºæ˜¯è¿‡å‡ åˆ†é’Ÿå†æ¥æ£€æŸ¥ä¸€æ¬¡ï¼ŒæŠŠå¯èƒ½å†’å‡ºæ¥çš„æ—§é’¥åŒ™ä¹Ÿæ”¶èµ°ã€‚\nä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 @Service public class UserServiceWithDelayDoubleDelete { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private ThreadPoolTaskExecutor taskExecutor; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final int DELAY_TIME = 500; // æ¯«ç§’ /** * å»¶æ—¶åŒåˆ ç­–ç•¥æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithDelayDoubleDelete(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { return false; } // 2. ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); // 3. å¼‚æ­¥å»¶æ—¶åˆ é™¤ç¼“å­˜ taskExecutor.execute(() -\u0026gt; { try { Thread.sleep(DELAY_TIME); redisTemplate.delete(cacheKey); log.info(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜å®Œæˆï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜è¢«ä¸­æ–­ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); } catch (Exception e) { log.error(\u0026#34;å»¶æ—¶åˆ é™¤ç¼“å­˜å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); } }); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * æŸ¥è¯¢ç”¨æˆ· */ public User getUser(Long userId) { String cacheKey = USER_CACHE_PREFIX + userId; // 1. å…ˆæŸ¥ç¼“å­˜ User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); } return user; } } 2.3 åŠ é”ç­–ç•¥ï¼ˆè¯»å†™é”ã€åˆ†å¸ƒå¼é”ï¼‰ é€šè¿‡åŠ é”æ¥ä¿è¯å†™æ“ä½œå’Œè¯»æ“ä½œçš„äº’æ–¥ï¼Œé¿å…å¹¶å‘ä¸ä¸€è‡´ã€‚\nè¯»å†™é” è¯»é”ï¼ˆå…±äº«é”ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½å†™ã€‚ å†™é”ï¼ˆæ’ä»–é”ï¼‰ï¼šå†™æ—¶ç‹¬å ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ã€‚ ä»£ç å®ç°ï¼ˆRedisson å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 @Service public class UserServiceWithLock { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RedissonClient redissonClient; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String LOCK_PREFIX = \u0026#34;lock:user:\u0026#34;; /** * ä½¿ç”¨è¯»å†™é”æŸ¥è¯¢ç”¨æˆ· */ public User getUserWithReadLock(Long userId) { String lockKey = LOCK_PREFIX + userId; RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock readLock = rwLock.readLock(); try { readLock.lock(); // 1. å…ˆæŸ¥ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + userId; User user = (User) redisTemplate.opsForValue().get(cacheKey); if (user != null) { log.info(\u0026#34;ç¼“å­˜å‘½ä¸­ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return user; } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ log.info(\u0026#34;ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); user = userMapper.selectById(userId); if (user != null) { // 3. å›å¡«ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;æ•°æ®å›å¡«ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } return user; } finally { readLock.unlock(); } } /** * ä½¿ç”¨å†™é”æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithWriteLock(User user) { String lockKey = LOCK_PREFIX + user.getId(); RReadWriteLock rwLock = redissonClient.getReadWriteLock(lockKey); RLock writeLock = rwLock.writeLock(); try { writeLock.lock(); // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } finally { writeLock.unlock(); } } /** * ä½¿ç”¨åˆ†å¸ƒå¼é”æ›´æ–°ç”¨æˆ· */ @Transactional public boolean updateUserWithDistributedLock(User user) { String lockKey = LOCK_PREFIX + user.getId(); RLock lock = redissonClient.getLock(lockKey); try { // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”æŒæœ‰æ—¶é—´30ç§’ boolean acquired = lock.tryLock(10, 30, TimeUnit.SECONDS); if (!acquired) { log.warn(\u0026#34;è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { log.warn(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return false; } // 2. åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;è·å–åˆ†å¸ƒå¼é”è¢«ä¸­æ–­ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); return false; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } finally { if (lock.isHeldByCurrentThread()) { lock.unlock(); } } } } ä¼˜ç‚¹ èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œé¿å…è„è¯»ã€è„å†™ ç‰¹åˆ«é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ ç¼ºç‚¹ æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œé«˜å¹¶å‘ä¸‹å®¹æ˜“æˆä¸ºç“¶é¢ˆ å¦‚æœé”é‡Šæ”¾å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´æ­»é” é€šä¿—ç±»æ¯” å›¾ä¹¦é¦†å€Ÿä¹¦ï¼šå¤šä¸ªäººåŒæ—¶çœ‹åŒä¸€æœ¬ä¹¦æ²¡é—®é¢˜ï¼ˆè¯»è¯»ä¸äº’æ–¥ï¼‰ã€‚å¦‚æœæœ‰äººè¦åœ¨ä¹¦ä¸Šå†™ç¬”è®°ï¼ˆå†™æ“ä½œï¼‰ï¼Œé‚£å¿…é¡»ç‹¬å è¿™æœ¬ä¹¦ï¼Œåˆ«äººä¸èƒ½å†çœ‹ï¼ˆè¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ï¼‰ã€‚\n2.4 æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ æ›´æ–°æ•°æ®åº“åï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ›´æ–°äº‹ä»¶ï¼Œæ¶ˆè´¹è€…è®¢é˜…åæ›´æ–°ç¼“å­˜ã€‚\nä»£ç å®ç° ç”Ÿäº§è€…ï¼ˆæ›´æ–°æ•°æ®åº“åå‘é€æ¶ˆæ¯ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 @Service public class UserServiceWithMQ { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RabbitTemplate rabbitTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String USER_UPDATE_QUEUE = \u0026#34;user.update.queue\u0026#34;; private static final String USER_DELETE_QUEUE = \u0026#34;user.delete.queue\u0026#34;; /** * æ›´æ–°ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ */ @Transactional public boolean updateUserWithMQ(User user) { try { // 1. æ›´æ–°æ•°æ®åº“ int result = userMapper.updateById(user); if (result \u0026lt;= 0) { return false; } // 2. å‘é€æ›´æ–°æ¶ˆæ¯ UserUpdateEvent event = new UserUpdateEvent(); event.setUserId(user.getId()); event.setOperation(\u0026#34;UPDATE\u0026#34;); event.setTimestamp(System.currentTimeMillis()); rabbitTemplate.convertAndSend(USER_UPDATE_QUEUE, event); log.info(\u0026#34;å‘é€ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); return true; } catch (Exception e) { log.error(\u0026#34;æ›´æ–°ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId(), e); throw new RuntimeException(\u0026#34;æ›´æ–°ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } /** * åˆ é™¤ç”¨æˆ·å¹¶å‘é€æ¶ˆæ¯ */ @Transactional public boolean deleteUserWithMQ(Long userId) { try { // 1. åˆ é™¤æ•°æ®åº“è®°å½• int result = userMapper.deleteById(userId); if (result \u0026lt;= 0) { return false; } // 2. å‘é€åˆ é™¤æ¶ˆæ¯ UserDeleteEvent event = new UserDeleteEvent(); event.setUserId(userId); event.setOperation(\u0026#34;DELETE\u0026#34;); event.setTimestamp(System.currentTimeMillis()); rabbitTemplate.convertAndSend(USER_DELETE_QUEUE, event); log.info(\u0026#34;å‘é€ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); return true; } catch (Exception e) { log.error(\u0026#34;åˆ é™¤ç”¨æˆ·å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); throw new RuntimeException(\u0026#34;åˆ é™¤ç”¨æˆ·å¤±è´¥\u0026#34;, e); } } } // äº‹ä»¶ç±» @Data public class UserUpdateEvent { private Long userId; private String operation; private Long timestamp; } @Data public class UserDeleteEvent { private Long userId; private String operation; private Long timestamp; } æ¶ˆè´¹è€…ï¼ˆå¤„ç†æ¶ˆæ¯å¹¶æ›´æ–°ç¼“å­˜ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component public class UserCacheConsumer { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; /** * å¤„ç†ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;user.update.queue\u0026#34;) public void handleUserUpdate(UserUpdateEvent event) { try { log.info(\u0026#34;æ”¶åˆ°ç”¨æˆ·æ›´æ–°æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); // 1. æŸ¥è¯¢æœ€æ–°æ•°æ® User user = userMapper.selectById(event.getUserId()); if (user != null) { // 2. æ›´æ–°ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;ç¼“å­˜æ›´æ–°æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } else { // 3. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + event.getUserId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ é™¤ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); } } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç”¨æˆ·æ›´æ–°æ¶ˆæ¯å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId(), e); // è¿™é‡Œå¯ä»¥å®ç°é‡è¯•æœºåˆ¶æˆ–æ­»ä¿¡é˜Ÿåˆ— } } /** * å¤„ç†ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ */ @RabbitListener(queues = \u0026#34;user.delete.queue\u0026#34;) public void handleUserDelete(UserDeleteEvent event) { try { log.info(\u0026#34;æ”¶åˆ°ç”¨æˆ·åˆ é™¤æ¶ˆæ¯ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); // åˆ é™¤ç¼“å­˜ String cacheKey = USER_CACHE_PREFIX + event.getUserId(); redisTemplate.delete(cacheKey); log.info(\u0026#34;ç¼“å­˜åˆ é™¤æˆåŠŸï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†ç”¨æˆ·åˆ é™¤æ¶ˆæ¯å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, event.getUserId(), e); } } } ä¼˜ç‚¹ æ•°æ®åº“ä¸ç¼“å­˜è§£è€¦ï¼Œä¿è¯å¼‚æ­¥æœ€ç»ˆä¸€è‡´æ€§ èƒ½æ‰¿å—æ›´é«˜çš„å¹¶å‘é‡ ç¼ºç‚¹ å¼•å…¥ MQ å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ æ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤æ¶ˆè´¹éœ€è¦é¢å¤–å¤„ç† é€šä¿—ç±»æ¯” ä½ æ¬å®¶äº†ï¼Œå…ˆåœ¨ç³»ç»Ÿé‡Œæ”¹äº†åœ°å€ï¼ˆæ•°æ®åº“ï¼‰ã€‚ç³»ç»Ÿå‘äº†ä¸€æ¡é€šçŸ¥ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œå‘Šè¯‰å¿«é€’å…¬å¸æ›´æ–°æ”¶ä»¶åœ°å€ï¼ˆç¼“å­˜ï¼‰ã€‚\n2.5 åŸºäº Binlog çš„ Canal åŒæ­¥ é€šè¿‡ç›‘å¬ MySQL çš„ Binlogï¼Œæ•è·æ•°æ®å˜æ›´äº‹ä»¶ï¼Œç„¶åæ›´æ–° Redisã€‚\næµç¨‹ MySQL å¼€å¯ Binlog Canal ä½œä¸ºä»åº“ä¼ªè£…ï¼Œè®¢é˜… Binlog Binlog é‡Œè®°å½•äº† INSERT/UPDATE/DELETE Canal è§£æäº‹ä»¶å¹¶å›å†™ Redis ä»£ç å®ç° Canal é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # canal.properties canal.port = 11111 canal.metrics.pull.port = 11112 canal.zkServers = localhost:2181 # å®ä¾‹é…ç½® canal.destinations = example canal.conf.dir = /opt/canal/conf canal.instance.global.master.address = 127.0.0.1:3306 canal.instance.global.master.journal.name = canal.instance.global.master.position = canal.instance.global.master.timestamp = canal.instance.global.master.gtid = canal.instance.dbUsername = canal canal.instance.dbPassword = canal canal.instance.connectionCharset = UTF-8 canal.instance.filter.regex = .*\\\\..* canal.instance.master.address = 127.0.0.1:3306 canal.instance.master.journal.name = canal.instance.master.position = canal.instance.master.timestamp = canal.instance.master.gtid = Canal å®¢æˆ·ç«¯ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 @Component public class CanalClient { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String USER_TABLE = \u0026#34;t_user\u0026#34;; @PostConstruct public void startCanalClient() { // åˆ›å»ºCanalè¿æ¥ CanalConnector connector = CanalConnectors.newSingleConnector( new InetSocketAddress(\u0026#34;127.0.0.1\u0026#34;, 11111), \u0026#34;example\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34; ); try { connector.connect(); connector.subscribe(\u0026#34;.*\\\\..*\u0026#34;); connector.rollback(); while (true) { Message message = connector.getWithoutAck(1000); long batchId = message.getBatchId(); int size = message.getEntries().size(); if (batchId == -1 || size == 0) { Thread.sleep(1000); } else { printEntry(message.getEntries()); connector.ack(batchId); } } } catch (Exception e) { log.error(\u0026#34;Canalå®¢æˆ·ç«¯å¼‚å¸¸\u0026#34;, e); } finally { connector.disconnect(); } } private void printEntry(List\u0026lt;Entry\u0026gt; entries) { for (Entry entry : entries) { if (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) { continue; } RowChange rowChange = null; try { rowChange = RowChange.parseFrom(entry.getStoreValue()); } catch (Exception e) { throw new RuntimeException(\u0026#34;è§£æbinlogå¼‚å¸¸\u0026#34;, e); } EventType eventType = rowChange.getEventType(); String tableName = entry.getHeader().getTableName(); // åªå¤„ç†ç”¨æˆ·è¡¨ if (!USER_TABLE.equals(tableName)) { continue; } for (RowData rowData : rowChange.getRowDatasList()) { if (eventType == EventType.DELETE) { handleDelete(rowData.getBeforeColumnsList()); } else if (eventType == EventType.INSERT) { handleInsert(rowData.getAfterColumnsList()); } else if (eventType == EventType.UPDATE) { handleUpdate(rowData.getAfterColumnsList()); } } } } private void handleInsert(List\u0026lt;Column\u0026gt; columns) { try { User user = buildUserFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;CanalåŒæ­¥æ–°å¢ç”¨æˆ·åˆ°ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ–°å¢ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private void handleUpdate(List\u0026lt;Column\u0026gt; columns) { try { User user = buildUserFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + user.getId(); redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES); log.info(\u0026#34;CanalåŒæ­¥æ›´æ–°ç”¨æˆ·åˆ°ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, user.getId()); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ›´æ–°ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private void handleDelete(List\u0026lt;Column\u0026gt; columns) { try { Long userId = getUserIdFromColumns(columns); String cacheKey = USER_CACHE_PREFIX + userId; redisTemplate.delete(cacheKey); log.info(\u0026#34;CanalåŒæ­¥åˆ é™¤ç”¨æˆ·ç¼“å­˜ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId); } catch (Exception e) { log.error(\u0026#34;å¤„ç†åˆ é™¤ç”¨æˆ·å¼‚å¸¸\u0026#34;, e); } } private User buildUserFromColumns(List\u0026lt;Column\u0026gt; columns) { User user = new User(); for (Column column : columns) { String name = column.getName(); String value = column.getValue(); switch (name) { case \u0026#34;id\u0026#34;: user.setId(Long.valueOf(value)); break; case \u0026#34;username\u0026#34;: user.setUsername(value); break; case \u0026#34;email\u0026#34;: user.setEmail(value); break; case \u0026#34;phone\u0026#34;: user.setPhone(value); break; case \u0026#34;create_time\u0026#34;: user.setCreateTime(LocalDateTime.parse(value)); break; case \u0026#34;update_time\u0026#34;: user.setUpdateTime(LocalDateTime.parse(value)); break; } } return user; } private Long getUserIdFromColumns(List\u0026lt;Column\u0026gt; columns) { for (Column column : columns) { if (\u0026#34;id\u0026#34;.equals(column.getName())) { return Long.valueOf(column.getValue()); } } return null; } } ä¼˜ç‚¹ æ•°æ®åº“æ˜¯æœ€ç»ˆæ•°æ®æºï¼ŒCanal ä¿è¯æ•°æ®åº“å’Œç¼“å­˜é«˜åº¦ä¸€è‡´ é€‚åˆå¼ºä¸€è‡´æ€§ã€è¯»å†™é¢‘ç¹çš„åœºæ™¯ ç¼ºç‚¹ Canal éƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ å®æ—¶æ€§å–å†³äº Binlog è§£æå’Œæ¶ˆè´¹é€Ÿåº¦ é€šä¿—ç±»æ¯” å°±åƒä½ ç»™å®¶é‡Œè£…äº†ä¸€ä¸ªç›‘æ§ï¼ˆCanalï¼‰ï¼Œæ¯æ¬¡æœ‰äººå¼€é—¨æ¢é”ï¼ˆæ•°æ®åº“æ›´æ–°ï¼‰ï¼Œç›‘æ§ç«‹åˆ»é€šçŸ¥ä¿å®‰ï¼ˆRedis æ›´æ–°ï¼‰ã€‚\nä¸‰ã€æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“ æ–¹æ¡ˆ ä¸€è‡´æ€§ æ€§èƒ½ å¤æ‚åº¦ é€‚ç”¨åœºæ™¯ Cache Aside å¼±ä¸€è‡´æ€§ é«˜ ä½ è¯»å¤šå†™å°‘ï¼Œæ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´ å»¶æ—¶åŒåˆ  è¾ƒå¼ºä¸€è‡´æ€§ ä¸­ ä¸­ èƒ½å®¹å¿çŸ­å»¶è¿Ÿï¼Œå†™è¯·æ±‚è¾ƒå¤šæ—¶ åŠ é”ç­–ç•¥ å¼ºä¸€è‡´æ€§ ä½ ä¸­ é‡‘èã€ç”µå•†ç­‰å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ æœ€ç»ˆä¸€è‡´æ€§ é«˜ é«˜ é«˜å¹¶å‘ã€å¼‚æ­¥åœºæ™¯ Canal Binlog åŒæ­¥ å‡†å®æ—¶å¼ºä¸€è‡´æ€§ ä¸­ é«˜ æ ¸å¿ƒä¸šåŠ¡ï¼Œå¼ºä¸€è‡´è¦æ±‚ å››ã€æœ€ä½³å®è·µå»ºè®® è¯»å¤šå†™å°‘ï¼Œæ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´ â†’ ä½¿ç”¨ Cache Aside é«˜å¹¶å‘å†™åœºæ™¯ â†’ å»¶æ—¶åŒåˆ  + åˆç†æ—¶é—´çª—å£ é‡‘èã€äº¤æ˜“ä¸šåŠ¡ â†’ åˆ†å¸ƒå¼è¯»å†™é”ï¼Œä¿è¯å¼ºä¸€è‡´æ€§ é«˜å¯æ‰©å±•ã€é«˜å¹¶å‘ â†’ æ•°æ®åº“å†™ + MQ å¼‚æ­¥æ›´æ–°ç¼“å­˜ ä¼ä¸šçº§æ ¸å¿ƒä¸šåŠ¡ â†’ Binlog + Canalï¼Œä¿è¯æ•°æ®åº“ä¸ç¼“å­˜å®æ—¶åŒæ­¥ äº”ã€å®é™…é¡¹ç›®ä¸­çš„ç»¼åˆæ–¹æ¡ˆ åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¾€å¾€éœ€è¦æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 @Service public class UserServiceComprehensive { @Autowired private UserMapper userMapper; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RedissonClient redissonClient; @Autowired private RabbitTemplate rabbitTemplate; private static final String USER_CACHE_PREFIX = \u0026#34;user:\u0026#34;; private static final String LOCK_PREFIX = \u0026#34;lock:user:\u0026#34;; /** * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„ç¼“å­˜ç­–ç•¥ */ public User getUser(Long userId, CacheStrategy strategy) { switch (strategy) { case CACHE_ASIDE: return getUserWithCacheAside(userId); case READ_WRITE_LOCK: return getUserWithReadWriteLock(userId); case MQ_SYNC: return getUserWithMQSync(userId); default: return getUserWithCacheAside(userId); } } /** * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„æ›´æ–°ç­–ç•¥ */ public boolean updateUser(User user, CacheStrategy strategy) { switch (strategy) { case CACHE_ASIDE: return updateUserWithCacheAside(user); case DELAY_DOUBLE_DELETE: return updateUserWithDelayDoubleDelete(user); case READ_WRITE_LOCK: return updateUserWithReadWriteLock(user); case MQ_SYNC: return updateUserWithMQSync(user); default: return updateUserWithCacheAside(user); } } // å„ç§ç­–ç•¥çš„å…·ä½“å®ç°... } enum CacheStrategy { CACHE_ASIDE, // æ—è·¯ç¼“å­˜ DELAY_DOUBLE_DELETE, // å»¶æ—¶åŒåˆ  READ_WRITE_LOCK, // è¯»å†™é” MQ_SYNC, // æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ CANAL_SYNC // CanalåŒæ­¥ } å…­ã€ç›‘æ§å’Œå‘Šè­¦ ä¸ºäº†ä¿è¯ç¼“å­˜ä¸€è‡´æ€§ï¼Œè¿˜éœ€è¦å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 @Component public class CacheConsistencyMonitor { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private UserMapper userMapper; /** * å®šæœŸæ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§ */ @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ public void checkCacheConsistency() { // éšæœºæŠ½æ ·æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§ List\u0026lt;Long\u0026gt; userIds = getRandomUserIds(100); for (Long userId : userIds) { try { // 1. æŸ¥è¯¢æ•°æ®åº“ User dbUser = userMapper.selectById(userId); // 2. æŸ¥è¯¢ç¼“å­˜ String cacheKey = \u0026#34;user:\u0026#34; + userId; User cacheUser = (User) redisTemplate.opsForValue().get(cacheKey); // 3. æ¯”è¾ƒæ•°æ® if (dbUser != null \u0026amp;\u0026amp; cacheUser != null) { if (!Objects.equals(dbUser.getUsername(), cacheUser.getUsername()) || !Objects.equals(dbUser.getEmail(), cacheUser.getEmail())) { // æ•°æ®ä¸ä¸€è‡´ï¼Œè®°å½•å‘Šè­¦ log.warn(\u0026#34;å‘ç°ç¼“å­˜ä¸ä¸€è‡´ï¼Œç”¨æˆ·ID: {}, æ•°æ®åº“: {}, ç¼“å­˜: {}\u0026#34;, userId, dbUser, cacheUser); // ä¿®å¤ç¼“å­˜ redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES); } } } catch (Exception e) { log.error(\u0026#34;æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§å¼‚å¸¸ï¼Œç”¨æˆ·ID: {}\u0026#34;, userId, e); } } } private List\u0026lt;Long\u0026gt; getRandomUserIds(int count) { // å®ç°éšæœºè·å–ç”¨æˆ·IDçš„é€»è¾‘ return userMapper.selectRandomUserIds(count); } } ä¸ƒã€ç»“è¯­ æ•°æ®åº“ä¸ Redis çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ å¦‚ä½•å¤„ç†\u0026quot;ä¸¤ä¸ªå‰¯æœ¬æ•°æ®çš„ä¸åŒæ­¥\u0026quot;ã€‚\næ²¡æœ‰ä¸€ç§ä¸‡èƒ½æ–¹æ¡ˆï¼Œéœ€è¦ç»“åˆä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©ï¼š\næ€§èƒ½ä¼˜å…ˆ â†’ Cache Aside ä¸€è‡´æ€§ä¼˜å…ˆ â†’ åŠ é” / Canal æŠ˜ä¸­ â†’ å»¶æ—¶åŒåˆ  / MQ åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œå¾€å¾€æ˜¯ å¤šç§æ–¹æ¡ˆç»“åˆ ä½¿ç”¨ï¼Œæ‰èƒ½æ—¢ä¿è¯æ€§èƒ½ï¼Œåˆä¿è¯æ•°æ®å¯é ã€‚\né€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œä»£ç ç¤ºä¾‹ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯ã€æ€§èƒ½è¦æ±‚ã€ä¸€è‡´æ€§è¦æ±‚æ¥é€‰æ‹©æœ€é€‚åˆçš„æ–¹æ¡ˆï¼Œå¹¶åœ¨å¿…è¦æ—¶ç»“åˆå¤šç§ç­–ç•¥æ¥å®ç°æœ€ä½³æ•ˆæœã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†æ•°æ®åº“ä¸RedisåŒå†™ä¸€è‡´æ€§é—®é¢˜çš„å„ç§è§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºæ­£ç¡®çš„æŠ€æœ¯é€‰æ‹©ã€‚\n","date":"2025-08-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E-redis-%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E5%85%A8%E8%A7%A3%E6%9E%90/","title":"æ•°æ®åº“ä¸ Redis åŒå†™ä¸€è‡´æ€§é—®é¢˜å…¨è§£æ"},{"content":"Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof åœ¨å¼€å‘ Java Web é¡¹ç›®æ—¶ï¼Œç»å¸¸ä¼šç”¨åˆ° JWT é‰´æƒã€æ‹¦æˆªå™¨ä»¥åŠè¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†ã€‚æœ¬æ–‡ç»“åˆä¸€ä¸ªå’–å•¡è´­ç‰©è½¦é¡¹ç›®ï¼Œè¯¦ç»†è®²è§£ç›¸å…³æ¦‚å¿µå’Œä»£ç å®ç°ã€‚\nğŸ“‹ ç›®å½• HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ æ³¨é‡Šè§£æï¼š\u0026ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID\u0026rdquo; JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£ Long userId = Long.valueOf(claims.get(\u0026ldquo;userId\u0026rdquo;).toString()); è§£æ BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³• instanceof æ˜¯ä»€ä¹ˆï¼Ÿ å®Œæ•´é¡¹ç›®å®æˆ˜ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„ 1. HttpServletRequest æ˜¯ä»€ä¹ˆï¼Ÿ HttpServletRequest æ˜¯ Java Servlet API æä¾›çš„æ¥å£ï¼Œç”¨æ¥å°è£…å®¢æˆ·ç«¯å‘ç»™æœåŠ¡å™¨çš„è¯·æ±‚ä¿¡æ¯ã€‚\nğŸ”§ æ ¸å¿ƒåŠŸèƒ½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // è·å–è¯·æ±‚æ–¹å¼ã€è·¯å¾„ request.getMethod() // GET / POST request.getRequestURI() // /cart/list // è·å–è¯·æ±‚å¤´ request.getHeader(\u0026#34;Authorization\u0026#34;) request.getHeader(\u0026#34;User-Agent\u0026#34;) // è·å–è¯·æ±‚å‚æ•° request.getParameter(\u0026#34;name\u0026#34;) request.getParameterMap() // è·å–è¯·æ±‚ä½“ï¼ˆPOST JSON æˆ–è¡¨å•ï¼‰ request.getReader() // è·å–å®¢æˆ·ç«¯ä¿¡æ¯ request.getRemoteAddr() // IPåœ°å€ request.getHeader(\u0026#34;User-Agent\u0026#34;) // æµè§ˆå™¨ä¿¡æ¯ // è·å–ä¼šè¯ä¿¡æ¯ request.getSession() ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯ åœ¨æˆ‘ä»¬çš„å’–å•¡é¡¹ç›®ä¸­ï¼ŒHttpServletRequest ä¸»è¦ç”¨äºï¼š\nJWT Token è·å–ï¼šä» Authorization è¯·æ±‚å¤´ä¸­æå– JWT Token ç”¨æˆ·èº«ä»½è¯†åˆ«ï¼šè§£æ Token è·å–ç”¨æˆ· ID è¯·æ±‚æ—¥å¿—è®°å½•ï¼šè®°å½•å®¢æˆ·ç«¯ IPã€User-Agent ç­‰ä¿¡æ¯ è·¨åŸŸå¤„ç†ï¼šè·å– Origin è¯·æ±‚å¤´è¿›è¡Œè·¨åŸŸéªŒè¯ 2. Controller æ–¹æ³•ä¸ºä»€ä¹ˆæœ‰æ—¶éœ€è¦ HttpServletRequestï¼Ÿ âœ… ä¸éœ€è¦ HttpServletRequest çš„æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @RestController @RequestMapping(\u0026#34;/products\u0026#34;) public class ProductController { // åªéœ€è¦ä¸šåŠ¡å‚æ•°ï¼ŒSpring è‡ªåŠ¨ç»‘å®š @GetMapping(\u0026#34;/{id}\u0026#34;) public Result\u0026lt;Product\u0026gt; getProduct(@PathVariable Long id) { return productService.getById(id); } @PostMapping public Result\u0026lt;String\u0026gt; createProduct(@RequestBody ProductDTO productDTO) { return productService.create(productDTO); } } âŒ éœ€è¦ HttpServletRequest çš„æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @RestController @RequestMapping(\u0026#34;/user\u0026#34;) public class UserController { @Autowired private JwtProperties jwtProperties; /** * éœ€è¦è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ */ @GetMapping(\u0026#34;/profile\u0026#34;) public Result\u0026lt;UserProfile\u0026gt; getProfile(HttpServletRequest request) { // ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID Long userId = getCurrentUserId(request); return userService.getProfile(userId); } /** * ä»è¯·æ±‚ä¸­è·å–å½“å‰ç”¨æˆ·ID */ private Long getCurrentUserId(HttpServletRequest request) { String token = request.getHeader(\u0026#34;Authorization\u0026#34;); if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { token = token.substring(7); } try { Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); return Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); } catch (Exception e) { log.error(\u0026#34;è§£ætokenå¤±è´¥\u0026#34;, e); throw new RuntimeException(\u0026#34;æ— æ•ˆçš„token\u0026#34;); } } } ğŸ¯ ä½¿ç”¨åœºæ™¯æ€»ç»“ åœºæ™¯ æ˜¯å¦éœ€è¦ HttpServletRequest åŸå›  è·å–è¯·æ±‚å¤´ä¿¡æ¯ âœ… éœ€è¦ å¦‚ JWT Tokenã€User-Agent è·å–å®¢æˆ·ç«¯ IP âœ… éœ€è¦ å®‰å…¨å®¡è®¡ã€é™æµ è·å– Session ä¿¡æ¯ âœ… éœ€è¦ ä¼šè¯ç®¡ç† è·å– Cookie âœ… éœ€è¦ çŠ¶æ€ä¿æŒ çº¯ä¸šåŠ¡å‚æ•°å¤„ç† âŒ ä¸éœ€è¦ Spring è‡ªåŠ¨ç»‘å®š 3. æ³¨é‡Šè§£æï¼š\u0026ldquo;ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ID\u0026rdquo; ğŸ“ æ³¨é‡Šå«ä¹‰è§£æ 1 // ä»è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·IDï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„JWTå®ç°æ¥è·å–ï¼‰ è¿™ä¸ªæ³¨é‡Šçš„å«ä¹‰æ˜¯ï¼š\nç”¨æˆ·ç™»å½•æµç¨‹ï¼šç”¨æˆ·ç™»å½•åï¼Œå‰ç«¯ä¼šæ‹¿åˆ°ä¸€ä¸ª JWT Token Token ä¼ é€’ï¼šå‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå°† Token æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼ˆAuthorization: Bearer \u0026lt;token\u0026gt;ï¼‰ åç«¯è§£æï¼šåç«¯è§£æ JWT Token è·å– userId æ³¨é‡Šè¯´æ˜ï¼šç›®å‰ä»£ç ç›´æ¥ä»è¯·æ±‚å¤´å– userIdï¼Œåœ¨çœŸå®é¡¹ç›®ä¸­è¦è§£æ JWT Token ğŸ”„ å®Œæ•´æµç¨‹ç¤ºæ„ æ–¹æ¡ˆ1ï¼šASCIIæµç¨‹å›¾ï¼ˆHugoå…¼å®¹ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å‰ç«¯ â”‚â”€â”€â”€â–¶â”‚ åç«¯ â”‚â”€â”€â”€â–¶â”‚ JWTå·¥å…· â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ 1.ç™»å½•è¯·æ±‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ 2.ç”ŸæˆToken â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ 3.è¿”å›Token â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ 4.è¿”å›Token â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”‚ â”‚ å­˜å‚¨åˆ°localStorage â”‚ â”‚ â”‚ â”‚ â”‚ 5.ä¸šåŠ¡è¯·æ±‚+Token â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ 6.è§£æToken â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ 7.è¿”å›Claims â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ 8.æå–userId â”‚ â”‚ â”‚ â”‚ â”‚ 9.è¿”å›ä¸šåŠ¡æ•°æ®â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ æ–¹æ¡ˆ2ï¼šä»£ç å—å½¢å¼ï¼ˆæ¨èï¼‰ 1 2 3 4 5 6 7 8 9 10 11 JWTè®¤è¯æµç¨‹ï¼š 1. å‰ç«¯å‘é€ç™»å½•è¯·æ±‚ 2. åç«¯éªŒè¯ç”¨æˆ·ä¿¡æ¯ 3. åç«¯ç”ŸæˆJWT Token 4. åç«¯è¿”å›Tokenç»™å‰ç«¯ 5. å‰ç«¯å­˜å‚¨Tokenåˆ°localStorage 6. å‰ç«¯å‘é€ä¸šåŠ¡è¯·æ±‚ï¼ˆæºå¸¦Authorizationå¤´ï¼‰ 7. åç«¯æ‹¦æˆªå™¨è§£æJWT Token 8. åç«¯ä»Tokenä¸­æå–ç”¨æˆ·ID 9. åç«¯æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 10. åç«¯è¿”å›ä¸šåŠ¡æ•°æ® 4. JwtTokenUserInterceptor æ‹¦æˆªå™¨è¯¦è§£ ğŸ—ï¸ å®Œæ•´æ‹¦æˆªå™¨å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 @Component @Slf4j public class JwtTokenUserInterceptor implements HandlerInterceptor { @Autowired private JwtProperties jwtProperties; /** * è¯·æ±‚å¤„ç†å‰çš„æ‹¦æˆªé€»è¾‘ */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // 1. åˆ¤æ–­å½“å‰æ‹¦æˆªåˆ°çš„æ˜¯Controllerçš„æ–¹æ³•è¿˜æ˜¯å…¶ä»–èµ„æº if (!(handler instanceof HandlerMethod)) { // å½“å‰æ‹¦æˆªåˆ°çš„ä¸æ˜¯åŠ¨æ€æ–¹æ³•ï¼Œç›´æ¥æ”¾è¡Œï¼ˆé™æ€èµ„æºç­‰ï¼‰ return true; } // 2. ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ String token = request.getHeader(jwtProperties.getUserTokenName()); log.info(\u0026#34;è¯·æ±‚å¤´åç§°: {}\u0026#34;, jwtProperties.getUserTokenName()); log.info(\u0026#34;Authorizationå¤´: {}\u0026#34;, request.getHeader(\u0026#34;Authorization\u0026#34;)); // 3. å»æ‰Bearerå‰ç¼€ if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { token = token.substring(7); } // 4. æ ¡éªŒä»¤ç‰Œ try { log.info(\u0026#34;JWTæ ¡éªŒ: {}\u0026#34;, token); Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); Long userId = Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); log.info(\u0026#34;å½“å‰ç”¨æˆ·IDï¼š{}\u0026#34;, userId); // 5. å°†ç”¨æˆ·IDå­˜å‚¨åˆ°ThreadLocalä¸­ BaseContext.setCurrentId(userId); // 6. é€šè¿‡ï¼Œæ”¾è¡Œ return true; } catch (Exception ex) { log.error(\u0026#34;JWTæ ¡éªŒå¤±è´¥: {}\u0026#34;, ex.getMessage()); // 7. ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç  response.setStatus(401); return false; } } } ğŸ” ä»£ç é€è¡Œè§£æ æ­¥éª¤1ï¼šåˆ¤æ–­è¯·æ±‚ç±»å‹ 1 2 3 if (!(handler instanceof HandlerMethod)) { return true; // é™æ€èµ„æºç›´æ¥æ”¾è¡Œ } ç›®çš„ï¼šåŒºåˆ† Controller æ–¹æ³•å’Œé™æ€èµ„æºè¯·æ±‚ åŸç†ï¼šSpring MVC ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ª handler æ¥å¤„ç† HandlerMethodï¼šController æ–¹æ³•çš„å¤„ç†å™¨ ResourceHttpRequestHandlerï¼šé™æ€èµ„æºçš„å¤„ç†å™¨ æ­¥éª¤2ï¼šè·å– JWT Token 1 String token = request.getHeader(jwtProperties.getUserTokenName()); é…ç½®åŒ–ï¼šé€šè¿‡ JwtProperties ç®¡ç†è¯·æ±‚å¤´åç§° çµæ´»æ€§ï¼šå¯ä»¥é…ç½®ä¸åŒçš„è¯·æ±‚å¤´åç§°ï¼ˆå¦‚ Authorizationã€X-Token ç­‰ï¼‰ æ­¥éª¤3ï¼šå¤„ç† Bearer å‰ç¼€ 1 2 3 if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { token = token.substring(7); } æ ‡å‡†æ ¼å¼ï¼šJWT Token é€šå¸¸ä»¥ Bearer å‰ç¼€ä¼ è¾“ å®‰å…¨è€ƒè™‘ï¼šæ˜ç¡®æ ‡è¯† Token ç±»å‹ï¼Œé¿å…ä¸å…¶ä»–è®¤è¯æ–¹å¼æ··æ·† æ­¥éª¤4ï¼šJWT è§£æä¸éªŒè¯ 1 2 Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); Long userId = Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); ç­¾åéªŒè¯ï¼šä½¿ç”¨ç›¸åŒçš„å¯†é’¥éªŒè¯ Token ç­¾å è¿‡æœŸæ£€æŸ¥ï¼šJWT åº“ä¼šè‡ªåŠ¨æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ Claims æå–ï¼šä» JWT è½½è·ä¸­æå–ç”¨æˆ·ä¿¡æ¯ æ­¥éª¤5ï¼šä¸Šä¸‹æ–‡å­˜å‚¨ 1 BaseContext.setCurrentId(userId); ThreadLocalï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ é¿å…ä¼ å‚ï¼šController å’Œ Service å±‚å¯ä»¥ç›´æ¥è·å–å½“å‰ç”¨æˆ· ID 5. Long userId = Long.valueOf(claims.get(\u0026ldquo;userId\u0026rdquo;).toString()); è§£æ ğŸ”„ ç±»å‹è½¬æ¢è¿‡ç¨‹ 1 2 3 4 // æ­¥éª¤åˆ†è§£ Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); // 1. ä»Claimsä¸­è·å–userIdï¼ˆObjectç±»å‹ï¼‰ String userIdStr = userIdObj.toString(); // 2. è½¬æˆå­—ç¬¦ä¸² Long userId = Long.valueOf(userIdStr); // 3. è½¬æˆLongå¯¹è±¡ âš ï¸ æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ é—®é¢˜1ï¼šç±»å‹è½¬æ¢å¼‚å¸¸ 1 2 // å¯èƒ½æŠ›å‡º NumberFormatException Long userId = Long.valueOf(claims.get(\u0026#34;userId\u0026#34;).toString()); è§£å†³æ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // å®‰å…¨çš„ç±»å‹è½¬æ¢ public static Long getUserIdSafely(Claims claims) { try { Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ·IDä¸èƒ½ä¸ºç©º\u0026#34;); } return Long.valueOf(userIdObj.toString()); } catch (NumberFormatException e) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ·IDæ ¼å¼é”™è¯¯: \u0026#34; + userIdObj); } } é—®é¢˜2ï¼šç©ºå€¼å¤„ç† 1 2 3 4 5 // æ£€æŸ¥ç©ºå€¼ Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;JWTä¸­ç¼ºå°‘ç”¨æˆ·ID\u0026#34;); } ğŸ¯ æœ€ä½³å®è·µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * å®‰å…¨åœ°ä»Claimsä¸­è·å–ç”¨æˆ·ID */ private Long extractUserId(Claims claims) { Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;JWTä¸­ç¼ºå°‘ç”¨æˆ·ID\u0026#34;); } try { return Long.valueOf(userIdObj.toString()); } catch (NumberFormatException e) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ·IDæ ¼å¼é”™è¯¯: \u0026#34; + userIdObj); } } 6. BaseContext æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ—ï¸ BaseContext å®Œæ•´å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 /** * åŸºäºThreadLocalå°è£…å·¥å…·ç±»ï¼Œç”¨äºä¿å­˜å’Œè·å–å½“å‰ç™»å½•ç”¨æˆ·ID */ public class BaseContext { private static ThreadLocal\u0026lt;Long\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); /** * è®¾ç½®å½“å‰ç”¨æˆ·ID * @param id ç”¨æˆ·ID */ public static void setCurrentId(Long id) { threadLocal.set(id); } /** * è·å–å½“å‰ç”¨æˆ·ID * @return ç”¨æˆ·ID */ public static Long getCurrentId() { return threadLocal.get(); } /** * åˆ é™¤å½“å‰ç”¨æˆ·IDï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰ */ public static void removeCurrentId() { threadLocal.remove(); } } ğŸ§µ ThreadLocal åŸç† ä¸ºä»€ä¹ˆä½¿ç”¨ ThreadLocalï¼Ÿ çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ é¿å…ä¼ å‚ï¼šä¸éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸­ä¼ é€’ç”¨æˆ· ID ä»£ç ç®€æ´ï¼šController å’Œ Service å±‚å¯ä»¥ç›´æ¥è·å–å½“å‰ç”¨æˆ· ThreadLocal å†…å­˜æ¨¡å‹ 1 2 3 è¯·æ±‚çº¿ç¨‹1 â”€â”€â–¶ ThreadLocal Map â”€â”€â–¶ userId: 1001 è¯·æ±‚çº¿ç¨‹2 â”€â”€â–¶ ThreadLocal Map â”€â”€â–¶ userId: 1002 è¯·æ±‚çº¿ç¨‹3 â”€â”€â–¶ ThreadLocal Map â”€â”€â–¶ userId: 1003 ThreadLocalå·¥ä½œåŸç†ï¼š\næ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ThreadLocalå˜é‡å‰¯æœ¬ çº¿ç¨‹1çš„userId=1001ï¼Œçº¿ç¨‹2çš„userId=1002ï¼Œäº’ä¸å¹²æ‰° é€šè¿‡ThreadLocalå®ç°çº¿ç¨‹éš”ç¦»ï¼Œé¿å…å¹¶å‘é—®é¢˜ è¯·æ±‚ç»“æŸåéœ€è¦æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ ğŸ”§ å®é™…ä½¿ç”¨åœºæ™¯ Controller å±‚ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 @RestController @RequestMapping(\u0026#34;/admin\u0026#34;) public class AdminController { @GetMapping(\u0026#34;/info\u0026#34;) public Result\u0026lt;AdminLoginVO\u0026gt; info() { // ç›´æ¥è·å–å½“å‰ç™»å½•ç®¡ç†å‘˜IDï¼Œæ— éœ€ä¼ å‚ Long adminId = BaseContext.getCurrentId(); AdminLoginVO adminInfo = adminService.getById(adminId); return Result.success(adminInfo); } } Service å±‚ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 @Service public class OrderServiceImpl implements OrderService { @Override public Result\u0026lt;String\u0026gt; createOrder(OrderDTO orderDTO) { // ç›´æ¥è·å–å½“å‰ç”¨æˆ·ID Long userId = BaseContext.getCurrentId(); orderDTO.setUserId(userId); // ä¸šåŠ¡é€»è¾‘å¤„ç† return processOrder(orderDTO); } } âš ï¸ å†…å­˜æ³„æ¼é˜²æŠ¤ é—®é¢˜ï¼šThreadLocal å†…å­˜æ³„æ¼ 1 2 3 4 5 6 // é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰æ¸…ç†ThreadLocal public void processRequest() { BaseContext.setCurrentId(1001L); // å¤„ç†ä¸šåŠ¡é€»è¾‘ // å¿˜è®°è°ƒç”¨ removeCurrentId() } è§£å†³æ–¹æ¡ˆï¼šæ‹¦æˆªå™¨åå¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Component @Slf4j public class JwtTokenUserInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // JWTéªŒè¯é€»è¾‘... BaseContext.setCurrentId(userId); return true; } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { // è¯·æ±‚å®Œæˆåæ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ BaseContext.removeCurrentId(); } } 7. åˆ¤æ–­ handler æ˜¯å¦æ˜¯ Controller æ–¹æ³• ğŸ” HandlerMethod è¯¦è§£ 1 2 3 if (!(handler instanceof HandlerMethod)) { return true; // é™æ€èµ„æºç›´æ¥æ”¾è¡Œ } Spring MVC è¯·æ±‚å¤„ç†æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 å®¢æˆ·ç«¯è¯·æ±‚ â”‚ â–¼ DispatcherServlet â”‚ â–¼ HandlerMapping â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ è¯·æ±‚ç±»å‹åˆ¤æ–­ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”œâ”€â”€ Controlleræ–¹æ³• â”€â”€â–¶ HandlerMethod â”€â”€â–¶ æ‹¦æˆªå™¨é“¾ â”€â”€â–¶ Controlleræ–¹æ³•æ‰§è¡Œ â”€â”€â–¶ è¿”å›å“åº” â”‚ â”œâ”€â”€ é™æ€èµ„æº â”€â”€â–¶ ResourceHttpRequestHandler â”€â”€â–¶ ç›´æ¥å¤„ç† â”€â”€â–¶ è¿”å›èµ„æº â”€â”€â–¶ è¿”å›å“åº” â”‚ â””â”€â”€ å…¶ä»–èµ„æº â”€â”€â–¶ å…¶ä»–Handler â”€â”€â–¶ ç›´æ¥å¤„ç† â”€â”€â–¶ è¿”å›èµ„æº â”€â”€â–¶ è¿”å›å“åº” æµç¨‹è¯´æ˜ï¼š\nå®¢æˆ·ç«¯è¯·æ±‚ â†’ å‘é€HTTPè¯·æ±‚åˆ°æœåŠ¡å™¨ DispatcherServlet â†’ Spring MVCçš„æ ¸å¿ƒåˆ†å‘å™¨ HandlerMapping â†’ æ ¹æ®URLæ˜ å°„æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ è¯·æ±‚ç±»å‹åˆ¤æ–­ â†’ åŒºåˆ†ä¸åŒç±»å‹çš„è¯·æ±‚ HandlerMethod â†’ Controlleræ–¹æ³•å¤„ç†å™¨ï¼Œéœ€è¦JWTéªŒè¯ ResourceHttpRequestHandler â†’ é™æ€èµ„æºå¤„ç†å™¨ï¼Œç›´æ¥è¿”å› æ‹¦æˆªå™¨é“¾ â†’ æ‰§è¡ŒJWTéªŒè¯ç­‰æ‹¦æˆªé€»è¾‘ Controlleræ–¹æ³•æ‰§è¡Œ â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ è¿”å›å“åº” â†’ è¿”å›å¤„ç†ç»“æœç»™å®¢æˆ·ç«¯ HandlerMethod vs ResourceHttpRequestHandler ç±»å‹ ç”¨é€” ç¤ºä¾‹ HandlerMethod Controller æ–¹æ³• @GetMapping(\u0026quot;/users\u0026quot;) ResourceHttpRequestHandler é™æ€èµ„æº /static/css/style.css RequestMappingHandlerMapping è¯·æ±‚æ˜ å°„ é»˜è®¤çš„è¯·æ±‚å¤„ç†å™¨ ğŸ¯ å®é™…åº”ç”¨åœºæ™¯ åœºæ™¯1ï¼šåªæ‹¦æˆª Controller æ–¹æ³• 1 2 3 4 5 6 7 8 9 @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // åªå¯¹Controlleræ–¹æ³•è¿›è¡ŒJWTéªŒè¯ if (!(handler instanceof HandlerMethod)) { return true; // é™æ€èµ„æºã€å¥åº·æ£€æŸ¥ç­‰ç›´æ¥æ”¾è¡Œ } // JWTéªŒè¯é€»è¾‘... } åœºæ™¯2ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚ 1 2 3 4 5 6 7 8 9 10 11 @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String requestType = handler instanceof HandlerMethod ? \u0026#34;Controller\u0026#34; : \u0026#34;Static\u0026#34;; log.info(\u0026#34;è¯·æ±‚ç±»å‹: {}, è·¯å¾„: {}\u0026#34;, requestType, request.getRequestURI()); if (!(handler instanceof HandlerMethod)) { return true; } // å…¶ä»–é€»è¾‘... } 8. instanceof æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ”§ instanceof è¯­æ³•è¯¦è§£ instanceof æ˜¯ Java å…³é”®å­—ï¼Œç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯æŸä¸ªç±»æˆ–æ¥å£çš„å®ä¾‹ã€‚\nåŸºæœ¬è¯­æ³• 1 object instanceof ClassName è¿”å›å€¼ trueï¼šå¯¹è±¡æ˜¯æŒ‡å®šç±»æˆ–æ¥å£çš„å®ä¾‹ falseï¼šå¯¹è±¡ä¸æ˜¯æŒ‡å®šç±»æˆ–æ¥å£çš„å®ä¾‹ ğŸ“ å®é™…ç¤ºä¾‹ ç¤ºä¾‹1ï¼šåŸºæœ¬ç±»å‹åˆ¤æ–­ 1 2 3 4 5 // åŠ¨ç‰©ç±»å±‚æ¬¡ç»“æ„ Animal animal = new Dog(); System.out.println(animal instanceof Animal); // true System.out.println(animal instanceof Dog); // true System.out.println(animal instanceof Cat); // false ç¤ºä¾‹2ï¼šæ¥å£åˆ¤æ–­ 1 2 3 4 List\u0026lt;String\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(); System.out.println(list instanceof List); // true System.out.println(list instanceof ArrayList); // true System.out.println(list instanceof LinkedList); // false ç¤ºä¾‹3ï¼šnull å¤„ç† 1 2 String str = null; System.out.println(str instanceof String); // falseï¼ˆnull ä¸æ˜¯ä»»ä½•ç±»çš„å®ä¾‹ï¼‰ ğŸ¯ åœ¨æ‹¦æˆªå™¨ä¸­çš„åº”ç”¨ åˆ¤æ–­ Handler ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { if (handler instanceof HandlerMethod) { // Controller æ–¹æ³•å¤„ç† HandlerMethod handlerMethod = (HandlerMethod) handler; log.info(\u0026#34;Controller: {}, Method: {}\u0026#34;, handlerMethod.getBeanType().getSimpleName(), handlerMethod.getMethod().getName()); // JWT éªŒè¯é€»è¾‘ return validateJWT(request, response); } else if (handler instanceof ResourceHttpRequestHandler) { // é™æ€èµ„æºå¤„ç† log.info(\u0026#34;é™æ€èµ„æºè¯·æ±‚: {}\u0026#34;, request.getRequestURI()); return true; } else { // å…¶ä»–ç±»å‹å¤„ç† log.info(\u0026#34;å…¶ä»–ç±»å‹è¯·æ±‚: {}\u0026#34;, handler.getClass().getSimpleName()); return true; } } è·å–æ–¹æ³•ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 if (handler instanceof HandlerMethod) { HandlerMethod handlerMethod = (HandlerMethod) handler; // è·å– Controller ç±»å String controllerName = handlerMethod.getBeanType().getSimpleName(); // è·å–æ–¹æ³•å String methodName = handlerMethod.getMethod().getName(); // è·å–æ³¨è§£ä¿¡æ¯ RequestMapping mapping = handlerMethod.getMethodAnnotation(RequestMapping.class); log.info(\u0026#34;æ‰§è¡Œæ–¹æ³•: {}.{}\u0026#34;, controllerName, methodName); } 9. å®Œæ•´é¡¹ç›®å®æˆ˜ ğŸ—ï¸ é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 coffee-project/ â”œâ”€â”€ coffee-common/ # å…¬å…±æ¨¡å— â”‚ â”œâ”€â”€ src/main/java/com/coffee/ â”‚ â”‚ â”œâ”€â”€ context/ # ä¸Šä¸‹æ–‡ç®¡ç† â”‚ â”‚ â”‚ â””â”€â”€ BaseContext.java â”‚ â”‚ â”œâ”€â”€ properties/ # é…ç½®å±æ€§ â”‚ â”‚ â”‚ â””â”€â”€ JwtProperties.java â”‚ â”‚ â””â”€â”€ utils/ # å·¥å…·ç±» â”‚ â”‚ â””â”€â”€ JwtUtil.java â”‚ â””â”€â”€ pom.xml â”œâ”€â”€ coffee-server/ # æœåŠ¡ç«¯æ¨¡å— â”‚ â”œâ”€â”€ src/main/java/com/coffee/ â”‚ â”‚ â”œâ”€â”€ config/ # é…ç½®ç±» â”‚ â”‚ â”‚ â””â”€â”€ WebMvcConfiguration.java â”‚ â”‚ â”œâ”€â”€ interceptor/ # æ‹¦æˆªå™¨ â”‚ â”‚ â”‚ â”œâ”€â”€ JwtTokenAdminInterceptor.java â”‚ â”‚ â”‚ â””â”€â”€ JwtTokenUserInterceptor.java â”‚ â”‚ â””â”€â”€ controller/ # æ§åˆ¶å™¨ â”‚ â”‚ â”œâ”€â”€ admin/ # ç®¡ç†ç«¯ â”‚ â”‚ â””â”€â”€ user/ # ç”¨æˆ·ç«¯ â”‚ â””â”€â”€ src/main/resources/ â”‚ â””â”€â”€ application.yml # é…ç½®æ–‡ä»¶ â””â”€â”€ pom.xml âš™ï¸ é…ç½®æ–‡ä»¶ application.yml 1 2 3 4 5 6 7 8 9 10 11 coffee: jwt: # ç®¡ç†å‘˜JWTé…ç½® admin-secret-key: itcast admin-ttl: 7200000 # 2å°æ—¶ admin-token-name: Authorization # ç”¨æˆ·JWTé…ç½® user-secret-key: itcast user-ttl: 7200000 # 2å°æ—¶ user-token-name: Authorization JwtProperties.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 @Data @Component @ConfigurationProperties(prefix = \u0026#34;coffee.jwt\u0026#34;) public class JwtProperties { /** * ç®¡ç†å‘˜JWTç­¾åå¯†é’¥ */ private String adminSecretKey; /** * ç®¡ç†å‘˜JWTè¿‡æœŸæ—¶é—´(æ¯«ç§’) */ private Long adminTtl; /** * ç®¡ç†å‘˜ä»¤ç‰Œåç§° */ private String adminTokenName; /** * ç”¨æˆ·ä»¤ç‰Œåç§° */ private String userTokenName; /** * ç”¨æˆ·JWTç­¾åå¯†é’¥ */ private String userSecretKey; /** * ç”¨æˆ·JWTè¿‡æœŸæ—¶é—´(æ¯«ç§’) */ private Long userTtl; } ğŸ”§ æ‹¦æˆªå™¨é…ç½® WebMvcConfiguration.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Configuration @Slf4j public class WebMvcConfiguration implements WebMvcConfigurer { @Autowired private JwtTokenAdminInterceptor jwtTokenAdminInterceptor; /** * æ³¨å†Œæ‹¦æˆªå™¨ */ @Override public void addInterceptors(InterceptorRegistry registry) { log.info(\u0026#34;å¼€å§‹æ³¨å†Œè‡ªå®šä¹‰æ‹¦æˆªå™¨...\u0026#34;); // ç®¡ç†ç«¯æ‹¦æˆªå™¨ registry.addInterceptor(jwtTokenAdminInterceptor) .addPathPatterns(\u0026#34;/admin/**\u0026#34;) // æ‹¦æˆªç®¡ç†ç«¯æ‰€æœ‰è¯·æ±‚ .excludePathPatterns(\u0026#34;/admin/login\u0026#34;); // æ’é™¤ç™»å½•æ¥å£ } /** * è·¨åŸŸé…ç½® */ @Override public void addCorsMappings(CorsRegistry registry) { registry.addMapping(\u0026#34;/**\u0026#34;) .allowedOriginPatterns(\u0026#34;*\u0026#34;) .allowedMethods(\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;, \u0026#34;PUT\u0026#34;, \u0026#34;DELETE\u0026#34;, \u0026#34;OPTIONS\u0026#34;) .allowedHeaders(\u0026#34;*\u0026#34;) .allowCredentials(true) .maxAge(3600); } } ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹ ç®¡ç†ç«¯æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @RestController @RequestMapping(\u0026#34;/admin\u0026#34;) @Slf4j @Api(tags = \u0026#34;ç®¡ç†ç«¯ç›¸å…³æ¥å£\u0026#34;) public class AdminController { @Autowired private AdminService adminService; /** * ç®¡ç†å‘˜ç™»å½•ï¼ˆä¸éœ€è¦JWTéªŒè¯ï¼‰ */ @PostMapping(\u0026#34;/login\u0026#34;) @ApiOperation(\u0026#34;ç®¡ç†å‘˜ç™»å½•\u0026#34;) public Result\u0026lt;AdminLoginVO\u0026gt; login(@Valid @RequestBody AdminLoginDTO adminLoginDTO) { log.info(\u0026#34;ç®¡ç†å‘˜ç™»å½•ï¼š{}\u0026#34;, adminLoginDTO); AdminLoginVO adminLoginVO = adminService.login(adminLoginDTO); return Result.success(adminLoginVO); } /** * è·å–ç®¡ç†å‘˜ä¿¡æ¯ï¼ˆéœ€è¦JWTéªŒè¯ï¼‰ */ @GetMapping(\u0026#34;/info\u0026#34;) @ApiOperation(\u0026#34;è·å–ç®¡ç†å‘˜ä¿¡æ¯\u0026#34;) public Result\u0026lt;AdminLoginVO\u0026gt; info() { // ä»ThreadLocalä¸­è·å–å½“å‰ç™»å½•ç®¡ç†å‘˜ID Long adminId = BaseContext.getCurrentId(); AdminLoginVO adminInfo = adminService.getById(adminId); return Result.success(adminInfo); } } 10. æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ âœ… æœ€ä½³å®è·µ 1. å®‰å…¨çš„JWTå¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 /** * å®‰å…¨çš„JWTè§£ææ–¹æ³• */ private Long extractUserIdSafely(String token) { if (StringUtils.isBlank(token)) { throw new IllegalArgumentException(\u0026#34;Tokenä¸èƒ½ä¸ºç©º\u0026#34;); } try { Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token); // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ if (claims.getExpiration().before(new Date())) { throw new IllegalArgumentException(\u0026#34;Tokenå·²è¿‡æœŸ\u0026#34;); } // å®‰å…¨åœ°æå–ç”¨æˆ·ID Object userIdObj = claims.get(\u0026#34;userId\u0026#34;); if (userIdObj == null) { throw new IllegalArgumentException(\u0026#34;Tokenä¸­ç¼ºå°‘ç”¨æˆ·ID\u0026#34;); } return Long.valueOf(userIdObj.toString()); } catch (Exception e) { log.error(\u0026#34;JWTè§£æå¤±è´¥: {}\u0026#34;, e.getMessage()); throw new IllegalArgumentException(\u0026#34;æ— æ•ˆçš„Token\u0026#34;); } } 2. å®Œæ•´çš„æ‹¦æˆªå™¨å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 @Component @Slf4j public class JwtTokenUserInterceptor implements HandlerInterceptor { @Autowired private JwtProperties jwtProperties; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // 1. åªå¤„ç†Controlleræ–¹æ³• if (!(handler instanceof HandlerMethod)) { return true; } // 2. è·å–Token String token = extractToken(request); if (StringUtils.isBlank(token)) { sendErrorResponse(response, \u0026#34;ç¼ºå°‘è®¤è¯Token\u0026#34;); return false; } // 3. éªŒè¯Token try { Long userId = extractUserIdSafely(token); BaseContext.setCurrentId(userId); return true; } catch (Exception e) { log.error(\u0026#34;JWTéªŒè¯å¤±è´¥: {}\u0026#34;, e.getMessage()); sendErrorResponse(response, \u0026#34;TokenéªŒè¯å¤±è´¥: \u0026#34; + e.getMessage()); return false; } } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { // æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ BaseContext.removeCurrentId(); } private String extractToken(HttpServletRequest request) { String token = request.getHeader(jwtProperties.getUserTokenName()); if (token != null \u0026amp;\u0026amp; token.startsWith(\u0026#34;Bearer \u0026#34;)) { return token.substring(7); } return token; } private void sendErrorResponse(HttpServletResponse response, String message) throws IOException { response.setStatus(401); response.setContentType(\u0026#34;application/json;charset=UTF-8\u0026#34;); response.getWriter().write(\u0026#34;{\\\u0026#34;code\\\u0026#34;:401,\\\u0026#34;message\\\u0026#34;:\\\u0026#34;\u0026#34; + message + \u0026#34;\\\u0026#34;}\u0026#34;); } } 3. å¼‚å¸¸å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @RestControllerAdvice @Slf4j public class GlobalExceptionHandler { /** * JWTç›¸å…³å¼‚å¸¸å¤„ç† */ @ExceptionHandler(IllegalArgumentException.class) public Result\u0026lt;String\u0026gt; handleJWTException(IllegalArgumentException e) { log.error(\u0026#34;JWTå¼‚å¸¸: {}\u0026#34;, e.getMessage()); return Result.error(\u0026#34;è®¤è¯å¤±è´¥: \u0026#34; + e.getMessage()); } /** * é€šç”¨å¼‚å¸¸å¤„ç† */ @ExceptionHandler(Exception.class) public Result\u0026lt;String\u0026gt; handleException(Exception e) { log.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸: \u0026#34;, e); return Result.error(\u0026#34;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜\u0026#34;); } } âš ï¸ æ³¨æ„äº‹é¡¹ 1. å†…å­˜æ³„æ¼é˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // é”™è¯¯ç¤ºä¾‹ï¼šå¿˜è®°æ¸…ç†ThreadLocal public void processRequest() { BaseContext.setCurrentId(1001L); // å¤„ç†ä¸šåŠ¡é€»è¾‘ // å¿˜è®°è°ƒç”¨ removeCurrentId() } // æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨try-finallyç¡®ä¿æ¸…ç† public void processRequest() { try { BaseContext.setCurrentId(1001L); // å¤„ç†ä¸šåŠ¡é€»è¾‘ } finally { BaseContext.removeCurrentId(); } } 2. çº¿ç¨‹å®‰å…¨é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 // ThreadLocalæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†è¦æ³¨æ„ä½¿ç”¨æ–¹å¼ public class BaseContext { // æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å‰¯æœ¬ private static ThreadLocal\u0026lt;Long\u0026gt; threadLocal = new ThreadLocal\u0026lt;\u0026gt;(); // é™æ€æ–¹æ³•ï¼Œçº¿ç¨‹å®‰å…¨ public static void setCurrentId(Long id) { threadLocal.set(id); } } 3. JWTå¯†é’¥ç®¡ç† 1 2 3 4 5 # ç”Ÿäº§ç¯å¢ƒé…ç½® coffee: jwt: admin-secret-key: ${JWT_ADMIN_SECRET:default-secret} user-secret-key: ${JWT_USER_SECRET:default-secret} 11. æ€»ç»“ä¸æµç¨‹å›¾ç¤ºæ„ ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹å›¾ æ—¶åºå›¾ï¼ˆASCIIç‰ˆæœ¬ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 å®¢æˆ·ç«¯ â”€â”€â–¶ DispatcherServlet â”€â”€â–¶ æ‹¦æˆªå™¨ â”€â”€â–¶ HandlerMethod â”€â”€â–¶ BaseContext â”€â”€â–¶ Service â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ HTTPè¯·æ±‚+ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ Authorizationâ”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è¯·æ±‚è¿›å…¥ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ æ£€æŸ¥handler â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ instanceof â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ HandlerMethodâ”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ æå–JWT Tokenâ”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è§£æToken â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è·å–Claims â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è®¾ç½®userId â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ æ”¾è¡Œåˆ° â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ Controller â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è·å–userId â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è¿”å›userId â”‚ â”‚ â”‚ â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”‚ è°ƒç”¨Service â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è·å–userId â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ è¿”å›userId â”‚ â”‚ â”‚ â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”‚ è¿”å›ä¸šåŠ¡æ•°æ®â”‚ â”‚ â”‚ â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”‚ è¿”å›å“åº” â”‚ â”‚ â”‚ â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ æ¸…ç†ThreadLocalâ”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â”‚ è¯¦ç»†æ­¥éª¤è¯´æ˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 1. å®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚ï¼Œæºå¸¦Authorizationå¤´ 2. DispatcherServletæ¥æ”¶è¯·æ±‚å¹¶è½¬å‘ç»™æ‹¦æˆªå™¨ 3. æ‹¦æˆªå™¨æ£€æŸ¥handlerç±»å‹ï¼ˆinstanceof HandlerMethodï¼‰ 4. æ‹¦æˆªå™¨æå–JWT Token 5. æ‹¦æˆªå™¨è§£æTokenè·å–Claims 6. æ‹¦æˆªå™¨å°†userIdå­˜å‚¨åˆ°BaseContext 7. æ‹¦æˆªå™¨æ”¾è¡Œè¯·æ±‚åˆ°Controller 8. Controllerä»BaseContextè·å–userId 9. Controllerè°ƒç”¨Serviceæ–¹æ³• 10. Serviceä»BaseContextè·å–userId 11. Serviceæ‰§è¡Œä¸šåŠ¡é€»è¾‘å¹¶è¿”å›æ•°æ® 12. Controllerè¿”å›å“åº”ç»™å®¢æˆ·ç«¯ 13. è¯·æ±‚å®Œæˆåæ¸…ç†ThreadLocalï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰ ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ€»ç»“ æ¦‚å¿µ ä½œç”¨ å…³é”®ç‚¹ HttpServletRequest å°è£…è¯·æ±‚ä¿¡æ¯ è·å–Headerã€å‚æ•°ã€Sessionç­‰ HandlerMethod Controlleræ–¹æ³•å¤„ç†å™¨ åŒºåˆ†Controllerå’Œé™æ€èµ„æº instanceof ç±»å‹åˆ¤æ–­ åˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ BaseContext çº¿ç¨‹ä¸Šä¸‹æ–‡ ThreadLocalå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ JWTæ‹¦æˆªå™¨ ç»Ÿä¸€è®¤è¯ è‡ªåŠ¨è§£æTokenï¼Œè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ ğŸ¯ æŠ€æœ¯è¦ç‚¹ HttpServletRequestï¼šå°è£…è¯·æ±‚ä¿¡æ¯ï¼Œå¯ä»¥è·å– Headerã€å‚æ•°ã€Sessionã€å®¢æˆ·ç«¯ä¿¡æ¯ç­‰ JWT + æ‹¦æˆªå™¨ï¼šç»Ÿä¸€è§£æç”¨æˆ·èº«ä»½ï¼Œæ‹¦æˆªæœªæˆæƒè¯·æ±‚ BaseContextï¼šå­˜å‚¨å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆThreadLocalï¼‰ï¼Œé¿å…ä¼ å‚éº»çƒ¦ handler \u0026amp; HandlerMethodï¼šåˆ¤æ–­è¯·æ±‚å¤„ç†å¯¹è±¡ç±»å‹ï¼ŒåŒºåˆ† Controller ä¸é™æ€èµ„æº instanceofï¼šåˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œæ˜¯ Java çš„åŸºç¡€è¯­æ³• ğŸš€ é¡¹ç›®ä¼˜åŠ¿ ç»Ÿä¸€è®¤è¯ï¼šé€šè¿‡æ‹¦æˆªå™¨å®ç°JWTç»Ÿä¸€éªŒè¯ ä»£ç ç®€æ´ï¼šä½¿ç”¨BaseContexté¿å…å±‚å±‚ä¼ å‚ ç±»å‹å®‰å…¨ï¼šé€šè¿‡instanceofç¡®ä¿ç±»å‹æ­£ç¡®æ€§ å†…å­˜å®‰å…¨ï¼šæ­£ç¡®ä½¿ç”¨ThreadLocalï¼Œé¿å…å†…å­˜æ³„æ¼ é…ç½®çµæ´»ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†JWTå‚æ•° è¿™ç¯‡åšå®¢è¯¦ç»†è§£æäº†Spring Bootä¸­JWTé‰´æƒã€æ‹¦æˆªå™¨å®ç°çš„æ ¸å¿ƒåŸç†ï¼Œç»“åˆå®é™…é¡¹ç›®ä»£ç ï¼Œè®©ä½ æ·±å…¥ç†è§£ç”¨æˆ·è®¤è¯çš„åº•å±‚æµç¨‹ã€‚é€šè¿‡æŒæ¡è¿™äº›æŠ€æœ¯è¦ç‚¹ï¼Œä½ å¯ä»¥æ„å»ºæ›´åŠ å¥å£®å’Œå®‰å…¨çš„Webåº”ç”¨ç³»ç»Ÿã€‚\nğŸ“ Hugoåšå®¢ä½¿ç”¨è¯´æ˜ âœ… å·²ä¼˜åŒ–çš„å†…å®¹ æµç¨‹å›¾ï¼šæ‰€æœ‰Mermaidå›¾è¡¨å·²è½¬æ¢ä¸ºASCIIå­—ç¬¦å›¾æˆ–ä»£ç å—å½¢å¼ ä»£ç é«˜äº®ï¼šä½¿ç”¨æ ‡å‡†Markdownä»£ç å—ï¼ŒHugoè‡ªåŠ¨æ”¯æŒè¯­æ³•é«˜äº® è¡¨æ ¼ï¼šä½¿ç”¨æ ‡å‡†Markdownè¡¨æ ¼æ ¼å¼ é“¾æ¥ï¼šæ‰€æœ‰é“¾æ¥éƒ½ä½¿ç”¨æ ‡å‡†Markdownæ ¼å¼ ğŸ”§ Hugoé…ç½®å»ºè®® åœ¨ä½ çš„Hugoé…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è®¾ç½®ä»¥ä¼˜åŒ–æ˜¾ç¤ºæ•ˆæœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # config.toml [markup] [markup.highlight] style = \u0026#34;github\u0026#34; lineNos = true lineNumbersInTable = true noClasses = false codeFences = true guessSyntax = true tabWidth = 4 wrap = true [markup.goldmark] [markup.goldmark.renderer] unsafe = true hardWraps = false xhtml = false ğŸ¨ ä¸»é¢˜å…¼å®¹æ€§ æœ¬æ–‡æ¡£å…¼å®¹ä»¥ä¸‹Hugoä¸»é¢˜ï¼š\nâœ… LoveIt - å®Œå…¨å…¼å®¹ âœ… PaperMod - å®Œå…¨å…¼å®¹ âœ… Ananke - å®Œå…¨å…¼å®¹ âœ… Academic - å®Œå…¨å…¼å®¹ âœ… Minimal - å®Œå…¨å…¼å®¹ ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ– æ‰€æœ‰ASCIIå›¾è¡¨åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º ä»£ç å—æ”¯æŒæ¨ªå‘æ»šåŠ¨ è¡¨æ ¼æ”¯æŒå“åº”å¼å¸ƒå±€ ğŸ’¡ æç¤ºï¼šæœ¬æ–‡åŸºäºå’–å•¡è´­ç‰©è½¦é¡¹ç›®å®æˆ˜ï¼Œæ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½ç»è¿‡å®é™…æµ‹è¯•éªŒè¯ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼\n","date":"2025-01-27T10:00:00+08:00","permalink":"https://Yin123-ybh.github.io/p/spring-boot-jwt-%E4%B8%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E8%AF%A6%E8%A7%A3basecontexthandlermethodhttpservletrequest-%E4%B8%8E-instanceof/","title":"Spring Boot JWT ä¸æ‹¦æˆªå™¨è¯¦è§£ï¼šBaseContextã€HandlerMethodã€HttpServletRequest ä¸ instanceof"},{"content":"ğŸš€ å‰è¨€ åœ¨ä½¿ç”¨ Spring Cloud Gateway å¼€å‘å¾®æœåŠ¡ç½‘å…³æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šçœ‹åˆ°è¿™æ ·ä¸€æ®µç»å…¸ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 @Override public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { ServerHttpRequest request = exchange.getRequest(); if (isExclude(request.getPath().toString())) { return chain.filter(exchange); } String token = request.getHeaders().getFirst(\u0026#34;authorization\u0026#34;); Long userId; try { userId = jwtTool.parseToken(token); } catch (UnauthorizedException e) { exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED); return exchange.getResponse().setComplete(); } ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;userId\u0026#34;, String.valueOf(userId)) .build(); ServerWebExchange newExchange = exchange.mutate() .request(newRequest) .build(); return chain.filter(newExchange); } çœ‹ä¼¼ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå®é™…ä¸Šè•´å«äº† Spring Cloud Gateway çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰ã€ä¸å¯å˜æ•°æ®æ¨¡å‹ï¼ˆImmutable Modelï¼‰ ä¸ å£°æ˜å¼æ•°æ®æµï¼ˆDeclarative Data Flowï¼‰ã€‚\næœ¬æ–‡å°†å¸¦ä½ ä»åº•å±‚åŸç†å‡ºå‘ï¼Œæ·±å…¥ç†è§£è¿™ä¸€åˆ‡çš„èƒŒåé€»è¾‘ã€‚\nğŸ§­ ä¸€ã€Spring Cloud Gateway çš„å®šä½ä¸åŸç† 1. ä»€ä¹ˆæ˜¯ç½‘å…³ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç½‘å…³ï¼ˆGatewayï¼‰æ˜¯æ‰€æœ‰å¤–éƒ¨è¯·æ±‚çš„å”¯ä¸€å…¥å£ã€‚ å®ƒè´Ÿè´£ï¼š\nç»Ÿä¸€è®¤è¯ä¸é‰´æƒï¼šæ‰€æœ‰è¯·æ±‚åœ¨è¿›å…¥å¾®æœåŠ¡ä¹‹å‰ï¼Œå…ˆç»è¿‡ç½‘å…³çš„èº«ä»½éªŒè¯ æµé‡æ§åˆ¶ä¸é™æµï¼šé˜²æ­¢å•ä¸ªæœåŠ¡è¢«å‹å® è·¯ç”±åˆ†å‘ï¼šæ ¹æ®è§„åˆ™å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ æ—¥å¿—è¿½è¸ªä¸ç›‘æ§ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ å‚æ•°è¿‡æ»¤ä¸å®‰å…¨æ ¡éªŒï¼šSQLæ³¨å…¥ã€XSSæ”»å‡»ç­‰å®‰å…¨é˜²æŠ¤ è·¨åŸŸå¤„ç†ï¼šç»Ÿä¸€å¤„ç†CORSé—®é¢˜ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š\n\u0026ldquo;æ‰€æœ‰å¾®æœåŠ¡çš„é—¨å« + å®‰ä¿ + æ¥å¾…å‘˜\u0026rdquo;\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Client â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Spring Cloud Gateway â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ GlobalFilter â”‚ â”‚ â”‚ â”‚ - è®¤è¯é‰´æƒ â”‚ â”‚ â”‚ â”‚ - é™æµç†”æ–­ â”‚ â”‚ â”‚ â”‚ - æ—¥å¿—è¿½è¸ª â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â†“ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ RouteLocator â”‚ â”‚ â”‚ â”‚ - è·¯ç”±åŒ¹é… â”‚ â”‚ â”‚ â”‚ - è½¬å‘è§„åˆ™ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”‚ Order â”‚ â”‚ Product â”‚ â”‚Service â”‚ â”‚ Service â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 2. Spring Cloud Gateway çš„åº•å±‚å¼•æ“ Spring Cloud Gateway æ„å»ºåœ¨ Spring WebFlux ä¹‹ä¸Šï¼Œ è€Œ WebFlux åˆæ˜¯åŸºäº Reactor å“åº”å¼æµï¼ˆReactive Streamsï¼‰ æ ‡å‡†ã€‚\nå“åº”å¼ç¼–ç¨‹çš„ä¸‰é©¾é©¬è½¦ Reactor æ˜¯ Spring å›¢é˜Ÿå¼€å‘çš„å“åº”å¼æµåº“ï¼Œæä¾›ä¸¤ä¸ªæ ¸å¿ƒç±»å‹ï¼š\nMonoï¼šè¡¨ç¤ºå¼‚æ­¥çš„0-1ä¸ªå€¼ï¼ˆç±»ä¼¼ Optionalï¼‰ Fluxï¼šè¡¨ç¤ºå¼‚æ­¥çš„0-Nä¸ªå€¼çš„åºåˆ— WebFlux çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š\néé˜»å¡ + å¼‚æ­¥ + é«˜å¹¶å‘ + å‡½æ•°å¼ç¼–ç¨‹é£æ ¼\nè¿™æ„å‘³ç€ï¼š\nâœ… æ¯ä¸ªè¯·æ±‚ä¸ä¼šç‹¬å çº¿ç¨‹ï¼šä¼ ç»Ÿ Servlet æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹èµ„æºæœ‰é™ï¼ˆé€šå¸¸å‡ ç™¾ä¸ªï¼‰ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å¾ˆå®¹æ˜“è€—å°½ âœ… æ•°æ®åœ¨ Filter é“¾ä¸­ä»¥ã€Œæµã€çš„å½¢å¼ä¼ é€’ï¼šæ•°æ®æ˜¯æµåŠ¨çš„ï¼Œä¸æ˜¯é™æ­¢çš„ âœ… æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸å¯å˜çš„ï¼ˆImmutableï¼‰ï¼šåœ¨å¼‚æ­¥ç¯å¢ƒä¸‹ä¿è¯çº¿ç¨‹å®‰å…¨ âœ… è¿‡æ»¤å™¨ä¹‹é—´é€šè¿‡ Mono / Flux ç»„åˆå½¢æˆå¼‚æ­¥ç®¡é“ï¼šä»£ç æ˜¯å£°æ˜å¼çš„ï¼Œæè¿°\u0026quot;åšä»€ä¹ˆ\u0026quot;è€Œé\u0026quot;æ€ä¹ˆåš\u0026quot; æ€§èƒ½å¯¹æ¯” ç‰¹æ€§ ä¼ ç»Ÿ Servlet Spring WebFlux I/Oæ¨¡å‹ é˜»å¡IO éé˜»å¡IO çº¿ç¨‹æ¨¡å‹ æ¯ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼ˆæµªè´¹ï¼‰ äº‹ä»¶å¾ªç¯ï¼ˆé«˜æ•ˆï¼‰ å¹¶å‘èƒ½åŠ› ~200 req/s per thread ~10,000 req/s ç¼–ç¨‹é£æ ¼ å‘½ä»¤å¼ å£°æ˜å¼ï¼ˆå‡½æ•°å¼ï¼‰ ğŸ§© äºŒã€ServerWebExchangeï¼šè¯·æ±‚çš„\u0026quot;ä¸Šä¸‹æ–‡å®¹å™¨\u0026quot; åœ¨ WebFlux ä¸­ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚ä¼šè¢«å°è£…ä¸ºä¸€ä¸ª ServerWebExchange å¯¹è±¡ã€‚\nå®ƒåŒ…å«ä»€ä¹ˆï¼Ÿ 1 2 3 4 ServerWebExchange â”œâ”€â”€ ServerHttpRequest â†’ è¯·æ±‚éƒ¨åˆ†ï¼ˆURLã€Headerã€Bodyç­‰ï¼‰ â”œâ”€â”€ ServerHttpResponse â†’ å“åº”éƒ¨åˆ†ï¼ˆHeaderã€Bodyç­‰ï¼‰ â””â”€â”€ attributes â†’ Mapç»“æ„çš„å…±äº«ä¸Šä¸‹æ–‡ï¼ˆFilteré—´ä¼ é€’æ•°æ®ï¼‰ ç†è§£æ–¹å¼ï¼š\n\u0026ldquo;ServerWebExchange å°±åƒä¸€ä¸ªä¿¡å°ï¼Œé‡Œé¢è£…ç€è¯·æ±‚(request)å’Œå“åº”(response)ï¼Œå¹¶é™„å¸¦ä¸€å¼ å°çº¸æ¡ï¼ˆattributesï¼‰æ¥è®°å½•é¢å¤–ä¿¡æ¯ã€‚\u0026rdquo;\nattributes çš„å¦™ç”¨ attributes æ˜¯ä¸€ä¸ª Map\u0026lt;String, Object\u0026gt;ï¼Œç”¨äºåœ¨åŒä¸€è¯·æ±‚çš„å¤„ç†é“¾ä¸­ä¼ é€’è‡ªå®šä¹‰æ•°æ®ã€‚\nå¸¸è§çš„ç”¨é€”ï¼š\n1 2 3 4 5 6 7 // åœ¨ç¬¬ä¸€ä¸ª Filter ä¸­è®¾ç½® exchange.getAttributes().put(\u0026#34;startTime\u0026#34;, System.currentTimeMillis()); exchange.getAttributes().put(\u0026#34;requestId\u0026#34;, UUID.randomUUID().toString()); // åœ¨åç»­ Filter ä¸­è·å– Long startTime = (Long) exchange.getAttributes().get(\u0026#34;startTime\u0026#34;); String requestId = (String) exchange.getAttributes().get(\u0026#34;requestId\u0026#34;); ä¸¾ä¾‹è¯´æ˜ å½“ç”¨æˆ·è¯·æ±‚ï¼š\n1 2 3 GET /api/order?id=1 Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... Content-Type: application/json åœ¨ Gateway å±‚å°±ä¼šè¢«è§£ææˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ServerWebExchange exchange = ...; // è·å–è¯·æ±‚ä¿¡æ¯ ServerHttpRequest request = exchange.getRequest(); URI uri = request.getURI(); // /api/order?id=1 HttpMethod method = request.getMethod(); // GET HttpHeaders headers = request.getHeaders(); // Authorization, Content-Type Flux\u0026lt;DataBuffer\u0026gt; body = request.getBody(); // è¯·æ±‚ä½“ // è·å–å“åº”å¯¹è±¡ï¼ˆç”¨äºå‘å®¢æˆ·ç«¯è¿”å›ï¼‰ ServerHttpResponse response = exchange.getResponse(); response.setStatusCode(HttpStatus.OK); response.getHeaders().add(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;); // è·å–å…±äº«å±æ€§ Map\u0026lt;String, Object\u0026gt; attrs = exchange.getAttributes(); attrs.put(\u0026#34;userId\u0026#34;, 10086L); ğŸ§  ä¸‰ã€ServerHttpRequest ä¸ ServerHttpResponse è¯¦è§£ è¿™ä¸¤ä¸ªç±»åˆ†åˆ«å°è£…äº† HTTP åè®®ä¸­çš„è¯·æ±‚ä¸å“åº”éƒ¨åˆ†ã€‚\n1. ServerHttpRequest çš„æ ¸å¿ƒèŒè´£ è´Ÿè´£ä¿å­˜ï¼š\nè¯·æ±‚æ–¹æ³•ï¼ˆMethodï¼‰ï¼šGETã€POSTã€PUTã€DELETE ç­‰ URL ä¿¡æ¯ï¼šå®Œæ•´è·¯å¾„ã€æŸ¥è¯¢å‚æ•°ã€è·¯å¾„å˜é‡ è¯·æ±‚å¤´ï¼ˆHeadersï¼‰ï¼šAuthorizationã€Content-Type ç­‰ è¯·æ±‚ä½“ï¼ˆBodyï¼‰ï¼šä»¥ Flux å½¢å¼æä¾›ï¼Œæ”¯æŒæµå¼è¯»å– å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ServerHttpRequest request = exchange.getRequest(); // è·å–è¯·æ±‚è·¯å¾„ String path = request.getURI().getPath(); // /api/orders String query = request.getURI().getQuery(); // id=1 // è·å–è¯·æ±‚å¤´ String auth = request.getHeaders().getFirst(\u0026#34;Authorization\u0026#34;); String contentType = request.getHeaders().getFirst(\u0026#34;Content-Type\u0026#34;); // è·å–è¯·æ±‚æ–¹æ³• HttpMethod method = request.getMethod(); // GET, POST, etc. // è·å–è¯·æ±‚ä½“ï¼ˆéœ€è¦è®¢é˜… Fluxï¼‰ request.getBody() .collectList() .subscribe(dataBuffers -\u0026gt; { // å¤„ç†è¯·æ±‚ä½“æ•°æ® }); 2. ServerHttpResponse çš„æ ¸å¿ƒèŒè´£ è´Ÿè´£ï¼š\nå“åº”çŠ¶æ€ç ï¼š200ã€401ã€404ã€500 ç­‰ å“åº”å¤´ï¼šContent-Typeã€Set-Cookie ç­‰ å“åº”ä½“è¾“å‡ºæµï¼šä»¥ Reactive æ–¹å¼å†™å…¥ ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 ServerHttpResponse response = exchange.getResponse(); // è®¾ç½®çŠ¶æ€ç  response.setStatusCode(HttpStatus.UNAUTHORIZED); // è®¾ç½®å“åº”å¤´ response.getHeaders().add(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;); // å†™å…¥å“åº”ä½“ response.writeWith(Flux.just(bufferFactory.wrap(\u0026#34;{\\\u0026#34;error\\\u0026#34;:\\\u0026#34;Unauthorized\\\u0026#34;}\u0026#34;.getBytes()))); // æˆ–è€…ç›´æ¥è®¾ç½®ä¸ºå®Œæˆï¼ˆç©ºå“åº”ï¼‰ return response.setComplete(); âš™ï¸ å››ã€ä¸å¯å˜å¯¹è±¡ï¼ˆImmutable Objectï¼‰æ¨¡å‹ è¿™ä¸€ç‚¹æ˜¯å¾ˆå¤šäººç¬¬ä¸€æ¬¡ä½¿ç”¨ WebFlux/Gateway æ—¶æœ€éš¾ç†è§£çš„åœ°æ–¹ã€‚\n1. ä¸ºä»€ä¹ˆè¦ä¸å¯å˜ï¼Ÿ åœ¨å“åº”å¼æ¶æ„ä¸­ï¼Œç³»ç»Ÿè¦åŒæ—¶å¤„ç†æˆåƒä¸Šä¸‡ä¸ªå¼‚æ­¥è¯·æ±‚ã€‚ å¦‚æœå¯¹è±¡æ˜¯å¯å˜çš„ï¼ˆMutableï¼‰ï¼Œé‚£ä¹ˆä¸åŒçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªè¯·æ±‚å¯¹è±¡æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ç«äº‰å’Œä¸å¯é¢„æµ‹çš„é”™è¯¯ã€‚\nä¼ ç»Ÿå¯å˜å¯¹è±¡çš„é£é™© å‡è®¾æœ‰è¿™æ ·çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // é”™è¯¯ç¤ºä¾‹ public class Request { private String userId; public void setUserId(String userId) { this.userId = userId; } } // å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ Request request = new Request(); Thread-1: request.setUserId(\u0026#34;10086\u0026#34;); Thread-2: request.setUserId(\u0026#34;10087\u0026#34;); // æœ€ç»ˆ userId çš„å€¼ä¸ç¡®å®šï¼ åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯å˜å¯¹è±¡ä¼šé€ æˆï¼š\næ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰ çº¿ç¨‹ä¸å®‰å…¨ éš¾ä»¥è°ƒè¯•å’Œè¿½è¸ª å“åº”å¼ç¯å¢ƒä¸‹çš„è€ƒè™‘ åœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢æ‰§è¡Œï¼š\n1 2 è¯·æ±‚1 â†’ Thread-A â†’ åˆ‡æ¢åˆ° Thread-B â†’ ç»§ç»­æ‰§è¡Œ è¯·æ±‚2 â†’ Thread-C â†’ ç»§ç»­æ‰§è¡Œ å¦‚æœå¯¹è±¡å¯å˜ï¼Œä¸åŒçº¿ç¨‹ä¿®æ”¹åŒä¸€å¯¹è±¡ä¼šå¯¼è‡´ï¼š\næ•°æ®ä¸ä¸€è‡´ ä¸å¯é¢„æµ‹çš„è¡Œä¸º éœ€è¦å¤§é‡é”æœºåˆ¶ï¼Œé™ä½æ€§èƒ½ å› æ­¤ï¼š\nWebFlux ä¸­æ‰€æœ‰å…³é”®å¯¹è±¡ï¼ˆServerWebExchangeã€ServerHttpRequestã€ServerHttpResponseï¼‰éƒ½æ˜¯ä¸å¯å˜çš„ã€‚\n2. ä¸å¯å˜å¸¦æ¥çš„å¥½å¤„ âœ… çº¿ç¨‹å®‰å…¨ï¼šä¸éœ€è¦é¢å¤–çš„é”æœºåˆ¶ âœ… å¯é¢„æµ‹æ€§ï¼šæ•°æ®ä¸ä¼šè¢«æ„å¤–ä¿®æ”¹ âœ… æ˜“äºå¹¶å‘ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨åœ°åŒæ—¶è¯»å– âœ… å‡½æ•°å¼é£æ ¼ï¼šç¬¦åˆ\u0026quot;æ— å‰¯ä½œç”¨\u0026quot;åŸåˆ™ 3. ä¸å¯å˜å¸¦æ¥çš„\u0026quot;é™åˆ¶\u0026quot; ä½ ä¸èƒ½ç›´æ¥ä¿®æ”¹è¯·æ±‚å¤´ã€ä¸èƒ½ç›´æ¥æ”¹URLã€‚\nä¾‹å¦‚ï¼Œè¿™æ ·çš„ä»£ç æ˜¯ä¸å¯è¡Œçš„ï¼š\n1 2 3 // âŒ é”™è¯¯ï¼šå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ²¡æœ‰ setter æ–¹æ³• request.getHeaders().add(\u0026#34;userId\u0026#34;, \u0026#34;10086\u0026#34;); request.setPath(\u0026#34;/new/path\u0026#34;); å¿…é¡»é€šè¿‡ä¸€ä¸ªç‰¹æ®Šæœºåˆ¶ï¼šmutate()ã€‚\nğŸ§© äº”ã€mutate() çš„åº•å±‚åŸç†ä¸å®ç°ç»†èŠ‚ 1. mutate() æ˜¯ä»€ä¹ˆï¼Ÿ mutate() æ˜¯ä¸€ä¸ªæ„å»ºå™¨ï¼ˆBuilderï¼‰æ¨¡å¼çš„å®ç°ã€‚ å®ƒçš„å·¥ä½œæœºåˆ¶å¦‚ä¸‹ï¼š\næ‹·è´åŸå¯¹è±¡çš„æ‰€æœ‰å­—æ®µ åº”ç”¨ä½ æƒ³è¦çš„ä¿®æ”¹ è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡å®ä¾‹ 2. å·¥ä½œåŸç†ç¤ºæ„ ä»¥è¯·æ±‚ä¸ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 // åŸå§‹çš„è¯·æ±‚å¯¹è±¡ ServerHttpRequest oldRequest = exchange.getRequest(); // ä½¿ç”¨ mutate() åˆ›å»ºæ–°è¯·æ±‚ ServerHttpRequest newRequest = oldRequest.mutate() .header(\u0026#34;userId\u0026#34;, \u0026#34;10086\u0026#34;) .header(\u0026#34;userRole\u0026#34;, \u0026#34;ADMIN\u0026#34;) .path(\u0026#34;/new/path\u0026#34;) .build(); æ‰§è¡Œåï¼š\nâœ… åŸæ¥çš„ oldRequest ä¾æ—§ä¿ç•™ï¼Œå†…å®¹ä¸å˜ âœ… æ–°çš„ newRequest æ˜¯\u0026quot;å…‹éš†ä½“\u0026quot;ï¼ŒåŒ…å«ç›¸åŒçš„æ•°æ® + æ–°çš„ header 3. mutate() çš„å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // ServerHttpRequest æ¥å£ public interface ServerHttpRequest { // mutate() æ–¹æ³•è¿”å›æ„å»ºå™¨ default Builder mutate() { return new DefaultBuilder(this); } // æ„å»ºå™¨æ¥å£ interface Builder { Builder header(String key, String value); Builder path(String path); ServerHttpRequest build(); } } // å…·ä½“å®ç° class DefaultBuilder implements ServerHttpRequest.Builder { private ServerHttpRequest delegate; DefaultBuilder(ServerHttpRequest delegate) { this.delegate = delegate; // ä¿å­˜åŸå§‹å¯¹è±¡å¼•ç”¨ } @Override public Builder header(String key, String value) { // è®°å½•ä¿®æ”¹æ“ä½œï¼Œä½†ä¸ç«‹å³æ‰§è¡Œ this.headersToAdd.put(key, value); return this; } @Override public ServerHttpRequest build() { // åœ¨è¿™é‡Œåˆ›å»ºæ–°å¯¹è±¡ return new DelegatingServerHttpRequest(delegate) { @Override public HttpHeaders getHeaders() { HttpHeaders headers = new HttpHeaders(); headers.putAll(delegate.getHeaders()); headers.addAll(headersToAdd); // åº”ç”¨ä¿®æ”¹ return headers; } }; } } è¿™å°±æ˜¯ å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ä¸­çš„æ— å‰¯ä½œç”¨ï¼ˆNo Side Effectï¼‰ã€‚\n4. æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ WebFlux çš„å®ç°éå¸¸é«˜æ•ˆï¼š\nå»¶è¿Ÿæ‹·è´ï¼ˆLazy Copy-on-Writeï¼‰ï¼šåªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»ºå‰¯æœ¬ å¯¹è±¡æ± åŒ–ï¼šå¤ç”¨åº•å±‚æ•°æ®ç»“æ„ é›¶æ‹·è´ï¼šå°½å¯èƒ½é¿å…ä¸å¿…è¦çš„æ•°æ®ç§»åŠ¨ ğŸ”„ å…­ã€é‡æ–°æ”¾å…¥ ServerWebExchange ä¿®æ”¹å®Œè¯·æ±‚åï¼Œå¦‚æœæƒ³ç»§ç»­å¾€ä¸‹ä¼ é€’ï¼Œå°±è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ ServerWebExchangeã€‚\n1. åˆ›å»ºæ–° Exchange 1 2 3 ServerWebExchange newExchange = exchange.mutate() .request(newRequest) .build(); å®ƒä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ exchange å®ä¾‹ï¼ŒåŒ…å«ï¼š\næ–°çš„ requestï¼ˆåŠ äº† headerï¼‰ åŸæ¥çš„ responseï¼ˆæ²¡å˜ï¼‰ åŸæ¥çš„ attributesï¼ˆæ²¡å˜ï¼Œä½†å†…å®¹ç›¸åŒï¼‰ 2. å®Œæ•´æµç¨‹ç¤ºæ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 æ—§ exchange â”‚ â”œâ”€â”€ request: â”‚ â”œâ”€â”€ path: /api/order â”‚ â”œâ”€â”€ method: GET â”‚ â””â”€â”€ headers: {Authorization: Bearer xxx} â”‚ â”œâ”€â”€ response: â”‚ â”œâ”€â”€ statusCode: null â”‚ â””â”€â”€ headers: {} â”‚ â””â”€â”€ attributes: {} â†“ mutate() ä¿®æ”¹ â†“ æ–° exchange â”‚ â”œâ”€â”€ request: â”‚ â”œâ”€â”€ path: /api/order â”‚ â”œâ”€â”€ method: GET â”‚ â””â”€â”€ headers: { â”‚ Authorization: Bearer xxx, â”‚ userId: 10086 â† æ–°å¢ â”‚ } â”‚ â”œâ”€â”€ response: (æœªå˜) â””â”€â”€ attributes: (æœªå˜) 3. ä¸ºä»€ä¹ˆ response å’Œ attributes ä¸å˜ï¼Ÿ responseï¼šå¦‚æœæ²¡ä¿®æ”¹ï¼Œå¤ç”¨åŸæ¥çš„å°±å¥½ï¼Œé¿å…ä¸å¿…è¦çš„æ‹·è´ attributesï¼šå…±äº«ä¸Šä¸‹æ–‡ï¼Œæ‰€æœ‰å¼•ç”¨éƒ½æŒ‡å‘åŒä¸€ä¸ª Mapï¼Œä¿®æ”¹æ˜¯å®‰å…¨çš„ ğŸ” ä¸ƒã€ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ åœ¨ç½‘å…³å±‚éªŒè¯å®Œ JWT Token åï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠç”¨æˆ·èº«ä»½ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ã€‚ å¦åˆ™æ¯ä¸ªå¾®æœåŠ¡éƒ½è¦é‡å¤è§£æ Tokenï¼Œæµªè´¹æ€§èƒ½ã€‚\n1. æ€§èƒ½è€ƒè™‘ æ–¹æ¡ˆAï¼šæ¯ä¸ªæœåŠ¡éƒ½è§£æ Tokenï¼ˆé‡å¤å·¥ä½œï¼‰ 1 2 3 4 5 Client â†’ Gateway (è§£æ Tokenï¼Œå¾—åˆ° userId) â†’ Order Service (åˆè§£æä¸€æ¬¡ Token) â†’ Inventory Service (åˆè§£æä¸€æ¬¡ Token) â†’ Payment Service (åˆè§£æä¸€æ¬¡ Token) é—®é¢˜ï¼š\næµªè´¹ CPU èµ„æºï¼ˆé‡å¤è§£æï¼‰ å¢åŠ å»¶è¿Ÿï¼ˆæ¯ä¸ªæœåŠ¡éƒ½è¦éªŒè¯ï¼‰ ç»´æŠ¤æˆæœ¬é«˜ï¼ˆæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å¼•å…¥ JWT åº“ï¼‰ æ–¹æ¡ˆBï¼šç½‘å…³è§£æï¼Œé€šè¿‡ Header ä¼ é€’ï¼ˆæ¨èï¼‰ 1 2 3 4 5 Client â†’ Gateway (è§£æ Tokenï¼Œå¾—åˆ° userIdï¼Œæ·»åŠ åˆ° Header) â†’ Order Service (ä» Header è¯»å– userId) â†’ Inventory Service (ä» Header è¯»å– userId) â†’ Payment Service (ä» Header è¯»å– userId) ä¼˜åŠ¿ï¼š\nâœ… åªè§£æä¸€æ¬¡ Token âœ… ä¸‹æ¸¸æœåŠ¡æ— æ„ŸçŸ¥ âœ… æ€§èƒ½æ›´å¥½ âœ… æ¶æ„æ›´æ¸…æ™° 2. æœ€ç®€å•çš„åŠæ³•ï¼šåœ¨è¯·æ±‚å¤´ä¸­é™„åŠ ç”¨æˆ·ä¿¡æ¯ 1 2 3 4 5 ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;userId\u0026#34;, String.valueOf(userId)) .header(\u0026#34;userName\u0026#34;, user.getName()) .header(\u0026#34;userRole\u0026#34;, user.getRole()) .build(); ä¸‹æ¸¸æœåŠ¡å³å¯ç›´æ¥è¯»å–ï¼š\n1 2 3 4 5 6 7 8 9 @GetMapping(\u0026#34;/api/orders\u0026#34;) public ResponseEntity\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; getOrders(HttpServletRequest request) { String userId = request.getHeader(\u0026#34;userId\u0026#34;); String userName = request.getHeader(\u0026#34;userName\u0026#34;); String userRole = request.getHeader(\u0026#34;userRole\u0026#34;); // ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯å¤„ç†ä¸šåŠ¡ return ResponseEntity.ok(orderService.getOrdersByUserId(Long.valueOf(userId))); } 3. æ•°æ®ä¼ é€’ç¤ºä¾‹ å‡è®¾å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼š\n1 2 GET /api/orders Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... åœ¨ Gateway çš„å¤„ç†æµç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // 1. æ¥æ”¶è¯·æ±‚ ServerHttpRequest originalRequest = exchange.getRequest(); // Headers: { Authorization: Bearer xxx } // 2. è§£æ Token Long userId = jwtService.parseToken(token); String userName = \u0026#34;å¼ ä¸‰\u0026#34;; String userRole = \u0026#34;USER\u0026#34;; // 3. åˆ›å»ºæ–°è¯·æ±‚ï¼ˆæ·»åŠ ç”¨æˆ·ä¿¡æ¯ï¼‰ ServerHttpRequest enhancedRequest = originalRequest.mutate() .header(\u0026#34;userId\u0026#34;, String.valueOf(userId)) .header(\u0026#34;userName\u0026#34;, userName) .header(\u0026#34;userRole\u0026#34;, userRole) .build(); // Headers: { Authorization: Bearer xxx, userId: 10086, userName: å¼ ä¸‰, userRole: USER } // 4. ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡ ServerWebExchange newExchange = exchange.mutate() .request(enhancedRequest) .build(); ä¸‹æ¸¸æœåŠ¡æ”¶åˆ°ï¼š\n1 2 3 4 5 GET /api/orders Authorization: Bearer xxx userId: 10086 userName: å¼ ä¸‰ userRole: USER ğŸ§° å…«ã€æ›¿ä»£æ–¹æ¡ˆä¸å®‰å…¨è€ƒè™‘ 1. attributes æ–¹å¼ï¼ˆä»…å†…éƒ¨ä½¿ç”¨ï¼‰ åœ¨è¿‡æ»¤å™¨é“¾ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨ exchange.getAttributes().put(\u0026quot;userId\u0026quot;, userId)ï¼Œ\n1 2 3 4 5 // åœ¨ GlobalFilter ä¸­è®¾ç½® exchange.getAttributes().put(\u0026#34;userId\u0026#34;, userId); // åœ¨å…¶ä»– Filter ä¸­è·å– Long userId = (Long) exchange.getAttributes().get(\u0026#34;userId\u0026#34;); ä½†è¿™åªåœ¨å½“å‰ç½‘å…³çš„å¤„ç†é“¾æœ‰æ•ˆï¼Œæ— æ³•ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡ã€‚\nattributes vs Header å¯¹æ¯” ç‰¹æ€§ attributes Header ä½œç”¨åŸŸ ä»…åœ¨ Gateway å†…éƒ¨ è·¨æœåŠ¡ä¼ é€’ å¯è§æ€§ ä¸å¯è§ï¼ˆè¯·æ±‚å¤´ä¸­çœ‹ä¸åˆ°ï¼‰ å¯è§ï¼ˆè¯·æ±‚å¤´ä¸­èƒ½çœ‹åˆ°ï¼‰ ç”¨é€” å†…éƒ¨æ•°æ®ä¼ é€’ è·¨æœåŠ¡æ•°æ®ä¼ é€’ å®‰å…¨æ€§ é«˜ï¼ˆä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼‰ éœ€è¦è€ƒè™‘å®‰å…¨æ€§ 2. è¯·æ±‚å¤´æ–¹å¼ï¼ˆè·¨æœåŠ¡ä¼ é€’ï¼‰ è¿™ç§æ–¹å¼æœ€å¸¸ç”¨ï¼Œå› ä¸ºè¯·æ±‚å¤´ä¼šè¢«è‡ªåŠ¨è½¬å‘ç»™åç«¯ã€‚\nä¸è¿‡è¦æ³¨æ„å®‰å…¨é—®é¢˜ï¼š\nå®‰å…¨é£é™© âŒ ä¸è¦ç›´æ¥ä¼ é€’æ•æ„Ÿæ•°æ®ï¼šå¦‚å®Œæ•´ JWTã€å¯†ç ã€èº«ä»½è¯å· âŒ ä¸è¦ä¼ é€’ä¸šåŠ¡ç§˜å¯†ï¼šå¦‚è´¦æˆ·ä½™é¢ã€ç§æœ‰ä»¤ç‰Œ âš ï¸ å°å¿ƒä¿¡æ¯æ³„éœ²ï¼šè¯·æ±‚å¤´å¯èƒ½è¢«è®°å½•åˆ°æ—¥å¿—ä¸­ å®‰å…¨å»ºè®® âœ… åªä¼ é€’å¿…è¦å­—æ®µï¼šå¦‚ userIdã€roleã€tenantId âœ… æ•°æ®è„±æ•ï¼šå¦‚æœå¿…é¡»ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼Œå…ˆåŠ å¯†æˆ–è„±æ• âœ… ç­¾åéªŒè¯ï¼šåœ¨å…³é”®Headerä¸Šæ·»åŠ ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹ âœ… HTTPSä¼ è¾“ï¼šç¡®ä¿ä¼ è¾“è¿‡ç¨‹åŠ å¯† ç¤ºä¾‹ï¼šå¸¦ç­¾åçš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // Gateway ç«¯æ·»åŠ ç­¾å String userId = \u0026#34;10086\u0026#34;; String timestamp = String.valueOf(System.currentTimeMillis()); String signature = generateSignature(userId, timestamp, secretKey); ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;userId\u0026#34;, userId) .header(\u0026#34;timestamp\u0026#34;, timestamp) .header(\u0026#34;signature\u0026#34;, signature) .build(); // ä¸‹æ¸¸æœåŠ¡éªŒè¯ç­¾å String receivedSignature = request.getHeader(\u0026#34;signature\u0026#34;); String expectedSignature = generateSignature(userId, timestamp, secretKey); if (!receivedSignature.equals(expectedSignature)) { throw new SecurityException(\u0026#34;Invalid signature\u0026#34;); } 3. ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰ å¯¹äºå¤§å‹ç³»ç»Ÿï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªç»Ÿä¸€çš„ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public class UserContext { private Long userId; private String userName; private String role; private Map\u0026lt;String, Object\u0026gt; customAttrs; // å¯ä»¥åºåˆ—åŒ–ä¸ºJSONä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ public String toJson() { ... } } // åœ¨ Gateway ä¸­å°è£… ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;X-User-Context\u0026#34;, userContext.toJson()) .build(); // ä¸‹æ¸¸æœåŠ¡è§£æ String contextJson = request.getHeader(\u0026#34;X-User-Context\u0026#34;); UserContext ctx = UserContext.fromJson(contextJson); âš¡ ä¹ã€è¯·æ±‚æµå®Œæ•´æ‰§è¡Œè¿‡ç¨‹ å‡è®¾å®¢æˆ·ç«¯è¯·æ±‚ï¼š\n1 2 3 GET /api/orders?page=1\u0026amp;size=10 Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... Content-Type: application/json æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š\né˜¶æ®µ1ï¼šè¯·æ±‚åˆ°è¾¾ Gateway 1 2 3 4 5 6 7 8 9 10 11 12 13 1. ç½‘å…³æ¥æ”¶è¯·æ±‚ â†“ 2. åˆ›å»º ServerWebExchange å¯¹è±¡ ServerWebExchange { request: ServerHttpRequest { path: /api/orders method: GET headers: {Authorization: Bearer ..., Content-Type: ...} body: ... }, response: ServerHttpResponse {...}, attributes: {} } é˜¶æ®µ2ï¼šè¿›å…¥ GlobalFilter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 3. è¿›å…¥è‡ªå®šä¹‰ GlobalFilter public class AuthGlobalFilter implements GlobalFilter { @Override public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, ...) { // è¯»å–è¯·æ±‚ ServerHttpRequest request = exchange.getRequest(); // è·å–Token String token = request.getHeaders().getFirst(\u0026#34;Authorization\u0026#34;) .replace(\u0026#34;Bearer \u0026#34;, \u0026#34;\u0026#34;); // è§£æTokenï¼ˆè¿™é‡Œç®€åŒ–ï¼‰ Long userId = jwtTool.parseToken(token); // å‡è®¾è¿”å› 10086 // è®°å½•å¼€å§‹æ—¶é—´ exchange.getAttributes().put(\u0026#34;startTime\u0026#34;, System.currentTimeMillis()); // åˆ›å»ºæ–°è¯·æ±‚ ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;userId\u0026#34;, String.valueOf(userId)) .build(); // åˆ›å»ºæ–°Exchange ServerWebExchange newExchange = exchange.mutate() .request(newRequest) .build(); return chain.filter(newExchange); // ç»§ç»­ä¼ é€’ } } é˜¶æ®µ3ï¼šè·¯ç”±è½¬å‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 4. è·¯ç”±åŒ¹é… Router æ ¹æ® path /api/orders åŒ¹é…åˆ° Order Service 5. LoadBalancer é€‰æ‹©å®ä¾‹ ä»å¤šä¸ª Order Service å®ä¾‹ä¸­é€‰æ‹©ä¸€ä¸ªï¼ˆå¦‚ï¼š192.168.1.10:8080ï¼‰ 6. è½¬å‘è¯·æ±‚ HTTP Forward: GET http://192.168.1.10:8080/api/orders Headers: { Authorization: Bearer ... Content-Type: application/json userId: 10086 â† æ–°æ·»åŠ çš„ } é˜¶æ®µ4ï¼šä¸‹æ¸¸æœåŠ¡å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @RestController @RequestMapping(\u0026#34;/api\u0026#34;) public class OrderController { @GetMapping(\u0026#34;/orders\u0026#34;) public ResponseEntity\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; getOrders( HttpServletRequest request, // ä¼ ç»Ÿæ–¹å¼ @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { // ä»Headerè·å– // å¯ä»¥ç›´æ¥ä½¿ç”¨ userIdï¼Œæ— éœ€å†æ¬¡è§£æToken List\u0026lt;Order\u0026gt; orders = orderService.getOrdersByUserId(userId); return ResponseEntity.ok(orders); } } é˜¶æ®µ5ï¼šå“åº”è¿”å› 1 2 3 4 5 6 7 8 9 10 11 7. Order Service è¿”å›å“åº” 200 OK Content-Type: application/json Body: [{\u0026#34;id\u0026#34;: 1, \u0026#34;total\u0026#34;: 99.9}, ...] 8. Gateway æ¥æ”¶å“åº” è®¡ç®—è€—æ—¶ï¼šendTime - startTime è®°å½•æ—¥å¿— 9. è¿”å›ç»™å®¢æˆ·ç«¯ æœ€ç»ˆå“åº”åˆ°è¾¾å®¢æˆ·ç«¯ æ•´ä¸ªé“¾æ¡å®Œå…¨éé˜»å¡ã€çº¿ç¨‹å®‰å…¨ã€‚\nğŸ’¡ åã€ç”Ÿäº§å®è·µç»éªŒæ€»ç»“ 1. ä¸è¦ä¿®æ”¹åŸå§‹å¯¹è±¡ âŒ é”™è¯¯åšæ³•ï¼š\n1 2 3 4 5 // å°è¯•é€šè¿‡åå°„ä¿®æ”¹ Field field = request.getClass().getDeclaredField(\u0026#34;headers\u0026#34;); field.setAccessible(true); HttpHeaders headers = (HttpHeaders) field.get(request); headers.add(\u0026#34;userId\u0026#34;, \u0026#34;10086\u0026#34;); âœ… æ­£ç¡®åšæ³•ï¼š\n1 2 3 4 // å§‹ç»ˆä½¿ç”¨ mutate() ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;userId\u0026#34;, \u0026#34;10086\u0026#34;) .build(); 2. ä½¿ç”¨ Header ä¼ é€’è½»é‡çº§ä¿¡æ¯ ä¼ é€’çš„åŸåˆ™ï¼š\nâœ… åªä¼ å¿…è¦èº«ä»½å­—æ®µï¼ˆuserId, role, tenantï¼‰ âœ… é¿å…ä¼ é€’å¤§å¯¹è±¡ï¼ˆæ€§èƒ½è€ƒè™‘ï¼‰ âœ… é¿å…ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰ ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 // æ¨èï¼šè½»é‡çº§å­—æ®µ .header(\u0026#34;userId\u0026#34;, userId) .header(\u0026#34;userRole\u0026#34;, role) .header(\u0026#34;tenantId\u0026#34;, tenantId) // ä¸æ¨èï¼šå¤§æ•°æ®æˆ–æ•æ„Ÿä¿¡æ¯ // .header(\u0026#34;userInfo\u0026#34;, largeJsonString) â† å½±å“æ€§èƒ½ // .header(\u0026#34;privateKey\u0026#34;, secretKey) â† å®‰å…¨é£é™© 3. ç½‘å…³æ˜¯\u0026quot;è¯·æ±‚å…¥å£ + å®‰å…¨è¾¹ç•Œ\u0026quot; èŒè´£åˆ†å·¥ï¼š\nGatewayï¼šè®¤è¯ã€é‰´æƒã€é™æµã€å®¡è®¡ã€å®‰å…¨é˜²æŠ¤ Serviceï¼šä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç† ä¸è¦åœ¨ä¸šåŠ¡æœåŠ¡ä¸­é‡å¤åšè®¤è¯ï¼š\n1 2 3 4 5 6 7 // Order Service - ä¸éœ€è¦å†æ¬¡éªŒè¯Token @GetMapping(\u0026#34;/orders\u0026#34;) public ResponseEntity\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; getOrders( @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { // ç›´æ¥ä½¿ç”¨ï¼Œç½‘å…³å·²éªŒè¯ return ResponseEntity.ok(orderService.getOrders(userId)); } 4. å“åº”å¼é“¾ä¸­çš„å¯¹è±¡å‡ä¸ºä¸€æ¬¡æ€§ä½¿ç”¨ ä¸è¦ç¼“å­˜æˆ–å…±äº«å¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // âŒ é”™è¯¯ï¼šç¼“å­˜ request private ServerHttpRequest cachedRequest; public Mono\u0026lt;Void\u0026gt; filter(...) { cachedRequest = exchange.getRequest(); // å±é™©ï¼ } // âœ… æ­£ç¡®ï¼šæ¯æ¬¡è·å– public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, ...) { ServerHttpRequest request = exchange.getRequest(); // æ¯æ¬¡éƒ½è·å–æ–°å¼•ç”¨ } 5. æ¨èæ­é… MDC æˆ– ThreadLocal ä¸Šä¸‹æ–‡è·Ÿè¸ª MDCï¼ˆMapped Diagnostic Contextï¼‰ç”¨äºæ—¥å¿—è¿½è¸ªï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class TracingGlobalFilter implements GlobalFilter { @Override public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { String requestId = UUID.randomUUID().toString(); exchange.getAttributes().put(\u0026#34;requestId\u0026#34;, requestId); return chain.filter(exchange) .doFinally(signalType -\u0026gt; { // æ—¥å¿—è®°å½• MDC.put(\u0026#34;requestId\u0026#34;, requestId); log.info(\u0026#34;Request completed: {}\u0026#34;, requestId); MDC.clear(); }); } } 6. æ€§èƒ½ä¼˜åŒ–æŠ€å·§ é¿å…é¢‘ç¹çš„ mutate() è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // âŒ ä¸å¥½ï¼šå¤šæ¬¡ mutate ServerHttpRequest r1 = request.mutate().header(\u0026#34;h1\u0026#34;, \u0026#34;v1\u0026#34;).build(); ServerHttpRequest r2 = r1.mutate().header(\u0026#34;h2\u0026#34;, \u0026#34;v2\u0026#34;).build(); ServerHttpRequest r3 = r2.mutate().header(\u0026#34;h3\u0026#34;, \u0026#34;v3\u0026#34;).build(); // âœ… æ›´å¥½ï¼šä¸€æ¬¡ mutate ServerHttpRequest newRequest = request.mutate() .header(\u0026#34;h1\u0026#34;, \u0026#34;v1\u0026#34;) .header(\u0026#34;h2\u0026#34;, \u0026#34;v2\u0026#34;) .header(\u0026#34;h3\u0026#34;, \u0026#34;v3\u0026#34;) .build(); ğŸ§± åä¸€ã€ç¤ºæ„å›¾ï¼šè¯·æ±‚æµè½¬å…¨è¿‡ç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Client Application â”‚ â”‚ â”‚ â”‚ GET /api/orders?page=1\u0026amp;size=10 â”‚ â”‚ Authorization: Bearer eyJ... â”‚ â”‚ Content-Type: application/json â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ HTTP Request â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Spring Cloud Gateway â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ 1. Receive Request â”‚ â”‚ â”‚ â”‚ ServerWebExchange created â”‚ â”‚ â”‚ â”‚ {request, response, attributes} â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â†“ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ 2. GlobalFilter: AuthGlobalFilter â”‚ â”‚ â”‚ â”‚ - Read Authorization header â”‚ â”‚ â”‚ â”‚ - Parse JWT token â†’ userId: 10086 â”‚ â”‚ â”‚ â”‚ - Add userId to request header â”‚ â”‚ â”‚ â”‚ request.mutate().header(\u0026#34;userId\u0026#34;, \u0026#34;10086\u0026#34;).build()â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â†“ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ 3. RouteLocator â”‚ â”‚ â”‚ â”‚ - Match path: /api/orders â”‚ â”‚ â”‚ â”‚ - Route to: Order Service â”‚ â”‚ â”‚ â”‚ - LoadBalance: 192.168.1.10:8080 â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ Forward Request â”‚ GET http://192.168.1.10:8080/api/orders â”‚ Headers: { â”‚ Authorization: Bearer eyJ... â”‚ userId: 10086 â”‚ } â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Order Service â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ OrderController â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ @GetMapping(\u0026#34;/orders\u0026#34;) â”‚ â”‚ â”‚ â”‚ public List\u0026lt;Order\u0026gt; getOrders( â”‚ â”‚ â”‚ â”‚ @RequestHeader(\u0026#34;userId\u0026#34;) Long userId) { â”‚ â”‚ â”‚ â”‚ // ç›´æ¥ä½¿ç”¨ userIdï¼Œæ— éœ€è§£æToken â”‚ â”‚ â”‚ â”‚ return orderService.getOrders(userId); â”‚ â”‚ â”‚ â”‚ } â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ OrderService â”‚ â”‚ â”‚ â”‚ - Query database â”‚ â”‚ â”‚ â”‚ - Return orders â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ HTTP Response â”‚ 200 OK â”‚ [{\u0026#34;id\u0026#34;: 1, \u0026#34;total\u0026#34;: 99.9}, ...] â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Spring Cloud Gateway (Continue) â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ 4. Calculate Duration â”‚ â”‚ â”‚ â”‚ startTime - endTime â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â†“ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ 5. Log Request â”‚ â”‚ â”‚ â”‚ - Method, Path â”‚ â”‚ â”‚ â”‚ - Duration â”‚ â”‚ â”‚ â”‚ - Response status â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ Response â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Client Application â”‚ â”‚ â”‚ â”‚ 200 OK â”‚ â”‚ [{\u0026#34;id\u0026#34;: 1, \u0026#34;total\u0026#34;: 99.9}, {\u0026#34;id\u0026#34;: 2, \u0026#34;total\u0026#34;: 150.5}] â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ¯ åäºŒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ Q1ï¼šå¦‚ä½•åœ¨ Filter ä¸­è·å–æˆ–ä¿®æ”¹è¯·æ±‚ä½“ï¼Ÿ Aï¼š éœ€è¦åŒ…è£…è¯·æ±‚ä½“ï¼Œä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public class ModifyRequestBodyFilter implements GlobalFilter { @Override public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { ServerHttpRequest request = exchange.getRequest(); ServerHttpRequestDecorator decoratedRequest = new ServerHttpRequestDecorator(request) { @Override public Flux\u0026lt;DataBuffer\u0026gt; getBody() { return super.getBody() .map(dataBuffer -\u0026gt; { // ä¿®æ”¹ body å†…å®¹ String content = decode(dataBuffer); String modified = modify(content); return encode(modified); }); } }; return chain.filter(exchange.mutate() .request(decoratedRequest) .build()); } } Q2ï¼šå¦‚ä½•åœ¨ Filter ä¸­è·å–å“åº”ä½“ï¼Ÿ Aï¼š ç±»ä¼¼åœ°ï¼Œéœ€è¦åŒ…è£…å“åº”ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public class LogResponseFilter implements GlobalFilter { @Override public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { ServerHttpResponseDecorator decoratedResponse = new ServerHttpResponseDecorator(exchange.getResponse()) { @Override public Mono\u0026lt;Void\u0026gt; writeWith(Publisher\u0026lt;? extends DataBuffer\u0026gt; body) { return super.writeWith(body.doOnNext(dataBuffer -\u0026gt; { // è®°å½•å“åº”å†…å®¹ log.info(\u0026#34;Response: {}\u0026#34;, decode(dataBuffer)); })); } }; return chain.filter(exchange.mutate() .response(decoratedResponse) .build()); } } Q3ï¼šFilter çš„æ‰§è¡Œé¡ºåºå¦‚ä½•æ§åˆ¶ï¼Ÿ Aï¼š ä½¿ç”¨ @Order æ³¨è§£æˆ–å®ç° Ordered æ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Component @Order(Ordered.HIGHEST_PRECEDENCE) // æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ public class AuthGlobalFilter implements GlobalFilter { // ... } // æˆ–è€… @Component public class AuthGlobalFilter implements GlobalFilter, Ordered { @Override public int getOrder() { return -100; // ä¼˜å…ˆçº§æœ€é«˜ } } Q4ï¼šå¦‚ä½•å®ç°ç†”æ–­é™çº§ï¼Ÿ Aï¼š ä½¿ç”¨ Resilience4j æˆ–è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public class FallbackGlobalFilter implements GlobalFilter { @Override public Mono\u0026lt;Void\u0026gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { return chain.filter(exchange) .onErrorResume(ex -\u0026gt; { // ç†”æ–­é™çº§ ServerHttpResponse response = exchange.getResponse(); response.setStatusCode(HttpStatus.SERVICE_UNAVAILABLE); // è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ String errorMsg = \u0026#34;Service temporarily unavailable, please try again later\u0026#34;; DataBuffer buffer = response.bufferFactory() .wrap(errorMsg.getBytes()); return response.writeWith(Mono.just(buffer)); }); } } ğŸ åä¸‰ã€ç»“è¯­ Spring Cloud Gateway çš„è®¾è®¡éå¸¸\u0026quot;ä¼˜é›…\u0026quot;â€”â€” å®ƒä»¥ å“åº”å¼æµå¼æ¨¡å‹ ä¸ºæ ¸å¿ƒï¼Œå½»åº•æ‘’å¼ƒä¼ ç»Ÿ Servlet æ¨¡å¼ä¸‹çš„å¯å˜å¯¹è±¡ï¼Œ è®©æ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹æ›´åŠ å®‰å…¨ã€é«˜æ•ˆã€å¯é¢„æµ‹ã€‚\nç†è§£ ServerWebExchangeã€ServerHttpRequestã€mutate() çš„å·¥ä½œåŸç†ï¼Œ æ­£æ˜¯æŒæ¡è¿™ä¸€å¥—æœºåˆ¶çš„å…³é”®ã€‚\n\u0026ldquo;Immutable å¯¹è±¡ + Reactive æ•°æ®æµ = é«˜å¹¶å‘å¾®æœåŠ¡çš„åŸºç¡€\u0026rdquo;\næ ¸å¿ƒè¦ç‚¹å›é¡¾ âœ… ServerWebExchange æ˜¯è¯·æ±‚çš„ä¸Šä¸‹æ–‡å®¹å™¨ âœ… ServerHttpRequest å’Œ ServerHttpResponse éƒ½æ˜¯ä¸å¯å˜çš„ âœ… ä½¿ç”¨ mutate() åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œéä¿®æ”¹åŸå¯¹è±¡ âœ… é€šè¿‡ Header ä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™ä¸‹æ¸¸æœåŠ¡ âœ… å“åº”å¼ç¼–ç¨‹è®©ç³»ç»Ÿæ›´åŠ é«˜å¹¶å‘ã€å¯æ‰©å±• ä¸‹ä¸€æ­¥å­¦ä¹  æŒæ¡äº†åŸºç¡€åŸç†åï¼Œå¯ä»¥è¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ ï¼š\nReactor å“åº”å¼ç¼–ç¨‹ï¼šMonoã€Flux çš„é«˜çº§æ“ä½œ WebFlux çš„å¼‚æ­¥å¤„ç†ï¼šå¦‚ä½•é¿å…é˜»å¡æ“ä½œ ç½‘å…³æ€§èƒ½ä¼˜åŒ–ï¼šé™æµã€ç†”æ–­ã€ç¼“å­˜ç­–ç•¥ åˆ†å¸ƒå¼è¿½è¸ªï¼šSleuthã€Zipkin é›†æˆ ğŸ“š å»¶ä¼¸é˜…è¯» å®˜æ–¹æ–‡æ¡£ Spring Cloud Gateway å®˜æ–¹æ–‡æ¡£ Spring WebFlux å®˜æ–¹æ–‡æ¡£ æŠ€æœ¯è§„èŒƒ Reactive Streams è§„èŒƒ JWT è§„èŒƒ (RFC 7519) æ¨èä¹¦ç± ã€ŠSpring WebFlux In Depthã€‹ ã€Šå“åº”å¼æ¶æ„è®¾è®¡æ€æƒ³ä¸å®æˆ˜ã€‹ ã€ŠSpring Cloud å¾®æœåŠ¡å®æˆ˜ã€‹ ç›¸å…³æ–‡ç«  ã€ŠReactor å“åº”å¼ç¼–ç¨‹å®Œå…¨æŒ‡å—ã€‹ ã€ŠJWT Token åœ¨å¾®æœåŠ¡ä¸­çš„æœ€ä½³å®è·µã€‹ ã€Šç½‘å…³é™æµç†”æ–­å®æˆ˜æ€»ç»“ã€‹ ğŸ‰ æ„Ÿè°¢é˜…è¯»ï¼ å¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹èµå’Œåˆ†äº«ã€‚\nğŸ“ å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºï¼\næœ€åæ›´æ–°ï¼š2025-01-20 ä½œè€…ï¼šgeorge è®¸å¯ï¼šæœ¬æ–‡é‡‡ç”¨ CC BY-SA 4.0 è®¸å¯åè®®\n","date":"2025-01-20T10:00:00+08:00","permalink":"https://Yin123-ybh.github.io/p/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82-spring-cloud-gateway-%E8%AF%B7%E6%B1%82%E6%B5%81serverwebexchangeserverhttprequest%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BC%A0%E9%80%92%E4%B8%8E%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B1%E4%BA%AB%E5%8E%9F%E7%90%86/","title":"ä¸€æ–‡å½»åº•ææ‡‚ Spring Cloud Gateway è¯·æ±‚æµï¼šServerWebExchangeã€ServerHttpRequestã€è¯·æ±‚å¤´ä¼ é€’ä¸ç”¨æˆ·ä¿¡æ¯å…±äº«åŸç†"},{"content":"RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºè§£è€¦å’Œå¼‚æ­¥å¤„ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…¶å¯é æ€§è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†ä»ç”Ÿäº§è€…è§’åº¦æ·±å…¥è§£æRabbitMQçš„ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Confirmæœºåˆ¶ã€Returnæœºåˆ¶ã€åŒæ­¥å¼‚æ­¥æ¨¡å¼å¯¹æ¯”ï¼Œä»¥åŠå®Œæ•´çš„ä»£ç å®ç°å’Œæœ€ä½³å®è·µã€‚\nç›®å½• ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ RabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯ æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç† åŒæ­¥ Confirm æ¨¡å¼ å¼‚æ­¥ Confirm æ¨¡å¼ Return æœºåˆ¶ publisher-confirm-type é…ç½® ç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ å®Œæ•´ä»£ç å®ç° æœ€ä½³å®è·µä¸æ€»ç»“ ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ç¡®è®¤ï¼ˆConsumer Ackï¼‰æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå®ƒä¿è¯äº†æ¶ˆæ¯ä¸ä¼š\u0026quot;ç™½ç™½ä¸¢å¤±\u0026quot;ã€‚\nä½†å¾€å¾€è¢«å¿½è§†çš„ä¸€ç‚¹æ˜¯ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ° RabbitMQ Broker çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯èƒ½ä¸¢å¤±æ¶ˆæ¯ã€‚å¸¸è§æƒ…å†µåŒ…æ‹¬ï¼š\næ¶ˆæ¯ä¸¢å¤±åœºæ™¯ ç½‘ç»œç¬æ—¶ä¸­æ–­ï¼šæ¶ˆæ¯æ²¡æœ‰åˆ°è¾¾ Broker Broker æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†å°šæœªæŒä¹…åŒ–å°±å´©æºƒ Exchange è·¯ç”±å¤±è´¥ï¼šæ¶ˆæ¯æ²¡æœ‰è¿›å…¥ä»»ä½•é˜Ÿåˆ— å†…å­˜ä¸è¶³ï¼šBroker å†…å­˜æº¢å‡ºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤± ç£ç›˜æ•…éšœï¼šæŒä¹…åŒ–æ¶ˆæ¯æ—¶ç£ç›˜å†™å…¥å¤±è´¥ é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆä¸å¯é å®ç°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 // âŒ é”™è¯¯å®ç°ï¼šæ²¡æœ‰ç¡®è®¤æœºåˆ¶ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤± @Service public class UnreliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; public void sendMessage(String message) { // ç›´æ¥å‘é€ï¼Œä¸çŸ¥é“æ˜¯å¦æˆåŠŸ rabbitTemplate.convertAndSend(\u0026#34;exchange\u0026#34;, \u0026#34;routingKey\u0026#34;, message); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€\u0026#34;); // è¿™é‡Œå¯èƒ½æ¶ˆæ¯å·²ç»ä¸¢å¤±äº†ï¼ } } å¯é å®ç°å¯¹æ¯” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // âœ… æ­£ç¡®å®ç°ï¼šå¸¦ç¡®è®¤æœºåˆ¶ @Service public class ReliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; public void sendMessage(String message) { try { // å¼€å¯ç¡®è®¤æ¨¡å¼ rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ\u0026#34;); } else { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: \u0026#34; + cause); } }); rabbitTemplate.convertAndSend(\u0026#34;exchange\u0026#34;, \u0026#34;routingKey\u0026#34;, message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } å¦‚æœæ²¡æœ‰å¯é çš„ç¡®è®¤æœºåˆ¶ï¼Œç”Ÿäº§è€…ä¼šè®¤ä¸ºæ¶ˆæ¯å·²ç»æˆåŠŸæŠ•é€’ï¼Œä½†å®é™…ä¸Šæ¶ˆæ¯å¯èƒ½åœ¨åŠè·¯ä¸¢äº†ã€‚\nå› æ­¤ï¼ŒRabbitMQ æä¾›äº† Publisher Confirms å’Œ Return æœºåˆ¶ æ¥ä¿è¯ç”Ÿäº§è€…ä¾§çš„å¯é æ€§ã€‚\nRabbitMQ æ¶ˆæ¯æŠ•é€’é“¾è·¯å…¨æ™¯ è®©æˆ‘ä»¬ä»æ•´ä½“é“¾è·¯çœ‹ä¸€æ¬¡æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„ç”Ÿå‘½å‘¨æœŸï¼š\nå®Œæ•´æŠ•é€’é“¾è·¯ 1 2 3 4 5 6 ç”Ÿäº§è€… â†’ Channel â†’ Broker â†’ æ¶ˆæ¯æŒä¹…åŒ– â†’ Exchange â†’ è·¯ç”±æ£€æŸ¥ â†’ Queue â†’ æ¶ˆè´¹è€… â†“ â†“ â†“ â†“ â†“ â†“ â†“ â†“ deliveryTag æœªç¡®è®¤æ¶ˆæ¯Map Confirmæœºåˆ¶ æŒä¹…åŒ–ç»“æœ è·¯ç”±ç»“æœ æ¶ˆæ¯çŠ¶æ€ æ¶ˆè´¹ç»“æœ â†“ â†“ â†“ â†“ â†“ â†“ â†“ â†“ ç”Ÿæˆå”¯ä¸€ID è®°å½•å¾…ç¡®è®¤ å¤„ç†Ack/Nack æˆåŠŸâ†’Ack æˆåŠŸâ†’è¿›å…¥Queue ç­‰å¾…æ¶ˆè´¹ æˆåŠŸâ†’Ack æ¶ˆæ¯ä¿¡æ¯ å¤±è´¥â†’Nack å¤±è´¥â†’Returnæœºåˆ¶ å¤±è´¥â†’ReturnCallback å¤±è´¥â†’Nack è¯¦ç»†æµç¨‹è¯´æ˜ï¼š 1. ç”Ÿäº§è€…å‘é€é˜¶æ®µ\n1 2 3 4 ç”Ÿäº§è€… â†’ Channel â”œâ”€â”€ ç”Ÿæˆ deliveryTagï¼ˆé€’å¢è®¡æ•°å™¨ï¼‰ â”œâ”€â”€ åŠ å…¥æœªç¡®è®¤æ¶ˆæ¯Map â””â”€â”€ å‘é€æ¶ˆæ¯åˆ°Broker 2. Brokerå¤„ç†é˜¶æ®µ\n1 2 3 Broker â†’ æ¶ˆæ¯æŒä¹…åŒ– â”œâ”€â”€ æŒä¹…åŒ–æˆåŠŸ â†’ è¿”å›Ack â†’ è§¦å‘Confirmæœºåˆ¶ â””â”€â”€ æŒä¹…åŒ–å¤±è´¥ â†’ è¿”å›Nack â†’ è§¦å‘Confirmæœºåˆ¶ 3. æ¶ˆæ¯è·¯ç”±é˜¶æ®µ\n1 2 3 Exchange â†’ è·¯ç”±æ£€æŸ¥ â”œâ”€â”€ è·¯ç”±æˆåŠŸ â†’ æ¶ˆæ¯è¿›å…¥Queue â†’ ç­‰å¾…æ¶ˆè´¹è€… â””â”€â”€ è·¯ç”±å¤±è´¥ â†’ è§¦å‘Returnæœºåˆ¶ â†’ è°ƒç”¨ReturnCallback 4. æ¶ˆè´¹è€…å¤„ç†é˜¶æ®µ\n1 2 3 æ¶ˆè´¹è€… â†’ å¤„ç†æ¶ˆæ¯ â”œâ”€â”€ æ¶ˆè´¹æˆåŠŸ â†’ å‘é€Consumer Ack â””â”€â”€ æ¶ˆè´¹å¤±è´¥ â†’ å‘é€Consumer Nack å…³é”®æœºåˆ¶å¯¹æ¯”è¡¨ï¼š æœºåˆ¶ è§¦å‘æ—¶æœº è¿”å›ç»“æœ ä½œç”¨èŒƒå›´ å¤„ç†æ–¹å¼ Confirmæœºåˆ¶ æ¶ˆæ¯åˆ°è¾¾Brokerå Ack/Nack ç”Ÿäº§è€…â†’Broker å¼‚æ­¥å›è°ƒ/åŒæ­¥ç­‰å¾… Returnæœºåˆ¶ è·¯ç”±å¤±è´¥æ—¶ Basic.Return Exchangeâ†’Queue ReturnCallback Consumer Ack æ¶ˆè´¹å®Œæˆå Consumer Ack/Nack Queueâ†’æ¶ˆè´¹è€… æ‰‹åŠ¨ç¡®è®¤/è‡ªåŠ¨ç¡®è®¤ æ¶ˆæ¯çŠ¶æ€æµè½¬ï¼š 1 2 3 4 5 æ¶ˆæ¯çŠ¶æ€: å‘é€ä¸­ â†’ å·²æŒä¹…åŒ– â†’ å·²è·¯ç”± â†’ å·²æ¶ˆè´¹ â†“ â†“ â†“ â†“ ç¡®è®¤æœºåˆ¶: æ—  Confirm Return Consumer Ack â†“ â†“ â†“ â†“ å¤„ç†ç»“æœ: ç­‰å¾… æˆåŠŸ/å¤±è´¥ æˆåŠŸ/å¤±è´¥ æˆåŠŸ/å¤±è´¥ è¯¦ç»†æµç¨‹è¯´æ˜ ç”Ÿäº§è€…è°ƒç”¨ channel.basicPublish\nå°†æ¶ˆæ¯é€šè¿‡ Channel å‘é€åˆ° Broker åŒæ—¶ï¼ŒChannel å†…éƒ¨ä¼šä¸ºè¯¥æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ª é€’å¢çš„ deliveryTag æŠŠå®ƒæ”¾åˆ°ä¸€ä¸ª\u0026quot;æœªç¡®è®¤æ¶ˆæ¯ Map\u0026quot;ä¸­ï¼ˆä»…åœ¨å¼€å¯ Confirm æ¨¡å¼æ—¶ï¼‰ Broker æ”¶åˆ°æ¶ˆæ¯å¹¶ç«‹å³æŒä¹…åŒ–\næ ¹æ® BasicPropertiesï¼ˆåŒ…æ‹¬æŒä¹…åŒ–æ ‡å¿—ï¼‰å°è¯•å­˜å‚¨æ¶ˆæ¯ æŒä¹…åŒ–æˆåŠŸ â†’ å‡†å¤‡è¿”å› Ack æŒä¹…åŒ–å¤±è´¥ â†’ å‡†å¤‡è¿”å› Nack æ¶ˆæ¯è·¯ç”±å¤„ç†\næŒä¹…åŒ–æˆåŠŸåï¼Œå°†æ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº”çš„ Exchange Exchange è¿›è¡Œè·¯ç”±æ£€æŸ¥ï¼š è·¯ç”±æˆåŠŸ â†’ æ¶ˆæ¯è¿›å…¥ç›®æ ‡ Queue è·¯ç”±å¤±è´¥ â†’ è§¦å‘ Return æœºåˆ¶ï¼ˆå¦‚æœè®¾ç½®äº† mandatory=trueï¼‰ Confirm æœºåˆ¶å¤„ç†\nBroker é€šè¿‡ AMQP åè®®è¿”å› Confirm æ¶ˆæ¯å¸§ï¼ˆåŒ…å« deliveryTagã€ack/nackã€multipleï¼‰ ç”Ÿäº§è€…çš„ Channel æ”¶åˆ°åï¼Œè§¦å‘å†…éƒ¨ Confirm å¤„ç†é€»è¾‘ Channel ä»\u0026quot;æœªç¡®è®¤ Map\u0026quot;ä¸­æ‰¾åˆ°å¯¹åº” deliveryTag çš„æ¶ˆæ¯ï¼Œç§»é™¤å¹¶è§¦å‘å›è°ƒ Return æœºåˆ¶å¤„ç†ï¼ˆå¯é€‰ï¼‰\nå¦‚æœè·¯ç”±å¤±è´¥ä¸”è®¾ç½®äº† mandatory=true Broker è¿”å› Basic.Return æ¶ˆæ¯å¸§ ç”Ÿäº§è€…é€šè¿‡ ReturnCallback æ¥æ”¶è¯¥äº‹ä»¶ï¼Œå†³å®šæ˜¯å¦é‡è¯•æˆ–ä¸¢å¼ƒ æ¶ˆè´¹è€…å¤„ç†\næ¶ˆè´¹è€…ä» Queue è·å–æ¶ˆæ¯ æ¶ˆè´¹æˆåŠŸ â†’ å‘é€ Consumer Ack æ¶ˆè´¹å¤±è´¥ â†’ å‘é€ Consumer Nack è¿™ä¸€è¿‡ç¨‹ç¡®ä¿äº† ç”Ÿäº§è€…å¯ä»¥æ˜ç¡®çŸ¥é“æ¶ˆæ¯çš„å®Œæ•´æŠ•é€’çŠ¶æ€ï¼Œé¿å…äº†\u0026quot;é»‘ç®±å‘é€\u0026quot;ï¼Œå®ç°äº†ç«¯åˆ°ç«¯çš„æ¶ˆæ¯å¯é æ€§ä¿éšœã€‚\næ ¸å¿ƒæ¦‚å¿µè¯¦è§£ 1. Broker RabbitMQ æœåŠ¡å™¨æœ¬èº«å°±æ˜¯ä¸€ä¸ª Brokerï¼Œè´Ÿè´£æ¥æ”¶ã€å­˜å‚¨ã€è·¯ç”±å’ŒæŠ•é€’æ¶ˆæ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Broker è¿æ¥é…ç½® @Configuration public class RabbitMQConfig { @Bean public ConnectionFactory connectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(\u0026#34;localhost\u0026#34;); factory.setPort(5672); factory.setUsername(\u0026#34;guest\u0026#34;); factory.setPassword(\u0026#34;guest\u0026#34;); factory.setVirtualHost(\u0026#34;/\u0026#34;); // å¼€å¯ç¡®è®¤æ¨¡å¼ factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } } 2. Connection ç”Ÿäº§è€…ä¸ Broker å»ºç«‹çš„ TCP é•¿è¿æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Component public class ConnectionManager { @Autowired private ConnectionFactory connectionFactory; private Connection connection; @PostConstruct public void initConnection() { try { connection = connectionFactory.newConnection(); System.out.println(\u0026#34;è¿æ¥å»ºç«‹æˆåŠŸ\u0026#34;); } catch (Exception e) { System.err.println(\u0026#34;è¿æ¥å»ºç«‹å¤±è´¥: \u0026#34; + e.getMessage()); } } @PreDestroy public void closeConnection() { if (connection != null \u0026amp;\u0026amp; connection.isOpen()) { try { connection.close(); System.out.println(\u0026#34;è¿æ¥å·²å…³é—­\u0026#34;); } catch (Exception e) { System.err.println(\u0026#34;å…³é—­è¿æ¥å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } } 3. Channel åœ¨ Connection ä¸Šçš„é€»è¾‘é€šé“ã€‚\næ¶ˆæ¯çš„å‘é€ã€ç¡®è®¤éƒ½é€šè¿‡ Channel å®Œæˆ ConfirmListener ç»‘å®šåœ¨ Channel ä¸Š deliveryTag ä¹Ÿæ˜¯ä»¥ Channel ä¸ºä½œç”¨åŸŸç”Ÿæˆçš„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Service public class ChannelManager { @Autowired private ConnectionFactory connectionFactory; private Channel channel; public Channel getChannel() throws IOException { if (channel == null || !channel.isOpen()) { Connection connection = connectionFactory.newConnection(); channel = connection.createChannel(); // å¼€å¯ç¡®è®¤æ¨¡å¼ channel.confirmSelect(); } return channel; } } 4. Exchange æ¶ˆæ¯è·¯ç”±å™¨ã€‚ç”Ÿäº§è€…åªèƒ½æŠŠæ¶ˆæ¯æŠ•é€’åˆ° Exchangeï¼Œç”± Exchange æ ¹æ®ç±»å‹ï¼ˆDirect/Topic/Fanout/Headersï¼‰å’Œ Binding è§„åˆ™è·¯ç”±åˆ° Queueã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Component public class ExchangeConfig { @Bean public DirectExchange directExchange() { return new DirectExchange(\u0026#34;direct.exchange\u0026#34;, true, false); } @Bean public TopicExchange topicExchange() { return new TopicExchange(\u0026#34;topic.exchange\u0026#34;, true, false); } @Bean public FanoutExchange fanoutExchange() { return new FanoutExchange(\u0026#34;fanout.exchange\u0026#34;, true, false); } } 5. Queue æ¶ˆæ¯çš„å­˜å‚¨å®¹å™¨ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Component public class QueueConfig { @Bean public Queue reliableQueue() { return QueueBuilder.durable(\u0026#34;reliable.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 60000) // æ¶ˆæ¯TTL .withArgument(\u0026#34;x-max-length\u0026#34;, 1000) // é˜Ÿåˆ—æœ€å¤§é•¿åº¦ .build(); } @Bean public Queue deadLetterQueue() { return QueueBuilder.durable(\u0026#34;dead.letter.queue\u0026#34;).build(); } } 6. Binding Exchange ä¸ Queue çš„ç»‘å®šå…³ç³»ï¼Œå†³å®šæ¶ˆæ¯çš„æµå‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 @Component public class BindingConfig { @Bean public Binding reliableBinding() { return BindingBuilder .bind(reliableQueue()) .to(directExchange()) .with(\u0026#34;reliable.key\u0026#34;); } } 7. Basic.Publish AMQP åè®®ä¸­çš„æ¶ˆæ¯å‘é€å‘½ä»¤ã€‚è°ƒç”¨ channel.basicPublish å°±æ˜¯å‘ Broker å‘é€ Basic.Publish æŒ‡ä»¤ï¼Œé™„å¸¦æ¶ˆæ¯ä½“å’Œå±æ€§ã€‚\nç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç† deliveryTag æ¯ä¸ª Channel å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ª é€’å¢çš„è®¡æ•°å™¨ æ¯è°ƒç”¨ä¸€æ¬¡ basicPublishï¼Œè¿™ä¸ªè®¡æ•°å™¨åŠ  1ï¼Œå¾—åˆ°ä¸€ä¸ª deliveryTag deliveryTag ä½œä¸ºæ¶ˆæ¯çš„\u0026quot;å”¯ä¸€åºå·\u0026quot;ï¼Œç”¨äºåç»­ Ack/Nack å¯¹åº” 1 2 3 4 5 6 7 8 9 10 11 12 13 // deliveryTag ç”Ÿæˆç¤ºä¾‹ public class DeliveryTagGenerator { private final AtomicLong deliveryTagCounter = new AtomicLong(0); public long generateDeliveryTag() { return deliveryTagCounter.incrementAndGet(); } public void reset() { deliveryTagCounter.set(0); } } æœªç¡®è®¤æ¶ˆæ¯ Map Channel å†…éƒ¨ä¿å­˜ä¸€ä¸ª æœ‰åº Mapï¼Œkey æ˜¯ deliveryTagï¼Œvalue æ˜¯æ¶ˆæ¯ä¿¡æ¯ åªæœ‰åœ¨å¼€å¯ Confirm æ¨¡å¼åï¼Œè¿™ä¸ª Map æ‰ä¼šå¯ç”¨ Ack/Nack åˆ°æ¥æ—¶ï¼ŒChannel ä¼šæŸ¥ Map æ¥æ‰¾åˆ°éœ€è¦ç¡®è®¤çš„æ¶ˆæ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // æœªç¡®è®¤æ¶ˆæ¯ç®¡ç† public class UnconfirmedMessageManager { private final Map\u0026lt;Long, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); public void addUnconfirmedMessage(long deliveryTag, UnconfirmedMessage message) { unconfirmedMessages.put(deliveryTag, message); } public UnconfirmedMessage removeUnconfirmedMessage(long deliveryTag) { return unconfirmedMessages.remove(deliveryTag); } public void removeMultipleMessages(long deliveryTag) { unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; entry.getKey() \u0026lt;= deliveryTag); } public int getUnconfirmedCount() { return unconfirmedMessages.size(); } } @Data @AllArgsConstructor public class UnconfirmedMessage { private String exchange; private String routingKey; private byte[] body; private long timestamp; } multiple æ ‡å¿—ä½ Ack/Nack æ¶ˆæ¯ä¸­å¸¦æœ‰ multiple å¸ƒå°”å€¼ falseï¼šåªç¡®è®¤å½“å‰ deliveryTag trueï¼šç¡®è®¤ å°äºç­‰äºå½“å‰ deliveryTag çš„æ‰€æœ‰æ¶ˆæ¯ è¿™æ˜¯ä¸€ç§æ‰¹é‡ç¡®è®¤æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œäº¤äº’ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // multiple æ ‡å¿—ä½å¤„ç† public class MultipleConfirmHandler { public void handleConfirm(long deliveryTag, boolean multiple, boolean ack) { if (multiple) { // æ‰¹é‡ç¡®è®¤ï¼šç¡®è®¤æ‰€æœ‰å°äºç­‰äº deliveryTag çš„æ¶ˆæ¯ handleMultipleConfirm(deliveryTag, ack); } else { // å•ä¸ªç¡®è®¤ï¼šåªç¡®è®¤å½“å‰ deliveryTag handleSingleConfirm(deliveryTag, ack); } } private void handleMultipleConfirm(long deliveryTag, boolean ack) { // å¤„ç†æ‰¹é‡ç¡®è®¤é€»è¾‘ System.out.println(\u0026#34;æ‰¹é‡ç¡®è®¤ deliveryTag: \u0026#34; + deliveryTag + \u0026#34;, ack: \u0026#34; + ack); } private void handleSingleConfirm(long deliveryTag, boolean ack) { // å¤„ç†å•ä¸ªç¡®è®¤é€»è¾‘ System.out.println(\u0026#34;å•ä¸ªç¡®è®¤ deliveryTag: \u0026#34; + deliveryTag + \u0026#34;, ack: \u0026#34; + ack); } } Ack/Nack è§¦å‘æ—¶æœº Ackï¼šæ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸï¼Œæˆ–æŠ•é€’åˆ°é˜Ÿåˆ—æˆåŠŸ Nackï¼šå­˜å‚¨å¤±è´¥ã€Broker å†…éƒ¨å¼‚å¸¸ åŒæ­¥ Confirm æ¨¡å¼ å®ç°æ–¹å¼ è°ƒç”¨ channel.confirmSelect() å¼€å¯ Confirm æ¨¡å¼ æ¯æ¬¡ basicPublish ä¹‹åè°ƒç”¨ channel.waitForConfirms() é˜»å¡ç­‰å¾… ç¤ºä¾‹ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 @Service public class SynchronousConfirmProducer { @Autowired private ConnectionFactory connectionFactory; public void sendMessageWithSyncConfirm(String exchange, String routingKey, String message) { Connection connection = null; Channel channel = null; try { // 1. å»ºç«‹è¿æ¥å’Œé€šé“ connection = connectionFactory.newConnection(); channel = connection.createChannel(); // 2. å¼€å¯ç¡®è®¤æ¨¡å¼ channel.confirmSelect(); // 3. å‘é€æ¶ˆæ¯ channel.basicPublish(exchange, routingKey, null, message.getBytes()); // 4. åŒæ­¥ç­‰å¾…ç¡®è®¤ boolean confirmed = channel.waitForConfirms(5000); // 5ç§’è¶…æ—¶ if (confirmed) { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: \u0026#34; + message); } else { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: \u0026#34; + message); } } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } finally { // 5. å…³é—­èµ„æº closeResources(channel, connection); } } public void sendMultipleMessagesWithSyncConfirm(String exchange, String routingKey, List\u0026lt;String\u0026gt; messages) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); channel.confirmSelect(); // æ‰¹é‡å‘é€æ¶ˆæ¯ for (String message : messages) { channel.basicPublish(exchange, routingKey, null, message.getBytes()); } // æ‰¹é‡ç­‰å¾…ç¡®è®¤ boolean confirmed = channel.waitForConfirms(10000); // 10ç§’è¶…æ—¶ if (confirmed) { System.out.println(\u0026#34;æ‰¹é‡æ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œæ•°é‡: \u0026#34; + messages.size()); } else { System.out.println(\u0026#34;æ‰¹é‡æ¶ˆæ¯æŠ•é€’å¤±è´¥\u0026#34;); } } catch (Exception e) { System.err.println(\u0026#34;æ‰¹é‡å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } finally { closeResources(channel, connection); } } private void closeResources(Channel channel, Connection connection) { try { if (channel != null \u0026amp;\u0026amp; channel.isOpen()) { channel.close(); } if (connection != null \u0026amp;\u0026amp; connection.isOpen()) { connection.close(); } } catch (Exception e) { System.err.println(\u0026#34;å…³é—­èµ„æºå¼‚å¸¸: \u0026#34; + e.getMessage()); } } } ç‰¹ç‚¹ ä¼˜ç‚¹ï¼šç®€å•æ˜“æ‡‚ï¼Œå®æ—¶çŸ¥é“ç»“æœ ç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå› ä¸ºæ¯æ¡æ¶ˆæ¯éƒ½è¦é˜»å¡ç­‰å¾… é€‚ç”¨åœºæ™¯ï¼šä½ååã€å¼ºä¸€è‡´åœºæ™¯ å¼‚æ­¥ Confirm æ¨¡å¼ å®ç°æ–¹å¼ è°ƒç”¨ channel.confirmSelect() å¼€å¯ Confirm æ¨¡å¼ æ³¨å†Œ ConfirmListener è°ƒç”¨ basicPublish æ—¶ä¸é˜»å¡ï¼Œä¾èµ–å¼‚æ­¥å›è°ƒå¤„ç† Ack/Nack ç¤ºä¾‹ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 @Service public class AsynchronousConfirmProducer { @Autowired private ConnectionFactory connectionFactory; private final Map\u0026lt;Long, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final AtomicLong deliveryTagCounter = new AtomicLong(0); public void sendMessageWithAsyncConfirm(String exchange, String routingKey, String message) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); channel.confirmSelect(); // æ³¨å†Œå¼‚æ­¥ç¡®è®¤ç›‘å¬å™¨ channel.addConfirmListener( (deliveryTag, multiple) -\u0026gt; { // ack å›è°ƒ handleAck(deliveryTag, multiple); }, (deliveryTag, multiple) -\u0026gt; { // nack å›è°ƒ handleNack(deliveryTag, multiple); } ); // å¼‚æ­¥å‘é€æ¶ˆæ¯ long deliveryTag = deliveryTagCounter.incrementAndGet(); channel.basicPublish(exchange, routingKey, null, message.getBytes()); // è®°å½•æœªç¡®è®¤æ¶ˆæ¯ unconfirmedMessages.put(deliveryTag, new UnconfirmedMessage( exchange, routingKey, message.getBytes(), System.currentTimeMillis() )); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤: \u0026#34; + message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } private void handleAck(long deliveryTag, boolean multiple) { if (multiple) { // æ‰¹é‡ç¡®è®¤ unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; entry.getKey() \u0026lt;= deliveryTag); System.out.println(\u0026#34;æ‰¹é‡ACKï¼ŒdeliveryTag: \u0026#34; + deliveryTag); } else { // å•ä¸ªç¡®è®¤ UnconfirmedMessage message = unconfirmedMessages.remove(deliveryTag); if (message != null) { System.out.println(\u0026#34;æ¶ˆæ¯ç¡®è®¤æˆåŠŸï¼ŒdeliveryTag: \u0026#34; + deliveryTag + \u0026#34;, message: \u0026#34; + new String(message.getBody())); } } } private void handleNack(long deliveryTag, boolean multiple) { if (multiple) { // æ‰¹é‡æ‹’ç» unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; entry.getKey() \u0026lt;= deliveryTag); System.out.println(\u0026#34;æ‰¹é‡NACKï¼ŒdeliveryTag: \u0026#34; + deliveryTag); } else { // å•ä¸ªæ‹’ç» UnconfirmedMessage message = unconfirmedMessages.remove(deliveryTag); if (message != null) { System.out.println(\u0026#34;æ¶ˆæ¯ç¡®è®¤å¤±è´¥ï¼ŒdeliveryTag: \u0026#34; + deliveryTag + \u0026#34;, message: \u0026#34; + new String(message.getBody())); // è¿™é‡Œå¯ä»¥å®ç°é‡è¯•é€»è¾‘ retryMessage(message); } } } private void retryMessage(UnconfirmedMessage message) { // å®ç°é‡è¯•é€»è¾‘ System.out.println(\u0026#34;é‡è¯•æ¶ˆæ¯: \u0026#34; + new String(message.getBody())); } public void sendMultipleMessagesWithAsyncConfirm(String exchange, String routingKey, List\u0026lt;String\u0026gt; messages) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); channel.confirmSelect(); // æ³¨å†Œç¡®è®¤ç›‘å¬å™¨ channel.addConfirmListener( (deliveryTag, multiple) -\u0026gt; handleAck(deliveryTag, multiple), (deliveryTag, multiple) -\u0026gt; handleNack(deliveryTag, multiple) ); // æ‰¹é‡å‘é€æ¶ˆæ¯ for (String message : messages) { long deliveryTag = deliveryTagCounter.incrementAndGet(); channel.basicPublish(exchange, routingKey, null, message.getBytes()); unconfirmedMessages.put(deliveryTag, new UnconfirmedMessage( exchange, routingKey, message.getBytes(), System.currentTimeMillis() )); } System.out.println(\u0026#34;æ‰¹é‡æ¶ˆæ¯å·²å‘é€ï¼Œæ•°é‡: \u0026#34; + messages.size()); } catch (Exception e) { System.err.println(\u0026#34;æ‰¹é‡å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } å¼‚æ­¥çš„åŸç† å‘é€æ¶ˆæ¯æ—¶ï¼šæ¶ˆæ¯ç«‹å³æ”¾å…¥æœªç¡®è®¤ Map Broker åœ¨åå°å¼‚æ­¥è¿”å› Confirm å¸§ Channel å†…éƒ¨çš„ IO çº¿ç¨‹è§£æ Confirm å¸§ï¼Œæ‰¾åˆ° deliveryTag å¯¹åº”çš„æ¶ˆæ¯ï¼Œä» Map ç§»é™¤ï¼Œå¹¶è§¦å‘å›è°ƒ ä¸åŒæ­¥çš„å¯¹æ¯” ç‰¹æ€§ åŒæ­¥ Confirm å¼‚æ­¥ Confirm æ€§èƒ½ ä½ï¼ˆé˜»å¡ç­‰å¾…ï¼‰ é«˜ï¼ˆéé˜»å¡ï¼‰ ååé‡ ä½ é«˜ å®æ—¶æ€§ å®æ—¶çŸ¥é“ç»“æœ é€šè¿‡å›è°ƒå¼‚æ­¥å¤„ç† å¤æ‚åº¦ ç®€å• ç›¸å¯¹å¤æ‚ é€‚ç”¨åœºæ™¯ ä½å¹¶å‘ã€å¼ºä¸€è‡´ é«˜å¹¶å‘ã€é«˜åå Return æœºåˆ¶ èƒŒæ™¯ å³ä½¿æ¶ˆæ¯åˆ°è¾¾äº† Brokerï¼Œå¦‚æœ Exchange æ— æ³•å°†æ¶ˆæ¯è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šè¢«ä¸¢å¼ƒã€‚\nä¸ºé¿å…æ— å£°ä¸¢å¤±ï¼Œå¯ä»¥å¼€å¯ Return æœºåˆ¶ã€‚\nMandatory æ ‡å¿— 1 2 // mandatory å‚æ•°è¯´æ˜ channel.basicPublish(exchange, routingKey, mandatory, props, body); mandatory=falseï¼šè·¯ç”±å¤±è´¥æ—¶ï¼ŒBroker ä¸¢å¼ƒæ¶ˆæ¯ mandatory=trueï¼šè·¯ç”±å¤±è´¥æ—¶ï¼ŒBroker é€šè¿‡ Basic.Return è¿”å›æ¶ˆæ¯ç»™ç”Ÿäº§è€… ReturnCallback å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @Service public class ReturnCallbackProducer { @Autowired private ConnectionFactory connectionFactory; public void sendMessageWithReturnCallback(String exchange, String routingKey, String message) { Connection connection = null; Channel channel = null; try { connection = connectionFactory.newConnection(); channel = connection.createChannel(); // æ³¨å†Œ Return ç›‘å¬å™¨ channel.addReturnListener((replyCode, replyText, exchangeName, routingKeyName, properties, body) -\u0026gt; { System.out.println(\u0026#34;æ¶ˆæ¯æ— æ³•è·¯ç”±ï¼Œè¢«é€€å›:\u0026#34;); System.out.println(\u0026#34; replyCode: \u0026#34; + replyCode); System.out.println(\u0026#34; replyText: \u0026#34; + replyText); System.out.println(\u0026#34; exchange: \u0026#34; + exchangeName); System.out.println(\u0026#34; routingKey: \u0026#34; + routingKeyName); System.out.println(\u0026#34; message: \u0026#34; + new String(body)); // å¤„ç†é€€å›çš„æ¶ˆæ¯ handleReturnedMessage(replyCode, replyText, exchangeName, routingKeyName, body); }); // å‘é€æ¶ˆæ¯ï¼Œè®¾ç½® mandatory=true channel.basicPublish(exchange, routingKey, true, null, message.getBytes()); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…è·¯ç”±ç»“æœ: \u0026#34; + message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } private void handleReturnedMessage(int replyCode, String replyText, String exchange, String routingKey, byte[] body) { // æ ¹æ®ä¸åŒçš„é”™è¯¯ç å¤„ç†é€€å›æ¶ˆæ¯ switch (replyCode) { case 312: // NO_ROUTE System.out.println(\u0026#34;æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é˜Ÿåˆ—ï¼Œæ¶ˆæ¯è¢«é€€å›\u0026#34;); // å¯ä»¥å®ç°é‡è¯•æˆ–è®°å½•æ—¥å¿— break; case 313: // NO_CONSUMERS System.out.println(\u0026#34;æ²¡æœ‰æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯è¢«é€€å›\u0026#34;); break; default: System.out.println(\u0026#34;æœªçŸ¥é”™è¯¯ï¼Œæ¶ˆæ¯è¢«é€€å›: \u0026#34; + replyCode); } } } ä¸ Confirm çš„åŒºåˆ« æœºåˆ¶ ä½œç”¨ è§¦å‘æ—¶æœº Confirm ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¿›å…¥ Broker æ¶ˆæ¯åˆ°è¾¾ Broker å Return ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¢«è·¯ç”±åˆ°é˜Ÿåˆ— æ¶ˆæ¯æ— æ³•è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶ ç»„åˆä½¿ç”¨ å®Œæ•´è¦†ç›–ç”Ÿäº§è€…å¯é æ€§ ä¸¤è€…ç»“åˆï¼Œæ‰èƒ½å®Œæ•´è¦†ç›– publisher-confirm-type é…ç½® åœ¨ Spring AMQP ä¸­ï¼Œå¸¸è§é…ç½®æ˜¯ï¼š\n1 2 3 4 spring: rabbitmq: publisher-confirm-type: correlated publisher-returns: true ç±»å‹è¯´æ˜ ç±»å‹ è¯´æ˜ ä½¿ç”¨åœºæ™¯ none å…³é—­ confirm æ€§èƒ½ä¼˜å…ˆï¼Œå¯é æ€§è¦æ±‚ä¸é«˜ simple åŒæ­¥é˜»å¡ç­‰å¾…ç¡®è®¤ ä½å¹¶å‘ï¼Œå¼ºä¸€è‡´æ€§è¦æ±‚ correlated å¼‚æ­¥å›è°ƒç¡®è®¤ï¼ˆæ¨èï¼‰ é«˜å¹¶å‘ï¼Œé«˜ååé‡ Spring AMQP é…ç½®ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Configuration @EnableRabbit public class RabbitMQConfig { @Bean public CachingConnectionFactory connectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(\u0026#34;localhost\u0026#34;); factory.setPort(5672); factory.setUsername(\u0026#34;guest\u0026#34;); factory.setPassword(\u0026#34;guest\u0026#34;); factory.setVirtualHost(\u0026#34;/\u0026#34;); // å¼€å¯ç¡®è®¤æ¨¡å¼ factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } @Bean public RabbitTemplate rabbitTemplate(CachingConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); // è®¾ç½®ç¡®è®¤å›è°ƒ template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: \u0026#34; + correlationData); } else { System.out.println(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: \u0026#34; + cause); } }); // è®¾ç½®è¿”å›å›è°ƒ template.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -\u0026gt; { System.out.println(\u0026#34;æ¶ˆæ¯è¢«é€€å›:\u0026#34;); System.out.println(\u0026#34; replyCode: \u0026#34; + replyCode); System.out.println(\u0026#34; replyText: \u0026#34; + replyText); System.out.println(\u0026#34; exchange: \u0026#34; + exchange); System.out.println(\u0026#34; routingKey: \u0026#34; + routingKey); System.out.println(\u0026#34; message: \u0026#34; + new String(message.getBody())); }); return template; } } ä¸å¼‚æ­¥ Confirm çš„å…³ç³» correlated å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨ RabbitMQ çš„ å¼‚æ­¥ ConfirmListenerï¼›\nSpring å°è£…äº† ConfirmCallback æ¥å£ï¼ŒæŠŠ deliveryTag ä¸æ¶ˆæ¯å…³è”èµ·æ¥ï¼Œä¾¿äºå¼€å‘ã€‚\nç”Ÿäº§è€…å¯é æ€§ä¿éšœçš„å…¨é“¾è·¯æ•´åˆ å®Œæ•´çš„å¯é æ€§é“¾è·¯é€šå¸¸éœ€è¦ï¼š\n1. Confirm + Return ç»„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Service public class ReliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; public void sendReliableMessage(String exchange, String routingKey, String message) { try { // è®¾ç½®æ¶ˆæ¯å±æ€§ MessageProperties properties = new MessageProperties(); properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); // æŒä¹…åŒ– properties.setMessageId(UUID.randomUUID().toString()); properties.setTimestamp(new Date()); Message messageObj = new Message(message.getBytes(), properties); // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(exchange, routingKey, messageObj); System.out.println(\u0026#34;å¯é æ¶ˆæ¯å·²å‘é€: \u0026#34; + message); } catch (Exception e) { System.err.println(\u0026#34;å‘é€å¯é æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); // å®ç°é‡è¯•é€»è¾‘ retryMessage(exchange, routingKey, message); } } private void retryMessage(String exchange, String routingKey, String message) { // å®ç°é‡è¯•é€»è¾‘ System.out.println(\u0026#34;é‡è¯•å‘é€æ¶ˆæ¯: \u0026#34; + message); } } 2. å¹‚ç­‰æ€§ä¸æ¶ˆæ¯å»é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Service public class IdempotentMessageProducer { @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; @Autowired private RabbitTemplate rabbitTemplate; public void sendIdempotentMessage(String exchange, String routingKey, String message, String messageId) { try { // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ String key = \u0026#34;message:\u0026#34; + messageId; if (redisTemplate.hasKey(key)) { System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€: \u0026#34; + messageId); return; } // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(exchange, routingKey, message); // è®°å½•æ¶ˆæ¯IDï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ redisTemplate.opsForValue().set(key, \u0026#34;sent\u0026#34;, Duration.ofHours(24)); System.out.println(\u0026#34;å¹‚ç­‰æ¶ˆæ¯å·²å‘é€: \u0026#34; + messageId); } catch (Exception e) { System.err.println(\u0026#34;å‘é€å¹‚ç­‰æ¶ˆæ¯å¼‚å¸¸: \u0026#34; + e.getMessage()); } } } 3. æ¶ˆæ¯æŒä¹…åŒ–ä¸ç£ç›˜å†™å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class PersistentMessageConfig { @Bean public DirectExchange persistentExchange() { return new DirectExchange(\u0026#34;persistent.exchange\u0026#34;, true, false); } @Bean public Queue persistentQueue() { return QueueBuilder.durable(\u0026#34;persistent.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 60000) .build(); } @Bean public Binding persistentBinding() { return BindingBuilder .bind(persistentQueue()) .to(persistentExchange()) .with(\u0026#34;persistent.key\u0026#34;); } } 4. åº”ç”¨å±‚è¡¥å¿æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Service public class CompensatingMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private final Map\u0026lt;String, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Scheduled(fixedRate = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡ public void checkUnconfirmedMessages() { long currentTime = System.currentTimeMillis(); unconfirmedMessages.entrySet().removeIf(entry -\u0026gt; { UnconfirmedMessage message = entry.getValue(); if (currentTime - message.getTimestamp() \u0026gt; 60000) { // 1åˆ†é’Ÿè¶…æ—¶ System.out.println(\u0026#34;æ¶ˆæ¯è¶…æ—¶æœªç¡®è®¤ï¼Œå‡†å¤‡é‡å‘: \u0026#34; + entry.getKey()); retryMessage(message); return true; } return false; }); } private void retryMessage(UnconfirmedMessage message) { try { rabbitTemplate.convertAndSend( message.getExchange(), message.getRoutingKey(), new String(message.getBody()) ); System.out.println(\u0026#34;æ¶ˆæ¯é‡å‘æˆåŠŸ: \u0026#34; + new String(message.getBody())); } catch (Exception e) { System.err.println(\u0026#34;æ¶ˆæ¯é‡å‘å¤±è´¥: \u0026#34; + e.getMessage()); } } } å®Œæ•´ä»£ç å®ç° é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 rabbitmq-reliability/ â”œâ”€â”€ src/main/java/com/reliability/ â”‚ â”œâ”€â”€ config/ â”‚ â”‚ â”œâ”€â”€ RabbitMQConfig.java â”‚ â”‚ â””â”€â”€ MessageConfig.java â”‚ â”œâ”€â”€ producer/ â”‚ â”‚ â”œâ”€â”€ ReliableMessageProducer.java â”‚ â”‚ â”œâ”€â”€ AsyncConfirmProducer.java â”‚ â”‚ â””â”€â”€ SyncConfirmProducer.java â”‚ â”œâ”€â”€ consumer/ â”‚ â”‚ â””â”€â”€ ReliableMessageConsumer.java â”‚ â”œâ”€â”€ entity/ â”‚ â”‚ â””â”€â”€ UnconfirmedMessage.java â”‚ â”œâ”€â”€ service/ â”‚ â”‚ â””â”€â”€ MessageReliabilityService.java â”‚ â””â”€â”€ util/ â”‚ â””â”€â”€ MessageUtils.java æ ¸å¿ƒé…ç½®ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 @Configuration @EnableRabbit @Slf4j public class RabbitMQConfig { @Bean public CachingConnectionFactory connectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(\u0026#34;localhost\u0026#34;); factory.setPort(5672); factory.setUsername(\u0026#34;guest\u0026#34;); factory.setPassword(\u0026#34;guest\u0026#34;); factory.setVirtualHost(\u0026#34;/\u0026#34;); // è¿æ¥æ± é…ç½® factory.setChannelCacheSize(50); factory.setChannelCheckoutTimeout(10000); // å¼€å¯ç¡®è®¤æ¨¡å¼ factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } @Bean public RabbitTemplate rabbitTemplate(CachingConnectionFactory connectionFactory) { RabbitTemplate template = new RabbitTemplate(connectionFactory); // è®¾ç½®ç¡®è®¤å›è°ƒ template.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { log.info(\u0026#34;æ¶ˆæ¯æŠ•é€’æˆåŠŸ: {}\u0026#34;, correlationData); } else { log.error(\u0026#34;æ¶ˆæ¯æŠ•é€’å¤±è´¥: {}, cause: {}\u0026#34;, correlationData, cause); } }); // è®¾ç½®è¿”å›å›è°ƒ template.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -\u0026gt; { log.warn(\u0026#34;æ¶ˆæ¯è¢«é€€å›: replyCode={}, replyText={}, exchange={}, routingKey={}\u0026#34;, replyCode, replyText, exchange, routingKey); }); return template; } // äº¤æ¢æœºé…ç½® @Bean public DirectExchange reliableExchange() { return new DirectExchange(\u0026#34;reliable.exchange\u0026#34;, true, false); } @Bean public Queue reliableQueue() { return QueueBuilder.durable(\u0026#34;reliable.queue\u0026#34;) .withArgument(\u0026#34;x-message-ttl\u0026#34;, 300000) // 5åˆ†é’ŸTTL .withArgument(\u0026#34;x-max-length\u0026#34;, 10000) // æœ€å¤§é•¿åº¦ .build(); } @Bean public Binding reliableBinding() { return BindingBuilder .bind(reliableQueue()) .to(reliableExchange()) .with(\u0026#34;reliable.key\u0026#34;); } } å¯é æ¶ˆæ¯ç”Ÿäº§è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 @Service @Slf4j public class ReliableMessageProducer { @Autowired private RabbitTemplate rabbitTemplate; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private final Map\u0026lt;String, UnconfirmedMessage\u0026gt; unconfirmedMessages = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * å‘é€å¯é æ¶ˆæ¯ */ public void sendReliableMessage(String message, String messageId) { try { // 1. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ï¼ˆå¹‚ç­‰æ€§ï¼‰ if (isMessageAlreadySent(messageId)) { log.warn(\u0026#34;æ¶ˆæ¯å·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€: {}\u0026#34;, messageId); return; } // 2. æ„å»ºæ¶ˆæ¯ MessageProperties properties = new MessageProperties(); properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); properties.setMessageId(messageId); properties.setTimestamp(new Date()); properties.setContentType(\u0026#34;application/json\u0026#34;); Message messageObj = new Message(message.getBytes(), properties); // 3. è®°å½•æœªç¡®è®¤æ¶ˆæ¯ UnconfirmedMessage unconfirmedMessage = new UnconfirmedMessage( \u0026#34;reliable.exchange\u0026#34;, \u0026#34;reliable.key\u0026#34;, message.getBytes(), System.currentTimeMillis() ); unconfirmedMessages.put(messageId, unconfirmedMessage); // 4. å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(\u0026#34;reliable.exchange\u0026#34;, \u0026#34;reliable.key\u0026#34;, messageObj); // 5. è®°å½•æ¶ˆæ¯IDåˆ°Redis recordMessageId(messageId); log.info(\u0026#34;å¯é æ¶ˆæ¯å·²å‘é€: {}\u0026#34;, messageId); } catch (Exception e) { log.error(\u0026#34;å‘é€å¯é æ¶ˆæ¯å¼‚å¸¸: {}\u0026#34;, e.getMessage(), e); // å®ç°é‡è¯•é€»è¾‘ retryMessage(message, messageId); } } /** * æ‰¹é‡å‘é€å¯é æ¶ˆæ¯ */ public void sendBatchReliableMessages(List\u0026lt;String\u0026gt; messages) { for (int i = 0; i \u0026lt; messages.size(); i++) { String messageId = \u0026#34;batch_\u0026#34; + System.currentTimeMillis() + \u0026#34;_\u0026#34; + i; sendReliableMessage(messages.get(i), messageId); } } /** * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€ */ private boolean isMessageAlreadySent(String messageId) { String key = \u0026#34;message:\u0026#34; + messageId; return redisTemplate.hasKey(key); } /** * è®°å½•æ¶ˆæ¯ID */ private void recordMessageId(String messageId) { String key = \u0026#34;message:\u0026#34; + messageId; redisTemplate.opsForValue().set(key, \u0026#34;sent\u0026#34;, Duration.ofHours(24)); } /** * é‡è¯•æ¶ˆæ¯ */ private void retryMessage(String message, String messageId) { try { Thread.sleep(1000); // ç­‰å¾…1ç§’ sendReliableMessage(message, messageId + \u0026#34;_retry\u0026#34;); log.info(\u0026#34;æ¶ˆæ¯é‡è¯•æˆåŠŸ: {}\u0026#34;, messageId); } catch (Exception e) { log.error(\u0026#34;æ¶ˆæ¯é‡è¯•å¤±è´¥: {}\u0026#34;, e.getMessage(), e); } } /** * è·å–æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ */ public int getUnconfirmedCount() { return unconfirmedMessages.size(); } /** * æ¸…ç†å·²ç¡®è®¤æ¶ˆæ¯ */ public void removeConfirmedMessage(String messageId) { unconfirmedMessages.remove(messageId); } } æ¶ˆæ¯æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 @Component @Slf4j public class ReliableMessageConsumer { @Autowired private ReliableMessageProducer messageProducer; @RabbitListener(queues = \u0026#34;reliable.queue\u0026#34;) public void handleReliableMessage(Message message, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) { try { String messageId = message.getMessageProperties().getMessageId(); String messageBody = new String(message.getBody()); log.info(\u0026#34;æ”¶åˆ°å¯é æ¶ˆæ¯: messageId={}, body={}\u0026#34;, messageId, messageBody); // å¤„ç†ä¸šåŠ¡é€»è¾‘ processMessage(messageBody); // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ channel.basicAck(deliveryTag, false); // ä»ç”Ÿäº§è€…ä¸­ç§»é™¤å·²ç¡®è®¤æ¶ˆæ¯ messageProducer.removeConfirmedMessage(messageId); log.info(\u0026#34;æ¶ˆæ¯å¤„ç†å®Œæˆ: {}\u0026#34;, messageId); } catch (Exception e) { log.error(\u0026#34;å¤„ç†æ¶ˆæ¯å¼‚å¸¸: {}\u0026#34;, e.getMessage(), e); try { // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ channel.basicNack(deliveryTag, false, false); } catch (IOException ioException) { log.error(\u0026#34;æ‹’ç»æ¶ˆæ¯å¼‚å¸¸: {}\u0026#34;, ioException.getMessage(), ioException); } } } /** * å¤„ç†ä¸šåŠ¡é€»è¾‘ */ private void processMessage(String messageBody) { // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† try { Thread.sleep(100); log.info(\u0026#34;ä¸šåŠ¡å¤„ç†å®Œæˆ: {}\u0026#34;, messageBody); } catch (InterruptedException e) { Thread.currentThread().interrupt(); log.error(\u0026#34;ä¸šåŠ¡å¤„ç†è¢«ä¸­æ–­: {}\u0026#34;, e.getMessage(), e); } } } æ¶ˆæ¯å¯é æ€§æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Service @Slf4j public class MessageReliabilityService { @Autowired private ReliableMessageProducer messageProducer; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; /** * æ£€æŸ¥æœªç¡®è®¤æ¶ˆæ¯ */ @Scheduled(fixedRate = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡ public void checkUnconfirmedMessages() { int unconfirmedCount = messageProducer.getUnconfirmedCount(); if (unconfirmedCount \u0026gt; 0) { log.warn(\u0026#34;å½“å‰æœ‰ {} æ¡æœªç¡®è®¤æ¶ˆæ¯\u0026#34;, unconfirmedCount); } } /** * æ¸…ç†è¿‡æœŸçš„æ¶ˆæ¯è®°å½• */ @Scheduled(fixedRate = 3600000) // 1å°æ—¶æ¸…ç†ä¸€æ¬¡ public void cleanupExpiredMessages() { try { Set\u0026lt;String\u0026gt; keys = redisTemplate.keys(\u0026#34;message:*\u0026#34;); if (keys != null \u0026amp;\u0026amp; !keys.isEmpty()) { redisTemplate.delete(keys); log.info(\u0026#34;æ¸…ç†è¿‡æœŸæ¶ˆæ¯è®°å½•: {} æ¡\u0026#34;, keys.size()); } } catch (Exception e) { log.error(\u0026#34;æ¸…ç†è¿‡æœŸæ¶ˆæ¯è®°å½•å¼‚å¸¸: {}\u0026#34;, e.getMessage(), e); } } /** * è·å–æ¶ˆæ¯ç»Ÿè®¡ä¿¡æ¯ */ public Map\u0026lt;String, Object\u0026gt; getMessageStatistics() { Map\u0026lt;String, Object\u0026gt; stats = new HashMap\u0026lt;\u0026gt;(); stats.put(\u0026#34;unconfirmedCount\u0026#34;, messageProducer.getUnconfirmedCount()); stats.put(\u0026#34;timestamp\u0026#34;, System.currentTimeMillis()); return stats; } } æœ€ä½³å®è·µä¸æ€»ç»“ 1. æ€§èƒ½ä¼˜åŒ–å»ºè®® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // è¿æ¥æ± é…ç½®ä¼˜åŒ– @Configuration public class PerformanceConfig { @Bean public CachingConnectionFactory optimizedConnectionFactory() { CachingConnectionFactory factory = new CachingConnectionFactory(); // è¿æ¥æ± é…ç½® factory.setChannelCacheSize(100); // å¢åŠ é€šé“ç¼“å­˜ factory.setChannelCheckoutTimeout(5000); // å‡å°‘è¶…æ—¶æ—¶é—´ // ç¡®è®¤æ¨¡å¼é…ç½® factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED); factory.setPublisherReturns(true); return factory; } } 2. ç›‘æ§å’Œå‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Component @Slf4j public class MessageMonitor { @Autowired private ReliableMessageProducer messageProducer; private final AtomicLong successCount = new AtomicLong(0); private final AtomicLong failureCount = new AtomicLong(0); @EventListener public void handleMessageSuccess(MessageSuccessEvent event) { successCount.incrementAndGet(); log.info(\u0026#34;æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ€»æ•°: {}\u0026#34;, successCount.get()); } @EventListener public void handleMessageFailure(MessageFailureEvent event) { failureCount.incrementAndGet(); log.error(\u0026#34;æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ€»æ•°: {}\u0026#34;, failureCount.get()); } @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ public void logStatistics() { long success = successCount.get(); long failure = failureCount.get(); long total = success + failure; if (total \u0026gt; 0) { double successRate = (double) success / total * 100; log.info(\u0026#34;æ¶ˆæ¯å‘é€ç»Ÿè®¡ - æˆåŠŸ: {}, å¤±è´¥: {}, æˆåŠŸç‡: {:.2f}%\u0026#34;, success, failure, successRate); } } } 3. æ€»ç»“ Confirm æœºåˆ¶è§£å†³äº†\u0026quot;æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ Broker\u0026quot;çš„é—®é¢˜ åŒæ­¥æ¨¡å¼ï¼šç®€å•ä½†ä½æ•ˆï¼Œé€‚åˆä½å¹¶å‘åœºæ™¯ å¼‚æ­¥æ¨¡å¼ï¼šé«˜æ•ˆä¸”å¸¸ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ Return æœºåˆ¶è§£å†³äº†\u0026quot;æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—\u0026quot;çš„é—®é¢˜ ä¸ Confirm æœºåˆ¶ç»“åˆä½¿ç”¨ ç¡®ä¿æ¶ˆæ¯å®Œæ•´æŠ•é€’åˆ°ç›®æ ‡é˜Ÿåˆ— deliveryTag + multiple æ„æˆäº† Confirm çš„æ ¸å¿ƒé€»è¾‘ deliveryTagï¼šæ¶ˆæ¯å”¯ä¸€æ ‡è¯† multipleï¼šæ‰¹é‡ç¡®è®¤æœºåˆ¶ æœªç¡®è®¤æ¶ˆæ¯Mapï¼šç®¡ç†å¾…ç¡®è®¤æ¶ˆæ¯ Spring AMQP çš„ publisher-confirm-type=correlated å°±æ˜¯å¼‚æ­¥ Confirm çš„å°è£… ç®€åŒ–äº†å¼‚æ­¥ç¡®è®¤çš„ä½¿ç”¨ æä¾›äº†ç»Ÿä¸€çš„å›è°ƒæ¥å£ ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼š Confirm + Return + æ¶ˆæ¯æŒä¹…åŒ– + åº”ç”¨å±‚è¡¥å¿ ç»„åˆä½¿ç”¨ Confirmæœºåˆ¶ï¼šç¡®ä¿æ¶ˆæ¯åˆ°è¾¾Broker Returnæœºåˆ¶ï¼šç¡®ä¿æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ— æ¶ˆæ¯æŒä¹…åŒ–ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤± åº”ç”¨å±‚è¡¥å¿ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µ å¹‚ç­‰æ€§ä¿è¯ï¼šé¿å…é‡å¤å¤„ç† é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†åˆ†æå’Œå®Œæ•´ä»£ç å®ç°ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹RabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚å’Œæ€§èƒ½è¦æ±‚æ¥é€‰æ‹©åˆé€‚çš„ç¡®è®¤æ¨¡å¼ï¼Œå¹¶é…åˆå…¶ä»–å¯é æ€§æœºåˆ¶æ¥æ„å»ºçœŸæ­£å¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿã€‚\næœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†RabbitMQç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„åŸç†å’Œå®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¯é çš„æ¶ˆæ¯æŠ•é€’ç³»ç»Ÿã€‚\n","date":"2025-01-14T00:00:00Z","permalink":"https://Yin123-ybh.github.io/p/rabbitmq-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8E%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90/","title":"RabbitMQ ç”Ÿäº§è€…å¯é æ€§ä¸ç¡®è®¤æœºåˆ¶å…¨è§£æ"}]